# file opened: ay232k.asm
   1  0000              ;AY232K (izzx)
   2  0000              ;Клиент для обмена ZX-PC
   3  0000                  device ZXSPECTRUM128
   4  0000
   5  0000              	org #6000
   6  6000              start_
   7  6000              col_fon equ 7 ;цвет фона
   8  6000              ;col_len equ 9 ;атрибутов на имя файла
   9  6000              col_win equ 4*8+7 ;цвет окна сообщения
  10  6000              col_win2 equ 2*8+7 ;цвет окна сообщения
  11  6000              win_size equ 11 ;длина атрибутов окна сообщения
  12  6000              win_pos equ #5800+768/2+10+32+32 ;позиция окна сообщения
  13  6000              file_name_len equ 12 ;длина имени файла
  14  6000              lenghtName equ 16 ;длина имени файла в каталоге
  15  6000              scroll_len equ 13 ;длина области скрола сообщений
  16  6000              pack_size_1024_com equ 1024 ;длина основной части большого пакета
  17  6000              pack_size_1024 equ pack_size_1024_com+pack_size_32_com+2 ;длина пакета полная
  18  6000              ;pack_size_1024_full equ pack_size_1024+40 ;длина большого пакета со служебной информацией
  19  6000              ;pack_size_1024_echo equ 26 ;длина ответа ESP на отправку большого пакета
  20  6000              pack_size_32_com equ 32 ;длина основной части малого пакета (заголовка)
  21  6000              pack_size_32 equ pack_size_32_com+2 ;длина пакета заголовка полная
  22  6000              ;pack_size_32_full equ pack_size_32+40 ;длина малого пакета со служебной информацией ??
  23  6000              ;pack_size_32_echo equ 24 ;длина ответа ESP на отправку малого пакета
  24  6000              pack_size_256_com equ 256 ;длина основной части пакета 256
  25  6000              pack_size_256 equ pack_size_256_com+pack_size_32_com+2 ;длина пакета полная
  26  6000              ;pack_size_256_full equ pack_size_256+39 ;длина пакета 256 со служебной информацией
  27  6000              ;pack_size_256_echo equ 25 ;длина ответа ESP на отправку пакета 256
  28  6000              files_view equ 24-3 ;показывать файлов в каталоге
  29  6000              col_pos_l equ #5800 ;позиция для покраски левая панель
  30  6000              col_pos_r equ #5800+31-9 ;позиция для покраски правая панель
  31  6000              colorcatc_act equ 7*8+1 ;цвет выбранного файла активной панели
  32  6000              colorcat_ equ     1*8+7; фон панели файлов
  33  6000              retry_rec_count_max equ 50 ;число фреймов ожидания приёма байта
  34  6000              launch_name equ #5dd4 ;адрес имени файла в загрузчике для запуска
  35  6000              max_files equ 64 ;макс файлов в каталоге
  36  6000              max_files_trd equ 128 ;макс файлов в образе
  37  6000              ;fix equ 500 ;дополнительная длина пакета для надёжного приёма
  38  6000              check_init_max equ 10 ;число отправки повторного пакета до внеочередного сброса устройства
  39  6000              cat_size_max equ 15*512 ;максимум буфер каталога слева
  40  6000
  41  6000
  42  6000              start
  43  6000 3E 10            ld      a,#10
  44  6002 32 5C 5B         ld      (#5b5c),a ;sys var
  45  6005 3A 19 5D     	ld      a,(#5d19) ;текущий диск
  46  6008 32 1D 73         ld      (cur_drive) ,a
  47  600B 3E 52        	ld a,"R"
  48  600D 32 2A 73     	ld (panel),a ;выбрать правую панель
  49  6010
  50  6010              	; DI
  51  6010              	; ;установим прерывания 2
  52  6010              	; ld a,interrupt_vec/256 ;вектор
  53  6010              	; ld i,a
  54  6010              	; im 2
  55  6010              	; ld hl,interrupt ;адрес обработчика
  56  6010              	; ld ((interrupt_vec/256)*256+#ff),hl ;
  57  6010              	; ei
  58  6010 CD CF 6E     	call cls_pic
  59  6013 CD 35 7C     	call read_cfg
  60  6016 CD AC 71     	call init_dev
  61  6019 CD BA 7C     	call init_hdd ;проверить разделы FAT
  62  601C              start_h
  63  601C CD CF 6E     	call cls_pic
  64  601F 21 D3 74     	ld hl,mes_title
  65  6022 CD 09 77     	call print
  66  6025 21 45 76     	ld hl,mes_server
  67  6028 CD 09 77     	call print
  68  602B 21 60 76     	ld hl,mes_port
  69  602E CD 09 77     	call print
  70  6031
  71  6031 AF           	xor a ;обнулить переменные
  72  6032 32 24 73     	ld     (files),a
  73  6035 32 1E 73     	ld     (shiftcat),a
  74  6038 32 25 73     	ld     (curfile),a
  75  603B 32 3A 73     	ld (cur_cat_pag),a
  76  603E 32 3B 73     	ld (cur_cat_pag+1),a
  77  6041              	;call init_dev
  78  6041 CD E1 62     	call renewcat_r
  79  6044 CD A9 62     	call renewcat_l
  80  6047
  81  6047              wait ;ожидание клавиши
  82  6047 CD C4 60     		call input_key
  83  604A
  84  604A              ;waitPass
  85  604A 79           			ld      a,c ;вспомним клавишу
  86  604B FE 45                    cp 		"E"
  87  604D CA 3C 61                 jp      z,exit
  88  6050 FE 06                    cp 		6 ;#36-" "
  89  6052 CA 71 61                 jp      z,down
  90  6055 FE 07                    cp 		7 ;#37-" "
  91  6057 CA BA 61                 jp      z,up
  92  605A FE 54                    cp 		"T" ;
  93  605C CA A7 6A                 jp      z,TRD ;copy TRD
  94  605F FE 52                    cp 		"R"
  95  6061 CA C1 60                 jp      z,readc
  96  6064 FE 31                    cp 		"1"
  97  6066 CA 71 62                 jp      z,driveA ;1
  98  6069 FE 41                    cp 		"A"
  99  606B CA 71 62                 jp      z,driveA ;A
 100  606E FE 32                    cp 		"2"
 101  6070 CA 7F 62                 jp      z,driveB ;2
 102  6073 FE 42                    cp 		"B"
 103  6075 CA 7F 62                 jp      z,driveB ;B
 104  6078 FE 33                    cp 		"3"
 105  607A CA 8D 62                 jp      z,driveC ;3
 106  607D FE 43                    cp 		"C"
 107  607F CA 8D 62                 jp      z,driveC ;C
 108  6082 FE 34                    cp 		"4"
 109  6084 CA 9B 62                 jp      z,driveD ;4
 110  6087 FE 44                    cp 		"D"
 111  6089 CA 9B 62                 jp      z,driveD ;D
 112  608C FE 48        			cp 		"H"
 113  608E CA D3 7E                 jp      z,select_hdd ;снова на выбор HDD
 114  6091 FE 0E                    cp 		#0e ;-" " ;CS+SS
 115  6093 CA 3A 71                 jp      z,change_panel ;S
 116  6096 FE 05                    cp 		5 ;#35-" "
 117  6098 CA 06 62                 jp      z,left
 118  609B FE 08                    cp 		8 ;#38-" "
 119  609D CA 2A 62                 jp      z,right
 120  60A0                          ; cp 		"I"
 121  60A0                          ; jp      z,ShowInfo ;I
 122  60A0              			; cp 		"S"
 123  60A0                          ; jp      z,check_sum_tog ;S
 124  60A0 FE 0D                    cp 		#0d
 125  60A2 CA 97 63                 jp      z,run_open ;enter
 126  60A5 FE 49        			cp 		"I"
 127  60A7 CA EC 65                 jp      z,esp_rst ;сброс ESP
 128  60AA FE 4B        			cp 		"K"
 129  60AC CA 3C 72                 jp      z,mark_all ;отметить все
 130  60AF FE 4A        			cp 		"J"
 131  60B1 CA ED 72                 jp      z,unmark_all ;включить ESP в режим translink
 132  60B4 FE 35                    cp 		"5"
 133  60B6 CA 1D 66                 jp      z,copyF ;копирование по файлам
 134  60B9 FE 20                    cp 		" "
 135  60BB CA E8 71                 jp      z,markF ;отметка файла
 136  60BE
 137  60BE C3 47 60                 jp      wait
 138  60C1
 139  60C1              readc
 140  60C1 C3 1C 60     			jp start_h
 141  60C4
 142  60C4
 143  60C4              input_key ;на выходе в c - код клавиши
 144  60C4 76                       halt
 145  60C5
 146  60C5 3A 22 73     			ld      a,(keyLast) ;предыдущая нажатая клавиша
 147  60C8 47           			ld		b,a
 148  60C9 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
 149  60CC              			;ld 		c,a
 150  60CC CD 08 61     			call 	input_key_curs
 151  60CF 7B           			ld 		a,e
 152  60D0 4F           			ld 		c,a
 153  60D1              			;ld      (23556),a
 154  60D1 32 22 73     			ld 		(keyLast),a ;запомним клавишу
 155  60D4 FE FF        			cp		#ff ;если сейчас ничего не нажато
 156  60D6 20 06        			jr		nz,wait1
 157  60D8 AF           			xor		a
 158  60D9 32 23 73     			ld		(keyDelayF),a ;обнулим флаг задержки
 159  60DC 18 E6        			jr      input_key ;и снова на ожидание
 160  60DE              wait1
 161  60DE 79           			ld		a,c
 162  60DF B8           			cp		b
 163  60E0 C0           			ret		nz ;если нажата первый раз, пропустим задержку
 164  60E1
 165  60E1 3A 23 73     			ld 		a,(keyDelayF)
 166  60E4 B7           			or		a
 167  60E5 C0           			ret		nz ;если всё ещё нажата и была пауза, пропустим
 168  60E6
 169  60E6              ;waitDelay
 170  60E6 3A 21 73     			ld      a,(keyRepeat) ;пауза
 171  60E9 47           			ld b,a
 172  60EA              waitDelay
 173  60EA 76                       halt
 174  60EB 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
 175  60EE CD 08 61     			call 	input_key_curs
 176  60F1 7B           			ld 		a,e
 177  60F2              			;ld      (23556),a
 178  60F2 32 22 73     			ld 		(keyLast),a ;запомним клавишу
 179  60F5 FE FF        			cp		#ff ;если сейчас ничего не нажато
 180  60F7 20 06        			jr		nz,waitDelay1
 181  60F9 AF           			xor		a
 182  60FA 32 23 73     			ld		(keyDelayF),a ;обнулим флаг задержки
 183  60FD 18 C5        			jr      input_key ;и снова на ожидание
 184  60FF              waitDelay1
 185  60FF 10 E9        			djnz waitDelay
 186  6101 3E 01        			ld		a,1
 187  6103 32 23 73     			ld		(keyDelayF),a ;установить флаг была пауза
 188  6106 18 BC        			jr      input_key ;и снова на ожидание
 189  6108
 190  6108              input_key_curs ;перехват курсора
 191  6108 5F           			ld e,a
 192  6109 3E FE        			ld a,#fe
 193  610B DB FE        			in a,(#fe)
 194  610D CB 47        			bit 0,a ;Caps
 195  610F C0           			ret nz
 196  6110 3E F7        			ld a,#f7
 197  6112 DB FE        			in a,(#fe)
 198  6114 CB 67        			bit 4,a
 199  6116 20 03        			jr nz,input_key_curs_1
 200  6118 1E 05        			ld e,5 ;left
 201  611A C9           			ret
 202  611B              input_key_curs_1
 203  611B 3E EF        			ld a,#ef
 204  611D DB FE        			in a,(#fe)
 205  611F CB 67        			bit 4,a
 206  6121 20 03        			jr nz,input_key_curs_2
 207  6123 1E 06        			ld e,6 ;down
 208  6125 C9           			ret
 209  6126              input_key_curs_2
 210  6126 CB 5F        			bit 3,a
 211  6128 20 03        			jr nz,input_key_curs_3
 212  612A 1E 07        			ld e,7 ;up
 213  612C C9           			ret
 214  612D              input_key_curs_3
 215  612D CB 57        			bit 2,a
 216  612F 20 03        			jr nz,input_key_curs_4
 217  6131 1E 08        			ld e,8 ;right
 218  6133 C9           			ret
 219  6134              input_key_curs_4
 220  6134 CB 47        			bit 0,a
 221  6136 C0           			ret nz
 222  6137 1E 00        			ld e,0 ;Back Space
 223  6139 C9           			ret
 224  613A
 225  613A
 226  613A              input_key_curs_e
 227  613A 79           			ld a,c
 228  613B C9           			ret
 229  613C
 230  613C
 231  613C              exit ;выход в DOS
 232  613C 3E 10                    ld      a,#10
 233  613E 32 5C 5B                 ld      (#5b5c),a ;sys var
 234  6141 21 58 27     			LD 		HL,10072
 235  6144 D9           			EXX
 236  6145              			;ld		bc,0
 237  6145 C9                       ret
 238  6146
 239  6146              wait_cont ;обновить переменные и продолжить
 240  6146 3A 2A 73     	ld a,(panel)
 241  6149 FE 4C        	cp "L"
 242  614B 20 12        	jr nz,wait_cont_r
 243  614D 3A 1E 73     	ld     a,(shiftcat)
 244  6150 32 20 73     	ld     (shiftcat_l),a
 245  6153 3A 25 73     	ld     a,(curfile)
 246  6156 32 29 73     	ld     (curfile_l),a
 247  6159 CD 4D 71     	call   printcat
 248  615C C3 47 60         jp     wait
 249  615F              wait_cont_r
 250  615F 3A 1E 73     	ld     a,(shiftcat)
 251  6162 32 1F 73     	ld     (shiftcat_r),a
 252  6165 3A 25 73     	ld     a,(curfile)
 253  6168 32 27 73     	ld     (curfile_r),a
 254  616B CD 4D 71     	call   printcat
 255  616E C3 47 60         jp     wait
 256  6171
 257  6171              down ; вниз по каталогу
 258  6171 3A 24 73                 ld     a,(files)
 259  6174 4F                       ld     c,a
 260  6175 3A 1E 73     			ld     a,(shiftcat)
 261  6178 47           			ld     b,a
 262  6179 3A 25 73                 ld     a,(curfile)
 263  617C 3C                       inc    a
 264  617D B9                       cp     c
 265  617E D2 91 61                 jp     nc,downE_upd ;подгрузка если дошли до конца
 266  6181 32 25 73                 ld     (curfile),a
 267  6184 90           			sub b
 268  6185                      ;    ld     a,(cursor)
 269  6185 FE 15                    cp     files_view ;не пора ли сдвинуться вниз всему каталогу
 270  6187 38 05                    jr     c,downE
 271  6189 04                       inc b
 272  618A 78                       ld   a,b
 273  618B 32 1E 73                 ld     (shiftcat),a
 274  618E              downE
 275  618E C3 46 61                 jp     wait_cont
 276  6191              downE_upd
 277  6191              			;подгрузка страницы каталога
 278  6191 3A 2A 73     			ld a,(panel)
 279  6194 FE 52        			cp "R"
 280  6196 C2 46 61     			jp nz,wait_cont ;только для правой панели
 281  6199 3A 39 73     			ld a,(open_trd_flag)
 282  619C B7           			or a
 283  619D C2 46 61     			jp nz,wait_cont ;не при открытом образе
 284  61A0 2A 3A 73     			ld hl,(cur_cat_pag)
 285  61A3 23           			inc hl
 286  61A4 22 3A 73     			ld (cur_cat_pag),hl
 287  61A7 AF           			xor a
 288  61A8 32 25 73     			ld (curfile),a
 289  61AB 32 1E 73     			ld (shiftcat),a
 290  61AE 32 24 73     			ld (files),a
 291  61B1 CD 62 65     			call cls_r
 292  61B4 CD E1 62     			call renewcat_r
 293  61B7 C3 46 61     			jp wait_cont
 294  61BA
 295  61BA
 296  61BA              up ; ; вверх по каталогу
 297  61BA
 298  61BA 3A 25 73                 ld     a,(curfile)
 299  61BD B7                       or     a
 300  61BE CA D8 61                 jp     z,upE_upd
 301  61C1 3D                       dec    a
 302  61C2 32 25 73                 ld     (curfile),a
 303  61C5 4F           			ld     c,a
 304  61C6 3A 1E 73                 ld     a,(shiftcat)
 305  61C9 47           			ld b,a
 306  61CA 79           			ld a,c
 307  61CB 90           			sub b
 308  61CC FE 15        			cp files_view
 309  61CE 38 05        			jr c,upE
 310  61D0 05           			dec b
 311  61D1 78           			ld a,b
 312  61D2 32 1E 73                 ld     (shiftcat),a
 313  61D5              upE
 314  61D5 C3 46 61                 jp     wait_cont
 315  61D8              upE_upd
 316  61D8              			;подгрузка страницы каталога
 317  61D8 3A 2A 73     			ld a,(panel)
 318  61DB FE 52        			cp "R"
 319  61DD C2 46 61     			jp nz,wait_cont ;только для правой панели
 320  61E0 3A 39 73     			ld a,(open_trd_flag)
 321  61E3 B7           			or a
 322  61E4 C2 46 61     			jp nz,wait_cont ;не при открытом образе
 323  61E7 2A 3A 73     			ld hl,(cur_cat_pag)
 324  61EA 7C           			ld a,h
 325  61EB B5           			or l
 326  61EC CA 47 60     			jp z,wait
 327  61EF 2B           			dec hl
 328  61F0 22 3A 73     			ld (cur_cat_pag),hl
 329  61F3 AF           			xor a
 330  61F4 32 25 73     			ld (curfile),a
 331  61F7 32 1E 73     			ld (shiftcat),a
 332  61FA 32 24 73     			ld (files),a
 333  61FD CD 62 65     			call cls_r
 334  6200 CD E1 62     			call renewcat_r
 335  6203 C3 46 61     			jp wait_cont
 336  6206
 337  6206
 338  6206              left ; на страницу вверх
 339  6206
 340  6206 3A 25 73                 ld     a,(curfile)
 341  6209 B7                       or     a
 342  620A CA 47 60                 jp     z,wait
 343  620D D6 14                    sub    files_view-1
 344  620F 30 01                    jr     nc,left02
 345  6211 AF                       xor    a
 346  6212              left02
 347  6212 32 25 73                 ld     (curfile),a
 348  6215 4F                       ld     c,a
 349  6216              			;проверка сдвига
 350  6216 3A 1E 73     			ld     a,(shiftcat)
 351  6219 47           			ld b,a
 352  621A 79           			ld     a,c
 353  621B 90           			sub b
 354  621C              			;cp files_view
 355  621C 30 09        			jr nc,leftE ;листать не надо
 356  621E
 357  621E 78           			ld a,b
 358  621F D6 14        			sub files_view-1
 359  6221 30 01        			jr nc,left03
 360  6223 AF           			xor a
 361  6224              left03
 362  6224 32 1E 73                 ld     (shiftcat),a
 363  6227              leftE
 364  6227 C3 46 61                 jp     wait_cont
 365  622A
 366  622A
 367  622A
 368  622A
 369  622A              right; на страницу вниз
 370  622A 3A 24 73                 ld     a,(files) ;всего
 371  622D B7           			or     a
 372  622E CA 47 60                 jp     z,wait
 373  6231 4F                       ld     c,a
 374  6232 3A 25 73                 ld     a,(curfile) ;текущий
 375  6235 C6 14                    add    a,files_view-1 ;листаем вперёд
 376  6237 B9                       cp     c
 377  6238 38 04                    jr     c,right01 ;если не дошли до конца
 378  623A 3A 24 73                 ld     a,(files) ;иначе на последний файл
 379  623D 3D                       dec    a
 380  623E              right01
 381  623E 32 25 73                 ld     (curfile),a
 382  6241
 383  6241              			;проверка сдвига, листать каталог или нет
 384  6241 3A 24 73     			ld     a,(files)
 385  6244 4F           			ld c,a
 386  6245 FE 16        			cp files_view+1
 387  6247 38 25        			jr c,rightE ;выход если файлов меньше 25
 388  6249 3A 1E 73                 ld     a,(shiftcat)
 389  624C 47           			ld b,a
 390  624D 3A 25 73     			ld     a,(curfile) ;текущий
 391  6250 90           			sub b
 392  6251 FE 15        			cp files_view
 393  6253 38 19        			jr c,rightE ;если не пора пролистать на страницу
 394  6255 3E 14        			ld a,files_view-1
 395  6257 80           			add b
 396  6258 B9           			cp c ;если больше чем всего файлов
 397  6259 38 05        			jr c,right04
 398  625B 79           			ld a,c
 399  625C D6 15        			sub files_view ;тогда максимум файлов - 24
 400  625E 18 0B        			jr right05
 401  6260              right04
 402  6260 47           			ld b,a ;и если до последнего файла не меньше 24х
 403  6261 79           			ld a,c
 404  6262 90           			sub b
 405  6263 FE 15        			cp files_view
 406  6265 78           			ld a,b
 407  6266 30 03        			jr nc,right05
 408  6268 79           			ld a,c
 409  6269 D6 15        			sub files_view ;тогда максимум файлов - 24
 410  626B
 411  626B              right05
 412  626B 32 1E 73                 ld     (shiftcat),a ;новое смещение от начала каталога
 413  626E              rightE
 414  626E C3 46 61                 jp     wait_cont
 415  6271
 416  6271
 417  6271              ; check_sum_tog ;переключение использовать контрольную сумму или нет
 418  6271              			; ld a,(check_sum_on)
 419  6271              			; or a
 420  6271              			; jr z,check_sum_tog3
 421  6271              			; xor a
 422  6271              			; ld (check_sum_on),a
 423  6271              			; ld a,"N"
 424  6271              			; ld (mes_check_sum),a
 425  6271              			; jr check_sum_tog1
 426  6271
 427  6271              ; check_sum_tog3
 428  6271              			; ld a,1
 429  6271              			; ld (check_sum_on),a
 430  6271              			; ld a,"Y"
 431  6271              			; ld (mes_check_sum),a
 432  6271              ; check_sum_tog1
 433  6271              			; ld hl,mes_title
 434  6271              			; call print
 435  6271              			; call wait_releas
 436  6271                          ; jp     wait
 437  6271
 438  6271              driveA
 439  6271 3E 00                    ld      a,0
 440  6273 32 19 5D                 ld      (#5d19) ,a
 441  6276 32 1D 73     			ld 		(cur_drive),a
 442  6279                          ; ld      c,1
 443  6279                          ; call    #3d13
 444  6279                          ; ld      c,#18
 445  6279                          ; call    #3d13
 446  6279 CD A9 62                 call    renewcat_l
 447  627C C3 47 60                 jp      wait
 448  627F              driveB
 449  627F 3E 01                    ld      a,1
 450  6281 32 19 5D                 ld      (#5d19) ,a
 451  6284 32 1D 73     			ld 		(cur_drive),a
 452  6287                          ; ld      c,1
 453  6287                          ; call    #3d13
 454  6287                          ; ld      c,#18
 455  6287                          ; call    #3d13
 456  6287 CD A9 62                 call    renewcat_l
 457  628A C3 47 60                 jp      wait
 458  628D              driveC
 459  628D 3E 02                    ld      a,2
 460  628F 32 19 5D                 ld      (#5d19) ,a
 461  6292 32 1D 73     			ld 		(cur_drive),a
 462  6295                          ; ld      c,1
 463  6295                          ; call    #3d13
 464  6295                          ; ld      c,#18
 465  6295                          ; call    #3d13
 466  6295 CD A9 62                 call    renewcat_l
 467  6298 C3 47 60                 jp      wait
 468  629B              driveD
 469  629B 3E 03                    ld      a,3
 470  629D 32 19 5D                 ld      (#5d19) ,a
 471  62A0 32 1D 73     			ld 		(cur_drive),a
 472  62A3                          ; ld      c,1
 473  62A3                          ; call    #3d13
 474  62A3                          ; ld      c,#18
 475  62A3                          ; call    #3d13
 476  62A3 CD A9 62                 call    renewcat_l
 477  62A6 C3 47 60                 jp      wait
 478  62A9
 479  62A9
 480  62A9              renewcat_l   ;обновить каталог слева
 481  62A9 AF                       xor     a
 482  62AA 32 29 73                 ld      (curfile_l),a ;каталог перелистнуть в начало
 483  62AD 32 20 73                 ld      (shiftcat_l),a
 484  62B0 3A 2A 73     			ld a,(panel)
 485  62B3 FE 4C        			cp "L"
 486  62B5 20 07        			jr nz,renewcat_l1
 487  62B7 AF           			xor a
 488  62B8 32 25 73                 ld      (curfile),a ;
 489  62BB 32 1E 73                 ld      (shiftcat),a
 490  62BE              renewcat_l1
 491  62BE 21 80 CF     			ld hl,cat_mark_l ;очистить таблицу отмеченных файлов
 492  62C1 11 81 CF     			ld de,cat_mark_l+1
 493  62C4 36 00        			ld (hl),0
 494  62C6 01 7F 00     			ld bc,128-1
 495  62C9 ED B0        			ldir
 496  62CB CD 7D 65     			call cls_l
 497  62CE              			;ld hl,mes_title
 498  62CE                          ;call    printFI
 499  62CE CD 13 71                 call    readcat
 500  62D1                          ; ld      a,(files)
 501  62D1                          ; or      a
 502  62D1                          ; jr      nz,renew01
 503  62D1                          ; ld      hl,mesnofile
 504  62D1                          ; call    print
 505  62D1              ; renew01
 506  62D1 CD 89 6F                 call    printcat_l
 507  62D4                          ; xor     a
 508  62D4                          ; ld      (finmem),a ;no files in mem
 509  62D4 3A 2A 73     			ld a,(panel)
 510  62D7 FE 4C        			cp "L"
 511  62D9 C0           			ret nz
 512  62DA 3A 28 73     			ld     a,(files_l) ;обновить количество файлов
 513  62DD 32 24 73     			ld     (files),a
 514  62E0
 515  62E0 C9                       ret
 516  62E1
 517  62E1
 518  62E1              renewcat_r ;обновить каталог справа
 519  62E1 CD BE 78     	call check_init_r ;авто проверка инициализации
 520  62E4
 521  62E4              ;renewcat_r_
 522  62E4 21 80 F6     	ld hl,rec_buf ;очистить буфер
 523  62E7 11 81 F6     	ld de,rec_buf+1
 524  62EA 36 00        	ld (hl),0
 525  62EC 01 20 00     	ld bc,pack_size_32_com ;только начало ;
 526  62EF ED B0        	ldir
 527  62F1 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
 528  62F4 FE 20        			cp " "
 529  62F6 20 0B        			jr nz,renewcat_r1 ;продолжим
 530  62F8 21 CB 74     			ld hl,mes_stopped ;прервём
 531  62FB CD E9 76     			call print_sys
 532  62FE CD B0 6E     			call wait_releas
 533  6301 18 55        			jr cat_pass2
 534  6303              renewcat_r1
 535  6303              ;запросим каталог
 536  6303              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 537  6303
 538  6303 3E 00        	ld a,0 ;Тип пакета Запроса каталога
 539  6305 32 3B B4     	ld (trn_buf+3),a
 540  6308 ED 5B 3A 73  	ld de,(cur_cat_pag)
 541  630C ED 53 3C B4  	ld (trn_buf+4),de ;смещение каталога (текущая страница)
 542  6310              	; ld (trn_buf+4),a ;смещение обнулить
 543  6310              	; ld (trn_buf+5),a
 544  6310              	;ld de,rec_buf ;где будет начало каталога пока точно не знаем
 545  6310              	; ld (rec_buf_adr_pack),de
 546  6310              	; ld (rec_buf_adr_pack1),de
 547  6310
 548  6310              	;call open_tcp
 549  6310              	;jr c,renewcat_r ;сначала если не удачно
 550  6310
 551  6310 21 38 B4     	ld hl,trn_buf ;откуда
 552  6313 11 22 00     	ld de,pack_size_32 ;размер
 553  6316 CD B4 7B     	call Wifi.tcpSend ;отправить
 554  6319 38 C6        	jr c,renewcat_r ;сначала если не удачно
 555  631B
 556  631B 21 6D 73     	ld hl,mes_req_cat
 557  631E CD E9 76     	call print_sys ;печать сообщения пока ждём ответ
 558  6321
 559  6321              	; ld b,1 ;подождать ещё, пока ESP сообразит
 560  6321              	; call pause1
 561  6321
 562  6321 21 80 F6     	ld hl,rec_buf ;куда
 563  6324 22 5F 79     	ld (Wifi.buffer_pointer),hl
 564  6327 CD 27 7B     	call Wifi.getPacket ;приём
 565  632A 30 02        	jr nc,cat_pass1
 566  632C              	;call init_dev
 567  632C 18 B3        	jr renewcat_r ;сначала если не удачно
 568  632E              cat_pass1
 569  632E 21 80 F6     	ld hl,rec_buf
 570  6331 01 20 04     	ld bc,pack_size_1024_com+pack_size_32_com
 571  6334 ED 43 4E 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
 572  6338 0E 01        	ld c,1 ;Тип пакета Каталог
 573  633A CD 51 6E     	call check_pack ;проверить пакет
 574  633D 30 02        	jr nc,cat_pass
 575  633F              	;call init_dev
 576  633F 18 A0        	jr renewcat_r ;сначала если не удачно
 577  6341              cat_pass
 578  6341 2A 3A 73     	ld hl,(cur_cat_pag)
 579  6344 CD A2 70     	call toDecimal
 580  6347 21 FA 70     	ld hl,decimalS+2 ;
 581  634A 11 80 73     	ld de,mes_rec_cat_num
 582  634D 01 03 00     	ld bc,3
 583  6350 ED B0        	ldir
 584  6352 21 7C 73     	ld hl,mes_rec_cat
 585  6355 CD E9 76     	call print_sys ;печать сообщения
 586  6358              cat_pass2
 587  6358 21 A0 F6     	ld hl,rec_buf+32
 588  635B 11 80 EE     	ld de,cat_r
 589  635E              	;ld (rec_buf_adr_pack1),de ;перенесём каталог из буфера приёма
 590  635E 01 00 08     	ld bc,cat_r_end-cat_r
 591  6361 ED B0        	ldir
 592  6363
 593  6363 AF           	xor a
 594  6364 32 27 73     	ld (curfile_r),a ;выберем первый файл
 595  6367 32 1F 73     	ld (shiftcat_r),a ;в начало каталога
 596  636A 32 26 73     	ld (files_r),a	;всего
 597  636D 32 39 73     	ld (open_trd_flag),a
 598  6370              	;посчитаем сколько файлов
 599  6370 DD 21 80 EE  	ld ix,cat_r ;тут принятый каталог
 600  6374 21 26 73     	ld hl,files_r
 601  6377 11 10 00     	ld de,16 ;шаг
 602  637A 06 40        	ld b,max_files ;цикл строк и ограничение на количество файлов
 603  637C              calc_cat
 604  637C DD 7E 00     	ld a,(ix)
 605  637F B7           	or a
 606  6380 28 05        	jr z,calc_cat1 ;выход если в начале имени 0
 607  6382 34           	inc (hl) ;прибавим количество
 608  6383 DD 19        	add ix,de
 609  6385 10 F5        	djnz calc_cat
 610  6387              calc_cat1
 611  6387              	;call sel_right_pan ;выбор панели
 612  6387 CD E4 6E     	call printcat_r
 613  638A
 614  638A 3A 2A 73     			ld a,(panel)
 615  638D FE 52        			cp "R"
 616  638F C0           			ret nz
 617  6390 3A 26 73     			ld     a,(files_r) ;обновить количество файлов
 618  6393 32 24 73     			ld     (files),a
 619  6396 C9           	ret
 620  6397
 621  6397
 622  6397
 623  6397              run_open ;запуск файла или открытие образа
 624  6397 3A 24 73         ld     a,(files)
 625  639A B7               or     a      ;no files?
 626  639B CA 47 60         jp     z,wait
 627  639E
 628  639E 3A 2A 73     	ld a,(panel)
 629  63A1 FE 4C        	cp "L"
 630  63A3 CA 98 65     	jp z,open_left ;если в левой панели, то запуск файла
 631  63A6
 632  63A6
 633  63A6              open_trd	;открытие образа справа
 634  63A6 3A 39 73     			ld a,(open_trd_flag)
 635  63A9 B7           			or a
 636  63AA 28 47        			jr z,open_trd0 ;продолжить, если образ ещё не открыт
 637  63AC
 638  63AC 3A 25 73     			ld a,(curfile) ;текущ файл
 639  63AF B7           			or a
 640  63B0 C2 47 60     			jp nz,wait ;выход, если не на первом файле (..)
 641  63B3              	;выход из образа
 642  63B3 21 00 D0     	ld hl,cat_mark_r
 643  63B6 11 01 D0     	ld de,cat_mark_r+1
 644  63B9 36 00        	ld (hl),0
 645  63BB 01 7F 00     	ld bc,128-1
 646  63BE ED B0        	ldir
 647  63C0              	;вернём позицию курсора до открытия образа
 648  63C0 3A 3C 73     	ld a,(curfile_r2)
 649  63C3 32 25 73     	ld (curfile),a ;
 650  63C6 32 27 73     	ld (curfile_r),a ;
 651  63C9 3A 3D 73     	ld a,(shiftcat_r2)
 652  63CC 32 1E 73     	ld (shiftcat),a ;
 653  63CF 32 1F 73     	ld (shiftcat_r),a ;
 654  63D2 3A 3E 73     	ld a,(files_r2)
 655  63D5 32 26 73     	ld (files_r),a
 656  63D8 32 24 73     	ld (files),a
 657  63DB AF           	xor a
 658  63DC 32 39 73     	ld (open_trd_flag),a
 659  63DF              	;вернём каталог сервера
 660  63DF 11 80 EE     	ld de,cat_r
 661  63E2 21 70 BE     	ld hl,cat_r2
 662  63E5 01 00 04     	ld bc,max_files*16
 663  63E8 ED B0        	ldir
 664  63EA CD 62 65     	call cls_r
 665  63ED CD E4 6E     	call printcat_r ;напечатаем каталог
 666  63F0 C3 46 61     	jp wait_cont
 667  63F3
 668  63F3              open_trd0
 669  63F3              	;проверить расширение
 670  63F3 3A 25 73     	ld a,(curfile) ;текущ файл
 671  63F6 01 80 EE     	ld bc,cat_r
 672  63F9 6F           			ld l,a
 673  63FA 26 00        			ld h,0
 674  63FC 29                       add    hl,hl ;2
 675  63FD 29           			add    hl,hl ;4
 676  63FE 29           			add    hl,hl ;8
 677  63FF 29           			add    hl,hl ;16
 678  6400 09           			add hl,bc
 679  6401 CD 5E 70     	call format_name_net
 680  6404 01 09 00     	ld bc,9
 681  6407 09           	add hl,bc
 682  6408 7E           	ld a,(hl)
 683  6409 FE 74        	cp "t"
 684  640B 20 02        	jr nz,open_trd0_ckeck
 685  640D 18 05        	jr open_trd0_ckeck_ext_ok1
 686  640F              open_trd0_ckeck
 687  640F FE 54        	cp "T"
 688  6411 C2 47 60     	jp nz,wait ;выход
 689  6414
 690  6414              open_trd0_ckeck_ext_ok1
 691  6414 23           	inc hl
 692  6415 7E           	ld a,(hl)
 693  6416 FE 72        	cp "r"
 694  6418 28 05        	jr z,open_trd0_ckeck_ext_ok2
 695  641A FE 52        	cp "R"
 696  641C C2 47 60     	jp nz,wait ;выход
 697  641F
 698  641F              open_trd0_ckeck_ext_ok2
 699  641F 23           	inc hl
 700  6420 7E           	ld a,(hl)
 701  6421 FE 64        	cp "d"
 702  6423 28 05        	jr z,open_trd0_ckeck_ext_ok
 703  6425 FE 44        	cp "D"
 704  6427 C2 47 60     	jp nz,wait ;выход
 705  642A
 706  642A
 707  642A              open_trd0_ckeck_ext_ok
 708  642A              	;сохраним каталог сервера
 709  642A 21 80 EE     	ld hl,cat_r
 710  642D 11 70 BE     	ld de,cat_r2
 711  6430 01 00 04     	ld bc,max_files*16
 712  6433 ED B0        	ldir
 713  6435
 714  6435 21 00 D0     			ld hl,cat_mark_r ;очистить таблицу отмеченных файлов
 715  6438 11 01 D0     			ld de,cat_mark_r+1
 716  643B 36 00        			ld (hl),0
 717  643D 01 7F 00     			ld bc,128-1
 718  6440 ED B0        			ldir
 719  6442
 720  6442 3A 25 73     			ld a,(curfile) ;текущ файл
 721  6445 01 80 EE     			ld bc,cat_r
 722  6448 6F           			ld l,a
 723  6449 26 00        			ld h,0
 724  644B 29                       add    hl,hl ;2
 725  644C 29           			add    hl,hl ;4
 726  644D 29           			add    hl,hl ;8
 727  644E 29           			add    hl,hl ;16
 728  644F 09           			add hl,bc
 729  6450
 730  6450 11 48 B4     			ld de,trn_buf+16 ;перекинем имя файла в запрос
 731  6453 01 0C 00     			ld bc,file_name_len
 732  6456 ED B0        			ldir
 733  6458
 734  6458 AF           			xor a
 735  6459 32 44 B4     			ld (trn_buf+12),a ;размер файла 655360
 736  645C 32 45 B4     			ld (trn_buf+13),a
 737  645F 32 47 B4     			ld (trn_buf+15),a
 738  6462 3E 0A        			ld a,#a
 739  6464 32 46 B4     			ld (trn_buf+14),a
 740  6467
 741  6467 3E 06        			ld a,6 ;Тип пакета Запрос приёма файла 256 байт
 742  6469 32 3B B4     			ld (trn_buf+3),a
 743  646C 21 00 00     			ld hl,0 ;счётчик частей
 744  646F 22 3C B4     			ld (trn_buf+4),hl
 745  6472 DD 2E 09     			ld xl,9 ;частей всего цикл
 746  6475 DD 26 00     			ld xh,0 ;начать с сектора 0
 747  6478
 748  6478              open_trd3	;цикл
 749  6478 CD BE 78     	call check_init_r ;авто проверка инициализации
 750  647B
 751  647B DD 7D        			ld a,xl
 752  647D 6F           			ld l,a
 753  647E 26 00        			ld h,0
 754  6480 CD BE 71     			call print_progress
 755  6483
 756  6483 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
 757  6486 FE 20        			cp " "
 758  6488 20 0C        			jr nz,open_trd2 ;продолжим
 759  648A 21 CB 74     			ld hl,mes_stopped ;прервём
 760  648D CD E9 76     			call print_sys
 761  6490 CD B0 6E     			call wait_releas
 762  6493 C3 1C 60     			jp start_h
 763  6496
 764  6496              open_trd2
 765  6496              			;call open_tcp
 766  6496              			;jr c,open_trd3 ;если ошибка, то новая попытка
 767  6496
 768  6496 21 38 B4     			ld hl,trn_buf ;откуда
 769  6499 11 22 00     			ld de,pack_size_32 ;размер
 770  649C CD B4 7B     			call Wifi.tcpSend ;отправить
 771  649F 38 D7        			jr c,open_trd3 ;если ошибка, то новая попытка
 772  64A1
 773  64A1 21 8A 73     			ld hl,mes_req_part_file ;сообщение пока ждём ответ
 774  64A4 CD E9 76     			call print_sys
 775  64A7
 776  64A7 21 80 F6     			ld hl,rec_buf ;куда
 777  64AA 22 5F 79     			ld (Wifi.buffer_pointer),hl
 778  64AD CD 27 7B     			call Wifi.getPacket ;приём
 779  64B0 30 02        			jr nc,open_check_pass1
 780  64B2              			;call init_dev
 781  64B2 18 C4        			jr open_trd3 ;если ошибка, то новая попытка
 782  64B4
 783  64B4              open_check_pass1	;принят пакет
 784  64B4 21 C2 73     			ld hl,mes_rec_part_file ;сообщение
 785  64B7 CD E9 76     			call print_sys
 786  64BA 21 80 F6     			ld hl,rec_buf
 787  64BD 01 20 01     	ld bc,pack_size_256_com+pack_size_32_com
 788  64C0 ED 43 4E 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
 789  64C4 0E 07        			ld c,7 ; Тип пакета Файл 256
 790  64C6 CD 51 6E     			call check_pack
 791  64C9 30 02        			jr nc,open_check_pass
 792  64CB              			;call init_dev
 793  64CB 18 AB        			jr open_trd3 ;если ошибка, то новая попытка
 794  64CD
 795  64CD              open_check_pass	;проверка прошла
 796  64CD
 797  64CD DD 7C        	ld a,xh ;какой сектор по счёту
 798  64CF DD 24        	inc xh
 799  64D1 21 A0 F6     	ld hl,rec_buf+32
 800  64D4 11 80 C6     	ld de,cat_open_trd+16 ;первый файл пропустим, он будет ".."
 801  64D7 82           	add d ;прибавить смещение на сектор
 802  64D8 57           	ld d,a
 803  64D9 01 00 01     	ld bc,pack_size_256_com
 804  64DC ED B0        	ldir ;перекинем часть каталога
 805  64DE
 806  64DE 2A 3C B4     			ld hl,(trn_buf+4) ;следующая честь файла
 807  64E1 23           			inc hl
 808  64E2 22 3C B4     			ld (trn_buf+4),hl
 809  64E5
 810  64E5 DD 2D        			dec xl
 811  64E7 C2 78 64     			jp nz,open_trd3
 812  64EA
 813  64EA
 814  64EA              	;обработаем каталог
 815  64EA 3E 2E        	ld a,"." ;в начале двоеточие для возврата
 816  64EC 32 70 C6     	ld (cat_open_trd),a
 817  64EF 32 71 C6     	ld (cat_open_trd+1),a
 818  64F2 AF           	xor a
 819  64F3 32 72 C6     	ld (cat_open_trd+2),a
 820  64F6 01 0A 00     	ld bc,13-3
 821  64F9 21 72 C6     	ld hl,cat_open_trd+2
 822  64FC 11 73 C6     	ld de,cat_open_trd+3
 823  64FF ED B0        	ldir
 824  6501
 825  6501              	; ld ixl,max_files_trd+1 ;отформатируем для красоты имён
 826  6501              	; ld hl,cat_open_trd
 827  6501              	; ld de,cat_open_trd ;(rec_buf_adr_pack1) ;перенос обратно
 828  6501              ; open_trd_frm
 829  6501              	; push hl
 830  6501              	; push de
 831  6501              	; call formatName
 832  6501              	; pop de
 833  6501              	; ld bc,16
 834  6501              	; ldir
 835  6501              	; pop hl
 836  6501              	; ld bc,16
 837  6501              	; add hl,bc
 838  6501              	; dec ixl
 839  6501              	; jr nz,open_trd_frm
 840  6501
 841  6501              	;запомнить на каком файле были в правой панели
 842  6501 3A 25 73     	ld a,(curfile)
 843  6504 32 3C 73     	ld (curfile_r2),a ;
 844  6507 3A 1E 73     	ld a,(shiftcat)
 845  650A 32 3D 73     	ld (shiftcat_r2),a ;
 846  650D 3A 24 73     	ld a,(files)
 847  6510 32 3F 73     	ld (files2),a
 848  6513 3A 26 73     	ld a,(files_r)
 849  6516 32 3E 73     	ld (files_r2),a
 850  6519
 851  6519 AF           	xor a
 852  651A 32 27 73     	ld (curfile_r),a ;выберем первый файл
 853  651D 32 1F 73     	ld (shiftcat_r),a ;в начало каталога
 854  6520 32 26 73     	ld (files_r),a	;всего
 855  6523 32 1E 73     	ld     (shiftcat),a
 856  6526 32 25 73     	ld     (curfile),a
 857  6529 3E 01        	ld a,1
 858  652B 32 39 73     	ld (open_trd_flag),a ;открыт образ
 859  652E
 860  652E              	;посчитаем сколько файлов
 861  652E DD 21 70 C6  	ld ix,cat_open_trd ;тут принятый каталог
 862  6532 21 26 73     	ld hl,files_r
 863  6535 11 10 00     	ld de,16 ;шаг
 864  6538 06 81        	ld b,max_files_trd+1 ;цикл строк и ограничение на количество файлов
 865  653A              open_trd_calc_cat
 866  653A DD 7E 00     	ld a,(ix)
 867  653D B7           	or a
 868  653E 28 05        	jr z,open_trd_calc_cat1 ;выход если в начале имени 0
 869  6540 34           	inc (hl) ;прибавим количество
 870  6541 DD 19        	add ix,de
 871  6543 10 F5        	djnz open_trd_calc_cat
 872  6545              open_trd_calc_cat1
 873  6545
 874  6545 CD 62 65     	call cls_r ;очистить правую панель
 875  6548 CD E4 6E     	call printcat_r
 876  654B
 877  654B 21 EA 75     	ld hl,mes_progress_off
 878  654E CD 09 77     	call print
 879  6551
 880  6551 3A 2A 73     			ld a,(panel)
 881  6554 FE 52        			cp "R"
 882  6556 C2 47 60     			jp nz,wait
 883  6559 3A 26 73     			ld     a,(files_r) ;обновить количество файлов
 884  655C 32 24 73     			ld     (files),a
 885  655F
 886  655F C3 47 60     	jp wait
 887  6562
 888  6562
 889  6562              cls_r ;очистка правой панели
 890  6562 AF                       xor     a
 891  6563              cls_r1
 892  6563 F5                       push    af
 893  6564 32 59 73                 ld      (catposit_r+1),a
 894  6567 21 58 73                 ld      hl,catposit_r ;установим позицию печати
 895  656A CD 09 77                 call    print
 896  656D 21 5C 73     			ld      hl,cat_space ;пробелами забьём
 897  6570 01 0C 00     			ld 		bc,12 ;длина
 898  6573 CD F8 76                 call    print_ ;печать одного имени файла
 899  6576 F1                       pop     af
 900  6577 3C                       inc     a
 901  6578 FE 15                    cp      files_view
 902  657A 38 E7                    jr      c,cls_r1
 903  657C C9           			ret
 904  657D
 905  657D              cls_l ;очистка левой панели
 906  657D AF                       xor     a
 907  657E              cls_l1
 908  657E F5                       push    af
 909  657F 32 55 73                 ld      (catposit_l+1),a
 910  6582 21 54 73                 ld      hl,catposit_l ;установим позицию печати
 911  6585 CD 09 77                 call    print
 912  6588 21 5C 73     			ld      hl,cat_space ;пробелами забьём
 913  658B 01 0C 00     			ld 		bc,12 ;длина
 914  658E CD F8 76                 call    print_ ;печать одного имени файла
 915  6591 F1                       pop     af
 916  6592 3C                       inc     a
 917  6593 FE 15                    cp      files_view
 918  6595 38 E7                    jr      c,cls_l1
 919  6597 C9           			ret
 920  6598
 921  6598              open_left ;enter в левой панели
 922  6598 3A 1D 73     	ld a,(cur_drive)
 923  659B FE 04        	cp 4
 924  659D D2 91 7E     	jp nc,open_dir_l
 925  65A0
 926  65A0              launch_basic ;запуск бэйсик файла из левой панели
 927  65A0
 928  65A0              	;Подставим имя файла в загрузчик
 929  65A0
 930  65A0 3A 25 73     			ld a,(curfile) ;текущ файл
 931  65A3 01 80 D0     			ld bc,cat_l
 932  65A6 6F           			ld l,a
 933  65A7 26 00        			ld h,0
 934  65A9 29                       add    hl,hl ;2
 935  65AA 29           			add    hl,hl ;4
 936  65AB 29           			add    hl,hl ;8
 937  65AC 29           			add    hl,hl ;16
 938  65AD 09           			add hl,bc
 939  65AE E5           			push hl
 940  65AF DD E1        			pop ix ;запомним
 941  65B1 01 08 00     			ld bc,8
 942  65B4 09           			add hl,bc
 943  65B5 7E           			ld a,(hl)
 944  65B6 FE 42        			cp "B"
 945  65B8 C2 47 60     			jp nz,wait ;если не бэйсик файл
 946  65BB
 947  65BB              	;ищем заготовленную бэйсик строку
 948  65BB 21 00 5B     	ld hl,#5b00
 949  65BE 01 00 25     	ld bc,#8000-#5b00
 950  65C1
 951  65C1              launch_find
 952  65C1 3E 2D        	ld a,"-" ;символ, который забит временно вместо имени
 953  65C3 BE           	cp (hl)
 954  65C4 20 0B        	jr nz,launch_find_next
 955  65C6 16 07        	ld d,7 ;сколько символов сравнить
 956  65C8              launch_find1
 957  65C8 23           	inc hl
 958  65C9 BE           	cp (hl)
 959  65CA 20 05        	jr nz,launch_find_next
 960  65CC 15           	dec d
 961  65CD 20 F9        	jr nz,launch_find1
 962  65CF 18 09        	jr launch_find_ok ;нашли
 963  65D1
 964  65D1              launch_find_next
 965  65D1 23           	inc hl
 966  65D2 0B           	dec bc
 967  65D3 78           	ld a,b
 968  65D4 B1           	or c
 969  65D5 20 EA        	jr nz,launch_find
 970  65D7 C3 47 60     	jp wait ;не нашли строки
 971  65DA
 972  65DA              launch_find_ok
 973  65DA 01 07 00     	ld bc,7 ;в начало имени
 974  65DD A7           	and a
 975  65DE ED 42        	sbc hl,bc
 976  65E0 EB           	ex de,hl
 977  65E1 DD E5        	push ix ;вспомним
 978  65E3 E1           	pop hl
 979  65E4 01 08 00     	ld bc,8
 980  65E7 ED B0        	ldir
 981  65E9
 982  65E9 C3 3C 61     	jp exit
 983  65EC
 984  65EC
 985  65EC
 986  65EC              ; link_off ;попытка вывести ESP из режима моста translink
 987  65EC              	; ld hl,mes_translink_off
 988  65EC              	; call print_sys
 989  65EC
 990  65EC              	; ;call clear_input
 991  65EC
 992  65EC              	; ld hl,cmd_brk
 993  65EC              	; ld de,cmd_brk_end-cmd_brk
 994  65EC              	; call start_trn1 ;оправка
 995  65EC              	; call pause
 996  65EC              	; ;call clear_input
 997  65EC
 998  65EC              	; ld hl,cmd_savetrans_0 ;выключение моста
 999  65EC              	; ld de,cmd_savetrans_0_end-cmd_savetrans_0
1000  65EC              	; call start_trn1 ;оправка
1001  65EC              	; call pause
1002  65EC              	; ;call clear_input
1003  65EC
1004  65EC              	; ld hl,cmd_rst
1005  65EC              	; ld de,cmd_rst_end-cmd_rst
1006  65EC              	; call start_trn1
1007  65EC              	; call pause
1008  65EC              	; ;call clear_input
1009  65EC
1010  65EC              	; ld hl,mes_ok
1011  65EC              	; call print_sys
1012  65EC
1013  65EC              	; jp wait
1014  65EC
1015  65EC              ; link_on ;попытка включить ESP в режим моста translink
1016  65EC              	; ld hl,mes_translink_on
1017  65EC              	; call print_sys
1018  65EC
1019  65EC              	; ;call clear_input
1020  65EC              	; halt
1021  65EC              	; halt
1022  65EC              	; ;call clear_input
1023  65EC
1024  65EC              	; ld hl,cmd_uart
1025  65EC              	; ld de,cmd_uart_end-cmd_uart
1026  65EC              	; call start_trn1
1027  65EC              	; ld b,150
1028  65EC              	; call pause1
1029  65EC              	; ;call clear_input
1030  65EC
1031  65EC              	; ld hl,cmd_cwmode
1032  65EC              	; ld de,cmd_cwmode_end-cmd_cwmode
1033  65EC              	; call start_trn1 ;оправка
1034  65EC              	; ld b,150
1035  65EC              	; call pause1
1036  65EC              	; ;call clear_input
1037  65EC
1038  65EC              	; ld hl,cmd_cwjap
1039  65EC              	; ld de,cmd_cwjap_end-cmd_cwjap
1040  65EC              	; call start_trn1 ;оправка
1041  65EC              	; ld b,255
1042  65EC              	; call pause1
1043  65EC              	; ld b,255
1044  65EC              	; call pause1
1045  65EC              	; ;call clear_input
1046  65EC
1047  65EC              	; ld hl,cmd_savetrans_1
1048  65EC              	; ld de,cmd_savetrans_1_end-cmd_savetrans_1
1049  65EC              	; call start_trn1
1050  65EC              	; ld b,150
1051  65EC              	; call pause1
1052  65EC              	; ;call clear_input
1053  65EC
1054  65EC              	; ld hl,cmd_rst
1055  65EC              	; ld de,cmd_rst_end-cmd_rst
1056  65EC              	; call start_trn1
1057  65EC              	; ld b,150
1058  65EC              	; call pause1
1059  65EC              	; ;call clear_input
1060  65EC
1061  65EC              	; ld hl,mes_ok
1062  65EC              	; call print_sys
1063  65EC
1064  65EC              	; jp wait
1065  65EC
1066  65EC
1067  65EC              esp_rst ;сброс ESP
1068  65EC 21 F1 73     	ld hl,mes_esp_rst
1069  65EF CD E9 76     	call print_sys
1070  65F2
1071  65F2              	;call clear_input
1072  65F2
1073  65F2 21 32 7C     	ld hl,cmd_brk
1074  65F5 11 03 00     	ld de,cmd_brk_end-cmd_brk
1075  65F8 CD AD 78     	call start_trn1 ;оправка
1076  65FB 06 05        	ld b,5
1077  65FD CD 19 66     	call pause1
1078  6600              	;call clear_input
1079  6600
1080  6600 21 2A 7C     	ld hl,cmd_rst
1081  6603 11 08 00     	ld de,cmd_rst_end-cmd_rst
1082  6606 CD AD 78     	call start_trn1
1083  6609 06 05        	ld b,5
1084  660B CD 19 66     	call pause1
1085  660E              	;call clear_input
1086  660E
1087  660E 21 FB 73     	ld hl,mes_ok
1088  6611 CD E9 76     	call print_sys
1089  6614
1090  6614 C3 47 60     	jp wait
1091  6617
1092  6617              pause
1093  6617 06 32        	ld b,50 ;пауза секунду
1094  6619              pause1
1095  6619 76           	halt
1096  661A 10 FD        	djnz pause1
1097  661C C9           	ret
1098  661D
1099  661D
1100  661D
1101  661D
1102  661D
1103  661D
1104  661D
1105  661D              copyF ;копирование по файлам
1106  661D 3A 24 73                 ld     a,(files)
1107  6620 B7                       or     a      ;если нет файлов там, где курсор, то выход
1108  6621 CA 47 60                 jp     z,wait
1109  6624
1110  6624              			;определить панель
1111  6624 3A 2A 73     			ld a,(panel)
1112  6627 FE 52        			cp "R"
1113  6629 CA 54 68     			jp z,copyF_RL
1114  662C
1115  662C
1116  662C
1117  662C              copyF_LR
1118  662C              			;из левой панели в правую файлы TRD
1119  662C
1120  662C 3A 1D 73     			ld a,(cur_drive)
1121  662F FE 04        			cp 4
1122  6631 D2 DF 7E     			jp nc,copyF_LR_FAT ;если слева FAT
1123  6634
1124  6634
1125  6634              			;копирование файлов TRD слева направо
1126  6634 3A 39 73     			ld     a,(open_trd_flag)
1127  6637 B7                       or     a      ;если не открыт образ справа, то выход
1128  6638 CA 47 60     			jp 		z,wait
1129  663B
1130  663B
1131  663B              			;окно запроса с выбором диска
1132  663B 3A 1D 73     			ld a,(cur_drive)
1133  663E C6 41        			add a,"A"
1134  6640 32 88 74     			ld (mes_trd_dsk+3),a
1135  6643 21 A5 75     			ld hl,mes_copy_file
1136  6646 CD 09 77     			call print
1137  6649 21 85 74     			ld hl,mes_trd_dsk
1138  664C CD 09 77     			call print
1139  664F 3E 27        			ld a,col_win
1140  6651 CD 2C 6E     			call paint_win
1141  6654              copyF_LR_w ;ожидание согласия
1142  6654 76           			halt
1143  6655 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
1144  6658 FE 4E        			cp 		"N"
1145  665A CA 61 6A     			jp z,copyF_exit ;выход если нет согласия
1146  665D FE 59        			cp 		"Y"
1147  665F 20 F3        			jr nz,copyF_LR_w
1148  6661
1149  6661              			;узнать сколько отмеченных файлов
1150  6661 21 80 CF     			ld hl,cat_mark_l
1151  6664 06 80        			ld b,128 ;размер таблицы
1152  6666 DD 2E 00     			ld xl,0 ;счётчик
1153  6669              copyF_LR_no_one_chk
1154  6669 7E           			ld a,(hl)
1155  666A B7           			or a
1156  666B 28 02        			jr z,copyF_LR_no_one_chk1
1157  666D DD 2C        			inc xl
1158  666F              copyF_LR_no_one_chk1
1159  666F 23           			inc hl
1160  6670 10 F7        			djnz copyF_LR_no_one_chk
1161  6672 DD 2C        			inc xl
1162  6674 DD 2D        			dec xl
1163  6676 20 11        			jr nz,copyF_LR_no_one ;не один
1164  6678 3A 25 73     			ld a,(curfile) ;тогда только текущий файл
1165  667B CD CB 66     			call copyF_LR_one
1166  667E D2 61 6A     			jp nc,copyF_exit ;выход без ошибки
1167  6681 FE FF        			cp 255
1168  6683 CA 61 6A     			jp z,copyF_exit ;выход после останова
1169  6686 C3 81 6A     			jp copyF_error ;выход с ошибкой
1170  6689
1171  6689
1172  6689              copyF_LR_no_one ;копировать несколько
1173  6689 21 80 CF     			ld hl,cat_mark_l
1174  668C DD 7D        			ld a,xl
1175  668E 32 53 73     			ld (cat_mark_cur_tot),a
1176  6691 AF           			xor a
1177  6692              copyF_LR_no_one_cl
1178  6692 32 52 73     			ld (cat_mark_cur_cl),a
1179  6695 22 50 73     			ld (cat_mark_cur),hl
1180  6698 7E           			ld a,(hl) ;есть отметка?
1181  6699 B7           			or a
1182  669A 28 1E        			jr z,copyF_LR_no_one_cl1
1183  669C 3A 53 73     			ld a,(cat_mark_cur_tot)
1184  669F 6F           			ld l,a
1185  66A0 26 00        			ld h,0
1186  66A2 3D           			dec a
1187  66A3 32 53 73     			ld (cat_mark_cur_tot),a
1188  66A6 CD D3 71     			call print_progress_tot ;прогресс
1189  66A9 3A 52 73     			ld a,(cat_mark_cur_cl) ;очередной номер файла
1190  66AC CD CB 66     			call copyF_LR_one ;скопировать
1191  66AF D2 BA 66     			jp nc,copyF_LR_no_one_cl1 ;продолжить без ошибки
1192  66B2 FE FF        			cp 255
1193  66B4 CA 61 6A     			jp z,copyF_exit ;выход после останова
1194  66B7 C3 81 6A     			jp copyF_error ;выход с ошибкой
1195  66BA
1196  66BA              copyF_LR_no_one_cl1
1197  66BA 2A 50 73     			ld hl,(cat_mark_cur)
1198  66BD 36 00        			ld (hl),0 ;снять отметку
1199  66BF 23           			inc hl
1200  66C0 3A 52 73     			ld a,(cat_mark_cur_cl)
1201  66C3 3C           			inc a
1202  66C4 FE 80        			cp 128
1203  66C6 38 CA        			jr c,copyF_LR_no_one_cl
1204  66C8
1205  66C8 C3 61 6A     			jp copyF_exit
1206  66CB
1207  66CB
1208  66CB
1209  66CB
1210  66CB              copyF_LR_one ;скопировать один файл слева направо
1211  66CB              			;на входе в A - номер файла
1212  66CB              			;на выходе C=1, если ошибка; A=255, если остановлено
1213  66CB 08           			ex af,af'
1214  66CC              			;узнать есть ли место на диске
1215  66CC 3A 64 CF     			ld a,(cat_open_trd+8*256+#e4+16) ; общее количество файлов в образе
1216  66CF FE 80        			cp 128
1217  66D1 D2 51 68     			jp nc,copyF_LR_error ;если уже максимум
1218  66D4 08           			ex af,af'
1219  66D5              			;узнать параметры файла
1220  66D5              			; ld de,0
1221  66D5              			; ld      (#5ceb),de ;начало сектор дорожка
1222  66D5 01 80 D0     			ld bc,cat_l ;каталог диска слева
1223  66D8              			;ld a,(curfile) ;текущ файл
1224  66D8 6F           			ld l,a
1225  66D9 26 00        			ld h,0
1226  66DB 29                       add    hl,hl ;2
1227  66DC 29           			add    hl,hl ;4
1228  66DD 29           			add    hl,hl ;8
1229  66DE 29           			add    hl,hl ;16
1230  66DF 09           			add hl,bc
1231  66E0
1232  66E0 22 45 73     			ld (copyF_RL_source_file),hl ;указатель на запись о файле
1233  66E3 01 0D 00     			ld bc,13
1234  66E6 09           			add hl,bc
1235  66E7 7E           			ld a,(hl) ;объём файла в секторах
1236  66E8 32 47 73     			ld (copyF_RL_source_sec_size),a ;
1237  66EB 4F           			ld c,a
1238  66EC 06 00        			ld b,0
1239  66EE 23           			inc hl
1240  66EF 5E           			ld e,(hl)
1241  66F0 23           			inc hl
1242  66F1 56           			ld d,(hl)
1243  66F2 ED 53 49 73  			ld (copyF_RL_source_trk),de ;исходные дорожка-сектор
1244  66F6 ED 53 EB 5C  			ld (#5ceb),de ;отсюда начнём считывать
1245  66FA
1246  66FA 2A 65 CF     			ld hl,(cat_open_trd+8*256+#e5+16) ; количество свободных секторов в образе
1247  66FD A7           			and a
1248  66FE ED 42        			sbc hl,bc
1249  6700 DA 51 68     			jp c,copyF_LR_error ;если не хватает места
1250  6703
1251  6703              			;цикл по размеру в секторах
1252  6703 DD 6F        			ld xl,a
1253  6705
1254  6705 2A 61 CF     			ld hl,(cat_open_trd+8*256+#e1+16) ;первые свободные сектор-дорожка назначения
1255  6708              			;узнаем где будет файл
1256  6708              			;пересчитать дорожки-секторы в пакеты
1257  6708 4D           			ld c,l ;секторы
1258  6709 06 00        			ld b,0
1259  670B 6C           			ld l,h ;дорожки
1260  670C 26 00        			ld h,0
1261  670E 29           			add hl,hl ;*2
1262  670F 29           			add hl,hl ;*4
1263  6710 29           			add hl,hl ;*8
1264  6711 29           			add hl,hl ;*16
1265  6712 09           			add hl,bc ;добавить секторы
1266  6713              			;ld hl,0 ;счётчик частей
1267  6713 22 3C B4     			ld (trn_buf+4),hl
1268  6716
1269  6716              			;начинаем копировать файл
1270  6716
1271  6716 3A 3C 73     			ld a,(curfile_r2) ;текущ файл образа
1272  6719 01 70 BE     			ld bc,cat_r2
1273  671C 6F           			ld l,a
1274  671D 26 00        			ld h,0
1275  671F 29                       add    hl,hl ;2
1276  6720 29           			add    hl,hl ;4
1277  6721 29           			add    hl,hl ;8
1278  6722 29           			add    hl,hl ;16
1279  6723 09           			add hl,bc
1280  6724
1281  6724 11 48 B4     			ld de,trn_buf+16 ;перекинем имя файла в запрос
1282  6727 01 0C 00     			ld bc,file_name_len
1283  672A ED B0        			ldir
1284  672C 3E 08        			ld a,8 ;Тип пакета Запрос на передачу файла 256 байт
1285  672E 32 3B B4     			ld (trn_buf+3),a
1286  6731
1287  6731 AF           			xor a
1288  6732 32 44 B4     			ld (trn_buf+12),a ;размер файла 655360
1289  6735 32 45 B4     			ld (trn_buf+13),a
1290  6738 32 47 B4     			ld (trn_buf+15),a
1291  673B 3E 0A        			ld a,#a
1292  673D 32 46 B4     			ld (trn_buf+14),a
1293  6740
1294  6740
1295  6740
1296  6740              			;цикл
1297  6740              copyF_LR3
1298  6740 DD 7D        			ld a,xl
1299  6742 6F           			ld l,a
1300  6743 26 00        			ld h,0
1301  6745 CD BE 71     			call print_progress
1302  6748
1303  6748 21 58 B4     	ld hl,trn_buf+pack_size_32_com ;адрес отправляемого пакета
1304  674B ED 5B EB 5C  	ld de,(#5ceb)
1305  674F 01 05 01     	ld bc,#0105
1306  6752 CD 13 3D     	call #3d13 ;считать 1 сектор
1307  6755
1308  6755 CD F4 67     	call sec256_to_srv ;отправить на сервер
1309  6758
1310  6758              copyF_LR_check_pass	;проверка прошла
1311  6758
1312  6758 ED 5B EB 5C  	ld de,(#5ceb)
1313  675C 06 01        	ld b,1
1314  675E CD BF 6E     	call calc_next_pos2 ;сменить позицию на 1 сектор
1315  6761
1316  6761 2A 3C B4     			ld hl,(trn_buf+4) ;следующая честь файла
1317  6764 23           			inc hl
1318  6765 22 3C B4     			ld (trn_buf+4),hl
1319  6768
1320  6768 DD 2D        			dec xl
1321  676A C2 40 67     			jp nz,copyF_LR3
1322  676D
1323  676D              			;теперь поправить каталог
1324  676D
1325  676D              			;запись о файле
1326  676D 3A 64 CF     			ld a,(cat_open_trd+8*256+#e4+16) ; общее количество файлов
1327  6770 6F           			ld l,a ;узнать в каком секторе будет запись о файле
1328  6771 26 00        			ld h,0
1329  6773 29           			add hl,hl ;*2
1330  6774 29           			add hl,hl ;*4
1331  6775 29           			add hl,hl ;*8
1332  6776 29           			add hl,hl ;*16
1333  6777 7C           			ld a,h ;запомнить номер сетора в каталоге
1334  6778 32 4B 73     			ld (copyF_RL_dest_sec_cat),a
1335  677B 01 80 C6     			ld bc,cat_open_trd+16
1336  677E 09           			add hl,bc ;здесь будет запись о новом файле
1337  677F EB           			ex de,hl
1338  6780
1339  6780 2A 45 73     			ld hl,(copyF_RL_source_file) ;запись о файле
1340  6783 01 10 00     			ld bc,16
1341  6786 ED B0        			ldir ;скопировать
1342  6788 EB           			ex de,hl
1343  6789 2B           			dec hl
1344  678A ED 5B 61 CF  			ld de,(cat_open_trd+8*256+#e1+16) ;первые свободные сектор-дорожка назначения
1345  678E 72           			ld (hl),d ;дорожка
1346  678F 2B           			dec hl
1347  6790 73           			ld (hl),e ;сектор
1348  6791
1349  6791 3A 4B 73     			ld a,(copyF_RL_dest_sec_cat)
1350  6794 67           			ld h,a
1351  6795 2E 00        			ld l,0
1352  6797 01 80 C6     			ld bc,cat_open_trd+16 ;скопировать сектор с учётом первой записи ".."
1353  679A 09           			add hl,bc
1354  679B 11 58 B4     			ld de,trn_buf+pack_size_32_com
1355  679E 01 00 01     			ld bc,256
1356  67A1 ED B0        			ldir
1357  67A3
1358  67A3 26 00        			ld h,0
1359  67A5 3A 4B 73     			ld a,(copyF_RL_dest_sec_cat)
1360  67A8 6F           			ld l,a ;номер сектора
1361  67A9 22 3C B4     			ld (trn_buf+4),hl ;номер части
1362  67AC              			;отправка сектора в образ
1363  67AC CD F4 67     			call sec256_to_srv
1364  67AF
1365  67AF              			;служебный сектор
1366  67AF ED 5B 61 CF  			ld de,(cat_open_trd+8*256+#e1+16) ;первые свободные сектор-дорожка назначения
1367  67B3 3A 47 73     			ld a,(copyF_RL_source_sec_size) ;размер файла
1368  67B6 47           			ld b,a
1369  67B7 CD BF 6E     			call calc_next_pos2
1370  67BA ED 53 61 CF  			ld (cat_open_trd+8*256+#e1+16),de
1371  67BE
1372  67BE 2A 65 CF     			ld hl,(cat_open_trd+8*256+#e5+16) ; количество свободных секторов на диске
1373  67C1 3A 47 73     			ld a,(copyF_RL_source_sec_size) ;размер файла
1374  67C4 4F           			ld c,a
1375  67C5 06 00        			ld b,0
1376  67C7 A7           			and a
1377  67C8 ED 42        			sbc hl,bc
1378  67CA 22 65 CF     			ld (cat_open_trd+8*256+#e5+16),hl
1379  67CD
1380  67CD 21 64 CF     			ld hl,cat_open_trd+8*256+#e4+16 ; общее количество файлов
1381  67D0 34           			inc (hl)
1382  67D1
1383  67D1 21 80 CE     			ld hl,cat_open_trd+8*256+16
1384  67D4 11 58 B4     			ld de,trn_buf+pack_size_32_com
1385  67D7 01 00 01     			ld bc,256
1386  67DA ED B0        			ldir
1387  67DC
1388  67DC              			;отправка сектора в образ
1389  67DC 21 08 00     			ld hl,#0008
1390  67DF 22 3C B4     			ld (trn_buf+4),hl ;номер части
1391  67E2 CD F4 67     			call sec256_to_srv
1392  67E5
1393  67E5 3A 26 73     			ld     a,(files_r) ;обновить количество файлов
1394  67E8 3C           			inc a
1395  67E9 32 26 73     			ld     (files_r),a
1396  67EC
1397  67EC              			;call cls_r ;очистить правую панель
1398  67EC CD 89 6F     			call printcat_l
1399  67EF CD E4 6E     			call printcat_r
1400  67F2
1401  67F2 AF           			xor a ;С=0, нет ошибок
1402  67F3 C9           			ret
1403  67F4
1404  67F4
1405  67F4              sec256_to_srv
1406  67F4              			;отправка сектора 256 в образ. заголовок пакета уже должен быть готов
1407  67F4 CD BE 78     			call check_init_r ;авто проверка инициализации
1408  67F7
1409  67F7 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
1410  67FA FE 20        			cp " "
1411  67FC 20 0E        			jr nz,sec256_to_srv2 ;продолжим
1412  67FE 21 CB 74     			ld hl,mes_stopped ;прервём
1413  6801 CD E9 76     			call print_sys
1414  6804 CD B0 6E     			call wait_releas
1415  6807 E1           			pop hl ;поправить адрес возврата
1416  6808 3E FF        			ld a,255 ;ошибка останов
1417  680A 3F           			ccf ;С=1
1418  680B C9           			ret
1419  680C
1420  680C              sec256_to_srv2
1421  680C
1422  680C
1423  680C 11 38 B4     			ld de,trn_buf
1424  680F 01 20 01     			ld bc,pack_size_256_com+pack_size_32_com
1425  6812 ED 43 4E 73  			ld (check_sum_size),bc
1426  6816 CD FD 70     			call calc_check_sum ;проверить сумму
1427  6819 22 58 B5     			ld (trn_buf+pack_size_256_com+pack_size_32_com),hl ;записать её в пакет
1428  681C
1429  681C              			;call open_tcp
1430  681C              			;jr c,sec256_to_srv ;если ошибка, повтор
1431  681C
1432  681C 21 38 B4     			ld hl,trn_buf ;откуда
1433  681F 11 22 01     			ld de,pack_size_256 ;размер
1434  6822 CD B4 7B     			call Wifi.tcpSend ;отправить
1435  6825 38 CD        			jr c,sec256_to_srv ;если ошибка, повтор
1436  6827
1437  6827 21 9A 73     			ld hl,mes_trq_part_file ;сообщение пока ждём ответ
1438  682A CD E9 76     			call print_sys
1439  682D
1440  682D 21 80 F6     			ld hl,rec_buf ;куда
1441  6830 22 5F 79     			ld (Wifi.buffer_pointer),hl
1442  6833 CD 27 7B     			call Wifi.getPacket ;приём
1443  6836 38 BC        			jr c,sec256_to_srv ;если ошибка, повтор
1444  6838
1445  6838              			;принят пакет
1446  6838 21 CD 73     			ld hl,mes_trn_part_file ;сообщение
1447  683B CD E9 76     			call print_sys
1448  683E 21 80 F6     			ld hl,rec_buf
1449  6841 01 20 00     			ld bc,pack_size_32_com
1450  6844 ED 43 4E 73  			ld (check_sum_size),bc ;задать длину пакета для подсчёта
1451  6848 0E 09        			ld c,9 ; Тип пакета Файл 256
1452  684A CD 51 6E     			call check_pack
1453  684D 38 A5        			jr c,sec256_to_srv ;если ошибка]повтор
1454  684F AF           			xor a
1455  6850 C9           			ret ;выход без ошибок
1456  6851
1457  6851              copyF_LR_error ;выход с ошибкой
1458  6851 AF           			xor a
1459  6852 3F           			ccf ;C=1
1460  6853 C9           			ret
1461  6854
1462  6854
1463  6854
1464  6854
1465  6854
1466  6854
1467  6854
1468  6854
1469  6854
1470  6854              copyF_RL ;копирование файлов справа налево TRD
1471  6854
1472  6854 3A 1D 73     			ld a,(cur_drive)
1473  6857 FE 04        			cp 4
1474  6859 D2 98 80     			jp nc,copyF_RL_FAT ;если слева FAT
1475  685C
1476  685C 3A 39 73     			ld a,(open_trd_flag)
1477  685F B7           			or a
1478  6860 CA 47 60     			jp z,wait ;выход, если справа не открыт образ
1479  6863
1480  6863              			;узнать сколько отмеченных файлов
1481  6863 21 00 D0     			ld hl,cat_mark_r
1482  6866 06 80        			ld b,128 ;размер таблицы
1483  6868 DD 2E 00     			ld xl,0 ;счётчик
1484  686B              copyF_RL_no_one_chk
1485  686B 7E           			ld a,(hl)
1486  686C B7           			or a
1487  686D 28 02        			jr z,copyF_RL_no_one_chk1
1488  686F DD 2C        			inc xl
1489  6871              copyF_RL_no_one_chk1
1490  6871 23           			inc hl
1491  6872 10 F7        			djnz copyF_RL_no_one_chk
1492  6874 DD 2C        			inc xl
1493  6876 DD 2D        			dec xl
1494  6878 20 07        			jr nz,copyF_RL_no_one2 ;не ноль
1495  687A              			;не отмечено
1496  687A 3A 25 73     			ld a,(curfile) ;текущ файл
1497  687D B7           			or a ;если стоит на ".."
1498  687E CA 47 60     			jp z,wait
1499  6881              copyF_RL_no_one2
1500  6881              			;окно запроса с выбором диска
1501  6881 3A 1D 73     			ld a,(cur_drive)
1502  6884 C6 41        			add a,"A"
1503  6886 32 88 74     			ld (mes_trd_dsk+3),a
1504  6889 21 A5 75     			ld hl,mes_copy_file
1505  688C CD 09 77     			call print
1506  688F 21 85 74     			ld hl,mes_trd_dsk
1507  6892 CD 09 77     			call print
1508  6895 3E 27        			ld a,col_win
1509  6897 CD 2C 6E     			call paint_win
1510  689A
1511  689A              copyF_RL_w ;ожидание согласия
1512  689A 76           			halt
1513  689B 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
1514  689E FE 4E        			cp 		"N"
1515  68A0 CA 61 6A     			jp z,copyF_exit ;выход если нет согласия
1516  68A3 FE 59        			cp 		"Y"
1517  68A5 20 F3        			jr nz,copyF_RL_w
1518  68A7
1519  68A7 DD 2C        			inc xl
1520  68A9 DD 2D        			dec xl
1521  68AB 20 11        			jr nz,copyF_RL_no_one ;не один
1522  68AD 3A 25 73     			ld a,(curfile) ;тогда только текущий файл
1523  68B0 CD 00 69     			call copyF_RL_one
1524  68B3 D2 61 6A     			jp nc,copyF_exit ;выход без ошибки
1525  68B6 FE FF        			cp 255
1526  68B8 CA 61 6A     			jp z,copyF_exit ;выход после останова
1527  68BB C3 81 6A     			jp copyF_error ;выход с ошибкой
1528  68BE
1529  68BE
1530  68BE              copyF_RL_no_one ;копировать несколько
1531  68BE 21 00 D0     			ld hl,cat_mark_r
1532  68C1 DD 7D        			ld a,xl
1533  68C3 32 53 73     			ld (cat_mark_cur_tot),a
1534  68C6 AF           			xor a
1535  68C7              copyF_RL_no_one_cl
1536  68C7 32 52 73     			ld (cat_mark_cur_cl),a
1537  68CA 22 50 73     			ld (cat_mark_cur),hl
1538  68CD 7E           			ld a,(hl) ;есть отметка?
1539  68CE B7           			or a
1540  68CF 28 1E        			jr z,copyF_RL_no_one_cl1
1541  68D1 3A 53 73     			ld a,(cat_mark_cur_tot)
1542  68D4 6F           			ld l,a
1543  68D5 26 00        			ld h,0
1544  68D7 3D           			dec a
1545  68D8 32 53 73     			ld (cat_mark_cur_tot),a
1546  68DB CD D3 71     			call print_progress_tot ;прогресс
1547  68DE 3A 52 73     			ld a,(cat_mark_cur_cl) ;очередной номер файла
1548  68E1 CD 00 69     			call copyF_RL_one ;скопировать
1549  68E4 D2 EF 68     			jp nc,copyF_RL_no_one_cl1 ;продолжить без ошибки
1550  68E7 FE FF        			cp 255
1551  68E9 CA 61 6A     			jp z,copyF_exit ;выход после останова
1552  68EC C3 81 6A     			jp copyF_error ;выход с ошибкой
1553  68EF              copyF_RL_no_one_cl1
1554  68EF 2A 50 73     			ld hl,(cat_mark_cur)
1555  68F2 36 00        			ld (hl),0 ;снять отметку
1556  68F4 23           			inc hl
1557  68F5 3A 52 73     			ld a,(cat_mark_cur_cl)
1558  68F8 3C           			inc a
1559  68F9 FE 80        			cp 128
1560  68FB 38 CA        			jr c,copyF_RL_no_one_cl
1561  68FD
1562  68FD C3 61 6A     			jp copyF_exit
1563  6900
1564  6900
1565  6900              copyF_RL_one ;по одному файлу справа налево
1566  6900              			;на входе в A - номер файла
1567  6900              			;на выходе C=1, если ошибка; A=255, если остановлено
1568  6900 08           			ex af,af'
1569  6901              			;узнать есть ли место на диске
1570  6901 3A 64 D9     			ld a,(cat_l+8*256+#e4) ; общее количество файлов
1571  6904 FE 80        			cp 128
1572  6906 D2 99 6A     			jp nc,copyF_RL_one_error ;если уже максимум
1573  6909 08           			ex af,af'
1574  690A              			;узнать параметры файла
1575  690A              			; ld de,0
1576  690A              			; ld      (#5ceb),de ;начало сектор дорожка
1577  690A 01 70 C6     			ld bc,cat_open_trd
1578  690D              			;ld a,(curfile) ;текущ файл
1579  690D 6F           			ld l,a
1580  690E 26 00        			ld h,0
1581  6910 29                       add    hl,hl ;2
1582  6911 29           			add    hl,hl ;4
1583  6912 29           			add    hl,hl ;8
1584  6913 29           			add    hl,hl ;16
1585  6914 09           			add hl,bc
1586  6915
1587  6915 22 45 73     			ld (copyF_RL_source_file),hl ;указатель на запись о файле
1588  6918 01 0D 00     			ld bc,13
1589  691B 09           			add hl,bc
1590  691C 7E           			ld a,(hl) ;объём файла в секторах
1591  691D 32 47 73     			ld (copyF_RL_source_sec_size),a ;
1592  6920 4F           			ld c,a
1593  6921 06 00        			ld b,0
1594  6923 23           			inc hl
1595  6924 5E           			ld e,(hl)
1596  6925 23           			inc hl
1597  6926 56           			ld d,(hl)
1598  6927 ED 53 49 73  			ld (copyF_RL_source_trk),de ;исходные дорожка-сектор
1599  692B
1600  692B 2A 65 D9     			ld hl,(cat_l+8*256+#e5) ; количество свободных секторов на диске
1601  692E A7           			and a
1602  692F ED 42        			sbc hl,bc
1603  6931 DA 99 6A     			jp c,copyF_RL_one_error ;если не хватает места
1604  6934
1605  6934              			;цикл по размеру в секторах
1606  6934 DD 6F        			ld xl,a
1607  6936
1608  6936 ED 5B 61 D9  			ld de,(cat_l+8*256+#e1) ;первые свободные сектор-дорожка назначения
1609  693A ED 53 EB 5C  			ld (#5ceb),de
1610  693E              			;узнаем где находится искодный файл
1611  693E 2A 49 73     			ld hl,(copyF_RL_source_trk) ;пересчитать дорожки-секторы в пакеты
1612  6941 4D           			ld c,l ;секторы
1613  6942 06 00        			ld b,0
1614  6944 6C           			ld l,h ;дорожки
1615  6945 26 00        			ld h,0
1616  6947 29           			add hl,hl ;*2
1617  6948 29           			add hl,hl ;*4
1618  6949 29           			add hl,hl ;*8
1619  694A 29           			add hl,hl ;*16
1620  694B 09           			add hl,bc ;добавить секторы
1621  694C              			;ld hl,0 ;счётчик частей
1622  694C 22 3C B4     			ld (trn_buf+4),hl
1623  694F
1624  694F              			;начинаем копировать файл
1625  694F
1626  694F 3A 3C 73     			ld a,(curfile_r2) ;текущ файл образа
1627  6952 01 70 BE     			ld bc,cat_r2
1628  6955 6F           			ld l,a
1629  6956 26 00        			ld h,0
1630  6958 29                       add    hl,hl ;2
1631  6959 29           			add    hl,hl ;4
1632  695A 29           			add    hl,hl ;8
1633  695B 29           			add    hl,hl ;16
1634  695C 09           			add hl,bc
1635  695D
1636  695D 11 48 B4     			ld de,trn_buf+16 ;перекинем имя файла в запрос
1637  6960 01 0C 00     			ld bc,file_name_len
1638  6963 ED B0        			ldir
1639  6965 3E 06        			ld a,6 ;Тип пакета Запрос приёма файла 256 байт
1640  6967 32 3B B4     			ld (trn_buf+3),a
1641  696A
1642  696A AF           			xor a
1643  696B 32 44 B4     			ld (trn_buf+12),a ;размер файла 655360
1644  696E 32 45 B4     			ld (trn_buf+13),a
1645  6971 32 47 B4     			ld (trn_buf+15),a
1646  6974 3E 0A        			ld a,#a
1647  6976 32 46 B4     			ld (trn_buf+14),a
1648  6979
1649  6979              			;цикл
1650  6979
1651  6979              copyF_RL3
1652  6979 CD BE 78     	call check_init_r ;авто проверка инициализации
1653  697C
1654  697C DD 7D        			ld a,xl
1655  697E 6F           			ld l,a
1656  697F 26 00        			ld h,0
1657  6981 CD BE 71     			call print_progress
1658  6984
1659  6984 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
1660  6987 FE 20        			cp " "
1661  6989 20 0D        			jr nz,copyF_RL2 ;продолжим
1662  698B 21 CB 74     			ld hl,mes_stopped ;прервём
1663  698E CD E9 76     			call print_sys
1664  6991 CD B0 6E     			call wait_releas
1665  6994 3E FF        			ld a,255
1666  6996 3F           			ccf ;C=1
1667  6997 C9           			ret
1668  6998
1669  6998              copyF_RL2
1670  6998              			;call open_tcp
1671  6998              			;jr c,copyF_RL3 ;если ошибка, то новая попытка
1672  6998
1673  6998 21 38 B4     			ld hl,trn_buf ;откуда
1674  699B 11 22 00     			ld de,pack_size_32 ;размер
1675  699E CD B4 7B     			call Wifi.tcpSend ;отправить
1676  69A1 38 D6        			jr c,copyF_RL3 ;если ошибка, то новая попытка
1677  69A3
1678  69A3 21 8A 73     			ld hl,mes_req_part_file ;сообщение пока ждём ответ
1679  69A6 CD E9 76     			call print_sys
1680  69A9
1681  69A9 21 80 F6     			ld hl,rec_buf ;куда
1682  69AC 22 5F 79     			ld (Wifi.buffer_pointer),hl
1683  69AF CD 27 7B     			call Wifi.getPacket ;приём
1684  69B2 30 02        			jr nc,copyF_RL_check_pass1
1685  69B4              			;call init_dev
1686  69B4 18 C3        			jr copyF_RL3 ;если ошибка, то новая попытка
1687  69B6
1688  69B6              copyF_RL_check_pass1	;принят пакет
1689  69B6 21 C2 73     			ld hl,mes_rec_part_file ;сообщение
1690  69B9 CD E9 76     			call print_sys
1691  69BC 21 80 F6     			ld hl,rec_buf
1692  69BF 01 20 01     	ld bc,pack_size_256_com+pack_size_32_com
1693  69C2 ED 43 4E 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
1694  69C6 0E 07        			ld c,7 ; Тип пакета Файл 256
1695  69C8 CD 51 6E     			call check_pack
1696  69CB 30 03        			jr nc,copyF_RL_check_pass
1697  69CD              			;call init_dev
1698  69CD C3 79 69     			jp copyF_RL3 ;если ошибка, то новая попытка
1699  69D0
1700  69D0              copyF_RL_check_pass	;проверка прошла
1701  69D0
1702  69D0 21 A0 F6     	ld hl,rec_buf+32 ;адрес принятого пакета
1703  69D3 ED 5B EB 5C  	ld de,(#5ceb)
1704  69D7 01 06 01     	ld bc,#0106
1705  69DA CD 13 3D     	call #3d13 ;запишем 1 сектор
1706  69DD
1707  69DD ED 5B EB 5C  	ld de,(#5ceb)
1708  69E1 06 01        	ld b,1
1709  69E3 CD BF 6E     	call calc_next_pos2 ;сменить позицию на 1 сектор
1710  69E6
1711  69E6 2A 3C B4     			ld hl,(trn_buf+4) ;следующая честь файла
1712  69E9 23           			inc hl
1713  69EA 22 3C B4     			ld (trn_buf+4),hl
1714  69ED
1715  69ED DD 2D        			dec xl
1716  69EF C2 79 69     			jp nz,copyF_RL3
1717  69F2
1718  69F2              			;теперь поправить каталог
1719  69F2
1720  69F2              			;запись о файле
1721  69F2 3A 64 D9     			ld a,(cat_l+8*256+#e4) ; общее количество файлов
1722  69F5 6F           			ld l,a ;узнать в каком секторе будет запись о файле
1723  69F6 26 00        			ld h,0
1724  69F8 29           			add hl,hl ;*2
1725  69F9 29           			add hl,hl ;*4
1726  69FA 29           			add hl,hl ;*8
1727  69FB 29           			add hl,hl ;*16
1728  69FC 7C           			ld a,h ;запомнить номер сетора в каталоге
1729  69FD 32 4B 73     			ld (copyF_RL_dest_sec_cat),a
1730  6A00 01 80 D0     			ld bc,cat_l
1731  6A03 09           			add hl,bc ;здесь будет запись о новом файле
1732  6A04 EB           			ex de,hl
1733  6A05
1734  6A05 2A 45 73     			ld hl,(copyF_RL_source_file) ;запись о файле
1735  6A08 01 10 00     			ld bc,16
1736  6A0B ED B0        			ldir ;скопировать
1737  6A0D EB           			ex de,hl
1738  6A0E 2B           			dec hl
1739  6A0F ED 5B 61 D9  			ld de,(cat_l+8*256+#e1) ;первые свободные сектор-дорожка назначения
1740  6A13 72           			ld (hl),d ;дорожка
1741  6A14 2B           			dec hl
1742  6A15 73           			ld (hl),e ;сектор
1743  6A16
1744  6A16 2E 00        			ld l,0 ;записать сектор целиком по ровному адресу
1745  6A18 16 00        			ld d,0
1746  6A1A 3A 4B 73     			ld a,(copyF_RL_dest_sec_cat)
1747  6A1D 5F           			ld e,a ;номер сектора
1748  6A1E 01 06 01     			ld bc,#0106 ;1 сектор записать
1749  6A21 CD 13 3D     			call #3d13
1750  6A24
1751  6A24              			;служебный сектор
1752  6A24 ED 5B 61 D9  			ld de,(cat_l+8*256+#e1) ;первые свободные сектор-дорожка назначения
1753  6A28 3A 47 73     			ld a,(copyF_RL_source_sec_size) ;размер файла
1754  6A2B 47           			ld b,a
1755  6A2C CD BF 6E     			call calc_next_pos2
1756  6A2F ED 53 61 D9  			ld (cat_l+8*256+#e1),de
1757  6A33
1758  6A33 2A 65 D9     			ld hl,(cat_l+8*256+#e5) ; количество свободных секторов на диске
1759  6A36 3A 47 73     			ld a,(copyF_RL_source_sec_size) ;размер файла
1760  6A39 4F           			ld c,a
1761  6A3A 06 00        			ld b,0
1762  6A3C A7           			and a
1763  6A3D ED 42        			sbc hl,bc
1764  6A3F 22 65 D9     			ld (cat_l+8*256+#e5),hl
1765  6A42
1766  6A42 21 64 D9     			ld hl,cat_l+8*256+#e4 ; общее количество файлов
1767  6A45 34           			inc (hl)
1768  6A46
1769  6A46 21 80 D8     			ld hl,cat_l+8*256
1770  6A49 11 08 00     			ld de,#0008
1771  6A4C 01 06 01     			ld bc,#0106 ;1 сектор записать
1772  6A4F CD 13 3D     			call #3d13
1773  6A52
1774  6A52 3A 28 73     			ld     a,(files_l) ;обновить количество файлов
1775  6A55 3C           			inc a
1776  6A56 32 28 73     			ld     (files_l),a
1777  6A59
1778  6A59 CD 89 6F     			call printcat_l
1779  6A5C CD E4 6E     			call printcat_r
1780  6A5F AF           			xor a ;C=0
1781  6A60 C9           			ret
1782  6A61
1783  6A61
1784  6A61              copyF_exit	;общий выход из копирования файлов
1785  6A61 3E 07        			ld a,col_fon ;стереть окно
1786  6A63 CD 2C 6E     			call paint_win
1787  6A66              			;call cls_l ;очистить левую панель
1788  6A66 21 FE 73     			ld hl,mes_win_cls ;стереть текст
1789  6A69 CD 09 77     			call print
1790  6A6C
1791  6A6C 21 EA 75     			ld hl,mes_progress_off ;стереть прогресс
1792  6A6F CD 09 77     			call print
1793  6A72 21 FC 75     			ld hl,mes_progress_tot_off ;стереть общий прогресс
1794  6A75 CD 09 77     			call print
1795  6A78 CD 89 6F     			call printcat_l
1796  6A7B CD E4 6E     			call printcat_r
1797  6A7E C3 47 60     			jp wait
1798  6A81
1799  6A81
1800  6A81              copyF_error ;общий выход из копирования файлов с ошибкой
1801  6A81 3E 17        			ld a,col_win2
1802  6A83 CD 2C 6E     			call paint_win ;окно ошибки
1803  6A86 21 B8 75     			ld hl,mes_copy_error
1804  6A89 CD 09 77     			call print
1805  6A8C CD B0 6E     			call wait_releas ;ждать клавишу
1806  6A8F              copyF_error1
1807  6A8F 76           			halt
1808  6A90 3A 04 5C     			ld 	a,(23556) ;сист. переменная нажатая клавиша
1809  6A93 FE FF        			cp #ff
1810  6A95 28 F8        			jr z,copyF_error1
1811  6A97 18 C8        			jr copyF_exit
1812  6A99
1813  6A99
1814  6A99              copyF_RL_one_error
1815  6A99 AF           			xor a
1816  6A9A 3F           			ccf ;C=1
1817  6A9B C9           			ret
1818  6A9C
1819  6A9C
1820  6A9C              exit_h ;выход после операции с ожиданием клавиши
1821  6A9C 76           			halt
1822  6A9D 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
1823  6AA0 FE FF        			cp #ff
1824  6AA2 28 F8        			jr z,exit_h
1825  6AA4 C3 1C 60     			jp start_h ;на горячий старт
1826  6AA7
1827  6AA7
1828  6AA7
1829  6AA7
1830  6AA7
1831  6AA7
1832  6AA7
1833  6AA7
1834  6AA7
1835  6AA7
1836  6AA7              TRD ;выбор записи или считывания
1837  6AA7 3A 1D 73     	ld a,(cur_drive)
1838  6AAA FE 04        	cp 4
1839  6AAC D2 47 60     	jp     nc,wait ;когда слева FAT, не работает копирование TRD
1840  6AAF
1841  6AAF 3A 39 73     	ld a,(open_trd_flag)
1842  6AB2 B7           	or a
1843  6AB3 C2 47 60     	jp     nz,wait ;когда открыт образ справа, нельзя копировать целиком образ
1844  6AB6
1845  6AB6 3A 2A 73     			ld a,(panel)
1846  6AB9 FE 52        			cp "R"
1847  6ABB CA 1A 6D     			jp z,write_trd_
1848  6ABE
1849  6ABE
1850  6ABE              read_trd_ ;прочитать TRD с диска на сервер
1851  6ABE 3A 24 73                 ld     a,(files)
1852  6AC1 B7                       or     a      ;no files?
1853  6AC2 CA 47 60                 jp     z,wait
1854  6AC5
1855  6AC5              			;запросить имя образа
1856  6AC5 21 75 D9     			ld hl,cat_l+8*256+#f5 ;имя диска тут
1857  6AC8 11 41 74     			ld de,trd_name
1858  6ACB 01 08 00     			ld bc,8
1859  6ACE ED B0        			ldir ;подставить имя диска
1860  6AD0
1861  6AD0 CD F8 6B     			call input_name
1862  6AD3
1863  6AD3              			;call wait_releas
1864  6AD3
1865  6AD3              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
1866  6AD3
1867  6AD3 3A 1D 73     			ld a,(cur_drive) ;подготовка сообщения для подтверждения
1868  6AD6 C6 41        			add a,"A"
1869  6AD8 32 88 74     			ld (mes_trd_dsk+3),a
1870  6ADB 21 5F 74     			ld hl,mes_read_trd
1871  6ADE CD 09 77     			call print
1872  6AE1 21 85 74     			ld hl,mes_trd_dsk
1873  6AE4 CD 09 77     			call print
1874  6AE7              			;call paint_win
1875  6AE7
1876  6AE7 CD 9C 6C     			call trd_w ;
1877  6AEA FE 59        			cp "Y"
1878  6AEC C2 1C 60     			jp nz,start_h ;выход если нет согласия
1879  6AEF
1880  6AEF
1881  6AEF              read_trd	;чтение образа TRD
1882  6AEF 3A 1D 73     			ld      a,(cur_drive) ;текущий диск
1883  6AF2 32 19 5D                 ld      (#5d19) ,a
1884  6AF5 0E 01                    ld      c,1
1885  6AF7 CD 13 3D                 call    #3d13
1886  6AFA 0E 18                    ld      c,#18
1887  6AFC CD 13 3D                 call    #3d13
1888  6AFF 11 00 00     			ld de,0
1889  6B02 ED 53 EB 5C  			ld      (#5ceb),de ;начало сектор дорожка
1890  6B06
1891  6B06 21 48 B4     			ld hl,trn_buf+16 ;очистим имя файла в пакете для отправки
1892  6B09 36 00        			ld (hl),0
1893  6B0B 11 49 B4     			ld de,trn_buf+16+1
1894  6B0E 01 0C 00     			ld bc,file_name_len
1895  6B11 ED B0        			ldir
1896  6B13
1897  6B13
1898  6B13              			;обрежем лишние пробелы в конце имени, если есть
1899  6B13 01 07 00     			ld bc,7
1900  6B16 21 48 74     			ld hl,trd_name+7
1901  6B19              read_trd_chk_n
1902  6B19 7E           			ld a,(hl)
1903  6B1A FE 20        			cp " "
1904  6B1C 20 04        			jr nz,read_trd_chk_n2
1905  6B1E 2B           			dec hl
1906  6B1F 0D           			dec c
1907  6B20 20 F7        			jr nz,read_trd_chk_n
1908  6B22
1909  6B22              read_trd_chk_n2
1910  6B22 21 41 74     			ld hl,trd_name
1911  6B25 11 48 B4     			ld de,trn_buf+16 ;перекинем имя файла в запрос
1912  6B28              			;ld bc,file_name_len
1913  6B28 0C           			inc c
1914  6B29 ED B0        			ldir
1915  6B2B              			;добавить расширение
1916  6B2B EB           			ex de,hl
1917  6B2C 36 2E        			ld (hl),"."
1918  6B2E 23           			inc hl
1919  6B2F 36 74        			ld (hl),"t"
1920  6B31 23           			inc hl
1921  6B32 36 72        			ld (hl),"r"
1922  6B34 23           			inc hl
1923  6B35 36 64        			ld (hl),"d"
1924  6B37
1925  6B37 AF           			xor a
1926  6B38 32 44 B4     			ld (trn_buf+12),a ;размер файла 655360
1927  6B3B 32 45 B4     			ld (trn_buf+13),a
1928  6B3E 32 47 B4     			ld (trn_buf+15),a
1929  6B41 3E 0A        			ld a,#a
1930  6B43 32 46 B4     			ld (trn_buf+14),a
1931  6B46
1932  6B46
1933  6B46 3E 04        			ld a,4 ;Тип пакета Запрос передачи файла
1934  6B48 32 3B B4     			ld (trn_buf+3),a
1935  6B4B 21 00 00     			ld hl,0 ;счётчик частей
1936  6B4E 22 3C B4     			ld (trn_buf+4),hl
1937  6B51 DD 21 80 02  			ld ix,640 ;частей всего цикл
1938  6B55              read_trd3	;цикл
1939  6B55 2A 3C B4     			ld hl,(trn_buf+4) ;чтения части файла
1940  6B58 CD A2 70     			call toDecimal
1941  6B5B 21 FA 70     		    ld hl,decimalS+2 ;
1942  6B5E 11 E8 73     			ld de,mes_rd_part_file_num
1943  6B61 01 03 00     			ld bc,3
1944  6B64 ED B0        			ldir
1945  6B66 21 E3 73     			ld hl,mes_rd_part_file ;сообщение
1946  6B69 CD E9 76     			call print_sys
1947  6B6C
1948  6B6C DD E5        			push ix
1949  6B6E E1           			pop hl
1950  6B6F CD BE 71     			call print_progress
1951  6B72
1952  6B72 ED 5B EB 5C  			ld  de,(#5ceb) ;сектор дорожка
1953  6B76 21 58 B4     			ld hl,trn_buf+pack_size_32_com
1954  6B79 01 05 04     			ld bc,#0405 ;чтение 4 сектора
1955  6B7C CD 13 3D     			call #3d13
1956  6B7F              read_trd3_retr
1957  6B7F CD C3 78     	call check_init_t ;авто проверка инициализации
1958  6B82
1959  6B82 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
1960  6B85 FE 20        			cp " "
1961  6B87 20 0C        			jr nz,r_calc_next_pos3 ;продолжим
1962  6B89 21 CB 74     			ld hl,mes_stopped ;прервём
1963  6B8C CD E9 76     			call print_sys
1964  6B8F CD B0 6E     			call wait_releas
1965  6B92 C3 9C 6A     			jp exit_h
1966  6B95
1967  6B95              r_calc_next_pos3
1968  6B95 11 38 B4     			ld de,trn_buf
1969  6B98 01 20 04     			ld bc,pack_size_1024_com+pack_size_32_com
1970  6B9B ED 43 4E 73  			ld (check_sum_size),bc
1971  6B9F CD FD 70     			call calc_check_sum ;проверить сумму
1972  6BA2 22 58 B8     			ld (trn_buf+pack_size_1024_com+pack_size_32_com),hl ;записать её в пакет
1973  6BA5
1974  6BA5              			;call open_tcp
1975  6BA5              			;jr c,read_trd3_retr ;если ошибка, то новая попытка
1976  6BA5
1977  6BA5 21 38 B4     			ld hl,trn_buf ;откуда
1978  6BA8 11 22 04     			ld de,pack_size_1024 ;размер
1979  6BAB CD B4 7B     			call Wifi.tcpSend ;отправить
1980  6BAE 38 CF        			jr c,read_trd3_retr ;если ошибка, то новая попытка
1981  6BB0
1982  6BB0 21 9A 73     			ld hl,mes_trq_part_file ;сообщение пока ждём ответ
1983  6BB3 CD E9 76     			call print_sys
1984  6BB6
1985  6BB6 21 80 F6     			ld hl,rec_buf ;куда
1986  6BB9 22 5F 79     			ld (Wifi.buffer_pointer),hl
1987  6BBC CD 27 7B     			call Wifi.getPacket ;приём
1988  6BBF 30 02        			jr nc,r_check_pass1 ;
1989  6BC1              			;call init_dev ;сбросить приёмник
1990  6BC1 18 BC        			jr read_trd3_retr ;если ошибка, то новая попытка
1991  6BC3
1992  6BC3              r_check_pass1	;принято
1993  6BC3 21 CD 73     			ld hl,mes_trn_part_file ;сообщение
1994  6BC6 CD E9 76     			call print_sys
1995  6BC9              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
1996  6BC9              			; ld a,(check_sum_on) ;временно выключим контроль суммы
1997  6BC9              			; ld (check_sum_on_tmp),a
1998  6BC9              			; xor a
1999  6BC9              			; ld (check_sum_on),a
2000  6BC9 21 80 F6     			ld hl,rec_buf
2001  6BCC 01 20 00     	ld bc,pack_size_32_com
2002  6BCF ED 43 4E 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
2003  6BD3 0E 05        			ld c,5 ; Тип пакета Файл
2004  6BD5 CD 51 6E     			call check_pack
2005  6BD8              			; ld (check_sum_on_tmp),a ;вернём флаг
2006  6BD8              			; ld (check_sum_on),a
2007  6BD8 30 02        			jr nc,r_check_pass ;
2008  6BDA              			;call init_dev ;сбросить приёмник
2009  6BDA 18 A3        			jr read_trd3_retr ;если ошибка, то новая попытка
2010  6BDC
2011  6BDC              r_check_pass	;проверка прошла
2012  6BDC
2013  6BDC CD B9 6E     			call calc_next_pos
2014  6BDF
2015  6BDF 2A 3C B4     			ld hl,(trn_buf+4) ;следующая честь файла
2016  6BE2 23           			inc hl
2017  6BE3 22 3C B4     			ld (trn_buf+4),hl
2018  6BE6
2019  6BE6 DD 2B        			dec ix
2020  6BE8 DD 7D        			ld a,ixl
2021  6BEA DD B4        			or ixh
2022  6BEC C2 55 6B     			jp nz,read_trd3
2023  6BEF
2024  6BEF 21 B6 73     			ld hl,mes_trn_file ;сообщение что передали
2025  6BF2 CD E9 76     			call print_sys
2026  6BF5              			;call wait_releas
2027  6BF5 C3 1C 60     			jp start_h
2028  6BF8
2029  6BF8
2030  6BF8              input_name ;ввод имени файла
2031  6BF8 DD 21 41 74  			ld ix,trd_name
2032  6BFC              			;ld de,trd_name ;указатель на имя файла
2033  6BFC              input_name_
2034  6BFC              			;очистим место под курсор
2035  6BFC 21 4E 74     			ld hl,mes_trd_name_curs+3
2036  6BFF 36 20        			ld (hl)," "
2037  6C01 11 4F 74     			ld de,mes_trd_name_curs+3+1
2038  6C04 01 0F 00     			ld bc,16-1
2039  6C07 ED B0        			ldir
2040  6C09              			;нарисуем курсор
2041  6C09 21 13 00     			ld hl,14+11-6  ;поле метка курсора
2042  6C0C DD E5        			push ix
2043  6C0E D1           			pop de
2044  6C0F 19           			add hl,de
2045  6C10 36 5E        			ld (hl),"^"
2046  6C12 21 38 74     			ld hl,mes_trd_name ;напечатать имя
2047  6C15 CD 09 77     			call print
2048  6C18 3E 27        			ld a,col_win
2049  6C1A CD 2C 6E     			call paint_win
2050  6C1D
2051  6C1D CD C4 60     			call input_key ;запросить клавишу
2052  6C20 79           			ld a,c
2053  6C21 FE 0D        			cp  #0d ;Enter
2054  6C23 C8           			ret z
2055  6C24
2056  6C24 FE 05                    cp 		5
2057  6C26 CA 67 6C                 jp      z,input_name_left
2058  6C29 FE 08                    cp 		8
2059  6C2B CA 7E 6C                 jp      z,input_name_right
2060  6C2E FE 07                    cp 		7
2061  6C30 CA 59 6C                 jp      z,input_name_up
2062  6C33 FE 06                    cp 		6
2063  6C35 CA 60 6C                 jp      z,input_name_down
2064  6C38 FE 00                    cp 		0
2065  6C3A CA 96 6C                 jp      z,input_name_BS ;стереть, backspace
2066  6C3D              ;input_name_sym
2067  6C3D              			;ld a,c
2068  6C3D FE 20        			cp 		" "
2069  6C3F 38 BB        			jr      c,input_name_ ;если недопустимы символ, в начало
2070  6C41 FE 7B        			cp 		"{"
2071  6C43 30 B7        			jr      nc,input_name_ ;если недопустимы символ, в начало
2072  6C45 DD 77 00     			ld      (ix),a ; записать букву в имя
2073  6C48 DD 23        			inc ix
2074  6C4A DD E5        			push ix
2075  6C4C D1           			pop de
2076  6C4D 21 48 74     			ld hl,trd_name+ 7;проверка на пределы имени
2077  6C50 A7           			and a
2078  6C51 ED 52        			sbc hl,de
2079  6C53 30 A7        			jr nc,input_name_ ; в начало
2080  6C55 DD 2B        			dec ix ;иначе отмена
2081  6C57 18 A3        			jr input_name_ ; в начало
2082  6C59
2083  6C59              input_name_up
2084  6C59 3E FF        			ld a,255
2085  6C5B 32 04 5C     			ld 	(23556),a
2086  6C5E 18 9C        			jr input_name_
2087  6C60              input_name_down
2088  6C60 3E FF        			ld a,255
2089  6C62 32 04 5C     			ld 	(23556),a
2090  6C65 18 95        			jr input_name_
2091  6C67
2092  6C67              input_name_left
2093  6C67 3E FF        			ld a,255
2094  6C69 32 04 5C     			ld 	(23556),a
2095  6C6C DD 2B        			dec ix
2096  6C6E DD E5        			push ix
2097  6C70 D1           			pop de
2098  6C71 21 40 74     			ld hl,trd_name-1 ;проверка на пределы имени
2099  6C74 A7           			and a
2100  6C75 ED 52        			sbc hl,de
2101  6C77 38 83        			jr c,input_name_ ; в начало
2102  6C79 DD 23        			inc ix ;иначе отмена
2103  6C7B C3 FC 6B     			jp input_name_
2104  6C7E              input_name_right
2105  6C7E 3E FF        			ld a,255
2106  6C80 32 04 5C     			ld 	(23556),a
2107  6C83 DD 23        			inc ix
2108  6C85 DD E5        			push ix
2109  6C87 D1           			pop de
2110  6C88 21 48 74     			ld hl,trd_name+ 7;проверка на пределы имени
2111  6C8B A7           			and a
2112  6C8C ED 52        			sbc hl,de
2113  6C8E D2 FC 6B     			jp nc,input_name_ ; в начало
2114  6C91 DD 2B        			dec ix ;иначе отмена
2115  6C93 C3 FC 6B     			jp input_name_ ; в начало
2116  6C96              input_name_BS
2117  6C96 DD 36 00 20  			ld (ix)," "
2118  6C9A 18 CB        			jr input_name_left
2119  6C9C
2120  6C9C              trd_w ;ожидание согласия и выбор диска
2121  6C9C 76           			halt
2122  6C9D 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
2123  6CA0 FE 31        			cp 		"1"
2124  6CA2 CA CE 6C                 jp      z,trd_w_driveA ;1
2125  6CA5 FE 41                    cp 		"A"
2126  6CA7 CA CE 6C                 jp      z,trd_w_driveA ;A
2127  6CAA FE 32                    cp 		"2"
2128  6CAC CA E1 6C                 jp      z,trd_w_driveB ;2
2129  6CAF FE 42                    cp 		"B"
2130  6CB1 CA E1 6C                 jp      z,trd_w_driveB ;B
2131  6CB4 FE 33                    cp 		"3"
2132  6CB6 CA F4 6C                 jp      z,trd_w_driveC ;3
2133  6CB9 FE 43                    cp 		"C"
2134  6CBB CA F4 6C                 jp      z,trd_w_driveC ;C
2135  6CBE FE 34                    cp 		"4"
2136  6CC0 28 45                    jr      z,trd_w_driveD ;4
2137  6CC2 FE 44                    cp 		"D"
2138  6CC4 28 41                    jr      z,trd_w_driveD ;D
2139  6CC6 FE 4E        			cp 		"N"
2140  6CC8 C8                       ret z
2141  6CC9 FE 59        			cp 		"Y"
2142  6CCB C8                       ret z ;
2143  6CCC 18 CE        			jr trd_w
2144  6CCE
2145  6CCE              trd_w_driveA
2146  6CCE 3E 00        			ld a,0
2147  6CD0 32 1D 73     			ld (cur_drive),a
2148  6CD3 C6 41        			add a,"A"
2149  6CD5 32 88 74     			ld (mes_trd_dsk+3),a
2150  6CD8 21 85 74     			ld hl,mes_trd_dsk
2151  6CDB CD 09 77     			call print
2152  6CDE C3 9C 6C     			jp trd_w
2153  6CE1              trd_w_driveB
2154  6CE1 3E 01        			ld a,1
2155  6CE3 32 1D 73     			ld (cur_drive),a
2156  6CE6 C6 41        			add a,"A"
2157  6CE8 32 88 74     			ld (mes_trd_dsk+3),a
2158  6CEB 21 85 74     			ld hl,mes_trd_dsk
2159  6CEE CD 09 77     			call print
2160  6CF1 C3 9C 6C     			jp trd_w
2161  6CF4              trd_w_driveC
2162  6CF4 3E 02        			ld a,2
2163  6CF6 32 1D 73     			ld (cur_drive),a
2164  6CF9 C6 41        			add a,"A"
2165  6CFB 32 88 74     			ld (mes_trd_dsk+3),a
2166  6CFE 21 85 74     			ld hl,mes_trd_dsk
2167  6D01 CD 09 77     			call print
2168  6D04 C3 9C 6C     			jp trd_w
2169  6D07              trd_w_driveD
2170  6D07 3E 03        			ld a,3
2171  6D09 32 1D 73     			ld (cur_drive),a
2172  6D0C C6 41        			add a,"A"
2173  6D0E 32 88 74     			ld (mes_trd_dsk+3),a
2174  6D11 21 85 74     			ld hl,mes_trd_dsk
2175  6D14 CD 09 77     			call print
2176  6D17 C3 9C 6C     			jp trd_w
2177  6D1A
2178  6D1A
2179  6D1A
2180  6D1A
2181  6D1A              write_trd_ ;записать TRD с сервера на диск
2182  6D1A 3A 24 73                 ld     a,(files)
2183  6D1D B7                       or     a      ;no files?
2184  6D1E CA 47 60                 jp     z,wait
2185  6D21                          ; ld     a,(open_trd_flag)
2186  6D21                          ; or     a      ;нельзя скопировать, если открыт образ
2187  6D21                          ; jp     nz,wait
2188  6D21
2189  6D21 3A 1D 73     			ld a,(cur_drive)
2190  6D24 C6 41        			add a,"A"
2191  6D26 32 88 74     			ld (mes_trd_dsk+3),a
2192  6D29 21 72 74     			ld hl,mes_write_trd
2193  6D2C CD 09 77     			call print
2194  6D2F 21 85 74     			ld hl,mes_trd_dsk
2195  6D32 CD 09 77     			call print
2196  6D35 3E 27        			ld a,col_win
2197  6D37 CD 2C 6E     			call paint_win
2198  6D3A
2199  6D3A CD 9C 6C     			call trd_w
2200  6D3D FE 59        			cp "Y"
2201  6D3F C2 1C 60     			jp nz,start_h ;выход если нет согласия
2202  6D42
2203  6D42              write_trd	;запись образа TRD на диск
2204  6D42 3A 1D 73     			ld      a,(cur_drive) ;текущий диск
2205  6D45 32 19 5D                 ld      (#5d19) ,a
2206  6D48 0E 01                    ld      c,1
2207  6D4A CD 13 3D                 call    #3d13
2208  6D4D 0E 18                    ld      c,#18
2209  6D4F CD 13 3D                 call    #3d13
2210  6D52 11 00 00     			ld de,0
2211  6D55 ED 53 EB 5C  			ld      (#5ceb),de ;начало сектор дорожка
2212  6D59 01 80 EE     			ld bc,cat_r
2213  6D5C 3A 39 73     			ld     a,(open_trd_flag)
2214  6D5F B7                       or     a      ;если открыт образ
2215  6D60 3A 25 73     			ld a,(curfile) ;текущ файл если образ не открыт
2216  6D63 28 06                    jr     z,write_trd2
2217  6D65 01 70 BE     			ld bc,cat_r2
2218  6D68 3A 3C 73     			ld a,(curfile_r2) ;текущ файл если образ открыт
2219  6D6B              write_trd2
2220  6D6B 6F           			ld l,a
2221  6D6C 26 00        			ld h,0
2222  6D6E 29                       add    hl,hl ;2
2223  6D6F 29           			add    hl,hl ;4
2224  6D70 29           			add    hl,hl ;8
2225  6D71 29           			add    hl,hl ;16
2226  6D72 09           			add hl,bc
2227  6D73              			; dec a
2228  6D73              			; jr nz,write_trd2
2229  6D73              ;write_trd1
2230  6D73 11 48 B4     			ld de,trn_buf+16 ;перекинем имя файла в запрос
2231  6D76 01 0C 00     			ld bc,file_name_len
2232  6D79 ED B0        			ldir
2233  6D7B
2234  6D7B AF           			xor a
2235  6D7C 32 44 B4     			ld (trn_buf+12),a ;размер файла 655360
2236  6D7F 32 45 B4     			ld (trn_buf+13),a
2237  6D82 32 47 B4     			ld (trn_buf+15),a
2238  6D85 3E 0A        			ld a,#a
2239  6D87 32 46 B4     			ld (trn_buf+14),a
2240  6D8A
2241  6D8A 3E 02        			ld a,2 ;Тип пакета Запрос приёма файла
2242  6D8C 32 3B B4     			ld (trn_buf+3),a
2243  6D8F 21 00 00     			ld hl,0 ;счётчик частей
2244  6D92 22 3C B4     			ld (trn_buf+4),hl
2245  6D95 DD 21 80 02  			ld ix,640 ;частей всего
2246  6D99              write_trd3 ;цикл
2247  6D99 CD BE 78     	call check_init_r ;авто проверка инициализации
2248  6D9C
2249  6D9C DD E5        			push ix
2250  6D9E E1           			pop hl
2251  6D9F CD BE 71     			call print_progress
2252  6DA2
2253  6DA2 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
2254  6DA5 FE 20        			cp " "
2255  6DA7 20 0C        			jr nz,calc_next_pos3 ;продолжим
2256  6DA9 21 CB 74     			ld hl,mes_stopped ;прервём
2257  6DAC CD E9 76     			call print_sys
2258  6DAF CD B0 6E     			call wait_releas
2259  6DB2 C3 9C 6A     			jp exit_h
2260  6DB5
2261  6DB5              calc_next_pos3
2262  6DB5              			;call open_tcp
2263  6DB5              			;jr c,write_trd3 ;если ошибка, то новая попытка
2264  6DB5
2265  6DB5 21 38 B4     			ld hl,trn_buf ;откуда
2266  6DB8 11 22 00     			ld de,pack_size_32 ;размер
2267  6DBB CD B4 7B     			call Wifi.tcpSend ;отправить
2268  6DBE 38 D9        			jr c,write_trd3 ;если ошибка, то новая попытка
2269  6DC0
2270  6DC0 21 8A 73     			ld hl,mes_req_part_file ;сообщение пока ждём ответ
2271  6DC3 CD E9 76     			call print_sys
2272  6DC6
2273  6DC6 21 80 F6     			ld hl,rec_buf ;куда
2274  6DC9 22 5F 79     			ld (Wifi.buffer_pointer),hl
2275  6DCC CD 27 7B     			call Wifi.getPacket ;приём
2276  6DCF 30 02        			jr nc,check_pass1
2277  6DD1              			;call init_dev
2278  6DD1 18 C6        			jr write_trd3 ;если ошибка, то новая попытка
2279  6DD3
2280  6DD3              check_pass1	;принят пакет
2281  6DD3 21 C2 73     			ld hl,mes_rec_part_file ;сообщение
2282  6DD6 CD E9 76     			call print_sys
2283  6DD9              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
2284  6DD9 21 80 F6     			ld hl,rec_buf
2285  6DDC 01 20 04     	ld bc,pack_size_1024_com+pack_size_32_com
2286  6DDF ED 43 4E 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
2287  6DE3 0E 03        			ld c,3 ; Тип пакета Файл
2288  6DE5 CD 51 6E     			call check_pack
2289  6DE8 30 02        			jr nc,check_pass
2290  6DEA              			;call init_dev
2291  6DEA 18 AD        			jr write_trd3 ;если ошибка, то новая попытка
2292  6DEC
2293  6DEC              check_pass	;проверка прошла
2294  6DEC 2A 3C B4     			ld hl,(trn_buf+4)
2295  6DEF CD A2 70     			call toDecimal
2296  6DF2 21 FA 70     		    ld hl,decimalS+2 ;
2297  6DF5 11 DF 73     			ld de,mes_wrt_part_file_num
2298  6DF8 01 03 00     			ld bc,3
2299  6DFB ED B0        			ldir
2300  6DFD 21 D9 73     			ld hl,mes_wrt_part_file ;сообщение
2301  6E00 CD E9 76     			call print_sys
2302  6E03
2303  6E03 ED 5B EB 5C  			ld  de,(#5ceb) ;сектор дорожка
2304  6E07 21 A0 F6     			ld hl,rec_buf+32
2305  6E0A 01 06 04     			ld bc,#0406 ;запись 4 сектора
2306  6E0D CD 13 3D     			call #3d13
2307  6E10
2308  6E10 CD B9 6E     			call calc_next_pos
2309  6E13
2310  6E13 2A 3C B4     			ld hl,(trn_buf+4)
2311  6E16 23           			inc hl
2312  6E17 22 3C B4     			ld (trn_buf+4),hl
2313  6E1A
2314  6E1A DD 2B        			dec ix
2315  6E1C DD 7D        			ld a,ixl
2316  6E1E DD B4        			or ixh
2317  6E20 C2 99 6D     			jp nz,write_trd3
2318  6E23
2319  6E23 21 AB 73     			ld hl,mes_rec_file ;сообщение что приняли
2320  6E26 CD E9 76     			call print_sys
2321  6E29              			;call wait_releas
2322  6E29 C3 1C 60     			jp start_h
2323  6E2C
2324  6E2C
2325  6E2C              paint_win
2326  6E2C              			;покрасим окно сообщения
2327  6E2C 21 CA 59     			ld hl,win_pos
2328  6E2F 77           			ld (hl),a
2329  6E30 54           			ld d,h
2330  6E31 5D           			ld e,l
2331  6E32 13           			inc de
2332  6E33 01 0B 00     			ld bc,win_size
2333  6E36 ED B0        			ldir
2334  6E38 21 EA 59     			ld hl,win_pos+32
2335  6E3B 77           			ld (hl),a
2336  6E3C 54           			ld d,h
2337  6E3D 5D           			ld e,l
2338  6E3E 13           			inc de
2339  6E3F 01 0B 00     			ld bc,win_size
2340  6E42 ED B0        			ldir
2341  6E44 21 0A 5A     			ld hl,win_pos+32+32
2342  6E47 77           			ld (hl),a
2343  6E48 54           			ld d,h
2344  6E49 5D           			ld e,l
2345  6E4A 13           			inc de
2346  6E4B 01 0B 00     			ld bc,win_size
2347  6E4E ED B0        			ldir
2348  6E50 C9           			ret
2349  6E51
2350  6E51              check_pack
2351  6E51              			;проверка пакета
2352  6E51              			;на входе в C - Тип пакета, в HL - адрес
2353  6E51 7E           			ld a,(hl)
2354  6E52 FE 5A        			cp "Z"
2355  6E54 C2 A0 6E     			jp nz,check_pac_error
2356  6E57 23           			inc hl
2357  6E58 7E           			ld a,(hl)
2358  6E59 FE 58        			cp "X"
2359  6E5B C2 A0 6E     			jp nz,check_pac_error
2360  6E5E 23           			inc hl
2361  6E5F 7E           			ld a,(hl)
2362  6E60 FE 4E        			cp "N"
2363  6E62 C2 A0 6E     			jp nz,check_pac_error
2364  6E65 23           			inc hl
2365  6E66 7E           			ld a,(hl)
2366  6E67 B9           			cp c ;Тип пакета
2367  6E68 C2 A0 6E     			jp nz,check_pac_error
2368  6E6B 23           			inc hl
2369  6E6C 7E           			ld a,(hl)
2370  6E6D EB           			ex de,hl
2371  6E6E 21 3C B4     			ld hl,trn_buf+4
2372  6E71 BE           			cp (hl) ;смещение
2373  6E72 EB           			ex de,hl
2374  6E73 C2 A0 6E     			jp nz,check_pac_error
2375  6E76 23           			inc hl
2376  6E77 7E           			ld a,(hl)
2377  6E78 EB           			ex de,hl
2378  6E79 21 3D B4     			ld hl,trn_buf+5
2379  6E7C BE           			cp (hl) ;смещение старший
2380  6E7D EB           			ex de,hl
2381  6E7E 20 20        			jr nz,check_pac_error
2382  6E80
2383  6E80 3A 15 73     			ld a,(check_sum_on) ;проверять или нет сумму
2384  6E83 B7           			or a
2385  6E84 28 18        			jr z,check_pack_sk
2386  6E86 11 80 F6     			ld de,rec_buf
2387  6E89 CD FD 70     			call calc_check_sum ;проверить сумму
2388  6E8C EB           			ex de,hl
2389  6E8D 01 80 F6     			ld bc,rec_buf
2390  6E90 2A 4E 73     			ld hl,(check_sum_size) ;pack_size_1024_com+pack_size_32_com
2391  6E93 09           			add hl,bc
2392  6E94 EB           			ex de,hl
2393  6E95 1A           			ld a,(de)
2394  6E96 BD           			cp l
2395  6E97 20 0F        			jr nz,check_chs_error
2396  6E99 13           			inc de
2397  6E9A 1A           			ld a,(de)
2398  6E9B BC           			cp h
2399  6E9C 20 0A        			jr nz,check_chs_error
2400  6E9E              check_pack_sk
2401  6E9E A7           			and a ;флаг сбросим С=0
2402  6E9F C9           			ret ;успешно проверен
2403  6EA0
2404  6EA0              check_pac_error ;проверка пакета не прошла
2405  6EA0 21 BE 74     			ld hl,mes_pac_error
2406  6EA3 CD E9 76     			call print_sys
2407  6EA6 3F           			ccf ;C=1
2408  6EA7 C9           			ret
2409  6EA8
2410  6EA8
2411  6EA8              check_chs_error
2412  6EA8                          ;проверка суммы не прошла
2413  6EA8 21 AE 74     			ld hl,mes_chs_error
2414  6EAB CD E9 76     			call print_sys
2415  6EAE 3F           			ccf
2416  6EAF C9           			ret
2417  6EB0
2418  6EB0              wait_releas
2419  6EB0 76           			halt ;ждём отпускания клавиши
2420  6EB1 3A 04 5C     			ld 	a,(23556) ;сист. переменная нажатая клавиша
2421  6EB4 FE FF        			cp #ff
2422  6EB6 20 F8        			jr nz,wait_releas
2423  6EB8 C9           			ret
2424  6EB9
2425  6EB9
2426  6EB9              calc_next_pos		;вперёд на 4 сектора
2427  6EB9 06 04        			ld b,4
2428  6EBB ED 5B EB 5C  			ld  de,(#5ceb)
2429  6EBF              calc_next_pos2
2430  6EBF 1C           			inc e
2431  6EC0 7B           			ld a,e
2432  6EC1 FE 10        			cp 16
2433  6EC3 38 03        			jr c,calc_next_pos1
2434  6EC5 14           			inc d
2435  6EC6 1E 00        			ld e,0
2436  6EC8              calc_next_pos1
2437  6EC8 10 F5        			djnz calc_next_pos2
2438  6ECA ED 53 EB 5C  			ld (#5ceb),de
2439  6ECE C9           			ret
2440  6ECF
2441  6ECF
2442  6ECF              cls_pic
2443  6ECF 21 00 40     			ld hl,#4000
2444  6ED2 11 01 40     			ld de,#4001
2445  6ED5 01 00 18     			ld bc,6144
2446  6ED8 36 00        			ld (hl),0
2447  6EDA ED B0        			ldir
2448  6EDC 36 07        			ld (hl),col_fon
2449  6EDE 01 FF 02     			ld bc,768-1
2450  6EE1 ED B0        			ldir
2451  6EE3 C9           			ret
2452  6EE4
2453  6EE4
2454  6EE4              printcat_r ;печать каталога правая панель
2455  6EE4 3A 2A 73     			ld a,(panel) ;проверка надо ли скрыть курсор
2456  6EE7 FE 52        			cp "R"
2457  6EE9 3E 39        			ld a,colorcatc_act
2458  6EEB 28 02        			jr z,printcat_r1
2459  6EED 3E 0F        			ld a,colorcat_
2460  6EEF              printcat_r1
2461  6EEF 32 19 73     			ld (colorcatc_r),a
2462  6EF2
2463  6EF2 21 16 58                 ld      hl,col_pos_r ;
2464  6EF5 AF                       xor		a
2465  6EF6              clscat_r
2466  6EF6 54                       ld      d,h
2467  6EF7 5D                       ld      e,l
2468  6EF8 13                       inc     de
2469  6EF9 4F                       ld      c,a  ;keep
2470  6EFA 3A 1F 73                 ld      a,(shiftcat_r)
2471  6EFD 47                       ld      b,a
2472  6EFE 3A 27 73                 ld      a,(curfile_r)
2473  6F01 A7                       and     a
2474  6F02 98                       sbc     a,b
2475  6F03 B9                       cp      c
2476  6F04 32 1C 73                 ld      (cursor_r),a ;posit
2477  6F07 3A 1A 73                 ld      a,(colorcat_r)
2478  6F0A 20 03                    jr      nz,clscat01_r
2479  6F0C 3A 19 73                 ld      a,(colorcatc_r) ;mark
2480  6F0F              clscat01_r
2481  6F0F 77                       ld      (hl),a  ;раскраска атрибутами
2482  6F10 79                       ld      a,c  ;restor
2483  6F11 01 09 00                 ld      bc,9
2484  6F14 ED B0                    ldir
2485  6F16 01 17 00                 ld      bc,32-9
2486  6F19 09                       add     hl,bc
2487  6F1A 3C                       inc     a
2488  6F1B FE 15                    cp      files_view
2489  6F1D 38 D7                    jr      c,clscat_r
2490  6F1F
2491  6F1F                     ;     ld      hl,catposit
2492  6F1F                     ;     call    print
2493  6F1F
2494  6F1F 3A 26 73     			ld a,(files_r)
2495  6F22 B7           			or a
2496  6F23 C8           			ret z ;выход если нет файлов
2497  6F24
2498  6F24                           ;теперь печать имён файлов
2499  6F24 3A 1F 73                 ld      a,(shiftcat_r)
2500  6F27 DD 6F        			ld xl,a
2501  6F29                          ; or      a
2502  6F29                          ; jr      z,printcat00
2503  6F29 6F           			ld      l,a
2504  6F2A 26 00        			ld 		h,0
2505  6F2C              ;printcat01  ;find name file
2506  6F2C 29                       add    hl,hl ;2
2507  6F2D 29           			add    hl,hl ;4
2508  6F2E 29           			add    hl,hl ;8
2509  6F2F 29           			add    hl,hl ;16
2510  6F30 01 80 EE     			ld bc,cat_r ;адрес обычного каталога
2511  6F33 3A 39 73     			ld a,(open_trd_flag)
2512  6F36 B7           			or a
2513  6F37 28 03        			jr z,printcat00_r
2514  6F39 01 70 C6     			ld bc,cat_open_trd ;адрес каталога образа
2515  6F3C              printcat00_r
2516  6F3C 09           			add hl,bc
2517  6F3D                          ;dec    a
2518  6F3D                          ;jr    nz,printcat01
2519  6F3D              ;printcat00
2520  6F3D
2521  6F3D AF                       xor     a
2522  6F3E              printcat02_r
2523  6F3E F5                       push    af
2524  6F3F E5                       push    hl
2525  6F40                                     ;print 24 row
2526  6F40
2527  6F40 32 59 73                 ld      (catposit_r+1),a
2528  6F43 21 58 73                 ld      hl,catposit_r ;установим позицию печати
2529  6F46 CD 09 77                 call    print
2530  6F49 E1                       pop     hl
2531  6F4A E5                       push    hl
2532  6F4B 3A 39 73     			ld a,(open_trd_flag)
2533  6F4E B7           			or a
2534  6F4F 28 05        			jr z,printcat02_r_net
2535  6F51 CD 22 70     			call format_name_trd ;подготовим имя, если это открытый образ
2536  6F54 18 03        			jr printcat02_r_skip
2537  6F56              printcat02_r_net
2538  6F56 CD 5E 70     			call format_name_net
2539  6F59              printcat02_r_skip
2540  6F59              			;отметка галкой
2541  6F59 EB           			ex de,hl
2542  6F5A 21 00 D0     			ld hl,cat_mark_r
2543  6F5D DD 7D        			ld a,xl
2544  6F5F 85           			add l
2545  6F60 6F           			ld l,a
2546  6F61 7E           			ld a,(hl)
2547  6F62 EB           			ex de,hl
2548  6F63 B7           			or a
2549  6F64 28 09        			jr z,printcat_mark_r
2550  6F66 E5           			push hl
2551  6F67 3E FB        			ld a,0-5 ;знак галка
2552  6F69 01 08 00     			ld bc,8
2553  6F6C 09           			add hl,bc
2554  6F6D 77           			ld (hl),a
2555  6F6E E1           			pop hl
2556  6F6F              printcat_mark_r
2557  6F6F DD 2C        			inc xl
2558  6F71              			;
2559  6F71
2560  6F71 01 0C 00     			ld bc,12 ;длина
2561  6F74 CD F8 76                 call    print_ ;печать одного имени файла
2562  6F77                          ;ld      hl,catspace
2563  6F77                          ;call    print
2564  6F77 E1                       pop     hl
2565  6F78 01 10 00                 ld      bc,lenghtName ;на след. имя
2566  6F7B 09                       add     hl,bc
2567  6F7C F1                       pop     af
2568  6F7D 3C                       inc     a
2569  6F7E ED 4B 26 73  			ld 		bc,(files_r) ;проверка сколько всего файлов
2570  6F82 B9           			cp 		c
2571  6F83 D0           			ret		nc
2572  6F84 FE 15                    cp      files_view
2573  6F86 38 B6                    jr      c,printcat02_r
2574  6F88 C9           			ret
2575  6F89
2576  6F89
2577  6F89              printcat_l ;печать каталога левая панель
2578  6F89 3A 1D 73     		ld a,(cur_drive)
2579  6F8C FE 04        		cp 4
2580  6F8E D2 FF 7D     		jp nc,printcat_l_fat ;если FAT
2581  6F91 3A 2A 73     			ld a,(panel) ;проверка надо ли скрыть курсор
2582  6F94 FE 4C        			cp "L"
2583  6F96 3E 39        			ld a,colorcatc_act
2584  6F98 28 02        			jr z,printcat_l1
2585  6F9A 3E 0F        			ld a,colorcat_
2586  6F9C              printcat_l1
2587  6F9C 32 17 73     			ld (colorcatc_l),a
2588  6F9F
2589  6F9F 21 00 58                 ld      hl,col_pos_l ;
2590  6FA2 AF                       xor		a
2591  6FA3              clscat_l
2592  6FA3 54                       ld      d,h
2593  6FA4 5D                       ld      e,l
2594  6FA5 13                       inc     de
2595  6FA6 4F                       ld      c,a  ;keep
2596  6FA7 3A 20 73                 ld      a,(shiftcat_l)
2597  6FAA 47                       ld      b,a
2598  6FAB 3A 29 73                 ld      a,(curfile_l)
2599  6FAE A7                       and     a
2600  6FAF 98                       sbc     a,b
2601  6FB0 B9                       cp      c
2602  6FB1 32 1B 73                 ld      (cursor_l),a ;posit
2603  6FB4 3A 18 73                 ld      a,(colorcat_l)
2604  6FB7 20 03                    jr      nz,clscat01_l
2605  6FB9 3A 17 73                 ld      a,(colorcatc_l) ;mark
2606  6FBC              clscat01_l
2607  6FBC 77                       ld      (hl),a  ;раскраска атрибутами
2608  6FBD 79                       ld      a,c  ;restor
2609  6FBE 01 09 00                 ld      bc,9
2610  6FC1 ED B0                    ldir
2611  6FC3 01 17 00                 ld      bc,32-9
2612  6FC6 09                       add     hl,bc
2613  6FC7 3C                       inc     a
2614  6FC8 FE 15                    cp      files_view
2615  6FCA 38 D7                    jr      c,clscat_l
2616  6FCC
2617  6FCC                     ;     ld      hl,catposit
2618  6FCC                     ;     call    print
2619  6FCC
2620  6FCC 3A 28 73     			ld a,(files_l)
2621  6FCF B7           			or a
2622  6FD0 C8           			ret z ;выход если нет файлов
2623  6FD1
2624  6FD1 01 80 D0                 ld      bc,cat_l  ;теперь печать имён файлов
2625  6FD4 3A 20 73                 ld      a,(shiftcat_l)
2626  6FD7 DD 6F        			ld xl,a
2627  6FD9                          ; or      a
2628  6FD9                          ; jr      z,printcat00
2629  6FD9 6F           			ld      l,a
2630  6FDA 26 00        			ld 		h,0
2631  6FDC              ;printcat01  ;find name file
2632  6FDC 29                       add    hl,hl ;2
2633  6FDD 29           			add    hl,hl ;4
2634  6FDE 29           			add    hl,hl ;8
2635  6FDF 29           			add    hl,hl ;16
2636  6FE0 09           			add hl,bc
2637  6FE1                          ;dec    a
2638  6FE1                          ;jr    nz,printcat01
2639  6FE1              ;printcat00
2640  6FE1
2641  6FE1 AF                       xor     a
2642  6FE2              printcat02_l
2643  6FE2 F5                       push    af
2644  6FE3 E5                       push    hl
2645  6FE4                                     ;print 24 row
2646  6FE4
2647  6FE4 32 55 73                 ld      (catposit_l+1),a
2648  6FE7 21 54 73                 ld      hl,catposit_l ;установим позицию печати
2649  6FEA CD 09 77                 call    print
2650  6FED E1                       pop     hl
2651  6FEE E5                       push    hl
2652  6FEF CD 22 70     			call 	format_name_trd ;подготовим
2653  6FF2              			;отметка галкой
2654  6FF2 EB           			ex de,hl
2655  6FF3 21 80 CF     			ld hl,cat_mark_l
2656  6FF6 DD 7D        			ld a,xl
2657  6FF8 85           			add l
2658  6FF9 6F           			ld l,a
2659  6FFA 7E           			ld a,(hl)
2660  6FFB EB           			ex de,hl
2661  6FFC B7           			or a
2662  6FFD 28 09        			jr z,printcat_mark_l
2663  6FFF E5           			push hl
2664  7000 3E FB        			ld a,0-5 ;знак галка
2665  7002 01 08 00     			ld bc,8
2666  7005 09           			add hl,bc
2667  7006 77           			ld (hl),a
2668  7007 E1           			pop hl
2669  7008              printcat_mark_l
2670  7008 DD 2C        			inc xl
2671  700A              			;
2672  700A
2673  700A 01 0C 00     			ld bc,12 ;длина
2674  700D CD F8 76                 call    print_ ;печать одного имени файла
2675  7010                          ;ld      hl,catspace
2676  7010                          ;call    print
2677  7010 E1                       pop     hl
2678  7011 01 10 00                 ld      bc,lenghtName ;на след. имя
2679  7014 09                       add     hl,bc
2680  7015 F1                       pop     af
2681  7016 3C                       inc     a
2682  7017 ED 4B 28 73  			ld 		bc,(files_l) ;проверка сколько всего файлов
2683  701B B9           			cp 		c
2684  701C D0           			ret		nc
2685  701D FE 15                    cp      files_view ;проверка сколько файлов показывать
2686  701F 38 C1                    jr      c,printcat02_l
2687  7021 C9           			ret
2688  7022
2689  7022
2690  7022
2691  7022              format_name_trd ;подготавливает имя файла для печати в каталоге, на выходе адрес в HL
2692  7022 11 2B 73                 ld      de,catFName ;здесь временное имя файла
2693  7025 01 08 00                 ld      bc,8   ;name 8 sym
2694  7028 ED B0                    ldir
2695  702A 3E 20        			ld		a," " ;добавим пробел перед расширением
2696  702C 12           			ld		(de),a
2697  702D 13           			inc		de
2698  702E 7E           			ld 		a,(hl) ;если это строчная буква, то расширение 3 символа
2699  702F ED A0        			ldi			;перенесём первую букву расширения
2700  7031 FE 61        			cp 		"a"
2701  7033 38 1B        			jr 		c,format_name_trd05
2702  7035 7E           			ld 		a,(hl)		;перенесём ещё две буквы
2703  7036 B7           			or		a
2704  7037 20 0A        			jr		nz,format_name_trd021
2705  7039 3E 20        			ld		a," " ;если второй нуль, то забъём пробелами
2706  703B 12           			ld		(de),a
2707  703C 23           			inc		hl
2708  703D 13           			inc 	de
2709  703E 12           			ld 		(de),a
2710  703F 23           			inc 	hl
2711  7040 13           			inc		de
2712  7041 18 15        			jr		format_name_trd06
2713  7043              format_name_trd021
2714  7043 ED A0        			ldi		;перенесли вторую букву
2715  7045 7E           			ld 		a,(hl)
2716  7046 B7           			or		a
2717  7047 20 02        			jr		nz,format_name_trd022
2718  7049 3E 20        			ld		a," " ;если третий нуль, добъём пробелом
2719  704B              format_name_trd022
2720  704B 12           			ld		(de),a ;перенесли третью
2721  704C 23           			inc		hl
2722  704D 13           			inc 	de
2723  704E 18 08        			jr		format_name_trd06
2724  7050              format_name_trd05 ;забъём пробелами если расширение одна буква
2725  7050 23           			inc		hl
2726  7051 23           			inc		hl
2727  7052 3E 20        			ld		a," "
2728  7054 12           			ld 		(de),a
2729  7055 13           			inc 	de
2730  7056 12           			ld		(de),a
2731  7057 13           			inc 	de
2732  7058              format_name_trd06
2733  7058 AF                       xor		a
2734  7059 12                       ld      (de),a ;marker end line
2735  705A 21 2B 73     			ld 		hl,catFName
2736  705D C9           			ret
2737  705E
2738  705E
2739  705E              ;для каталога сервера
2740  705E              format_name_net ;подготавливает имя файла для печати в каталоге, на выходе адрес в HL
2741  705E E5           			push hl
2742  705F 21 2B 73                 ld      hl,catFName ;здесь временное имя файла
2743  7062 11 2C 73     			ld      de,catFName+1
2744  7065 36 20        			ld (hl)," "
2745  7067 01 0A 00     			ld bc,8+3-1
2746  706A ED B0        			ldir ;почистить
2747  706C E1           			pop hl
2748  706D 11 2B 73     			ld      de,catFName ;здесь временное имя файла
2749  7070 01 FF 08                 ld      bc,#08ff   ;name 8 sym
2750  7073              format_name_net_cl
2751  7073 7E           			ld a,(hl)
2752  7074 FE 2E        			cp "."
2753  7076 28 04        			jr z,format_name_net_ext
2754  7078 ED A0        			ldi
2755  707A 10 F7        			djnz format_name_net_cl
2756  707C              format_name_net_ext
2757  707C 23           			inc hl
2758  707D 11 34 73     			ld      de,catFName+9
2759  7080 01 03 00                 ld      bc,3   ;ext 3 sym
2760  7083 ED B0        			ldir
2761  7085 AF           			xor		a
2762  7086 12                       ld      (de),a ;marker end line
2763  7087 21 2B 73     			ld 		hl,catFName
2764  708A C9           			ret
2765  708B
2766  708B
2767  708B              format_name_fat_l ;подготавливает имя файла для печати в каталоге, на выходе адрес в HL
2768  708B 11 2B 73                 ld      de,catFName ;здесь временное имя файла
2769  708E 01 08 00                 ld      bc,8   ;name 8 sym
2770  7091 ED B0                    ldir
2771  7093 3E 20        			ld		a," " ;добавим пробел перед расширением
2772  7095 12           			ld		(de),a
2773  7096 13           			inc		de
2774  7097
2775  7097              			;ld bc,#0b-8
2776  7097              			;push hl
2777  7097              			;add hl,bc
2778  7097              			;ld a,(hl)
2779  7097              			;pop hl
2780  7097              			; bit 4,a ;признак каталога
2781  7097              			; jr z,format_name_fat_l_no_dir
2782  7097              			; ;если папка
2783  7097              			; ld a,"<"
2784  7097              			; ld (de),a
2785  7097              			; inc de
2786  7097              			; ld a,"."
2787  7097              			; ld (de),a
2788  7097              			; inc de
2789  7097              			; ld a,">"
2790  7097              			; ld (de),a
2791  7097              			; inc de
2792  7097              			; jr format_name_fat_l_ex
2793  7097              format_name_fat_l_no_dir
2794  7097 01 03 00     			ld bc,3
2795  709A ED B0        			ldir		;перенесём расширение
2796  709C              format_name_fat_l_ex
2797  709C AF           			xor		a
2798  709D 12                       ld      (de),a ;marker end line
2799  709E 21 2B 73     			ld 		hl,catFName
2800  70A1 C9           			ret
2801  70A2
2802  70A2
2803  70A2
2804  70A2              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
2805  70A2              				;на входе в HL число
2806  70A2 11 10 27     			ld de,10000 ;десятки тысяч
2807  70A5 3E FF        			ld a,255
2808  70A7              toDecimal10k
2809  70A7 A7           			and a
2810  70A8 ED 52        			sbc hl,de
2811  70AA 3C           			inc a
2812  70AB 30 FA        			jr nc,toDecimal10k
2813  70AD 19           			add hl,de
2814  70AE C6 30        			add a,48
2815  70B0 32 F8 70     			ld (decimalS),a
2816  70B3 11 E8 03     			ld de,1000 ;тысячи
2817  70B6 3E FF        			ld a,255
2818  70B8              toDecimal1k
2819  70B8 A7           			and a
2820  70B9 ED 52        			sbc hl,de
2821  70BB 3C           			inc a
2822  70BC 30 FA        			jr nc,toDecimal1k
2823  70BE 19           			add hl,de
2824  70BF C6 30        			add a,48
2825  70C1 32 F9 70     			ld (decimalS+1),a
2826  70C4 11 64 00     			ld de,100 ;сотни
2827  70C7 3E FF        			ld a,255
2828  70C9              toDecimal01k
2829  70C9 A7           			and a
2830  70CA ED 52        			sbc hl,de
2831  70CC 3C           			inc a
2832  70CD 30 FA        			jr nc,toDecimal01k
2833  70CF 19           			add hl,de
2834  70D0 C6 30        			add a,48
2835  70D2 32 FA 70     			ld (decimalS+2),a
2836  70D5 11 0A 00     			ld de,10 ;десятки
2837  70D8 3E FF        			ld a,255
2838  70DA              toDecimal001k
2839  70DA A7           			and a
2840  70DB ED 52        			sbc hl,de
2841  70DD 3C           			inc a
2842  70DE 30 FA        			jr nc,toDecimal001k
2843  70E0 19           			add hl,de
2844  70E1 C6 30        			add a,48
2845  70E3 32 FB 70     			ld (decimalS+3),a
2846  70E6 11 01 00     			ld de,1 ;единицы
2847  70E9 3E FF        			ld a,255
2848  70EB              toDecimal0001k
2849  70EB A7           			and a
2850  70EC ED 52        			sbc hl,de
2851  70EE 3C           			inc a
2852  70EF 30 FA        			jr nc,toDecimal0001k
2853  70F1 19           			add hl,de
2854  70F2 C6 30        			add a,48
2855  70F4 32 FC 70     			ld (decimalS+4),a
2856  70F7
2857  70F7 C9           			ret
2858  70F8
2859  70F8 00 00 00...  decimalS	ds 5 ;десятичные цифры
2860  70FD
2861  70FD
2862  70FD              calc_check_sum ;подсчёт контрольной суммы
2863  70FD 21 00 00     	ld hl,0
2864  7100              	;ld de,rec_buf
2865  7100 ED 4B 4E 73  	ld bc,(check_sum_size) ;pack_size_1024_com+pack_size_32_com
2866  7104              calc_check_sum1
2867  7104 C5           	push bc
2868  7105 EB           	ex de,hl
2869  7106 4E           	ld c,(hl)
2870  7107 06 00        	ld b,0
2871  7109 EB           	ex de,hl
2872  710A 09           	add hl,bc
2873  710B 13           	inc de
2874  710C C1           	pop bc
2875  710D 0B           	dec bc
2876  710E 78           	ld a,b
2877  710F B1           	or c
2878  7110 20 F2        	jr nz,calc_check_sum1
2879  7112 C9           	ret
2880  7113
2881  7113              readcat ;чтение каталога
2882  7113 3A 1D 73     			ld 		a,(cur_drive)
2883  7116 FE 04        			cp 4
2884  7118 D2 71 7D     			jp nc,readcat_fat ;начиная с 4 будет диск FAT
2885  711B 0E 01                    ld      c,1 ;настройка на диск
2886  711D CD 13 3D                 call    #3d13
2887  7120 0E 18                    ld      c,#18
2888  7122 CD 13 3D                 call    #3d13
2889  7125 21 80 D0                 ld      hl,cat_l ;to
2890  7128 11 00 00                 ld      de,#0000 ;0 trk 0 sec
2891  712B 06 09                    ld      b,9      ;9 sect
2892  712D 0E 05                    ld      c,5 ;read
2893  712F CD 13 3D                 call    #3d13
2894  7132 21 64 D9                 ld      hl,cat_l+2048+#e4;
2895  7135 7E                       ld      a,(hl) ;total files
2896  7136 32 28 73     			ld      (files_l),a ;всего файлов на диске
2897  7139                          ;or      a
2898  7139                          ;ret     z  ;exit if no fales
2899  7139
2900  7139                          ; ld      c,a
2901  7139                          ; ld      a,128
2902  7139                          ; sub     c
2903  7139                          ; ld      (catend),a ;fill end cat
2904  7139                          ;ld      a,c
2905  7139                          ;call    markdrive
2906  7139 C9                       ret
2907  713A
2908  713A              change_panel ;смена панели
2909  713A 3A 2A 73     	ld a,(panel)
2910  713D FE 4C        	cp "L"
2911  713F 28 06        	jr z,change_panel_r
2912  7141 CD 82 71     	call sel_left_pan
2913  7144 C3 47 60         jp     wait
2914  7147              change_panel_r
2915  7147 CD 58 71     	call sel_right_pan
2916  714A C3 47 60         jp     wait
2917  714D
2918  714D              printcat ;печать активного каталога
2919  714D 3A 2A 73     	ld a,(panel)
2920  7150 FE 4C        	cp "L"
2921  7152 CA 89 6F     	jp z,printcat_l
2922  7155 C3 E4 6E     	jp printcat_r
2923  7158
2924  7158              sel_right_pan ;выбор правой панели
2925  7158 3A 26 73     	ld     a,(files_r)
2926  715B 32 24 73     	ld     (files),a
2927  715E 3A 1E 73     	ld     a,(shiftcat)
2928  7161 32 20 73     	ld     (shiftcat_l),a
2929  7164 3A 25 73     	ld     a,(curfile)
2930  7167 32 29 73     	ld     (curfile_l),a
2931  716A 3A 1F 73     	ld     a,(shiftcat_r)
2932  716D 32 1E 73     	ld     (shiftcat),a
2933  7170 3A 27 73     	ld     a,(curfile_r)
2934  7173 32 25 73     	ld     (curfile),a
2935  7176 3E 52        	ld a,"R"
2936  7178 32 2A 73     	ld (panel),a
2937  717B CD 89 6F     	call printcat_l
2938  717E CD E4 6E     	call printcat_r
2939  7181 C9           	ret
2940  7182              sel_left_pan ;выбор левой панели
2941  7182 3A 28 73     	ld     a,(files_l)
2942  7185 32 24 73     	ld     (files),a
2943  7188 3A 1E 73     	ld     a,(shiftcat)
2944  718B 32 1F 73     	ld     (shiftcat_r),a
2945  718E 3A 25 73     	ld     a,(curfile)
2946  7191 32 27 73     	ld     (curfile_r),a
2947  7194 3A 20 73     	ld     a,(shiftcat_l)
2948  7197 32 1E 73     	ld     (shiftcat),a
2949  719A 3A 29 73     	ld     a,(curfile_l)
2950  719D 32 25 73     	ld     (curfile),a
2951  71A0 3E 4C        	ld a,"L"
2952  71A2 32 2A 73     	ld (panel),a
2953  71A5 CD 89 6F     	call printcat_l
2954  71A8 CD E4 6E     	call printcat_r
2955  71AB C9           	ret
2956  71AC
2957  71AC              init_dev ;инициализация устройства передачи
2958  71AC              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
2959  71AC              	; ld hl,mes_req_init
2960  71AC              	; call print_sys
2961  71AC CD 62 79     	call Wifi.init
2962  71AF              	;ret
2963  71AF
2964  71AF              open_tcp ;открыть соединение
2965  71AF 21 6E 76     	ld hl,mes_open_tcp
2966  71B2 CD E9 76     	call print_sys
2967  71B5 21 50 76     	ld hl,server_name
2968  71B8 11 69 76     	ld de,server_port
2969  71BB C3 46 7A     	jp Wifi.openTCP
2970  71BE
2971  71BE              	; ld de,pack_size_1024 ;размер полного пакета
2972  71BE              	; call start_rcv ;всё примем
2973  71BE              	;call read_buf
2974  71BE
2975  71BE              	; ld hl,cmd_brk ;прервать передачу
2976  71BE              	; ld de,cmd_brk_end-cmd_brk
2977  71BE              	; call start_trn1 ;оправка
2978  71BE              	; call read_buf
2979  71BE
2980  71BE              	; ld hl,cmd_ipclose ;закрыть соединение
2981  71BE              	; ld de,cmd_ipclose_e-cmd_ipclose
2982  71BE              	; call start_trn1 ;оправка
2983  71BE
2984  71BE              	; ld de,pack_size_1024_full ;размер полного пакета
2985  71BE              	; call start_rcv ;всё примем
2986  71BE              	; ;call read_buf
2987  71BE
2988  71BE              	; ;подготовить строку открытия соединения
2989  71BE              	; ld hl,cmd_ipstart
2990  71BE              	; ld bc,cmd_ipstart_e-cmd_ipstart
2991  71BE              	; ld ix,bc ;длина
2992  71BE              	; ld de,cipstart_line
2993  71BE              	; ldir
2994  71BE              	; ;имя сервера
2995  71BE              	; ld hl,server_name
2996  71BE              ; init_dev_server
2997  71BE              	; ld a,(hl)
2998  71BE              	; cp " "
2999  71BE              	; jr c,init_dev1
3000  71BE              	; ldi
3001  71BE              	; inc ix
3002  71BE              	; jr init_dev_server
3003  71BE              ; init_dev1
3004  71BE              	; ld a,'"'
3005  71BE              	; ld (de),a
3006  71BE              	; inc de
3007  71BE              	; inc ix
3008  71BE              	; ld a,','
3009  71BE              	; ld (de),a
3010  71BE              	; inc de
3011  71BE              	; inc ix
3012  71BE              	; ;порт
3013  71BE              	; ld hl,server_port
3014  71BE              ; init_dev_server2
3015  71BE              	; ld a,(hl)
3016  71BE              	; cp " "
3017  71BE              	; jr c,init_dev2
3018  71BE              	; ldi
3019  71BE              	; inc ix
3020  71BE              	; jr init_dev_server2
3021  71BE              ; init_dev2
3022  71BE              	; ld a,13
3023  71BE              	; ld (de),a
3024  71BE              	; inc de
3025  71BE              	; inc ix
3026  71BE              	; ld a,10
3027  71BE              	; ld (de),a
3028  71BE              	; inc ix
3029  71BE
3030  71BE              	; ld hl,cipstart_line
3031  71BE              	; ld de,ix ;длина
3032  71BE              	; call start_trn1 ;оправка
3033  71BE
3034  71BE              	; ld de,pack_size_1024_full ;размер полного пакета
3035  71BE              	; call start_rcv ;всё примем
3036  71BE              	; ;call read_buf
3037  71BE              	; ret
3038  71BE
3039  71BE              ;read_buf	;чтение в буфер
3040  71BE              	; ld bc,257 ;очистить буфер - убрать!
3041  71BE              	; ld hl,rec_buf
3042  71BE              	; ld de,rec_buf+1
3043  71BE              	; ld (hl),0
3044  71BE              	; ldir
3045  71BE
3046  71BE              	; ld b,0 ;чтение данных
3047  71BE              	; ld hl,rec_buf
3048  71BE              ; read_buf1
3049  71BE              	; call Uart.read
3050  71BE              	; ret nc
3051  71BE              	; ld (hl),a
3052  71BE              	; inc hl
3053  71BE              	; djnz read_buf1
3054  71BE              	; ret
3055  71BE
3056  71BE              	; ;проверка заголовка UDP
3057  71BE              ; check_id
3058  71BE              	; ld hl,rec_buf
3059  71BE              	; ld de,pack_id ;образец для сравнения
3060  71BE              	; ld b,0 ;ограничение на поиск
3061  71BE              	; ld c,pack_id_e-pack_id ;символов для сравнения
3062  71BE              ; compar1
3063  71BE              	; ld a,(de)
3064  71BE              	; cp (hl)
3065  71BE              	; jr z,compar2
3066  71BE              	; ld c,pack_id_e-pack_id
3067  71BE              	; ld de,pack_id	;с начала образца
3068  71BE              	; inc hl
3069  71BE              	; djnz compar1
3070  71BE              	; jr compar_no
3071  71BE              ; compar2
3072  71BE              	; inc de
3073  71BE              	; inc hl
3074  71BE              	; dec c
3075  71BE              	; jr nz,compar1
3076  71BE              	; ;и в конце найти ещё ":"
3077  71BE              ; compar3
3078  71BE              	; ld a,(hl)
3079  71BE              	; inc hl
3080  71BE              	; cp ":"
3081  71BE              	; jr z,compar_ok
3082  71BE              	; djnz compar3
3083  71BE              ; compar_no ;не нашли
3084  71BE              	; xor a
3085  71BE              	; ret ;
3086  71BE              ; compar_ok ;нашли
3087  71BE              	; ;в hl указатель на начало ответного пакета
3088  71BE              	; ld (rec_buf_adr_pack),hl
3089  71BE              	; ex de,hl
3090  71BE              	; ld hl,pack_size_32_com
3091  71BE              	; add hl,de
3092  71BE              	; ld (rec_buf_adr_pack1),hl
3093  71BE              	; ex de,hl
3094  71BE              	; scf
3095  71BE              	; ret
3096  71BE
3097  71BE
3098  71BE              print_progress ;печать текущего прогресса
3099  71BE CD A2 70     			call toDecimal
3100  71C1 21 F8 70     		    ld hl,decimalS ;
3101  71C4 11 E4 75     			ld de,mes_progress+3
3102  71C7 01 05 00     			ld bc,5
3103  71CA ED B0        			ldir
3104  71CC 21 E1 75     			ld hl,mes_progress
3105  71CF CD E9 76     			call print_sys
3106  71D2 C9           			ret
3107  71D3
3108  71D3              print_progress_tot ;печать общего прогресса
3109  71D3 CD A2 70     			call toDecimal
3110  71D6 21 F8 70     		    ld hl,decimalS ;
3111  71D9 11 F6 75     			ld de,mes_progress_tot+3
3112  71DC 01 05 00     			ld bc,5
3113  71DF ED B0        			ldir
3114  71E1 21 F3 75     			ld hl,mes_progress_tot
3115  71E4 CD E9 76     			call print_sys
3116  71E7 C9           			ret
3117  71E8
3118  71E8
3119  71E8
3120  71E8              markF ;отметка файлов для копирования
3121  71E8 3A 24 73     	ld a,(files) ;всего
3122  71EB B7           	or a
3123  71EC CA 46 61     	jp z,wait_cont	;если 0
3124  71EF
3125  71EF 3A 2A 73     	ld a,(panel)
3126  71F2 FE 52        	cp "R"
3127  71F4 C2 16 72     	jp nz,markF_l ;если левая панель
3128  71F7              	;правая панель
3129  71F7 3A 39 73     	ld a,(open_trd_flag)
3130  71FA B7           	or a
3131  71FB CA 05 72     	jp z,markF_r1 ;если не открыт образ
3132  71FE              	;правая панель
3133  71FE 3A 25 73     	ld a,(curfile) ;номер файла
3134  7201 B7           	or a
3135  7202 CA 46 61     	jp z,wait_cont	;многоточие нельзя выбрать
3136  7205              markF_r1
3137  7205 3A 25 73     	ld a,(curfile) ;номер файла
3138  7208 21 00 D0     	ld hl,cat_mark_r
3139  720B 06 00        	ld b,0
3140  720D 4F           	ld c,a
3141  720E 09           	add hl,bc
3142  720F 7E           	ld a,(hl)
3143  7210 EE 01        	xor 1 ;меняем на противоположное
3144  7212 77           	ld (hl),a
3145  7213              	;call wait_releas
3146  7213 C3 46 61     	jp wait_cont
3147  7216
3148  7216              markF_l ;левая панель
3149  7216 3A 1D 73     	ld a,(cur_drive)
3150  7219 FE 04        	cp 4
3151  721B 38 0E        	jr c,markF_l_TRD ;
3152  721D 3A 25 73     	ld a,(curfile) ;номер файла
3153  7220              	;если FAT
3154  7220 CD C0 82     	call calc_cat_fat_deskr
3155  7223 DD 7E 0B     	ld a,(ix+#0b)
3156  7226 CB 67        	bit 4,a
3157  7228 C2 46 61     	jp nz,wait_cont ;если папка, то нельзя пометить
3158  722B              markF_l_TRD
3159  722B 3A 25 73     	ld a,(curfile)
3160  722E 21 80 CF     	ld hl,cat_mark_l
3161  7231 06 00        	ld b,0
3162  7233 4F           	ld c,a
3163  7234 09           	add hl,bc
3164  7235 7E           	ld a,(hl)
3165  7236 EE 01        	xor 1 ;меняем на противоположное
3166  7238 77           	ld (hl),a
3167  7239              	;call wait_releas
3168  7239 C3 46 61     	jp wait_cont
3169  723C
3170  723C
3171  723C
3172  723C              mark_all ;отметить все файлы
3173  723C 3A 2A 73     	ld a,(panel)
3174  723F FE 52        	cp "R"
3175  7241 C2 8C 72     	jp nz,mark_all_l ;если левая панель
3176  7244
3177  7244              	;правая панель
3178  7244 3A 39 73     	ld a,(open_trd_flag)
3179  7247 B7           	or a
3180  7248 CA 6E 72     	jp z,mark_all_r_fat ;не если не открыт образ
3181  724B 3A 24 73     	ld a,(files) ;всего
3182  724E FE 02        	cp 2
3183  7250 DA 46 61     	jp c,wait_cont	;если только точки
3184  7253 21 01 D0     	ld hl,cat_mark_r+1
3185  7256 FE 02        	cp 2 ;если один
3186  7258 20 05        	jr nz,mark_all_r
3187  725A              	;если 1 файл
3188  725A 36 01        	ld (hl),1 ;отметить второй
3189  725C CA 46 61     	jp z,wait_cont
3190  725F              mark_all_r
3191  725F D6 02        	sub 2
3192  7261 06 00        	ld b,0
3193  7263 4F           	ld c,a
3194  7264 11 02 D0     	ld de,cat_mark_r+2
3195  7267 36 01        	ld (hl),1 ;отметить много
3196  7269 ED B0        	ldir
3197  726B C3 46 61     	jp wait_cont
3198  726E              mark_all_r_fat
3199  726E              	;правая fat
3200  726E 3A 24 73     	ld a,(files) ;всего
3201  7271 21 00 D0     	ld hl,cat_mark_r
3202  7274 FE 02        	cp 2 ;если один
3203  7276 30 05        	jr nc,mark_all_r_fat1
3204  7278              	;если 1 файл
3205  7278 36 01        	ld (hl),1
3206  727A C3 46 61     	jp wait_cont
3207  727D              mark_all_r_fat1
3208  727D D6 01        	sub 1
3209  727F 06 00        	ld b,0
3210  7281 4F           	ld c,a
3211  7282 11 01 D0     	ld de,cat_mark_r+1
3212  7285 36 01        	ld (hl),1 ;отметить много
3213  7287 ED B0        	ldir
3214  7289 C3 46 61     	jp wait_cont
3215  728C
3216  728C
3217  728C
3218  728C              mark_all_l ;левая панель
3219  728C 3A 24 73     	ld a,(files) ;всего
3220  728F B7           	or a
3221  7290 CA 46 61     	jp z,wait_cont	;если 0
3222  7293
3223  7293 3A 1D 73     	ld a,(cur_drive)
3224  7296 FE 04        	cp 4
3225  7298 38 36        	jr c,mark_all_l_TRD ;
3226  729A
3227  729A              	;если FAT
3228  729A 3A 24 73     	ld a,(files) ;всего
3229  729D FE 01        	cp 1
3230  729F 20 13        	jr nz,mark_all_l1_fat
3231  72A1 3A 25 73     	ld a,(curfile) ;номер файла
3232  72A4 CD C0 82     	call calc_cat_fat_deskr
3233  72A7 DD 7E 0B     	ld a,(ix+#0b)
3234  72AA CB 67        	bit 4,a
3235  72AC C2 46 61     	jp nz,wait_cont ;если папка, то нельзя пометить
3236  72AF 36 01        	ld (hl),1 ;отметить первый
3237  72B1 C3 46 61     	jp wait_cont
3238  72B4
3239  72B4              mark_all_l1_fat
3240  72B4 5F           	ld e,a ;счётчик
3241  72B5 16 00        	ld d,0
3242  72B7 21 80 CF     	ld hl,cat_mark_l
3243  72BA              mark_all_l1_fat_cl ;цикл
3244  72BA 7A           	ld a,d
3245  72BB CD C0 82     	call calc_cat_fat_deskr
3246  72BE DD 7E 0B     	ld a,(ix+#0b)
3247  72C1 CB 67        	bit 4,a
3248  72C3 C2 C8 72     	jp nz,mark_all_l1_fat_cl1 ;если папка, то нельзя пометить
3249  72C6 36 01        	ld (hl),1 ;отметить много
3250  72C8              mark_all_l1_fat_cl1
3251  72C8 23           	inc hl
3252  72C9 14           	inc d
3253  72CA 1D           	dec e
3254  72CB 20 ED        	jr nz,mark_all_l1_fat_cl
3255  72CD C3 46 61     	jp wait_cont
3256  72D0
3257  72D0
3258  72D0
3259  72D0              	;если TRD
3260  72D0              mark_all_l_TRD
3261  72D0 3A 24 73     	ld a,(files) ;всего
3262  72D3 21 80 CF     	ld hl,cat_mark_l
3263  72D6 FE 01        	cp 1
3264  72D8 20 05        	jr nz,mark_all_l1
3265  72DA 36 01        	ld (hl),1 ;отметить первый
3266  72DC CA 46 61     	jp z,wait_cont
3267  72DF              mark_all_l1
3268  72DF 3D           	dec a
3269  72E0 06 00        	ld b,0
3270  72E2 4F           	ld c,a
3271  72E3 11 81 CF     	ld de,cat_mark_l+1
3272  72E6 36 01        	ld (hl),1 ;отметить много
3273  72E8 ED B0        	ldir
3274  72EA C3 46 61     	jp wait_cont
3275  72ED
3276  72ED
3277  72ED
3278  72ED              unmark_all ;снять отметку со всех файлов
3279  72ED 3A 2A 73     	ld a,(panel)
3280  72F0 FE 52        	cp "R"
3281  72F2 C2 05 73     	jp nz,unmark_all_l ;если левая панель
3282  72F5              	;правая
3283  72F5 21 00 D0     	ld hl,cat_mark_r
3284  72F8 11 01 D0     	ld de,cat_mark_r+1
3285  72FB 36 00        	ld (hl),0
3286  72FD 01 7F 00     	ld bc,128-1
3287  7300 ED B0        	ldir
3288  7302 C3 46 61     	jp wait_cont
3289  7305              unmark_all_l ;левая
3290  7305 21 80 CF     	ld hl,cat_mark_l
3291  7308 11 81 CF     	ld de,cat_mark_l+1
3292  730B 36 00        	ld (hl),0
3293  730D 01 7F 00     	ld bc,128-1
3294  7310 ED B0        	ldir
3295  7312 C3 46 61     	jp wait_cont
3296  7315
3297  7315              ;pack_size dw 0 ;размер пакета
3298  7315 01           check_sum_on db 1; флаг включения проверки контрольной суммы
3299  7316 01           check_sum_on_tmp db 1; сохранение флага
3300  7317 39           colorcatc_l db colorcatc_act ;цвет выбранного файла слева
3301  7318 0F           colorcat_l db  colorcat_; цвет окна каталога слева
3302  7319 39           colorcatc_r db colorcatc_act ;цвет выбранного файла справа
3303  731A 0F           colorcat_r db  colorcat_; цвет окна каталога	справа
3304  731B 00           cursor_l   db     0; строка курсора слева
3305  731C 00           cursor_r   db     0; строка курсора справа
3306  731D 00           cur_drive db 0 ; дисковод
3307  731E 00           shiftcat db 0;сдвиг по каталогу
3308  731F 00           shiftcat_r db 0;сдвиг по каталогу правая панель
3309  7320 00           shiftcat_l db 0;сдвиг по каталогу левая панель
3310  7321 14           keyRepeat db 20 ;пауза перед повтором нажатия клавиши
3311  7322 FF           keyLast db 255; последняя нажатая клавиша
3312  7323 00           keyDelayF db 0 ;флаг что уже была пауза нажатия
3313  7324 00           files db 0 ;всего файлов
3314  7325 00           curfile db 0 ; текущий файл
3315  7326 00           files_r db 0 ;всего файлов правая панель
3316  7327 00           curfile_r db 0 ; текущий файл правая панель
3317  7328 00           files_l db 0 ;всего файлов левая панель
3318  7329 00           curfile_l db 0 ; текущий файл левая панель
3319  732A              ;col_pos dw #5800 ;позиция для покраски
3320  732A 00           panel db 0; текущая панель
3321  732B 00 00 00...  catFName  ds		13 ;имя файла для каталога
3322  7338 00           		 db		0 ;маркер конца имени
3323  7339 00           open_trd_flag db 0 ;открыт образ
3324  733A              ;rec_buf_adr_pack dw 0 ;адрес начала принятого пакета без заголовка UDP
3325  733A              ;rec_buf_adr_pack1 dw 0 ;адрес начала принятого пакета без заголовка ZXN
3326  733A 00 00        cur_cat_pag dw 0 ;текущая страница каталога сервера
3327  733C              ;rec_buf_adr_pack1_tmp dw 0 ;временное хранилище
3328  733C 00           curfile_r2 db 0 ;хранение позиции курсора при открытии образа
3329  733D 00           shiftcat_r2 db 0
3330  733E 00           files_r2 db 0
3331  733F 00           files2 db 0
3332  7340 00 00        check_init_val dw 0 ;контрольная сумма для системы внеочередной инициализации
3333  7342 00           check_init_count db 0 ;счётчик системы
3334  7343 00 00        cur_trk dw 0 ;текущие сектор-дорожка
3335  7345 00 00        copyF_RL_source_file dw 0 ;указатель на исходный файл для копирования
3336  7347 00 00        copyF_RL_source_sec_size dw 0 ;размер в секторах исходного файла
3337  7349 00 00        copyF_RL_source_trk dw 0 ;исходные дорожка-сектор файла
3338  734B 00           copyF_RL_dest_sec_cat db 0 ;сектор каталога где запись о файле назначения
3339  734C 00 00        copyF_FAT_RL_last_part dw 0 ;последний кусок файла для записи
3340  734E              ;copyF_RL_first_pack_flag db 0; флаг для первого пакета файла
3341  734E 00 00        check_sum_size dw 0 ;длина области для подсчёта суммы
3342  7350 00 00        cat_mark_cur dw 0 ;текущая позиция в таблице отмеченных файлов слева
3343  7352 00           cat_mark_cur_cl db 0 ;позиция цикла копирования слева
3344  7353 00           cat_mark_cur_tot db 0 ;осталось копировать файлов
3345  7354
3346  7354              catposit_l ;позиция печати каталога слева
3347  7354 16 00 00 00  	db 22,0,0,0
3348  7358              catposit_r ;позиция печати каталога справа
3349  7358 16 00 1E 00  	db 22,0,30,0
3350  735C 20 20 20 20  cat_space db "            ",0 ;пробелы для очистки
3350  7360 20 20 20 20
3350  7364 20 20 20 20
3350  7368 00
3351  7369              mes_sys_at ;позиция печати сист. сообщений
3352  7369 16 17 00 00  	db 22,23,0,0
3353  736D              mes_req_cat
3354  736D 43 61 74 20  	db "Cat in request",0
3354  7371 69 6E 20 72
3354  7375 65 71 75 65
3354  7379 73 74 00
3355  737C              mes_rec_cat
3356  737C 43 61 74 20  	db "Cat "
3357  7380              mes_rec_cat_num
3358  7380 30 30 30 20  	db "000 in OK",0
3358  7384 69 6E 20 4F
3358  7388 4B 00
3359  738A              mes_req_part_file
3360  738A 46 69 6C 65  	db "File in request",0
3360  738E 20 69 6E 20
3360  7392 72 65 71 75
3360  7396 65 73 74 00
3361  739A              mes_trq_part_file
3362  739A 46 69 6C 65  	db "File out request",0
3362  739E 20 6F 75 74
3362  73A2 20 72 65 71
3362  73A6 75 65 73 74
3362  73AA 00
3363  73AB              mes_rec_file
3364  73AB 46 69 6C 65  	db "File in OK",0
3364  73AF 20 69 6E 20
3364  73B3 4F 4B 00
3365  73B6              mes_trn_file
3366  73B6 46 69 6C 65  	db "File out OK",0
3366  73BA 20 6F 75 74
3366  73BE 20 4F 4B 00
3367  73C2              mes_rec_part_file
3368  73C2 50 61 72 74  	db "Part in OK",0
3368  73C6 20 69 6E 20
3368  73CA 4F 4B 00
3369  73CD              mes_trn_part_file
3370  73CD 50 61 72 74  	db "Part out OK",0
3370  73D1 20 6F 75 74
3370  73D5 20 4F 4B 00
3371  73D9              mes_wrt_part_file
3372  73D9 57 72 69 74  	db "Write "
3372  73DD 65 20
3373  73DF              mes_wrt_part_file_num
3374  73DF 30 30 30 00  	db "000",0
3375  73E3              mes_rd_part_file
3376  73E3 52 65 61 64  	db "Read "
3376  73E7 20
3377  73E8              mes_rd_part_file_num
3378  73E8 30 30 30 00  	db "000",0
3379  73EC              mes_req_init
3380  73EC 49 6E 69 74  	db "Init",0
3380  73F0 00
3381  73F1              ; mes_translink_off
3382  73F1              	; db "ESP link off    ",0
3383  73F1              ; mes_translink_on
3384  73F1              	; db "ESP link on     ",0
3385  73F1              mes_esp_rst
3386  73F1 45 53 50 20  	db "ESP reset",0
3386  73F5 72 65 73 65
3386  73F9 74 00
3387  73FB              mes_ok
3388  73FB 4F 4B 00     	db "OK",0
3389  73FE
3390  73FE              mes_win_cls
3391  73FE 16 0E 0D 20  	db 22,14,13,"                "
3391  7402 20 20 20 20
3391  7406 20 20 20 20
3391  740A 20 20 20 20
3391  740E 20 20 20
3392  7411 16 0F 0D 20  	db 22,15,13,"                "
3392  7415 20 20 20 20
3392  7419 20 20 20 20
3392  741D 20 20 20 20
3392  7421 20 20 20
3393  7424 16 10 0D 20  	db 22,16,13,"                ",0
3393  7428 20 20 20 20
3393  742C 20 20 20 20
3393  7430 20 20 20 20
3393  7434 20 20 20 00
3394  7438              mes_trd_name
3395  7438 16 0F 0D 4E  	db 22,15,13,"Name: ";
3395  743C 61 6D 65 3A
3395  7440 20
3396  7441 20 20 20 20  trd_name db "          "
3396  7445 20 20 20 20
3396  7449 20 20
3397  744B              mes_trd_name_curs
3398  744B 16 10 0D 20  	db 22,16,13,"                ",0
3398  744F 20 20 20 20
3398  7453 20 20 20 20
3398  7457 20 20 20 20
3398  745B 20 20 20 00
3399  745F
3400  745F              mes_read_trd
3401  745F 16 0E 0D 20  	db 22,14,13," READ TRD, dsk:",0;
3401  7463 52 45 41 44
3401  7467 20 54 52 44
3401  746B 2C 20 64 73
3401  746F 6B 3A 00
3402  7472              mes_write_trd
3403  7472 16 0E 0D 57  	db 22,14,13,"WRITE TRD, dsk:",0;
3403  7476 52 49 54 45
3403  747A 20 54 52 44
3403  747E 2C 20 64 73
3403  7482 6B 3A 00
3404  7485 16 0E 1C 41  mes_trd_dsk db 22,14,28,"A"
3405  7489 16 0F 0D 20  	db 22,15,13,"  Y to start   "
3405  748D 20 59 20 74
3405  7491 6F 20 73 74
3405  7495 61 72 74 20
3405  7499 20 20
3406  749B 16 10 0D 20  	db 22,16,13,"  N to cancel  ",0
3406  749F 20 4E 20 74
3406  74A3 6F 20 63 61
3406  74A7 6E 63 65 6C
3406  74AB 20 20 00
3407  74AE              mes_chs_error
3408  74AE 43 68 65 63  	db "Check sum error",0
3408  74B2 6B 20 73 75
3408  74B6 6D 20 65 72
3408  74BA 72 6F 72 00
3409  74BE              mes_pac_error
3410  74BE 50 61 63 6B  	db "Packet error",0
3410  74C2 65 74 20 65
3410  74C6 72 72 6F 72
3410  74CA 00
3411  74CB              mes_stopped
3412  74CB 53 74 6F 70  	db "Stopped",0
3412  74CF 70 65 64 00
3413  74D3              mes_title
3414  74D3 16 00 0E 41  	db 22,0,14,"AY232K v0.1.3"
3414  74D7 59 32 33 32
3414  74DB 4B 20 76 30
3414  74DF 2E 31 2E 33
3415  74E3 16 02 0E 41  	db 22,2,14,"Arrow keys"
3415  74E7 72 72 6F 77
3415  74EB 20 6B 65 79
3415  74EF 73
3416  74F0 16 03 0E 52  	db 22,3,14,"R - renew"
3416  74F4 20 2D 20 72
3416  74F8 65 6E 65 77
3417  74FC 16 04 0E 41  	db 22,4,14,"A-D, H - disk"
3417  7500 2D 44 2C 20
3417  7504 48 20 2D 20
3417  7508 64 69 73 6B
3418  750C 16 05 0E 45  	db 22,5,14,"En - run/open"
3418  7510 6E 20 2D 20
3418  7514 72 75 6E 2F
3418  7518 6F 70 65 6E
3419  751C 16 06 0E 35  	db 22,6,14,"5 - copy"
3419  7520 20 2D 20 63
3419  7524 6F 70 79
3420  7527 16 07 0E 54  	db 22,7,14,"T - TRD copy"
3420  752B 20 2D 20 54
3420  752F 52 44 20 63
3420  7533 6F 70 79
3421  7536 16 08 0E 45  	db 22,8,14,"Ext - panel"
3421  753A 78 74 20 2D
3421  753E 20 70 61 6E
3421  7542 65 6C
3422  7544 16 09 0E 53  	db 22,9,14,"Sp - mark/stop"
3422  7548 70 20 2D 20
3422  754C 6D 61 72 6B
3422  7550 2F 73 74 6F
3422  7554 70
3423  7555 16 0A 0E 4B  	db 22,10,14,"K - mark all"
3423  7559 20 2D 20 6D
3423  755D 61 72 6B 20
3423  7561 61 6C 6C
3424  7564 16 0B 0E 4A  	db 22,11,14,"J - unmark all"
3424  7568 20 2D 20 75
3424  756C 6E 6D 61 72
3424  7570 6B 20 61 6C
3424  7574 6C
3425  7575 16 0C 0E 45  	db 22,12,14,"E - exit"
3425  7579 20 2D 20 65
3425  757D 78 69 74
3426  7580              	;db 22,11,15,"S - Sum: "
3427  7580              ;mes_check_sum
3428  7580              	;db "Y"
3429  7580              	; db 22,13,15,"Dangerous(!):"
3430  7580 16 0D 0E 49  	db 22,13,14,"I - ESP Reset"
3430  7584 20 2D 20 45
3430  7588 53 50 20 52
3430  758C 65 73 65 74
3431  7590
3432  7590 00           	db 0
3433  7591              mes_wait
3434  7591 16 11 12 57  	db 22,17,18,"Wait..",0
3434  7595 61 69 74 2E
3434  7599 2E 00
3435  759B              mes_wait_off
3436  759B 16 11 12 20  	db 22,17,18,"      ",0
3436  759F 20 20 20 20
3436  75A3 20 00
3437  75A5              mes_copy_file
3438  75A5 16 0E 0D 43  	db 22,14,13,         "COPY FILE, dsk:",0;
3438  75A9 4F 50 59 20
3438  75AD 46 49 4C 45
3438  75B1 2C 20 64 73
3438  75B5 6B 3A 00
3439  75B8              mes_copy_error
3440  75B8 16 0F 0D 10  	db 22,15,13,16,2*8+7,"Error copy file "
3440  75BC 17 45 72 72
3440  75C0 6F 72 20 63
3440  75C4 6F 70 79 20
3440  75C8 66 69 6C 65
3440  75CC 20
3441  75CD 16 10 0D 20  	db 22,16,13,         "                ",0
3441  75D1 20 20 20 20
3441  75D5 20 20 20 20
3441  75D9 20 20 20 20
3441  75DD 20 20 20 00
3442  75E1
3443  75E1              mes_progress
3444  75E1 16 13 12 30  	db 22,19,18,"00000",0
3444  75E5 30 30 30 30
3444  75E9 00
3445  75EA              mes_progress_off
3446  75EA 16 13 12 20  	db 22,19,18,"     ",0
3446  75EE 20 20 20 20
3446  75F2 00
3447  75F3
3448  75F3              mes_progress_tot
3449  75F3 16 14 12 30  	db 22,20,18,"00000",0
3449  75F7 30 30 30 30
3449  75FB 00
3450  75FC              mes_progress_tot_off
3451  75FC 16 14 12 20  	db 22,20,18,"     ",0
3451  7600 20 20 20 20
3451  7604 00
3452  7605
3453  7605 16 00 00 53  mes_curent_drive	db 22,0,0,"Select ("
3453  7609 65 6C 65 63
3453  760D 74 20 28
3454  7610 20 29 00     mes_curent_drive_letter db " )",0
3455  7613 16 01 00 41  mes_fdd	db 22,1,0,"A-D - FDD",0
3455  7617 2D 44 20 2D
3455  761B 20 46 44 44
3455  761F 00
3456  7620 16 02 00 00  mes_fat_found db 22,2,0,0
3457  7624 16 02 00 46  mes_fat_not_found db 22,2,0,"FAT not found",13,0
3457  7628 41 54 20 6E
3457  762C 6F 74 20 66
3457  7630 6F 75 6E 64
3457  7634 0D 00
3458  7636 0D 00        mes_next_line db 13,0
3459  7638
3460  7638 4E 6F 20     mes_read_cfg_err db "No "
3461  763B 41 59 32 33  file_cfg_name db "AY232K_iC",0
3461  763F 32 4B 5F 69
3461  7643 43 00
3462  7645
3463  7645              mes_server
3464  7645 16 16 12 53  	db 22,22,18,"Server: "
3464  7649 65 72 76 65
3464  764D 72 3A 20
3465  7650 00 00 00...  server_name ds 15 ;имя сервера
3466  765F 00           	db 0
3467  7660              mes_port
3468  7660 16 17 12 50  	db 22,23,18,"Port: "
3468  7664 6F 72 74 3A
3468  7668 20
3469  7669 00 00 00 00  server_port ds 4 ;порт
3470  766D 00           	db 0
3471  766E              mes_open_tcp
3472  766E 4F 70 65 6E  	db "Open TCP...",0
3472  7672 20 54 43 50
3472  7676 2E 2E 2E 00
3473  767A
3474  767A
3475  767A              scroll_sys ;скрол области системных сообщений
3476  767A              	; ld de,#4000+2048+2048+3*32
3477  767A              	; ld hl,#4000+2048+2048+4*32
3478  767A              	; ld a,8
3479  767A              ; scroll_sys1
3480  767A              	; push hl
3481  767A              	; push de
3482  767A              	; ld bc,scroll_len ; длина области для сдвига
3483  767A              	; ldir
3484  767A              	; pop de
3485  767A              	; pop hl
3486  767A              	; inc h
3487  767A              	; inc d
3488  767A              	; dec a
3489  767A              	; jr nz,scroll_sys1
3490  767A
3491  767A              	; ld de,#4000+2048+2048+4*32
3492  767A              	; ld hl,#4000+2048+2048+5*32
3493  767A              	; ld a,8
3494  767A              ; scroll_sys2
3495  767A              	; push hl
3496  767A              	; push de
3497  767A              	; ld bc,scroll_len ; длина области для сдвига
3498  767A              	; ldir
3499  767A              	; pop de
3500  767A              	; pop hl
3501  767A              	; inc h
3502  767A              	; inc d
3503  767A              	; dec a
3504  767A              	; jr nz,scroll_sys2
3505  767A
3506  767A 11 A0 50     	ld de,#4000+2048+2048+5*32
3507  767D 21 C0 50     	ld hl,#4000+2048+2048+6*32
3508  7680 3E 08        	ld a,8
3509  7682              scroll_sys3
3510  7682 E5           	push hl
3511  7683 D5           	push de
3512  7684              	dup scroll_len ; длина области для сдвига
3513  7684 ED A0       >	ldi
3513  7686 ED A0       >	ldi
3513  7688 ED A0       >	ldi
3513  768A ED A0       >	ldi
3513  768C ED A0       >	ldi
3513  768E ED A0       >	ldi
3513  7690 ED A0       >	ldi
3513  7692 ED A0       >	ldi
3513  7694 ED A0       >	ldi
3513  7696 ED A0       >	ldi
3513  7698 ED A0       >	ldi
3513  769A ED A0       >	ldi
3513  769C ED A0       >	ldi
3514  769E              	edup
3515  769E D1           	pop de
3516  769F E1           	pop hl
3517  76A0 24           	inc h
3518  76A1 14           	inc d
3519  76A2 3D           	dec a
3520  76A3 20 DD        	jr nz,scroll_sys3
3521  76A5
3522  76A5 11 C0 50     	ld de,#4000+2048+2048+6*32
3523  76A8 21 E0 50     	ld hl,#4000+2048+2048+7*32
3524  76AB 3E 08        	ld a,8
3525  76AD              scroll_sys4
3526  76AD E5           	push hl
3527  76AE D5           	push de
3528  76AF              	dup scroll_len ; длина области для сдвига
3529  76AF ED A0       >	ldi
3529  76B1 ED A0       >	ldi
3529  76B3 ED A0       >	ldi
3529  76B5 ED A0       >	ldi
3529  76B7 ED A0       >	ldi
3529  76B9 ED A0       >	ldi
3529  76BB ED A0       >	ldi
3529  76BD ED A0       >	ldi
3529  76BF ED A0       >	ldi
3529  76C1 ED A0       >	ldi
3529  76C3 ED A0       >	ldi
3529  76C5 ED A0       >	ldi
3529  76C7 ED A0       >	ldi
3530  76C9              	edup
3531  76C9 D1           	pop de
3532  76CA E1           	pop hl
3533  76CB 24           	inc h
3534  76CC 14           	inc d
3535  76CD 3D           	dec a
3536  76CE 20 DD        	jr nz,scroll_sys4
3537  76D0
3538  76D0              	;почистить нижнюю строку
3539  76D0 21 E0 50     	ld hl,#4000+2048+2048+7*32
3540  76D3 11 E1 50     	ld de,#4000+2048+2048+7*32+1
3541  76D6 3E 08        	ld a,8
3542  76D8              scroll_sys_e
3543  76D8 E5           	push hl
3544  76D9 D5           	push de
3545  76DA 01 0C 00     	ld bc,scroll_len-1
3546  76DD 36 00        	ld (hl),0
3547  76DF ED B0        	ldir
3548  76E1 D1           	pop de
3549  76E2 E1           	pop hl
3550  76E3 24           	inc h
3551  76E4 14           	inc d
3552  76E5 3D           	dec a
3553  76E6 20 F0        	jr nz,scroll_sys_e
3554  76E8 C9           	ret
3555  76E9
3556  76E9
3557  76E9              print_sys
3558  76E9 E5           	push hl
3559  76EA CD 7A 76     	call scroll_sys
3560  76ED 21 69 73     	ld hl,mes_sys_at
3561  76F0 CD 09 77     	call print ;установка позиции
3562  76F3 E1           	pop hl
3563  76F4 CD 09 77     	call print
3564  76F7 C9           	ret
3565  76F8              ;печать до символа 0
3566  76F8              ;hl - text address
3567  76F8              ;13-enter
3568  76F8              ;16-color(атрибуты 128+64+pap*8+ink)
3569  76F8              ;20-inverse
3570  76F8              ;21-отступ от левого края
3571  76F8              ;22-at
3572  76F8              print_  ;var 2: print text lenght in bc
3573  76F8 7E                   ld      a,(hl)
3574  76F9 CD 7B 77             call    prsym
3575  76FC 23                   inc     hl
3576  76FD 0B                   dec     bc
3577  76FE 78                   ld      a,b
3578  76FF B1                   or      c
3579  7700 20 F6                jr      nz,print_
3580  7702 C9                   ret
3581  7703 E1           aupr    pop     hl
3582  7704 CD 09 77             call    print
3583  7707 E5                   push    hl
3584  7708 C9                   ret
3585  7709              ;start print to 0
3586  7709 7E           print   ld      a,(hl)
3587  770A 23                   inc     hl
3588  770B B7                   or      a
3589  770C C8                   ret     z
3590  770D FE 17                cp      23
3591  770F 38 05                jr      c,prin
3592  7711 CD 7B 77             call    prsym
3593  7714 18 F3                jr      print
3594  7716              prin
3595  7716 FE 0D                cp      13
3596  7718 20 14                jr      nz,prin0
3597  771A 3A 7A 78             ld      a,(space)
3598  771D 32 7C 78             ld      (xtxt),a
3599  7720 3A 7B 78             ld      a,(ytxt)
3600  7723 3C                   inc     a
3601  7724 FE 17                cp      23
3602  7726 38 01                jr      c,pr13_0
3603  7728 AF                   xor     a
3604  7729 32 7B 78     pr13_0  ld      (ytxt),a
3605  772C 18 DB                jr      print
3606  772E FE 10        prin0   cp      16
3607  7730 20 07                jr      nz,prin1
3608  7732 7E                   ld      a,(hl)
3609  7733 23                   inc     hl
3610  7734 32 8F 5C             ld      (23695),a
3611  7737 18 D0                jr      print
3612  7739 FE 14        prin1   cp      20
3613  773B 20 23                jr      nz,prin2
3614  773D 7E                   ld      a,(hl)
3615  773E 23                   inc     hl
3616  773F B7                   or      a
3617  7740 28 10                jr      z,pr20_0
3618  7742 3E 2F                ld      a,#2f
3619  7744 32 EA 77             ld      (pr0),a
3620  7747 32 06 78             ld      (pr1),a
3621  774A 32 16 78             ld      (pr2),a
3622  774D 32 31 78             ld      (pr3),a
3623  7750 18 B7                jr      print
3624  7752 32 EA 77     pr20_0  ld      (pr0),a
3625  7755 32 06 78             ld      (pr1),a
3626  7758 32 16 78             ld      (pr2),a
3627  775B 32 31 78             ld      (pr3),a
3628  775E 18 A9                jr      print
3629  7760 FE 16        prin2   cp      22
3630  7762 20 0C                jr      nz,prin3
3631  7764 7E                   ld      a,(hl)
3632  7765 32 7B 78             ld      (ytxt),a
3633  7768 23                   inc     hl
3634  7769 7E                   ld      a,(hl)
3635  776A 32 7C 78             ld      (xtxt),a
3636  776D 23                   inc     hl
3637  776E 18 99                jr      print
3638  7770 FE 15        prin3   cp      21
3639  7772 20 95                jr      nz,print
3640  7774 7E                   ld      a,(hl)
3641  7775 23                   inc     hl
3642  7776 32 7A 78             ld      (space),a
3643  7779 18 8E                jr      print
3644  777B              prsym
3645  777B F5                   push    af
3646  777C C5                   push    bc
3647  777D D5                   push    de
3648  777E E5                   push    hl
3649  777F DD E5                push    ix
3650  7781 ED 5B 7B 78          ld      de,(ytxt)
3651  7785 14                   inc     d
3652  7786 ED 53 7B 78          ld      (ytxt),de
3653  778A 15                   dec     d
3654  778B 08                   ex      af,af'
3655  778C 7A                   ld      a,d
3656  778D FE 29                cp      41
3657  778F 38 10                jr      c,prs
3658  7791 7B                   ld      a,e
3659  7792 3C                   inc     a
3660  7793 FE 18                cp      24
3661  7795 38 01                jr      c,prs1
3662  7797 AF                   xor     a
3663  7798 32 7B 78     prs1    ld      (ytxt),a
3664  779B 3A 7A 78             ld      a,(space)
3665  779E 32 7C 78             ld      (xtxt),a
3666  77A1 08           prs     ex      af,af'
3667  77A2 6F                   ld      l,a
3668  77A3 26 00                ld      h,#00
3669  77A5 29                   add     hl,hl
3670  77A6 29                   add     hl,hl
3671  77A7 29                   add     hl,hl
3672  77A8 01 5B 83             ld      bc,font
3673  77AB 09                   add     hl,bc
3674  77AC E5                   push    hl
3675  77AD 7A                   ld      a,d
3676  77AE 87                   add     a,a
3677  77AF 57                   ld      d,a
3678  77B0 87                   add     a,a
3679  77B1 82                   add     a,d
3680  77B2 C6 02                add     a,#02
3681  77B4 57                   ld      d,a
3682  77B5 E6 07                and     #07
3683  77B7 08                   ex      af,af'
3684  77B8 7A                   ld      a,d
3685  77B9 0F                   rrca
3686  77BA 0F                   rrca
3687  77BB 0F                   rrca
3688  77BC E6 1F                and     #1F
3689  77BE 57                   ld      d,a
3690  77BF 7B                   ld      a,e
3691  77C0 E6 18                and     #18
3692  77C2 C6 40                add     a,#40
3693  77C4 67                   ld      h,a
3694  77C5 7B                   ld      a,e
3695  77C6 E6 07                and     #07
3696  77C8 0F                   rrca
3697  77C9 0F                   rrca
3698  77CA 0F                   rrca
3699  77CB 82                   add     a,d
3700  77CC 6F                   ld      l,a
3701  77CD 22 78 78             ld      (posit),hl
3702  77D0 D1                   pop     de
3703  77D1 06 08                ld      b,#08
3704  77D3 08                   ex      af,af'
3705  77D4 28 2B                jr      z,L73C7
3706  77D6 DD 60                ld      xh,b
3707  77D8 FE 02                cp      #02
3708  77DA 28 35                jr      z,L73D6
3709  77DC FE 04                cp      #04
3710  77DE 28 45                jr      z,L73E9
3711  77E0 7E           L73A7   ld      a,(hl)
3712  77E1 0F                   rrca
3713  77E2 0F                   rrca
3714  77E3 47                   ld      b,a
3715  77E4 23                   inc     hl
3716  77E5 7E                   ld      a,(hl)
3717  77E6 E6 0F                and     #0F
3718  77E8 4F                   ld      c,a
3719  77E9 1A                   ld      a,(de)
3720  77EA 00           pr0     nop
3721  77EB E6 FC                and     #FC
3722  77ED CB 27                sla     a
3723  77EF CB 10                rl      b
3724  77F1 CB 27                sla     a
3725  77F3 CB 10                rl      b
3726  77F5 B1                   or      c
3727  77F6 77                   ld      (hl),a
3728  77F7 2B                   dec     hl
3729  77F8 70                   ld      (hl),b
3730  77F9 24                   inc     h
3731  77FA 13                   inc     de
3732  77FB DD 25                dec     xh
3733  77FD 20 E1                jr      nz,L73A7
3734  77FF 18 60                jr      prsc1
3735  7801 7E           L73C7   ld      a,(hl)
3736  7802 E6 03                and     #03
3737  7804 4F                   ld      c,a
3738  7805 1A                   ld      a,(de)
3739  7806 00           pr1     nop
3740  7807 E6 FC                and     #FC
3741  7809 B1                   or      c
3742  780A 77                   ld      (hl),a
3743  780B 24                   inc     h
3744  780C 13                   inc     de
3745  780D 10 F2                djnz    L73C7
3746  780F 18 3F                jr      prsc
3747  7811 7E           L73D6   ld      a,(hl)
3748  7812 E6 C0                and     #C0
3749  7814 47                   ld      b,a
3750  7815 1A                   ld      a,(de)
3751  7816 00           pr2     nop
3752  7817 E6 FC                and     #FC
3753  7819 0F                   rrca
3754  781A 0F                   rrca
3755  781B B0                   or      b
3756  781C 77                   ld      (hl),a
3757  781D 24                   inc     h
3758  781E 13                   inc     de
3759  781F DD 25                dec     xh
3760  7821 20 EE                jr      nz,L73D6
3761  7823 18 2B                jr      prsc
3762  7825 7E           L73E9   ld      a,(hl)
3763  7826 0F                   rrca
3764  7827 0F                   rrca
3765  7828 0F                   rrca
3766  7829 0F                   rrca
3767  782A 47                   ld      b,a
3768  782B 23                   inc     hl
3769  782C 7E                   ld      a,(hl)
3770  782D E6 3F                and     #3F
3771  782F 4F                   ld      c,a
3772  7830 1A                   ld      a,(de)
3773  7831 00           pr3     nop
3774  7832 E6 FC                and     #FC
3775  7834 CB 27                sla     a
3776  7836 CB 10                rl      b
3777  7838 CB 27                sla     a
3778  783A CB 10                rl      b
3779  783C CB 27                sla     a
3780  783E CB 10                rl      b
3781  7840 CB 27                sla     a
3782  7842 CB 10                rl      b
3783  7844 B1                   or      c
3784  7845 77                   ld      (hl),a
3785  7846 2B                   dec     hl
3786  7847 70                   ld      (hl),b
3787  7848 24                   inc     h
3788  7849 13                   inc     de
3789  784A DD 25                dec     xh
3790  784C 20 D7                jr      nz,L73E9
3791  784E 18 11                jr      prsc1
3792  7850 2A 78 78     prsc    ld      hl,(posit)
3793  7853 7C                   ld      a,h
3794  7854 E6 18                and     #18
3795  7856 0F                   rrca
3796  7857 0F                   rrca
3797  7858 0F                   rrca
3798  7859 C6 58                add     a,#58
3799  785B 67                   ld      h,a
3800  785C 3A 8F 5C             ld      a,(23695)
3801  785F                      ;ld      (hl),a ;отключена раскраска
3802  785F 18 10                jr      prse
3803  7861 2A 78 78     prsc1   ld      hl,(posit)
3804  7864 7C                   ld      a,h
3805  7865 E6 18                and     #18
3806  7867 0F                   rrca
3807  7868 0F                   rrca
3808  7869 0F                   rrca
3809  786A C6 58                add     a,#58
3810  786C 67                   ld      h,a
3811  786D 3A 8F 5C             ld      a,(23695)
3812  7870                      ;ld      (hl),a
3813  7870 23                   inc     hl
3814  7871                      ;ld      (hl),a
3815  7871 DD E1        prse    pop     ix
3816  7873 E1                   pop     hl
3817  7874 D1                   pop     de
3818  7875 C1                   pop     bc
3819  7876 F1                   pop     af
3820  7877 C9                   ret
3821  7878 00 00        posit   dw      0
3822  787A 00           space   nop
3823  787B 00           ytxt    nop
3824  787C 00           xtxt    nop
3825  787D
3826  787D
3827  787D              ;Приём пакета
3828  787D              start_rcv
3829  787D D5           		push de
3830  787E 21 91 75     		ld hl,mes_wait
3831  7881 CD 09 77     		call print
3832  7884 D1           		pop de
3833  7885 21 80 F6     		ld	hl,rec_buf ; куда принимать
3834  7888              		;ld	de,pack_size_1024_full ;размер
3835  7888              start_rcv1
3836  7888 CD 33 79     		call Uart.read
3837  788B 30 0F        		jr nc,start_rcv_ex
3838  788D 77           		ld (hl),a
3839  788E 23           		inc hl
3840  788F 1B           		dec de
3841  7890 7A           		ld a,d
3842  7891 B3           		or e
3843  7892 20 F4        		jr nz,start_rcv1
3844  7894
3845  7894 21 9B 75     		ld hl,mes_wait_off
3846  7897 CD 09 77     		call print
3847  789A 37           		scf ;флаг C=1, значит приём успешный
3848  789B C9           		ret
3849  789C              start_rcv_ex
3850  789C 21 9B 75     		ld hl,mes_wait_off
3851  789F CD 09 77     		call print
3852  78A2 AF           		xor a ;C=0, если не успешно
3853  78A3 C9           		ret
3854  78A4
3855  78A4
3856  78A4              ;Передача пакета
3857  78A4              start_trn
3858  78A4 21 91 75     		ld hl,mes_wait
3859  78A7 CD 09 77     		call print
3860  78AA
3861  78AA 21 38 B4     		ld	hl,trn_buf ;откуда
3862  78AD              		;ld	de,(pack_size)
3863  78AD              start_trn1
3864  78AD 7E           		ld a,(hl)
3865  78AE CD 4C 79     		call Uart.write
3866  78B1 23           		inc hl
3867  78B2 1B           		dec de
3868  78B3 7A           		ld a,d
3869  78B4 B3           		or e
3870  78B5 20 F6        		jr nz,start_trn1
3871  78B7
3872  78B7 21 9B 75     		ld hl,mes_wait_off
3873  78BA CD 09 77     		call print
3874  78BD C9           		ret
3875  78BE
3876  78BE              check_init_r ;при приёме
3877  78BE 21 3B B4     	ld hl,trn_buf+3
3878  78C1              	;ld hl,trn_buf+pack_size_32_com
3879  78C1 18 03        	jr check_init
3880  78C3              check_init_t ;при передаче
3881  78C3 21 3B B4     	ld hl,trn_buf+3
3882  78C6              	;ld hl,trn_buf+pack_size_1024_com+pack_size_32_com
3883  78C6              check_init
3884  78C6              	;проверка не пора ли сбросить устройство
3885  78C6              	;если слишком часто передаётся один и тот же пакет
3886  78C6              	;значит нужно снова инициализировать
3887  78C6 ED 5B 40 73  	ld de,(check_init_val)
3888  78CA 7E           	ld a,(hl)
3889  78CB BB           	cp e
3890  78CC 20 18        	jr nz,check_init1
3891  78CE 23           	inc hl
3892  78CF 7E           	ld a,(hl)
3893  78D0 2B           	dec hl
3894  78D1 BA           	cp d
3895  78D2 20 12        	jr nz,check_init1
3896  78D4              	;если суммы совпадают
3897  78D4 3A 42 73     	ld a,(check_init_count) ;счётчик попыток
3898  78D7 3C           	inc a
3899  78D8 32 42 73     	ld (check_init_count),a
3900  78DB FE 0A        	cp check_init_max ;сколько попыток максимум
3901  78DD D8           	ret c
3902  78DE AF           	xor a
3903  78DF 32 42 73     	ld (check_init_count),a
3904  78E2 CD AF 71     	call open_tcp ;init_dev ;пора сбросить
3905  78E5 C9           	ret
3906  78E6              check_init1 ;не равныcheck_init
3907  78E6 5E           	ld e,(hl) ;запомнить новое значение
3908  78E7 23           	inc hl
3909  78E8 56           	ld d,(hl)
3910  78E9 ED 53 40 73  	ld (check_init_val),de
3911  78ED AF           	xor a ;сбросить счётчик
3912  78EE 32 42 73     	ld (check_init_count),a
3913  78F1 C9           	ret
3914  78F2
3915  78F2              ;здесь драйвер устройства
3916  78F2              		include "drivers/utils.asm"
# file opened: drivers/utils.asm
   1+ 78F2              ;;; Macroses!!!!
   2+ 78F2                  MACRO EspSend Text
   3+ 78F2 ~                ld hl, .txtB
   4+ 78F2 ~                ld e, (.txtE - .txtB)
   5+ 78F2 ~                call espSend
   6+ 78F2 ~                jr .txtE
   7+ 78F2 ~            .txtB
   8+ 78F2 ~                db Text
   9+ 78F2 ~            .txtE
  10+ 78F2                  ENDM
  11+ 78F2
  12+ 78F2                  MACRO EspCmd Text
  13+ 78F2 ~                ld hl, .txtB
  14+ 78F2 ~                ld e, (.txtE - .txtB)
  15+ 78F2 ~                call espSend
  16+ 78F2 ~                jr .txtE
  17+ 78F2 ~            .txtB
  18+ 78F2 ~                db Text
  19+ 78F2 ~                db 13, 10
  20+ 78F2 ~            .txtE
  21+ 78F2                  ENDM
  22+ 78F2
  23+ 78F2                  MACRO EspCmdOkErr text
  24+ 78F2 ~                EspCmd text
  25+ 78F2 ~                call checkOkErr
  26+ 78F2                  ENDM
  27+ 78F2
  28+ 78F2              ; ; IN DE - string pointer
  29+ 78F2              ; ; OUT HL - string len
  30+ 78F2              ; strLen:
  31+ 78F2                  ; ld hl, 0
  32+ 78F2              ; .loop
  33+ 78F2                  ; ld a, (de) : and a : ret z
  34+ 78F2                  ; inc de, hl
  35+ 78F2                  ; jr .loop
# file closed: drivers/utils.asm
3917  78F2              		include "drivers/zx-wifi.asm"
# file opened: drivers/zx-wifi.asm
   1+ 78F2              ; This driver works with 16c550 uart that's support AFE
   2+ 78F2                  module Uart
   3+ 78F2              ; Make init shorter and readable:-)
   4+ 78F2                  macro outp port, value
   5+ 78F2 ~            	ld b, port
   6+ 78F2 ~            	ld c, #EF
   7+ 78F2 ~                ld a, value
   8+ 78F2 ~                out (c), a
   9+ 78F2                  endm
  10+ 78F2
  11+ 78F2              ; Internal port constants
  12+ 78F2              RBR_THR = #F8
  13+ 78F2              IER     = RBR_THR + 1
  14+ 78F2              IIR_FCR = RBR_THR + 2
  15+ 78F2              LCR     = RBR_THR + 3
  16+ 78F2              MCR     = RBR_THR + 4
  17+ 78F2              LSR     = RBR_THR + 5
  18+ 78F2              MSR     = RBR_THR + 6
  19+ 78F2              SR      = RBR_THR + 7
  20+ 78F2
  21+ 78F2              init:
  22+ 78F2                  outp MCR,     #0d  // Assert RTS
  22+ 78F2 06 FC       >	ld b, MCR
  22+ 78F4 0E EF       >	ld c, #EF
  22+ 78F6 3E 0D       >    ld a, #0d
  22+ 78F8 ED 79       >    out (c), a
  23+ 78FA                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  23+ 78FA 06 FA       >	ld b, IIR_FCR
  23+ 78FC 0E EF       >	ld c, #EF
  23+ 78FE 3E 87       >    ld a, #87
  23+ 7900 ED 79       >    out (c), a
  24+ 7902                  outp LCR,     #83  // 8n1, DLAB=1
  24+ 7902 06 FB       >	ld b, LCR
  24+ 7904 0E EF       >	ld c, #EF
  24+ 7906 3E 83       >    ld a, #83
  24+ 7908 ED 79       >    out (c), a
  25+ 790A                  outp RBR_THR, #01  // 115200 (divider 1)
  25+ 790A 06 F8       >	ld b, RBR_THR
  25+ 790C 0E EF       >	ld c, #EF
  25+ 790E 3E 01       >    ld a, #01
  25+ 7910 ED 79       >    out (c), a
  26+ 7912                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  26+ 7912 06 F9       >	ld b, IER
  26+ 7914 0E EF       >	ld c, #EF
  26+ 7916 3E 00       >    ld a, #00
  26+ 7918 ED 79       >    out (c), a
  27+ 791A
  28+ 791A                  outp LCR,     #03 // 8n1, DLAB=0
  28+ 791A 06 FB       >	ld b, LCR
  28+ 791C 0E EF       >	ld c, #EF
  28+ 791E 3E 03       >    ld a, #03
  28+ 7920 ED 79       >    out (c), a
  29+ 7922                  outp IER,     #00 // Disable int
  29+ 7922 06 F9       >	ld b, IER
  29+ 7924 0E EF       >	ld c, #EF
  29+ 7926 3E 00       >    ld a, #00
  29+ 7928 ED 79       >    out (c), a
  30+ 792A                  outp MCR,     #2f // Enable AFE
  30+ 792A 06 FC       >	ld b, MCR
  30+ 792C 0E EF       >	ld c, #EF
  30+ 792E 3E 2F       >    ld a, #2f
  30+ 7930 ED 79       >    out (c), a
  31+ 7932 C9               ret
  32+ 7933
  33+ 7933              retry_rec_count_max equ 20 ;ждать данных максимум столько прерываний
  34+ 7933
  35+ 7933              ; Flag C <- Data available
  36+ 7933              ; isAvailable:
  37+ 7933                  ; ld a, LSR
  38+ 7933                  ; in a, (#EF)
  39+ 7933                  ; rrca
  40+ 7933                  ; ret
  41+ 7933
  42+ 7933              ; Non-blocking read
  43+ 7933              ; Flag C <- is byte was readen
  44+ 7933              ; A <- byte
  45+ 7933              ; read1:
  46+ 7933                  ; ld a, LSR
  47+ 7933                  ; in a, (#EF)
  48+ 7933                  ; rrca
  49+ 7933                  ; ret nc
  50+ 7933                  ; ld a, RBR_THR
  51+ 7933                  ; in a, (#EF)
  52+ 7933                  ; scf
  53+ 7933                  ; ret
  54+ 7933
  55+ 7933              ; Tries read byte with timeout
  56+ 7933              ; Flag C <- is byte read
  57+ 7933              ; A <- byte
  58+ 7933              read:
  59+ 7933 AF           	xor a ;4
  60+ 7934 32 78 5C     	ld (#5C78),a ;обнулить счётчик ожидания ;13
  61+ 7937              .wait
  62+ 7937 3E FD            ld a, LSR
  63+ 7939 DB EF            in a, (#EF)
  64+ 793B 0F               rrca
  65+ 793C 30 05        	jr nc, .readW
  66+ 793E 3E F8            ld a, RBR_THR
  67+ 7940 DB EF            in a, (#EF)
  68+ 7942 C9           	ret
  69+ 7943              .readW
  70+ 7943 3A 78 5C     	ld a,(#5C78)
  71+ 7946 FE 14        	cp retry_rec_count_max
  72+ 7948 38 ED        	jr c, .wait ;ещё попытка
  73+ 794A AF           	xor a ;выключим флаг переноса если время вышло
  74+ 794B C9           	ret
  75+ 794C
  76+ 794C
  77+ 794C
  78+ 794C
  79+ 794C              ; Blocking read
  80+ 794C              ; A <- Byte
  81+ 794C              ; readB:
  82+ 794C                  ; ld a, LSR
  83+ 794C                  ; in a, (#EF)
  84+ 794C                  ; rrca
  85+ 794C                  ; jr nc, readB
  86+ 794C              	; ld a, RBR_THR
  87+ 794C                  ; in a, (#EF)
  88+ 794C                  ; ret
  89+ 794C
  90+ 794C              ; A -> byte to send
  91+ 794C              write:
  92+ 794C F5               push af
  93+ 794D              .wait
  94+ 794D 3E FD        	ld a, LSR
  95+ 794F DB EF            in a, (#EF)
  96+ 7951 E6 20            and #20
  97+ 7953 28 F8            jr z, .wait
  98+ 7955 F1               pop af
  99+ 7956 06 F8        	ld b, RBR_THR
 100+ 7958 0E EF        	ld c, #EF
 101+ 795A ED 79            out (c), a
 102+ 795C C9               ret
 103+ 795D
 104+ 795D                  endmodule
# file closed: drivers/zx-wifi.asm
3918  795D              		include "drivers/wifi.asm"
# file opened: drivers/wifi.asm
   1+ 795D                  MODULE Wifi
   2+ 795D 00 00        bytes_avail dw 0
   3+ 795F 00 00        buffer_pointer dw 0
   4+ 7961 01           closed db 1
   5+ 7962              ; Initialize Wifi chip to work
   6+ 7962              init:
   7+ 7962 21 1E 7A         ld hl, .uartIniting
   7+ 7965 CD E9 76       call print_sys
   8+ 7968 CD F2 78         call Uart.init
   9+ 796B 21 2F 7A         ld hl, .chipIniting
   9+ 796E CD E9 76       call print_sys
  10+ 7971                  EspCmdOkErr "ATE0"
  10+ 7971             >    EspCmd "ATE0"
  10+ 7971 21 7B 79    >    ld hl, .txtB
  10+ 7974 1E 06       >    ld e, (.txtE - .txtB)
  10+ 7976 CD 0C 7B    >    call espSend
  10+ 7979 18 06       >    jr .txtE
  10+ 797B             >.txtB
  10+ 797B 41 54 45 30 >    db "ATE0"
  10+ 797F 0D 0A       >    db 13, 10
  10+ 7981             >.txtE
  10+ 7981 CD A5 7A    >    call checkOkErr
  11+ 7984 38 79            jr c, .initError
  12+ 7986
  13+ 7986                  EspCmdOkErr "AT+CIPSERVER=0"
  13+ 7986             >    EspCmd "AT+CIPSERVER=0"
  13+ 7986 21 90 79    >    ld hl, .txtB
  13+ 7989 1E 10       >    ld e, (.txtE - .txtB)
  13+ 798B CD 0C 7B    >    call espSend
  13+ 798E 18 10       >    jr .txtE
  13+ 7990             >.txtB
  13+ 7990 41 54 2B 43 >    db "AT+CIPSERVER=0"
  13+ 7994 49 50 53 45 >
  13+ 7998 52 56 45 52 >
  13+ 799C 3D 30       >
  13+ 799E 0D 0A       >    db 13, 10
  13+ 79A0             >.txtE
  13+ 79A0 CD A5 7A    >    call checkOkErr
  14+ 79A3                  EspCmdOkErr "AT+CIPCLOSE" ; Close if there some connection was. Don't care about result
  14+ 79A3             >    EspCmd "AT+CIPCLOSE"
  14+ 79A3 21 AD 79    >    ld hl, .txtB
  14+ 79A6 1E 0D       >    ld e, (.txtE - .txtB)
  14+ 79A8 CD 0C 7B    >    call espSend
  14+ 79AB 18 0D       >    jr .txtE
  14+ 79AD             >.txtB
  14+ 79AD 41 54 2B 43 >    db "AT+CIPCLOSE"
  14+ 79B1 49 50 43 4C >
  14+ 79B5 4F 53 45    >
  14+ 79B8 0D 0A       >    db 13, 10
  14+ 79BA             >.txtE
  14+ 79BA CD A5 7A    >    call checkOkErr
  15+ 79BD                  EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  15+ 79BD             >    EspCmd "AT+CIPMUX=0"
  15+ 79BD 21 C7 79    >    ld hl, .txtB
  15+ 79C0 1E 0D       >    ld e, (.txtE - .txtB)
  15+ 79C2 CD 0C 7B    >    call espSend
  15+ 79C5 18 0D       >    jr .txtE
  15+ 79C7             >.txtB
  15+ 79C7 41 54 2B 43 >    db "AT+CIPMUX=0"
  15+ 79CB 49 50 4D 55 >
  15+ 79CF 58 3D 30    >
  15+ 79D2 0D 0A       >    db 13, 10
  15+ 79D4             >.txtE
  15+ 79D4 CD A5 7A    >    call checkOkErr
  16+ 79D7 38 26            jr c, .initError
  17+ 79D9
  18+ 79D9                  EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  18+ 79D9             >    EspCmd "AT+CIPDINFO=0"
  18+ 79D9 21 E3 79    >    ld hl, .txtB
  18+ 79DC 1E 0F       >    ld e, (.txtE - .txtB)
  18+ 79DE CD 0C 7B    >    call espSend
  18+ 79E1 18 0F       >    jr .txtE
  18+ 79E3             >.txtB
  18+ 79E3 41 54 2B 43 >    db "AT+CIPDINFO=0"
  18+ 79E7 49 50 44 49 >
  18+ 79EB 4E 46 4F 3D >
  18+ 79EF 30          >
  18+ 79F0 0D 0A       >    db 13, 10
  18+ 79F2             >.txtE
  18+ 79F2 CD A5 7A    >    call checkOkErr
  19+ 79F5 38 08            jr c, .initError
  20+ 79F7
  21+ 79F7 21 40 7A         ld hl, .doneInit
  21+ 79FA CD E9 76       call print_sys
  22+ 79FD
  23+ 79FD B7               or a
  24+ 79FE C9               ret
  25+ 79FF              .initError
  26+ 79FF 21 07 7A         ld hl, .errMsg
  26+ 7A02 CD E9 76       call print_sys
  27+ 7A05 37               scf
  28+ 7A06 C9               ret
  29+ 7A07 57 69 46 69  .errMsg db "WiFi chip init failed!",0
  29+ 7A0B 20 63 68 69
  29+ 7A0F 70 20 69 6E
  29+ 7A13 69 74 20 66
  29+ 7A17 61 69 6C 65
  29+ 7A1B 64 21 00
  30+ 7A1E 55 61 72 74  .uartIniting db "Uart initing...",13,0
  30+ 7A22 20 69 6E 69
  30+ 7A26 74 69 6E 67
  30+ 7A2A 2E 2E 2E 0D
  30+ 7A2E 00
  31+ 7A2F 43 68 69 70  .chipIniting db "Chip initing...",13,0
  31+ 7A33 20 69 6E 69
  31+ 7A37 74 69 6E 67
  31+ 7A3B 2E 2E 2E 0D
  31+ 7A3F 00
  32+ 7A40 44 6F 6E 65  .doneInit    db "Done!",0
  32+ 7A44 21 00
  33+ 7A46                  IFNDEF PROXY
  34+ 7A46              ; HL - host pointer in gopher row
  35+ 7A46              ; DE - port pointer in gopher row
  36+ 7A46              openTCP:
  37+ 7A46 D5               push de
  38+ 7A47 E5               push hl
  39+ 7A48                  EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  39+ 7A48             >    EspCmd "AT+CIPCLOSE"
  39+ 7A48 21 52 7A    >    ld hl, .txtB
  39+ 7A4B 1E 0D       >    ld e, (.txtE - .txtB)
  39+ 7A4D CD 0C 7B    >    call espSend
  39+ 7A50 18 0D       >    jr .txtE
  39+ 7A52             >.txtB
  39+ 7A52 41 54 2B 43 >    db "AT+CIPCLOSE"
  39+ 7A56 49 50 43 4C >
  39+ 7A5A 4F 53 45    >
  39+ 7A5D 0D 0A       >    db 13, 10
  39+ 7A5F             >.txtE
  39+ 7A5F CD A5 7A    >    call checkOkErr
  40+ 7A62                  EspSend 'AT+CIPSTART="TCP","'
  40+ 7A62 21 6C 7A    >    ld hl, .txtB
  40+ 7A65 1E 13       >    ld e, (.txtE - .txtB)
  40+ 7A67 CD 0C 7B    >    call espSend
  40+ 7A6A 18 13       >    jr .txtE
  40+ 7A6C             >.txtB
  40+ 7A6C 41 54 2B 43 >    db 'AT+CIPSTART="TCP","'
  40+ 7A70 49 50 53 54 >
  40+ 7A74 41 52 54 3D >
  40+ 7A78 22 54 43 50 >
  40+ 7A7C 22 2C 22    >
  40+ 7A7F             >.txtE
  41+ 7A7F E1               pop hl
  42+ 7A80 CD 15 7B         call espSendT
  43+ 7A83                  EspSend '",'
  43+ 7A83 21 8D 7A    >    ld hl, .txtB
  43+ 7A86 1E 02       >    ld e, (.txtE - .txtB)
  43+ 7A88 CD 0C 7B    >    call espSend
  43+ 7A8B 18 02       >    jr .txtE
  43+ 7A8D             >.txtB
  43+ 7A8D 22 2C       >    db '",'
  43+ 7A8F             >.txtE
  44+ 7A8F E1               pop hl
  45+ 7A90 CD 15 7B         call espSendT
  46+ 7A93 3E 0D            ld a, 13
  46+ 7A95 CD 4C 79       call Uart.write
  47+ 7A98 3E 0A            ld a, 10
  47+ 7A9A CD 4C 79       call Uart.write
  48+ 7A9D AF               xor a
  48+ 7A9E 32 61 79       ld (closed), a
  49+ 7AA1 C3 A5 7A         jp checkOkErr
  50+ 7AA4
  51+ 7AA4              continue:
  52+ 7AA4 C9               ret
  53+ 7AA5                  ENDIF
  54+ 7AA5
  55+ 7AA5
  56+ 7AA5
  57+ 7AA5              checkOkErr:
  58+ 7AA5 CD 33 79         call Uart.read
  59+ 7AA8 FE 4F            cp 'O'
  59+ 7AAA 28 0A          jr z, .okStart ; OK
  60+ 7AAC FE 45            cp 'E'
  60+ 7AAE 28 19          jr z, .errStart ; ERROR
  61+ 7AB0 FE 46            cp 'F'
  61+ 7AB2 28 36          jr z, .failStart ; FAIL
  62+ 7AB4 18 EF            jr checkOkErr
  63+ 7AB6              .okStart
  64+ 7AB6 CD 33 79         call Uart.read
  64+ 7AB9 FE 4B          cp 'K'
  64+ 7ABB 20 E8          jr nz, checkOkErr
  65+ 7ABD CD 33 79         call Uart.read
  65+ 7AC0 FE 0D          cp 13
  65+ 7AC2 20 E1          jr nz, checkOkErr
  66+ 7AC4 CD 04 7B         call .flushToLF
  67+ 7AC7 B7               or a
  68+ 7AC8 C9               ret
  69+ 7AC9              .errStart
  70+ 7AC9 CD 33 79         call Uart.read
  70+ 7ACC FE 52          cp 'R'
  70+ 7ACE 20 D5          jr nz, checkOkErr
  71+ 7AD0 CD 33 79         call Uart.read
  71+ 7AD3 FE 52          cp 'R'
  71+ 7AD5 20 CE          jr nz, checkOkErr
  72+ 7AD7 CD 33 79         call Uart.read
  72+ 7ADA FE 4F          cp 'O'
  72+ 7ADC 20 C7          jr nz, checkOkErr
  73+ 7ADE CD 33 79         call Uart.read
  73+ 7AE1 FE 52          cp 'R'
  73+ 7AE3 20 C0          jr nz, checkOkErr
  74+ 7AE5 CD 04 7B         call .flushToLF
  75+ 7AE8 37               scf
  76+ 7AE9 C9               ret
  77+ 7AEA              .failStart
  78+ 7AEA CD 33 79         call Uart.read
  78+ 7AED FE 41          cp 'A'
  78+ 7AEF 20 B4          jr nz, checkOkErr
  79+ 7AF1 CD 33 79         call Uart.read
  79+ 7AF4 FE 49          cp 'I'
  79+ 7AF6 20 AD          jr nz, checkOkErr
  80+ 7AF8 CD 33 79         call Uart.read
  80+ 7AFB FE 4C          cp 'L'
  80+ 7AFD 20 A6          jr nz, checkOkErr
  81+ 7AFF CD 04 7B         call .flushToLF
  82+ 7B02 37               scf
  83+ 7B03 C9               ret
  84+ 7B04              .flushToLF
  85+ 7B04 CD 33 79         call Uart.read
  86+ 7B07 FE 0A            cp 10
  86+ 7B09 20 F9          jr nz, .flushToLF
  87+ 7B0B C9               ret
  88+ 7B0C
  89+ 7B0C              ; Send buffer to UART
  90+ 7B0C              ; HL - buff
  91+ 7B0C              ; E - count
  92+ 7B0C              espSend:
  93+ 7B0C 7E               ld a, (hl)
  93+ 7B0D CD 4C 79       call Uart.write
  94+ 7B10 23               inc hl
  95+ 7B11 1D               dec e
  96+ 7B12 20 F8            jr nz, espSend
  97+ 7B14 C9               ret
  98+ 7B15
  99+ 7B15              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 100+ 7B15              espSendT:
 101+ 7B15 7E               ld a, (hl)
 102+ 7B16
 103+ 7B16 A7               and a
 103+ 7B17 C8             ret z
 104+ 7B18 FE 09            cp 9
 104+ 7B1A C8             ret z
 105+ 7B1B FE 0D            cp 13
 105+ 7B1D C8             ret z
 106+ 7B1E FE 0A            cp 10
 106+ 7B20 C8             ret z
 107+ 7B21
 108+ 7B21 CD 4C 79         call Uart.write
 109+ 7B24 23               inc hl
 110+ 7B25 18 EE            jr espSendT
 111+ 7B27
 112+ 7B27              ; ; HL - stringZ to send
 113+ 7B27              ; ; Adds CR LF
 114+ 7B27              ; tcpSendZ:
 115+ 7B27                  ; push hl
 116+ 7B27                  ; EspSend "AT+CIPSEND="
 117+ 7B27                  ; pop de : push de
 118+ 7B27                  ; call strLen
 119+ 7B27                  ; inc hl : inc hl ; +CRLF
 120+ 7B27                  ; call hlToNumEsp
 121+ 7B27                  ; ld a, 13 : call Uart.write
 122+ 7B27                  ; ld a, 10 : call Uart.write
 123+ 7B27                  ; call checkOkErr : ret c
 124+ 7B27              ; .wait
 125+ 7B27                  ; call Uart.read : cp '>' : jr nz, .wait
 126+ 7B27                  ; pop hl
 127+ 7B27              ; .loop
 128+ 7B27                  ; ld a, (hl) : and a : jr z, .exit
 129+ 7B27                  ; call Uart.write
 130+ 7B27                  ; inc hl
 131+ 7B27                  ; jp .loop
 132+ 7B27              ; .exit
 133+ 7B27                  ; ld a, 13 : call Uart.write
 134+ 7B27                  ; ld a, 10 : call Uart.write
 135+ 7B27                  ; jp checkOkErr
 136+ 7B27
 137+ 7B27              getPacket:
 138+ 7B27 CD 33 79         call Uart.read
 139+ 7B2A              	;jp nc,getPacket_ex
 140+ 7B2A FE 2B            cp '+'
 140+ 7B2C 28 28          jr z, .ipdBegun    ; "+IPD," packet
 141+ 7B2E FE 4F            cp 'O'
 141+ 7B30 28 02          jr z, .closedBegun ; It enough to check "OSED\n" :-)
 142+ 7B32 18 F3            jr getPacket
 143+ 7B34              .closedBegun
 144+ 7B34 CD 33 79         call Uart.read
 144+ 7B37 FE 53          cp 'S'
 144+ 7B39 20 EC          jr nz, getPacket
 145+ 7B3B CD 33 79         call Uart.read
 145+ 7B3E FE 45          cp 'E'
 145+ 7B40 20 E5          jr nz, getPacket
 146+ 7B42 CD 33 79         call Uart.read
 146+ 7B45 FE 44          cp 'D'
 146+ 7B47 20 DE          jr nz, getPacket
 147+ 7B49 CD 33 79         call Uart.read
 147+ 7B4C FE 0D          cp 13
 147+ 7B4E 20 D7          jr nz, getPacket
 148+ 7B50 3E 01 32 61      ld a, 1, (closed), a
 148+ 7B54 79
 149+ 7B55 C9               ret
 150+ 7B56              .ipdBegun
 151+ 7B56 CD 33 79         call Uart.read
 151+ 7B59 FE 49          cp 'I'
 151+ 7B5B 20 CA          jr nz, getPacket
 152+ 7B5D CD 33 79         call Uart.read
 152+ 7B60 FE 50          cp 'P'
 152+ 7B62 20 C3          jr nz, getPacket
 153+ 7B64 CD 33 79         call Uart.read
 153+ 7B67 FE 44          cp 'D'
 153+ 7B69 20 BC          jr nz, getPacket
 154+ 7B6B CD 33 79         call Uart.read ; Comma
 155+ 7B6E CD 9B 7B         call .count_ipd_lenght
 155+ 7B71 22 5D 79       ld (bytes_avail), hl
 156+ 7B74 44 4D            ld bc, hl
 157+ 7B76 2A 5F 79         ld hl, (buffer_pointer)
 158+ 7B79              .readp
 159+ 7B79 7C               ld a, h
 159+ 7B7A FE FF          cp #ff
 159+ 7B7C 30 12          jr nc, .skipbuff
 160+ 7B7E C5 E5            push bc, hl
 161+ 7B80 CD 33 79         call Uart.read
 162+ 7B83 E1 C1            pop hl, bc
 163+ 7B85 77               ld (hl), a
 164+ 7B86 0B               dec bc
 164+ 7B87 23             inc hl
 165+ 7B88 78               ld a, b
 165+ 7B89 B1             or c
 165+ 7B8A 20 ED          jr nz, .readp
 166+ 7B8C 22 5F 79         ld (buffer_pointer), hl
 167+ 7B8F C9               ret
 168+ 7B90              .skipbuff
 169+ 7B90 C5               push bc
 170+ 7B91 CD 33 79         call Uart.read
 171+ 7B94 C1               pop bc
 172+ 7B95 0B               dec bc
 172+ 7B96 78             ld a, b
 172+ 7B97 B1             or c
 172+ 7B98 20 F6          jr nz, .skipbuff
 173+ 7B9A C9               ret
 174+ 7B9B              .count_ipd_lenght
 175+ 7B9B 21 00 00     		ld hl,0			; count lenght
 176+ 7B9E E5           .cil1	push  hl
 177+ 7B9F CD 33 79             call Uart.read
 178+ 7BA2 E1                   pop hl
 179+ 7BA3 FE 3A        		cp ':'
 179+ 7BA5 C8             ret z
 180+ 7BA6 D6 30        		sub 0x30
 180+ 7BA8 4D             ld c,l
 180+ 7BA9 44             ld b,h
 180+ 7BAA 29             add hl,hl
 180+ 7BAB 29             add hl,hl
 180+ 7BAC 09             add hl,bc
 180+ 7BAD 29             add hl,hl
 180+ 7BAE 4F             ld c,a
 180+ 7BAF 06 00          ld b,0
 180+ 7BB1 09             add hl,bc
 181+ 7BB2 18 EA        		jr .cil1
 182+ 7BB4
 183+ 7BB4              ; getPacket_ex
 184+ 7BB4              	; scf ;error
 185+ 7BB4              	; ret
 186+ 7BB4
 187+ 7BB4
 188+ 7BB4              ; HL - string to send
 189+ 7BB4              ; DE - lenght
 190+ 7BB4              ; Adds CR LF
 191+ 7BB4              tcpSend:
 192+ 7BB4 E5               push hl
 193+ 7BB5 D5           	push de ;
 194+ 7BB6                  EspSend "AT+CIPSEND=" ;
 194+ 7BB6 21 C0 7B    >    ld hl, .txtB
 194+ 7BB9 1E 0B       >    ld e, (.txtE - .txtB)
 194+ 7BBB CD 0C 7B    >    call espSend
 194+ 7BBE 18 0B       >    jr .txtE
 194+ 7BC0             >.txtB
 194+ 7BC0 41 54 2B 43 >    db "AT+CIPSEND="
 194+ 7BC4 49 50 53 45 >
 194+ 7BC8 4E 44 3D    >
 194+ 7BCB             >.txtE
 195+ 7BCB E1               pop hl
 195+ 7BCC E5             push hl ;длина
 196+ 7BCD                  ;call strLen
 197+ 7BCD                  ;inc hl : inc hl ; +CRLF
 198+ 7BCD CD 03 7C         call hlToNumEsp
 199+ 7BD0 3E 0D            ld a, 13
 199+ 7BD2 CD 4C 79       call Uart.write
 200+ 7BD5 3E 0A            ld a, 10
 200+ 7BD7 CD 4C 79       call Uart.write
 201+ 7BDA CD A5 7A         call checkOkErr
 201+ 7BDD 38 21          jr c,.exit_err2
 202+ 7BDF              .wait2
 203+ 7BDF CD 33 79         call Uart.read
 203+ 7BE2 FE 3E          cp '>'
 203+ 7BE4 20 F9          jr nz, .wait2
 204+ 7BE6 D1           	pop de ;длина
 205+ 7BE7 E1               pop hl
 206+ 7BE8              .loop2
 207+ 7BE8 7E               ld a, (hl)
 208+ 7BE9 CD 4C 79         call Uart.write
 209+ 7BEC 23               inc hl
 210+ 7BED 1B           	dec de
 211+ 7BEE 7A           	ld a,d
 212+ 7BEF B3           	or e
 213+ 7BF0 C2 E8 7B         jp nz, .loop2
 214+ 7BF3              .exit2
 215+ 7BF3 3E 0D            ld a, 13
 215+ 7BF5 CD 4C 79       call Uart.write
 216+ 7BF8 3E 0A            ld a, 10
 216+ 7BFA CD 4C 79       call Uart.write
 217+ 7BFD C3 A5 7A         jp checkOkErr
 218+ 7C00              .exit_err2
 219+ 7C00 D1           	pop de
 220+ 7C01 E1           	pop hl
 221+ 7C02 C9           	ret
 222+ 7C03
 223+ 7C03
 224+ 7C03
 225+ 7C03
 226+ 7C03
 227+ 7C03              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 228+ 7C03              ; HL - number
 229+ 7C03              ; It will be written to UART
 230+ 7C03              hlToNumEsp:
 231+ 7C03 01 F0 D8     	ld	bc,-10000
 232+ 7C06 CD 1C 7C     	call	.n1
 233+ 7C09 01 18 FC     	ld	bc,-1000
 234+ 7C0C CD 1C 7C     	call	.n1
 235+ 7C0F 01 9C FF     	ld	bc,-100
 236+ 7C12 CD 1C 7C     	call	.n1
 237+ 7C15 0E F6        	ld	c,-10
 238+ 7C17 CD 1C 7C     	call	.n1
 239+ 7C1A 0E FF        	ld	c,-1
 240+ 7C1C 3E 2F        .n1	ld	a,'0'-1
 241+ 7C1E 3C           .n2	inc	a
 242+ 7C1F 09           	add	hl,bc
 243+ 7C20 38 FC        	jr	c, .n2
 244+ 7C22 ED 42        	sbc	hl,bc
 245+ 7C24 C5               push bc
 246+ 7C25 CD 4C 79     	call Uart.write
 247+ 7C28 C1               pop bc
 248+ 7C29 C9               ret
 249+ 7C2A
 250+ 7C2A                  ENDMODULE
# file closed: drivers/wifi.asm
3919  7C2A              		include "at_command.asm"
# file opened: at_command.asm
   1+ 7C2A              ; cmd_uart
   2+ 7C2A              	; db "AT+UART_DEF=115200,8,1,0,3",13,10
   3+ 7C2A              ; cmd_uart_end
   4+ 7C2A
   5+ 7C2A              ; cmd_cwmode
   6+ 7C2A              	; db "AT+CWMODE=1",13,10
   7+ 7C2A              ; cmd_cwmode_end
   8+ 7C2A
   9+ 7C2A              ; cmd_cwjap
  10+ 7C2A              	; db "AT+CWJAP_DEF=\"\",\"\"",13,10
  11+ 7C2A              ; cmd_cwjap_end
  12+ 7C2A
  13+ 7C2A              ; cmd_savetrans_1
  14+ 7C2A              	; db "AT+SAVETRANSLINK=1,\"PC5\",8888,\"UDP\"",13,10
  15+ 7C2A              ; cmd_savetrans_1_end
  16+ 7C2A
  17+ 7C2A              ; cmd_savetrans_0
  18+ 7C2A              	; db "AT+SAVETRANSLINK=0",13,10
  19+ 7C2A              ; cmd_savetrans_0_end
  20+ 7C2A
  21+ 7C2A              cmd_rst
  22+ 7C2A 41 54 2B 52  	db "AT+RST",13,10
  22+ 7C2E 53 54 0D 0A
  23+ 7C32              cmd_rst_end
  24+ 7C32
  25+ 7C32              cmd_brk
  26+ 7C32 2B 2B 2B     	db "+++"
  27+ 7C35              cmd_brk_end
  28+ 7C35
  29+ 7C35              ; cmd_ipstart db 'AT+CIPSTART="TCP","' ;    
  30+ 7C35              ; cmd_ipstart_e
  31+ 7C35
  32+ 7C35
  33+ 7C35              ; cmd_ipclose db "AT+CIPCLOSE",13,10
  34+ 7C35              ; cmd_ipclose_e
  35+ 7C35
  36+ 7C35              ; cmd_ipsend_34 db "AT+CIPSEND=34",13,10
  37+ 7C35              ; cmd_ipsend_34_e
  38+ 7C35
  39+ 7C35              ; cmd_ipsend_1058 db "AT+CIPSEND=1058",13,10
  40+ 7C35              ; cmd_ipsend_1058_e
  41+ 7C35
  42+ 7C35              ; cmd_ipsend_290 db "AT+CIPSEND=290",13,10
  43+ 7C35              ; cmd_ipsend_290_e
  44+ 7C35
  45+ 7C35              ; pack_id db "+IPD," ;   
  46+ 7C35              ; pack_id_e
  47+ 7C35
  48+ 7C35              ; -
  49+ 7C35              			; ld hl,trn_buf ;
  50+ 7C35              			; ld de,pack_size_32_com ;
  51+ 7C35              			; call Wifi.tcpSend ;
  52+ 7C35              			; jr c, ; ,   
  53+ 7C35
  54+ 7C35              			; ld hl,rec_buf ;
  55+ 7C35              			; ld (Wifi.buffer_pointer),hl
  56+ 7C35              			; call Wifi.getPacket ;
  57+ 7C35              			; jr c, ; ,   
  58+ 7C35
# file closed: at_command.asm
3920  7C35
3921  7C35
3922  7C35
3923  7C35              	; ;org #6450 ;обработчик прерывания
3924  7C35              ; interrupt
3925  7C35              	; ; push af
3926  7C35              	; ; push bc
3927  7C35              	; ; push de
3928  7C35              	; push hl
3929  7C35              	; ; exx
3930  7C35              	; ; ex af,af'
3931  7C35              	; ; push af
3932  7C35              	; ; push bc
3933  7C35              	; ; push de
3934  7C35              	; ; push hl
3935  7C35              	; ; push ix
3936  7C35              	; ; push iy
3937  7C35              	; ; call #6500
3938  7C35              	; ld hl,frame
3939  7C35              	; inc (hl)
3940  7C35              	; ; pop iy
3941  7C35              	; ; pop ix
3942  7C35              	; ; pop hl
3943  7C35              	; ; pop de
3944  7C35              	; ; pop bc
3945  7C35              	; ; pop af
3946  7C35              	; ; ex af,af'
3947  7C35              	; ; exx
3948  7C35              	; pop hl
3949  7C35              	; ; pop de
3950  7C35              	; ; pop bc
3951  7C35              	; ; pop af
3952  7C35              	; rst #38 ;вместо прерывания im 1
3953  7C35              	; ei
3954  7C35              	; ret
3955  7C35              ; frame dw 0
3956  7C35              		; align 256
3957  7C35              ; interrupt_vec equ $-1 ;указатель на обработчик прерываний
3958  7C35              	; dw 0
3959  7C35
3960  7C35
3961  7C35              read_cfg ;прочитать файл конфигурации
3962  7C35 21 3B 76     	ld hl,file_cfg_name
3963  7C38 0E 13        	ld      c,#13 ;move file info to syst var
3964  7C3A CD 13 3D         call    #3d13
3965  7C3D 79           	ld      a,c
3966  7C3E FE FF        	cp 		#ff
3967  7C40 28 71        	jr 		z,read_cfg_err
3968  7C42 0E 0A            ld      c,#0a ;find file
3969  7C44 CD 13 3D         call    #3d13
3970  7C47 79               ld      a,c
3971  7C48 FE FF        	cp 		#ff
3972  7C4A 28 67        	jr 		z,read_cfg_err ;если не нашли файла
3973  7C4C 0E 08            ld      c,#08 ;read file title
3974  7C4E CD 13 3D         call    #3d13
3975  7C51 79           	ld      a,c
3976  7C52 FE FF        	cp 		#ff
3977  7C54 28 5D        	jr 		z,read_cfg_err
3978  7C56 21 6A BD         ld      hl,file_cfg_name_buf ;куда
3979  7C59 ED 5B EB 5C      ld      de,(#5ceb) ;начало файла сектор дорожка
3980  7C5D 01 05 01         ld      bc,#0105 ;считать один сектор
3981  7C60 CD 13 3D         call    #3d13
3982  7C63 79           	ld      a,c
3983  7C64 FE FF        	cp 		#ff
3984  7C66 28 4B        	jr 		z,read_cfg_err
3985  7C68
3986  7C68              	;распознать файл настроек
3987  7C68 21 6A BD     	ld  hl,file_cfg_name_buf ;откуда
3988  7C6B 11 50 76     	ld 	de,server_name ;куда
3989  7C6E 01 FF 0F     	ld bc,#0fff ;максимум имя сервера 15 символов
3990  7C71              read_cfg_cl
3991  7C71 7E           	ld a,(hl)
3992  7C72 FE 20        	cp " "
3993  7C74 38 04        	jr c,read_cfg_cl_skip
3994  7C76              	;тут нашли имя сервера
3995  7C76 ED A0        	ldi
3996  7C78 10 F7        	djnz read_cfg_cl
3997  7C7A
3998  7C7A
3999  7C7A              read_cfg_cl_skip
4000  7C7A              	;пропустить конец строки
4001  7C7A 01 FF 0F     	ld bc,#0fff ;максимум имя сервера15 символов
4002  7C7D              read_cfg_cl1
4003  7C7D 7E           	ld a,(hl)
4004  7C7E FE 20        	cp " "
4005  7C80 30 03        	jr nc,read_cfg_cl_skip2
4006  7C82              	;тут нашли имя сервера
4007  7C82 23           	inc hl
4008  7C83 10 F8        	djnz read_cfg_cl1
4009  7C85
4010  7C85              read_cfg_cl_skip2
4011  7C85              	;порт
4012  7C85 11 69 76     	ld 	de,server_port ;куда
4013  7C88 01 FF 04     	ld bc,#04ff ;максимум длина порта 4
4014  7C8B              	;ld ixl,0 ;счётчик
4015  7C8B              read_cfg_cl2
4016  7C8B 7E           	ld a,(hl)
4017  7C8C FE 20        	cp " "
4018  7C8E 38 04        	jr c,read_cfg_cl_skip3
4019  7C90 ED A0        	ldi
4020  7C92 10 F7        	djnz read_cfg_cl2
4021  7C94
4022  7C94              read_cfg_cl_skip3
4023  7C94              	;настройки определения HDD
4024  7C94              ;пропустить конец строки
4025  7C94 01 FF 05     	ld bc,#05ff ;максимум 5
4026  7C97              read_cfg_cl3
4027  7C97 7E           	ld a,(hl)
4028  7C98 FE 20        	cp " "
4029  7C9A 30 03        	jr nc,read_cfg_cl_skip4
4030  7C9C              	;тут нашли имя сервера
4031  7C9C 23           	inc hl
4032  7C9D 10 F8        	djnz read_cfg_cl3
4033  7C9F
4034  7C9F              read_cfg_cl_skip4
4035  7C9F 01 FF 08     	ld bc,#08ff ;максимум 8
4036  7CA2 1E 00        	ld e,0
4037  7CA4              read_cfg_cl4
4038  7CA4 7E           	ld a,(hl)
4039  7CA5 D6 30        	sub "0"
4040  7CA7 CB 1F        	rr a
4041  7CA9 CB 13        	rl e
4042  7CAB 23           	inc hl
4043  7CAC 10 F6        	djnz read_cfg_cl4
4044  7CAE 7B           	ld a,e
4045  7CAF 32 5F 98     	ld (cng_19+1),a
4046  7CB2
4047  7CB2 C9           	ret
4048  7CB3
4049  7CB3
4050  7CB3              read_cfg_err
4051  7CB3 21 38 76     	ld hl,mes_read_cfg_err
4052  7CB6 CD E9 76     	call print_sys
4053  7CB9 C9           	ret
4054  7CBA
4055  7CBA
4056  7CBA              init_hdd ;
4057  7CBA              ;инициализация файловой системы FAT
4058  7CBA              	;xor a
4059  7CBA CD 51 98     	call navGetNumDrives ;узнаем какая буква последняя, сколько разделов FAT
4060  7CBD FD 21 3A 5C  	ld	iy,#5C3A
4061  7CC1 FE 05        	cp 5 ;если только дисководы
4062  7CC3 30 0A        	jr nc,init_fs_fat_prn2
4063  7CC5              init_hdd_err
4064  7CC5 21 24 76     	ld hl,mes_fat_not_found
4065  7CC8 CD 09 77     	call print
4066  7CCB CD E8 7D     	call wait_key
4067  7CCE              	;scf ;ошибка
4068  7CCE C9           	ret
4069  7CCF
4070  7CCF
4071  7CCF              init_fs_fat_prn2
4072  7CCF              	;печать букв дисководов
4073  7CCF 3A 1D 73     	ld a,(cur_drive)
4074  7CD2 C6 41        	add a,"A"
4075  7CD4 32 10 76     	ld (mes_curent_drive_letter),a
4076  7CD7 21 05 76     	ld hl,mes_curent_drive ;
4077  7CDA CD 09 77     	call print
4078  7CDD 21 13 76     	ld hl,mes_fdd ;
4079  7CE0 CD 09 77     	call print
4080  7CE3              	;печать списка разделов
4081  7CE3 21 20 76     	ld hl,mes_fat_found
4082  7CE6 CD 09 77     	call print
4083  7CE9 21 4C 99     	ld hl,typeDrive
4084  7CEC 3A 6C 99     	ld a,(numDrives)
4085  7CEF FE 05        	cp 5
4086  7CF1 38 4D        	jr c,init_fs_select_
4087  7CF3 D6 04        	sub 4 ;убрать дисководы
4088  7CF5 47           	ld b,a ;цикл по количеству разделов
4089  7CF6 0E 45        	ld c,"E" ;первая буква диска FAT
4090  7CF8              init_fs_fat_prn1
4091  7CF8 C5           	push bc
4092  7CF9 E5           	push hl
4093  7CFA 79           	ld a,c ;имя диска
4094  7CFB CD 7B 77     	call prsym
4095  7CFE 3E 3A        	ld a,":" ;
4096  7D00 CD 7B 77     	call prsym
4097  7D03              	;тип S или H
4098  7D03 3E 48        	ld a,"H"
4099  7D05 E1           	pop hl
4100  7D06 E5           	push hl
4101  7D07 CB 6E        	bit 5,(hl) ;SD?
4102  7D09 28 06        	jr z,init_fs_fat_prn3
4103  7D0B CB 66        	bit 4,(hl) ;SD?
4104  7D0D 28 02        	jr z,init_fs_fat_prn3
4105  7D0F 3E 53        	ld a,"S"
4106  7D11              init_fs_fat_prn3
4107  7D11
4108  7D11 CD 7B 77     	call prsym ;первая буква
4109  7D14 3E 44        	ld a,"D"
4110  7D16 CD 7B 77     	call prsym ;вторая буква
4111  7D19              	;номер диска
4112  7D19 E1           	pop hl
4113  7D1A E5           	push hl
4114  7D1B 7E           	ld a,(hl)
4115  7D1C E6 04        	and %00000100
4116  7D1E 0F           	rrca
4117  7D1F 0F           	rrca
4118  7D20 C6 30        	add "0"
4119  7D22 CD 7B 77     	call prsym ;номер диска
4120  7D25              	;номер раздела
4121  7D25 3E 2C        	ld a,","
4122  7D27 CD 7B 77     	call prsym ;разделитель
4123  7D2A E1           	pop hl
4124  7D2B E5           	push hl
4125  7D2C 7E           	ld a,(hl)
4126  7D2D E6 03        	and %00000011
4127  7D2F C6 30        	add "0"
4128  7D31 CD 7B 77     	call prsym ;номер раздела
4129  7D34 21 36 76     	ld hl,mes_next_line ;новая строка
4130  7D37 CD 09 77     	call print
4131  7D3A E1           	pop hl
4132  7D3B 23           	inc hl
4133  7D3C C1           	pop bc
4134  7D3D 0C           	inc c
4135  7D3E 10 B8        	djnz init_fs_fat_prn1
4136  7D40
4137  7D40              	;ждём выбора буквы
4138  7D40              init_fs_select_
4139  7D40 3A 6C 99     	ld a,(numDrives)
4140  7D43 C6 41        	add "A"
4141  7D45 32 E7 7D     	ld (numDrives_last),a ;последняя свободная буква
4142  7D48 21 E7 7D     	ld hl,numDrives_last
4143  7D4B              init_fs_select
4144  7D4B CD C4 60     	call input_key
4145  7D4E FE 41        	cp "A"
4146  7D50 38 F9        	jr c,init_fs_select ;не в диапазоне
4147  7D52
4148  7D52 BE           	cp (hl)
4149  7D53 30 F6        	jr nc,init_fs_select ;не в диапазоне
4150  7D55
4151  7D55 D6 41        	sub "A"
4152  7D57 32 1D 73     	ld (cur_drive),a ;сменить текущий диск
4153  7D5A
4154  7D5A              	;ld a,(cur_drive)
4155  7D5A D6 04        	sub 4
4156  7D5C 4F           	ld c,a
4157  7D5D 06 00        	ld b,0
4158  7D5F 21 4C 99     	ld hl,typeDrive
4159  7D62 09           	add hl,bc
4160  7D63              	;инициализация
4161  7D63 7E           	ld a,(hl) ;выбранный раздел
4162  7D64 CD A4 AD     	call DrvFAT.InitFAT32
4163  7D67 DC 0F 83     	call c,print_hdd_error
4164  7D6A
4165  7D6A              	;в корневой каталог
4166  7D6A CD 93 AE     	call DrvFAT.setRootDir
4167  7D6D DC 0F 83     	call c,print_hdd_error
4168  7D70
4169  7D70              	;подсчет количества легинтимных (первых 256) записей в текущем каталоге
4170  7D70              	;call DrvFAT.GetNumOfEntries
4171  7D70 C9           	ret
4172  7D71
4173  7D71
4174  7D71
4175  7D71              readcat_fat
4176  7D71 CD F1 7D     	call cat_cls ;почистить место
4177  7D74 AF           	xor a
4178  7D75 32 28 73     	ld (files_l),a
4179  7D78 21 80 D0     	ld hl,cat_l
4180  7D7B 22 E5 7D     	ld (cat_target_tmp),hl ;указатель на начало
4181  7D7E              	;прочитать сектор каталога
4182  7D7E 01 00 00     	ld bc,0 ;первый сектор
4183  7D81 1E 0F        	ld e,cat_size_max/512 ;максимум секторов влезет в буфер
4184  7D83              readcat_fat_cl
4185  7D83 D5           	push de
4186  7D84 CD AD A8     	call DrvFAT.ReadSectorDIR
4187  7D87 D1           	pop de
4188  7D88 DC 0F 83     	call c,print_hdd_error
4189  7D8B 38 57        	jr c,init_fs_ex
4190  7D8D
4191  7D8D
4192  7D8D E5           	push hl
4193  7D8E DD E1        	pop ix ;уазатель на запись о файле
4194  7D90              	;перенести 1 сектор в каталог, кроме лишних записей
4195  7D90 C5           	push bc
4196  7D91 06 10        	ld b,16 ;цикл записей в секторе
4197  7D93              readcat_fat_cl_one
4198  7D93 C5           	push bc
4199  7D94 DD 7E 00     	ld a,(ix)
4200  7D97 B7           	or a ;конец каталога
4201  7D98 28 38        	jr z,readcat_fat_cl_skip
4202  7D9A FE E5        	cp #e5 ;удалённый
4203  7D9C 28 34        	jr z,readcat_fat_cl_skip
4204  7D9E FE 05        	cp #05 ;удалённый
4205  7DA0 28 30        	jr z,readcat_fat_cl_skip
4206  7DA2 DD 7E 0B     	ld a,(ix+#0b)
4207  7DA5 FE 0F        	cp #0f ;длинный
4208  7DA7 28 29        	jr z,readcat_fat_cl_skip
4209  7DA9 FE 08        	cp #08 ;метка тома
4210  7DAB 28 25        	jr z,readcat_fat_cl_skip
4211  7DAD              	;проверка на папку "." (этот же каталог)
4212  7DAD DD 7E 00     	ld a,(ix+#00)
4213  7DB0 FE 2E        	cp "." ;
4214  7DB2 20 07        	jr nz,readcat_fat__add
4215  7DB4 DD 7E 01     	ld a,(ix+#01)
4216  7DB7 FE 20        	cp " " ;
4217  7DB9 28 17        	jr z,readcat_fat_cl_skip
4218  7DBB              readcat_fat__add
4219  7DBB              	;перенести одну запись
4220  7DBB DD E5        	push ix
4221  7DBD E1           	pop hl
4222  7DBE ED 5B E5 7D  	ld de,(cat_target_tmp)
4223  7DC2 01 20 00     	ld bc,32
4224  7DC5 ED B0        	ldir
4225  7DC7 ED 53 E5 7D  	ld (cat_target_tmp),de
4226  7DCB 3A 28 73     	ld a,(files_l)
4227  7DCE 3C           	inc a
4228  7DCF 32 28 73     	ld (files_l),a
4229  7DD2
4230  7DD2              readcat_fat_cl_skip
4231  7DD2
4232  7DD2 01 20 00     	ld bc,32 ;на следующую запись
4233  7DD5 DD 09        	add ix,bc
4234  7DD7 C1           	pop bc
4235  7DD8 10 B9        	djnz readcat_fat_cl_one
4236  7DDA C1           	pop bc
4237  7DDB              	;
4238  7DDB
4239  7DDB
4240  7DDB
4241  7DDB 21 10 00     	ld hl,16 ;на следующий сектор (512/32)
4242  7DDE 09           	add hl,bc
4243  7DDF 44           	ld b,h
4244  7DE0 4D           	ld c,l
4245  7DE1 1D           	dec e
4246  7DE2 20 9F        	jr nz,readcat_fat_cl
4247  7DE4
4248  7DE4
4249  7DE4              init_fs_ex
4250  7DE4              	; ld a,(cur_drive)
4251  7DE4              	; or a
4252  7DE4 C9           	ret
4253  7DE5 00 00        cat_target_tmp dw 0 ;временно
4254  7DE7 00           numDrives_last db 0 ;временно
4255  7DE8
4256  7DE8              wait_key ;ждёт любой клавиши
4257  7DE8 76           	halt
4258  7DE9 3A 04 5C     	ld a,(23556)
4259  7DEC FE FF        	cp 255
4260  7DEE 28 F8        	jr z,wait_key
4261  7DF0 C9           	ret
4262  7DF1
4263  7DF1
4264  7DF1              cat_cls ;очистить каталог слева
4265  7DF1 21 80 D0     	ld hl,cat_l
4266  7DF4 11 81 D0     	ld de,cat_l+1
4267  7DF7 01 FF 1D     	ld bc,cat_l_end-cat_l-1
4268  7DFA 36 00        	ld (hl),0
4269  7DFC ED B0        	ldir
4270  7DFE C9           	ret
4271  7DFF
4272  7DFF
4273  7DFF              ;печать каталога левая панель FAT
4274  7DFF              printcat_l_fat
4275  7DFF 3A 2A 73     			ld a,(panel) ;проверка надо ли скрыть курсор
4276  7E02 FE 4C        			cp "L"
4277  7E04 3E 39        			ld a,colorcatc_act
4278  7E06 28 02        			jr z,printcat_l_fat1
4279  7E08 3E 0F        			ld a,colorcat_
4280  7E0A              printcat_l_fat1
4281  7E0A 32 17 73     			ld (colorcatc_l),a
4282  7E0D
4283  7E0D 21 00 58                 ld      hl,col_pos_l ;
4284  7E10 AF                       xor		a
4285  7E11              clscat_fat_l
4286  7E11 54                       ld      d,h
4287  7E12 5D                       ld      e,l
4288  7E13 13                       inc     de
4289  7E14 4F                       ld      c,a  ;keep
4290  7E15 3A 20 73                 ld      a,(shiftcat_l)
4291  7E18 47                       ld      b,a
4292  7E19 3A 29 73                 ld      a,(curfile_l)
4293  7E1C A7                       and     a
4294  7E1D 98                       sbc     a,b
4295  7E1E B9                       cp      c
4296  7E1F 32 1B 73                 ld      (cursor_l),a ;posit
4297  7E22 3A 18 73                 ld      a,(colorcat_l)
4298  7E25 20 03                    jr      nz,clscat_fat01_l
4299  7E27 3A 17 73                 ld      a,(colorcatc_l) ;mark
4300  7E2A              clscat_fat01_l
4301  7E2A 77                       ld      (hl),a  ;раскраска атрибутами
4302  7E2B 79                       ld      a,c  ;restor
4303  7E2C 01 09 00                 ld      bc,9
4304  7E2F ED B0                    ldir
4305  7E31 01 17 00                 ld      bc,32-9
4306  7E34 09                       add     hl,bc
4307  7E35 3C                       inc     a
4308  7E36 FE 15                    cp      files_view
4309  7E38 38 D7                    jr      c,clscat_fat_l
4310  7E3A
4311  7E3A                     ;     ld      hl,catposit
4312  7E3A                     ;     call    print
4313  7E3A
4314  7E3A 3A 28 73     			ld a,(files_l)
4315  7E3D B7           			or a
4316  7E3E C8           			ret z ;выход если нет файлов
4317  7E3F
4318  7E3F 01 80 D0                 ld      bc,cat_l  ;теперь печать имён файлов
4319  7E42 3A 20 73                 ld      a,(shiftcat_l)
4320  7E45 DD 6F        			ld xl,a
4321  7E47                          ; or      a
4322  7E47                          ; jr      z,printcat00
4323  7E47 6F           			ld      l,a
4324  7E48 26 00        			ld 		h,0
4325  7E4A              ;printcat01  ;find name file
4326  7E4A 29                       add    hl,hl ;2
4327  7E4B 29           			add    hl,hl ;4
4328  7E4C 29           			add    hl,hl ;8
4329  7E4D 29           			add    hl,hl ;16
4330  7E4E 29           			add    hl,hl ;32
4331  7E4F 09           			add hl,bc
4332  7E50                          ;dec    a
4333  7E50                          ;jr    nz,printcat01
4334  7E50              ;printcat00
4335  7E50
4336  7E50 AF                       xor     a
4337  7E51              printcat_fat02_l
4338  7E51 F5                       push    af
4339  7E52 E5                       push    hl
4340  7E53                                     ;print 24 row
4341  7E53
4342  7E53 32 55 73                 ld      (catposit_l+1),a
4343  7E56 21 54 73                 ld      hl,catposit_l ;установим позицию печати
4344  7E59 CD 09 77                 call    print
4345  7E5C E1                       pop     hl
4346  7E5D E5                       push    hl
4347  7E5E CD 8B 70     			call 	format_name_fat_l ;подготовим
4348  7E61              			;отметка галкой
4349  7E61 EB           			ex de,hl
4350  7E62 21 80 CF     			ld hl,cat_mark_l
4351  7E65 DD 7D        			ld a,xl
4352  7E67 85           			add l
4353  7E68 6F           			ld l,a
4354  7E69 7E           			ld a,(hl)
4355  7E6A EB           			ex de,hl
4356  7E6B B7           			or a
4357  7E6C 28 09        			jr z,printcat_mark_fat_l
4358  7E6E E5           			push hl
4359  7E6F 3E FB        			ld a,0-5 ;знак галка
4360  7E71 01 08 00     			ld bc,8
4361  7E74 09           			add hl,bc
4362  7E75 77           			ld (hl),a
4363  7E76 E1           			pop hl
4364  7E77              printcat_mark_fat_l
4365  7E77 DD 2C        			inc xl
4366  7E79              			;
4367  7E79
4368  7E79 01 0C 00     			ld bc,12 ;длина
4369  7E7C CD F8 76                 call    print_ ;печать одного имени файла
4370  7E7F                          ;ld      hl,catspace
4371  7E7F                          ;call    print
4372  7E7F E1                       pop     hl
4373  7E80 01 20 00                 ld      bc,lenghtName*2 ;на след. имя
4374  7E83 09                       add     hl,bc
4375  7E84 F1                       pop     af
4376  7E85 3C                       inc     a
4377  7E86 ED 4B 28 73  			ld 		bc,(files_l) ;проверка сколько всего файлов
4378  7E8A B9           			cp 		c
4379  7E8B D0           			ret		nc
4380  7E8C FE 15                    cp      files_view ;проверка сколько файлов показывать
4381  7E8E 38 C1                    jr      c,printcat_fat02_l
4382  7E90 C9           			ret
4383  7E91
4384  7E91              ;открыть папку слева
4385  7E91              open_dir_l
4386  7E91 3A 25 73     			ld a,(curfile) ;текущ файл
4387  7E94 01 80 D0     			ld bc,cat_l
4388  7E97 6F           			ld l,a
4389  7E98 26 00        			ld h,0
4390  7E9A 29                       add    hl,hl ;2
4391  7E9B 29           			add    hl,hl ;4
4392  7E9C 29           			add    hl,hl ;8
4393  7E9D 29           			add    hl,hl ;16
4394  7E9E 29           			add    hl,hl ;32
4395  7E9F 09           			add hl,bc
4396  7EA0 E5           			push hl
4397  7EA1 DD E1        			pop ix ;запомним
4398  7EA3 DD 7E 0B     	ld a,(ix+#0b)
4399  7EA6 CB 67        	bit 4,a ;это папка?
4400  7EA8 CA 47 60     	jp z,wait
4401  7EAB 1E 00        	ld e,0
4402  7EAD              	;проверка на папку ".." (каталог выше)
4403  7EAD DD 7E 00     	ld a,(ix+#00)
4404  7EB0 FE 2E        	cp "." ;
4405  7EB2 20 10        	jr nz,open_dir_l1
4406  7EB4 DD 7E 01     	ld a,(ix+#01)
4407  7EB7 FE 2E        	cp "." ;
4408  7EB9 20 09        	jr nz,open_dir_l1
4409  7EBB DD 7E 02     	ld a,(ix+#02)
4410  7EBE FE 20        	cp " " ;
4411  7EC0 20 02        	jr nz,open_dir_l1
4412  7EC2 1E 80        	ld e,#80 ;7,e =1 это возврат в родительский каталог
4413  7EC4              open_dir_l1
4414  7EC4 DD 7E 0B     	ld a,(ix+#0b)
4415  7EC7 CD 06 A7     	call DrvFAT.Enter2DIR
4416  7ECA DC 0F 83     	call c,print_hdd_error
4417  7ECD CD A9 62     	call    renewcat_l
4418  7ED0 C3 47 60         jp      wait
4419  7ED3
4420  7ED3              ;повторный выбор раздела
4421  7ED3              select_hdd
4422  7ED3 CD 7D 65     	call cls_l
4423  7ED6 CD CF 7C     	call init_fs_fat_prn2
4424  7ED9              	; ld a,24 ;скрыть курсор
4425  7ED9              	; ld (curfile),a
4426  7ED9              	; xor a
4427  7ED9              	; ld (shiftcat_),a
4428  7ED9 CD A9 62     	call renewcat_l
4429  7EDC C3 47 60     	jp wait
4430  7EDF
4431  7EDF
4432  7EDF
4433  7EDF
4434  7EDF
4435  7EDF              copyF_LR_FAT	;копирование файлов слева направо FAT
4436  7EDF 3A 39 73     			ld a,(open_trd_flag)
4437  7EE2 B7           			or a
4438  7EE3 C2 47 60     			jp nz,wait ;если открыт образ справа, то нельзя
4439  7EE6
4440  7EE6
4441  7EE6              			;окно запроса с выбором диска
4442  7EE6 3A 1D 73     			ld a,(cur_drive)
4443  7EE9 C6 41        			add a,"A"
4444  7EEB 32 88 74     			ld (mes_trd_dsk+3),a
4445  7EEE 21 A5 75     			ld hl,mes_copy_file
4446  7EF1 CD 09 77     			call print
4447  7EF4 21 85 74     			ld hl,mes_trd_dsk
4448  7EF7 CD 09 77     			call print
4449  7EFA 3E 27        			ld a,col_win
4450  7EFC CD 2C 6E     			call paint_win
4451  7EFF              copyF_LR_FAT_w ;ожидание согласия
4452  7EFF 76           			halt
4453  7F00 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
4454  7F03 FE 4E        			cp 		"N"
4455  7F05 CA 61 6A     			jp z,copyF_exit ;выход если нет согласия
4456  7F08 FE 59        			cp 		"Y"
4457  7F0A 20 F3        			jr nz,copyF_LR_FAT_w
4458  7F0C
4459  7F0C              			;узнать сколько отмеченных файлов
4460  7F0C 21 80 CF     			ld hl,cat_mark_l
4461  7F0F 06 80        			ld b,128 ;размер таблицы
4462  7F11 DD 2E 00     			ld xl,0 ;счётчик
4463  7F14              copyF_LR_FAT_no_one_chk
4464  7F14 7E           			ld a,(hl)
4465  7F15 B7           			or a
4466  7F16 28 02        			jr z,copyF_LR_FAT_no_one_chk1
4467  7F18 DD 2C        			inc xl
4468  7F1A              copyF_LR_FAT_no_one_chk1
4469  7F1A 23           			inc hl
4470  7F1B 10 F7        			djnz copyF_LR_FAT_no_one_chk
4471  7F1D DD 2C        			inc xl
4472  7F1F DD 2D        			dec xl
4473  7F21 20 11        			jr nz,copyF_LR_FAT_no_one ;не один
4474  7F23 3A 25 73     			ld a,(curfile) ;тогда только текущий файл
4475  7F26 CD 82 7F     			call copyF_LR_FAT_one
4476  7F29 D2 76 7F     			jp nc,copyF_LR_fat_exit ;выход без ошибки
4477  7F2C FE FF        			cp 255
4478  7F2E CA 76 7F     			jp z,copyF_LR_fat_exit ;выход после останова
4479  7F31 C3 7C 7F     			jp copyF_LR_fat_error ;выход с ошибкой
4480  7F34
4481  7F34
4482  7F34              copyF_LR_FAT_no_one ;копировать несколько
4483  7F34 21 80 CF     			ld hl,cat_mark_l
4484  7F37 DD 7D        			ld a,xl
4485  7F39 32 53 73     			ld (cat_mark_cur_tot),a
4486  7F3C AF           			xor a
4487  7F3D              copyF_LR_FAT_no_one_cl
4488  7F3D 32 52 73     			ld (cat_mark_cur_cl),a
4489  7F40 22 50 73     			ld (cat_mark_cur),hl
4490  7F43 7E           			ld a,(hl) ;есть отметка?
4491  7F44 B7           			or a
4492  7F45 28 1E        			jr z,copyF_LR_FAT_no_one_cl1
4493  7F47 3A 53 73     			ld a,(cat_mark_cur_tot)
4494  7F4A 6F           			ld l,a
4495  7F4B 26 00        			ld h,0
4496  7F4D 3D           			dec a
4497  7F4E 32 53 73     			ld (cat_mark_cur_tot),a
4498  7F51 CD D3 71     			call print_progress_tot ;прогресс
4499  7F54 3A 52 73     			ld a,(cat_mark_cur_cl) ;очередной номер файла
4500  7F57 CD 82 7F     			call copyF_LR_FAT_one ;скопировать
4501  7F5A D2 65 7F     			jp nc,copyF_LR_FAT_no_one_cl1 ;продолжить без ошибки
4502  7F5D FE FF        			cp 255
4503  7F5F CA 76 7F     			jp z,copyF_LR_fat_exit ;выход после останова
4504  7F62 C3 7C 7F     			jp copyF_LR_fat_error ;выход с ошибкой
4505  7F65
4506  7F65              copyF_LR_FAT_no_one_cl1
4507  7F65 2A 50 73     			ld hl,(cat_mark_cur)
4508  7F68 36 00        			ld (hl),0 ;снять отметку
4509  7F6A 23           			inc hl
4510  7F6B 3A 52 73     			ld a,(cat_mark_cur_cl)
4511  7F6E 3C           			inc a
4512  7F6F FE 80        			cp 128
4513  7F71 38 CA        			jr c,copyF_LR_FAT_no_one_cl
4514  7F73
4515  7F73 C3 76 7F     			jp copyF_LR_fat_exit ;без ошибки
4516  7F76
4517  7F76              copyF_LR_fat_exit
4518  7F76 CD E1 62     	call renewcat_r
4519  7F79 C3 61 6A     	jp copyF_exit
4520  7F7C
4521  7F7C              copyF_LR_fat_error
4522  7F7C CD E1 62     	call renewcat_r
4523  7F7F C3 81 6A     	jp copyF_error
4524  7F82
4525  7F82              copyF_LR_FAT_one ;скопировать один файл слева направо
4526  7F82              			;на входе в A - номер файла
4527  7F82              			;на выходе C=1, если ошибка; A=255, если остановлено
4528  7F82
4529  7F82              			;узнать параметры файла
4530  7F82 01 80 D0     			ld bc,cat_l ;каталог диска слева
4531  7F85              			;ld a,(curfile) ;текущ файл
4532  7F85 6F           			ld l,a
4533  7F86 26 00        			ld h,0
4534  7F88 29                       add    hl,hl ;2
4535  7F89 29           			add    hl,hl ;4
4536  7F8A 29           			add    hl,hl ;8
4537  7F8B 29           			add    hl,hl ;16
4538  7F8C 29           			add    hl,hl ;32
4539  7F8D 09           			add hl,bc
4540  7F8E
4541  7F8E 22 45 73     			ld (copyF_RL_source_file),hl ;указатель на запись о файле
4542  7F91 01 1F 00     			ld bc,#1c+3
4543  7F94 09           			add hl,bc
4544  7F95 7E           			ld a,(hl) ;размер файла 4й байт
4545  7F96 FE 04        			cp 4
4546  7F98 D2 51 68     			jp nc,copyF_LR_error ;если слишком большой (больше 67108864)
4547  7F9B 4F           			ld c,a ;4й
4548  7F9C 2B           			dec hl
4549  7F9D 7E           			ld a,(hl) ;размер файла 3й байт
4550  7F9E 57           			ld d,a ;3й
4551  7F9F 2B           			dec hl
4552  7FA0 7E           			ld a,(hl) ;
4553  7FA1 5F           			ld e,a ;2й
4554  7FA2
4555  7FA2
4556  7FA2 CB 39        			srl c ;/2 на старший бит придёт 0
4557  7FA4 CB 1A        			rr d ;
4558  7FA6 CB 1B        			rr e ; на старший бит придёт флаг С
4559  7FA8 CB 39        			srl c ;/4
4560  7FAA CB 1A        			rr d ;
4561  7FAC CB 1B        			rr e
4562  7FAE
4563  7FAE 7E           			ld a,(hl) ;2й байт
4564  7FAF E6 03        			and %00000011
4565  7FB1 4F           			ld c,a
4566  7FB2 2B           			dec hl
4567  7FB3 7E           			ld a,(hl) ;1й байт
4568  7FB4 B1           			or c
4569  7FB5 28 01        			jr z,copyF_LR_FAT_one_fix
4570  7FB7 13           			inc de ;фикс
4571  7FB8              copyF_LR_FAT_one_fix
4572  7FB8
4573  7FB8              			;ld (copyF_RL_source_sec_size),de ;два байта длины в секторах по 1024
4574  7FB8
4575  7FB8              			;цикл по размеру в секторах
4576  7FB8 DD 62 DD 6B  			ld ix,de
4577  7FBC
4578  7FBC
4579  7FBC              			;начинаем копировать файл
4580  7FBC
4581  7FBC
4582  7FBC 2A 45 73     			ld hl,(copyF_RL_source_file) ;указатель
4583  7FBF CD D5 82     			call format_name_fat_dot
4584  7FC2 11 48 B4     			ld de,trn_buf+16 ;перекинем имя файла в запрос
4585  7FC5 01 0C 00     			ld bc,file_name_len
4586  7FC8 ED B0        			ldir
4587  7FCA 3E 04        			ld a,4 ;Тип пакета Запрос на передачу файла 1024 байт
4588  7FCC 32 3B B4     			ld (trn_buf+3),a
4589  7FCF
4590  7FCF 21 00 00     			ld hl,0
4591  7FD2 22 3C B4     			ld (trn_buf+4),hl ;с нулевой части
4592  7FD5
4593  7FD5              			;размер файла
4594  7FD5 2A 45 73     			ld hl,(copyF_RL_source_file) ;указатель
4595  7FD8 01 1C 00     			ld bc,#1c
4596  7FDB 09           			add hl,bc
4597  7FDC 7E           			ld a,(hl)
4598  7FDD 32 44 B4     			ld (trn_buf+12),a
4599  7FE0 23           			inc hl
4600  7FE1 7E           			ld a,(hl)
4601  7FE2 32 45 B4     			ld (trn_buf+13),a
4602  7FE5 23           			inc hl
4603  7FE6 7E           			ld a,(hl)
4604  7FE7 32 46 B4     			ld (trn_buf+14),a
4605  7FEA 23           			inc hl
4606  7FEB 7E           			ld a,(hl)
4607  7FEC 32 47 B4     			ld (trn_buf+15),a
4608  7FEF
4609  7FEF
4610  7FEF
4611  7FEF              	;открыть файл
4612  7FEF 2A 45 73     	ld hl,(copyF_RL_source_file) ;указатель
4613  7FF2 DD E5        	push ix
4614  7FF4 DD 21 3B BD  	ld ix,file_fcb_tmp
4615  7FF8
4616  7FF8              ;установка fcb буфера на основании дескриптора файла
4617  7FF8              ;вх:  ix - адрес fcb буфера
4618  7FF8              ;     hl - адрес дескриптора файла
4619  7FF8              ;     (CLS_CurrDir) кластер каталога с файлом
4620  7FF8              ;вых: hl - адрес дескриптора файла
4621  7FF8 CD D9 AC     	call DrvFAT.fcbSetFromEntry
4622  7FFB DD E1        	pop ix
4623  7FFD DC 0F 83     	call c,print_hdd_error
4624  8000 DA 51 68     	jp c,copyF_LR_error
4625  8003
4626  8003
4627  8003
4628  8003
4629  8003              			;цикл
4630  8003              copyF_LR_FAT3
4631  8003 DD E5        			push ix
4632  8005 E1           			pop hl
4633  8006 CD BE 71     			call print_progress
4634  8009
4635  8009
4636  8009              	;считать 1 сектор 1024
4637  8009 DD E5        	push ix
4638  800B DD 21 3B BD  	ld ix,file_fcb_tmp
4639  800F 21 58 B4     	ld hl,trn_buf+pack_size_32_com ;адрес отправляемого пакета
4640  8012 01 00 04     	ld bc,2*512
4641  8015              ;чтение данных из файла в память
4642  8015              ;  файл должен быть открыт
4643  8015              ;  в fcb должны быть установлены: fcbClsFile, fcbOffset
4644  8015              ;вх:  ix - адрес fcb
4645  8015              ;     hl - адрес для чтения
4646  8015              ;     bc - количество байт для чтения
4647  8015 CD 62 A6     	call DrvFAT.ReadDataFromFile
4648  8018 DD E1        	pop ix
4649  801A DC 0F 83     	call c,print_hdd_error
4650  801D DA 51 68     	jp c,copyF_LR_error
4651  8020
4652  8020 CD 3B 80     	call sec1024_to_srv ;отправить на сервер
4653  8023 DA 51 68     		jp c,copyF_LR_error
4654  8026
4655  8026              copyF_LR_FAT_check_pass	;проверка прошла
4656  8026
4657  8026
4658  8026 2A 3C B4     			ld hl,(trn_buf+4) ;следующая честь файла
4659  8029 23           			inc hl
4660  802A 22 3C B4     			ld (trn_buf+4),hl
4661  802D
4662  802D DD 2B        			dec ix
4663  802F DD 7D        			ld a,xl
4664  8031 DD B4        			or xh
4665  8033 C2 03 80     			jp nz,copyF_LR_FAT3
4666  8036
4667  8036
4668  8036              			;call cls_r ;очистить правую панель
4669  8036 CD 89 6F     			call printcat_l
4670  8039              			;call renewcat_r
4671  8039
4672  8039 AF           			xor a ;С=0, нет ошибок
4673  803A C9           			ret
4674  803B
4675  803B
4676  803B              sec1024_to_srv
4677  803B              			;отправка сектора 1024 в образ. заголовок пакета уже должен быть готов
4678  803B CD BE 78     			call check_init_r ;авто проверка инициализации
4679  803E
4680  803E 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
4681  8041 FE 20        			cp " "
4682  8043 20 0E        			jr nz,sec1024_to_srv2 ;продолжим
4683  8045 21 CB 74     			ld hl,mes_stopped ;прервём
4684  8048 CD E9 76     			call print_sys
4685  804B CD B0 6E     			call wait_releas
4686  804E E1           			pop hl ;поправить адрес возврата
4687  804F 3E FF        			ld a,255 ;ошибка останов
4688  8051 3F           			ccf ;С=1
4689  8052 C9           			ret
4690  8053
4691  8053              sec1024_to_srv2
4692  8053
4693  8053
4694  8053 11 38 B4     			ld de,trn_buf
4695  8056 01 20 04     			ld bc,pack_size_1024_com+pack_size_32_com
4696  8059 ED 43 4E 73  			ld (check_sum_size),bc
4697  805D CD FD 70     			call calc_check_sum ;проверить сумму
4698  8060 22 58 B8     			ld (trn_buf+pack_size_1024_com+pack_size_32_com),hl ;записать её в пакет
4699  8063
4700  8063              			;call open_tcp
4701  8063              			;jr c,sec1024_to_srv ;если ошибка, повтор
4702  8063
4703  8063 21 38 B4     			ld hl,trn_buf ;откуда
4704  8066 11 22 04     			ld de,pack_size_1024 ;размер
4705  8069 CD B4 7B     			call Wifi.tcpSend ;отправить
4706  806C 38 CD        			jr c,sec1024_to_srv ;если ошибка, повтор
4707  806E
4708  806E 21 9A 73     			ld hl,mes_trq_part_file ;сообщение пока ждём ответ
4709  8071 CD E9 76     			call print_sys
4710  8074
4711  8074 21 80 F6     			ld hl,rec_buf ;куда
4712  8077 22 5F 79     			ld (Wifi.buffer_pointer),hl
4713  807A CD 27 7B     			call Wifi.getPacket ;приём
4714  807D 38 BC        			jr c,sec1024_to_srv ;если ошибка, повтор
4715  807F
4716  807F              			;принят пакет
4717  807F
4718  807F 21 CD 73     			ld hl,mes_trn_part_file ;сообщение
4719  8082 CD E9 76     			call print_sys
4720  8085 21 80 F6     			ld hl,rec_buf
4721  8088 01 20 00     			ld bc,pack_size_32_com
4722  808B ED 43 4E 73  			ld (check_sum_size),bc ;задать длину пакета для подсчёта
4723  808F 0E 05        			ld c,5 ; Тип пакета Файл 1024
4724  8091 CD 51 6E     			call check_pack
4725  8094 38 A5        			jr c,sec1024_to_srv ;если ошибка]повтор
4726  8096 AF           			xor a
4727  8097 C9           			ret ;выход без ошибок
4728  8098
4729  8098
4730  8098
4731  8098
4732  8098
4733  8098
4734  8098
4735  8098
4736  8098
4737  8098              copyF_RL_FAT ;копирование файлов справа налево FAT
4738  8098 3A 39 73     			ld a,(open_trd_flag)
4739  809B B7           			or a
4740  809C C2 47 60     			jp nz,wait ;если открыт образ справа
4741  809F
4742  809F
4743  809F              			;узнать сколько отмеченных файлов
4744  809F 21 00 D0     			ld hl,cat_mark_r
4745  80A2 06 80        			ld b,128 ;размер таблицы
4746  80A4 DD 2E 00     			ld xl,0 ;счётчик
4747  80A7              copyF_RL_FAT_no_one_chk
4748  80A7 7E           			ld a,(hl)
4749  80A8 B7           			or a
4750  80A9 28 02        			jr z,copyF_RL_FAT_no_one_chk1
4751  80AB DD 2C        			inc xl
4752  80AD              copyF_RL_FAT_no_one_chk1
4753  80AD 23           			inc hl
4754  80AE 10 F7        			djnz copyF_RL_FAT_no_one_chk
4755  80B0 DD 2C        			inc xl
4756  80B2 DD 2D        			dec xl
4757  80B4 20 00        			jr nz,copyF_RL_FAT_no_one2 ;не ноль
4758  80B6              			;не отмечено
4759  80B6              copyF_RL_FAT_no_one2
4760  80B6              			;окно запроса с выбором диска
4761  80B6 3A 1D 73     			ld a,(cur_drive)
4762  80B9 C6 41        			add a,"A"
4763  80BB 32 88 74     			ld (mes_trd_dsk+3),a
4764  80BE 21 A5 75     			ld hl,mes_copy_file
4765  80C1 CD 09 77     			call print
4766  80C4 21 85 74     			ld hl,mes_trd_dsk
4767  80C7 CD 09 77     			call print
4768  80CA 3E 27        			ld a,col_win
4769  80CC CD 2C 6E     			call paint_win
4770  80CF
4771  80CF              copyF_RL_FAT_w ;ожидание согласия
4772  80CF 76           			halt
4773  80D0 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
4774  80D3 FE 4E        			cp 		"N"
4775  80D5 CA 61 6A     			jp z,copyF_exit ;выход если нет согласия
4776  80D8 FE 59        			cp 		"Y"
4777  80DA 20 F3        			jr nz,copyF_RL_FAT_w
4778  80DC
4779  80DC DD 2C        			inc xl
4780  80DE DD 2D        			dec xl
4781  80E0 20 11        			jr nz,copyF_RL_FAT_no_one ;не один
4782  80E2 3A 25 73     			ld a,(curfile) ;тогда только текущий файл
4783  80E5 CD 41 81     			call copyF_RL_FAT_one
4784  80E8 D2 35 81     			jp nc,copyF_RL_fat_exit ;выход без ошибки
4785  80EB FE FF        			cp 255
4786  80ED CA 35 81     			jp z,copyF_RL_fat_exit ;выход после останова
4787  80F0 C3 3B 81     			jp copyF_RL_fat_error ;выход с ошибкой
4788  80F3
4789  80F3
4790  80F3              copyF_RL_FAT_no_one ;копировать несколько
4791  80F3 21 00 D0     			ld hl,cat_mark_r
4792  80F6 DD 7D        			ld a,xl
4793  80F8 32 53 73     			ld (cat_mark_cur_tot),a
4794  80FB AF           			xor a
4795  80FC              copyF_RL_FAT_no_one_cl
4796  80FC 32 52 73     			ld (cat_mark_cur_cl),a
4797  80FF 22 50 73     			ld (cat_mark_cur),hl
4798  8102 7E           			ld a,(hl) ;есть отметка?
4799  8103 B7           			or a
4800  8104 28 1E        			jr z,copyF_RL_FAT_no_one_cl1
4801  8106 3A 53 73     			ld a,(cat_mark_cur_tot)
4802  8109 6F           			ld l,a
4803  810A 26 00        			ld h,0
4804  810C 3D           			dec a
4805  810D 32 53 73     			ld (cat_mark_cur_tot),a
4806  8110 CD D3 71     			call print_progress_tot ;прогресс
4807  8113 3A 52 73     			ld a,(cat_mark_cur_cl) ;очередной номер файла
4808  8116 CD 41 81     			call copyF_RL_FAT_one ;скопировать
4809  8119 D2 24 81     			jp nc,copyF_RL_FAT_no_one_cl1 ;продолжить без ошибки
4810  811C FE FF        			cp 255
4811  811E CA 35 81     			jp z,copyF_RL_fat_exit ;выход после останова
4812  8121 C3 3B 81     			jp copyF_RL_fat_error ;выход с ошибкой
4813  8124              copyF_RL_FAT_no_one_cl1
4814  8124 2A 50 73     			ld hl,(cat_mark_cur)
4815  8127 36 00        			ld (hl),0 ;снять отметку
4816  8129 23           			inc hl
4817  812A 3A 52 73     			ld a,(cat_mark_cur_cl)
4818  812D 3C           			inc a
4819  812E FE 80        			cp 128
4820  8130 38 CA        			jr c,copyF_RL_FAT_no_one_cl
4821  8132
4822  8132 C3 35 81     			jp copyF_RL_fat_exit ;выход без ошибки
4823  8135
4824  8135              copyF_RL_fat_exit
4825  8135 CD A9 62     			call renewcat_l
4826  8138 C3 61 6A     			jp copyF_exit
4827  813B
4828  813B              copyF_RL_fat_error
4829  813B CD A9 62     			call renewcat_l
4830  813E C3 81 6A     			jp copyF_error
4831  8141
4832  8141              copyF_RL_FAT_one ;по одному файлу справа налево FAT
4833  8141              			;на входе в A - номер файла
4834  8141              			;на выходе C=1, если ошибка; A=255, если остановлено
4835  8141
4836  8141              			;узнать параметры файла
4837  8141 01 80 EE     			ld bc,cat_r ;адрес обычного каталога
4838  8144              			;ld a,(curfile) ;текущ файл
4839  8144 6F           			ld l,a
4840  8145 26 00        			ld h,0
4841  8147 29                       add    hl,hl ;2
4842  8148 29           			add    hl,hl ;4
4843  8149 29           			add    hl,hl ;8
4844  814A 29           			add    hl,hl ;16
4845  814B 09           			add hl,bc
4846  814C
4847  814C 22 45 73     			ld (copyF_RL_source_file),hl ;указатель на запись о файле
4848  814F
4849  814F
4850  814F 01 0F 00     			ld bc,12+3
4851  8152 09           			add hl,bc
4852  8153 7E           			ld a,(hl) ;размер файла 4й байт
4853  8154 FE 04        			cp 4
4854  8156 D2 51 68     			jp nc,copyF_LR_error ;если слишком большой (больше 67108864)
4855  8159 4F           			ld c,a ;4й
4856  815A 2B           			dec hl
4857  815B 7E           			ld a,(hl) ;размер файла 3й байт
4858  815C 57           			ld d,a ;3й
4859  815D 2B           			dec hl
4860  815E 7E           			ld a,(hl) ;
4861  815F 5F           			ld e,a ;2й
4862  8160
4863  8160              			;разделить на 1024
4864  8160 CB 39        			srl c ;/2 на старший бит придёт 0
4865  8162 CB 1A        			rr d ;
4866  8164 CB 1B        			rr e ; на старший бит придёт флаг С
4867  8166 CB 39        			srl c ;/4
4868  8168 CB 1A        			rr d ;
4869  816A CB 1B        			rr e
4870  816C
4871  816C              			;цикл по размеру в секторах 1024
4872  816C DD 62 DD 6B  			ld ix,de
4873  8170
4874  8170              			;узнать размер последней части файла. обратно умножим на 1024
4875  8170              			;ld c,0
4876  8170 CB 23        			sla e ;*2 на младший бит придёт 0
4877  8172              			;rl d ;на младший бит придёт флаг C
4878  8172              			;rl c
4879  8172 CB 23        			sla e ;*2 на младший бит придёт 0
4880  8174              			;rl d ;на младший бит придёт флаг C
4881  8174              			;rl c
4882  8174              			;ld e,d
4883  8174              			;ld d,c ;в DE 3й и 4й байт
4884  8174 53           			ld d,e
4885  8175 1E 00        			ld e,0
4886  8177 2A 45 73     			ld hl,(copyF_RL_source_file) ;указатель на запись о файле
4887  817A 01 0D 00     			ld bc,12+1
4888  817D 09           			add hl,bc
4889  817E 7E           			ld a,(hl) ;размер файла 2й байт
4890  817F 2B           			dec hl
4891  8180 6E           			ld l,(hl) ;1й байт
4892  8181 67           			ld h,a
4893  8182 A7           			and a
4894  8183 ED 52        			sbc hl,de ;узнали остаток
4895  8185 22 4C 73     			ld (copyF_FAT_RL_last_part),hl
4896  8188
4897  8188              			;коррекция числа пакетов
4898  8188 2A 45 73     			ld hl,(copyF_RL_source_file) ;указатель на запись о файле
4899  818B 01 0D 00     			ld bc,12+1
4900  818E 09           			add hl,bc
4901  818F 7E           			ld a,(hl) ;2й байт
4902  8190 E6 03        			and %00000011
4903  8192 4F           			ld c,a
4904  8193 2B           			dec hl
4905  8194 7E           			ld a,(hl) ;1й байт
4906  8195 B1           			or c
4907  8196 28 02        			jr z,copyF_RL_FAT_one_fix
4908  8198 DD 23        			inc ix ;фикс
4909  819A              copyF_RL_FAT_one_fix
4910  819A
4911  819A
4912  819A              			;пробуем открыть файл
4913  819A DD E5        			push ix
4914  819C 2A 45 73     			ld hl,(copyF_RL_source_file) ;указатель на запись о файле
4915  819F 11 5B BD     			ld de,file_name_cur
4916  81A2 01 0C 00     			ld bc,file_name_len ;перенести, чтобы в конце был 0
4917  81A5 ED B0        			ldir
4918  81A7 AF           			xor a
4919  81A8 12           			ld (de),a
4920  81A9 21 5B BD     			ld hl,file_name_cur
4921  81AC CD D1 B2     			call  DrvFAT.strTestFileName
4922  81AF DC 0F 83     			call c,print_hdd_error
4923  81B2 DA DB 81     			jp c,copyF_RL_FAT_one1      ;ошибка в имени
4924  81B5 11 3B BD     			ld  de,file_fcb_tmp
4925  81B8 CD 30 B2     			call  DrvFAT.FileNameTo8dot3
4926  81BB              			; ld  de,file_fcb_tmp
4927  81BB              			; ld  bc,file_name_len
4928  81BB              			; ldir
4929  81BB DD 21 3B BD  			ld  ix,file_fcb_tmp
4930  81BF CD 43 A7     			call  DrvFAT.fatEraseEntry
4931  81C2 DC 0F 83     			call c,print_hdd_error
4932  81C5 DA DB 81     			jp c,copyF_RL_FAT_one1
4933  81C8              			; ld  hl,(CLS_CurrDir+0)
4934  81C8              			; ld  de,(CLS_CurrDir+2)
4935  81C8 CD D5 AC     			call  DrvFAT.fcbSetCLSCurrDir
4936  81CB DD CB 1E A6  			res  4,(ix+DrvFAT.fcbType)    ;файл
4937  81CF 11 00 00     			ld  de,#0000
4938  81D2 21 00 00     			ld  hl,#0000    ;size
4939  81D5 CD 73 AD     			call  DrvFAT.DEHL2fcbSize
4940  81D8 CD 93 A9     			call  DrvFAT.fatCreateFile
4941  81DB              copyF_RL_FAT_one1
4942  81DB 21 FF FF     			ld  hl,#FFFF
4943  81DE 22 98 8D     			ld  (SecDIRinBuf+2),hl
4944  81E1 3A 5B 8B     			ld  a,(PartitionNum)
4945  81E4 DD 77 1F     			ld  (ix+DrvFAT.fcbPart),a
4946  81E7              			;загрузка в fcbOffset указателя в файле
4947  81E7 11 00 00     			ld de,0
4948  81EA 21 00 00     			ld hl,0
4949  81ED CD 59 AD     			call DrvFAT.DEHL2fcbOffset
4950  81F0 DD E1        			pop ix
4951  81F2 DC 0F 83     			call c,print_hdd_error
4952  81F5 DA 51 68     			jp c,copyF_LR_error
4953  81F8
4954  81F8
4955  81F8
4956  81F8              			;начинаем копировать файл
4957  81F8
4958  81F8 2A 45 73     			ld hl,(copyF_RL_source_file) ;указатель на запись о файле
4959  81FB
4960  81FB 11 48 B4     			ld de,trn_buf+16 ;перекинем имя файла в запрос
4961  81FE 01 0C 00     			ld bc,file_name_len
4962  8201 ED B0        			ldir
4963  8203 3E 02        			ld a,2 ;Тип пакета Запрос приёма файла 1024 байт
4964  8205 32 3B B4     			ld (trn_buf+3),a
4965  8208
4966  8208 21 00 00     			ld hl,0
4967  820B 22 3C B4     			ld (trn_buf+4),hl ;с нулевой части
4968  820E
4969  820E              			;размер файла
4970  820E 2A 45 73     			ld hl,(copyF_RL_source_file) ;указатель
4971  8211 01 0C 00     			ld bc,12
4972  8214 09           			add hl,bc
4973  8215 7E           			ld a,(hl)
4974  8216 32 44 B4     			ld (trn_buf+12),a
4975  8219 23           			inc hl
4976  821A 7E           			ld a,(hl)
4977  821B 32 45 B4     			ld (trn_buf+13),a
4978  821E 23           			inc hl
4979  821F 7E           			ld a,(hl)
4980  8220 32 46 B4     			ld (trn_buf+14),a
4981  8223 23           			inc hl
4982  8224 7E           			ld a,(hl)
4983  8225 32 47 B4     			ld (trn_buf+15),a
4984  8228
4985  8228              			;цикл
4986  8228
4987  8228              copyF_RL_FAT3
4988  8228 CD BE 78     	call check_init_r ;авто проверка инициализации
4989  822B
4990  822B DD E5        			push ix
4991  822D E1           			pop hl
4992  822E CD BE 71     			call print_progress
4993  8231
4994  8231 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
4995  8234 FE 20        			cp " "
4996  8236 20 0D        			jr nz,copyF_RL_FAT2 ;продолжим
4997  8238 21 CB 74     			ld hl,mes_stopped ;прервём
4998  823B CD E9 76     			call print_sys
4999  823E CD B0 6E     			call wait_releas
5000  8241 3E FF        			ld a,255
5001  8243 3F           			ccf ;C=1
5002  8244 C9           			ret
5003  8245
5004  8245              copyF_RL_FAT2
5005  8245              			;call open_tcp
5006  8245              			;jr c,copyF_RL_FAT3 ;если ошибка, то новая попытка
5007  8245
5008  8245 21 38 B4     			ld hl,trn_buf ;откуда
5009  8248 11 22 00     			ld de,pack_size_32 ;размер
5010  824B CD B4 7B     			call Wifi.tcpSend ;отправить
5011  824E 38 D8        			jr c,copyF_RL_FAT3 ;если ошибка, то новая попытка
5012  8250
5013  8250 21 8A 73     			ld hl,mes_req_part_file ;сообщение пока ждём ответ
5014  8253 CD E9 76     			call print_sys
5015  8256
5016  8256 21 80 F6     			ld hl,rec_buf ;куда
5017  8259 22 5F 79     			ld (Wifi.buffer_pointer),hl
5018  825C CD 27 7B     			call Wifi.getPacket ;приём
5019  825F 30 02        			jr nc,copyF_RL_FAT_check_pass1
5020  8261 18 C5        			jr copyF_RL_FAT3 ;если ошибка, то новая попытка
5021  8263
5022  8263              copyF_RL_FAT_check_pass1	;принят пакет
5023  8263 21 C2 73     			ld hl,mes_rec_part_file ;сообщение
5024  8266 CD E9 76     			call print_sys
5025  8269 21 80 F6     	ld hl,rec_buf
5026  826C 01 20 04     	ld bc,pack_size_1024_com+pack_size_32_com
5027  826F ED 43 4E 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
5028  8273 0E 03        			ld c,3 ; Тип пакета Файл 1024
5029  8275 CD 51 6E     			call check_pack
5030  8278 30 03        			jr nc,copyF_RL_FAT_check_pass
5031  827A              			;call init_dev
5032  827A C3 28 82     			jp copyF_RL_FAT3 ;если ошибка, то новая попытка
5033  827D
5034  827D              copyF_RL_FAT_check_pass	;проверка прошла
5035  827D
5036  827D
5037  827D
5038  827D              	;запишем 1 сектор 1024
5039  827D DD E5        	push ix
5040  827F 01 00 04     	ld bc,2*512 ;на запись 1024
5041  8282              	;проверка на последнюю часть файла
5042  8282 DD 7C        	ld a,xh
5043  8284 B7           	or a
5044  8285 20 0F        	jr nz,copyF_RL_FAT_write_no_last
5045  8287 DD 7D        	ld a,xl
5046  8289 FE 01        	cp 1
5047  828B 20 09        	jr nz,copyF_RL_FAT_write_no_last
5048  828D 2A 4C 73     	ld hl,(copyF_FAT_RL_last_part)	;остаток
5049  8290 7C           	ld a,h
5050  8291 B5           	or l
5051  8292 28 02        	jr z,copyF_RL_FAT_write_no_last ;если = 0
5052  8294 44           	ld b,h
5053  8295 4D           	ld c,l
5054  8296
5055  8296              copyF_RL_FAT_write_no_last
5056  8296 DD 21 3B BD  	ld ix,file_fcb_tmp
5057  829A 21 A0 F6     	ld hl,rec_buf+32 ;адрес принятого пакета
5058  829D
5059  829D              ;запись данных из памяти в файл
5060  829D              ;  файл должен быть открыт
5061  829D              ;  в fcb должны быть установлены: fcbName, fcbExt, fcbClsFile, fcbClsDIR,
5062  829D              ;    fcbSize, fcbOffset, fcbPart
5063  829D              ;вх:  ix - адрес fcb
5064  829D              ;     hl - адрес в памяти для записи
5065  829D              ;     bc - количество байт для записи
5066  829D              ;вых: cy=1 ошибки
5067  829D              ;        a=errNumTooBig - слишком большой размер, более #FFFF кластеров
5068  829D              ;        a=errRWnum - код ошибки
5069  829D              ;        a=errFileEmpty - нулевой размер файла
5070  829D              ;        a=errDiskNoSpace
5071  829D              ;        a=errInvalidPart
5072  829D              ;        a=errEoF - файл прервался
5073  829D              ;        a=errFileNotFound
5074  829D              ;     cy=0 данные записаны
5075  829D              ;       hl следующий адрес для записи
5076  829D CD C9 A5     	call DrvFAT.WriteDataToFile
5077  82A0 DD E1        	pop ix
5078  82A2 DC 0F 83     	call c,print_hdd_error
5079  82A5 DA 51 68     	jp c,copyF_LR_error
5080  82A8
5081  82A8
5082  82A8 2A 3C B4     			ld hl,(trn_buf+4) ;следующая честь файла
5083  82AB 23           			inc hl
5084  82AC 22 3C B4     			ld (trn_buf+4),hl
5085  82AF
5086  82AF DD 2B        			dec ix
5087  82B1 DD 7D        			ld a,xl
5088  82B3 DD B4        			or xh
5089  82B5 C2 28 82     			jp nz,copyF_RL_FAT3
5090  82B8
5091  82B8
5092  82B8 CD 89 6F     			call printcat_l
5093  82BB CD E4 6E     			call printcat_r
5094  82BE AF           			xor a ;C=0
5095  82BF C9           			ret
5096  82C0
5097  82C0
5098  82C0
5099  82C0
5100  82C0
5101  82C0
5102  82C0
5103  82C0
5104  82C0              ;узнать дексриптор файла фат из каталога слева
5105  82C0              ;вх: A - номер файла в каталоге
5106  82C0              ;вых: ix - дескриптор
5107  82C0              calc_cat_fat_deskr
5108  82C0 DD 6F        			ld      ixl,a
5109  82C2 DD 26 00     			ld 		ixh,0
5110  82C5 DD 29                    add    ix,ix ;2
5111  82C7 DD 29        			add    ix,ix ;4
5112  82C9 DD 29        			add    ix,ix ;8
5113  82CB DD 29        			add    ix,ix ;16
5114  82CD DD 29        			add    ix,ix ;32
5115  82CF 01 80 D0     			ld bc,cat_l
5116  82D2 DD 09        			add ix,bc
5117  82D4 C9           			ret
5118  82D5
5119  82D5
5120  82D5
5121  82D5              format_name_fat_dot ;подогнать имя 8+3 под стандарт filename.ext
5122  82D5              ;вх: HL - имя в каталоге
5123  82D5 E5           	push hl
5124  82D6 21 5B BD     	ld hl,file_name_cur
5125  82D9 11 5C BD     	ld de,file_name_cur+1 ;почистить
5126  82DC 01 0B 00     	ld bc,file_name_len-1
5127  82DF 36 00        	ld (hl),0
5128  82E1 ED B0        	ldir
5129  82E3
5130  82E3 E1           	pop hl
5131  82E4 E5           	push hl
5132  82E5
5133  82E5 11 5B BD     	ld de,file_name_cur ;куда
5134  82E8 01 FF 08     	ld bc,#08ff
5135  82EB              format_name_fat_dot_cl
5136  82EB 7E           	ld a,(hl)
5137  82EC FE 21        	cp " "+1
5138  82EE 38 04        	jr c,format_name_fat_dot_skip
5139  82F0 ED A0        	ldi
5140  82F2 10 F7        	djnz format_name_fat_dot_cl
5141  82F4              format_name_fat_dot_skip
5142  82F4 3E 2E        	ld a,"."
5143  82F6 12           	ld (de),a
5144  82F7
5145  82F7 13           	inc de
5146  82F8 E1           	pop hl
5147  82F9 01 08 00     	ld bc,8 ;перейти на расширение
5148  82FC 09           	add hl,bc
5149  82FD
5150  82FD 01 FF 03     	ld bc,#03ff
5151  8300              format_name_fat_dot_cl2
5152  8300 7E           	ld a,(hl)
5153  8301 FE 21        	cp " "+1
5154  8303 38 04        	jr c,format_name_fat_dot_skip2
5155  8305 ED A0        	ldi
5156  8307 10 F7        	djnz format_name_fat_dot_cl2
5157  8309              format_name_fat_dot_skip2
5158  8309 AF           	xor a ;в конце 0
5159  830A 12           	ld (de),a
5160  830B 21 5B BD     	ld hl,file_name_cur
5161  830E C9           	ret
5162  830F
5163  830F              ;печать номера ошибки HDD в системной строке
5164  830F              print_hdd_error
5165  830F F5           	push af
5166  8310              	;пропуск некоторых ошибок
5167  8310 FE 71        	cp #71
5168  8312 28 2A        	jr z,print_hdd_error_skip
5169  8314 E5           	push hl
5170  8315 D5           	push de
5171  8316 C5           	push bc
5172  8317 DD E5        	push ix
5173  8319 4F           	ld c,a
5174  831A E6 F0        	and %11110000
5175  831C CB 3F        	srl a
5176  831E CB 3F        	srl a
5177  8320 CB 3F        	srl a
5178  8322 CB 3F        	srl a
5179  8324 CD 40 83     	call print_hdd_error_to_hex
5180  8327 32 58 83     	ld (mes_hdd_error_num),a
5181  832A 79           	ld a,c
5182  832B E6 0F        	and %00001111
5183  832D CD 40 83     	call print_hdd_error_to_hex
5184  8330 32 59 83     	ld (mes_hdd_error_num+1),a
5185  8333 21 4C 83     	ld hl,mes_hdd_error
5186  8336 CD E9 76     	call print_sys
5187  8339 DD E1        	pop ix
5188  833B C1           	pop bc
5189  833C D1           	pop de
5190  833D E1           	pop hl
5191  833E              print_hdd_error_skip
5192  833E F1           	pop af
5193  833F C9           	ret
5194  8340              print_hdd_error_to_hex
5195  8340 FE 0A        	cp 10
5196  8342 30 03        	jr nc,print_hdd_error_to_hex1
5197  8344 C6 30        	add "0" ;0-9
5198  8346 C9           	ret
5199  8347              print_hdd_error_to_hex1 ;A-F
5200  8347 D6 0A        	sub 10
5201  8349 C6 41        	add "A"
5202  834B C9           	ret
5203  834C
5204  834C 44 69 73 6B  mes_hdd_error db "Disk error #"
5204  8350 20 65 72 72
5204  8354 6F 72 20 23
5205  8358 30 30 00     mes_hdd_error_num db "00",0
5206  835B
5207  835B              		;align 256
5208  835B              font    insert  "FONT.C" ;шрифт
5209  8B5B
5210  8B5B              	;org #a000
5211  8B5B              	;incbin "_cat.txt" ;тестовый каталог
5212  8B5B
5213  8B5B              ;для драйвера HDD
5214  8B5B 00           PartitionNum db 0 ;
5215  8B5C 00           _ExtFlags db 0 ;флаги внешней программы
5216  8B5D 00 00 00...  _BufSecHdd ds #200 ;буфер для драйвера HDD
5217  8D5D 00 00 00...  _VarsFAT ds #5B ;адрес блока переменных
5218  8DB8              ;различные буфера
5219  8DB8 00 00 00...  _Buf4File	ds #200 ;буфер для чтения файла
5220  8FB8              _Buf4MBR	equ _BufSecHdd ;ds #200 ;буфер с сектором MBR
5221  8FB8 00 00 00...  _Buf4LFN	ds #100 ;буфер для создания записей с длинным именем
5222  90B8 00 00 00...  _Buf4DIR	ds #200 ;буфер для загрузки сектора DIR (каталога)
5223  92B8 00 00 00...  _Buf4FAT	ds #200 ;буфер для загрузки сектора FAT
5224  94B8 00 00 00...  _CurrentPath ds #100 ;буфер текущего пути
5225  95B8 00 00 00...  _tmp_fcb	ds #20 ;для временного хранения fcb
5226  95D8 00 00 00...  BufIDsd ds #200 ;буфер для SD (нужен?)
5227  97D8
5228  97D8 00 00 00...  _msSMUC	  ds	11		;SMUC master
5229  97E3 00 00 00...  _slSMUC	  ds	11		;SMUC slave
5230  97EE 00 00 00...  _msNemo	  ds	11		;Nemo master
5231  97F9 00 00 00...  _slNemo	  ds	11		;Nemo slave
5232  9804 00 00 00...  _msATM	  ds	11		;ATM IDE master
5233  980F 00 00 00...  _slATM	  ds	11		;ATM IDE slave
5234  981A 00 00 00...  _msPROFI	  ds	11		;Profi IDE master
5235  9825 00 00 00...  _slPROFI	  ds	11		;Profi IDE slave
5236  9830 00 00 00...  _cardZC	  ds	11		;ZC SD Є ав 
5237  983B 00 00 00...  _mDivMMC	  ds	11		;DivMMC master
5238  9846 00 00 00...  _sDivMMC	  ds	11		;DivMMC slave
5239  9851
5240  9851              		include "Drivers/InitHDD/init.a80"
# file opened: Drivers/InitHDD/init.a80
   1+ 9851              ;------------------------------------------------------------------------------
   2+ 9851              ; ⢠ 㯭 ࠧ  
   3+ 9851              ;:  a - ⨢ ஫ HDD/SD
   4+ 9851              ;: hl,a - ⢮ ன
   5+ 9851              ;     typeDrive - ନ஢ ⠡
   6+ 9851              ;
   7+ 9851              navGetNumDrives
   8+ 9851              ;
   9+ 9851              ;஢ઠ  DivMMC
  10+ 9851              	IFDEF	useDivMMC
  11+ 9851 ~            	 di
  12+ 9851 ~            	 ld	a,#80
  13+ 9851 ~            	 out	(#E3),a
  14+ 9851 ~            	 ld	hl,(#0002)
  15+ 9851 ~            	 ld	de,#5E00
  16+ 9851 ~            	 or	a
  17+ 9851 ~            	 sbc	hl,de
  18+ 9851 ~            	 jr	nz,goto514		;DivMMC  
  19+ 9851 ~            ; ⪫祭 ᪠஢ SMUCv1, ATM-IDE
  20+ 9851 ~            	 IFDEF	SMUC
  21+ 9851 ~            	  ld	(_msSMUC+#0A),a
  22+ 9851 ~            	 ENDIF
  23+ 9851 ~            	 IFDEF	ATMide
  24+ 9851 ~            	  ld	(_msATM+#0A),a
  25+ 9851 ~            	 ENDIF
  26+ 9851 ~            	 IFDEF	PROFIide
  27+ 9851 ~            	  ld	(_msPROFI+#0A),a
  28+ 9851 ~            	 ENDIF
  29+ 9851 ~            	 call	#1FFA			;몫祭 rom DivMMC
  30+ 9851 ~            goto514	 ei
  31+ 9851              	ENDIF
  32+ 9851
  33+ 9851              ;樠 ஫஢  ன  
  34+ 9851 11 4C 99     	ld	de,typeDrive
  35+ 9854 D5           	push	de
  36+ 9855 06 08        	ld	b,DrvHDD.devNums
  37+ 9857 21 87 98     	ld	hl,tablDev
  38+ 985A DD 21 5D 8B  	ld	ix,_Buf4MBR
  39+ 985E 3E FF        cng_19	ld	a,#FF
  40+ 9860 C5           loop061	push	bc
  41+ 9861 4E           	ld	c,(hl)
  42+ 9862 23           	inc	hl
  43+ 9863 46           	ld	b,(hl)
  44+ 9864 23           	inc	hl
  45+ 9865 C5           	push	bc
  46+ 9866 FD E1        	pop	iy
  47+ 9868 0F           	rrca
  48+ 9869 30 05        	jr	nc,goto532
  49+ 986B F5           	push	af
  50+ 986C CD 9F 98     	call	proc_11			;䨪 ஢/SD 
  51+ 986F F1           	pop	af
  52+ 9870 23           goto532	inc	hl
  53+ 9871 C1           	pop	bc
  54+ 9872 10 EC        	djnz	loop061
  55+ 9874 EB           	ex	de,hl
  56+ 9875 D1           	pop	de
  57+ 9876
  58+ 9876              ; ⢠  ࠧ
  59+ 9876 B7           	or	a
  60+ 9877 ED 52        	sbc	hl,de			;⢮  ࠧ
  61+ 9879 7D           	ld	a,l
  62+ 987A C6 04        	add	a,#04			;+fdd
  63+ 987C 2E 16        	ld	l,22
  64+ 987E BD           	cp	l
  65+ 987F 38 01        	jr	c,goto312
  66+ 9881 7D           	ld	a,l
  67+ 9882 6F           goto312	ld	l,a
  68+ 9883 32 6C 99     	ld	(numDrives),a
  69+ 9886 C9           	ret
  70+ 9887
  71+ 9887              ;⠡  ࠬ ன
  72+ 9887              ;                        ccchpp
  73+ 9887              tablDev
  74+ 9887              ;	IFDEF	SMUCv2
  75+ 9887 D8 97        	 dw _msSMUC
  75+ 9889 00              db %00000000	;SMUC v2 master
  76+ 988A              ;	ENDIF
  77+ 988A              ;	IFDEF	SMUCv1
  78+ 988A D8 97        	 dw _msSMUC
  78+ 988C 08              db %00001000	;SMUC v1 master
  79+ 988D              ;	ENDIF
  80+ 988D              ;	IFDEF	NemoStd
  81+ 988D EE 97        	 dw _msNemo
  81+ 988F 10              db %00010000	;Nemo master
  82+ 9890              ;	ENDIF
  83+ 9890              ;	IFDEF	NemoA8
  84+ 9890 EE 97        	 dw _msNemo
  84+ 9892 18              db %00011000	;Nemo A8 master
  85+ 9893              ;	ENDIF
  86+ 9893              ;	IFDEF	ATMide
  87+ 9893 04 98        	 dw _msATM
  87+ 9895 20               db %00100000	;ATM ide master
  88+ 9896              ;	ENDIF
  89+ 9896              ;	IFDEF	PROFIide
  90+ 9896 1A 98        	 dw _msPROFI
  90+ 9898 28             db %00101000	;ATM ide master
  91+ 9899              ;	ENDIF
  92+ 9899              ;	IFDEF	ZC
  93+ 9899 30 98        	 dw _cardZC
  93+ 989B 30              db %00110000	;SD ZC
  94+ 989C              ;	ENDIF
  95+ 989C              ;	IFDEF	DivMMC
  96+ 989C 3B 98        	 dw _mDivMMC
  96+ 989E 38             db %00111000	;SD DivMMC master
  97+ 989F              ;	ENDIF
  98+ 989F
  99+ 989F              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 100+ 989F              ;䨪 ஫  ன  
 101+ 989F              ;:  hl -   ⠡  ࠬ ன
 102+ 989F              ;     de -   ⠡ ࠧ typeDrive
 103+ 989F              ;     ix -    㧪 ᥪ 䨪樨
 104+ 989F              ;     iy -  砫  ६  master  SD 
 105+ 989F              ;: de -    ⠡ ࠧ typeDrive
 106+ 989F              ;     iy,bc,a - ???
 107+ 989F              ;
 108+ 989F 7E           proc_11	ld	a,(hl)
 109+ 98A0 2F           	cpl
 110+ 98A1 E6 30        	and	%00110000
 111+ 98A3 28 07        	jr	z,loop060		; SD 
 112+ 98A5 FD 7E 0A     	ld	a,(iy+#0A)		;master
 113+ 98A8 FD B6 15     	or	(iy+#0A+11)		;slave
 114+ 98AB F8           	ret	m			;  ஢ 
 115+ 98AC
 116+ 98AC              ;䨪 ன
 117+ 98AC              ;  ⠭ ன⢠ ⥪騬
 118+ 98AC 7E           loop060	ld	a,(hl)
 119+ 98AD 07           	rlca
 120+ 98AE 07           	rlca
 121+ 98AF E6 10        	and	#10
 122+ 98B1 FD 77 0A     	ld	(iy+#0A),a
 123+ 98B4 7E           	ld	a,(hl)
 124+ 98B5 CD 6E 99     	call	DrvHDD.hddSetDevice
 125+ 98B8              ;  䨪 
 126+ 98B8 E5           	push	hl
 127+ 98B9 D5           	push	de
 128+ 98BA E6 38        	and	%00111000
 129+ 98BC FE 30        	cp	#30
 130+ 98BE 28 0D        	jr	z,goto512		; ZC
 131+ 98C0 30 0D        	jr	nc,goto108		; MMC
 132+ 98C2 CD 03 9A     	call	DrvHDD.kHddCheck	;஢ਬ tr-dos  smuc v1
 133+ 98C5 D4 06 9A     	call	nc,DrvHDD.kPortsOn	;稬   ATM
 134+ 98C8 D4 F1 99     	call	nc,DrvHDD.kHddTestInit
 135+ 98CB 18 19        	jr	goto513
 136+ 98CD              ;  䨪 SD  ZC
 137+ 98CD CB D6        goto512	set	2,(hl)			; ZC ⮫쪮  
 138+ 98CF F3           goto108	di
 139+ 98D0 CD F1 99     	call	DrvHDD.kHddTestInit	;樠 SD 
 140+ 98D3 21 D8 95     	ld	hl,BufIDsd
 141+ 98D6 D4 5D 9E     	call	nc,DrvHDD.sdReadCID
 142+ 98D9 E5           	push	hl
 143+ 98DA D4 58 9E     	call	nc,DrvHDD.sdReadCSD
 144+ 98DD E1           	pop	hl			;hl=BufIDsd+#10
 145+ 98DE F5           	push	af
 146+ 98DF D4 E0 9D     	call	nc,DrvHDD.sdCalcCapacity
 147+ 98E2 DB 7B        	in	a,(#7B)			;몫稬 
 148+ 98E4 F1           	pop	af
 149+ 98E5 FB           	ei
 150+ 98E6              ;  ⠭ ६ ன⢠  ନ஢ ⠡  㯭묨 ࠧ
 151+ 98E6 D1           goto513	pop	de
 152+ 98E7 D4 86 99     	call	nc,DrvHDD.devSetVars
 153+ 98EA D4 FA 98     	call	nc,proc_10		;ନ஢ ⠡  㯭묨 ࠧ
 154+ 98ED E1           	pop	hl
 155+ 98EE 01 0B 00     	ld	bc,11
 156+ 98F1 FD 09        	add	iy,bc
 157+ 98F3 CB 56        	bit	2,(hl)
 158+ 98F5 CB D6        	set	2,(hl)
 159+ 98F7 28 B3        	jr	z,loop060
 160+ 98F9 C9           	ret
 161+ 98FA
 162+ 98FA              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 163+ 98FA              ;ନ஢ ⠡  㯭묨 ࠧ  
 164+ 98FA              ;:  (drvDevice) -  ஫    
 165+ 98FA              ;     de -   ⠡ ࠧ typeDrive
 166+ 98FA              ;: de -    ⠡ ࠧ typeDrive
 167+ 98FA              ;     b=#00
 168+ 98FA              ;     hl,c,a - ???
 169+ 98FA              ;
 170+ 98FA D5           proc_10	push	de
 171+ 98FB CD 20 99     	call	navFindPart
 172+ 98FE D1           	pop	de
 173+ 98FF D8           	ret	c			; ⥪饬   ࠧ
 174+ 9900 EB           	ex	de,hl
 175+ 9901 F5           	push	af
 176+ 9902 3A D7 A4     	ld	a,(DrvHDD.drvDevice)
 177+ 9905 E6 3C        	and	%00111100
 178+ 9907 4F           	ld	c,a			;   ࢮ ࠧ
 179+ 9908 F1           	pop	af
 180+ 9909 06 04        	ld	b,#04
 181+ 990B 36 00        loop059	ld	(hl),#00
 182+ 990D 1F           	rra
 183+ 990E 30 0A        	jr	nc,goto106		; ࠧ
 184+ 9910 71           	ld	(hl),c
 185+ 9911 CB F6        	set	6,(hl)			;=%01??zhpp MFS
 186+ 9913 1F           	rra
 187+ 9914 30 02        	jr	nc,goto107		; MFS
 188+ 9916 CB FE        	set	7,(hl)			;=%11??zhpp  FAT
 189+ 9918 23           goto107	inc	hl
 190+ 9919 17           	rla
 191+ 991A 1F           goto106	rra
 192+ 991B 0C           	inc	c
 193+ 991C 10 ED        	djnz	loop059
 194+ 991E EB           	ex	de,hl
 195+ 991F C9           	ret
 196+ 9920
 197+ 9920              ;------------------------------------------------------------------------------
 198+ 9920              ; ࠧ FAT32  MFS  ⥪饬 
 199+ 9920              ;:  ---
 200+ 9920              ;: cy=1 訡 ⥭/ࠧ  
 201+ 9920              ;       a=#66  MBR
 202+ 9920              ;       a=errInvalidPart ࠧ  
 203+ 9920              ;     cy=0 ࠧ() ()
 204+ 9920              ;       a,c - १
 205+ 9920              ;       bit 1-0 ⨯ 0 ࠧ =%00 ࠧ   ⥭
 206+ 9920              ;                               =%01  MFS ࠧ
 207+ 9920              ;                               =%11  FAT32 ࠧ
 208+ 9920              ;       bit 3-2 ⨯ 1 ࠧ
 209+ 9920              ;       bit 5-4 ⨯ 2 ࠧ
 210+ 9920              ;       bit 7-6 ⨯ 3 ࠧ
 211+ 9920              ;
 212+ 9920              navFindPart
 213+ 9920              ;
 214+ 9920 01 00 04     	ld	bc,#0400
 215+ 9923 C5           loop058	push	bc
 216+ 9924 3A D7 A4     	ld	a,(DrvHDD.drvDevice)
 217+ 9927 E6 FC        	and	#FC
 218+ 9929 05           	dec	b
 219+ 992A B0           	or	b
 220+ 992B 6F           	ld	l,a			; ࠧ
 221+ 992C CD C4 AE     	call	DrvFAT.GetAdrMFSorFAT
 222+ 992F C1            	pop	bc
 223+ 9930 38 09        	jr	c,goto104		;訡 ⥭/ ࠧ  
 224+ 9932 FE 53        	cp	#53
 225+ 9934              	IFNDEF	useMFS
 226+ 9934 28 09        	jr	z,goto329
 227+ 9936              	ENDIF
 228+ 9936 CB 11        	rl	c
 229+ 9938 37           	scf
 230+ 9939 18 06        	jr	goto105
 231+ 993B FE 6D        goto104	cp	DrvFAT.errInvalidPart
 232+ 993D 20 0B        	jr	nz,goto092		;訡 ⥭/  MBR
 233+ 993F CB 11        goto329	rl	c
 234+ 9941 CB 11        goto105	rl	c
 235+ 9943 10 DE        	djnz	loop058
 236+ 9945 79           	ld	a,c
 237+ 9946 B7           	or	a
 238+ 9947 C0           	ret	nz
 239+ 9948 3E 6D        	ld	a,DrvFAT.errInvalidPart
 240+ 994A 37           goto092	scf
 241+ 994B C9           	ret
 242+ 994C
# file closed: Drivers/InitHDD/init.a80
5241  994C              		include "Drivers/InitHDD/init2.a80"
# file opened: Drivers/InitHDD/init2.a80
   1+ 994C                         ;!!冷  !!  2 ६
   2+ 994C              typeCat
   3+ 994C              ;	   db 0 ;1 ⨯ ⠫ ( ᯮ짮  )
   4+ 994C              		;=#00 롮 ᪮
   5+ 994C              		;=#01 롮 䠩  FDD
   6+ 994C              		;=#02 롮 䠩  .trd 䠩 FAT ࠧ
   7+ 994C              		;=#03 롮 䠩  ࠧ ࠧ MFS
   8+ 994C              		;=#04 롮 䠩  FAT ࠧ
   9+ 994C              		;=#05 롮 ࠧ ࠧ MFS
  10+ 994C              		;=#06 롮 ࠧ ᪠  ࠧ MFS
  11+ 994C              		;=#07 롮 䠩  ⠫ WiFi
  12+ 994C              		;=#08 롮 䠩  ࠧ ⠫ WiFi
  13+ 994C              		;7,=1  樨: 롮 ᪮
  14+ 994C
  15+ 994C              curDrive
  16+ 994C              ;	   db 0	;1 ⥪饥 ன⢮ ( ⥪饣 ன⢠)
  17+ 994C              		;=0..3 fdd
  18+ 994C              		;=4 tape
  19+ 994C              		;=5..n  ࠧ  ᯨ᪥ typeDrive
  20+ 994C
  21+ 994C 00 00 00...  typeDrive  ds 28;28 ᯨ᮪ 㯭 ࠧ  
  22+ 9968 00 00 00 00             ds 4 ;4 ᯨ᮪ 㯭 ࠧ  SD 
  23+ 996C              		;7,=0/1 ⨯ ࠧ MFS/FAT
  24+ 996C              		;6,=1 ࠧ 
  25+ 996C              		;5-3,=???  ன⢠: =000 SMUC v2
  26+ 996C              		;                           =001 SMUC v1
  27+ 996C              		;                           =010 Nemo
  28+ 996C              		;                           =011 Nemo A8
  29+ 996C              		;                           =100 ATM IDE
  30+ 996C              		;                           =101 IDE ???   ᯮ
  31+ 996C              		;                           =110 SD ZC
  32+ 996C              		;                           =111 SD ??   ᯮ
  33+ 996C              		;2,=0/1 hdd master/slave
  34+ 996C              		;0..1,=??  ࠧ
  35+ 996C
  36+ 996C 00 00        numDrives    dw 0		;2 ⢮ ன
  37+ 996E
# file closed: Drivers/InitHDD/init2.a80
5242  996E              		include "Drivers/DrvHDD/DrvHDD.main.a80"
# file opened: Drivers/DrvHDD/DrvHDD.main.a80
   1+ 996E              ;ࠩ ࠡ  ஬
   2+ 996E              ;HDD Driver v1.00/v1.10
   3+ 996E              ;(c) 2023-2024 LW aka PLM
   4+ 996E              ;
   5+ 996E              ;Date Creating: 24.08.2023
   6+ 996E              ;Last   Update: 05.09.2024
   7+ 996E              ;Last  Edition: 07.09.2024
   8+ 996E              ;
   9+ 996E              ;:
  10+ 996E              ;DrvHDD.main.a80	-  䠩
  11+ 996E              ;DrvHDD.kernal1_00.a80	-  ᠭ ஫஢ IDE  v1.00
  12+ 996E              ;DrvHDD.kernal1_10.a80	-  ᠭ ஫஢ IDE  v1.10
  13+ 996E              ;DrvHDD.hdd.a80		- 楤  ࠡ  ⥫
  14+ 996E              ;DrvHDD.spi.a80		- 楤  ࠡ  ⠬ ஫஢ SD
  15+ 996E              ;DrvHDD.ide.a80		- 楤  ࠡ  ⠬ ஫஢ IDE
  16+ 996E              ;DrvHDD.calc.a80	- 楤  ⥬᪨ ⮢
  17+ 996E              ;DrvHDD.var1_00.a80	- ६  v1.00
  18+ 996E              ;DrvHDD.var1_10.a80	- ६  v1.10
  19+ 996E              ;DrvHDD.lua		- LUA
  20+ 996E              ;
  21+ 996E              ;------------------------------------------------------------------------------
  22+ 996E              ; 樨
  23+ 996E              	DEVICE 	ZXSPECTRUM128
  24+ 996E              	INCLUDE "DrvHDD.lua"
# file opened: Drivers/DrvHDD/DrvHDD.lua
   1++996E              	LUA
   2++996E ~
   3++996E ~            	local nameflog = "DrvHDD.lua.info"
   4++996E ~            	local flog = nil
   5++996E ~            	local blname={}
   6++996E ~            	blname[1] ="DrvHDD.Start"
   7++996E ~            	blname[2] ="DrvHDD.End"
   8++996E ~
   9++996E ~            	if flog==nil then flog=io.open(nameflog,"w") end
  10++996E ~
  11++996E ~            	plen = sj.get_label(blname[1])
  12++996E ~            	flog:write(" 砫 Drv Hdd","\t"," = ",string.format('0x%04X', plen)," = ",plen,"\n")
  13++996E ~
  14++996E ~            	plen = sj.get_label(blname[2]) - sj.get_label(blname[1])
  15++996E ~            	flog:write("  ࠩ","\t"," = ",string.format('0x%04X', plen)," = ",plen,"\n")
  16++996E ~
  17++996E ~            	flog:flush ()
  18++996E ~
  19++996E              	ENDLUA
  20++996E
  21++996E
# file closed: Drivers/DrvHDD/DrvHDD.lua
  25+ 996E              ;	PAGE	#XX
  26+ 996E              	MODULE	DrvHDD
  27+ 996E
  28+ 996E              ;------------------------------------------------------------------------------
  29+ 996E              ;᫮ ࠭樨
  30+ 996E
  31+ 996E              	DEFINE	ver1_10		;ᡮઠ ᨨ 1.10
  32+ 996E              ;	DEFINE	ver1_00		;ᡮઠ ᨨ 1.00
  33+ 996E              	DEFINE	DrvHddExtVars	;६ ࠭  ࠩ
  34+ 996E              	DEFINE	AllDevice	;ᯮ짮  ஫
  35+ 996E              	DEFINE	SMUCv2		;প SMUC v2
  36+ 996E              	DEFINE	SMUCv1		;প SMUC v1 (१ ⥭ )
  37+ 996E              	DEFINE	NemoStd		;প NEMO
  38+ 996E              	DEFINE	NemoA8		;প NEMO A8
  39+ 996E              	DEFINE	ATMide		;প ATM-IDE
  40+ 996E              	DEFINE	PROFIide	;প PROFI-IDE
  41+ 996E              	DEFINE	ZC		;প Z-Controller
  42+ 996E              	DEFINE	DivMMC		;প DivMMC
  43+ 996E              	DEFINE	MultiRW		;⥭ 㯯 ᥪ஢
  44+ 996E              	DEFINE	LBA32		;প LBA32 樨
  45+ 996E              	DEFINE	offCACHE	;⪫ 
  46+ 996E              ;	DEFINE	scrATM80x25	;⥪⮢ ࠭ ATM
  47+ 996E              	DEFINE	scrATMstd	;⠭ ࠭ ATM
  48+ 996E              ;	DEFINE	onlyRead	;⮫쪮 ⥭
  49+ 996E              ;	DEFINE	noTestTrDos	; ஢ 稥  Tr-Dos 楤 ⥭/    SMUC
  50+ 996E              ;	DEFINE	openDOS		;⥭  
  51+ 996E              ;	DEFINE	forGMXloader	; 稪 GMX
  52+ 996E
  53+ 996E              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  54+ 996E              ;४ ᫮ ࠭樨  ᨬ  
  55+ 996E              	IFDEF	AllDevice
  56+ 996E              	 IFNDEF	SMUCv2		;প SMUC v2
  57+ 996E ~            	 DEFINE	SMUCv2		;প SMUC v2
  58+ 996E              	 ENDIF
  59+ 996E              	 IFNDEF	SMUCv1		;প SMUC v1 (१ ⥭ )
  60+ 996E ~            	 DEFINE	SMUCv1		;প SMUC v1 (१ ⥭ )
  61+ 996E              	 ENDIF
  62+ 996E              	 IFNDEF	NemoStd		;প NEMO
  63+ 996E ~            	 DEFINE	NemoStd		;প NEMO
  64+ 996E              	 ENDIF
  65+ 996E              	 IFNDEF	NemoA8		;প NEMO A8
  66+ 996E ~            	 DEFINE	NemoA8		;প NEMO A8
  67+ 996E              	 ENDIF
  68+ 996E              	 IFNDEF	ATMide		;প ATM-IDE
  69+ 996E ~            	 DEFINE	ATMide		;প ATM-IDE
  70+ 996E              	 ENDIF
  71+ 996E              	 IFNDEF	PROFIide	;প PROFI-IDE
  72+ 996E ~            	 DEFINE	PROFIide	;প PROFI-IDE
  73+ 996E              	 ENDIF
  74+ 996E              	 IFNDEF	ZC		;প Z-Controller
  75+ 996E ~            	 DEFINE	ZC		;প Z-Controller
  76+ 996E              	 ENDIF
  77+ 996E              	 IFNDEF	DivMMC		;প DivMMC
  78+ 996E ~            	 DEFINE	DivMMC		;প DivMMC
  79+ 996E              	 ENDIF
  80+ 996E              	ENDIF
  81+ 996E              	IFDEF	SMUCv1
  82+ 996E              	 IFNDEF	SMUC
  83+ 996E              	 DEFINE	SMUC
  84+ 996E              	 ENDIF
  85+ 996E              	ENDIF
  86+ 996E              	IFDEF	SMUCv2
  87+ 996E              	 IFNDEF	SMUC
  88+ 996E ~            	 DEFINE	SMUC
  89+ 996E              	 ENDIF
  90+ 996E              	ENDIF
  91+ 996E              	IFDEF	NemoStd
  92+ 996E              	 IFNDEF	NEMO
  93+ 996E              	 DEFINE	NEMO
  94+ 996E              	 ENDIF
  95+ 996E              	ENDIF
  96+ 996E              	IFDEF	NemoA8
  97+ 996E              	 IFNDEF	NEMO
  98+ 996E ~            	 DEFINE	NEMO
  99+ 996E              	 ENDIF
 100+ 996E              	ENDIF
 101+ 996E              	IFDEF	PROFIide
 102+ 996E              	 IFDEF	MultiRW
 103+ 996E              	 UNDEFINE MultiRW
 104+ 996E              	 ENDIF
 105+ 996E              	ENDIF
 106+ 996E              	IFDEF	ZC
 107+ 996E              	 IFNDEF	LBA32
 108+ 996E ~            	 DEFINE	LBA32		;প LBA32 ॠ樨
 109+ 996E              	 ENDIF
 110+ 996E              	 IFNDEF	SDcard
 111+ 996E              	 DEFINE	SDcard
 112+ 996E              	 ENDIF
 113+ 996E              	ENDIF
 114+ 996E              	IFDEF	DivMMC
 115+ 996E              	 IFNDEF	LBA32
 116+ 996E ~            	 DEFINE	LBA32		;প LBA32 ॠ樨
 117+ 996E              	 ENDIF
 118+ 996E              	 IFNDEF	SDcard
 119+ 996E ~            	 DEFINE	SDcard
 120+ 996E              	 ENDIF
 121+ 996E              	ENDIF
 122+ 996E
 123+ 996E              ;------------------------------------------------------------------------------
 124+ 996E              ;⠭ ࠩ
 125+ 996E
 126+ 996E              ;ﭨ  #DFFD  祭/몫祭 ⮢ PROFI IDE
 127+ 996E              baseDFFDon	equ	%00100000	; 祭
 128+ 996E              baseDFFDoff	equ	%00000000	; 몫祭
 129+ 996E
 130+ 996E              		IFDEF	scrATM80x25
 131+ 996E ~            atmXX77		 equ	%00000110	; ⥪⮢ ࠭ 80x25
 132+ 996E              		ENDIF
 133+ 996E              		IFDEF	scrATMstd
 134+ 996E              atmXX77		 equ	%00000011	; ⠭⭮ ࠭
 135+ 996E              		ENDIF
 136+ 996E
 137+ 996E              ;------------------------------------------------------------------------------
 138+ 996E              ;譨 ६
 139+ 996E
 140+ 996E              ;䫠 譥 ணࠬ
 141+ 996E              ;5,=1 ஢     SD
 142+ 996E              ;
 143+ 996E              ExtFlags	equ _ExtFlags ;#XXXX
 144+ 996E
 145+ 996E              ;⠩ 
 146+ 996E              busyTimeOut	equ #20;#4FD3
 147+ 996E              cmdTimeOut	equ #10;#14E6
 148+ 996E              dataTimeOut	equ #80;#C350
 149+ 996E
 150+ 996E              ;᫨  ᫮ DrvHddExtVars
 151+ 996E              ;	IFDEF	DrvHddExtVars
 152+ 996E              ;msSMUC	 equ	0	;SMUC master
 153+ 996E              ;slSMUC	 equ	0	;SMUC slave
 154+ 996E              ;msNemo	 equ	0	;Nemo master
 155+ 996E              ;slNemo	 equ	0	;Nemo slave
 156+ 996E              ;msATM	 equ	0	;ATM IDE master
 157+ 996E              ;slATM	 equ	0	;ATM IDE slave
 158+ 996E              ;msPROFI	 equ	0	;PROFI IDE master
 159+ 996E              ;slPROFI	 equ	0	;PROFI IDE slave
 160+ 996E              ;cardZC	 equ	0	;ZC SD 
 161+ 996E              ;mDivMMC	 equ	0	;DivMMC master
 162+ 996E              ;sDivMMC	 equ	0	;DivMMC slave
 163+ 996E              ;	ENDIF
 164+ 996E
 165+ 996E              ;᫨  ᫮ DrvHddExtVars
 166+ 996E                IFDEF  DrvHddExtVars
 167+ 996E              msSMUC  equ  _msSMUC  ;SMUC master
 168+ 996E              slSMUC  equ  _slSMUC  ;SMUC slave
 169+ 996E              msNemo  equ  _msNemo  ;Nemo master
 170+ 996E              slNemo  equ  _slNemo  ;Nemo slave
 171+ 996E              msATM  equ  _msATM  ;ATM IDE master
 172+ 996E              slATM  equ  _slATM  ;ATM IDE slave
 173+ 996E              msPROFI  equ  _msPROFI;PROFI IDE master
 174+ 996E              slPROFI  equ  _msPROFI;PROFI IDE slave
 175+ 996E              cardZC  equ  _cardZC  ;ZC SD 
 176+ 996E              mDivMMC  equ  _mDivMMC;DivMMC master
 177+ 996E              sDivMMC  equ  _sDivMMC;DivMMC slave
 178+ 996E                ENDIF
 179+ 996E
 180+ 996E              ;------------------------------------------------------------------------------
 181+ 996E              ;⠭ ࠩ
 182+ 996E
 183+ 996E              ; ᥬ஢:
 184+ 996E              AdrDrvBegin	equ $
 185+ 996E
 186+ 996E              ;ࠧ 
 187+ 996E              BufSecHdd	equ _BufSecHdd ;#XXXX	;  㧪/ ᥪ
 188+ 996E              Buf4MBR		equ BufSecHdd	;  㧪 ᥪ MBR
 189+ 996E
 190+ 996E              ; 楤  Tr-Dos  SMUC
 191+ 996E              dosOutPort equ	#3FF0		; 楤     SMUC v1
 192+ 996E              dosInPort  equ	#3FF3		; 楤 ⥭   SMUC v1
 193+ 996E
 194+ 996E              ; 訡
 195+ 996E              errOK		equ #00
 196+ 996E              errNumTooBig	equ #11 ;number too big
 197+ 996E              errInvFileName	equ #45 ;invalid file name
 198+ 996E              errFileNotFound	equ #48 ;file not found
 199+ 996E              errDiskNoSpace	equ #49	;disk no space
 200+ 996E              errRWnum	equ #50 ;R/W error _᫮_
 201+ 996E              errHddNotFound	equ #56 ;hard disk not found
 202+ 996E              errHddRWerror	equ #57 ;hard disk R/W error #nnnn
 203+ 996E              errHddBusy	equ #60 ;busy not found
 204+ 996E              errHddNotReady	equ #61 ;hard disk not ready
 205+ 996E              errHddNotData	equ #62 ;hard disk data not ready
 206+ 996E              errInvPartMg	equ #63 ;invalid partition manager
 207+ 996E              errPartNotFound	equ #66 ;partition not found
 208+ 996E              errInvalidPart	equ #6D ;invalid partition
 209+ 996E              errNoMBR	equ #6E ;MBR not found
 210+ 996E              errInvalidFile	equ #70 ;invalid file
 211+ 996E              errEoF		equ #71 ;end of file
 212+ 996E              errPathEmpty	equ #72 ;path empty
 213+ 996E              errFileExist	equ #73 ;file exist
 214+ 996E              errDirNotEmpty	equ #74 ;dir not empty
 215+ 996E              errFileEmpty	equ #75 ;file empty
 216+ 996E
 217+ 996E              ;------------------------------------------------------------------------------
 218+ 996E
 219+ 996E              	ORG		AdrDrvBegin
 220+ 996E              Start
 221+ 996E              	IFDEF		ver1_10
 222+ 996E              	 INCLUDE	"DrvHDD.kernal1_10.a80"
# file opened: Drivers/DrvHDD/DrvHDD.kernal1_10.a80
   1++996E              ;६ HDD Driver
   2++996E              ;䠩 DrvHDD.var.a80
   3++996E              ;
   4++996E              ;hddSetDevice		⠭ ⥪騬 ன⢠
   5++996E              ;devSetVars		⠭ ६ ࠭  Master/Slave
   6++996E              ;devSetDevice		⠭ ୠ  ஫
   7++996E              ;
   8++996E              ;------------------------------------------------------------------------------
   9++996E              hddSetDevice	ifused
  10++996E              ;⠭ ⥪騬 ன⢠
  11++996E              ;:  a -  ⥪饣 ஫   ( ଠ PartitionNum)
  12++996E              ;: cy=0
  13++996E              ;
  14++996E              ;hddSetDevice
  15++996E              ;
  16++996E E5           	push	hl
  17++996F F5           	push	af
  18++9970 D5           	push	de
  19++9971 C5           	push	bc
  20++9972
  21++9972              ;஢ઠ ⥪饣 ன⢠
  22++9972 2A D7 A4     	ld	hl,(drvDevice)
  23++9975 67           	ld	h,a
  24++9976 AD           	xor	l
  25++9977 E6 3C        	and	%00111100
  26++9979 28 28        	jr	z,goto065
  27++997B
  28++997B              ;⠭ ६
  29++997B E6 38        	and	%00111000
  30++997D 7C           	ld	a,h
  31++997E 32 D7 A4     	ld	(drvDevice),a
  32++9981 C4 C2 99     	call	nz,devSetDevice
  33++9984 18 04        	jr	goto066
  34++9986 18 FE        	jr	devSetVars
  35++9988              	org	$-2
  36++9986
  37++9986              	endif
  38++9986
  39++9986              ;------------------------------------------------------------------------------
  40++9986              devSetVars	ifused
  41++9986              ;⠭ ६ ࠭ ன⢠
  42++9986              ;:  5-2,(drvDevice) -  ஫  ன⢠  
  43++9986              ;: cy=0
  44++9986              ;
  45++9986              ;devSetVars
  46++9986              ;
  47++9986 E5           	push	hl
  48++9987 F5           	push	af
  49++9988 D5           	push	de
  50++9989 C5           	push	bc
  51++998A
  52++998A              ;㥬 ६
  53++998A 3A D7 A4     goto066	ld	a,(drvDevice)
  54++998D 0F           	rrca
  55++998E E6 1E        	and	#1E
  56++9990 5F           	ld	e,a
  57++9991 16 00        	ld	d,#00
  58++9993 21 F1 A4     	ld	hl,tblDev
  59++9996 19           	add	hl,de
  60++9997 5E           	ld	e,(hl)
  61++9998 23           	inc	hl
  62++9999 56           	ld	d,(hl)
  63++999A EB           	ex	de,hl
  64++999B 11 E6 A4     	ld	de,CurrentDev
  65++999E 01 0B 00     	ld	bc,EndCurrentDev-CurrentDev
  66++99A1 ED B0        	ldir
  67++99A3
  68++99A3              ;⠭ 祭   1F6
  69++99A3 3A F0 A4     goto065	ld	a,(devFlags)
  70++99A6 E6 50        	and	%01010000
  71++99A8 F6 A0        	or	%10100000
  72++99AA 32 DD A4     	ld	(idePort1F6),a
  73++99AD
  74++99AD              ;⠭ master/slave  DivMMC
  75++99AD              	IFDEF	DivMMC
  76++99AD 3A D7 A4     	 ld	a,(drvDevice)
  77++99B0 E6 3C        	 and	%00111100
  78++99B2 FE 38        	 cp	#38
  79++99B4 38 35        	 jr	c,goto064
  80++99B6 E6 04        	 and	%00000100
  81++99B8 3E FE        	 ld	a,%11111110		;=#FE
  82++99BA 28 01        	 jr	z,goto067
  83++99BC 07           	 rlca				;=#FD
  84++99BD 32 10 9A     goto067	 ld	(kPortCSlow),a
  85++99C0              	ENDIF
  86++99C0 18 29        	jr	goto064
  87++99C2 18 FE        	jr	devSetDevice
  88++99C4              	org	$-2
  89++99C2
  90++99C2              	endif
  91++99C2
  92++99C2              ;------------------------------------------------------------------------------
  93++99C2              devSetDevice	ifused
  94++99C2              ;⠭ ୠ  ஫
  95++99C2              ;:  5-3,(drvDevice) -  ஫
  96++99C2              ;: cy=0
  97++99C2              ;
  98++99C2              ;devSetDevice
  99++99C2              ;
 100++99C2 E5           	push	hl
 101++99C3 F5           	push	af
 102++99C4 D5           	push	de
 103++99C5 C5           	push	bc
 104++99C6 CD 09 9A     	call	kPortsOff		;⪫稬 ।騩
 105++99C9 21 1E 9A     	ld	hl,devKernals
 106++99CC 01 2D 00     	ld	bc,endKernal-startKernal
 107++99CF 1E FF        	ld	e,devMask
 108++99D1 3A D7 A4     	ld	a,(drvDevice)
 109++99D4 0F           	rrca
 110++99D5 0F           	rrca
 111++99D6 0F           	rrca
 112++99D7 E6 07        	and	#07
 113++99D9 28 08        	jr	z,goto062
 114++99DB CB 1B        loop024	rr	e
 115++99DD 30 01        	jr	nc,goto063
 116++99DF 09           	add	hl,bc
 117++99E0 3D           goto063	dec	a
 118++99E1 20 F8        	jr	nz,loop024
 119++99E3 11 F1 99     goto062	ld	de,startKernal
 120++99E6 ED B0        	ldir
 121++99E8 CD 06 9A     	call	kPortsOn
 122++99EB C1           goto064	pop	bc
 123++99EC D1           	pop	de
 124++99ED F1           	pop	af
 125++99EE E1           	pop	hl
 126++99EF B7           	or	a
 127++99F0 C9           	ret
 128++99F1
 129++99F1              	endif
 130++99F1
 131++99F1              ;------------------------------------------------------------------------------
 132++99F1              ;⪫祭 
 133++99F1              	MACRO	noCache
 134++99F1 ~            	 IFDEF	offCACHE
 135++99F1 ~            	  in	a,(#7B)
 136++99F1 ~            	  ret
 137++99F1 ~            	 ELSE
 138++99F1 ~            	  or	a
 139++99F1 ~            	  ret
 140++99F1 ~            	  nop
 141++99F1 ~            	 ENDIF
 142++99F1              	ENDM
 143++99F1
 144++99F1              ;------------------------------------------------------------------------------
 145++99F1              ; 㭪
 146++99F1              	MACRO	NoFunct
 147++99F1 ~            	 or	a
 148++99F1 ~            	 ret
 149++99F1 ~            	 nop
 150++99F1              	ENDM
 151++99F1
 152++99F1              ;------------------------------------------------------------------------------
 153++99F1              ;ୠ    ࠡ  ஫஬ IDE
 154++99F1              ; 45 
 155++99F1              ;
 156++99F1              startKernal
 157++99F1              ;
 158++99F1              kHddTestInit	NoFunct		;+#00 0 ஢ઠ ⢮ 
 158++99F1 B7          >	 or	a
 158++99F2 C9          >	 ret
 158++99F3 00          >	 nop
 159++99F4              kOut_C_A	NoFunct		;+#03 1   
 159++99F4 B7          >	 or	a
 159++99F5 C9          >	 ret
 159++99F6 00          >	 nop
 160++99F7              kIn_A_C		NoFunct		;+#06 2 ⥭ 
 160++99F7 B7          >	 or	a
 160++99F8 C9          >	 ret
 160++99F9 00          >	 nop
 161++99FA              kHddWriteData	NoFunct		;+#09 3  ᥪ
 161++99FA B7          >	 or	a
 161++99FB C9          >	 ret
 161++99FC 00          >	 nop
 162++99FD              kHddReadData	NoFunct		;+#0C 4 ⥭ ᥪ
 162++99FD B7          >	 or	a
 162++99FE C9          >	 ret
 162++99FF 00          >	 nop
 163++9A00              kHddReset	NoFunct		;+#0F 5  
 163++9A00 B7          >	 or	a
 163++9A01 C9          >	 ret
 163++9A02 00          >	 nop
 164++9A03              kHddCheck	NoFunct		;+#12 6 ஢ઠ 祪 室  tr-dos  smuc v1
 164++9A03 B7          >	 or	a
 164++9A04 C9          >	 ret
 164++9A05 00          >	 nop
 165++9A06              kPortsOn	NoFunct		;+#15 7 祭 ⮢ ( ATM)
 165++9A06 B7          >	 or	a
 165++9A07 C9          >	 ret
 165++9A08 00          >	 nop
 166++9A09              kPortsOff	NoFunct		;+#18 8 ⪫祭 ⮢ ( ATM)
 166++9A09 B7          >	 or	a
 166++9A0A C9          >	 ret
 166++9A0B 00          >	 nop
 167++9A0C
 168++9A0C              kPortCONF			;+#nn   䨣樨  SD 
 169++9A0C 00 00        kPort1F0	dw	0	;+#nn   #1F0
 170++9A0E              kPortDATA			;+#nn     SD 
 171++9A0E 00 00        kPort1F1	dw	0	;+#nn   #1F1
 172++9A10              kPortCSlow
 173++9A10 00 00        kPort1F2	dw	0	;+#nn   #1F2
 174++9A12              kPortCSHigh
 175++9A12 00 00        kPort1F3	dw	0	;+#nn   #1F3
 176++9A14 00 00        kPort1F4	dw	0	;+#nn   #1F4
 177++9A16 00 00        kPort1F5	dw	0	;+#nn   #1F5
 178++9A18 00 00        kPort1F6	dw	0	;+#nn   #1F6
 179++9A1A 00 00        kPort1F7	dw	0	;+#nn   #1F7
 180++9A1C 00 00        kPort3F6	dw	0	;+#nn   #3F6
 181++9A1E              endKernal
 182++9A1E
 183++9A1E              ;------------------------------------------------------------------------------
 184++9A1E              ;ୠ  ࠡ  ஫ࠬ
 185++9A1E              ;冷 ᯮ  
 186++9A1E              ;
 187++9A1E              devKernals
 188++9A1E              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 189++9A1E              ;ୠ  ࠡ  SMUC v2
 190++9A1E              		IFDEF	SMUCv2
 191++9A1E C3 1D 9C     ideSMUCv2	 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 192++9A21 ED 79        		 out	(c),a		;1   
 193++9A23 C9           		 ret
 194++9A24 ED 78        		 in	a,(c)		;2 ⥭ 
 195++9A26 C9           		 ret
 196++9A27              		 IFDEF	onlyRead
 197++9A27 ~            		  NoFunct
 198++9A27              		 ELSE
 199++9A27 C3 ED A2     		  jp	hddWriteDataSv2	;3  ᥪ
 200++9A2A              		 ENDIF
 201++9A2A C3 2C A2     		 jp	hddReadDataSv2	;4 ⥭ ᥪ
 202++9A2D C3 8A A1     		 jp	hddResetSmuc	;5  
 203++9A30              		 NoFunct		;6 誠
 203++9A30 B7          >	 or	a
 203++9A31 C9          >	 ret
 203++9A32 00          >	 nop
 204++9A33              		 IFDEF	forGMXloader
 205++9A33 ~            		  jp	Rom0ld.hddOpenDOS
 206++9A33 ~            		  jp	Rom0ld.hddCloseDOS
 207++9A33              		 ELSE
 208++9A33              		  NoFunct		;7 誠
 208++9A33 B7          >	 or	a
 208++9A34 C9          >	 ret
 208++9A35 00          >	 nop
 209++9A36              		  NoFunct		;8 誠
 209++9A36 B7          >	 or	a
 209++9A37 C9          >	 ret
 209++9A38 00          >	 nop
 210++9A39              		 ENDIF
 211++9A39 BE F8        		 dw	#F8BE		;  #1F0
 212++9A3B BE F9        		 dw	#F9BE		;  #1F1
 213++9A3D BE FA        		 dw	#FABE		;  #1F2
 214++9A3F BE FB        		 dw	#FBBE		;  #1F3
 215++9A41 BE FC        		 dw	#FCBE		;  #1F4
 216++9A43 BE FD        		 dw	#FDBE		;  #1F5
 217++9A45 BE FE        		 dw	#FEBE		;  #1F6
 218++9A47 BE FF        		 dw	#FFBE		;  #1F7
 219++9A49 BE FE        		 dw	#FEBE		;  #3F6
 220++9A4B              		ENDIF
 221++9A4B
 222++9A4B              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 223++9A4B              ;ୠ  ࠡ  SMUC v1 ( ⥭묨 ⠬)
 224++9A4B              		IFDEF	SMUCv1
 225++9A4B C3 1D 9C     ideSMUCv1	 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 226++9A4E C3 14 A4     		 jp	out_C_A		;1   
 227++9A51 C3 23 A4     		 jp	in_A_C		;2 ⥭ 
 228++9A54              		 IFDEF	onlyRead
 229++9A54 ~            		  NoFunct
 230++9A54              		 ELSE
 231++9A54 C3 79 A2     		  jp	hddWriteDataSv1	;3  ᥪ
 232++9A57              		 ENDIF
 233++9A57 C3 C2 A1     		 jp	hddReadDataSv1	;4 ⥭ ᥪ
 234++9A5A C3 8A A1     		 jp	hddResetSmuc	;5  
 235++9A5D              		 IFDEF	noTestTrDos
 236++9A5D ~            		  NoFunct		;6 誠
 237++9A5D              		 ELSE
 238++9A5D C3 C6 A3     		  jp	smucTest3FF0	;6 ஢ઠ 祪 室
 239++9A60              		 ENDIF
 240++9A60              		 NoFunct		;7 誠
 240++9A60 B7          >	 or	a
 240++9A61 C9          >	 ret
 240++9A62 00          >	 nop
 241++9A63              		 NoFunct		;8 誠
 241++9A63 B7          >	 or	a
 241++9A64 C9          >	 ret
 241++9A65 00          >	 nop
 242++9A66 BE F8        		 dw	#F8BE		;  #1F0
 243++9A68 BE F9        		 dw	#F9BE		;  #1F1
 244++9A6A BE FA        		 dw	#FABE		;  #1F2
 245++9A6C BE FB        		 dw	#FBBE		;  #1F3
 246++9A6E BE FC        		 dw	#FCBE		;  #1F4
 247++9A70 BE FD        		 dw	#FDBE		;  #1F5
 248++9A72 BE FE        		 dw	#FEBE		;  #1F6
 249++9A74 BE FF        		 dw	#FFBE		;  #1F7
 250++9A76 BE FE        		 dw	#FEBE		;  #3F6
 251++9A78              		ENDIF
 252++9A78
 253++9A78              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 254++9A78              ;ୠ  ࠡ  NEMO
 255++9A78              		IFDEF	NemoStd
 256++9A78 C3 1D 9C     ideNemo		 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 257++9A7B ED 79        		 out	(c),a		;1   
 258++9A7D C9           		 ret
 259++9A7E ED 78        		 in	a,(c)		;2 ⥭ 
 260++9A80 C9           		 ret
 261++9A81              		 IFDEF	onlyRead
 262++9A81 ~            		  NoFunct
 263++9A81              		 ELSE
 264++9A81 C3 03 A3     		  jp	hddWriteDataN	;3  ᥪ
 265++9A84              		 ENDIF
 266++9A84 C3 40 A2     		 jp	hddReadDataN	;4 ⥭ ᥪ
 267++9A87 C3 AD A1     		 jp	hddResetNemo	;5  
 268++9A8A              		 NoFunct		;6 誠
 268++9A8A B7          >	 or	a
 268++9A8B C9          >	 ret
 268++9A8C 00          >	 nop
 269++9A8D              		 NoFunct		;7 誠
 269++9A8D B7          >	 or	a
 269++9A8E C9          >	 ret
 269++9A8F 00          >	 nop
 270++9A90              		 noCache		;8 誠/⪫ 
 270++9A90             >	 IFDEF	offCACHE
 270++9A90 DB 7B       >	  in	a,(#7B)
 270++9A92 C9          >	  ret
 270++9A93             >	 ELSE
 270++9A93 ~           >	  or	a
 270++9A93 ~           >	  ret
 270++9A93 ~           >	  nop
 270++9A93             >	 ENDIF
 271++9A93 10 FF        		 dw	#FF10		;  #1F0
 272++9A95 30 FF        		 dw	#FF30		;  #1F1
 273++9A97 50 FF        		 dw	#FF50		;  #1F2
 274++9A99 70 FF        		 dw	#FF70		;  #1F3
 275++9A9B 90 FF        		 dw	#FF90		;  #1F4
 276++9A9D B0 FF        		 dw	#FFB0		;  #1F5
 277++9A9F D0 FF        		 dw	#FFD0		;  #1F6
 278++9AA1 F0 FF        		 dw	#FFF0		;  #1F7
 279++9AA3 C8 FF        		 dw	#FFC8		;  #3F6
 280++9AA5              		ENDIF
 281++9AA5
 282++9AA5              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 283++9AA5              ;ୠ  ࠡ  NEMO A8
 284++9AA5              		IFDEF	NemoA8
 285++9AA5 C3 1D 9C     ideNemoA8	 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 286++9AA8 ED 79        		 out	(c),a		;1   
 287++9AAA C9           		 ret
 288++9AAB ED 78        		 in	a,(c)		;2 ⥭ 
 289++9AAD C9           		 ret
 290++9AAE              		 IFDEF	onlyRead
 291++9AAE ~            		  NoFunct
 292++9AAE              		 ELSE
 293++9AAE C3 19 A3     		  jp	hddWriteDataNA8	;3  ᥪ
 294++9AB1              		 ENDIF
 295++9AB1 C3 54 A2     		 jp	hddReadDataNA8	;4 ⥭ ᥪ
 296++9AB4 C3 AD A1     		 jp	hddResetNemo	;5  
 297++9AB7              		 NoFunct		;6 誠
 297++9AB7 B7          >	 or	a
 297++9AB8 C9          >	 ret
 297++9AB9 00          >	 nop
 298++9ABA              		 NoFunct		;7 誠
 298++9ABA B7          >	 or	a
 298++9ABB C9          >	 ret
 298++9ABC 00          >	 nop
 299++9ABD              		 noCache		;8 誠/⪫ 
 299++9ABD             >	 IFDEF	offCACHE
 299++9ABD DB 7B       >	  in	a,(#7B)
 299++9ABF C9          >	  ret
 299++9AC0             >	 ELSE
 299++9AC0 ~           >	  or	a
 299++9AC0 ~           >	  ret
 299++9AC0 ~           >	  nop
 299++9AC0             >	 ENDIF
 300++9AC0 10 FE        		 dw	#FE10		;  #1F0
 301++9AC2 30 FE        		 dw	#FE30		;  #1F1
 302++9AC4 50 FE        		 dw	#FE50		;  #1F2
 303++9AC6 70 FE        		 dw	#FE70		;  #1F3
 304++9AC8 90 FE        		 dw	#FE90		;  #1F4
 305++9ACA B0 FE        		 dw	#FEB0		;  #1F5
 306++9ACC D0 FE        		 dw	#FED0		;  #1F6
 307++9ACE F0 FE        		 dw	#FEF0		;  #1F7
 308++9AD0 C8 FE        		 dw	#FEC8		;  #3F6
 309++9AD2              		ENDIF
 310++9AD2
 311++9AD2              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 312++9AD2              ;ୠ  ࠡ  ATM-IDE
 313++9AD2              		IFDEF	ATMide
 314++9AD2 C3 1D 9C     ideATM		 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 315++9AD5 ED 79        		 out	(c),a		;1   
 316++9AD7 C9           		 ret
 317++9AD8 ED 78        		 in	a,(c)		;2 ⥭ 
 318++9ADA C9           		 ret
 319++9ADB              		 IFDEF	onlyRead
 320++9ADB ~            		  NoFunct
 321++9ADB              		 ELSE
 322++9ADB C3 1D A3     		  jp	hddWriteDataAtm	;3  ᥪ
 323++9ADE              		 ENDIF
 324++9ADE C3 59 A2     		 jp	hddReadDataAtm	;4 ⥭ ᥪ
 325++9AE1              		 NoFunct		;5 誠 ( )
 325++9AE1 B7          >	 or	a
 325++9AE2 C9          >	 ret
 325++9AE3 00          >	 nop
 326++9AE4              		 NoFunct		;6 誠
 326++9AE4 B7          >	 or	a
 326++9AE5 C9          >	 ret
 326++9AE6 00          >	 nop
 327++9AE7 C3 06 A4     		 jp	atmPortsOn	;7 祭 ⮢ ATM
 328++9AEA C3 01 A4     		 jp	atmPortsOff	;8 몫祭 ⮢ ATM
 329++9AED 0F FE        		 dw	#FE0F		;  #1F0
 330++9AEF 2F FE        		 dw	#FE2F		;  #1F1
 331++9AF1 4F FE        		 dw	#FE4F		;  #1F2
 332++9AF3 6F FE        		 dw	#FE6F		;  #1F3
 333++9AF5 8F FE        		 dw	#FE8F		;  #1F4
 334++9AF7 AF FE        		 dw	#FEAF		;  #1F5
 335++9AF9 CF FE        		 dw	#FECF		;  #1F6
 336++9AFB EF FE        		 dw	#FEEF		;  #1F7
 337++9AFD FF FF        		 dw	#FFFF		;  #3F6 ()
 338++9AFF              		ENDIF
 339++9AFF
 340++9AFF              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 341++9AFF              ;ୠ  ࠡ  PROFIide
 342++9AFF              		IFDEF	PROFIide
 343++9AFF C3 1D 9C     idePROFI	 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 344++9B02 ED 79        		 out	(c),a		;1   
 345++9B04 C9           		 ret
 346++9B05 C3 1C A4     		 jp	in_A_C_profi	;2 ⥭ 
 347++9B08              		 IFDEF	onlyRead
 348++9B08 ~            		  NoFunct
 349++9B08              		 ELSE
 350++9B08 C3 30 A3     		  jp	hddWriteDataPrf	;3  ᥪ
 351++9B0B              		 ENDIF
 352++9B0B C3 64 A2     		 jp	hddReadDataPrf	;4 ⥭ ᥪ
 353++9B0E C3 AD A1     		 jp	hddResetNemo	;5  
 354++9B11              		 NoFunct		;6 誠
 354++9B11 B7          >	 or	a
 354++9B12 C9          >	 ret
 354++9B13 00          >	 nop
 355++9B14 C3 F8 A3     		 jp	profiPortsOn	;7 祭 ⮢ PROFI
 356++9B17 C3 F4 A3     		 jp	profiPortsOff	;8 몫祭 ⮢ PROFI
 357++9B1A CB FF        		 dw	#FFCB		;  #1F0
 358++9B1C EB 01        		 dw	#01EB		;  #1F1
 359++9B1E EB 02        		 dw	#02EB		;  #1F2
 360++9B20 EB 03        		 dw	#03EB		;  #1F3
 361++9B22 EB 04        		 dw	#04EB		;  #1F4
 362++9B24 EB 05        		 dw	#05EB		;  #1F5
 363++9B26 EB 06        		 dw	#06EB		;  #1F6
 364++9B28 EB 07        		 dw	#07EB		;  #1F7
 365++9B2A AB 06        		 dw	#06AB		;  #3F6
 366++9B2C ~            /*
 367++9B2C ~            		 dw	#F8EB		;  #1F0
 368++9B2C ~            		 dw	#F9EB		;  #1F1
 369++9B2C ~            		 dw	#FAEB		;  #1F2
 370++9B2C ~            		 dw	#FBEB		;  #1F3
 371++9B2C ~            		 dw	#FCEB		;  #1F4
 372++9B2C ~            		 dw	#FDEB		;  #1F5
 373++9B2C ~            		 dw	#FEEB		;  #1F6
 374++9B2C ~            		 dw	#FFEB		;  #1F7
 375++9B2C ~            		 dw	#00AB		;  #3F6
 376++9B2C ~            */
 377++9B2C              		ENDIF
 378++9B2C
 379++9B2C              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 380++9B2C              ;ୠ  ࠡ  Z-Controller
 381++9B2C              		IFDEF	ZC
 382++9B2C C3 75 9E     sdZC		 jp	sdTestInit	;0 樠 SD 
 383++9B2F ED 79        		 out	(c),a		;1   
 384++9B31 C9           		 ret
 385++9B32 ED 78        		 in	a,(c)		;2 ⥭ 
 386++9B34 C9           		 ret
 387++9B35              		 IFDEF	onlyRead
 388++9B35 ~            		  NoFunct
 389++9B35              		 ELSE
 390++9B35 C3 C1 9C     		  jp	sdWriteSecs_HL	;3  ᥪ/ ᥪ஢
 391++9B38              		 ENDIF
 392++9B38 C3 0F 9D     		 jp	sdReadSecs_HL	;4 ⥭ ᥪ/ ᥪ஢
 393++9B3B              		 NoFunct		;5 誠
 393++9B3B B7          >	 or	a
 393++9B3C C9          >	 ret
 393++9B3D 00          >	 nop
 394++9B3E              		 NoFunct		;6 誠
 394++9B3E B7          >	 or	a
 394++9B3F C9          >	 ret
 394++9B40 00          >	 nop
 395++9B41              		 NoFunct		;7 誠
 395++9B41 B7          >	 or	a
 395++9B42 C9          >	 ret
 395++9B43 00          >	 nop
 396++9B44              		 NoFunct		;8 誠
 396++9B44 B7          >	 or	a
 396++9B45 C9          >	 ret
 396++9B46 00          >	 nop
 397++9B47 77 00        		 dw	#0077		;  䨣樨  SD 
 398++9B49 57 00        		 dw	#0057		;    SD 
 399++9B4B 01 00        		 dw	#01		; ᯮ
 400++9B4D 03 00        		 dw	#03		; ᯮ
 401++9B4F 00 00        		 dw	0		; ᯮ
 402++9B51 00 00        		 dw	0		; ᯮ
 403++9B53 00 00        		 dw	0		; ᯮ
 404++9B55 00 00        		 dw	0		; ᯮ
 405++9B57 00 00        		 dw	0		; ᯮ
 406++9B59              		ENDIF
 407++9B59
 408++9B59              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 409++9B59              ;ୠ  ࠡ  DivMMC
 410++9B59              		IFDEF	DivMMC
 411++9B59 C3 75 9E     sdDivMMC	 jp	sdTestInit	;0 樠 SD 
 412++9B5C ED 79        		 out	(c),a		;1   
 413++9B5E C9           		 ret
 414++9B5F ED 78        		 in	a,(c)		;2 ⥭ 
 415++9B61 C9           		 ret
 416++9B62              		 IFDEF	onlyRead
 417++9B62 ~            		  NoFunct
 418++9B62              		 ELSE
 419++9B62 C3 C1 9C     		  jp	sdWriteSecs_HL	;3  ᥪ/ ᥪ஢
 420++9B65              		 ENDIF
 421++9B65 C3 0F 9D     		 jp	sdReadSecs_HL	;4 ⥭ ᥪ/ ᥪ஢
 422++9B68              		 NoFunct		;5 誠
 422++9B68 B7          >	 or	a
 422++9B69 C9          >	 ret
 422++9B6A 00          >	 nop
 423++9B6B              		 NoFunct		;6 誠
 423++9B6B B7          >	 or	a
 423++9B6C C9          >	 ret
 423++9B6D 00          >	 nop
 424++9B6E              		 NoFunct		;7 誠
 424++9B6E B7          >	 or	a
 424++9B6F C9          >	 ret
 424++9B70 00          >	 nop
 425++9B71              		 NoFunct		;8 誠
 425++9B71 B7          >	 or	a
 425++9B72 C9          >	 ret
 425++9B73 00          >	 nop
 426++9B74 E7 00        		 dw	#00E7		;  䨣樨  SD 
 427++9B76 EB 00        		 dw	#00EB		;    SD 
 428++9B78 FE 00        		 dw	#FE		; ᯮ
 429++9B7A FF 00        		 dw	#FF		; ᯮ
 430++9B7C 00 00        		 dw	0		; ᯮ
 431++9B7E 00 00        		 dw	0		; ᯮ
 432++9B80 00 00        		 dw	0		; ᯮ
 433++9B82 00 00        		 dw	0		; ᯮ
 434++9B84 00 00        		 dw	0		; ᯮ
 435++9B86              		ENDIF
 436++9B86
 437++9B86              ;==============================================================================
 438++9B86
# file closed: Drivers/DrvHDD/DrvHDD.kernal1_10.a80
 223+ 9B86              	ELSE
 224+ 9B86 ~            	 INCLUDE	"DrvHDD.kernal1_00.a80"
 225+ 9B86              	ENDIF
 226+ 9B86              	INCLUDE		"DrvHDD.hdd.a80"
# file opened: Drivers/DrvHDD/DrvHDD.hdd.a80
   1++9B86              ;楤  HDD Driver. 楤  ࠡ  ⥫
   2++9B86              ;䠩 DrvHDD.hdd.a80
   3++9B86              ;
   4++9B86              ;hddRdWrSectors		אַ ⥭/ 㯯 ᥪ஢  
   5++9B86              ;hddSendCmdRW		⠭ ॣ஢    
   6++9B86              ;			 ⥭/
   7++9B86              ;hddReadMBRsec		⥭ ᥪ MBR  
   8++9B86              ;RdSecHDD_DEHL		⥭ ᥪ     xE5A9
   9++9B86              ;RdSecHDD_IX		⥭ ᥪ     ix
  10++9B86              ;RdSecHDD_HL		⥭ ᥪ     HL
  11++9B86              ;RdSecHDD_buf		⥭ ᥪ     xE5A9
  12++9B86              ;WrSecHDD_DEHL		 ᥪ   xE5A9    
  13++9B86              ;			 dehl
  14++9B86              ;WrSecHDD_IX		 ᥪ   ix  
  15++9B86              ;WrSecHDD_buf		 ᥪ   xE5A9  
  16++9B86              ;WrSecHDD_HL		 ᥪ   HL  
  17++9B86              ;hddSetVarLBAadr	  ⠭  ६  LBA/CHS
  18++9B86              ;			 ᨬ  ஥
  19++9B86              ;hddHddIdent		䨪 ⥪饣 ⪮ ᪠
  20++9B86              ;
  21++9B86              ;------------------------------------------------------------------------------
  22++9B86              hddRdWrSectors	ifused
  23++9B86 ~            ;אַ ⥭/ 㯯 ᥪ஢  
  24++9B86 ~            ;:   ࢮ ᥪ   ⠭  ६
  25++9B86 ~            ;     hl -   ⥭
  26++9B86 ~            ;     b  - ⢮ ᥪ஢  ⥭
  27++9B86 ~            ;     cy=0/1 - ⥭/
  28++9B86 ~            ;     (AdrLBA32) - LBA  ࢮ ᥪ
  29++9B86 ~            ;: cy=1 訡 ⥭/
  30++9B86 ~            ;       a=#57 -  訡 ࠩ
  31++9B86 ~            ;       a=#60 busy not found
  32++9B86 ~            ;       a=#61 hard disk not ready
  33++9B86 ~            ;       a=#62 hard disk data not ready
  34++9B86 ~            ;
  35++9B86 ~            ;hddRdWrSectors
  36++9B86 ~            ;
  37++9B86 ~            	IFDEF	SDcard
  38++9B86 ~            	 IFDEF	ver1_10			; ᨨ v1.10
  39++9B86 ~            	  ld	a,(drvDevice)
  40++9B86 ~            	  cpl
  41++9B86 ~            	  rla
  42++9B86 ~            	  and	%01100001
  43++9B86 ~            	  rra
  44++9B86 ~            	  jr	nz,goto060		;ࠡ  ஬
  45++9B86 ~            	 ELSE				; ᨨ v1.00
  46++9B86 ~            	  ld	a,(selHdd)
  47++9B86 ~            	  bit	2,a
  48++9B86 ~            	  jr	z,goto060		;ࠡ  ஬
  49++9B86 ~            	 ENDIF
  50++9B86 ~            ;ࠡ  SD ⮩
  51++9B86 ~            	 ld	a,b
  52++9B86 ~            	 ld	(secCounter),a
  53++9B86 ~            	 push	hl
  54++9B86 ~            	 ld	hl,goto061
  55++9B86 ~            	 ex	(sp),hl
  56++9B86 ~            	 jp	c,sdWriteSecs_HL	;
  57++9B86 ~            	 jp	sdReadSecs_HL		;⥭
  58++9B86 ~            goto060
  59++9B86 ~            	ENDIF
  60++9B86 ~
  61++9B86 ~            ;ࠡ  ஬ (⥭ ᥪ஢ 㯯)
  62++9B86 ~            	IFDEF	MultiRW
  63++9B86 ~            	 call	hddSendCmdRW		;    ⥭/
  64++9B86 ~            	 jr	c,goto040		;訡
  65++9B86 ~            ;  ⥭/    㥬 hl
  66++9B86 ~            loop032	 push	bc
  67++9B86 ~            	 rr	c
  68++9B86 ~            	 push	af
  69++9B86 ~            	 call	nc,kHddReadData		;⥭
  70++9B86 ~            	 pop	af
  71++9B86 ~            	 call	c,kHddWriteData		;
  72++9B86 ~            	 pop	bc
  73++9B86 ~            	 inc	h
  74++9B86 ~            	 inc	h
  75++9B86 ~            	 djnz	loop032
  76++9B86 ~            ;ࠡ  ஬ (⥭ ᥪ஢  )
  77++9B86 ~            	ELSE
  78++9B86 ~            loop032	 call	hddSendCmdRW		;    ⥭/
  79++9B86 ~            	 jr	c,goto040		;訡
  80++9B86 ~            ;  ⥭/ ᥪ   㥬 hl
  81++9B86 ~            	 push	bc
  82++9B86 ~            	 rr	c
  83++9B86 ~            	 push	af
  84++9B86 ~            	 call	nc,kHddReadData		;⥭
  85++9B86 ~            	 pop	af
  86++9B86 ~            	 call	c,kHddWriteData		;
  87++9B86 ~            	 inc	h
  88++9B86 ~            	 inc	h
  89++9B86 ~            ;  ⠭  ᫥饣 ᥪ
  90++9B86 ~            	 push	hl
  91++9B86 ~            	 ld	hl,(AdrLBA32+0)		;  LBA32 ᥪ  ६
  92++9B86 ~            	 ld	de,(AdrLBA32+2)
  93++9B86 ~            	 inc	hl
  94++9B86 ~            	 ld	a,h
  95++9B86 ~            	 or	l
  96++9B86 ~            	 jr	nz,goto069
  97++9B86 ~            	 inc	de
  98++9B86 ~            goto069	 call	hddSetVarLBAadr
  99++9B86 ~            	 pop	hl
 100++9B86 ~            	 pop	bc
 101++9B86 ~            	 rr	c
 102++9B86 ~            	 djnz	loop032
 103++9B86 ~            	ENDIF
 104++9B86 ~
 105++9B86 ~            ;室
 106++9B86 ~            	call	hddCheckError		;஢ઠ 訡
 107++9B86 ~            goto040	call	c,kHddReset		;ணࠬ    訡
 108++9B86 ~            goto061	ld	hl,idePort1F2
 109++9B86 ~            	ld	(hl),#01
 110++9B86 ~            	ret
 111++9B86 ~
 112++9B86              	endif
 113++9B86
 114++9B86              ;------------------------------------------------------------------------------
 115++9B86              hddSendCmdRW	ifused
 116++9B86 ~            ;⠭ ॣ஢      ⥭/
 117++9B86 ~            ;:   ࢮ ᥪ   ⠭  ६
 118++9B86 ~            ;     b  - ⢮ ᥪ஢  ⥭
 119++9B86 ~            ;     cy=0/1 - ⥭/
 120++9B86 ~            ;: cy=1 訡 ⥭/
 121++9B86 ~            ;       a=#57 -  訡 ࠩ
 122++9B86 ~            ;       a=#60 busy not found
 123++9B86 ~            ;       a=#61 hard disk not ready
 124++9B86 ~            ;       a=#62 hard disk data not ready
 125++9B86 ~            ;     cy=0 訡  뫮
 126++9B86 ~            ;       hl,b -  
 127++9B86 ~            ;       0,c/e =0/1 - ⥭/
 128++9B86 ~            ;
 129++9B86 ~            ;hddSendCmdRW
 130++9B86 ~            ;
 131++9B86 ~            	push	hl
 132++9B86 ~            	push	bc
 133++9B86 ~            	push	af
 134++9B86 ~            	IFDEF	MultiRW
 135++9B86 ~            	 ld	a,b
 136++9B86 ~            	ELSE
 137++9B86 ~            	 ld	a,#01
 138++9B86 ~            	ENDIF
 139++9B86 ~            	ld	(idePort1F2),a
 140++9B86 ~            	ld	hl,idePort1F7r		;  : ⥭
 141++9B86 ~            	jr	nc,goto039
 142++9B86 ~            	inc	hl			;  : 
 143++9B86 ~            goto039	ld	a,(hl)
 144++9B86 ~            	call	hddSendCmd		;뫠  
 145++9B86 ~            	call	nc,hddWaitReadyData	; ⮢ HDD  । 
 146++9B86 ~            	pop	de
 147++9B86 ~            	pop	bc
 148++9B86 ~            	ld	c,e			;0,c=0/1 ⥭/
 149++9B86 ~            	pop	hl
 150++9B86 ~            	ret
 151++9B86 ~
 152++9B86              	endif
 153++9B86
 154++9B86              ;------------------------------------------------------------------------------
 155++9B86              hddReadMBRsec	ifused
 156++9B86 ~            ;⥭ ᥪ MBR  
 157++9B86 ~            ;: cy=1, z/nz 訡 ⥭
 158++9B86 ~            ;       a=errRWnum
 159++9B86 ~            ;     cy=0, nz  ᨣ MBR
 160++9B86 ~            ;     cy=0, z ᨣ 
 161++9B86 ~            ;
 162++9B86 ~            ;hddReadMBRsec
 163++9B86 ~            ;
 164++9B86 ~            	call	SetZeroDEHL
 165++9B86 ~            	ld	a,#01
 166++9B86 ~            	ld	(idePort1F2),a		;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
 167++9B86 ~               	call	RdSecHDD_DEHL		;⥭ 㫥 ᥪ     BufSecHdd
 168++9B86 ~            	ld	a,errRWnum
 169++9B86 ~            	ret	c			;訡 ⥭
 170++9B86 ~
 171++9B86 ~            ;஢ઠ ᨣ MBR
 172++9B86 ~            	ld	hl,(Buf4MBR+#1FE)
 173++9B86 ~            	ld	de,#AA55	;ᨣ (55h AAh)
 174++9B86 ~            	or	a
 175++9B86 ~            	sbc	hl,de
 176++9B86 ~            	scf
 177++9B86 ~            	ccf
 178++9B86 ~            	ret
 179++9B86 ~
 180++9B86              	endif
 181++9B86
 182++9B86              ;------------------------------------------------------------------------------
 183++9B86              RdSecHDD_DEHL	ifused
 184++9B86              ;⥭ ᥪ     xE5A9
 185++9B86              ;:  dehl - ᬥ饭  ᥪ (512b)  砫   㦭 ᥪ
 186++9B86              ;: cy=0 -> hl -  
 187++9B86              ;     cy=1 訡   -> a -  訡
 188++9B86              ;       a=#57 hard disk R/W error
 189++9B86              ;       a=#60 busy not found
 190++9B86              ;       a=#61 hard disk not ready
 191++9B86              ;       a=#62 hard disk data not ready
 192++9B86              ;
 193++9B86              ;RdSecHDD_DEHL
 194++9B86              ;
 195++9B86 CD E6 9B     	call	hddSetVarLBAadr		;  ⠭  ६  LBA/CHS  ᨬ  ஥
 196++9B89 18 05         	jr	RdSecHDD_buf
 197++9B8B
 198++9B8B              	endif
 199++9B8B
 200++9B8B              ;------------------------------------------------------------------------------
 201++9B8B              RdSecHDD_IX	ifused
 202++9B8B              ;⥭ ᥪ     ix
 203++9B8B              ;  LBA  ᥪ   ⠭  ॣ 
 204++9B8B              ;:  ix -    ⥭ ᥪ
 205++9B8B              ;: cy=1 訡   -> a -  訡
 206++9B8B              ;       a=#57 hard disk R/W error
 207++9B8B              ;       a=#60 busy not found
 208++9B8B              ;       a=#61 hard disk not ready
 209++9B8B              ;       a=#62 hard disk data not ready
 210++9B8B              ;
 211++9B8B              ;RdSecHDD_IX
 212++9B8B              ;
 213++9B8B DD E5        	push	ix
 214++9B8D E1           	pop	hl
 215++9B8E 18 03        	jr	RdSecHDD_HL
 216++9B90              	endif
 217++9B90
 218++9B90              ;------------------------------------------------------------------------------
 219++9B90              RdSecHDD_buf	ifused
 220++9B90              ;⥭ ᥪ     xE5A9
 221++9B90              ;  LBA  ᥪ   ⠭  ॣ 
 222++9B90              ;: cy=1 訡   -> a -  訡
 223++9B90              ;       a=#57 hard disk R/W error
 224++9B90              ;       a=#60 busy not found
 225++9B90              ;       a=#61 hard disk not ready
 226++9B90              ;       a=#62 hard disk data not ready
 227++9B90              ;
 228++9B90              ;RdSecHDD_buf
 229++9B90              ;
 230++9B90 21 5D 8B     	ld	hl,BufSecHdd
 231++9B93 18 FE        	jr	RdSecHDD_HL
 232++9B95              	org	$-2
 233++9B93              	endif
 234++9B93
 235++9B93              RdSecHDD_HL	ifused
 236++9B93              ;
 237++9B93              	IFDEF	SDcard
 238++9B93              	 IFDEF	ver1_10			; ᨨ v1.10
 239++9B93 3A D7 A4     	  ld	a,(drvDevice)
 240++9B96 2F           	  cpl
 241++9B97 E6 30        	  and	%00110000
 242++9B99 CA 0F 9D     	  jp	z,sdReadSecs_HL		;ࠡ  SD ⮩
 243++9B9C              	 ELSE				; ᨨ v1.00
 244++9B9C ~            	  ld	a,(selHdd)
 245++9B9C ~            	  bit	2,a
 246++9B9C ~            	  jp	nz,sdReadSecs_HL	;ࠡ  SD ⮩
 247++9B9C              	 ENDIF
 248++9B9C              	ENDIF
 249++9B9C 3A E1 A4     goto037	ld	a,(idePortErrCnt)	;⢮ ⥫ ⮪  ᥪ
 250++9B9F 47           	ld	b,a
 251++9BA0 C5           loop031	push	bc
 252++9BA1 3A DE A4     	ld	a,(idePort1F7r)		;  
 253++9BA4 E5           	push	hl
 254++9BA5 CD 47 A3     	call	hddSendCmd		;뫠  
 255++9BA8 D4 6C A3     	call	nc,hddWaitReadyData	; ⮢ HDD  । 
 256++9BAB DC 00 9A     	call	c,kHddReset		;訡
 257++9BAE E1           	pop	hl
 258++9BAF D4 FD 99     	call	nc,kHddReadData		;⥭ 512b    㥬 hl
 259++9BB2 D4 6D A1     	call	nc,hddCheckError
 260++9BB5 C1           	pop	bc
 261++9BB6 D0           	ret	nc
 262++9BB7 10 E7        	djnz	loop031
 263++9BB9 C9           	ret
 264++9BBA
 265++9BBA              	endif
 266++9BBA
 267++9BBA              ;------------------------------------------------------------------------------
 268++9BBA              WrSecHDD_DEHL	ifused
 269++9BBA ~            ; ᥪ   xE5A9      dehl
 270++9BBA ~            ;:  dehl - LBA  ᥪ
 271++9BBA ~            ;: cy=1 訡   -> a -  訡
 272++9BBA ~            ;       a=#57 hard disk R/W error
 273++9BBA ~            ;       a=#60 busy not found
 274++9BBA ~            ;       a=#61 hard disk not ready
 275++9BBA ~            ;       a=#62 hard disk data not ready
 276++9BBA ~            ;
 277++9BBA ~            ;WrSecHDD_DEHL
 278++9BBA ~            ;
 279++9BBA ~            	call	hddSetVarLBAadr		;  ⠭  ६  LBA/CHS
 280++9BBA ~            	jr	WrSecHDD_buf		; ᥪ   xE5A9  
 281++9BBA ~
 282++9BBA              	endif
 283++9BBA
 284++9BBA              ;------------------------------------------------------------------------------
 285++9BBA              WrSecHDD_IX	ifused
 286++9BBA              ; ᥪ   ix  
 287++9BBA              ;  LBA  ᥪ   ⠭  ॣ 
 288++9BBA              ;:  ix -     ᥪ
 289++9BBA              ;: cy=1 訡   -> a -  訡
 290++9BBA              ;       a=#57 hard disk R/W error
 291++9BBA              ;       a=#60 busy not found
 292++9BBA              ;       a=#61 hard disk not ready
 293++9BBA              ;       a=#62 hard disk data not ready
 294++9BBA              ;
 295++9BBA              ;WrSecHDD_IX
 296++9BBA              ;
 297++9BBA DD E5        	push	ix
 298++9BBC E1           	pop	hl
 299++9BBD 18 00        	jr	WrSecHDD_HL
 300++9BBF              	endif
 301++9BBF
 302++9BBF              ;------------------------------------------------------------------------------
 303++9BBF              WrSecHDD_buf	ifused
 304++9BBF ~            ; ᥪ   Buf4MBR  
 305++9BBF ~            ;  LBA  ᥪ   ⠭  ॣ 
 306++9BBF ~            ;: cy=1 訡   -> a -  訡
 307++9BBF ~            ;       a=#57 hard disk R/W error
 308++9BBF ~            ;       a=#60 busy not found
 309++9BBF ~            ;       a=#61 hard disk not ready
 310++9BBF ~            ;       a=#62 hard disk data not ready
 311++9BBF ~            ;
 312++9BBF ~            ;WrSecHDD_buf
 313++9BBF ~            ;
 314++9BBF ~            	ld	hl,BufSecHdd
 315++9BBF ~            	jr	WrSecHDD_HL
 316++9BBF ~            	org	$-2
 317++9BBF              	endif
 318++9BBF
 319++9BBF              WrSecHDD_HL	ifused
 320++9BBF              ;
 321++9BBF              	IFDEF	SDcard
 322++9BBF              	 IFDEF	ver1_10			; ᨨ v1.10
 323++9BBF 3A D7 A4     	  ld	a,(drvDevice)
 324++9BC2 2F           	  cpl
 325++9BC3 E6 30        	  and	%00110000
 326++9BC5 CA C1 9C     	  jp	z,sdWriteSecs_HL	;ࠡ  SD ⮩
 327++9BC8              	 ELSE				; ᨨ v1.00
 328++9BC8 ~            	  ld	a,(selHdd)
 329++9BC8 ~            	  bit	2,a
 330++9BC8 ~            	  jp	nz,sdWriteSecs_HL	;ࠡ  SD ⮩
 331++9BC8              	 ENDIF
 332++9BC8              	ENDIF
 333++9BC8 3A E1 A4     goto036	ld	a,(idePortErrCnt)	;⢮ ⥫ ⮪  ᥪ
 334++9BCB 47           	ld	b,a
 335++9BCC C5           loop030	push	bc
 336++9BCD 3A DF A4     	ld	a,(idePort1F7w)		;  
 337++9BD0 E5           	push	hl
 338++9BD1 CD 47 A3     	call	hddSendCmd		;뫠  
 339++9BD4 D4 6C A3     	call	nc,hddWaitReadyData	; ⮢ HDD  । 
 340++9BD7 DC 00 9A     	call	c,kHddReset		;訡
 341++9BDA E1           	pop	hl
 342++9BDB D4 FA 99     	call	nc,kHddWriteData	; 512b    㥬 hl
 343++9BDE D4 6D A1     	call	nc,hddCheckError	;஢ઠ  訡  室
 344++9BE1 C1           	pop	bc
 345++9BE2 D0           	ret	nc			; 訡
 346++9BE3 10 E7        	djnz	loop030			; ࠧ ⠥ 
 347++9BE5 C9           	ret
 348++9BE6
 349++9BE6              	endif
 350++9BE6
 351++9BE6              ;------------------------------------------------------------------------------
 352++9BE6              hddSetVarLBAadr	ifused
 353++9BE6              ;  ⠭  ६  LBA/CHS  ᨬ  ஥
 354++9BE6              ;:  dehl - LBA  ᥪ
 355++9BE6              ;: (idePort1F2) ࠬ LBA/CHS  ᨬ  ஥
 356++9BE6              ;     (AdrLBA32) = dehl 
 357++9BE6              ;
 358++9BE6              ;hddSetVarLBAadr
 359++9BE6              ;
 360++9BE6 22 E2 A4     	ld	(AdrLBA32+0),hl		;  LBA32 ᥪ  ६
 361++9BE9 ED 53 E4 A4  	ld	(AdrLBA32+2),de
 362++9BED              	IFDEF	ver1_10			; ᨨ v1.10
 363++9BED 3A D7 A4     	 ld	a,(drvDevice)
 364++9BF0 2F           	 cpl
 365++9BF1 E6 30        	 and	%00110000
 366++9BF3 C8           	 ret	z			;ࠡ  SD  ० LBA
 367++9BF4 3A F0 A4      	 ld	a,(devFlags)
 368++9BF7 E6 F0        	 and	#F0
 369++9BF9 F6 A0        	 or	%10100000
 370++9BFB              	ELSE				; ᨨ v1.00
 371++9BFB ~            	 ld	a,(selHdd)
 372++9BFB ~            	 bit	2,a
 373++9BFB ~            	 ret	nz			;ࠡ  SD  ० LBA
 374++9BFB ~            	 ld	a,(devPort1F6)
 375++9BFB ~            	 and	#F0
 376++9BFB              	ENDIF
 377++9BFB CB 77        	bit	6,a
 378++9BFD 20 14        	jr	nz,goto035		;ࠡ  ஬  ० LBA
 379++9BFF
 380++9BFF              ;ࠡ  ஬  ० CHS
 381++9BFF F5           	push	af
 382++9C00 CD 36 A4     	call	hddLBAtoCHS		;८ࠧ  LBA  C/H/S
 383++9C03 E6 0F        	and	#0F
 384++9C05 E1           	pop	hl
 385++9C06 B4           	or	h
 386++9C07 32 DD A4     	ld	(idePort1F6),a		;
 387++9C0A 79           	ld	a,c
 388++9C0B 32 DA A4     	ld	(idePort1F3),a		;ᥪ
 389++9C0E ED 53 DB A4  	ld	(idePort1F4),de		;樫
 390++9C12 C9           	ret
 391++9C13
 392++9C13              ;  LBA ᥪ  ६
 393++9C13 22 DA A4     goto035	ld	(idePort1F3),hl
 394++9C16 B2           	or	d
 395++9C17 57           	ld	d,a
 396++9C18 ED 53 DC A4  	ld	(idePort1F5),de
 397++9C1C C9           	ret
 398++9C1D
 399++9C1D              	endif
 400++9C1D
 401++9C1D              ;------------------------------------------------------------------------------
 402++9C1D              hddHddIdent	ifused
 403++9C1D              ;䨪 ⥪饣 ⪮ ᪠
 404++9C1D              ;:  ix -    㧪 ᥪ 䨪樨
 405++9C1D              ;     iy -  砫  ६ 
 406++9C1D              ;     4,(iy+#0A) =0/1 master/slave
 407++9C1D              ;: cy=1 訡
 408++9C1D              ;       a=#56 hard disk not found
 409++9C1D              ;       a=#57 hard disk R/W error
 410++9C1D              ;       a=#58 hard disk undefined
 411++9C1D              ;       a=#60 busy not found
 412++9C1D              ;       a=#61 hard disk not ready
 413++9C1D              ;       a=#62 hard disk data not ready
 414++9C1D              ;
 415++9C1D              ;hddHddIdent
 416++9C1D              ;
 417++9C1D AF           	xor	a
 418++9C1E 32 11 A5     	ld	(ideError),a		; 訡 ᪮ 
 419++9C21              	IFDEF	ver1_10			; ᨨ v1.10
 420++9C21 FD 7E 0A     	 ld	a,(iy+#0A)
 421++9C24 E6 10        	 and	%00010000
 422++9C26 FD 77 0A     	 ld	(iy+#0A),a		;ᨬ  ࠬ 
 423++9C29 F6 A0        	 or	#A0
 424++9C2B              	ELSE				; ᨨ v1.00
 425++9C2B ~            	 ld	(iy+#0A),a
 426++9C2B ~            	 ld	a,(iy+#0B)
 427++9C2B ~            	 and	%10110000
 428++9C2B              	ENDIF
 429++9C2B 32 DD A4     	ld	(idePort1F6),a		;⠭  祭 
 430++9C2E 57           	ld	d,a
 431++9C2F
 432++9C2F              ; SMUC ࠧ蠥 뢠
 433++9C2F              ;	ld	a,(drvDevice)
 434++9C2F              ;	and	%00110000
 435++9C2F              ;	jr	nz,goto029		;  SMUC
 436++9C2F              ;  ࠧ襭 뢠  
 437++9C2F              ;	ld	bc,#FFBA
 438++9C2F              ;	ld	a,#F7			;४祭  ⥭ ॣ  
 439++9C2F              ;	call	out_C_A_2A53		;device control/alt status
 440++9C2F              ;	push	bc
 441++9C2F              ;	ld	bc,#FEBE
 442++9C2F              ;	xor	a
 443++9C2F              ;	call	out_C_A_2A53
 444++9C2F              ;	pop	bc
 445++9C2F              ;	ld	a,#77
 446++9C2F              ;	call	out_C_A_2A53		;୥ ॣ 
 447++9C2F              ;	djnz	$			;প
 448++9C2F CD 00 9A     	call	kHddReset
 449++9C32 ED 4B 18 9A  goto029	ld	bc,(kPort1F6)		;⠭   樠஢ master/slave
 450++9C36 7A           	ld	a,d
 451++9C37 CD F4 99     	call	kOut_C_A
 452++9C3A              	IFDEF	PROFIide
 453++9C3A CD 2B A4     	 call	Pause70k
 454++9C3D              	ENDIF
 455++9C3D ED 4B 1A 9A  	ld	bc,(kPort1F7)		;bc - ॣ ﭨ
 456++9C41 CD F7 99     	call	kIn_A_C			;।塞     
 457++9C44 3C           	inc	a
 458++9C45 FE 02        	cp	#02			;⠭ #00/#FF ->  
 459++9C47
 460++9C47              ;⥭ ᥪ 䨪樨  ⠭ ६ ਨ 
 461++9C47 7A           	ld	a,d
 462++9C48 D4 D7 A0     	call	nc,hddTestInit		;।  
 463++9C4B 3E 56        	ld	a,#56
 464++9C4D D8           	ret	c			; 
 465++9C4E
 466++9C4E              ;⥭ ࠬ஢  ᥪ 䨪樨
 467++9C4E DD E5        	push	ix
 468++9C50 E1           	pop	hl
 469++9C51 AF           	xor	a
 470++9C52 B6           	or	(hl)
 471++9C53 23           	inc	hl
 472++9C54 B6           	or	(hl)
 473++9C55 23           	inc	hl
 474++9C56 28 65        	jr	z,goto030		;訡  ᥪ 䨪樨
 475++9C58 FD E5        	push	iy
 476++9C5A D1           	pop	de
 477++9C5B ED A0        	ldi				;樫஢ (訩 )
 478++9C5D ED A0        	ldi				;樫஢ (訩 )
 479++9C5F 23           	inc	hl
 480++9C60 23           	inc	hl
 481++9C61 ED A0        	ldi				;
 482++9C63 01 05 00     	ld	bc,#0006-1
 483++9C66 09           	add	hl,bc
 484++9C67 7E           	ld	a,(hl)			;ᥪ஢
 485++9C68 ED A0        	ldi				;ᥪ஢
 486++9C6A 0E 6B        	ld	c,#6C-1			;108
 487++9C6C 09           	add	hl,bc			;hl= +120 (᫮ +60) ⢮ LBA ᥪ஢
 488++9C6D 13           	inc	de
 489++9C6E 13           	inc	de
 490++9C6F 0E 04        	ld	c,#04
 491++9C71 ED B0        	ldir				;⢮ LBA ᥪ஢
 492++9C73
 493++9C73              ; ந   ᥪ஢
 494++9C73 FD 5E 02     	ld	e,(iy+#02)		;- 
 495++9C76              ;	ld	a,(iy+#03)		;- ᥪ஢
 496++9C76 CD 70 A4     	call	calcHLequEmulA
 497++9C79 FD 75 04     	ld	(iy+#04),l
 498++9C7C FD 74 05     	ld	(iy+#05),h		;ந head * sectors
 499++9C7F
 500++9C7F              ;஢ઠ ਨ CHS
 501++9C7F FD 7E 00     	ld	a,(iy+#00)		;樫஢ (訩 )
 502++9C82 FD B6 01     	or	(iy+#01)
 503++9C85 28 18        	jr	z,goto031		; ன.  樫஢
 504++9C87 AF           	xor	a
 505++9C88 FD B6 02     	or	(iy+#02)
 506++9C8B 28 12        	jr	z,goto031		; ன.  
 507++9C8D AF           	xor	a
 508++9C8E FD B6 03     	or	(iy+#03)
 509++9C91 28 0C        	jr	z,goto031		; ன.  ᥪ஢
 510++9C93 FD 7E 04     	ld	a,(iy+#04)
 511++9C96 FD B6 05     	or	(iy+#05)
 512++9C99 28 04        	jr	z,goto031		; ன. 㫥 ந   ᥪ஢
 513++9C9B FD CB 0A EE  	set	5,(iy+#0A)		; প CHS
 514++9C9F              	IFDEF	ver1_00			; ᨨ v1.00
 515++9C9F ~            	 res	6,(iy+#0B)		;稬 CHS
 516++9C9F              	ENDIF
 517++9C9F
 518++9C9F              ;஢ઠ ਨ LBA
 519++9C9F FD 7E 06     goto031	ld	a,(iy+#06)
 520++9CA2 FD B6 07     	or	(iy+#07)
 521++9CA5 FD B6 08     	or	(iy+#08)
 522++9CA8 FD B6 09     	or	(iy+#09)
 523++9CAB 28 04        	jr	z,goto032
 524++9CAD FD CB 0A F6  	set	6,(iy+#0A)		; প LBA
 525++9CB1              	IFDEF	ver1_00			; ᨨ v1.00
 526++9CB1 ~            	 set	6,(iy+#0B)		;稬 LBA
 527++9CB1              	ENDIF
 528++9CB1
 529++9CB1              ;᫨ ஢ન ன,    ⥬
 530++9CB1 FD 7E 0A     goto032	ld	a,(iy+#0A)
 531++9CB4 E6 60        	and	%01100000
 532++9CB6 28 05        	jr	z,goto030		;஢ઠ ਨ   ன
 533++9CB8 FD CB 0A FE  	set	7,(iy+#0A)
 534++9CBC C9           	ret
 535++9CBD
 536++9CBD              ;訡 #58. 訡  ᥪ 䨪樨
 537++9CBD 3E 58        goto030	ld	a,#58
 538++9CBF 37           	scf
 539++9CC0 C9           	ret
 540++9CC1
 541++9CC1              	endif
 542++9CC1
 543++9CC1              ;==============================================================================
 544++9CC1              ;
 545++9CC1              ;==============================================================================
 546++9CC1
# file closed: Drivers/DrvHDD/DrvHDD.hdd.a80
 227+ 9CC1              	INCLUDE		"DrvHDD.spi.a80"
# file opened: Drivers/DrvHDD/DrvHDD.spi.a80
   1++9CC1              ;楤  HDD Driver. 楤  ࠡ  ⠬ ஫஢ SD
   2++9CC1              ;䠩 DrvHDD.spi.a80
   3++9CC1              ;
   4++9CC1              ;sdWriteSecs_HL		  ᥪ஢
   5++9CC1              ;sdReadSecs_HL		㧪  ᥪ஢
   6++9CC1              ;sdWriteDataSB512	  512b   
   7++9CC1              ;sdWriteDataMB512	  512b   
   8++9CC1              ;sdReadData512		⥭ 512b    㥬 hl
   9++9CC1              ;sdCalcCapacity		 ꥬ   
  10++9CC1              ;sdReadCSD		⥭ ॣ CSD
  11++9CC1              ;sdReadCID		⥭ ॣ CID
  12++9CC1              ;sdTestInit		।   樠 SDC/MMC 
  13++9CC1              ;sdSendAcmd_41		 樠樨 (⮫쪮  SDC)
  14++9CC1              ;sdSendCmd_24		 ᥪ୮ 
  15++9CC1              ;sdSendCmd_25		 -ᥪ୮  (襭 ந  ⮯ ⮪!)
  16++9CC1              ;sdSendCmd_17		 ᥪ୮ ⥭
  17++9CC1              ;sdSendCmd_18		 -ᥪ୮ ⥭ (襭 ந  cmd12)
  18++9CC1              ;sdSendCmd_12		襭 ।  (뢠  襭
  19++9CC1              ;			-ᥪ୮ ⥭)
  20++9CC1              ;sdSendCmd_10		⥭ CID
  21++9CC1              ;sdSendCmd_09		⥭ CSD
  22++9CC1              ;sdSendCmd_58		⥭ OCR
  23++9CC1              ;sdSendCmd_55		뢠 । ACMD<n>
  24++9CC1              ;sdSendCmd_01		 樠樨 (⮫쪮  MMC)
  25++9CC1              ;sdSendCmd_A_CS		뤠    c ⠢ ᨣ CS
  26++9CC1              ;sdSendCmd_A		뤠   
  27++9CC1              ;sdSendCmd_16		뤠  #10   ( ࠧ )
  28++9CC1              ;sdSendCmd_08		뤠  #08   (㧭  殮 㦭 )
  29++9CC1              ;sdSendCmd_00		뤠  #00   (ணࠬ  )
  30++9CC1              ;sdSendCmd_HL		뤠   
  31++9CC1              ;sdWaitCmdResp		 cmd. Resp. ( 祭 80 ⠪஢)
  32++9CC1              ;sdWaitDR		 Data Response
  33++9CC1              ;sdSendEndToken		뤠 ⮪  -ᥪ୮ 樨
  34++9CC1              ;sdWait128tact		㧠  128 ⠪஢
  35++9CC1              ;sdWaitNoBusy		  BUSY
  36++9CC1              ;sdWaitDO		 DO
  37++9CC1              ;sdOffSD		몫祭 ⠭ 
  38++9CC1              ;sdFakeRead		宫 㧪  ⢠ ⮢  SPI
  39++9CC1              ;sdCSlow		⠢ CS  0
  40++9CC1              ;sdCShigh		⠢ CS  1
  41++9CC1              ;sdWait			 ⮩ 設
  42++9CC1              ;
  43++9CC1              ;------------------------------------------------------------------------------
  44++9CC1              sdWriteSecs_HL	ifused
  45++9CC1              ;  ᥪ஢
  46++9CC1              ;:  hl -     ᥪ஢
  47++9CC1              ;: cy=1 訡 SD  -> a -  訡
  48++9CC1              ;       a=#77 SD card error R/W
  49++9CC1              ;       a=#78 SD card read only
  50++9CC1              ;
  51++9CC1              ;sdWriteSecs_HL
  52++9CC1              ;
  53++9CC1              ;஢ઠ  
  54++9CC1 3A 5C 8B     	ld	a,(ExtFlags)
  55++9CC4 CB 6F        	bit	5,a
  56++9CC6 20 0C        	jr	nz,goto059		;஢ read only
  57++9CC8 ED 4B 0C 9A  	ld	bc,(kPortCONF)
  58++9CCC ED 78        	in	a,(c)
  59++9CCE E6 02        	and	#02
  60++9CD0 37           	scf
  61++9CD1 3E 78        	ld	a,#78			;SD card read only
  62++9CD3 C0           	ret	nz			; 饭
  63++9CD4
  64++9CD4              ; ᥪ/ᥪ஢
  65++9CD4 E5           goto059	push	hl
  66++9CD5 2A E2 A4     	ld	hl,(AdrLBA32+0)		; ᥪ
  67++9CD8 ED 5B E4 A4  	ld	de,(AdrLBA32+2)
  68++9CDC 3A D9 A4     	ld	a,(secCounter)		;⢮ ᥪ஢
  69++9CDF 47           	ld	b,a
  70++9CE0 3D           	dec	a
  71++9CE1 20 07        	jr	nz,goto057		;ᥪ୮ ⥭
  72++9CE3
  73++9CE3              ;ᥪୠ 
  74++9CE3 CD 4B 9F     	call	sdSendCmd_24
  75++9CE6 3E FE        	ld	a,#FE			;⮪ 砫  
  76++9CE8 18 05        	jr	goto058
  77++9CEA
  78++9CEA              ;ᥪୠ 
  79++9CEA CD 4F 9F     goto057	call	sdSendCmd_25		;   ᥪ 
  80++9CED 3E FC        	ld	a,#FC			;⮪ 砫  
  81++9CEF E1           goto058	pop	hl
  82++9CF0 38 5D        	jr	c,goto054		;訡 SD 
  83++9CF2 CD AA A0     	call	sdWait			; ⮢  ਥ 
  84++9CF5 38 58        	jr	c,goto054		; 諨  ⮢
  85++9CF7 E5           	push	hl
  86++9CF8 F5           loop046	push	af
  87++9CF9 CD 54 9D     	call	sdWriteData512		;।  ,  ⮪ 砫 + 512    2  crc
  88++9CFC 24           	inc	h
  89++9CFD 24           	inc	h
  90++9CFE F1           	pop	af
  91++9CFF CD 1D A0     	call	sdWaitDR		; Data Resp.   busy
  92++9D02 38 4A        	jr	c,goto056		; 諨  ⮢
  93++9D04 10 F2        	djnz	loop046
  94++9D06 E1           	pop	hl
  95++9D07 FE FC        	cp	#FC
  96++9D09 CA 33 A0     	jp	z,sdSendEndToken
  97++9D0C C3 94 A0     	jp	sdCShigh
  98++9D0F
  99++9D0F              	endif
 100++9D0F
 101++9D0F              ;------------------------------------------------------------------------------
 102++9D0F              sdReadSecs_HL	ifused
 103++9D0F              ;㧪  ᥪ஢
 104++9D0F              ;:  hl -    ⥭ ᥪ஢
 105++9D0F              ;: cy=1 訡 SD  -> a -  訡
 106++9D0F              ;       a=#77 SD card error R/W
 107++9D0F              ;
 108++9D0F              ;sdReadSecs_HL
 109++9D0F              ;
 110++9D0F E5           	push	hl
 111++9D10 2A E2 A4     	ld	hl,(AdrLBA32+0)		; ᥪ
 112++9D13 ED 5B E4 A4  	ld	de,(AdrLBA32+2)
 113++9D17 3A D9 A4     	ld	a,(secCounter)		;⢮ ᥪ஢
 114++9D1A 47           	ld	b,a
 115++9D1B 3D           	dec	a
 116++9D1C 20 13        	jr	nz,goto053		;ᥪ୮ ⥭
 117++9D1E
 118++9D1E              ;ᥪ୮ ⥭
 119++9D1E CD 53 9F     	call	sdSendCmd_17
 120++9D21 E1           	pop	hl
 121++9D22 38 2B        	jr	c,goto054		;訡 SD 
 122++9D24              ;  ⥭ ᥪ
 123++9D24 E5           	push	hl
 124++9D25 CD 61 A0     loop044	call	sdWaitDO		; ⮪ 砫  (#FE)
 125++9D28 20 FB        	jr	nz,loop044
 126++9D2A CD 9B 9D     	call	sdReadData512		;ਭ 512   ய᪠ crc
 127++9D2D 10 F6        	djnz	loop044
 128++9D2F 18 1C        	jr	goto055
 129++9D31
 130++9D31              ;ᥪ୮ ⥭
 131++9D31 CD 57 9F     goto053	call	sdSendCmd_18		; ᥪ୮ ⥭
 132++9D34 E1           	pop	hl
 133++9D35 38 18        	jr	c,goto054		;訡 SD 
 134++9D37              ;  ⥭ ᥪ஢
 135++9D37 E5           	push	hl
 136++9D38 CD 61 A0     loop045	call	sdWaitDO		; ⮪ 砫  (#FE)
 137++9D3B 20 FB        	jr	nz,loop045
 138++9D3D CD 9B 9D     	call	sdReadData512		;ਭ 512   ய᪠ crc
 139++9D40 24           	inc	h
 140++9D41 24           	inc	h
 141++9D42 10 F4        	djnz	loop045
 142++9D44              ;  襭 ⥭
 143++9D44 CD 94 9F     	call	sdSendCmd_12
 144++9D47 CD 43 A0     	call	sdWait128tact
 145++9D4A CD 53 A0     	call	sdWaitNoBusy
 146++9D4D B7           goto055	or	a
 147++9D4E E1           goto056	pop	hl
 148++9D4F 3E 77        goto054	ld	a,#77			;SD card error R/W
 149++9D51 C3 94 A0     	jp	sdCShigh
 150++9D54
 151++9D54              	endif
 152++9D54
 153++9D54              ;------------------------------------------------------------------------------
 154++9D54              sdWriteDataSB512	ifused
 155++9D54 ~            ;  512b   
 156++9D54 ~            ;:  hl -     
 157++9D54 ~            ;: bc=kPortDATA
 158++9D54 ~            ;     a=#00
 159++9D54 ~            ;     cy=0
 160++9D54 ~            ;
 161++9D54 ~            ;sdWriteDataSB512
 162++9D54 ~            ;
 163++9D54 ~            	ld	a,#FE			;⮪ 砫  
 164++9D54 ~            	jr	goto052
 165++9D54 ~            	jr	sdWriteData512
 166++9D54 ~            	org	$-2
 167++9D54 ~
 168++9D54              	endif
 169++9D54
 170++9D54              ;------------------------------------------------------------------------------
 171++9D54              sdWriteDataMB512	ifused
 172++9D54 ~            ;  512b   
 173++9D54 ~            ;:  hl -     
 174++9D54 ~            ;: a=#00
 175++9D54 ~            ;     cy=0
 176++9D54 ~            ;
 177++9D54 ~            ;sdWriteDataMB512
 178++9D54 ~            ;
 179++9D54 ~            	ld	a,#FC			;⮪ 砫  
 180++9D54 ~            	jr	sdWriteData512
 181++9D54 ~            	org	$-2
 182++9D54              	endif
 183++9D54
 184++9D54              sdWriteData512	ifused
 185++9D54              ;
 186++9D54 E5           goto052	push	hl
 187++9D55 C5           	push	bc
 188++9D56 ED 4B 0E 9A  	ld	bc,(kPortDATA)
 189++9D5A ED 79        	out	(c),a
 190++9D5C 3E 20        	ld	a,#20
 191++9D5E              loop043	DUP	#10
 192++9D5E ED A3       >	outi
 193++9D60 04          >	inc	b
 192++9D61 ED A3       >	outi
 193++9D63 04          >	inc	b
 192++9D64 ED A3       >	outi
 193++9D66 04          >	inc	b
 192++9D67 ED A3       >	outi
 193++9D69 04          >	inc	b
 192++9D6A ED A3       >	outi
 193++9D6C 04          >	inc	b
 192++9D6D ED A3       >	outi
 193++9D6F 04          >	inc	b
 192++9D70 ED A3       >	outi
 193++9D72 04          >	inc	b
 192++9D73 ED A3       >	outi
 193++9D75 04          >	inc	b
 192++9D76 ED A3       >	outi
 193++9D78 04          >	inc	b
 192++9D79 ED A3       >	outi
 193++9D7B 04          >	inc	b
 192++9D7C ED A3       >	outi
 193++9D7E 04          >	inc	b
 192++9D7F ED A3       >	outi
 193++9D81 04          >	inc	b
 192++9D82 ED A3       >	outi
 193++9D84 04          >	inc	b
 192++9D85 ED A3       >	outi
 193++9D87 04          >	inc	b
 192++9D88 ED A3       >	outi
 193++9D8A 04          >	inc	b
 192++9D8B ED A3       >	outi
 193++9D8D 04          >	inc	b
 194++9D8E              	EDUP
 195++9D8E 3D           	dec	a
 196++9D8F C2 5E 9D     	jp	nz,loop043
 197++9D92 3D           	dec	a			;a=#FF
 198++9D93 ED 79        	out	(c),a			;뫠 2  crc ()
 199++9D95 ED 79        	out	(c),a
 200++9D97 C1           	pop	bc
 201++9D98 E1           	pop	hl
 202++9D99 AF           	xor	a
 203++9D9A C9           	ret
 204++9D9B
 205++9D9B              	endif
 206++9D9B
 207++9D9B              ;------------------------------------------------------------------------------
 208++9D9B              sdReadData512	ifused
 209++9D9B              ;⥭ 512b   
 210++9D9B              ;:  hl -    ⥭ 
 211++9D9B              ;: a=#00
 212++9D9B              ;
 213++9D9B              ;sdReadData512
 214++9D9B              ;
 215++9D9B E5           	push	hl
 216++9D9C C5           	push	bc
 217++9D9D ED 4B 0E 9A  	ld	bc,(kPortDATA)
 218++9DA1 3E 20        	ld	a,#20
 219++9DA3              loop042	DUP	#10
 220++9DA3 ED A2       >	ini
 221++9DA5 04          >	inc	b
 220++9DA6 ED A2       >	ini
 221++9DA8 04          >	inc	b
 220++9DA9 ED A2       >	ini
 221++9DAB 04          >	inc	b
 220++9DAC ED A2       >	ini
 221++9DAE 04          >	inc	b
 220++9DAF ED A2       >	ini
 221++9DB1 04          >	inc	b
 220++9DB2 ED A2       >	ini
 221++9DB4 04          >	inc	b
 220++9DB5 ED A2       >	ini
 221++9DB7 04          >	inc	b
 220++9DB8 ED A2       >	ini
 221++9DBA 04          >	inc	b
 220++9DBB ED A2       >	ini
 221++9DBD 04          >	inc	b
 220++9DBE ED A2       >	ini
 221++9DC0 04          >	inc	b
 220++9DC1 ED A2       >	ini
 221++9DC3 04          >	inc	b
 220++9DC4 ED A2       >	ini
 221++9DC6 04          >	inc	b
 220++9DC7 ED A2       >	ini
 221++9DC9 04          >	inc	b
 220++9DCA ED A2       >	ini
 221++9DCC 04          >	inc	b
 220++9DCD ED A2       >	ini
 221++9DCF 04          >	inc	b
 220++9DD0 ED A2       >	ini
 221++9DD2 04          >	inc	b
 222++9DD3              	EDUP
 223++9DD3 3D           	dec	a
 224++9DD4 C2 A3 9D     	jp	nz,loop042
 225++9DD7 ED 78        	in	a,(c)			;ॡ 2  crc
 226++9DD9 00           	nop
 227++9DDA 00           	nop
 228++9DDB ED 78        	in	a,(c)
 229++9DDD C1           	pop	bc
 230++9DDE E1           	pop	hl
 231++9DDF C9           	ret
 232++9DE0
 233++9DE0              	endif
 234++9DE0
 235++9DE0              ;------------------------------------------------------------------------------
 236++9DE0              sdCalcCapacity	ifused
 237++9DE0              ; ꥬ   
 238++9DE0              ;:  hl -  ⠭ CSD
 239++9DE0              ;     iy -  砫  ६ SD 
 240++9DE0              ;: dehl - ࠧ   
 241++9DE0              ;     bc,a - ???
 242++9DE0              ;
 243++9DE0              ;sdCalcCapacity
 244++9DE0              ;
 245++9DE0 7E           	ld	a,(hl)
 246++9DE1 01 05 00     	ld	bc,#0005
 247++9DE4 09           	add	hl,bc
 248++9DE5 E6 C0        	and	#C0
 249++9DE7 FE 40        	cp	#40
 250++9DE9 28 4A        	jr	z,goto049		;CSD version 2.0
 251++9DEB
 252++9DEB              ;CSD version 1.0
 253++9DEB 7E           	ld	a,(hl)
 254++9DEC E6 0F        	and	#0F
 255++9DEE 4F           	ld	c,a			;c - READ_BL_LEN
 256++9DEF 06 02        	ld	b,#02
 257++9DF1 23           	inc	hl
 258++9DF2 23           loop039	inc	hl
 259++9DF3 23           	inc	hl			;hl +8
 260++9DF4 CB 16        	rl	(hl)
 261++9DF6 2B           	dec	hl
 262++9DF7 CB 16        	rl	(hl)
 263++9DF9 2B           	dec	hl
 264++9DFA CB 16        	rl	(hl)
 265++9DFC 10 F4        	djnz	loop039
 266++9DFE 7E           	ld	a,(hl)			;hl +6
 267++9DFF E6 0F        	and	#0F
 268++9E01 57           	ld	d,a
 269++9E02 23           	inc	hl
 270++9E03 5E           	ld	e,(hl)			;de - C_SIZE
 271++9E04 23           	inc	hl
 272++9E05 23           	inc	hl
 273++9E06 23           	inc	hl
 274++9E07 CB 16        	rl	(hl)
 275++9E09 2B           	dec	hl
 276++9E0A CB 16        	rl	(hl)
 277++9E0C 7E           	ld	a,(hl)
 278++9E0D E6 07        	and	#07			;a - C_SIZE_MULT
 279++9E0F              ;  dehl = BLOCKNR = (C_SIZE+1) * 2^(C_SIZE_MULT+2)
 280++9E0F 3C           	inc	a
 281++9E10 3C           	inc	a
 282++9E11 47           	ld	b,a			;C_SIZE_MULT+2
 283++9E12 13           	inc	de
 284++9E13 EB           	ex	de,hl
 285++9E14 AF           	xor	a
 286++9E15 57           	ld	d,a
 287++9E16 5F           	ld	e,a
 288++9E17 29           loop040	add	hl,hl
 289++9E18 EB           	ex	de,hl
 290++9E19 ED 6A        	adc	hl,hl
 291++9E1B EB           	ex	de,hl
 292++9E1C 10 F9        	djnz	loop040
 293++9E1E              ;  adehl = (C_SIZE+1) * 2^(C_SIZE_MULT+2) * 2^READ_BL_LEN
 294++9E1E 41           	ld	b,c
 295++9E1F AF           	xor	a
 296++9E20 29           loop041	add	hl,hl
 297++9E21 EB           	ex	de,hl
 298++9E22 ED 6A        	adc	hl,hl
 299++9E24 EB           	ex	de,hl
 300++9E25 8F           	adc	a,a
 301++9E26 10 F8        	djnz	loop041
 302++9E28              ;  adehl/#200 - ⢮ (ᥪ஢)
 303++9E28 1F           	rra
 304++9E29 CB 1A        	rr	d
 305++9E2B CB 1B        	rr	e
 306++9E2D CB 1C        	rr	h
 307++9E2F 6C           	ld	l,h
 308++9E30 63           	ld	h,e
 309++9E31 5A           	ld	e,d
 310++9E32 57           	ld	d,a
 311++9E33 18 16        	jr	goto050			;襬  ६
 312++9E35
 313++9E35              ;CSD version 2.0
 314++9E35 23           goto049	inc	hl
 315++9E36 23           	inc	hl			;+7
 316++9E37 56           	ld	d,(hl)
 317++9E38 23           	inc	hl
 318++9E39 5E           	ld	e,(hl)
 319++9E3A 23           	inc	hl
 320++9E3B 66           	ld	h,(hl)
 321++9E3C 68           	ld	l,b
 322++9E3D 24           	inc	h
 323++9E3E 20 01        	jr	nz,goto051
 324++9E40 13           	inc	de
 325++9E41 29           goto051	add	hl,hl
 326++9E42 EB           	ex	de,hl
 327++9E43 ED 6A        	adc	hl,hl
 328++9E45 EB           	ex	de,hl
 329++9E46 29           	add	hl,hl
 330++9E47 EB           	ex	de,hl
 331++9E48 ED 6A        	adc	hl,hl
 332++9E4A EB           	ex	de,hl
 333++9E4B
 334++9E4B              ;襬  ६
 335++9E4B              	IFDEF	ver1_10			; ᨨ v1.10
 336++9E4B              goto050	 ;ld	(sdLBAsec+#00),hl
 337++9E4B              	 ;ld	(sdLBAsec+#02),de
 338++9E4B FD 75 06     	 ld	(iy+#06),l
 339++9E4E FD 74 07     	 ld	(iy+#07),h
 340++9E51 FD 73 08     	 ld	(iy+#08),e
 341++9E54 FD 72 09     	 ld	(iy+#09),d
 342++9E57              	ELSE				; ᨨ v1.00
 343++9E57 ~            goto050	 ld	(sdLBAsec+#00),hl
 344++9E57 ~            	 ld	(sdLBAsec+#02),de
 345++9E57              	ENDIF
 346++9E57
 347++9E57 C9           	ret
 348++9E58
 349++9E58              	endif
 350++9E58
 351++9E58              ;------------------------------------------------------------------------------
 352++9E58              sdReadCSD	ifused
 353++9E58              ;⥭ ॣ CSD
 354++9E58              ;:  hl -    ⥭
 355++9E58              ;: cy=1 訡 
 356++9E58              ;       a=#77 - SD card error R/W
 357++9E58              ;     cy=0 ⠭ ᯥ譮
 358++9E58              ;       a=#00
 359++9E58              ;       hl=hl+#10
 360++9E58              ;
 361++9E58              ;sdReadCSD
 362++9E58              ;
 363++9E58 CD A7 9F     	call	sdSendCmd_09
 364++9E5B 18 03        	jr	goto048
 365++9E5D 18 FE        	jr	sdReadCID
 366++9E5F              	org	$-2
 367++9E5D
 368++9E5D              	endif
 369++9E5D
 370++9E5D              ;------------------------------------------------------------------------------
 371++9E5D              sdReadCID	ifused
 372++9E5D              ;⥭ ॣ CID
 373++9E5D              ;:  hl -    ⥭
 374++9E5D              ;: cy=1 訡 
 375++9E5D              ;       a=#77 - SD card error R/W
 376++9E5D              ;     cy=0 ⠭ ᯥ譮
 377++9E5D              ;       a=#00
 378++9E5D              ;       hl=hl+#10
 379++9E5D              ;
 380++9E5D              ;sdReadCID
 381++9E5D              ;
 382++9E5D CD A3 9F     	call	sdSendCmd_10
 383++9E60 3E 77        goto048	ld	a,#77			;SD card error R/W
 384++9E62 D8           	ret	c			;訡 
 385++9E63 CD 61 A0     loop037	call	sdWaitDO		; ⮪ 砫  #FE
 386++9E66 20 FB        	jr	nz,loop037
 387++9E68 ED 4B 0E 9A  	ld	bc,(kPortDATA)
 388++9E6C 3E 10        	ld	a,#10
 389++9E6E ED A2        loop038	ini
 390++9E70 3D           	dec	a
 391++9E71 20 FB        	jr	nz,loop038
 392++9E73 AF           	xor	a
 393++9E74 C9           	ret
 394++9E75
 395++9E75              	endif
 396++9E75
 397++9E75              ;------------------------------------------------------------------------------
 398++9E75              sdTestInit	ifused
 399++9E75              ;।   樠 SDC/MMC 
 400++9E75              ;:  iy -  砫  ६ SD 
 401++9E75              ;: cy=1   
 402++9E75              ;     cy=0  㦥
 403++9E75              ;       a=#00
 404++9E75              ;       hl,de,bc - ????
 405++9E75              ;
 406++9E75              ;sdTestInit
 407++9E75              ;
 408++9E75              	IFDEF	ver1_10			; ᨨ v1.10
 409++9E75              ;	 ld	hl,devFlags		;ᨬ ன 
 410++9E75              ;	 ld	(hl),%01001000
 411++9E75 FD 36 0A 48  	 ld	(iy+#0A),%01001000
 412++9E79              	ELSE				; ᨨ v1.00
 413++9E79 ~            	 ld	hl,sdFlags		;ᨬ ன 
 414++9E79 ~            	 ld	(hl),%01001000
 415++9E79              	ENDIF
 416++9E79 CD 94 A0     	call	sdCShigh
 417++9E7C 11 0A 02     	ld	de,512+10
 418++9E7F CD 70 A0     	call	sdFakeRead		;宫 㧪 512+10   直 砩
 419++9E82
 420++9E82              ;1000 横 
 421++9E82 11 E8 03     	ld	de,1000
 422++9E85 1B           loop033	dec	de
 423++9E86 7A           	ld	a,d
 424++9E87 B3           	or	e
 425++9E88 CA 1F 9F     	jp	z,goto043		;  
 426++9E8B CD E6 9F     	call	sdSendCmd_00		;  樠 
 427++9E8E 38 F5        	jr	c,loop033		;ᨬ  横,   㤥 祭 cmd. Resp. ( ⢥ 80 ⠪஢)
 428++9E90 3D           	dec	a
 429++9E91 20 F2        	jr	nz,loop033		;ᨬ  横,   稬 ⢥  訡   ⠢ Idle State 䫠 (bit 0)
 430++9E93              ;  ᫨  諮 ᯥ譮,   ४砥  SPI ०
 431++9E93 CD E1 9F     	call	sdSendCmd_08		;  ন 殮 ⠭ (⮫쪮  SDCv2)
 432++9E96 F5           	push	af
 433++9E97 ED 60        	in	h,(c)
 434++9E99 00           	nop
 435++9E9A ED 60        	in	h,(c)
 436++9E9C 00           	nop
 437++9E9D ED 60        	in	h,(c)
 438++9E9F 00           	nop
 439++9EA0 ED 68        	in	l,(c)
 440++9EA2 F1           	pop	af
 441++9EA3 38 E0        	jr	c,loop033		;cmd. Resp. 祭?
 442++9EA5 CB 57        	bit	2,a
 443++9EA7 28 2C        	jr	z,goto044		;᫨  訡 Illegal command ( 2),  ।  SDCv2
 444++9EA9
 445++9EA9              ;cmd08  ন, ।   SDCv1,  MMC
 446++9EA9 11 40 1F     	ld	de,8000			;8 横 
 447++9EAC 1B           loop034	dec	de
 448++9EAD 7A           	ld	a,d
 449++9EAE B3           	or	e
 450++9EAF 28 0E        	jr	z,goto045		;᫨ ६ 諮, ஡㥬 ।   MMC
 451++9EB1 26 00        	ld	h,#00			;HCS  0
 452++9EB3 CD 23 9F     	call	sdSendAcmd_41		;  樠 SDC
 453++9EB6 38 F4        	jr	c,loop034		; cmd. Resp.
 454++9EB8 FE 01        	cp	#01
 455++9EBA 28 F0        	jr	z,loop034		; 室  Idle State
 456++9EBC B7           	or	a			;᫨  - 訡,  ஡㥬 ।   MMC
 457++9EBD 28 58        	jr	z,goto046		;SDv1 Detected
 458++9EBF
 459++9EBF              ;஡㥬 ।   MMC
 460++9EBF 11 40 1F     goto045	ld	de,8000
 461++9EC2 1B           loop035	dec	de
 462++9EC3 7A           	ld	a,d
 463++9EC4 B3           	or	e
 464++9EC5 28 58        	jr	z,goto043		; ,   ⨯
 465++9EC7 CD B3 9F     	call	sdSendCmd_01		;  樠 MMC
 466++9ECA 38 F6        	jr	c,loop035		; cmd. Resp.
 467++9ECC FE 01        	cp	#01
 468++9ECE 28 F2        	jr	z,loop035		; 室  Idle State
 469++9ED0 B7           	or	a
 470++9ED1 20 4C        	jr	nz,goto043		;  
 471++9ED3 18 42        	jr	goto046			;MMC Ver.3 Detected
 472++9ED5
 473++9ED5              ;஡㥬 ।   SDCv2
 474++9ED5 11 AA 01     goto044	ld	de,#01AA
 475++9ED8 B7           	or	a
 476++9ED9 ED 52        	sbc	hl,de
 477++9EDB 20 42        	jr	nz,goto043		;  
 478++9EDD 11 40 1F     	ld	de,8000
 479++9EE0 1B           loop036	dec	de
 480++9EE1 7A           	ld	a,d
 481++9EE2 B3           	or	e
 482++9EE3 28 3A        	jr	z,goto043		;  
 483++9EE5 26 40        	ld	h,#40			;HCS  1
 484++9EE7 CD 23 9F     	call	sdSendAcmd_41		;  樠 SDC
 485++9EEA 38 F4        	jr	c,loop036		; cmd. Resp.
 486++9EEC FE 01        	cp	#01
 487++9EEE 28 F0        	jr	z,loop036		; 室  Idle State
 488++9EF0 B7           	or	a
 489++9EF1 20 2C        	jr	nz,goto043		;  
 490++9EF3              ;  SDv2 Detected
 491++9EF3 CD AB 9F     	call	sdSendCmd_58		;।塞 ⨯ 樨 (  ⮢)
 492++9EF6 38 27        	jr	c,goto043		;  
 493++9EF8 ED 4B 0E 9A  	ld	bc,(kPortDATA)
 494++9EFC ED 78        	in	a,(c)
 495++9EFE 00           	nop
 496++9EFF ED 68        	in	l,(c)
 497++9F01 00           	nop
 498++9F02 ED 68        	in	l,(c)
 499++9F04 00           	nop
 500++9F05 ED 68        	in	l,(c)
 501++9F07 CB 77        	bit	6,a
 502++9F09 28 0C        	jr	z,goto046		;SDv2 ⮢ 
 503++9F0B              ;  SDv2  
 504++9F0B              	IFDEF	ver1_10			; ᨨ v1.10
 505++9F0B              ;	 ld	hl,devFlags
 506++9F0B              ;	 set	2,(hl)			; 
 507++9F0B FD CB 0A D6  	 set	2,(iy+#0A)		; 
 508++9F0F              	ELSE				; ᨨ v1.00
 509++9F0F ~            	 ld	hl,sdFlags
 510++9F0F ~            	 set	4,(hl)			; 
 511++9F0F              	ENDIF
 512++9F0F
 513++9F0F              ; ᯥ譮 
 514++9F0F              	IFDEF	ver1_10			; ᨨ v1.10
 515++9F0F FD CB 0A FE  goto047	 set	7,(iy+#0A)		; 
 516++9F13              ;	 ld	hl,devFlags
 517++9F13              ;	 set	7,(hl)			; 
 518++9F13              	ELSE				; ᨨ v1.00
 519++9F13 ~            goto047	 ld	hl,sdFlags
 520++9F13 ~            	 set	7,(hl)			; 
 521++9F13              	ENDIF
 522++9F13 AF           	xor	a
 523++9F14 C3 94 A0     	jp	sdCShigh
 524++9F17
 525++9F17              ;⠢塞 ࠧ   512, . .  ᯮ ⮢ 
 526++9F17 CD DC 9F     goto046	call	sdSendCmd_16
 527++9F1A 38 03        	jr	c,goto043		;᫨  祭 cmd. Resp.,  ⠥,   
 528++9F1C B7           	or	a
 529++9F1D 28 F0        	jr	z,goto047
 530++9F1F
 531++9F1F              ;  , 뫥⠥  訡
 532++9F1F 37           goto043	scf
 533++9F20 C3 94 A0     	jp	sdCShigh
 534++9F23
 535++9F23              	endif
 536++9F23
 537++9F23              ;------------------------------------------------------------------------------
 538++9F23              sdSendAcmd_41	ifused
 539++9F23              ; 樠樨 (⮫쪮  SDC)
 540++9F23              ;:  h - ࠬ 
 541++9F23              ;: a - ﭨ  DATA
 542++9F23              ;     cy=0 - 訡  뫮
 543++9F23              ;       =1 - 訡 SD 
 544++9F23              ;
 545++9F23              ;sdSendAcmd_41
 546++9F23              ;
 547++9F23 CD AF 9F     	call	sdSendCmd_55
 548++9F26 CD 94 A0     	call	sdCShigh
 549++9F29 CD 7E A0     	call	sdCSlow
 550++9F2C ED 4B 0E 9A  	ld	bc,(kPortDATA)
 551++9F30 ED 70        	in	(c)
 552++9F32 ED 70        	in	(c)
 553++9F34 3E 69        	ld	a,sdCmd41
 554++9F36 ED 79        	out	(c),a
 555++9F38 2E 00        	ld	l,#00
 556++9F3A ED 61        	out	(c),h
 557++9F3C 00           	nop
 558++9F3D ED 69        	out	(c),l
 559++9F3F 00           	nop
 560++9F40 ED 69        	out	(c),l
 561++9F42 00           	nop
 562++9F43 ED 69        	out	(c),l
 563++9F45 2D           	dec	l
 564++9F46 ED 69        	out	(c),l
 565++9F48 C3 08 A0     	jp	sdWaitCmdResp
 566++9F4B
 567++9F4B              	endif
 568++9F4B
 569++9F4B              ;------------------------------------------------------------------------------
 570++9F4B              sdSendCmd_24	ifused
 571++9F4B              ; ᥪ୮ 
 572++9F4B              ;:  dehl -  ᥪ
 573++9F4B              ;: a - ﭨ  DATA
 574++9F4B              ;     cy=0 - 訡  뫮
 575++9F4B              ;       =1 - 訡 SD 
 576++9F4B              ;
 577++9F4B              ;sdSendCmd_24
 578++9F4B              ;
 579++9F4B 3E 58        	ld	a,sdCmd24
 580++9F4D 18 0A        	jr	goto025
 581++9F4F 18 06        	jr	sdSendCmd_18
 582++9F51              	org	$-2
 583++9F4F
 584++9F4F              	endif
 585++9F4F
 586++9F4F              ;------------------------------------------------------------------------------
 587++9F4F              sdSendCmd_25	ifused
 588++9F4F              ; -ᥪ୮  (襭 ந  ⮯ ⮪!)
 589++9F4F              ;:  dehl -  ᥪ
 590++9F4F              ;: a - ﭨ  DATA
 591++9F4F              ;     cy=0 - 訡  뫮
 592++9F4F              ;       =1 - 訡 SD 
 593++9F4F              ;
 594++9F4F              ;sdSendCmd_25
 595++9F4F              ;
 596++9F4F 3E 59        	ld	a,sdCmd25
 597++9F51 18 06        	jr	goto025
 598++9F53 18 02        	jr	sdSendCmd_18
 599++9F55              	org	$-2
 600++9F53
 601++9F53              	endif
 602++9F53
 603++9F53              ;------------------------------------------------------------------------------
 604++9F53              sdSendCmd_17	ifused
 605++9F53              ; ᥪ୮ ⥭
 606++9F53              ;:  dehl -  ᥪ
 607++9F53              ;: a - ﭨ  DATA
 608++9F53              ;     cy=0 - 訡  뫮
 609++9F53              ;       =1 - 訡 SD 
 610++9F53              ;
 611++9F53              ;sdSendCmd_17
 612++9F53              ;
 613++9F53 3E 51        	ld	a,sdCmd17
 614++9F55 18 02        	jr	goto025
 615++9F57 18 FE        	jr	sdSendCmd_18
 616++9F59              	org	$-2
 617++9F57
 618++9F57              	endif
 619++9F57
 620++9F57              ;------------------------------------------------------------------------------
 621++9F57              sdSendCmd_18	ifused
 622++9F57              ; -ᥪ୮ ⥭ (襭 ந  cmd12)
 623++9F57              ;:  dehl -  ᥪ
 624++9F57              ;: a - ﭨ  DATA
 625++9F57              ;     cy=0 - 訡  뫮
 626++9F57              ;       =1 - 訡 SD 
 627++9F57              ;
 628++9F57              ;sdSendCmd_18
 629++9F57              ;
 630++9F57 3E 52        	ld	a,sdCmd18
 631++9F59 CD 94 A0     goto025	call	sdCShigh
 632++9F5C CD 7E A0     	call	sdCSlow
 633++9F5F E5           	push	hl
 634++9F60 D5           	push	de
 635++9F61 C5           	push	bc
 636++9F62 4F           	ld	c,a
 637++9F63              	IFDEF	ver1_10			; ᨨ v1.10
 638++9F63 3A F0 A4     	 ld	a,(devFlags)		;⨯ 樨
 639++9F66 CB 57        	 bit	2,a
 640++9F68              	ELSE				; ᨨ v1.00
 641++9F68 ~            	 ld	a,(sdFlags)		;⨯ 樨
 642++9F68 ~            	 bit	4,a
 643++9F68              	ENDIF
 644++9F68 20 0A        	jr	nz,goto026		;
 645++9F6A 29           	add	hl,hl
 646++9F6B EB           	ex	de,hl
 647++9F6C ED 6A        	adc	hl,hl
 648++9F6E EB           	ex	de,hl
 649++9F6F 53           	ld	d,e
 650++9F70 5C           	ld	e,h
 651++9F71 65           	ld	h,l
 652++9F72 2E 00        	ld	l,#00
 653++9F74 79           goto026	ld	a,c
 654++9F75 ED 4B 0E 9A  	ld	bc,(kPortDATA)
 655++9F79 ED 70        	in	(c)
 656++9F7B ED 70        	in	(c)
 657++9F7D ED 79        	out	(c),a
 658++9F7F 00           	nop
 659++9F80 ED 51        	out	(c),d
 660++9F82 00           	nop
 661++9F83 ED 59        	out	(c),e
 662++9F85 00           	nop
 663++9F86 ED 61        	out	(c),h
 664++9F88 00           	nop
 665++9F89 ED 69        	out	(c),l
 666++9F8B 3E FF        	ld	a,#FF
 667++9F8D ED 79        	out	(c),a
 668++9F8F C1           	pop	bc
 669++9F90 D1           	pop	de
 670++9F91 E1           	pop	hl
 671++9F92 18 74        	jr	sdWaitCmdResp
 672++9F94
 673++9F94              	endif
 674++9F94
 675++9F94              ;------------------------------------------------------------------------------
 676++9F94              sdSendCmd_12	ifused
 677++9F94              ;襭 ।  (뢠  襭 -ᥪ୮ ⥭)
 678++9F94              ;:  ---
 679++9F94              ;: a - ﭨ  DATA
 680++9F94              ;     cy=0 - 訡  뫮
 681++9F94              ;       =1 - 訡 SD 
 682++9F94              ;
 683++9F94              ;sdSendCmd_12
 684++9F94              ;
 685++9F94 3E 4C        	ld	a,sdCmd12
 686++9F96 CD C0 9F     	call	sdSendCmd_A
 687++9F99 C5           	push	bc
 688++9F9A ED 4B 0E 9A  	ld	bc,(kPortDATA)
 689++9F9E ED 78        	in	a,(c)
 690++9FA0 C1           	pop	bc
 691++9FA1 18 65        	jr	sdWaitCmdResp
 692++9FA3
 693++9FA3              	endif
 694++9FA3
 695++9FA3              ;------------------------------------------------------------------------------
 696++9FA3              sdSendCmd_10	ifused
 697++9FA3              ;⥭ CID
 698++9FA3              ;:  ---
 699++9FA3              ;: a - ﭨ  DATA
 700++9FA3              ;     cy=0 - 訡  뫮
 701++9FA3              ;       =1 - 訡 SD 
 702++9FA3              ;
 703++9FA3              ;sdSendCmd_10
 704++9FA3              ;
 705++9FA3 3E 4A        	ld	a,sdCmd10
 706++9FA5 18 0E        	jr	goto042
 707++9FA7 18 0A        	jr	sdSendCmd_01
 708++9FA9              	org	$-2
 709++9FA7
 710++9FA7              	endif
 711++9FA7
 712++9FA7              ;------------------------------------------------------------------------------
 713++9FA7              sdSendCmd_09	ifused
 714++9FA7              ;⥭ CSD
 715++9FA7              ;:  ---
 716++9FA7              ;: a - ﭨ  DATA
 717++9FA7              ;     cy=0 - 訡  뫮
 718++9FA7              ;       =1 - 訡 SD 
 719++9FA7              ;
 720++9FA7              ;sdSendCmd_09
 721++9FA7              ;
 722++9FA7 3E 49        	ld	a,sdCmd09
 723++9FA9 18 0A        	jr	goto042
 724++9FAB 18 06        	jr	sdSendCmd_01
 725++9FAD              	org	$-2
 726++9FAB
 727++9FAB              	endif
 728++9FAB
 729++9FAB              ;------------------------------------------------------------------------------
 730++9FAB              sdSendCmd_58	ifused
 731++9FAB              ;⥭ OCR
 732++9FAB              ;:  ---
 733++9FAB              ;: a - ﭨ  DATA
 734++9FAB              ;     cy=0 - 訡  뫮
 735++9FAB              ;       =1 - 訡 SD 
 736++9FAB              ;
 737++9FAB              ;sdSendCmd_58
 738++9FAB              ;
 739++9FAB 3E 7A        	ld	a,sdCmd58
 740++9FAD 18 06        	jr	goto042
 741++9FAF 18 02        	jr	sdSendCmd_01
 742++9FB1              	org	$-2
 743++9FAF
 744++9FAF              	endif
 745++9FAF
 746++9FAF              ;------------------------------------------------------------------------------
 747++9FAF              sdSendCmd_55	ifused
 748++9FAF              ;뢠 । ACMD<n>
 749++9FAF              ;:  ---
 750++9FAF              ;: a - ﭨ  DATA
 751++9FAF              ;     cy=0 - 訡  뫮
 752++9FAF              ;       =1 - 訡 SD 
 753++9FAF              ;
 754++9FAF              ;sdSendCmd_55
 755++9FAF              ;
 756++9FAF 3E 77        	ld	a,sdCmd55
 757++9FB1 18 02        	jr	goto042
 758++9FB3 18 FE        	jr	sdSendCmd_01
 759++9FB5              	org	$-2
 760++9FB3
 761++9FB3              	endif
 762++9FB3
 763++9FB3              ;------------------------------------------------------------------------------
 764++9FB3              sdSendCmd_01	ifused
 765++9FB3              ; 樠樨 (⮫쪮  MMC)
 766++9FB3              ;:  ---
 767++9FB3              ;: a - ﭨ  DATA
 768++9FB3              ;     cy=0 - 訡  뫮
 769++9FB3              ;       =1 - 訡 SD 
 770++9FB3              ;
 771++9FB3              ;sdSendCmd_01
 772++9FB3              ;
 773++9FB3 3E 41        	ld	a,sdCmd01
 774++9FB5 CD BA 9F     goto042	call	sdSendCmd_A_CS
 775++9FB8 18 4E        	jr	sdWaitCmdResp
 776++9FBA
 777++9FBA              	endif
 778++9FBA
 779++9FBA              ;------------------------------------------------------------------------------
 780++9FBA              sdSendCmd_A_CS	ifused
 781++9FBA              ;뤠    c ⠢ ᨣ CS
 782++9FBA              ;:  a -  
 783++9FBA              ;: a=#FF
 784++9FBA              ;
 785++9FBA              ;sdSendCmd_A_CS
 786++9FBA              ;
 787++9FBA CD 94 A0     	call	sdCShigh
 788++9FBD CD 7E A0     	call	sdCSlow
 789++9FC0 18 FE        	jr	sdSendCmd_A
 790++9FC2              	org	$-2
 791++9FC0
 792++9FC0              	endif
 793++9FC0
 794++9FC0              ;------------------------------------------------------------------------------
 795++9FC0              sdSendCmd_A	ifused
 796++9FC0              ;뤠   
 797++9FC0              ;    #nn #00 #00 #00 #00 #FF
 798++9FC0              ;:  a -  
 799++9FC0              ;: a=#FF
 800++9FC0              ;
 801++9FC0              ;sdSendCmd_A
 802++9FC0              ;
 803++9FC0 C5           	push	bc
 804++9FC1 ED 4B 0E 9A  	ld	bc,(kPortDATA)
 805++9FC5 ED 70        	in	(c)
 806++9FC7 ED 70        	in	(c)
 807++9FC9 ED 79        	out	(c),a
 808++9FCB AF           	xor	a
 809++9FCC ED 79        	out	(c),a
 810++9FCE 00           	nop
 811++9FCF ED 79        	out	(c),a
 812++9FD1 00           	nop
 813++9FD2 ED 79        	out	(c),a
 814++9FD4 00           	nop
 815++9FD5 ED 79        	out	(c),a
 816++9FD7 3D           	dec	a
 817++9FD8 ED 79        	out	(c),a
 818++9FDA C1           	pop	bc
 819++9FDB C9           	ret
 820++9FDC
 821++9FDC              	endif
 822++9FDC
 823++9FDC              ;------------------------------------------------------------------------------
 824++9FDC              sdSendCmd_16	ifused
 825++9FDC              ;뤠  #10   ( ࠧ )   ᥣ 512
 826++9FDC              ;:  ---
 827++9FDC              ;: bc -  DATA
 828++9FDC              ;     a - ﭨ  DATA
 829++9FDC              ;     cy=0 - 訡  뫮
 830++9FDC              ;       =1 - 訡 SD 
 831++9FDC              ;     hl - ???
 832++9FDC              ;
 833++9FDC              ;sdSendCmd_16
 834++9FDC              ;
 835++9FDC 21 D1 A0     	ld	hl,sdCmd16
 836++9FDF 18 08        	jr	sdSendCmd_HL
 837++9FE1
 838++9FE1              	endif
 839++9FE1
 840++9FE1              ;------------------------------------------------------------------------------
 841++9FE1              sdSendCmd_08	ifused
 842++9FE1              ;뤠  #08   (㧭  殮 㦭 )
 843++9FE1              ;  ⮫쪮  SDCv2
 844++9FE1              ;:  ---
 845++9FE1              ;: bc -  DATA
 846++9FE1              ;     a - ﭨ  DATA
 847++9FE1              ;     cy=0 - 訡  뫮
 848++9FE1              ;       =1 - 訡 SD 
 849++9FE1              ;     hl - ???
 850++9FE1              ;
 851++9FE1              ;sdSendCmd_08
 852++9FE1              ;
 853++9FE1 21 CB A0     	ld	hl,sdCmd08
 854++9FE4 18 03        	jr	sdSendCmd_HL
 855++9FE6
 856++9FE6              	endif
 857++9FE6
 858++9FE6              ;------------------------------------------------------------------------------
 859++9FE6              sdSendCmd_00	ifused
 860++9FE6              ;뤠  #00   (ணࠬ  )
 861++9FE6              ;:  ---
 862++9FE6              ;: bc -  DATA
 863++9FE6              ;     a - ﭨ  DATA
 864++9FE6              ;     cy=0 - 訡  뫮
 865++9FE6              ;       =1 - 訡 SD 
 866++9FE6              ;     hl - ???
 867++9FE6              ;
 868++9FE6              ;sdSendCmd_00
 869++9FE6              ;
 870++9FE6 21 C5 A0     	ld	hl,sdCmd00
 871++9FE9 18 FE        	jr	sdSendCmd_HL
 872++9FEB              	org	$-2
 873++9FE9
 874++9FE9              	endif
 875++9FE9
 876++9FE9              ;------------------------------------------------------------------------------
 877++9FE9              sdSendCmd_HL	ifused
 878++9FE9              ;뤠   
 879++9FE9              ;:  hl -  砫 
 880++9FE9              ;: bc -  DATA
 881++9FE9              ;     a - ﭨ  DATA
 882++9FE9              ;     hl=hl+6
 883++9FE9              ;     cy=0 - 訡  뫮
 884++9FE9              ;       =1 - 訡 SD 
 885++9FE9              ;
 886++9FE9              ;sdSendCmd_HL
 887++9FE9              ;
 888++9FE9 CD 94 A0     	call	sdCShigh
 889++9FEC CD 7E A0     	call	sdCSlow
 890++9FEF ED 4B 0E 9A  	ld	bc,(kPortDATA)
 891++9FF3 ED 70        	in	(c)
 892++9FF5 ED 70        	in	(c)
 893++9FF7 ED A3        	outi
 894++9FF9 00           	nop
 895++9FFA ED A3        	outi
 896++9FFC 00           	nop
 897++9FFD ED A3        	outi
 898++9FFF 00           	nop
 899++A000 ED A3        	outi
 900++A002 00           	nop
 901++A003 ED A3        	outi
 902++A005 00           	nop
 903++A006 ED A3        	outi
 904++A008 18 FE        	jr	sdWaitCmdResp
 905++A00A              	org	$-2
 906++A008
 907++A008              	endif
 908++A008
 909++A008              ;------------------------------------------------------------------------------
 910++A008              sdWaitCmdResp	ifused
 911++A008              ; cmd. Resp. ( 祭 80 ⠪஢)
 912++A008              ;:  ---
 913++A008              ;: a - ﭨ  DATA
 914++A008              ;     cy=0 - 訡  뫮
 915++A008              ;       =1 - 訡 SD 
 916++A008              ;
 917++A008              ;sdWaitCmdResp
 918++A008              ;
 919++A008 D5           	push	de
 920++A009 C5           	push	bc
 921++A00A ED 4B 0E 9A  	ld	bc,(kPortDATA)
 922++A00E 16 0A        	ld	d,10
 923++A010 ED 78        loop023	in	a,(c)
 924++A012 B7           	or	a			;nc
 925++A013 F2 1A A0     	jp	p,goto024		;7,a=0
 926++A016 15           	dec	d
 927++A017 20 F7        	jr	nz,loop023
 928++A019 37           	scf
 929++A01A C1           goto024	pop	bc
 930++A01B D1           	pop	de
 931++A01C C9           	ret
 932++A01D
 933++A01D              	endif
 934++A01D
 935++A01D              ;------------------------------------------------------------------------------
 936++A01D              sdWaitDR	ifused
 937++A01D              ; Data Response
 938++A01D              ;:  ---
 939++A01D              ;: cy=0 - 訡  뫮
 940++A01D              ;       =1 - 訡 SD 
 941++A01D              ;
 942++A01D              ;sdWaitDR
 943++A01D              ;
 944++A01D F5           	push	af
 945++A01E CD 61 A0     	call	sdWaitDO
 946++A021 E6 1F        	and	#1F
 947++A023 FE 05        	cp	#05
 948++A025 20 06        	jr	nz,goto023		;᫨ Data Resp. ਭ  訡,    (%0XXX1, xxx -   [%010 -  ਭ])
 949++A027 CD 53 A0     	call	sdWaitNoBusy		;  ன busy
 950++A02A F1           	pop	af
 951++A02B B7           	or	a
 952++A02C C9           	ret
 953++A02D CD 33 A0     goto023	call	sdSendEndToken		; ⮯ ⮪
 954++A030              ;	call	sdOffSD			;㡠 ⠭ 
 955++A030 F1           	pop	af
 956++A031 37           	scf
 957++A032 C9           	ret
 958++A033
 959++A033              	endif
 960++A033
 961++A033              ;------------------------------------------------------------------------------
 962++A033              sdSendEndToken	ifused
 963++A033              ;뤠 ⮪  -ᥪ୮ 樨
 964++A033              ;:  ---
 965++A033              ;: bc -  DATA
 966++A033              ;     a=#FD
 967++A033              ;
 968++A033              ;sdSendEndToken
 969++A033              ;
 970++A033 ED 4B 0E 9A  	ld	bc,(kPortDATA)
 971++A037 3E FD        	ld	a,#FD			;⮪  -ᥪ୮ 樨
 972++A039 ED 79        	out	(c),a
 973++A03B CD 43 A0     	call	sdWait128tact
 974++A03E CD 53 A0     	call	sdWaitNoBusy
 975++A041 18 51        	jr	sdCShigh
 976++A043
 977++A043              	endif
 978++A043
 979++A043              ;------------------------------------------------------------------------------
 980++A043              sdWait128tact	ifused
 981++A043              ;㧠  128 ⠪஢
 982++A043              ;:  ---
 983++A043              ;: ॣ  
 984++A043              ;
 985++A043              ;sdWait128tact
 986++A043              ;
 987++A043 C5           	push	bc
 988++A044 F5           	push	af
 989++A045 3E 10        	ld	a,#10
 990++A047 ED 4B 0E 9A  loop022	ld	bc,(kPortDATA)
 991++A04B ED 48        	in	c,(c)
 992++A04D 3D           	dec	a
 993++A04E 20 F7        	jr	nz,loop022
 994++A050 F1           	pop	af
 995++A051 C1           	pop	bc
 996++A052 C9           	ret
 997++A053
 998++A053              	endif
 999++A053
1000++A053              ;------------------------------------------------------------------------------
1001++A053              sdWaitNoBusy	ifused
1002++A053              ;  BUSY
1003++A053              ;:  ---
1004++A053              ;: ॣ  
1005++A053              ;
1006++A053              ;sdWaitNoBusy
1007++A053              ;
1008++A053 C5           	push	bc
1009++A054 F5           	push	af
1010++A055 ED 4B 0E 9A  	ld	bc,(kPortDATA)
1011++A059 ED 78        loop021	in	a,(c)
1012++A05B B7           	or	a
1013++A05C 28 FB        	jr	z,loop021
1014++A05E F1           	pop	af
1015++A05F C1           	pop	bc
1016++A060 C9           	ret
1017++A061
1018++A061              	endif
1019++A061
1020++A061              ;------------------------------------------------------------------------------
1021++A061              sdWaitDO	ifused
1022++A061              ; DO
1023++A061              ;:  ---
1024++A061              ;: a - ﭨ  DATA
1025++A061              ;     z -> a=#FE
1026++A061              ;
1027++A061              ;sdWaitDO
1028++A061              ;
1029++A061 C5           	push	bc
1030++A062 ED 4B 0E 9A  	ld	bc,(kPortDATA)
1031++A066 ED 78        loop020	in	a,(c)
1032++A068 FE FF        	cp	#FF
1033++A06A 28 FA        	jr	z,loop020
1034++A06C C1           	pop	bc
1035++A06D FE FE        	cp	#FE
1036++A06F C9           	ret
1037++A070
1038++A070              	endif
1039++A070
1040++A070              ;------------------------------------------------------------------------------
1041++A070              sdOffSD		ifused
1042++A070 ~            ;몫祭 ⠭ 
1043++A070 ~            ;:  ---
1044++A070 ~            ;: a=#00
1045++A070 ~            ;
1046++A070 ~            ;sdOffSD
1047++A070 ~            ;
1048++A070 ~            	push	bc
1049++A070 ~            	xor	a
1050++A070 ~            	ld	bc,(kPortCONF)
1051++A070 ~            	out	(c),a
1052++A070 ~            	ld	bc,(kPortDATA)
1053++A070 ~            	out	(c),a
1054++A070 ~            	pop	bc
1055++A070 ~            	ret
1056++A070 ~
1057++A070              	endif
1058++A070
1059++A070              ;------------------------------------------------------------------------------
1060++A070              sdFakeRead	ifused
1061++A070              ;宫 㧪  ⢠ ⮢  SPI
1062++A070              ;:  de - ⢮ 
1063++A070              ;: bc -  DATA
1064++A070              ;     de=#0000
1065++A070              ;     a=#00
1066++A070              ;
1067++A070              ;sdFakeRead
1068++A070              ;
1069++A070 ED 4B 0E 9A  	ld	bc,(kPortDATA)
1070++A074 3E FF        loop019	ld	a,#FF
1071++A076 ED 79        	out	(c),a
1072++A078 1B           	dec	de
1073++A079 7A           	ld	a,d
1074++A07A B3           	or	e
1075++A07B 20 F7        	jr	nz,loop019
1076++A07D C9           	ret
1077++A07E
1078++A07E              	endif
1079++A07E
1080++A07E              ;------------------------------------------------------------------------------
1081++A07E              sdCSlow		ifused
1082++A07E              ;⠢ CS  0
1083++A07E              ;:  ---
1084++A07E              ;: ॣ  
1085++A07E              ;
1086++A07E              ;sdCSlow
1087++A07E              ;
1088++A07E C5           	push	bc
1089++A07F F5           	push	af
1090++A080
1091++A080 ED 4B 0C 9A  	ld	bc,(kPortCONF)
1092++A084 3A 10 9A     	ld	a,(kPortCSlow)		;%00000001
1093++A087 ED 79        	out	(c),a
1094++A089 ED 4B 0E 9A  	ld	bc,(kPortDATA)
1095++A08D 3E FF        	ld	a,#FF
1096++A08F ED 79        	out	(c),a
1097++A091
1098++A091 F1           	pop	af
1099++A092 C1           	pop	bc
1100++A093              ;	jr	sdWait
1101++A093 C9           	ret
1102++A094
1103++A094              	endif
1104++A094
1105++A094              ;------------------------------------------------------------------------------
1106++A094              sdCShigh	ifused
1107++A094              ;⠢ CS  1
1108++A094              ;:  ---
1109++A094              ;: ॣ  
1110++A094              ;
1111++A094              ;sdCShigh
1112++A094              ;
1113++A094 C5           	push	bc
1114++A095 F5           	push	af
1115++A096
1116++A096 ED 4B 0C 9A  	ld	bc,(kPortCONF)
1117++A09A 3A 12 9A     	ld	a,(kPortCSHigh)		;%00000011
1118++A09D ED 79        	out	(c),a
1119++A09F ED 4B 0E 9A  	ld	bc,(kPortDATA)
1120++A0A3 3E FF        	ld	a,#FF
1121++A0A5 ED 79        	out	(c),a
1122++A0A7
1123++A0A7 F1           	pop	af
1124++A0A8 C1           	pop	bc
1125++A0A9 C9           	ret
1126++A0AA
1127++A0AA              	endif
1128++A0AA
1129++A0AA              ;------------------------------------------------------------------------------
1130++A0AA              sdWait		ifused
1131++A0AA              ; ⮩ 設
1132++A0AA              ;:  ---
1133++A0AA              ;: ॣ  
1134++A0AA              ;
1135++A0AA              ;sdWait
1136++A0AA              ;
1137++A0AA D5           	push	de
1138++A0AB C5           	push	bc
1139++A0AC F5           	push	af
1140++A0AD 11 00 10     	ld	de,#1000
1141++A0B0 ED 4B 0E 9A  	ld	bc,(kPortDATA)
1142++A0B4 ED 78        loop018	in	a,(c)
1143++A0B6 FE FF        	cp	#FF
1144++A0B8 28 06        	jr	z,goto041
1145++A0BA 1B           	dec	de
1146++A0BB 7A           	ld	a,d
1147++A0BC B3           	or	e
1148++A0BD 20 F5        	jr	nz,loop018
1149++A0BF 37           	scf
1150++A0C0 C1           goto041	pop	bc
1151++A0C1 78           	ld	a,b
1152++A0C2 C1           	pop	bc
1153++A0C3 D1           	pop	de
1154++A0C4 C9           	ret
1155++A0C5
1156++A0C5              	endif
1157++A0C5
1158++A0C5              ;==============================================================================
1159++A0C5              	IFDEF	SDcard
1160++A0C5              ;
1161++A0C5              sdCmd01	equ #40+#01				;樠
1162++A0C5              sdCmd09	equ #40+#09				;⥭ CSD
1163++A0C5              sdCmd10	equ #40+#0A				;⥭ CID
1164++A0C5              sdCmd12	equ #40+#0C				;⠭ ।
1165++A0C5              sdCmd17	equ #40+#11				;ᥪ୮ ⥭
1166++A0C5              sdCmd18	equ #40+#12				;ᥪ୮ ⥭
1167++A0C5              sdCmd24	equ #40+#18				;ᥪୠ 
1168++A0C5              sdCmd25	equ #40+#19				;ᥪୠ 
1169++A0C5              sdCmd41	equ #40+#29				;樠 (⮫쪮 SDC)
1170++A0C5              sdCmd55	equ #40+#37				; 䨪  ACMD
1171++A0C5              sdCmd58	equ #40+#3A				;⥭ OCR
1172++A0C5 40 00 00 00  sdCmd00	db  %01000000+#00,#00,#00,#00,#00,#95	;ணࠬ 
1172++A0C9 00 95
1173++A0CB 48 00 00 01  sdCmd08	db  %01000000+#08,#00,#00,#01,#AA,#87	;殮  (⮫쪮  SDCv2)
1173++A0CF AA 87
1174++A0D1 50 00 00 02  sdCmd16	db  %01000000+#10,#00,#00,#02,#00,#FF	; ࠧ  (512)
1174++A0D5 00 FF
1175++A0D7              	ENDIF
1176++A0D7              ;==============================================================================
1177++A0D7
# file closed: Drivers/DrvHDD/DrvHDD.spi.a80
 228+ A0D7              	INCLUDE		"DrvHDD.ide.a80"
# file opened: Drivers/DrvHDD/DrvHDD.ide.a80
   1++A0D7              ;楤  HDD Driver. 楤  ࠡ  ⠬ ஫஢ IDE
   2++A0D7              ;䠩 DrvHDD.ide.a80
   3++A0D7              ;
   4++A0D7              ;hddTestInit		஢ઠ ⢮ 
   5++A0D7              ;hddReadIdSec		⥭ ᥪ 䨪樨      ix
   6++A0D7              ;hddCheckError		஢ઠ  訡  室,  砥 訡  
   7++A0D7              ;hddResetSmuc		ணࠬ   SMUC
   8++A0D7              ;hddResetNemo		ணࠬ   NEMO
   9++A0D7              ;hddReadDataSv1		⥭ 512b    㥬 hl ( SMUC v1 shadow)
  10++A0D7              ;hddReadDataSv2		⥭ 512b    㥬 hl ( SMUC v2)
  11++A0D7              ;hddReadDataN		⥭ 512b    㥬 hl ( NEMO)
  12++A0D7              ;hddReadDataNA8		⥭ 512b    㥬 hl ( NEMO A8)
  13++A0D7              ;hddReadDataAtm		⥭ 512b    㥬 hl ( ATM-IDE)
  14++A0D7              ;hddReadDataPrf		⥭ 512b    㥬 hl ( PROFI IDE)
  15++A0D7              ;hddWriteDataSv1	 512b    㥬 hl ( SMUC v1 shadow)
  16++A0D7              ;hddWriteDataSv2	 512b    㥬 hl ( SMUC v2)
  17++A0D7              ;hddWriteDataN		 512b    㥬 hl ( NEMO)
  18++A0D7              ;hddWriteDataNA8	 512b    㥬 hl ( NEMO A8)
  19++A0D7              ;hddWriteDataAtm	 512b    㥬 hl ( ATM-IDE)
  20++A0D7              ;hddWriteDataPrf	 512b    㥬 hl ( PROFI-IDE)
  21++A0D7              ;hddSendCmd		뫠  
  22++A0D7              ;hddWaitReadyData	 ⮢ HDD  । 
  23++A0D7              ;hddWaitReadyCmd	 ⮢ HDD  ਭ 
  24++A0D7              ;hddWaitNoBusy		 ⮢ HDD
  25++A0D7              ;smucTest3FF0		஢ઠ    ࠡ Smuc v1
  26++A0D7              ;profiPortsOff		몫祭 ⮢ PROFI
  27++A0D7              ;profiPortsOn		祭 ⮢ PROFI
  28++A0D7              ;atmPortsOff		몫祭 ⮢ ATM
  29++A0D7              ;atmPortsOn		祭 ⮢ ATM
  30++A0D7              ;out_C_A_2A53		  ⥭ 
  31++A0D7              ;out_C_A		  ⥭ 
  32++A0D7              ;in_A_C_profi		⥭  PROFI
  33++A0D7              ;in_A_C			⥭ ⥭ 
  34++A0D7              ;
  35++A0D7              ;------------------------------------------------------------------------------
  36++A0D7              hddTestInit	ifused
  37++A0D7              ;஢ઠ ⢮ 
  38++A0D7              ;:  ix -    ⥭ 䨪樮 ᥪ
  39++A0D7              ;     a=#A0/#B0 ஢塞 Master/Slave
  40++A0D7              ;: cy=1 訡 ⥭/    
  41++A0D7              ;       a=#56 hard disk not found
  42++A0D7              ;       a=#57 hard disk R/W error
  43++A0D7              ;       a=#60 busy not found
  44++A0D7              ;       a=#61 hard disk not ready
  45++A0D7              ;       a=#62 hard disk data not ready
  46++A0D7              ;     cy=0  㦥,  ix ⠭ ᥪ 䨪樨
  47++A0D7              ;       a=#00
  48++A0D7              ;       hl,de,bc - ????
  49++A0D7              ;
  50++A0D7              ;hddTestInit
  51++A0D7              ;
  52++A0D7              ;⠭  master/slave  LBA addr =#00000000
  53++A0D7 57           	ld	d,a
  54++A0D8 1E 06        	ld	e,#06
  55++A0DA AF           	xor	a
  56++A0DB 21 0E 9A     	ld	hl,kPort1F1
  57++A0DE 4E           loop016	ld	c,(hl)
  58++A0DF 23           	inc	hl
  59++A0E0 46           	ld	b,(hl)
  60++A0E1 23           	inc	hl
  61++A0E2 1D           	dec	e
  62++A0E3 C4 F4 99     	call	nz,kOut_C_A
  63++A0E6 20 F6        	jr	nz,loop016
  64++A0E8 7A           	ld	a,d
  65++A0E9 CD F4 99     	call	kOut_C_A
  66++A0EC              ;d=#A0/#B0 ஢塞 Master/Slave
  67++A0EC
  68++A0EC              ;ࠢ塞  #90 (EXECUTE DEVICE DIAGNOSTIC)
  69++A0EC CD 85 A3     	call	hddWaitReadyCmd		;->bc -  #1F7 - Command/Status
  70++A0EF D8           	ret	c			;error -> a=#60/#61
  71++A0F0 3E 90        	ld	a,#90			;EXECUTE DEVICE DIAGNOSTIC
  72++A0F2 CD F4 99     	call	kOut_C_A
  73++A0F5 CD A1 A3     	call	hddWaitNoBusy
  74++A0F8 D8           	ret	c			;error -> a=#60
  75++A0F9              ;  ஢塞 ⢥
  76++A0F9 ED 4B 0E 9A  	ld	bc,(kPort1F1)		;Error
  77++A0FD CD F7 99     	call	kIn_A_C
  78++A100 CB 62        	bit	4,d
  79++A102 28 04        	jr	z,goto019		;䨪 master`
  80++A104 FE 80        	cp	#80
  81++A106 28 04        	jr	z,goto020		;slave   
  82++A108 FE 01        goto019	cp	#01
  83++A10A 20 3E        	jr	nz,goto021		;master/slave 
  84++A10C
  85++A10C              ;  
  86++A10C              ;  ஢塞 ᨣ
  87++A10C ED 4B 16 9A  goto020	ld	bc,(kPort1F5)		;Cylinder high
  88++A110 CD F7 99     	call	kIn_A_C
  89++A113 5F           	ld	e,a
  90++A114 ED 4B 14 9A  	ld	bc,(kPort1F4)		;Cylinder low
  91++A118 CD F7 99     	call	kIn_A_C
  92++A11B B3           	or	e
  93++A11C 20 2C        	jr	nz,goto021		;  ,   ஢ ᨣ CD
  94++A11E ED 4B 12 9A  	ld	bc,(kPort1F3)		;Sector number
  95++A122 CD F7 99     	call	kIn_A_C
  96++A125 5F           	ld	e,a
  97++A126 1D           	dec	e
  98++A127 ED 4B 10 9A  	ld	bc,(kPort1F2)		;Sector count
  99++A12B CD F7 99     	call	kIn_A_C
 100++A12E 3D           	dec	a
 101++A12F B3           	or	e
 102++A130 20 18        	jr	nz,goto021		;  ,   ஢ ᨣ CD
 103++A132 CD 50 A1     	call	hddReadIdSec		;⠥ ᥪ 䨪樨
 104++A135 D8           	ret	c			;a=#57/#60/#61/#62
 105++A136              ;  ஢塞   㫨   ᫮
 106++A136 4E           	ld	c,(hl)
 107++A137 23           	inc	hl
 108++A138 46           	ld	b,(hl)			;bc - ࢮ ᫮
 109++A139 23           	inc	hl
 110++A13A 3E FF        	ld	a,#FF
 111++A13C 5E           loop017	ld	e,(hl)			;ࠢ  ⠫묨
 112++A13D 23           	inc	hl
 113++A13E 56           	ld	d,(hl)
 114++A13F 23           	inc	hl
 115++A140 EB           	ex	de,hl
 116++A141 B7           	or	a
 117++A142 ED 42        	sbc	hl,bc
 118++A144 EB           	ex	de,hl
 119++A145 20 07        	jr	nz,goto022		;  ᫮
 120++A147 3D           	dec	a
 121++A148 20 F2        	jr	nz,loop017
 122++A14A
 123++A14A              ;  
 124++A14A 3E 56        goto021	ld	a,#56
 125++A14C 37           	scf
 126++A14D C9           	ret
 127++A14E
 128++A14E              ; ஢ન ன,  
 129++A14E AF           goto022	xor	a
 130++A14F C9           	ret
 131++A150
 132++A150              	endif
 133++A150
 134++A150              ;------------------------------------------------------------------------------
 135++A150              hddReadIdSec	ifused
 136++A150              ;⥭ ᥪ 䨪樨      ix
 137++A150              ;:  ix -    ⥭ ᥪ 䨪樨
 138++A150              ;     d=#E0/#F0 - master/slave
 139++A150              ;: cy=1 訡   -> a -  訡
 140++A150              ;       a=#57 hard disk R/W error
 141++A150              ;       a=#60 busy not found
 142++A150              ;       a=#61 hard disk not ready
 143++A150              ;       a=#62 hard disk data not ready
 144++A150              ;     cy=0 ᥪ ⠭
 145++A150              ;       hl -   ᥪ஬
 146++A150              ;       bc= #1F7
 147++A150              ;
 148++A150              ;hddReadIdSec
 149++A150              ;
 150++A150 ED 4B 18 9A  	ld	bc,(kPort1F6)
 151++A154 7A           	ld	a,d
 152++A155 CD F4 99     	call	kOut_C_A
 153++A158 CD 85 A3     	call	hddWaitReadyCmd		;->bc -  #1F7 - Command/Status
 154++A15B D8           	ret	c			;error -> a=#60/#61
 155++A15C 3E EC        	ld	a,#EC			;IDENTIFY DEVICE
 156++A15E CD F4 99     	call	kOut_C_A
 157++A161 CD 6C A3     	call	hddWaitReadyData
 158++A164 DA 00 9A     	jp	c,kHddReset		;error -> a=#60/#62
 159++A167 DD E5        	push	ix
 160++A169 E1           	pop	hl			;   ⥭ ᥪ
 161++A16A CD FD 99     	call	kHddReadData
 162++A16D C3 6D A1     	jp	hddCheckError		;error -> a=#57
 163++A170              	org	$-3
 164++A16D
 165++A16D              	endif
 166++A16D
 167++A16D              ;------------------------------------------------------------------------------
 168++A16D              hddCheckError	ifused
 169++A16D              ;஢ઠ  訡  室,  砥 訡  
 170++A16D              ;: cy=0 訡  뫮
 171++A16D              ;       =1 뫨 訡 -> a=#57, (ideError) -  訡 
 172++A16D              ;
 173++A16D              ;hddCheckError
 174++A16D              ;
 175++A16D ED 4B 1A 9A  	ld	bc,(kPort1F7)
 176++A171 CD F7 99     	call	kIn_A_C
 177++A174 57           	ld	d,a			;ॣ ﭨ
 178++A175 E6 71        	and	%01110001
 179++A177 EE 50        	xor	%01010000
 180++A179 C8           	ret	z			;室  ⮢   ⢨ 訡
 181++A17A ED 4B 0E 9A  	ld	bc,(kPort1F1)
 182++A17E CD F7 99     	call	kIn_A_C			;⠥  訡
 183++A181 32 11 A5     	ld	(ideError),a		;࠭塞
 184++A184 3E 57        	ld	a,#57			; 訡 ࠩ
 185++A186 37           	scf
 186++A187 C3 00 9A     	jp	kHddReset		;ணࠬ  
 187++A18A
 188++A18A              	endif
 189++A18A
 190++A18A              ;------------------------------------------------------------------------------
 191++A18A              hddResetSmuc	ifused
 192++A18A              ;ணࠬ   SMUC
 193++A18A              ;
 194++A18A              ;hddResetSmuc
 195++A18A              ;
 196++A18A F5           	push	af
 197++A18B C5           	push	bc
 198++A18C
 199++A18C 01 BA FF     	ld	bc,#FFBA
 200++A18F 3E F7        	ld	a,#F7
 201++A191 CD 0C A4     	call	out_C_A_2A53		;device control/alt status on
 202++A194 C5           	push	bc
 203++A195 01 BE FE     	ld	bc,#FEBE
 204++A198 3E 0C        	ld	a,%00001100
 205++A19A CD F4 99     	call	kOut_C_A		;ணࠬ  
 206++A19D 87           	add	a,a			;㧠 383t
 207++A19E 3D           loop015	dec	a			;
 208++A19F 20 FD        	jr	nz,loop015		;
 209++A1A1 CD F4 99     	call	kOut_C_A		;蠥 ணࠬ  
 210++A1A4 C1           	pop	bc
 211++A1A5 3E 77        	ld	a,#77
 212++A1A7 CD 0C A4     	call	out_C_A_2A53		;device control/alt status off
 213++A1AA
 214++A1AA C1           	pop	bc
 215++A1AB F1           	pop	af
 216++A1AC C9           	ret
 217++A1AD
 218++A1AD              	endif
 219++A1AD
 220++A1AD              ;------------------------------------------------------------------------------
 221++A1AD              hddResetNemo	ifused
 222++A1AD              ;ணࠬ   NEMO
 223++A1AD              ;
 224++A1AD              ;hddResetNemo
 225++A1AD              ;
 226++A1AD F5           	push	af
 227++A1AE C5           	push	bc
 228++A1AF
 229++A1AF              ;⠭  
 230++A1AF              ;	ld	bc,(kPort1F6)
 231++A1AF              ;	ld	a,(idePort1F6)
 232++A1AF              ;	out	(c),a			;  
 233++A1AF
 234++A1AF              ; 
 235++A1AF ED 4B 1C 9A  	ld	bc,(kPort3F6)
 236++A1B3 3E 04        	ld	a,%00000100
 237++A1B5 ED 79        	out	(c),a			;ணࠬ  
 238++A1B7              	IFDEF	PROFIide
 239++A1B7 CD 2B A4     	 call	Pause70k
 240++A1BA              	ELSE
 241++A1BA ~            	 xor	a			;㧠 4095t
 242++A1BA ~            loop014	 dec	a			;
 243++A1BA ~            	 jr	nz,loop014		;
 244++A1BA              	ENDIF
 245++A1BA ED 79        	out	(c),a			;蠥 ணࠬ  
 246++A1BC              	IFDEF	PROFIide
 247++A1BC CD 2B A4     	 call	Pause70k
 248++A1BF              	ELSE
 249++A1BF ~            loop049	 dec	a			;
 250++A1BF ~            	 jr	nz,loop049		;
 251++A1BF              	ENDIF
 252++A1BF
 253++A1BF C1           	pop	bc
 254++A1C0 F1           	pop	af
 255++A1C1 C9           	ret
 256++A1C2
 257++A1C2              	endif
 258++A1C2
 259++A1C2              ;------------------------------------------------------------------------------
 260++A1C2              hddReadDataSv1	ifused
 261++A1C2              ;⥭ 512b    㥬 hl ( SMUC v1 shadow)
 262++A1C2              ;:  hl -    ⥭ 
 263++A1C2              ;: cy=0
 264++A1C2              ;     hl -  
 265++A1C2              ;     a=#00
 266++A1C2              ;     de,bc - ???
 267++A1C2              ;
 268++A1C2              ;hddReadDataSv1
 269++A1C2              ;
 270++A1C2 F3           	di
 271++A1C3 DD E5        	push	ix
 272++A1C5 E5           	push	hl
 273++A1C6 ED 73 04 A2  	ld	(cng_02+1),sp
 274++A1CA EB           	ex	de,hl
 275++A1CB 0E BE        	ld	c,#BE
 276++A1CD 21 2F 3D     	ld	hl,#3D2F
 277++A1D0 DD 2E 40     	ld	xl,#40
 278++A1D3 31 0C A2     loop013	ld	sp,var_02
 279++A1D6 06 F8        	ld	b,#F8
 280++A1D8 E9           	jp	(hl)
 281++A1D9 12           goto011	ld	(de),a
 282++A1DA 13           	inc	de
 283++A1DB 06 D8        	ld	b,#D8
 284++A1DD E9           	jp	(hl)
 285++A1DE 12           goto012	ld	(de),a
 286++A1DF 13           	inc	de
 287++A1E0 06 F8        	ld	b,#F8
 288++A1E2 E9           	jp	(hl)
 289++A1E3 12           goto013	ld	(de),a
 290++A1E4 13           	inc	de
 291++A1E5 06 D8        	ld	b,#D8
 292++A1E7 E9           	jp	(hl)
 293++A1E8 12           goto014	ld	(de),a
 294++A1E9 13           	inc	de
 295++A1EA 06 F8        	ld	b,#F8
 296++A1EC E9           	jp	(hl)
 297++A1ED 12           goto015	ld	(de),a
 298++A1EE 13           	inc	de
 299++A1EF 06 D8        	ld	b,#D8
 300++A1F1 E9           	jp	(hl)
 301++A1F2 12           goto016	ld	(de),a
 302++A1F3 13           	inc	de
 303++A1F4 06 F8        	ld	b,#F8
 304++A1F6 E9           	jp	(hl)
 305++A1F7 12           goto017	ld	(de),a
 306++A1F8 13           	inc	de
 307++A1F9 06 D8        	ld	b,#D8
 308++A1FB E9           	jp	(hl)
 309++A1FC 12           goto018	ld	(de),a
 310++A1FD 13           	inc	de
 311++A1FE DD 2D        	dec	xl
 312++A200 C2 D3 A1     	jp	nz,loop013
 313++A203 31 00 00     cng_02	ld	sp,#0000
 314++A206 E1           	pop	hl
 315++A207 DD E1        	pop	ix
 316++A209 FB           	ei
 317++A20A AF           	xor	a
 318++A20B C9           	ret
 319++A20C F3 3F D9 A1  var_02	dw	dosInPort,goto011
 320++A210 F3 3F DE A1  	dw	dosInPort,goto012
 321++A214 F3 3F E3 A1  	dw	dosInPort,goto013
 322++A218 F3 3F E8 A1  	dw	dosInPort,goto014
 323++A21C F3 3F ED A1  	dw	dosInPort,goto015
 324++A220 F3 3F F2 A1  	dw	dosInPort,goto016
 325++A224 F3 3F F7 A1  	dw	dosInPort,goto017
 326++A228 F3 3F FC A1  	dw	dosInPort,goto018
 327++A22C
 328++A22C              	endif
 329++A22C
 330++A22C              ;------------------------------------------------------------------------------
 331++A22C              hddReadDataSv2	ifused
 332++A22C              ;⥭ 512b    㥬 hl ( SMUC v2)
 333++A22C              ;:  hl -    ⥭ 
 334++A22C              ;: cy=0
 335++A22C              ;     hl -  
 336++A22C              ;     a=#00
 337++A22C              ;     de,bc - ???
 338++A22C              ;
 339++A22C              ;hddReadDataSv2
 340++A22C              ;
 341++A22C E5           	push	hl
 342++A22D 0E BE        	ld	c,#BE
 343++A22F 11 F8 D8     	ld	de,#D8F8
 344++A232 AF           	xor	a
 345++A233 43           loop012	ld	b,e		; #F8BE ॣ  ( )
 346++A234 ED A2        	ini
 347++A236 42           	ld	b,d		; #D8BE ॣ  ( )
 348++A237 ED A2        	ini
 349++A239 3D           	dec	a
 350++A23A C2 33 A2     	jp	nz,loop012
 351++A23D E1           	pop	hl
 352++A23E AF           	xor	a
 353++A23F C9           	ret
 354++A240
 355++A240              	endif
 356++A240
 357++A240              ;------------------------------------------------------------------------------
 358++A240              hddReadDataN	ifused
 359++A240              ;⥭ 512b    㥬 hl ( NEMO)
 360++A240              ;:  hl -    ⥭ 
 361++A240              ;: cy=0
 362++A240              ;     hl -  
 363++A240              ;     a=#00
 364++A240              ;     bc - ???
 365++A240              ;
 366++A240              ;hddReadDataN
 367++A240              ;
 368++A240 E5           	push	hl
 369++A241 01 10 FF     	ld	bc,#FF10	; #FF10 ॣ  ( )
 370++A244 AF           	xor	a
 371++A245 ED A2        loop011	ini
 372++A247 04           	inc	b
 373++A248 0C           	inc	c		; #FF11 ॣ  ( )
 374++A249 ED A2        	ini
 375++A24B 04           	inc	b
 376++A24C 0D           	dec	c
 377++A24D 3D           	dec	a
 378++A24E C2 45 A2     	jp	nz,loop011
 379++A251 E1           	pop	hl
 380++A252 AF           	xor	a
 381++A253 C9           	ret
 382++A254
 383++A254              	endif
 384++A254
 385++A254              ;------------------------------------------------------------------------------
 386++A254              hddReadDataNA8	ifused
 387++A254              ;⥭ 512b    㥬 hl ( NEMO A8)
 388++A254              ;:  hl -    ⥭ 
 389++A254              ;: cy=0
 390++A254              ;     hl -  
 391++A254              ;     a=#00
 392++A254              ;     de,bc - ???
 393++A254              ;
 394++A254              ;hddReadDataNA8
 395++A254              ;
 396++A254 01 10 00     	ld	bc,#0010
 397++A257 18 03        	jr	goto010
 398++A259 18 FE        	jr	hddReadDataAtm
 399++A25B              	org	$-2
 400++A259
 401++A259              	endif
 402++A259
 403++A259              ;------------------------------------------------------------------------------
 404++A259              hddReadDataAtm	ifused
 405++A259              ;⥭ 512b    㥬 hl ( ATM-IDE)
 406++A259              ;:  hl -    ⥭ 
 407++A259              ;: cy=0
 408++A259              ;     hl -  
 409++A259              ;     a=#00
 410++A259              ;     de,bc - ???
 411++A259              ;
 412++A259              ;hddReadDataAtm
 413++A259              ;
 414++A259 01 0F 00     	ld	bc,#000F
 415++A25C E5           goto010	push	hl
 416++A25D ED B2        	inir
 417++A25F ED B2        	inir
 418++A261 E1           	pop	hl
 419++A262 AF           	xor	a
 420++A263 C9           	ret
 421++A264
 422++A264              	endif
 423++A264
 424++A264              ;------------------------------------------------------------------------------
 425++A264              hddReadDataPrf	ifused
 426++A264              ;⥭ 512b    㥬 hl ( PROFI IDE)
 427++A264              ;:  hl -    ⥭ 
 428++A264              ;: cy=0
 429++A264              ;     hl -  
 430++A264              ;     a=#00
 431++A264              ;     de,bc - ???
 432++A264              ;
 433++A264              ;hddReadDataPrf
 434++A264              ;
 435++A264 E5           	push	hl
 436++A265 11 CB EB     	ld	de,#EBCB
 437++A268 AF           	xor	a
 438++A269 47           	ld	b,a
 439++A26A 4B           loop048	ld	c,e			; #00CB ॣ  ( )
 440++A26B ED A2        	ini
 441++A26D 04           	inc	b
 442++A26E 4A           	ld	c,d			; #00EB ॣ  ( )
 443++A26F ED A2        	ini
 444++A271 04           	inc	b
 445++A272 3D           	dec	a
 446++A273 C2 6A A2     	jp	nz,loop048
 447++A276 E1           	pop	hl
 448++A277 AF           	xor	a
 449++A278 C9           	ret
 450++A279
 451++A279              	endif
 452++A279
 453++A279              ;------------------------------------------------------------------------------
 454++A279              hddWriteDataSv1	ifused
 455++A279              ; 512b    㥬 hl ( SMUC v1 shadow)
 456++A279              ;:  hl -     
 457++A279              ;: cy=0
 458++A279              ;     hl -  
 459++A279              ;     a=#00
 460++A279              ;     de,bc - ???
 461++A279              ;
 462++A279              ;hddWriteDataSv1
 463++A279              ;
 464++A279 F3           	di
 465++A27A DD E5        	push	ix
 466++A27C E5           	push	hl
 467++A27D ED 73 C5 A2  	ld	(cng_01+1),sp
 468++A281 0E BE        	ld	c,#BE
 469++A283 DD 21 2F 3D  	ld	ix,#3D2F
 470++A287 16 40        	ld	d,#40
 471++A289 31 CD A2     loop006	ld	sp,var_01
 472++A28C 5E           	ld	e,(hl)
 473++A28D 23           	inc	hl
 474++A28E 7E           	ld	a,(hl)
 475++A28F 23           	inc	hl
 476++A290 06 D8        	ld	b,#D8
 477++A292 DD E9        	jp	(ix)
 478++A294 06 F8        goto001	ld	b,#F8
 479++A296 7B           	ld	a,e
 480++A297 DD E9        	jp	(ix)
 481++A299 5E           goto002	ld	e,(hl)
 482++A29A 23           	inc	hl
 483++A29B 7E           	ld	a,(hl)
 484++A29C 23           	inc	hl
 485++A29D 06 D8        	ld	b,#D8
 486++A29F DD E9        	jp	(ix)
 487++A2A1 06 F8        goto003	ld	b,#F8
 488++A2A3 7B           	ld	a,e
 489++A2A4 DD E9        	jp	(ix)
 490++A2A6 5E           goto004	ld	e,(hl)
 491++A2A7 23           	inc	hl
 492++A2A8 7E           	ld	a,(hl)
 493++A2A9 23           	inc	hl
 494++A2AA 06 D8        	ld	b,#D8
 495++A2AC DD E9        	jp	(ix)
 496++A2AE 06 F8        goto005	ld	b,#F8
 497++A2B0 7B           	ld	a,e
 498++A2B1 DD E9        	jp	(ix)
 499++A2B3 5E           goto006	ld	e,(hl)
 500++A2B4 23           	inc	hl
 501++A2B5 7E           	ld	a,(hl)
 502++A2B6 23           	inc	hl
 503++A2B7 06 D8        	ld	b,#D8
 504++A2B9 DD E9        	jp	(ix)
 505++A2BB 06 F8        goto007	ld	b,#F8
 506++A2BD 7B           	ld	a,e
 507++A2BE DD E9        	jp	(ix)
 508++A2C0 15           goto008	dec	d
 509++A2C1 C2 89 A2     	jp	nz,loop006
 510++A2C4 31 00 00     cng_01	ld	sp,#0000
 511++A2C7 E1           	pop	hl
 512++A2C8 DD E1        	pop	ix
 513++A2CA FB           	ei
 514++A2CB AF           	xor	a
 515++A2CC C9           	ret
 516++A2CD F0 3F 94 A2  var_01	dw	dosOutPort,goto001
 517++A2D1 F0 3F 99 A2  	dw	dosOutPort,goto002
 518++A2D5 F0 3F A1 A2  	dw	dosOutPort,goto003
 519++A2D9 F0 3F A6 A2  	dw	dosOutPort,goto004
 520++A2DD F0 3F AE A2  	dw	dosOutPort,goto005
 521++A2E1 F0 3F B3 A2  	dw	dosOutPort,goto006
 522++A2E5 F0 3F BB A2  	dw	dosOutPort,goto007
 523++A2E9 F0 3F C0 A2  	dw	dosOutPort,goto008
 524++A2ED
 525++A2ED              	endif
 526++A2ED
 527++A2ED              ;------------------------------------------------------------------------------
 528++A2ED              hddWriteDataSv2	ifused
 529++A2ED              ; 512b    㥬 hl ( SMUC v2)
 530++A2ED              ;:  hl -     
 531++A2ED              ;: cy=0
 532++A2ED              ;     hl -  
 533++A2ED              ;     a=#00
 534++A2ED              ;     de,bc - ???
 535++A2ED              ;
 536++A2ED              ;hddWriteDataSv2
 537++A2ED              ;
 538++A2ED E5           	push	hl
 539++A2EE 0E BE        	ld	c,#BE
 540++A2F0 11 F9 D9     	ld	de,#D9F9	; outd 砫  dec b
 541++A2F3 AF           	xor	a
 542++A2F4 42           loop010	ld	b,d		; #D8BE ॣ  ( )
 543++A2F5 23           	inc	hl
 544++A2F6 ED AB        	outd
 545++A2F8 43           	ld	b,e		; #F8BE ॣ  ( )
 546++A2F9 ED A3        	outi
 547++A2FB 23           	inc	hl
 548++A2FC 3D           	dec	a
 549++A2FD C2 F4 A2     	jp	nz,loop010
 550++A300 E1           	pop	hl
 551++A301 AF           	xor	a
 552++A302 C9           	ret
 553++A303
 554++A303              	endif
 555++A303
 556++A303              ;------------------------------------------------------------------------------
 557++A303              hddWriteDataN	ifused
 558++A303              ; 512b    㥬 hl ( NEMO)
 559++A303              ;:  hl -     
 560++A303              ;: cy=0
 561++A303              ;     hl -  
 562++A303              ;     a=#00
 563++A303              ;     de,bc - ???
 564++A303              ;
 565++A303              ;hddWriteDataN
 566++A303              ;
 567++A303 E5           	push	hl
 568++A304 01 11 00     	ld	bc,#0011		; outd 砫  dec b
 569++A307 AF           	xor	a
 570++A308 23           loop009	inc	hl
 571++A309 ED AB        	outd				;訩 
 572++A30B 0D           	dec	c
 573++A30C 04           	inc	b
 574++A30D ED A3        	outi				;訩 
 575++A30F 0C           	inc	c
 576++A310 04           	inc	b
 577++A311 23           	inc	hl
 578++A312 3D           	dec	a
 579++A313 C2 08 A3     	jp	nz,loop009
 580++A316 E1           	pop	hl
 581++A317 AF           	xor	a
 582++A318 C9           	ret
 583++A319
 584++A319              	endif
 585++A319
 586++A319              ;------------------------------------------------------------------------------
 587++A319              hddWriteDataNA8	ifused
 588++A319              ; 512b    㥬 hl ( NEMO A8)
 589++A319              ;:  hl -     
 590++A319              ;: cy=0
 591++A319              ;     hl -  
 592++A319              ;     a=#00
 593++A319              ;     de,bc - ???
 594++A319              ;
 595++A319              ;hddWriteDataNA8
 596++A319              ;
 597++A319 0E 10        	ld	c,#10
 598++A31B 18 02        	jr	goto009
 599++A31D 18 FE        	jr	hddWriteDataAtm
 600++A31F              	org	$-2
 601++A31D
 602++A31D              	endif
 603++A31D
 604++A31D              ;------------------------------------------------------------------------------
 605++A31D              hddWriteDataAtm	ifused
 606++A31D              ; 512b    㥬 hl ( ATM-IDE)
 607++A31D              ;:  hl -     
 608++A31D              ;: cy=0
 609++A31D              ;     hl -  
 610++A31D              ;     a=#00
 611++A31D              ;     de,bc - ???
 612++A31D              ;
 613++A31D              ;hddWriteDataAtm
 614++A31D              ;
 615++A31D 0E 0F        	ld	c,#0F
 616++A31F E5           goto009	push	hl
 617++A320 AF           	xor	a
 618++A321 5F           	ld	e,a			; outd 砫  dec b
 619++A322 43           loop007	ld	b,e
 620++A323 23           	inc	hl
 621++A324 ED AB        	outd				;訩 
 622++A326 ED A3        	outi				;訩 
 623++A328 23           	inc	hl
 624++A329 3D           	dec	a
 625++A32A C2 22 A3     	jp	nz,loop007
 626++A32D E1           	pop	hl
 627++A32E AF           	xor	a
 628++A32F C9           	ret
 629++A330
 630++A330              	endif
 631++A330
 632++A330              ;------------------------------------------------------------------------------
 633++A330              hddWriteDataPrf	ifused
 634++A330              ; 512b    㥬 hl ( PROFI-IDE)
 635++A330              ;:  hl -     
 636++A330              ;: cy=0
 637++A330              ;     hl -  
 638++A330              ;     a=#00
 639++A330              ;     de,bc - ???
 640++A330              ;
 641++A330              ;hddWriteDataPrf
 642++A330              ;
 643++A330 E5           	push	hl
 644++A331 11 CB EB     	ld	de,#EBCB
 645++A334 AF           	xor	a
 646++A335 47           	ld	b,a
 647++A336 04           loop047	inc	b			; outd 砫  dec b
 648++A337 4B           	ld	c,e			; #00CB ॣ  ( )
 649++A338 23           	inc	hl
 650++A339 ED AB        	outd
 651++A33B 04           	inc	b
 652++A33C 4A           	ld	c,d			; #00EB ॣ  ( )
 653++A33D ED A3        	outi
 654++A33F 23           	inc	hl
 655++A340 3D           	dec	a
 656++A341 C2 36 A3     	jp	nz,loop047
 657++A344 E1           	pop	hl
 658++A345 AF           	xor	a
 659++A346 C9           	ret
 660++A347
 661++A347              	endif
 662++A347
 663++A347              ;------------------------------------------------------------------------------
 664++A347              hddSendCmd	ifused
 665++A347              ;뫠  
 666++A347              ;:  a -  
 667++A347              ;: cy=1 HDD  襫  ⮢
 668++A347              ;       a=#60 busy not found
 669++A347              ;       a=#61 hard disk not ready
 670++A347              ;     cy=0  㦥  ॣ
 671++A347              ;        a,d -  
 672++A347              ;     bc -  #1F7
 673++A347              ;     hl,e - ???
 674++A347              ;
 675++A347              ;hddSendCmd
 676++A347              ;
 677++A347              ; ⮢ hdd
 678++A347 57           	ld	d,a
 679++A348 CD A1 A3     	call	hddWaitNoBusy		; ⮢ HDD
 680++A34B D8           	ret	c			;訡: hdd  襫  ⮢
 681++A34C
 682++A34C              ;㧪  ॣ - ᥪ஢,  LBA/CHS, ⨯ ன⢠
 683++A34C D5           	push	de
 684++A34D 11 D8 A4     	ld	de,idePort1F1
 685++A350 21 0E 9A     	ld	hl,kPort1F1
 686++A353 3E 06        	ld	a,#06
 687++A355 F5           loop005	push	af
 688++A356 4E           	ld	c,(hl)
 689++A357 23           	inc	hl
 690++A358 46           	ld	b,(hl)
 691++A359 23           	inc	hl
 692++A35A 1A           	ld	a,(de)
 693++A35B 13           	inc	de
 694++A35C CD F4 99     	call	kOut_C_A
 695++A35F F1           	pop	af
 696++A360 3D           	dec	a
 697++A361 20 F2        	jr	nz,loop005
 698++A363 D1           	pop	de
 699++A364
 700++A364              ; ⮢  ਥ 
 701++A364 CD 85 A3     	call	hddWaitReadyCmd		; ⮢ HDD  ਭ 
 702++A367 D8           	ret	c			;訡: hdd  襫  ⮢
 703++A368 7A           	ld	a,d
 704++A369 C3 F4 99     	jp	kOut_C_A
 705++A36C
 706++A36C              	endif
 707++A36C
 708++A36C              ;------------------------------------------------------------------------------
 709++A36C              hddWaitReadyData	ifused
 710++A36C              ; ⮢ HDD  । 
 711++A36C              ;:  ---
 712++A36C              ;: cy=1 HDD  襫  ⮢
 713++A36C              ;       a=#60 busy not found
 714++A36C              ;       a=#62 hard disk data not ready
 715++A36C              ;     cy=0 HDD ⮢  ਭ 
 716++A36C              ;        a - ॣ ﭨ
 717++A36C              ;     bc -  #1F7
 718++A36C              ;     hl,e - ???
 719++A36C              ;
 720++A36C              ;hddWaitReadyData
 721++A36C              ;
 722++A36C CD A1 A3     	call	hddWaitNoBusy		; ⮢ HDD
 723++A36F D8           	ret	c			;訡: hdd  襫  ⮢
 724++A370 CB 5F        	bit	3,a
 725++A372 C0           	ret	nz			; ⮢  । 
 726++A373              ;bc -  #1F7
 727++A373
 728++A373              ; ⮢  । 
 729++A373 21 80 00     	ld	hl,dataTimeOut
 730++A376 CD F7 99     loop004	call	kIn_A_C			;⠥ ॣ ﭨ
 731++A379 CB 5F        	bit	3,a
 732++A37B C0           	ret	nz			; ⮢  । 
 733++A37C 2B           	dec	hl
 734++A37D 7C           	ld	a,h
 735++A37E B5           	or	l
 736++A37F 20 F5        	jr	nz,loop004
 737++A381 3E 62        	ld	a,#62
 738++A383 37           	scf
 739++A384 C9           	ret
 740++A385
 741++A385              	endif
 742++A385
 743++A385              ;------------------------------------------------------------------------------
 744++A385              hddWaitReadyCmd	ifused
 745++A385              ; ⮢ HDD  ਭ 
 746++A385              ;:  ---
 747++A385              ;: cy=1 HDD  襫  ⮢
 748++A385              ;       a=#60 busy not found
 749++A385              ;       a=#61 hard disk not ready
 750++A385              ;     cy=0 HDD ⮢  ਭ 
 751++A385              ;        a - ॣ ﭨ
 752++A385              ;     bc -  #1F7
 753++A385              ;     hl,e - ???
 754++A385              ;
 755++A385              ;hddWaitReadyCmd
 756++A385              ;
 757++A385 CD A1 A3     	call	hddWaitNoBusy		; ⮢ HDD
 758++A388 D8           	ret	c			;訡: hdd  襫  ⮢
 759++A389 CB 77        	bit	6,a
 760++A38B C0           	ret	nz			;室.  ⮢ ਭ 
 761++A38C              ;bc -  #1F7
 762++A38C
 763++A38C              ; ⮢ ਭ 
 764++A38C 21 10 00     	ld	hl,cmdTimeOut
 765++A38F CD F7 99     loop003	call	kIn_A_C			;⠥ ॣ ﭨ
 766++A392 CB 77        	bit	6,a
 767++A394 C0           	ret	nz			;室.  ⮢ ਭ 
 768++A395 1D           	dec	e
 769++A396 20 F7        	jr	nz,loop003
 770++A398 2B           	dec	hl
 771++A399 7C           	ld	a,h
 772++A39A B5           	or	l
 773++A39B 20 F2        	jr	nz,loop003
 774++A39D 3E 61        	ld	a,#61
 775++A39F 37           	scf
 776++A3A0 C9           	ret
 777++A3A1
 778++A3A1              	endif
 779++A3A1
 780++A3A1              ;------------------------------------------------------------------------------
 781++A3A1              hddWaitNoBusy	ifused
 782++A3A1              ; ⮢ HDD
 783++A3A1              ;:  ---
 784++A3A1              ;: cy=1 HDD  襫  ⮢
 785++A3A1              ;       a=#60 busy not found
 786++A3A1              ;     cy=0 HDD ⮢
 787++A3A1              ;        a - ॣ ﭨ
 788++A3A1              ;     bc -  #1F7
 789++A3A1              ;     hl,e - ???
 790++A3A1              ;
 791++A3A1              ;hddWaitNoBusy
 792++A3A1              ;
 793++A3A1              ;⠭  
 794++A3A1 ED 4B 18 9A  	ld	bc,(kPort1F6)
 795++A3A5 3A DD A4     	ld	a,(idePort1F6)
 796++A3A8 CD F4 99     	call	kOut_C_A		;  
 797++A3AB              ;	IFDEF	PROFIide
 798++A3AB              ;	 ld	a,(DrvHDD.ideType)
 799++A3AB              ;	 and	#20
 800++A3AB              ;	 call	nz,Pause70k
 801++A3AB              ;	ENDIF
 802++A3AB
 803++A3AB              ; ⮢
 804++A3AB ED 4B 1A 9A  	ld	bc,(kPort1F7)
 805++A3AF 21 20 00     	ld	hl,busyTimeOut		;⢮ ⮪
 806++A3B2 AF           loop002	xor	a
 807++A3B3 5F           	ld	e,a
 808++A3B4 CD F7 99     loop001	call	kIn_A_C			;⠥ ॣ ﭨ
 809++A3B7 CB 7F        	bit	7,a
 810++A3B9 C8           	ret	z			;HDD ⮢
 811++A3BA 1D           	dec	e			;HDD 
 812++A3BB 20 F7        	jr	nz,loop001		;塞 ⪨
 813++A3BD 2B           	dec	hl
 814++A3BE 7C           	ld	a,h
 815++A3BF B5           	or	l
 816++A3C0 20 F0        	jr	nz,loop002
 817++A3C2 3E 60        	ld	a,#60			;HDD  襫  ⮢
 818++A3C4 37           	scf
 819++A3C5 C9           	ret
 820++A3C6
 821++A3C6              	endif
 822++A3C6
 823++A3C6              ;------------------------------------------------------------------------------
 824++A3C6              smucTest3FF0	ifused
 825++A3C6              ;஢ઠ    ࠡ Smuc v1
 826++A3C6              ;: cy=1 窨 室 
 827++A3C6              ;
 828++A3C6              ;smucTest3FF0
 829++A3C6              ;
 830++A3C6              ;㥬  tr-dos
 831++A3C6 FD E5        	push	iy
 832++A3C8 21 F0 3F     	ld	hl,dosOutPort
 833++A3CB 0E 13        	ld	c,#13
 834++A3CD F3           	di
 835++A3CE FD 21 3A 5C  	ld	iy,#5C3A
 836++A3D2 ED 46        	im	0
 837++A3D4 CD 13 3D     	call	#3D13
 838++A3D7 ED 56        	im	1 ;2
 839++A3D9 FB           	ei
 840++A3DA FD E1        	pop	iy
 841++A3DC
 842++A3DC              ;஢塞
 843++A3DC 06 06        	ld	b,#06
 844++A3DE 21 DD 5C     	ld	hl,#5CDD
 845++A3E1 11 EE A3     	ld	de,var_03
 846++A3E4 1A           loop025	ld	a,(de)
 847++A3E5 BE           	cp	(hl)
 848++A3E6 37           	scf
 849++A3E7 C0           	ret	nz
 850++A3E8 23           	inc	hl
 851++A3E9 13           	inc	de
 852++A3EA 10 F8        	djnz	loop025
 853++A3EC B7           	or	a
 854++A3ED C9           	ret
 855++A3EE ED 79        var_03	db	#ED,#79			;out (c),a
 856++A3F0 C9           	db	#C9			;ret
 857++A3F1 ED 78        	db	#ED,#78			;in a,(c)
 858++A3F3 C9           	db	#C9			;ret
 859++A3F4
 860++A3F4              	endif
 861++A3F4
 862++A3F4              ;------------------------------------------------------------------------------
 863++A3F4              profiPortsOff	ifused
 864++A3F4              ;몫祭 ⮢ PROFI
 865++A3F4              ;:  ---
 866++A3F4              ;
 867++A3F4              ;profiPortsOff
 868++A3F4              ;
 869++A3F4 3E 00        	ld	a,baseDFFDoff
 870++A3F6 18 02        	jr	goto068
 871++A3F8 18 FE        	jr	profiPortsOn
 872++A3FA              	org	$-2
 873++A3F8
 874++A3F8              	endif
 875++A3F8
 876++A3F8              ;------------------------------------------------------------------------------
 877++A3F8              profiPortsOn	ifused
 878++A3F8              ;祭 ⮢ PROFI
 879++A3F8              ;:  ---
 880++A3F8              ;
 881++A3F8              ;profiPortsOn
 882++A3F8              ;
 883++A3F8 3E 20        	ld	a,baseDFFDon
 884++A3FA 01 FD DF     goto068	ld	bc,#DFFD
 885++A3FD ED 79        	out	(c),a
 886++A3FF B7           	or	a
 887++A400 C9           	ret
 888++A401
 889++A401              	endif
 890++A401
 891++A401              ;------------------------------------------------------------------------------
 892++A401              atmPortsOff	ifused
 893++A401              ;몫祭 ⮢ ATM
 894++A401              ;:  ---
 895++A401              ;
 896++A401              ;atmPortsOff
 897++A401              ;
 898++A401 01 77 FF     	ld	bc,#FF77
 899++A404              ;	ld	a,%10101000 or atmXX77
 900++A404 18 03        	jr	goto027
 901++A406
 902++A406              	endif
 903++A406
 904++A406              ;------------------------------------------------------------------------------
 905++A406              atmPortsOn	ifused
 906++A406              ;祭 ⮢ ATM
 907++A406              ;:  ---
 908++A406              ;
 909++A406              ;atmPortsOn
 910++A406              ;
 911++A406 01 77 FD     	ld	bc,#FD77
 912++A409 3E AB        goto027	ld	a,%10101000 or atmXX77
 913++A40B B7           	or	a
 914++A40C 18 FE        	jr	out_C_A_2A53
 915++A40E              	org	$-2
 916++A40C
 917++A40C              	endif
 918++A40C
 919++A40C              ;------------------------------------------------------------------------------
 920++A40C              out_C_A_2A53	ifused
 921++A40C              ;  ⥭ 
 922++A40C              ;:  bc - 
 923++A40C              ;     a - ᫤ন 
 924++A40C              ;
 925++A40C              ;out_C_A_2A53
 926++A40C              ;
 927++A40C              	IFDEF	openDOS		;⥭  
 928++A40C ~            	 out	(c),a
 929++A40C ~            	 ret
 930++A40C              	ELSE
 931++A40C E5           	 push	hl
 932++A40D 21 53 2A     	 ld	hl,#2A53
 933++A410 E3           	 ex	(sp),hl
 934++A411 C3 2F 3D     	 jp	#3D2F
 935++A414              	ENDIF
 936++A414
 937++A414              	endif
 938++A414
 939++A414              ;------------------------------------------------------------------------------
 940++A414              out_C_A		ifused
 941++A414              ;  ⥭ 
 942++A414              ;:  bc - 
 943++A414              ;     a - ᫤ন 
 944++A414              ;
 945++A414              ;out_C_A
 946++A414              ;
 947++A414 E5           	push	hl
 948++A415 21 F0 3F     	ld	hl,dosOutPort
 949++A418 E3           	ex	(sp),hl
 950++A419 C3 2F 3D     	jp	#3D2F
 951++A41C
 952++A41C              	endif
 953++A41C
 954++A41C              ;------------------------------------------------------------------------------
 955++A41C              in_A_C_profi	ifused
 956++A41C              ;⥭  PROFI
 957++A41C              ;:  bc - 
 958++A41C              ;: a - ᫤ন 
 959++A41C              ;
 960++A41C              ;in_A_C_profi
 961++A41C              ;
 962++A41C CB A9        	res	5,c
 963++A41E ED 78        	in	a,(c)
 964++A420 CB E9        	set	5,c
 965++A422 C9           	ret
 966++A423
 967++A423              	endif
 968++A423
 969++A423              ;------------------------------------------------------------------------------
 970++A423              in_A_C		ifused
 971++A423              ;⥭ ⥭ 
 972++A423              ;:  bc - 
 973++A423              ;: a - ᫤ন 
 974++A423              ;
 975++A423              ;in_A_C
 976++A423              ;
 977++A423 E5           	push	hl
 978++A424 21 F3 3F     	ld	hl,dosInPort
 979++A427 E3           	ex	(sp),hl
 980++A428 C3 2F 3D     	jp	#3D2F
 981++A42B
 982++A42B              	endif
 983++A42B
 984++A42B              ;==============================================================================
 985++A42B              ;
 986++A42B              ;==============================================================================
 987++A42B
# file closed: Drivers/DrvHDD/DrvHDD.ide.a80
 229+ A42B              	INCLUDE		"DrvHDD.calc.a80"
# file opened: Drivers/DrvHDD/DrvHDD.calc.a80
   1++A42B              ;楤  HDD Driver. 楤  ⥬᪨ ⮢
   2++A42B              ;䠩 DrvHDD.calc.a80
   3++A42B              ;
   4++A42B              ;Pause70k		প 70k ⠪⮢
   5++A42B              ;SetZeroDEHL		㫥 dehl
   6++A42B              ;hddLBAtoCHS		८ࠧ  LBA  CHS
   7++A42B              ;calcHLequEmulA		㬭: hl=e*a
   8++A42B              ;altDEHLdivBC		 de'hl'=de'hl'/bc
   9++A42B              ;
  10++A42B              ;------------------------------------------------------------------------------
  11++A42B              Pause70k	ifused
  12++A42B              ;প 70k ⠪⮢
  13++A42B              ;: bc=#0000
  14++A42B              ;     a=#00
  15++A42B              ;
  16++A42B              ;Pause70k
  17++A42B              ;
  18++A42B C5           	push	bc
  19++A42C 01 28 0A     	ld	bc,2600
  20++A42F 0B           loop050	dec	bc
  21++A430 78           	ld	a,b
  22++A431 B1           	or	c
  23++A432 20 FB        	jr	nz,loop050
  24++A434 C1           	pop	bc
  25++A435 C9           	ret
  26++A436
  27++A436              	endif
  28++A436
  29++A436              ;------------------------------------------------------------------------------
  30++A436              SetZeroDEHL	ifused
  31++A436 ~            ;㫥 dehl
  32++A436 ~            ;: dehl=#00000000
  33++A436 ~            ;
  34++A436 ~            ;SetZeroDEHL
  35++A436 ~            ;
  36++A436 ~            	ld	hl,#0000
  37++A436 ~            	ld	e,l
  38++A436 ~            	ld	d,l
  39++A436 ~            	ret
  40++A436 ~
  41++A436              	endif
  42++A436
  43++A436              ;------------------------------------------------------------------------------
  44++A436              hddLBAtoCHS	ifused
  45++A436              ;८ࠧ  LBA  CHS
  46++A436              ;:  dehl - LBA  ᥪ
  47++A436              ;: de -  樫 CHS
  48++A436              ;     c -  ᥪ CHS
  49++A436              ;     a -   CHS
  50++A436              ;
  51++A436              ;hddLBAtoCHS
  52++A436              ;
  53++A436 D9           	exx
  54++A437 ED 4B EA A4  	ld	bc,(devHmulS)		;head*sector (ᥪ஢  樫)
  55++A43B CD 7D A4     	call	altDEHLdivBC		; de'hl'=de'hl'/bc
  56++A43E D9           	exx
  57++A43F 7A           	ld	a,d
  58++A440 B3           	or	e
  59++A441 20 21        	jr	nz,goto038		; । CHS
  60++A443 47           	ld	b,a			;b=#00
  61++A444 EB           	ex	de,hl
  62++A445 2A E6 A4     	ld	hl,(devCylinders)
  63++A448 ED 52        	sbc	hl,de
  64++A44A 38 18        	jr	c,goto038		; । CHS
  65++A44C D5           	push	de			; 樫 CHS
  66++A44D 3A E9 A4     	ld	a,(devSectors)
  67++A450 4F           	ld	c,a			;bc - 祭 sector HDD
  68++A451 F5           	push	af
  69++A452 CD 7D A4     	call	altDEHLdivBC		; de'hl'=de'hl'/bc
  70++A455 F1           	pop	af
  71++A456 D1           	pop	de
  72++A457 2C           	inc	l
  73++A458 BD           	cp	l
  74++A459 38 09        	jr	c,goto038		; । CHS
  75++A45B 7D           	ld	a,l			; ᥪ CHS
  76++A45C D9           	exx
  77++A45D 4F           	ld	c,a
  78++A45E 3A E8 A4     	ld	a,(devHeads)
  79++A461 BD           	cp	l
  80++A462 7D           	ld	a,l			;  CHS
  81++A463 D0           	ret	nc			;ࠬ  । CHS
  82++A464
  83++A464              ; । CHS, ⠢ ᨬ 祭
  84++A464 ED 5B E6 A4  goto038	ld	de,(devCylinders)
  85++A468 2A E8 A4     	ld	hl,(devHeads)
  86++A46B 7D           	ld	a,l
  87++A46C 4C           	ld	c,h
  88++A46D 1B           	dec	de
  89++A46E 2D           	dec	l
  90++A46F C9           	ret
  91++A470
  92++A470              	endif
  93++A470
  94++A470              ;------------------------------------------------------------------------------
  95++A470              calcHLequEmulA	ifused
  96++A470              ;㬭: hl=e*a
  97++A470              ;:  a,e - ᫠
  98++A470              ;: hl=e*a
  99++A470              ;     d,b =#00
 100++A470              ;
 101++A470              ;calcHLequEmulA
 102++A470              ;
 103++A470 67                   ld      h,a
 104++A471 2E 00                ld      l,#00
 105++A473 55                   ld      d,l
 106++A474 06 08                ld      b,#08
 107++A476 29           loop026 add     hl,hl
 108++A477 30 01                jr      nc,goto028
 109++A479 19                   add     hl,de
 110++A47A 10 FA        goto028 djnz    loop026
 111++A47C C9                   ret
 112++A47D
 113++A47D                      endif
 114++A47D
 115++A47D              ;------------------------------------------------------------------------------
 116++A47D              altDEHLdivBC	ifused
 117++A47D              ; de'hl'=de'hl'/bc
 118++A47D              ;:  de'hl' - 
 119++A47D              ;     bc - ⥫
 120++A47D              ;: de'hl' - 祭
 121++A47D              ;     hl ⮪  
 122++A47D              ;
 123++A47D              ;altDEHLdivBC
 124++A47D              ;
 125++A47D 21 00 00     	ld	hl,#0000
 126++A480 E5           	push	hl
 127++A481 5D           	ld	e,l
 128++A482 54           	ld	d,h
 129++A483 D9           	exx
 130++A484 06 20        	ld	b,#20
 131++A486 AF           loop028	xor	a
 132++A487 CB 15        	rl	l
 133++A489 CB 14        	rl	h
 134++A48B CB 13        	rl	e
 135++A48D CB 12        	rl	d
 136++A48F D9           	exx
 137++A490 CB 15        	rl	l
 138++A492 CB 14        	rl	h
 139++A494 CB 13        	rl	e
 140++A496 CB 12        	rl	d
 141++A498 17           	rla
 142++A499 B7           	or	a
 143++A49A ED 42        	sbc	hl,bc
 144++A49C E3           	ex	(sp),hl
 145++A49D EB           	ex	de,hl
 146++A49E ED 52        	sbc	hl,de
 147++A4A0 EB           	ex	de,hl
 148++A4A1 E3           	ex	(sp),hl
 149++A4A2 D9           	exx
 150++A4A3 DE 00        	sbc	a,#00
 151++A4A5 20 26        	jr	nz,goto033
 152++A4A7 2C           loop029	inc	l
 153++A4A8 10 DC        	djnz	loop028
 154++A4AA 33           	inc	sp
 155++A4AB 33           	inc	sp
 156++A4AC D9           	exx
 157++A4AD C9           	ret
 158++A4AE AF           loop027	xor	a
 159++A4AF CB 15        	rl	l
 160++A4B1 CB 14        	rl	h
 161++A4B3 CB 13        	rl	e
 162++A4B5 CB 12        	rl	d
 163++A4B7 D9           	exx
 164++A4B8 CB 15        	rl	l
 165++A4BA CB 14        	rl	h
 166++A4BC CB 13        	rl	e
 167++A4BE CB 12        	rl	d
 168++A4C0 17           	rla
 169++A4C1 09           	add	hl,bc
 170++A4C2 E3           	ex	(sp),hl
 171++A4C3 EB           	ex	de,hl
 172++A4C4 ED 5A        	adc	hl,de
 173++A4C6 EB           	ex	de,hl
 174++A4C7 E3           	ex	(sp),hl
 175++A4C8 D9           	exx
 176++A4C9 DE 00        	sbc	a,#00
 177++A4CB 28 DA        	jr	z,loop029
 178++A4CD 10 DF        goto033	djnz	loop027
 179++A4CF D9           	exx
 180++A4D0 09           	add	hl,bc
 181++A4D1 30 01        	jr	nc,goto034
 182++A4D3 13           	inc	de
 183++A4D4 33           goto034	inc	sp
 184++A4D5 33           	inc	sp
 185++A4D6 C9           	ret
 186++A4D7
 187++A4D7              	endif
 188++A4D7
 189++A4D7              ;==============================================================================
 190++A4D7              ;
 191++A4D7              ;==============================================================================
 192++A4D7
# file closed: Drivers/DrvHDD/DrvHDD.calc.a80
 230+ A4D7              	IFDEF		ver1_10
 231+ A4D7              	 INCLUDE	"DrvHDD.var1_10.a80"
# file opened: Drivers/DrvHDD/DrvHDD.var1_10.a80
   1++A4D7              ;६ HDD Driver
   2++A4D7              ;䠩 DrvHDD.var.a80
   3++A4D7              ;
   4++A4D7              ;⠭ ᪨ ஫஢ ( ४⭮ ⠭ ୠ)
   5++A4D7              ;㯭 ஫
   6++A4D7              ;0,=1 SMUC v2
   7++A4D7              ;1,=1 SMUC v1 (shadow)
   8++A4D7              ;2,=1 Nemo
   9++A4D7              ;3,=1 Nemo A8
  10++A4D7              ;4,=1 ATM-IDE
  11++A4D7              ;5,=1 PROFI IDE
  12++A4D7              ;6,=1 Z-Controller
  13++A4D7              ;7,=1 DivMMC
  14++A4D7              ;
  15++A4D7              devMask	=	#00
  16++A4D7              devNums	=	#00
  17++A4D7              	IFDEF	SMUCv2		;প SMUC v2
  18++A4D7              devMask	=	devMask+#01
  19++A4D7              devNums	=	devNums+#01
  20++A4D7              	ENDIF
  21++A4D7              	IFDEF	SMUCv1		;প SMUC v1 (१ ⥭ )
  22++A4D7              devMask	=	devMask+#02
  23++A4D7              devNums	=	devNums+#01
  24++A4D7              	ENDIF
  25++A4D7              	IFDEF	NemoStd		;প NEMO
  26++A4D7              devMask	=	devMask+#04
  27++A4D7              devNums	=	devNums+#01
  28++A4D7              	ENDIF
  29++A4D7              	IFDEF	NemoA8		;প NEMO A8
  30++A4D7              devMask	=	devMask+#08
  31++A4D7              devNums	=	devNums+#01
  32++A4D7              	ENDIF
  33++A4D7              	IFDEF	ATMide		;প ATM-IDE
  34++A4D7              devMask	=	devMask+#10
  35++A4D7              devNums	=	devNums+#01
  36++A4D7              	ENDIF
  37++A4D7              	IFDEF	PROFIide	;প PROFI-IDE
  38++A4D7              devMask	=	devMask+#20
  39++A4D7              devNums	=	devNums+#01
  40++A4D7              	ENDIF
  41++A4D7              	IFDEF	ZC		;প Z-Controller
  42++A4D7              devMask	=	devMask+#40
  43++A4D7              devNums	=	devNums+#01
  44++A4D7              	ENDIF
  45++A4D7              	IFDEF	DivMMC		;প DivMMC
  46++A4D7              devMask	=	devMask+#80
  47++A4D7              devNums	=	devNums+#01
  48++A4D7              	ENDIF
  49++A4D7
  50++A4D7              ;------------------------------------------------------------------------------
  51++A4D7              ; ⥪饣 ஫   ( ଠ PartitionNum)
  52++A4D7              ; ࠩ ᯮ ⮫쪮  5-3,2
  53++A4D7              ;7,=0/1 ⨯ ࠧ MFS/FAT
  54++A4D7              ;6,=1 ࠧ             543
  55++A4D7              ;5-3,=???  ன⢠: =000 SMUC v2
  56++A4D7              ;                           =001 SMUC v1
  57++A4D7              ;                           =010 Nemo
  58++A4D7              ;                           =011 Nemo A8
  59++A4D7              ;                           =100 ATM IDE
  60++A4D7              ;                           =101 PROFI-IDE
  61++A4D7              ;                           =110 SD ZC
  62++A4D7              ;                           =111 SD DivMMC
  63++A4D7              ;2,=0/1 hdd master/slave
  64++A4D7              ;0..1,=??  ࠧ
  65++A4D7              ;
  66++A4D7 FF           drvDevice	db	#FF
  67++A4D8
  68++A4D8              ;------------------------------------------------------------------------------
  69++A4D8              ; ६     
  70++A4D8 00           idePort1F1	db	0	;ॣ ⥫ ⥩ #1F1/#F9BE ( ॠ)
  71++A4D9              secCounter
  72++A4D9 00           idePort1F2	db	0	;ॣ 稪 ᥪ஢ #1F2/#FABE
  73++A4DA 00           idePort1F3	db	0	;CHS  ᥪ/LBA 7:0 #1F3/#FBBE
  74++A4DB 00           idePort1F4	db	0	;CHS  樫 low/LBA 15:8 #1F4/#FCBE
  75++A4DC 00           idePort1F5	db	0	;CHS  樫 high/LBA 23:16 #1F5/#FDBE
  76++A4DD 00           idePort1F6	db	0	;CHS  /LBA 27:24 #1F6/#FEBE
  77++A4DE              				; 4,=0/1 ⥪騩  master/slave
  78++A4DE              				; 5,=1 ᥣ
  79++A4DE              				; 6,=0/1  CHS/LBA 
  80++A4DE              				; 7,=1 ᥣ
  81++A4DE 20           idePort1F7r	db	#20	;ॣ  (⥭ ᥪ)
  82++A4DF 30           idePort1F7w	db	#30	;ॣ  ( ᥪ)
  83++A4E0 90           idePort1F7i	db	#90	;ॣ  (䨪)
  84++A4E1 01           idePortErrCnt	db	#01	;⢮ ⮪ ⥭/ ᥪ
  85++A4E2              AdrLBA32	ifused
  86++A4E2 00 00 00 00  		 dd	0	;LBA32  ᥪ
  87++A4E6              		endif
  88++A4E6
  89++A4E6              ;------------------------------------------------------------------------------
  90++A4E6              ; ६ ਨ ⥪饣 ன⢠
  91++A4E6              ;+#0A ࠬ ன⢠
  92++A4E6              ;7,=1 /SD 
  93++A4E6              ;6,=1  প LBA
  94++A4E6              ;5,=1  প CHS
  95++A4E6              ;4,=0/1  SD/HDD master/slave
  96++A4E6              ;3,=0/1 প LBA32 off/on
  97++A4E6              ;2,=0/1  SD ⮢/筠 
  98++A4E6              ;1-0,=00  ⠡ ࠧ
  99++A4E6              ;    =10  ࠧ  砫 ᪠
 100++A4E6              ;    =01  MBR
 101++A4E6              ;    =11  GPT
 102++A4E6              ;
 103++A4E6              CurrentDev
 104++A4E6 00 00        devCylinders	dw 0		;+#00 2 祭 Cylinders HDD
 105++A4E8 00           devHeads	db 0		;+#02 1 祭 head HDD
 106++A4E9 00           devSectors	db 0		;+#03 1 祭 sector HDD
 107++A4EA 00 00        devHmulS	dw 0		;+#04 2 ந head * sectors
 108++A4EC 00 00 00 00  devLBAsec	dd 0		;+#06 4 - ᥪ஢ LBA
 109++A4F0 00           devFlags	db %00000000	;+#0A 1 ࠬ ன⢠
 110++A4F1              EndCurrentDev
 111++A4F1
 112++A4F1              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 113++A4F1              ; ६ ਨ   ஢
 114++A4F1              	IFNDEF	DrvHddExtVars
 115++A4F1 ~            	 IFDEF	SMUC
 116++A4F1 ~            msSMUC	  ds	11		;SMUC master
 117++A4F1 ~            slSMUC	  ds	11		;SMUC slave
 118++A4F1 ~            	 ENDIF
 119++A4F1 ~            	 IFDEF	NEMO
 120++A4F1 ~            msNemo	  ds	11		;Nemo master
 121++A4F1 ~            slNemo	  ds	11		;Nemo slave
 122++A4F1 ~            	 ENDIF
 123++A4F1 ~            	 IFDEF	ATMide
 124++A4F1 ~            msATM	  ds	11		;ATM IDE master
 125++A4F1 ~            slATM	  ds	11		;ATM IDE slave
 126++A4F1 ~            	 ENDIF
 127++A4F1 ~            	 IFDEF	PROFIide
 128++A4F1 ~            msPROFI	  ds	11		;Profi IDE master
 129++A4F1 ~            slPROFI	  ds	11		;Profi IDE slave
 130++A4F1 ~            	 ENDIF
 131++A4F1 ~            	 IFDEF	ZC
 132++A4F1 ~            cardZC	  ds	11		;ZC SD 
 133++A4F1 ~            	 ENDIF
 134++A4F1 ~            	 IFDEF	DivMMC
 135++A4F1 ~            mDivMMC	  ds	11		;DivMMC master
 136++A4F1 ~            sDivMMC	  ds	11		;DivMMC slave
 137++A4F1 ~            	 ENDIF
 138++A4F1              	ENDIF
 139++A4F1
 140++A4F1              ;------------------------------------------------------------------------------
 141++A4F1              ;⠡ ᮢ  ६ ஢/SD 
 142++A4F1 D8 97        tblDev	dw	msSMUC
 143++A4F3 E3 97        	dw	slSMUC
 144++A4F5 D8 97        	dw	msSMUC
 145++A4F7 E3 97        	dw	slSMUC
 146++A4F9 EE 97        	dw	msNemo
 147++A4FB F9 97        	dw	slNemo
 148++A4FD EE 97        	dw	msNemo
 149++A4FF F9 97        	dw	slNemo
 150++A501 04 98        	dw	msATM
 151++A503 0F 98        	dw	slATM
 152++A505 1A 98        	dw	msPROFI
 153++A507 1A 98        	dw	slPROFI
 154++A509 30 98        	dw	cardZC
 155++A50B 30 98        	dw	cardZC
 156++A50D 3B 98        	dw	mDivMMC
 157++A50F 46 98        	dw	sDivMMC
 158++A511
 159++A511              ;------------------------------------------------------------------------------
 160++A511              ; 訡
 161++A511 00           ideError	db 0
 162++A512
 163++A512              ;==============================================================================
 164++A512
# file closed: Drivers/DrvHDD/DrvHDD.var1_10.a80
 232+ A512              	ELSE
 233+ A512 ~            	 INCLUDE	"DrvHDD.var1_00.a80"
 234+ A512              	ENDIF
 235+ A512              End	;SAVEBIN	"drvhdd.bin",Start,End-Start
 236+ A512              	DISPLAY		"Lenght DrvHDD = ",/A,End-Start
 237+ A512              	ENDMODULE
 238+ A512
# file closed: Drivers/DrvHDD/DrvHDD.main.a80
5243  A512              		include "Drivers/DrvFAT/DrvFAT.main.a80"
# file opened: Drivers/DrvFAT/DrvFAT.main.a80
   1+ A512              ;ࠩ  FAT32
   2+ A512              ;FAT Driver v1.00
   3+ A512              ;(c) 2022-2024 LW aka PLM
   4+ A512              ;
   5+ A512              ;Date Creating: 14.12.2022
   6+ A512              ;Last   Update: 08.09.2024
   7+ A512              ;Last  Edition: 08.09.2024
   8+ A512              ;
   9+ A512              ;:
  10+ A512              ;DrvFAT.main.a80	-  䠩
  11+ A512              ;DrvFAT.LFN.a80		- ࠡ  묨 
  12+ A512              ;DrvFAT.rst.a80		- ࠡ⪠ ᮢ 짮⥫
  13+ A512              ;DrvFAT.format.a80	- ᮧ  ଠ஢ ࠧ
  14+ A512              ;DrvFAT.dir.a80		- ࠡ  ⠫
  15+ A512              ;DrvFAT.file.a80	- ࠡ  䠩  ⠫
  16+ A512              ;DrvFAT.fcb.a80		- ࠡ  ஬ fcb
  17+ A512              ;DrvFAT.init.a80	- 樠 ६ FAT32 ࠧ
  18+ A512              ;DrvFAT.part.a80	- ࠡ  ࠧ
  19+ A512              ;DrvFAT.table.a80	- 楤  ࠡ  ⠡楩 FAT
  20+ A512              ;DrvFAT.str.a80		-  ࠡ  ப
  21+ A512              ;DrvFAT.misc.a80	- 楤 饣 祭
  22+ A512              ;DrvFAT.var.a80		- ६
  23+ A512              ;DrvFAT.info		- ଠ  ࠩ
  24+ A512              ;DrvFAT.lua.a80		- LUA
  25+ A512              ;
  26+ A512              ;------------------------------------------------------------------------------
  27+ A512              ; 樨
  28+ A512              	DEVICE 	ZXSPECTRUM128
  29+ A512              	INCLUDE "DrvFAT.lua.a80"
# file opened: Drivers/DrvFAT/DrvFAT.lua.a80
   1++A512              	LUA
   2++A512 ~
   3++A512 ~            	local nameflog = "DrvFAT.lua.info"
   4++A512 ~            	local flog = nil
   5++A512 ~            	local blname={}
   6++A512 ~            	blname[1] ="DrvFAT.Start"
   7++A512 ~            	blname[2] ="DrvFAT.End"
   8++A512 ~
   9++A512 ~            	if flog==nil then flog=io.open(nameflog,"w") end
  10++A512 ~
  11++A512 ~            	plen = sj.get_label(blname[1])
  12++A512 ~            	flog:write(" 砫 DrvFAT32","\t"," = ",string.format('0x%04X', plen)," = ",plen,"\n")
  13++A512 ~
  14++A512 ~            	plen = sj.get_label(blname[2]) - sj.get_label(blname[1])
  15++A512 ~            	flog:write("  ࠩ","\t"," = ",string.format('0x%04X', plen)," = ",plen,"\n")
  16++A512 ~
  17++A512 ~            	flog:flush ()
  18++A512 ~
  19++A512              	ENDLUA
  20++A512
  21++A512
# file closed: Drivers/DrvFAT/DrvFAT.lua.a80
  30+ A512              	INCLUDE "DrvHDD.Project.mac"
# file opened: Drivers/DrvFAT/DrvHDD.Project.mac
   1++A512              ;  맮 / ࠩ ॠ
   2++A512              ;䠩 DrvHDD.mac
   3++A512              ;
   4++A512              ;hddSetCurrSec		  ⠭  ६  LBA/CHS
   5++A512              ;hddReadSec2HL		⥭ ᥪ     㥬 hl
   6++A512              ;hddReadSec2IX		⥭ ᥪ     㥬 ix
   7++A512              ;hddWriteSecHL		 ᥪ   㥬 hl  
   8++A512              ;hddWriteSecIX		 ᥪ   㥬 IX  
   9++A512              ;CheckDelFile		室 ஢ન 㤠  䠩
  10++A512              ;			(㦭 ⮫쪮  䏇)
  11++A512              ;CheckHDDms		஢ઠ   ⥬  
  12++A512              ;SetNumSectors_1	⠭ ⢠ । ᥪ஢ =#01
  13++A512              ;ReadSecMBR		⥭ 㫥 ᥪ     Buf4MBR
  14++A512              ;SetHDDpart		⠭ ⥪騬  ᮣ᭮  ࠧ
  15++A512              ;WriteSecDEHL		 ᥪ   xE5A9    
  16++A512              ;			 dehl
  17++A512              ;DirectRdWrSectors	אַ ⥭/ 㯯 ᥪ஢  
  18++A512              ;
  19++A512              ;------------------------------------------------------------------------------
  20++A512              ;  ⠭  ६  LBA/CHS
  21++A512              ;:  dehl - ᬥ饭  ᥪ (512b)  砫   㦭 ᥪ
  22++A512              	MACRO	hddSetCurrSec
  23++A512 ~            	call	DrvHDD.hddSetVarLBAadr
  24++A512              	ENDM
  25++A512
  26++A512              ;------------------------------------------------------------------------------
  27++A512              ;⥭ ᥪ     㥬 hl
  28++A512              ;: hl  
  29++A512              	MACRO	hddReadSec2HL
  30++A512 ~            	call	DrvHDD.RdSecHDD_HL
  31++A512              	ENDM
  32++A512
  33++A512              ;------------------------------------------------------------------------------
  34++A512              ;⥭ ᥪ     㥬 ix
  35++A512              ;: hl = ix
  36++A512              	MACRO	hddReadSec2IX
  37++A512 ~            	call	DrvHDD.RdSecHDD_IX
  38++A512              	ENDM
  39++A512
  40++A512              ;------------------------------------------------------------------------------
  41++A512              ; ᥪ   㥬 hl  
  42++A512              ;: hl  
  43++A512              	MACRO	hddWriteSecHL
  44++A512 ~            	call	DrvHDD.WrSecHDD_HL
  45++A512              	ENDM
  46++A512
  47++A512              ;------------------------------------------------------------------------------
  48++A512              ; ᥪ   㥬 ix  
  49++A512              ;: hl = ix
  50++A512              	MACRO	hddWriteSecIX
  51++A512 ~            	call	DrvHDD.WrSecHDD_IX
  52++A512              	ENDM
  53++A512
  54++A512              ;------------------------------------------------------------------------------
  55++A512              ;室 ஢ન 㤠  䠩 (㦭 ⮫쪮  䏇)
  56++A512              ;: nz - ஢ઠ  㦭
  57++A512              	MACRO	CheckDelFile
  58++A512 ~            	bit	0,(iy+#1B)
  59++A512              	ENDM
  60++A512
  61++A512              ;------------------------------------------------------------------------------
  62++A512              ;஢ઠ   ⥬  
  63++A512              ;:  a -   =#00/#01 master/slave
  64++A512              ;: z -  
  65++A512              	MACRO	CheckHDDms
  66++A512 ~            	or	a
  67++A512 ~            	jr	z,.gtm01
  68++A512 ~            	bit	3,(iy+#1D)
  69++A512 ~            	jr	.gtm02
  70++A512 ~            .gtm01	bit	3,(iy+#1C)
  71++A512 ~            .gtm02
  72++A512              	ENDM
  73++A512
  74++A512              ;------------------------------------------------------------------------------
  75++A512              ;⠭ ⢠ । ᥪ஢ =#01
  76++A512              	MACRO	SetNumSectors_1
  77++A512 ~            	ld	a,#01
  78++A512 ~            	ld	(DrvHDD.idePort1F2),a	;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
  79++A512              	ENDM
  80++A512
  81++A512              ;------------------------------------------------------------------------------
  82++A512              ;⥭ 㫥 ᥪ     Buf4MBR
  83++A512              	MACRO	ReadSecMBR
  84++A512 ~            	call	DrvHDD.RdSecHDD_DEHL
  85++A512              	ENDM
  86++A512
  87++A512              ;------------------------------------------------------------------------------
  88++A512              ;⠭ ⥪騬  ᮣ᭮  ࠧ
  89++A512              ;:  0-1,a -  ࠧ
  90++A512              ;       2,a - hdd master/slave
  91++A512              ;     5-3,a -  ஫
  92++A512              ;: cy=1 ன⢮ 
  93++A512              ;
  94++A512              	MACRO	SetHDDpart
  95++A512 ~            	call	DrvHDD.hddSetDevice
  96++A512              	ENDM
  97++A512
  98++A512              ;------------------------------------------------------------------------------
  99++A512              ; ᥪ        dehl
 100++A512              ;:  dehl - LBA  ᥪ
 101++A512              ;: cy=1 訡 ⥭ 
 102++A512              ;
 103++A512              	MACRO	WriteSecDEHL
 104++A512 ~            	call	Rom7.WrSecHDD_DEHL
 105++A512              	ENDM
 106++A512
 107++A512              ;------------------------------------------------------------------------------
 108++A512              ;אַ ⥭/ 㯯 ᥪ஢  
 109++A512              ;:   ࢮ ᥪ   ⠭  ६
 110++A512              ;     hl -   ⥭
 111++A512              ;     b  - ⢮ ᥪ஢  ⥭
 112++A512              ;     cy=0/1 - ⥭/
 113++A512              ;: cy=1 訡 ⥭/
 114++A512              ;       a=#60 - HDD  襫  ⮢
 115++A512              ;       a=#61
 116++A512              ;       a=#62
 117++A512              ;       a=#57 -  訡 ࠩ
 118++A512              ;
 119++A512              	MACRO	DirectRdWrSectors
 120++A512 ~            	call	Rom7.hddRdWrSectors
 121++A512              	ENDM
 122++A512
 123++A512              ;==============================================================================
 124++A512
# file closed: Drivers/DrvFAT/DrvHDD.Project.mac
  31+ A512              ;	PAGE	#00
  32+ A512              	MODULE	DrvFAT
  33+ A512
  34+ A512              ;------------------------------------------------------------------------------
  35+ A512              ;᫮ ࠭樨
  36+ A512
  37+ A512              ;	DEFINE	forProfROM	;ᡮઠ  䏧
  38+ A512              ;	DEFINE	forRRL		;ᡮઠ  ResetRomLoader
  39+ A512              	DEFINE	withMFS		; প MFS
  40+ A512              ;	DEFINE	VarsInDrv	;६ 室  ⠢ ࠩ
  41+ A512              ;	DEFINE	FAT_SIZE_32	;প ⮫쪮 FAT32 ( ॠ)
  42+ A512
  43+ A512              ;------------------------------------------------------------------------------
  44+ A512              ;⠭ ࠩ
  45+ A512
  46+ A512              ; ᥬ஢:
  47+ A512              AdrDrvBegin	equ $
  48+ A512
  49+ A512              	ifndef	VarsInDrv
  50+ A512              VarsFAT	equ	_VarsFAT;  ६
  51+ A512              	endif
  52+ A512
  53+ A512              LenEntryLFN	equ #0D	;⢮ ᨬ  ਯ LongName
  54+ A512              fnSep		equ "/" ;᭮ ࠧ⥫   (    )
  55+ A512              fnSep1		equ "/" ; ࠧ⥫  
  56+ A512              fnSep2		equ #5C ; ࠧ⥫  
  57+ A512
  58+ A512              ; 訡
  59+ A512              errOK		equ #00
  60+ A512              errNumTooBig	equ #11 ;number too big
  61+ A512              @errInvFileName	equ #45 ;invalid file name
  62+ A512              errFileNotFound	equ #48 ;file not found
  63+ A512              errDiskNoSpace	equ #49	;disk no space
  64+ A512              errRWnum	equ #50 ;R/W error _᫮_
  65+ A512              errHddNotFound	equ #56 ;hard disk not found
  66+ A512              errHddRWerror	equ #57 ;hard disk R/W error #nnnn
  67+ A512              errHddBusy	equ #60 ;busy not found
  68+ A512              errHddNotReady	equ #61 ;hard disk not ready
  69+ A512              errHddNotData	equ #62 ;hard disk data not ready
  70+ A512              errInvPartMg	equ #63 ;invalid partition manager
  71+ A512              errPartNotFound	equ #66 ;partition not found
  72+ A512              errInvalidPart	equ #6D ;invalid partition
  73+ A512              errInvalidFile	equ #70 ;invalid file
  74+ A512              errEoF		equ #71 ;end of file
  75+ A512              errPathEmpty	equ #72 ;path empty
  76+ A512              errFileExist	equ #73 ;file exist
  77+ A512              errDirNotEmpty	equ #74 ;dir not empty
  78+ A512              errFileEmpty	equ #75 ;file empty
  79+ A512              errAccesDenied	equ #79 ;acces denied
  80+ A512              errCopyItself	equ #7A ;copy to itself
  81+ A512
  82+ A512              ;ᬥ饭   fcb
  83+ A512              fcbName		equ #00 ;8  䠩
  84+ A512              fcbExt		equ #08 ;3 ७ 䠩
  85+ A512              fcbAttr		equ #0B ;1 ਡ 䠩
  86+ A512              fcbClsFile	equ #0C ;4  ࢮ  䠩/⠫
  87+ A512              fcbClsDIR	equ #10 ;4  ࢮ  ⠫  ⨬ 䠩/⠫
  88+ A512              fcbSize		equ #14 ;4 ࠧ 䠩/⠫  
  89+ A512              fcbOffset	equ #18 ;4 㪠⥫  䠩
  90+ A512              fcbStore	equ #1C	;1  ७ 㦤
  91+ A512              fcbStore2	equ #1D ;1 १
  92+ A512              fcbType		equ #1E ;1 bit 3,=0/1  SFN/LFN
  93+ A512              			;  bit 4,=0/1  䠩/⠫
  94+ A512              fcbPart		equ #1F ;1  ⥪饣   ࠧ  
  95+ A512
  96+ A512              ;ᬥ饭   BPB
  97+ A512              BPB_BytesPerSec		equ #0B	;2 ⢮   ᥪ
  98+ A512              BPB_SecPerClus		equ #0D	;1 ⢮ ᥪ஢  
  99+ A512              BPB_RsvdSecCnt		equ #0E	;2 ⢮ १ࢨ஢ ᥪ஢
 100+ A512              BPB_NumFATs		equ #10	;1 ⢮ FAT ⠡
 101+ A512              BPB_RootEntCnt		equ #11	;2  FAT12/16 ᫮ 32- ⮢,  FAT32 = 0
 102+ A512              BPB_TotSec16		equ #13	;2 ⢮ ᥪ஢  ࠧ
 103+ A512              BPB_FATSz16		equ #16	;2  FAT12/16 ⢮ ᥪ஢  FAT,  FAT32 = 0
 104+ A512              BPB_TotSec32		equ #20	;4 饥 ⢮ ᥪ஢  ࠧ
 105+ A512              BPB_FATSz32		equ #24	;4 ⢮ ᥪ஢  FAT ⠡
 106+ A512              BPB_RootClus		equ #2C	;4  ࢮ  root ४ਨ
 107+ A512              BPB_FAT32_FsInfo	equ #30 ;2  ᥪ  FSInfo  १ࢭ  ᪮ ᪠
 108+ A512
 109+ A512              ;ࠧ 
 110+ A512              Buf4File	equ _Buf4File	;  ⥭ 䠩
 111+ A512              Buf4MBR		equ _Buf4MBR	;  ᥪ஬ MBR
 112+ A512              Buf4LFN		equ _Buf4LFN	;  ᮧ ᥩ   
 113+ A512              Buf4Format	equ 0		;#600   ଠ஢ ࠧ
 114+ A512              @Buf4Desc	equ 0		;#200   ஢ ਯ஢  ⠫
 115+ A512              @Buf4FirstSym	equ 0		;#200    㪢  ਯ஢
 116+ A512              Buf4DIR		equ _Buf4DIR	;#200   㧪 ᥪ DIR (⠫)
 117+ A512              Buf4FAT		equ _Buf4FAT	;#200   㧪 ᥪ FAT
 118+ A512              @Buf4SortDesc	equ 0		;६   ஢ FAT ⠫
 119+ A512              @CurrentPath 	equ _CurrentPath;#100  ⥪饣 
 120+ A512              				;+#00 -   (᫥   =#00)
 121+ A512              @BufCurrentPath	equ 0		;#100  ⥪饣  ( ࠭  )
 122+ A512              tmp_fcb		equ _tmp_fcb	;#20  ६ ࠭ fcb
 123+ A512
 124+ A512              ;------------------------------------------------------------------------------
 125+ A512
 126+ A512              	ORG	AdrDrvBegin
 127+ A512              Start
 128+ A512              	INCLUDE	"DrvFAT.LFN.a80"
# file opened: Drivers/DrvFAT/DrvFAT.LFN.a80
   1++A512              ;楤  FAT Driver. ࠡ  묨 
   2++A512              ;䠩 DrvFAT.LFN.a80
   3++A512              ;
   4++A512              ;lfnSetOneEntry		⠭   LFN  
   5++A512              ;fatSetSFNname		ନ஢ ⪮   ஢મ ⢮
   6++A512              ;			䠩
   7++A512              ;fatGetLongName		祭   䠩
   8++A512              ;lfnGetOneGroupName	뤥     ਯ
   9++A512              ;strGetShortName	஢   ⪮   ॢ ᨬ
  10++A512              ;			  ॣ
  11++A512              ;
  12++A512              ;------------------------------------------------------------------------------
  13++A512              lfnSetOneEntry	ifused
  14++A512              ;⠭   LFN  
  15++A512              ;:  de -   ப  
  16++A512              ;     hl -    
  17++A512              ;     b -  ⠭ 
  18++A512              ;     c - ஫쭠 㬬 ⪮ 
  19++A512              ;: de - ᫥騩  ப  
  20++A512              ;     hl -     +#20
  21++A512              ;     b -  ⠭ 
  22++A512              ;     c - ஫쭠 㬬 ⪮ 
  23++A512              ;
  24++A512              ;lfnSetOneEntry
  25++A512              ;
  26++A512              ; +#00     
  27++A512 70           	ld	(hl),b
  28++A513 23           	inc	hl
  29++A514              ; +#01..#0A (5 ᨬ)
  30++A514 B7           	or	a
  31++A515 3E 05        	ld	a,#05
  32++A517 CD 2F A5     	call	lfnSetOneGroupName
  33++A51A              ; +#0B..#0C
  34++A51A 36 0F        	ld	(hl),#0F
  35++A51C 23           	inc	hl
  36++A51D 36 00        	ld	(hl),#00
  37++A51F 23           	inc	hl
  38++A520              ; +#0D ஫쭠 㬬 ⪮ 
  39++A520 71           	ld	(hl),c
  40++A521 23           	inc	hl
  41++A522              ; +#0E..#19 (6 ᨬ)
  42++A522 3E 06        	ld	a,#06
  43++A524 CD 2F A5     	call	lfnSetOneGroupName
  44++A527              ; +#1A..#1B 㫨
  45++A527 36 00        	ld	(hl),#00
  46++A529 23           	inc	hl
  47++A52A 36 00        	ld	(hl),#00
  48++A52C 23           	inc	hl
  49++A52D              ; +#1C..#1F (2 ᨬ)
  50++A52D 3E 02        	ld	a,#02
  51++A52F              ;	call	lfnSetOneGroupName
  52++A52F              ;	ret
  53++A52F
  54++A52F              	endif
  55++A52F
  56++A52F              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  57++A52F              lfnSetOneGroupName	ifused
  58++A52F              ;८ࠧ ப    
  59++A52F              ;:  a - ⢮ ᨬ  㯯
  60++A52F              ;     hl -  㯯  ਯ
  61++A52F              ;     de -  ப 筨
  62++A52F              ;     cy=1 塞  #FF
  63++A52F              ;: cy=1 -  ,  塞 #FF
  64++A52F              ;     hl=hl+(a*2)
  65++A52F              ;     de=de+a - ᫥騩   ப  
  66++A52F              ;
  67++A52F              ;lfnSetOneGroupName
  68++A52F              ;
  69++A52F C5           	push	bc
  70++A530 47           	ld	b,a
  71++A531 9F           	sbc	a,a			;cy=1 -> a=#FF, cy=1
  72++A532 38 3E        	jr	c,goto163		;  ᨬ  
  73++A534 1A           loop062	ld	a,(de)
  74++A535 B7           	or	a
  75++A536 28 3A        	jr	z,goto163		; 
  76++A538 D5           	push	de
  77++A539 11 5F 00     	ld	de,#005F		;"_"
  78++A53C CD FA B2     	call	chrCheckLFN		;஢ઠ  ⨬ ᨬ
  79++A53F 28 26        	jr	z,goto164		; ⨬ ᨬ   䠩
  80++A541 5F           	ld	e,a
  81++A542 FE 80        	cp	#80
  82++A544 38 21        	jr	c,goto164		;ᨬ ⨭   ப
  83++A546 FE A0        	cp	#A0
  84++A548 38 18        	jr	c,goto165		;.. -> -#70
  85++A54A FE B0        	cp	#B0
  86++A54C 38 14        	jr	c,goto165		;.. -> -#70
  87++A54E FE E0        	cp	#E0
  88++A550 38 15        	jr	c,goto164		;᪨ ᨬ ⨬
  89++A552 FE F0        	cp	#F0
  90++A554 38 0A        	jr	c,goto166		;.. -> -#A0
  91++A556 FE F1        	cp	#F1
  92++A558 38 04        	jr	c,goto167		; -> -#EF
  93++A55A 28 04        	jr	z,goto166		; -> -#A0
  94++A55C 18 09        	jr	goto164			;⠫쭮 ⨬
  95++A55E D6 4F        goto167	sub	#4F
  96++A560 D6 30        goto166	sub	#30			;-#A0
  97++A562 D6 70        goto165	sub	#70			;-#70
  98++A564 5F           	ld	e,a
  99++A565 16 04        	ld	d,#04
 100++A567 73           goto164	ld	(hl),e
 101++A568 23           	inc	hl
 102++A569 72           	ld	(hl),d
 103++A56A 23           	inc	hl
 104++A56B D1           	pop	de
 105++A56C 13           	inc	de
 106++A56D 10 C5        	djnz	loop062
 107++A56F C1           	pop	bc
 108++A570 B7           	or	a
 109++A571 C9           	ret
 110++A572              ; 
 111++A572 77           goto163	ld	(hl),a
 112++A573 23           	inc	hl
 113++A574 77           	ld	(hl),a
 114++A575 23           	inc	hl
 115++A576 3E FF        	ld	a,#FF
 116++A578 10 F8        	djnz	goto163
 117++A57A C1           	pop	bc
 118++A57B 37           	scf
 119++A57C C9           	ret
 120++A57D
 121++A57D              	endif
 122++A57D
 123++A57D              ;------------------------------------------------------------------------------
 124++A57D              fatSetSFNname	ifused
 125++A57D              ;ନ஢ ⪮   ஢મ ⢮ 䠩
 126++A57D              ;:  ix -   fcb
 127++A57D              ;     hl -  ப   䠩
 128++A57D              ;: hl -  
 129++A57D              ;     b =#00
 130++A57D              ;     c - ஫쭠 㬬 
 131++A57D              ;     cy=1 訡 ⥭/
 132++A57D              ;       a=errRWnum
 133++A57D              ;       a=errInvalidPart
 134++A57D              ;       a=errEoF - 䠩 ࢠ
 135++A57D              ;       a=errFileEmpty - ⮩ ୥ ⠫
 136++A57D              ;       a=errInvFileName 䠩  ⠪  
 137++A57D              ;     cy=0   
 138++A57D              ;
 139++A57D              ;fatSetSFNname
 140++A57D              ;
 141++A57D E5           	push	hl
 142++A57E DD E5        	push	ix
 143++A580 D1           	pop	de
 144++A581 CD 07 B2     	call	FileNameLFNto8dot3	;ନ㥬 ⪮ 
 145++A584 C5           	push	bc			;b=#00
 146++A585 18 1B        	jr	goto159			;饬 䠩
 147++A587
 148++A587              ;⪮४㥬   ⨫줮, ᫨ 
 149++A587 C5           loop061	push	bc
 150++A588 2B           	dec	hl
 151++A589 2B           	dec	hl
 152++A58A 2B           	dec	hl
 153++A58B 2B           	dec	hl			;hl+7   䩠
 154++A58C 78           	ld	a,b
 155++A58D E6 0F        	and	#0F
 156++A58F C6 30        	add	a,#30
 157++A591 77           	ld	(hl),a			;ன ᨬ ᫥ ⨫
 158++A592 2B           	dec	hl
 159++A593 78           	ld	a,b
 160++A594 0F           	rrca
 161++A595 0F           	rrca
 162++A596 0F           	rrca
 163++A597 0F           	rrca
 164++A598 E6 0F        	and	#0F
 165++A59A 28 04        	jr	z,goto160			;⠢ ⨫
 166++A59C C6 30        	add	a,#30
 167++A59E 77           	ld	(hl),a
 168++A59F 2B           	dec	hl
 169++A5A0 36 7E        goto160	ld	(hl),"~"
 170++A5A2 DD E5        goto159	push	ix
 171++A5A4 E1           	pop	hl			;   fcb
 172++A5A5 CD 29 A8     	call	fatFindEntryDir		; 䠩  ⠫
 173++A5A8              ;	call	fcbFindEntry		; 䠩  ⠫
 174++A5A8 C1           	pop	bc
 175++A5A9 38 08        	jr	c,goto161		;訡 ⥭
 176++A5AB 20 06        	jr	nz,goto161		;䠩  ⠪   
 177++A5AD 04           	inc	b
 178++A5AE 20 D7        	jr	nz,loop061		;䠩  ⠪  
 179++A5B0 3E 45        	ld	a,errInvFileName
 180++A5B2 37           	scf
 181++A5B3
 182++A5B3              ; ஫쭮 㬬 ⪮ 
 183++A5B3 F5           goto161	push	af
 184++A5B4 DD E5        	push	ix
 185++A5B6 E1           	pop	hl
 186++A5B7 AF           	xor	a
 187++A5B8 06 0B        	ld	b,#0B
 188++A5BA 4F           goto168	ld	c,a
 189++A5BB 0F           	rrca
 190++A5BC E6 80        	and	#80
 191++A5BE CB 39        	srl	c
 192++A5C0 81           	add	a,c
 193++A5C1 86           	add	a,(hl)
 194++A5C2 23           	inc	hl
 195++A5C3 10 F5        	djnz	goto168
 196++A5C5 4F           	ld	c,a
 197++A5C6 F1           	pop	af
 198++A5C7 E1           	pop	hl
 199++A5C8 C9           	ret
 200++A5C9
 201++A5C9              	endif
 202++A5C9
 203++A5C9              ;------------------------------------------------------------------------------
 204++A5C9              fatGetLongName	ifused
 205++A5C9 ~            ;祭   䠩
 206++A5C9 ~            ;:  hl -    
 207++A5C9 ~            ;     bc -    ⥪饬 ⠫
 208++A5C9 ~            ;: hl -     ଠ ASCIZ (᫨   , 
 209++A5C9 ~            ;          頥 ⪮ )
 210++A5C9 ~            ;     a -  ,  ⮬ 
 211++A5C9 ~            ;
 212++A5C9 ~            ;fatGetLongName
 213++A5C9 ~            ;
 214++A5C9 ~            	push	hl
 215++A5C9 ~            	push	hl
 216++A5C9 ~            	call	fatGetEntryLong		;  ⥪饬 ⠫ ਯ   
 217++A5C9 ~            	jr	c,goto157
 218++A5C9 ~            	bit	0,e
 219++A5C9 ~            	jp	z,lfnGetShortName	;  
 220++A5C9 ~
 221++A5C9 ~            ;⥭   䠩
 222++A5C9 ~            	exx
 223++A5C9 ~            	ld	c,#00
 224++A5C9 ~            	exx
 225++A5C9 ~            loop059	dec	bc
 226++A5C9 ~            	call	fatGetEntry
 227++A5C9 ~            	jr	c,goto157
 228++A5C9 ~            	ld	a,(hl)
 229++A5C9 ~            	inc	hl
 230++A5C9 ~            	exx
 231++A5C9 ~            	bit	6,c
 232++A5C9 ~            	pop	hl			;  
 233++A5C9 ~            	jr	nz,goto151
 234++A5C9 ~            	ld	c,a
 235++A5C9 ~            	exx
 236++A5C9 ~            	ld	a,#05			;⢮ ᨬ
 237++A5C9 ~            	call	lfnGetOneGroupName
 238++A5C9 ~            	and	a
 239++A5C9 ~            	jr	z,goto156		; 
 240++A5C9 ~            	inc	hl
 241++A5C9 ~            	inc	hl
 242++A5C9 ~            	inc	hl
 243++A5C9 ~            	ld	a,#06
 244++A5C9 ~            	call	lfnGetOneGroupName
 245++A5C9 ~            	and	a
 246++A5C9 ~            	jr	z,goto156		; 
 247++A5C9 ~            	inc	hl
 248++A5C9 ~            	inc	hl
 249++A5C9 ~            	ld	a,#02
 250++A5C9 ~            	call	lfnGetOneGroupName
 251++A5C9 ~            	and	a
 252++A5C9 ~            	jr	z,goto156		; 
 253++A5C9 ~            	exx
 254++A5C9 ~            	push	hl
 255++A5C9 ~            	exx
 256++A5C9 ~            	jr	loop059
 257++A5C9 ~
 258++A5C9 ~            ;થ     
 259++A5C9 ~            goto156	exx
 260++A5C9 ~            goto151	ld	(hl),#00
 261++A5C9 ~            	inc	hl
 262++A5C9 ~            	pop	de
 263++A5C9 ~            	push	de
 264++A5C9 ~            	or	a
 265++A5C9 ~            	sbc	hl,de
 266++A5C9 ~            	ld	a,l
 267++A5C9 ~            	exx
 268++A5C9 ~            	pop	hl
 269++A5C9 ~            	ret
 270++A5C9 ~
 271++A5C9 ~            ;訡 ⥭
 272++A5C9 ~            goto157	pop	hl
 273++A5C9 ~            	pop	hl
 274++A5C9 ~            	ret
 275++A5C9 ~            	jr	strGetShortName
 276++A5C9 ~            	org	$-2
 277++A5C9 ~
 278++A5C9              	endif
 279++A5C9
 280++A5C9              ;------------------------------------------------------------------------------
 281++A5C9              lfnGetOneGroupName	ifused
 282++A5C9 ~            ;뤥     ਯ
 283++A5C9 ~            ;:  a - ⢮ ᨬ  㯯
 284++A5C9 ~            ;     hl -  㯯  ਯ
 285++A5C9 ~            ;     hl' -  ਥ  
 286++A5C9 ~            ;: z,a =#00 -  
 287++A5C9 ~            ;     hl=hl+(a*2)
 288++A5C9 ~            ;     hl' -  ਥ  
 289++A5C9 ~            ;
 290++A5C9 ~            ;lfnGetOneGroupName
 291++A5C9 ~            ;
 292++A5C9 ~            	exx
 293++A5C9 ~            	ld	b,a
 294++A5C9 ~            	exx
 295++A5C9 ~            loop058	ld	d,(hl)
 296++A5C9 ~            	inc	hl
 297++A5C9 ~            	ld	e,(hl)
 298++A5C9 ~            	inc	hl
 299++A5C9 ~            	ld	a,d
 300++A5C9 ~            	or	e
 301++A5C9 ~            	ret	z
 302++A5C9 ~            	ld	a,e
 303++A5C9 ~            	and	a
 304++A5C9 ~            	jr	nz,goto152
 305++A5C9 ~            	ld	a,d
 306++A5C9 ~            	cp	#80
 307++A5C9 ~            	jr	c,goto153
 308++A5C9 ~            	ld	d,#5F
 309++A5C9 ~            	jr	goto153
 310++A5C9 ~            goto152	cp	#04
 311++A5C9 ~            	ld	a,#5F
 312++A5C9 ~            	jr	nz,goto153
 313++A5C9 ~            	ld	a,d
 314++A5C9 ~            	ld	de,#5FEF
 315++A5C9 ~            	cp	#01
 316++A5C9 ~            	jr	z,goto154
 317++A5C9 ~            	ld	e,#A0
 318++A5C9 ~            	cp	#51
 319++A5C9 ~            	jr	z,goto154
 320++A5C9 ~            	sub	#10
 321++A5C9 ~            	ld	e,#80
 322++A5C9 ~            	jr	nc,goto155
 323++A5C9 ~            	ld	a,d
 324++A5C9 ~            	jr	goto153
 325++A5C9 ~            goto155	cp	#30
 326++A5C9 ~            	jr	c,goto154
 327++A5C9 ~            	ld	e,#B0
 328++A5C9 ~            	cp	#40
 329++A5C9 ~            	jr	c,goto154
 330++A5C9 ~            	ld	a,d
 331++A5C9 ~            	jr	goto153
 332++A5C9 ~            goto154	add	a,e
 333++A5C9 ~            goto153	exx
 334++A5C9 ~            	ld	(hl),a
 335++A5C9 ~            	inc	hl
 336++A5C9 ~            	dec	b
 337++A5C9 ~            	exx
 338++A5C9 ~            	jr	nz,loop058
 339++A5C9 ~            	ret
 340++A5C9 ~
 341++A5C9              	endif
 342++A5C9
 343++A5C9              ;------------------------------------------------------------------------------
 344++A5C9              strGetShortName	ifused
 345++A5C9 ~            ;஢   ⪮   ॢ ᨬ   ॣ
 346++A5C9 ~            ;:  hl -  ਯ
 347++A5C9 ~            ;     de -  ਥ  
 348++A5C9 ~            ;     a - ਡ 
 349++A5C9 ~            ;: a -  ப  
 350++A5C9 ~            ;     hl -  砫 
 351++A5C9 ~            ;
 352++A5C9 ~            ;strGetShortName
 353++A5C9 ~            ;
 354++A5C9 ~            	push	de
 355++A5C9 ~            	push	de
 356++A5C9 ~
 357++A5C9 ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 358++A5C9 ~            ;஢   ⪮   ॢ ᨬ   ॣ
 359++A5C9 ~            ;:  hl -  ਯ
 360++A5C9 ~            ;     (sp) -  ਥ  
 361++A5C9 ~            ;     (sp) -  ਥ  
 362++A5C9 ~            ;     a - ਡ 
 363++A5C9 ~            ;: a -  ப  
 364++A5C9 ~            ;     hl -  砫 
 365++A5C9 ~            ;
 366++A5C9 ~            lfnGetShortName
 367++A5C9 ~            ;
 368++A5C9 ~            	pop	de
 369++A5C9 ~            	ld	c,a
 370++A5C9 ~            	ld	b,#08
 371++A5C9 ~            	call	proc_14			;㥬 
 372++A5C9 ~            	ld	a,(hl)
 373++A5C9 ~            	cp	" "
 374++A5C9 ~            	jr	z,goto150		; ७
 375++A5C9 ~            	ld	a,"."
 376++A5C9 ~            	ld	(de),a
 377++A5C9 ~            	inc	de
 378++A5C9 ~            	ld	b,#03
 379++A5C9 ~            	call	proc_14			;㥬 ७
 380++A5C9 ~
 381++A5C9 ~            ;થ     
 382++A5C9 ~            goto150	ex	de,hl
 383++A5C9 ~            	ld	(hl),#00
 384++A5C9 ~            	inc	hl
 385++A5C9 ~            	pop	de
 386++A5C9 ~            	or	a
 387++A5C9 ~            	sbc	hl,de
 388++A5C9 ~            	ld	a,l			; 
 389++A5C9 ~            	ex	de,hl
 390++A5C9 ~            	ret
 391++A5C9 ~
 392++A5C9 ~            ;஢ /७  ਥ  ॢ   ॣ
 393++A5C9 ~            proc_14
 394++A5C9 ~            loop057	ld	a,(hl)
 395++A5C9 ~            	cp	" "
 396++A5C9 ~            	jr	z,goto146
 397++A5C9 ~            	bit	4,c
 398++A5C9 ~            	jr	nz,goto147		; ⠫
 399++A5C9 ~            	cp	"A"
 400++A5C9 ~            	jr	c,goto147
 401++A5C9 ~            	cp	"Z"+1
 402++A5C9 ~            	jr	c,goto148
 403++A5C9 ~            	cp	#80			;rus 
 404++A5C9 ~            	jr	c,goto147
 405++A5C9 ~            	cp	#90			;rus +1
 406++A5C9 ~            	jr	c,goto148
 407++A5C9 ~            	cp	#A0			;rus +1
 408++A5C9 ~            	jr	c,goto149
 409++A5C9 ~            	cp	#F0
 410++A5C9 ~            	jr	nz,goto147		;rus 
 411++A5C9 ~            	inc	a
 412++A5C9 ~            	jr	goto147
 413++A5C9 ~            goto149	and	#EF
 414++A5C9 ~            	or	#40
 415++A5C9 ~            goto148	or	#20
 416++A5C9 ~            goto147	ld	(de),a
 417++A5C9 ~            	inc	de
 418++A5C9 ~            	inc	hl
 419++A5C9 ~            	djnz	loop057
 420++A5C9 ~            goto146	ld	a,b
 421++A5C9 ~            	add	a,l
 422++A5C9 ~            	ld	l,a
 423++A5C9 ~            	ret	nc
 424++A5C9 ~            	inc	h
 425++A5C9 ~            	ret
 426++A5C9 ~
 427++A5C9              	endif
 428++A5C9
 429++A5C9              ;==============================================================================
 430++A5C9
# file closed: Drivers/DrvFAT/DrvFAT.LFN.a80
 129+ A5C9              	INCLUDE	"DrvFAT.rst.a80"
# file opened: Drivers/DrvFAT/DrvFAT.rst.a80
   1++A5C9              ;楤  FAT Driver. ࠡ⪠ ᮢ 짮⥫
   2++A5C9              ;䠩 DrvFAT.rst.a80
   3++A5C9              ;
   4++A5C9              ;WriteDataToFile	     䠩
   5++A5C9              ;ReadDataFromFile	⥭   䠩  
   6++A5C9              ;tmWrSecHDD_hl		ﬠ  ᥪ      hl
   7++A5C9              ;			( ⥭ )
   8++A5C9              ;WrSecHDD_hl		ﬠ  ᥪ      hl
   9++A5C9              ;tmRdSecHDD_hl		אַ ⥭ ᥪ      hl
  10++A5C9              ;			( ⥭ )     
  11++A5C9              ;			⥬ , ⠥ १ 
  12++A5C9              ;RdSecHDD_hl		אַ ⥭ ᥪ      hl
  13++A5C9              ;
  14++A5C9              ;------------------------------------------------------------------------------
  15++A5C9              WriteDataToFile	ifused
  16++A5C9              ;     䠩
  17++A5C9              ;  䠩   
  18++A5C9              ;   fcb   ⠭: fcbName, fcbExt, fcbClsFile, fcbClsDIR,
  19++A5C9              ;    fcbSize, fcbOffset, fcbPart
  20++A5C9              ;:  ix -  fcb
  21++A5C9              ;     hl -     
  22++A5C9              ;     bc - ⢮   
  23++A5C9              ;: cy=1 訡
  24++A5C9              ;        a=errNumTooBig - ᫨誮 让 ࠧ,  #FFFF ஢
  25++A5C9              ;        a=errRWnum -  訡
  26++A5C9              ;        a=errFileEmpty - 㫥 ࠧ 䠩
  27++A5C9              ;        a=errDiskNoSpace
  28++A5C9              ;        a=errInvalidPart
  29++A5C9              ;        a=errEoF - 䠩 ࢠ
  30++A5C9              ;        a=errFileNotFound
  31++A5C9              ;     cy=0  ᠭ
  32++A5C9              ;       hl ᫥騩   
  33++A5C9              ;
  34++A5C9              ;WriteDataToFile
  35++A5C9              ;
  36++A5C9 E5           	push	hl
  37++A5CA C5           	push	bc
  38++A5CB
  39++A5CB              ;⠥  ᪮쪮 㦭 㢥 ࠧ 䠩
  40++A5CB              ;  ࠧ offset-size+BC
  41++A5CB CD 8D AD     	call	LD_DEHL_fcbOffset
  42++A5CE D5           	push	de
  43++A5CF E5           	push	hl
  44++A5D0 CD 92 AD     	call	LD_DEHL_fcbSize
  45++A5D3 EB           	ex	de,hl
  46++A5D4 E3           	ex	(sp),hl
  47++A5D5 B7           	or	a
  48++A5D6 ED 52        	sbc	hl,de
  49++A5D8 D1           	pop	de
  50++A5D9 E3           	ex	(sp),hl
  51++A5DA ED 52        	sbc	hl,de
  52++A5DC EB           	ex	de,hl
  53++A5DD E1           	pop	hl		;dehl = offset - size
  54++A5DE 09           	add	hl,bc
  55++A5DF 30 01        	jr	nc,goto106
  56++A5E1 13           	inc	de		;dehl = offset - size + BC
  57++A5E2 7A           goto106	ld	a,d             ;       ࠧ   㦭 㢥 䠩
  58++A5E3 B3           	or	e
  59++A5E4 B4           	or	h
  60++A5E5 B5           	or	l
  61++A5E6 28 09        	jr	z,goto107	;=#00  墠⠥
  62++A5E8 7A           	ld	a,d
  63++A5E9 17           	rla
  64++A5EA 38 05        	jr	c,goto107	;<#00  墠⠥
  65++A5EC              ;dehl  ᪮쪮  㦭 㢥 ࠧ 䠩
  66++A5EC
  67++A5EC              ;ਬ 䠩  dehl 
  68++A5EC CD EB A8     	call	addBytesToFile
  69++A5EF 38 38        	jr	c,goto115
  70++A5F1
  71++A5F1              ; ᬥ饭  ᥪ
  72++A5F1 CD 8D AD     goto107	call	LD_DEHL_fcbOffset;dehl ᬥ饭  䠩
  73++A5F4 AF           loop043	xor	a
  74++A5F5 CB 3A        	srl	d
  75++A5F7 20 2E        	jr	nz,goto108	;᫨誮 让 㪠⥫
  76++A5F9 CB 1B        	rr	e
  77++A5FB CB 1C        	rr	h
  78++A5FD 17           	rla
  79++A5FE 47           	ld	b,a
  80++A5FF 4D           	ld	c,l
  81++A600 53           	ld	d,e
  82++A601 5C           	ld	e,h
  83++A602 21 00 02     	ld	hl,#0200
  84++A605 ED 42        	sbc	hl,bc
  85++A607              ;hl ᪮쪮    ᥪ  
  86++A607              ;de ᬥ饭  砫 䠩  ᥪ (512b)
  87++A607              ;bc ᬥ饭  ᥪ
  88++A607
  89++A607              ;। 㦭 뢠 楫 ᥪ  ⮫쪮  
  90++A607 EB           	ex	de,hl
  91++A608 E3           	ex	(sp),hl
  92++A609 B7           	or	a
  93++A60A ED 52        	sbc	hl,de
  94++A60C 19           	add	hl,de
  95++A60D 30 02        	jr	nc,goto109
  96++A60F 54           	ld	d,h
  97++A610 5D           	ld	e,l
  98++A611 F1           goto109	pop	af
  99++A612 E3           	ex	(sp),hl
 100++A613 F5           	push	af
 101++A614 E3           	ex	(sp),hl
 102++A615 EB           	ex	de,hl
 103++A616 7D           	ld	a,l
 104++A617 B7           	or	a
 105++A618 20 13        	jr	nz,goto110		;襬  ᥪ
 106++A61A 7C           	ld	a,h
 107++A61B FE 02        	cp	#02
 108++A61D 20 0E        	jr	nz,goto110		;襬  ᥪ
 109++A61F              ;hl ᪮쪮  㦭   ᥪ
 110++A61F              ;de ᬥ饭  砫 䠩  ᥪ (512b)
 111++A61F              ;bc ᬥ饭  ᥪ
 112++A61F
 113++A61F              ;襬 ᥪ 楫
 114++A61F E1           	pop	hl
 115++A620 CD D3 A6     	call	tmWrSecHDD_hl
 116++A623 30 2B        	jr	nc,goto111
 117++A625
 118++A625              ;訡 
 119++A625 C1           goto112	pop	bc
 120++A626 C9           	ret
 121++A627 3E 11        goto108	ld	a,errNumTooBig
 122++A629 C1           goto115	pop	bc
 123++A62A E1           	pop	hl
 124++A62B 37           	scf
 125++A62C C9           	ret
 126++A62D
 127++A62D
 128++A62D              ;襬  ᥪ
 129++A62D E5           goto110	push	hl
 130++A62E C5           	push	bc
 131++A62F 21 B8 8D     	ld	hl,Buf4File
 132++A632 E5           	push	hl
 133++A633 CD E8 A6     	call	RdSecHDD_hl	;⠫ ᥪ  
 134++A636 E1           	pop	hl
 135++A637 C1           	pop	bc
 136++A638 F5           	push	af
 137++A639 09           	add	hl,bc
 138++A63A F1           	pop	af
 139++A63B C1           	pop	bc
 140++A63C D1           	pop	de
 141++A63D EB           	ex	de,hl
 142++A63E 38 E5        	jr	c,goto112	;訡 ⥭
 143++A640              	IFDEF	forProfROM
 144++A640 ~            	 bit	5,(iy+#0B)
 145++A640 ~            	 jr	z,goto113	;맮  
 146++A640 ~            	 call	Rom7.CheckAdrMem;।   ⥭  ⥬ 
 147++A640 ~            	 jr	nc,goto113
 148++A640 ~            	 push	bc
 149++A640 ~            	 rst	#30
 150++A640 ~            	 dw	Rom2.copyUserRamToRam8	;஢   
 151++A640 ~            	 db	#02
 152++A640 ~            	 jr	goto114
 153++A640              	ENDIF
 154++A640              	IFDEF	forRRL
 155++A640 ~            	 bit	5,(iy+P0Bh)
 156++A640 ~            	 jr	z,goto113		;맮  
 157++A640 ~            	 call	r8d.CheckAdrMem		;।   ⥭  ⥬ 
 158++A640 ~            	 jr	nc,goto113
 159++A640 ~            	 push	bc
 160++A640 ~            	 UserMemToBuf
 161++A640 ~            ;	 call	Rom2.copyUserRamToRam8	;஢   
 162++A640 ~            	 jr	goto114
 163++A640              	ENDIF
 164++A640
 165++A640 C5           goto113	push	bc
 166++A641 ED B0        	ldir
 167++A643 E5           goto114	push	hl
 168++A644 21 B8 8D     	ld	hl,Buf4File
 169++A647              	hddWriteSecHL		; ᥪ    
 169++A647 CD BF 9B    >	call	DrvHDD.WrSecHDD_HL
 170++A64A E1           	pop	hl
 171++A64B C1           	pop	bc
 172++A64C 3E 50        	ld	a,errRWnum
 173++A64E 38 D5        	jr	c,goto112	;訡 
 174++A650
 175++A650
 176++A650              ;᫥騩 ᥪ
 177++A650 E3           goto111	ex	(sp),hl
 178++A651 B7           	or	a
 179++A652 ED 42        	sbc	hl,bc
 180++A654 E5           	push	hl
 181++A655 F5           	push	af
 182++A656 60           	ld	h,b
 183++A657 69           	ld	l,c
 184++A658 CD 1A AD     	call	add2Offset_HL
 185++A65B F1           	pop	af
 186++A65C              	IFDEF	forRRL
 187++A65C ~            	 jp	nz,loop043
 188++A65C              	ELSE
 189++A65C 20 96        	 jr	nz,loop043
 190++A65E              	ENDIF
 191++A65E E1           	pop	hl
 192++A65F
 193++A65F
 194++A65F              ;室
 195++A65F E1           	pop	hl
 196++A660 B7           	or	a
 197++A661 C9           	ret
 198++A662
 199++A662              	endif
 200++A662
 201++A662              ;------------------------------------------------------------------------------
 202++A662              ReadDataFromFile	ifused
 203++A662              ;⥭   䠩  
 204++A662              ;  䠩   
 205++A662              ;   fcb   ⠭: fcbClsFile, fcbOffset
 206++A662              ;:  ix -  fcb
 207++A662              ;     hl -   ⥭
 208++A662              ;     bc - ⢮   ⥭
 209++A662              ;: cy=1 뫨 訡
 210++A662              ;       a=errRWnum
 211++A662              ;       a=errInvalidPart
 212++A662              ;       a=errEoF - 䠩 ࢠ
 213++A662              ;       a=errFileEmpty
 214++A662              ;     cy=0  ⠭
 215++A662              ;       hl ᫥騩   ⥭
 216++A662              ;
 217++A662              ;ReadDataFromFile
 218++A662              ;
 219++A662 E5           	push	hl
 220++A663 C5           	push	bc
 221++A664
 222++A664              ; ᬥ饭  ᥪ
 223++A664              ;	call	LD_DEHL_fcbOffset	;dehl 㪠⥫  䠩
 224++A664 2E 00        	ld	l,#00
 225++A666 CD 2E AD     	call	add2OffsetEOF_L		;dehl 㪠⥫  䠩
 226++A669 3E 71        	ld	a,errEoF
 227++A66B 38 35        	jr	c,goto187		; । 䠩
 228++A66D AF           loop033	xor	a
 229++A66E CB 3A        	srl	d
 230++A670 20 2E        	jr	nz,goto082
 231++A672 CB 1B        	rr	e
 232++A674 CB 1C        	rr	h
 233++A676 17           	rla
 234++A677 47           	ld	b,a
 235++A678 4D           	ld	c,l
 236++A679 53           	ld	d,e
 237++A67A 5C           	ld	e,h
 238++A67B              ;	or	l
 239++A67B              ;	jr	z,goto083
 240++A67B              ;	inc	de
 241++A67B              ;	ld	a,e
 242++A67B              ;	or	d
 243++A67B              ;	jr	z,goto082
 244++A67B 21 00 02     goto083	ld	hl,#0200
 245++A67E ED 42        	sbc	hl,bc
 246++A680              ;hl ᪮쪮    ᥪ  
 247++A680              ;de ᬥ饭  砫 䠩  ᥪ (512b)
 248++A680              ;bc ᬥ饭  ᥪ
 249++A680
 250++A680
 251++A680              ;। 㦭 㦠 楫 ᥪ  ⮫쪮  
 252++A680 EB           	ex	de,hl
 253++A681 E3           	ex	(sp),hl
 254++A682 B7           	or	a
 255++A683 ED 52        	sbc	hl,de
 256++A685 19           	add	hl,de
 257++A686 30 02        	jr	nc,goto084
 258++A688 54           	ld	d,h
 259++A689 5D           	ld	e,l
 260++A68A F1           goto084	pop	af
 261++A68B E3           	ex	(sp),hl
 262++A68C F5           	push	af
 263++A68D E3           	ex	(sp),hl
 264++A68E EB           	ex	de,hl
 265++A68F 7D           	ld	a,l
 266++A690 B7           	or	a
 267++A691 20 13        	jr	nz,goto085		;⠥  ᥪ
 268++A693 7C           	ld	a,h
 269++A694 FE 02        	cp	#02
 270++A696 20 0E        	jr	nz,goto085		;⠥  ᥪ
 271++A698              ;hl ᪮쪮  㦭   ᥪ
 272++A698              ;de ᬥ饭  砫 䠩  ᥪ (512b)
 273++A698              ;bc ᬥ饭  ᥪ
 274++A698
 275++A698
 276++A698              ;⠥ ᥪ 楫
 277++A698 E1           	pop	hl
 278++A699 CD E8 A6     	call	tmRdSecHDD_hl
 279++A69C 30 1F        	jr	nc,goto086
 280++A69E
 281++A69E              ;訡 ⥭
 282++A69E C1           goto087	pop	bc
 283++A69F C9           	ret
 284++A6A0 3E 11        goto082	ld	a,errNumTooBig
 285++A6A2 C1           goto187	pop	bc
 286++A6A3 E1           	pop	hl
 287++A6A4 37           	scf
 288++A6A5 C9           	ret
 289++A6A6
 290++A6A6
 291++A6A6              ;⠥  ᥪ
 292++A6A6 E5           goto085	push	hl
 293++A6A7 C5           	push	bc
 294++A6A8 21 B8 8D     	ld	hl,Buf4File
 295++A6AB E5           	push	hl
 296++A6AC CD E8 A6     	call	RdSecHDD_hl
 297++A6AF E1           	pop	hl
 298++A6B0 C1           	pop	bc
 299++A6B1 F5           	push	af
 300++A6B2 09           	add	hl,bc
 301++A6B3 F1           	pop	af
 302++A6B4 C1           	pop	bc
 303++A6B5 D1           	pop	de
 304++A6B6 38 E6        	jr	c,goto087
 305++A6B8              	IFDEF	forProfROM
 306++A6B8 ~            	 bit	5,(iy+#0B)
 307++A6B8 ~            	 jr	z,goto088		;맮  
 308++A6B8 ~            	 ex	de,hl
 309++A6B8 ~            	 call	Rom7.CheckAdrMem	;।   ⥭  ⥬ 
 310++A6B8 ~            	 ex	de,hl
 311++A6B8 ~            	 jr	nc,goto088
 312++A6B8 ~            	 push	bc
 313++A6B8 ~            	 rst	#30
 314++A6B8 ~            	 dw	Rom2.copyRam8ToUserRam	;⠭    ram 8
 315++A6B8 ~            	 db	#02
 316++A6B8 ~            	 pop	bc
 317++A6B8 ~            	 ex	de,hl
 318++A6B8 ~            	 jr	goto086
 319++A6B8              	ENDIF
 320++A6B8              	IFDEF	forRRL
 321++A6B8 ~            	 bit	5,(iy+P0Bh)
 322++A6B8 ~            	 jr	z,goto088		;맮  
 323++A6B8 ~            	 ex	de,hl
 324++A6B8 ~            	 call	r8d.CheckAdrMem		;।   ⥭  ⥬ 
 325++A6B8 ~            	 ex	de,hl
 326++A6B8 ~            	 jr	nc,goto088
 327++A6B8 ~            	 push	bc
 328++A6B8 ~            	 call	Rom2.copyRam8ToUserRam	;⠭    ram 8
 329++A6B8 ~            	 pop	bc
 330++A6B8 ~            	 ex	de,hl
 331++A6B8 ~            	 jr	goto086
 332++A6B8              	ENDIF
 333++A6B8
 334++A6B8 C5           goto088	push	bc
 335++A6B9 ED B0        	ldir
 336++A6BB C1           	pop	bc			;bc ⢮ ⠭   ᥪ
 337++A6BC EB           	ex	de,hl			;hl ᫥騩   ⥭
 338++A6BD
 339++A6BD
 340++A6BD              ;᫥騩 ᥪ
 341++A6BD              ;(sp) bc - ⠢襥 ⢮   ⥭
 342++A6BD              ;hl ᫥騩   ⥭
 343++A6BD              ;bc ⢮ ⠭ 
 344++A6BD E3           goto086	ex	(sp),hl
 345++A6BE B7           	or	a
 346++A6BF ED 42        	sbc	hl,bc
 347++A6C1 E5           	push	hl
 348++A6C2 F5           	push	af
 349++A6C3 60           	ld	h,b
 350++A6C4 69           	ld	l,c
 351++A6C5 CD 30 AD     	call	add2OffsetEOF_HL	;cy=1 㪠⥫   । 䠩 -> ⠭  砫
 352++A6C8 C1           	pop	bc
 353++A6C9 38 04        	jr	c,goto186		; 䠩
 354++A6CB C5           	push	bc
 355++A6CC F1           	pop	af
 356++A6CD 20 9E        	jr	nz,loop033
 357++A6CF E1           goto186	pop	hl
 358++A6D0
 359++A6D0
 360++A6D0              ;室
 361++A6D0 E1           	pop	hl
 362++A6D1 B7           	or	a
 363++A6D2 C9           	ret
 364++A6D3
 365++A6D3              	endif
 366++A6D3
 367++A6D3              ;------------------------------------------------------------------------------
 368++A6D3              tmWrSecHDD_hl	ifused
 369++A6D3              ;ﬠ  ᥪ      hl ( ⥭ )
 370++A6D3              ;      ⥬ , 襬 १ 
 371++A6D3              ;:  ix -  fcb
 372++A6D3              ;     hl -   
 373++A6D3              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 374++A6D3              ;: cy=1 뫨 訡
 375++A6D3              ;       a=errRWnum
 376++A6D3              ;       a=errInvalidPart
 377++A6D3              ;       a=errEoF - 䠩 ࢠ
 378++A6D3              ;       a=errFileEmpty
 379++A6D3              ;     cy=0, nz - ᠫ   
 380++A6D3              ;     cy=0, z - ४뢠  , ⮬ ᠫ  
 381++A6D3              ;       hl - ᫥騩   
 382++A6D3              ;       bc=#0200 ⢮ ᠭ 
 383++A6D3              ;     de,bc,a - ???
 384++A6D3              ;
 385++A6D3              ;tmWrSecHDD_hl
 386++A6D3              ;
 387++A6D3              	IFDEF	forProfROM
 388++A6D3 ~            	 bit	5,(iy+#0B)
 389++A6D3 ~            	 jr	z,WrSecHDD_hl		;맮  
 390++A6D3 ~            	 ld	bc,#0200		;ࠧ ᥪ
 391++A6D3 ~            	 call	Rom7.CheckAdrMem	;।   ⥭  ⥬ 
 392++A6D3 ~            	 jr	nc,WrSecHDD_hl		;஢  
 393++A6D3 ~            	 push	bc
 394++A6D3 ~            	 push	de
 395++A6D3 ~            	 ld	de,Buf4File
 396++A6D3 ~            	 push	de
 397++A6D3 ~            	 rst	#30
 398++A6D3 ~            	 dw	Rom2.copyUserRamToRam8	;஢   
 399++A6D3 ~            	 db	#02
 400++A6D3 ~            	 pop	de
 401++A6D3 ~            	 ex	(sp),hl
 402++A6D3 ~            	 ex	de,hl
 403++A6D3 ~            	 call	WrSecHDD_hl		; ᥪ
 404++A6D3 ~            	 pop	hl
 405++A6D3 ~            	 pop	bc
 406++A6D3 ~            	 ret
 407++A6D3              	ENDIF
 408++A6D3              	IFDEF	forRRL
 409++A6D3 ~            	 bit	5,(iy+P0Bh)
 410++A6D3 ~            	 jr	z,WrSecHDD_hl		;맮  
 411++A6D3 ~            	 ld	bc,#0200		;ࠧ ᥪ
 412++A6D3 ~            	 call	r8d.CheckAdrMem		;।   ⥭  ⥬ 
 413++A6D3 ~            	 jr	nc,WrSecHDD_hl		;஢  
 414++A6D3 ~            	 push	bc
 415++A6D3 ~            	 push	de
 416++A6D3 ~            	 ld	de,Buf4File
 417++A6D3 ~            	 push	de
 418++A6D3 ~            	 call	Rom2.copyUserRamToRam8	;஢   
 419++A6D3 ~            	 pop	de
 420++A6D3 ~            	 ex	(sp),hl
 421++A6D3 ~            	 ex	de,hl
 422++A6D3 ~            	 call	WrSecHDD_hl		; ᥪ
 423++A6D3 ~            	 pop	hl
 424++A6D3 ~            	 pop	bc
 425++A6D3 ~            	 ret
 426++A6D3              	ENDIF
 427++A6D3 18 FE        	jr	WrSecHDD_hl
 428++A6D5              	org	$-2
 429++A6D3
 430++A6D3              	endif
 431++A6D3
 432++A6D3              ;------------------------------------------------------------------------------
 433++A6D3              WrSecHDD_hl	ifused
 434++A6D3              ;ﬠ  ᥪ      hl
 435++A6D3              ;:  ix -  fcb
 436++A6D3              ;     hl -   
 437++A6D3              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 438++A6D3              ;: cy=1 뫨 訡
 439++A6D3              ;       a=errRWnum
 440++A6D3              ;       a=errInvalidPart
 441++A6D3              ;       a=errEoF - 䠩 ࢠ
 442++A6D3              ;       a=errFileEmpty
 443++A6D3              ;     cy=0 - ᥪ ᠭ
 444++A6D3              ;       hl - ᫥騩   
 445++A6D3              ;       bc=#0200 ⢮ ᠭ 
 446++A6D3              ;     de,a - ???
 447++A6D3              ;
 448++A6D3              ;WrSecHDD_hl
 449++A6D3              ;
 450++A6D3 DD E5        	push	ix
 451++A6D5 E3           	ex	(sp),hl
 452++A6D6 01 0C 00     	ld	bc,fcbClsFile
 453++A6D9 09           	add	hl,bc		;  ஬ ࢮ  䠩
 454++A6DA CD A0 AB     	call	CalcAdrSecInFile;dehl - LBA  ᥪ
 455++A6DD              ;	jr	c,goto105	;訡
 456++A6DD 38 25        	jr	c,goto081	;訡
 457++A6DF              	hddSetCurrSec		;  ⠭  ६  LBA/CHS  ᨬ  ஥
 457++A6DF CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 458++A6E2 E1           	pop	hl
 459++A6E3              	hddWriteSecHL		; ᥪ    
 459++A6E3 CD BF 9B    >	call	DrvHDD.WrSecHDD_HL
 460++A6E6 18 13        	jr	goto185
 461++A6E8              ;	ld	a,errRWnum
 462++A6E8              ;	ret	c		;訡 ⥭ 
 463++A6E8              ;	ld	bc,#0200
 464++A6E8              ;	add	hl,bc
 465++A6E8              ;	or	a
 466++A6E8              ;	ret
 467++A6E8              ;goto105	pop	hl
 468++A6E8              ;	ret
 469++A6E8
 470++A6E8              	endif
 471++A6E8
 472++A6E8              ;------------------------------------------------------------------------------
 473++A6E8              tmRdSecHDD_hl	ifused
 474++A6E8              ;אַ ⥭ ᥪ      hl ( ⥭ )
 475++A6E8              ;      ⥬ , ⠥ १ 
 476++A6E8              ;:  ix -  fcb
 477++A6E8              ;     hl -   ⥭
 478++A6E8              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 479++A6E8              ;: cy=1 뫨 訡
 480++A6E8              ;       a=errRWnum
 481++A6E8              ;       a=errInvalidPart
 482++A6E8              ;       a=errEoF - 䠩 ࢠ
 483++A6E8              ;       a=errFileEmpty
 484++A6E8              ;     cy=0, nz - ⠫   
 485++A6E8              ;     cy=0, z - ⠫  , ⮬ ४뢠   짮⥫
 486++A6E8              ;       hl - ᫥騩   
 487++A6E8              ;       bc=#0200 ⢮ ⠭ 
 488++A6E8              ;     de,bc,a - ???
 489++A6E8              ;
 490++A6E8              ;tmRdSecHDD_hl
 491++A6E8              ;
 492++A6E8              	IFDEF	forProfROM
 493++A6E8 ~            	 bit	5,(iy+#0B)
 494++A6E8 ~            	 jr	z,RdSecHDD_hl		;맮  
 495++A6E8 ~            	 ld	bc,#0200		;ࠧ ᥪ
 496++A6E8 ~            	 call	Rom7.CheckAdrMem	;।   ⥭  ⥬ 
 497++A6E8 ~            	 jr	nc,RdSecHDD_hl		;஢  
 498++A6E8 ~            	 push	hl
 499++A6E8 ~            	 ld	hl,Buf4File
 500++A6E8 ~            	 call	RdSecHDD_hl
 501++A6E8 ~            	 pop	de
 502++A6E8 ~            	 ret	c			;뫨 訡 ⥭
 503++A6E8 ~            	 ld	hl,Buf4File
 504++A6E8 ~            	 push	bc
 505++A6E8 ~            	 rst	#30
 506++A6E8 ~            	 dw	Rom2.copyRam8ToUserRam	;⠭    ram 8
 507++A6E8 ~            	 db	#02
 508++A6E8 ~            	 pop	bc
 509++A6E8 ~            	 ex	de,hl
 510++A6E8 ~            	 xor	a
 511++A6E8 ~            	 ret
 512++A6E8              	ENDIF
 513++A6E8              	IFDEF	forRRL
 514++A6E8 ~            	 bit	5,(iy+P0Bh)
 515++A6E8 ~            	 jr	z,RdSecHDD_hl		;맮  
 516++A6E8 ~            	 ld	bc,#0200		;ࠧ ᥪ
 517++A6E8 ~            	 call	r8d.CheckAdrMem		;।   ⥭  ⥬ 
 518++A6E8 ~            	 jr	nc,RdSecHDD_hl		;஢  
 519++A6E8 ~            	 push	hl
 520++A6E8 ~            	 ld	hl,Buf4File
 521++A6E8 ~            	 call	RdSecHDD_hl
 522++A6E8 ~            	 pop	de
 523++A6E8 ~            	 ret	c			;뫨 訡 ⥭
 524++A6E8 ~            	 ld	hl,Buf4File
 525++A6E8 ~            	 push	bc
 526++A6E8 ~            	 call	Rom2.copyRam8ToUserRam	;⠭    ram 8
 527++A6E8 ~            	 pop	bc
 528++A6E8 ~            	 ex	de,hl
 529++A6E8 ~            	 xor	a
 530++A6E8 ~            	 ret
 531++A6E8              	ENDIF
 532++A6E8 18 FE        	jr	RdSecHDD_hl
 533++A6EA              	org	$-2
 534++A6E8
 535++A6E8              	endif
 536++A6E8
 537++A6E8              ;------------------------------------------------------------------------------
 538++A6E8              RdSecHDD_hl	ifused
 539++A6E8              ;אַ ⥭ ᥪ      hl
 540++A6E8              ;:  ix -  fcb
 541++A6E8              ;     hl -   ⥭
 542++A6E8              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 543++A6E8              ;: cy=1 뫨 訡
 544++A6E8              ;       a=errRWnum
 545++A6E8              ;       a=errInvalidPart
 546++A6E8              ;       a=errEoF - 䠩 ࢠ
 547++A6E8              ;       a=errFileEmpty
 548++A6E8              ;     cy=0 - ᥪ ⠭
 549++A6E8              ;       hl - ᫥騩   
 550++A6E8              ;       bc=#0200 ⢮ ⠭ 
 551++A6E8              ;     de,a - ???
 552++A6E8              ;
 553++A6E8              ;RdSecHDD_hl
 554++A6E8              ;
 555++A6E8 DD E5        	push	ix
 556++A6EA E3           	ex	(sp),hl
 557++A6EB 01 0C 00     	ld	bc,fcbClsFile
 558++A6EE 09           	add	hl,bc		;  ஬ ࢮ  䠩
 559++A6EF CD A0 AB     	call	CalcAdrSecInFile;dehl - LBA  ᥪ
 560++A6F2 38 10        	jr	c,goto081	;訡
 561++A6F4              	hddSetCurrSec		;  ⠭  ६  LBA/CHS  ᨬ  ஥
 561++A6F4 CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 562++A6F7 E1           	pop	hl
 563++A6F8              	hddReadSec2HL		;⥭ ᥪ    
 563++A6F8 CD 93 9B    >	call	DrvHDD.RdSecHDD_HL
 564++A6FB 3E 50        goto185	ld	a,errRWnum
 565++A6FD D8           	ret	c		;訡 ⥭ 
 566++A6FE 01 00 02     	ld	bc,#0200
 567++A701 09           	add	hl,bc
 568++A702 B7           	or	a
 569++A703 C9           	ret
 570++A704 E1           goto081	pop	hl
 571++A705 C9           	ret
 572++A706
 573++A706              	endif
 574++A706
 575++A706              ;==============================================================================
 576++A706
# file closed: Drivers/DrvFAT/DrvFAT.rst.a80
 130+ A706              	INCLUDE	"DrvFAT.format.a80"
# file opened: Drivers/DrvFAT/DrvFAT.format.a80
   1++A706              ;楤  FAT Driver. ᮧ  ଠ஢ ࠧ
   2++A706              ;䠩 DrvFAT.format.a80
   3++A706              ;
   4++A706              ;fatFormatPart		ଠ஢ ࠧ FAT
   5++A706              ;
   6++A706              ;------------------------------------------------------------------------------
   7++A706              fatFormatPart	ifused
   8++A706 ~            ;ଠ஢ ࠧ FAT
   9++A706 ~            ;:  a - ࠧ  (=#01/#02/#04/#08/#10/#20/#40/#80)
  10++A706 ~            ;         =#00 ⮬᪨  室  ꥬ ࠧ
  11++A706 ~            ;     hl -  ਯ ࠧ (    xEBF5)
  12++A706 ~            ;: cy=1 뫨 訡
  13++A706 ~            ;       a=errHddNotFound
  14++A706 ~            ;       a=errHddRWerror
  15++A706 ~            ;       a=errHddBusy
  16++A706 ~            ;       a=errHddNotReady
  17++A706 ~            ;       a=errHddNotData
  18++A706 ~            ;
  19++A706 ~            ;fatFormatPart
  20++A706 ~            ;
  21++A706 ~            	call	DeinitFATpart
  22++A706 ~
  23++A706 ~            ;ନ㥬 boot sector
  24++A706 ~            	push	af
  25++A706 ~            	push	hl
  26++A706 ~            	ld	hl,BootSecFAT32
  27++A706 ~            	ld	de,Buf4Format
  28++A706 ~            	ld	bc,#005A
  29++A706 ~            	ldir
  30++A706 ~            	ld	h,d
  31++A706 ~            	ld	l,e
  32++A706 ~            	inc	de
  33++A706 ~            	ld	(hl),b
  34++A706 ~            	ld	bc,#05A3
  35++A706 ~            	ldir
  36++A706 ~            	ld	hl,#AA55
  37++A706 ~            	ld	(Buf4Format+#1FE),hl
  38++A706 ~            	pop	hl
  39++A706 ~            ;   砫 ࠧ
  40++A706 ~            	ld	c,#04
  41++A706 ~            	add	hl,bc
  42++A706 ~            	add	hl,bc
  43++A706 ~            	ld	de,tmpDWORD
  44++A706 ~            	ldir
  45++A706 ~            ;  ᥪ஢  ࠧ
  46++A706 ~            	ld	de,Buf4Format+#20
  47++A706 ~            	ld	c,#04
  48++A706 ~            	ldir
  49++A706 ~            ;  ᥪ஢  
  50++A706 ~            	pop	af
  51++A706 ~            	ld	bc,(Buf4Format+#20+2)
  52++A706 ~            	or	a
  53++A706 ~            	jr	nz,goto140
  54++A706 ~            	ld	hl,TablCLS
  55++A706 ~            	ld	a,#80
  56++A706 ~            loop053	rrca
  57++A706 ~            	ld	e,(hl)
  58++A706 ~            	inc	hl
  59++A706 ~            	ld	d,(hl)
  60++A706 ~            	inc	hl
  61++A706 ~            	ex	de,hl
  62++A706 ~            	sbc	hl,bc
  63++A706 ~            	ex	de,hl
  64++A706 ~            	jr	nc,loop053
  65++A706 ~            goto140	ld	(Buf4Format+#0D),a	;ᥪ஢  
  66++A706 ~            ;  ࠧ FAT  ᥪ
  67++A706 ~            ;  (((ᥪ஢  ࠧ-१ࢨ஢)/ᥪ஢  +1)/(512/4))+1
  68++A706 ~            	ld	d,b
  69++A706 ~            	ld	e,c
  70++A706 ~            	ld	hl,(Buf4Format+#20)	;dehl - ࠧ ࠧ  ᥪ
  71++A706 ~            	ld	bc,(Buf4Format+#0E)	;bc - १ࢨ஢ ᥪ஢
  72++A706 ~            	or	a
  73++A706 ~            	sbc	hl,bc
  74++A706 ~            	jr	nc,goto141
  75++A706 ~            	dec	de
  76++A706 ~            goto141	call	SRL_dehl_A		;dehl=dehl/a
  77++A706 ~            	call	Inc_DEHL		;dehl+1
  78++A706 ~            	ld	a,#80
  79++A706 ~            	call	SRL_dehl_A		;dehl=dehl/#80
  80++A706 ~            	call	Inc_DEHL		;dehl+1 (ࠧ FAT ⠡)
  81++A706 ~            	ld	(Buf4Format+#24),hl	;ࠧ FAT ⠡
  82++A706 ~            	ld	(Buf4Format+#24+2),de
  83++A706 ~            ;  ନ㥬 ᥪ FS-Info
  84++A706 ~            	ld	hl,FSinfoSecFAT32
  85++A706 ~            	ld	de,Buf4Format+#200
  86++A706 ~            	ld	bc,#0004
  87++A706 ~            	ldir
  88++A706 ~            	ld	de,Buf4Format+#200+#1E4
  89++A706 ~            	ld	c,#0C
  90++A706 ~            	ldir
  91++A706 ~            	ld	hl,#AA55
  92++A706 ~            	ld	(Buf4Format+#3FE),hl
  93++A706 ~            ;  襬  ᥪ஢ ( ࠧ  )
  94++A706 ~            	ld	hl,tmpDWORD
  95++A706 ~            	call	LD_DEHL_adrHL		; 砫 ࠧ
  96++A706 ~            	call	proc_12
  97++A706 ~            	call	nc,proc_12
  98++A706 ~            	ret	c			;訡 
  99++A706 ~
 100++A706 ~            ;㫨 ⠢訥 १ࢨ஢ ᥪ,   FAT, ୥ ⠫
 101++A706 ~            	push	de
 102++A706 ~            	push	hl
 103++A706 ~            	exx
 104++A706 ~            	ld	bc,#20-#06-#06		;⠢襥  १ࢨ஢
 105++A706 ~            	ld	a,(Buf4Format+#0D)	;ᥪ஢  
 106++A706 ~            	add	a,c
 107++A706 ~            	ld	c,a
 108++A706 ~            	ld	hl,(Buf4Format+#24)	;ࠧ FAT ⠡
 109++A706 ~            	ld	de,(Buf4Format+#24+2)
 110++A706 ~            	add	hl,hl
 111++A706 ~            	ex	de,hl
 112++A706 ~            	adc	hl,hl
 113++A706 ~            	ex	de,hl			;ࠧ FAT ⠡ *2
 114++A706 ~            	add	hl,bc
 115++A706 ~            	jr	nc,loop054
 116++A706 ~            	inc	de			;dehl ⢮ ᥪ஢  㫥
 117++A706 ~            loop054	push	hl
 118++A706 ~            	push	de
 119++A706 ~            	exx
 120++A706 ~            	call	proc_13
 121++A706 ~            	dw	Buf4Format+#400
 122++A706 ~            	exx
 123++A706 ~            	pop	de
 124++A706 ~            	pop	hl
 125++A706 ~            	jr	c,goto143
 126++A706 ~            	call	Dec_DEHL
 127++A706 ~            	ld	a,d
 128++A706 ~            	or	e
 129++A706 ~            	or	h
 130++A706 ~            	or	l
 131++A706 ~            	jr	nz,loop054
 132++A706 ~
 133++A706 ~            ;ய襬  ⠡ FAT  
 134++A706 ~            	ld	b,#0A
 135++A706 ~            	ld	hl,Buf4Format+#400
 136++A706 ~            	ld	(hl),#F8
 137++A706 ~            	inc	hl
 138++A706 ~            loop055	ld	(hl),#FF
 139++A706 ~            	inc	hl
 140++A706 ~            	djnz	loop055
 141++A706 ~            	ld	a,#0F
 142++A706 ~            	ld	(hl),a
 143++A706 ~            	ld	(Buf4Format+#400+#03),a
 144++A706 ~            	pop	hl
 145++A706 ~            	pop	de
 146++A706 ~            	ld	bc,#20-#06-#06		;⠢襥  १ࢨ஢
 147++A706 ~            	add	hl,bc
 148++A706 ~            	jr	nc,goto142
 149++A706 ~            	inc	de
 150++A706 ~            goto142	ld	c,#01
 151++A706 ~            	call	proc_13
 152++A706 ~            	dw	Buf4Format+#400
 153++A706 ~            	ret	c
 154++A706 ~            	ld	bc,Buf4Format+#24
 155++A706 ~            	call	Add_DEHL_adrBC
 156++A706 ~            	call	Dec_DEHL
 157++A706 ~            	ld	bc,#0001
 158++A706 ~            	call	proc_13
 159++A706 ~            	dw	Buf4Format+#400
 160++A706 ~            	ret
 161++A706 ~
 162++A706 ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 163++A706 ~            ;  ᥪ஢: boot, FSinfo, 4 
 164++A706 ~            ;:  dehl - LBA  ࢮ ᥪ
 165++A706 ~            ;: cy=1 訡 
 166++A706 ~            ;     cy=0  ᠭ ᯥ譮
 167++A706 ~            ;     dehl=dehl+#06
 168++A706 ~            ;     bc=#0001
 169++A706 ~            ;
 170++A706 ~            proc_12	ld	bc,#0003
 171++A706 ~            	call	proc_13
 172++A706 ~            	dw	Buf4Format
 173++A706 ~            	ret	c
 174++A706 ~            	ld	bc,#0301
 175++A706 ~            loop056	push	bc
 176++A706 ~            	ld	b,#00
 177++A706 ~            	call	proc_13
 178++A706 ~            	dw	Buf4Format+#400
 179++A706 ~            	pop	bc
 180++A706 ~            	ret	c
 181++A706 ~            	djnz	loop056
 182++A706 ~            	ret
 183++A706 ~
 184++A706 ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 185++A706 ~            ; 㯯 ᥪ஢
 186++A706 ~            ;:  dehl - LBA  ࢮ ᥪ
 187++A706 ~            ;     bc - ⢮ ᥪ஢  
 188++A706 ~            ;     dw #nnnn -  , 㤠 襬
 189++A706 ~            ;: cy=1 訡 
 190++A706 ~            ;     cy=0  ᠭ ᯥ譮
 191++A706 ~            ;     dehl=dehl+bc
 192++A706 ~            ;     bc -  
 193++A706 ~            ;
 194++A706 ~            proc_13	ex	(sp),hl
 195++A706 ~            	push	de
 196++A706 ~            	pop	af
 197++A706 ~            	ld	e,(hl)
 198++A706 ~            	inc	hl
 199++A706 ~            	ld	d,(hl)
 200++A706 ~            	inc	hl
 201++A706 ~            	ex	(sp),hl
 202++A706 ~            	push	hl
 203++A706 ~            	push	af
 204++A706 ~            	push	bc
 205++A706 ~            	push	bc
 206++A706 ~            	push	de
 207++A706 ~            	push	af
 208++A706 ~            	pop	de
 209++A706 ~            	hddSetCurrSec
 210++A706 ~            	pop	hl
 211++A706 ~            	pop	bc
 212++A706 ~            	ld	b,c
 213++A706 ~            	scf
 214++A706 ~            	DirectRdWrSectors
 215++A706 ~            	pop	bc
 216++A706 ~            goto143	pop	de
 217++A706 ~            	pop	hl
 218++A706 ~            	ret	c
 219++A706 ~            	add	hl,bc
 220++A706 ~            	ret	nc
 221++A706 ~            	inc	de
 222++A706 ~            	or	a
 223++A706 ~            	ret
 224++A706 ~
 225++A706              	endif
 226++A706
 227++A706              ;==============================================================================
 228++A706              ;蠡  boot sector FAT32
 229++A706              BootSecFAT32	ifused
 230++A706 ~            ;
 231++A706 ~             db #EB,#3C,#90		;+#00..#02 Jump code
 232++A706 ~             db "MSDOS5.0"		;+#03..#0A OEM Name
 233++A706 ~             dw #200		;+#0B Bytes per sector
 234++A706 ~             db #00;?		;+#0D sectors_per_cluster
 235++A706 ~             dw #0020		;+#0E १ࢨ஢ ᥪ஢
 236++A706 ~             db #02			;+#10 ⢮  FAT
 237++A706 ~             dw #0000		;+#11 ⢮ ᥩ  ୥ ⠫ =0  FAT32
 238++A706 ~             dw #0000;?		;+#13 Total sectors (use FAT32 count instead)
 239++A706 ~             db #F8			;+#15 Media type
 240++A706 ~             dw #0000		;+#16 Count of sectors used by the FAT table (FAT16 only)
 241++A706 ~             dw #003F		;+#18 Sectors per track (default)
 242++A706 ~             dw #00FF		;+#1A Heads (default)
 243++A706 ~             dd #00000000		;+#1C Hidden sectors
 244++A706 ~             dd #00000000;?		;+#20 Total sectors for this volume
 245++A706 ~             dd #00000000;?		;+#24 BPB_FATSz32 (ࠧ FAT  ᥪ)
 246++A706 ~             dw #0000		;+#28 BPB_ExtFlags
 247++A706 ~             dw #0000		;+#2A BPB_FSVer
 248++A706 ~             dd #00000002		;+#2C BPB_RootClus
 249++A706 ~             dw #0001		;+#30 BPB_FSInfo
 250++A706 ~             dw #0006		;+#32 BPB_BkBootSec
 251++A706 ~             ds #0C,#00		;+#34..#3F free
 252++A706 ~             db #00			;+#40 Drive number
 253++A706 ~             db #00			;+#41 free
 254++A706 ~             db #29			;+#42 Boot signature
 255++A706 ~             db #12,#34,#56,#78	;+#43..#46 Volume ID
 256++A706 ~             db "ZS-Scorpion"	;+#47..#51 Volume name
 257++A706 ~             db "FAT32   "		;+#52..59 File sys type
 258++A706 ~            ; ds #1A4,#00		;+#5A..#1FD free
 259++A706 ~            ; db #55,#AA		;+#1FE Signature
 260++A706              	endif
 261++A706
 262++A706              ;蠡  fsinfo ᥪ
 263++A706              FSinfoSecFAT32	ifused
 264++A706 ~            ;
 265++A706 ~             db "RRaA"		;+#00..#03 ᨣ
 266++A706 ~             db "rrAa"		;+#1E4..#1E7 ᨣ
 267++A706 ~             db #FF,#FF,#FF,#FF	;+#1E8..#1EB Free Count
 268++A706 ~             db #FF,#FF,#FF,#FF	;+#1EC..#1EF Next Free
 269++A706              	endif
 270++A706
 271++A706              ;⠡   ⢠ ᥪ஢  
 272++A706              ;
 273++A706              TablCLS	ifused
 274++A706 ~            	dw #03FF
 275++A706 ~            	dw #01FF
 276++A706 ~            	dw #00FF
 277++A706 ~            	dw #0007
 278++A706 ~            	dw #0003
 279++A706 ~            	dw #0001
 280++A706 ~            	dw #0000
 281++A706              	endif
 282++A706              ;==============================================================================
 283++A706
# file closed: Drivers/DrvFAT/DrvFAT.format.a80
 131+ A706              	INCLUDE	"DrvFAT.dir.a80"
# file opened: Drivers/DrvFAT/DrvFAT.dir.a80
   1++A706              ;楤  FAT Driver. ࠡ  ⠫
   2++A706              ;䠩 DrvFAT.dir.a80
   3++A706              ;
   4++A706              ;fatRenMoveEntry	२/७   㣮 ⠫ 
   5++A706              ;			।  ࠧ FAT
   6++A706              ;fatWriteEntry		ᮧ   ⠫ (⮫쪮 )
   7++A706              ;FindPathFile		 䠩     ⥪饬 ⠫ 
   8++A706              ;			室  ⠫  ஢મ ᨭ⠪
   9++A706              ;SetPathFile		 䠩     ⥪饬 ⠫ 
  10++A706              ;			室  ⠫  ஢મ ᨭ⠪
  11++A706              ;			 ⠭  ⠫ ⥪騬
  12++A706              ;Enter2DIR		室  ४
  13++A706              ;SetDirCurrent		⠭ ४ਨ ⥪饩
  14++A706              ;fatEraseEntry		㤠   ⥪饬 ⠫ (䠩/⮣ ⠫)
  15++A706              ;fatMarkDelEntry	⪠  䠩  ⠫   ﬨ
  16++A706              ;			  㤠묨
  17++A706              ;fatGetEntryLBA		  ⥪饬 ⠫ ਯ   LBA 
  18++A706              ;fatGetEntryLong	  ⥪饬 ⠫ ਯ   
  19++A706              ;fatGetEntry		  ⥪饬 ⠫ ਯ   
  20++A706              ;fatTestEmptyDir	஢ઠ ⥪飮 ⠫ ⮩  
  21++A706              ;SortFoundedEntries	஢ ᯨ᪠  ਯ஢
  22++A706              ;			(䠩/⠫)
  23++A706              ;GetNumOfEntries	 ⢠ ⨬ ( 256) ᥩ 
  24++A706              ;			⥪饬 ⠫
  25++A706              ;fatCreateDIR		ᮧ ⠫  ⥪饬 FAT32 ⠫
  26++A706              ;fatCreateDIRlfn	ᮧ ⠫     ⥪饬 FAT32 ⠫
  27++A706              ;fatFindEntryDir	   ⥪饬 ⠫    ଠ
  28++A706              ;			name[.][ext]\
  29++A706              ;CP_TwoDot		஢ઠ  䠩   窨 (뫪  த⥫)
  30++A706              ;CP_OneDot		஢ઠ  䠩    (뫪  ᥡ)
  31++A706              ;ReadSectorDIR		⥭ ᥪ ⠫     
  32++A706              ;fatSetTmpDir		⠭ ६ ⥪饩 ४ਨ
  33++A706              ;
  34++A706              ;------------------------------------------------------------------------------
  35++A706              fatRenMoveEntry	ifused
  36++A706 ~            ;२/७   ⥪饣 ⠫  㣮 ⠫
  37++A706 ~            ;   ।  ࠧ
  38++A706 ~            ;     ஢७   SFN ॢ  孨 ॣ
  39++A706 ~            ;  䠩/⠫  ⢮
  40++A706 ~            ;   fcb   ⠭: fcbName, fcbExt, fcbAttr, fcbClsFile,
  41++A706 ~            ;    fcbClsDIR, bit3 fcbType=0/1 SFN/LFN
  42++A706 ~            ;:  ix -   fcb
  43++A706 ~            ;     fcbName, fcbExt - ஥   ७
  44++A706 ~            ;     hl -  ப     ଠ ASCIIZ
  45++A706 ~            ;     hl -     ଠ name[.][ext]\ (  ଠ 8+3)
  46++A706 ~            ;     de -  ६   ஬ ⠫-ਥ, ᫨ ࠢ
  47++A706 ~            ;        fcbClsDIR   २
  48++A706 ~            ;: cy=1 訡 ⥭/,   
  49++A706 ~            ;       a=errRWnum
  50++A706 ~            ;       a=errInvalidPart
  51++A706 ~            ;       a=errEoF - 䠩 ࢠ
  52++A706 ~            ;       a=errFileEmpty - ⮩ ୥ ⠫
  53++A706 ~            ;	a=errFileNotFound
  54++A706 ~            ;       a=errInvFileName 䠩  ⠪  /⮥ 
  55++A706 ~            ;       a=errDiskNoSpace
  56++A706 ~            ;     cy=0  ᥭ  ⫮
  57++A706 ~            ;
  58++A706 ~            ;fatRenMoveEntry
  59++A706 ~            ;
  60++A706 ~            ;।    ⠫-筨
  61++A706 ~            	push	hl
  62++A706 ~            	push	de
  63++A706 ~            	push	ix
  64++A706 ~            	pop	hl
  65++A706 ~            	call	fcbFindEntry
  66++A706 ~            	pop	de
  67++A706 ~            	pop	hl
  68++A706 ~            	ret	c			;訡 ⥭/䠩  
  69++A706 ~
  70++A706 ~            ;஢ઠ ⨯  SFN/LFN
  71++A706 ~            	push	bc			;   ⠫-筨
  72++A706 ~            	bit	3,(ix+fcbType)
  73++A706 ~            	jr	nz,goto191		; LFN
  74++A706 ~
  75++A706 ~            ;஢ઠ ⢮ 䠩  ⠫-ਥ ( SFN)
  76++A706 ~            	push	de
  77++A706 ~            ;  ⠭ ⠫-ਥ
  78++A706 ~            	push	hl
  79++A706 ~            	ex	de,hl
  80++A706 ~            	call	excngCLSCurrDir		;⠫-ਥ
  81++A706 ~            	pop	hl
  82++A706 ~            ;  ନ㥬  SFN  fcb    ਥ
  83++A706 ~            	push	hl
  84++A706 ~            	push	ix
  85++A706 ~            	pop	de
  86++A706 ~            	call	FileNameTo8dot3
  87++A706 ~            	pop	hl
  88++A706 ~            ;     ⠫-ਥ
  89++A706 ~            	call	fatFindEntryDir
  90++A706 ~            	pop	hl
  91++A706 ~            	jr	c,goto192		;訡 ⥭
  92++A706 ~            	ld	a,errFileExist
  93++A706 ~            	jr	z,goto192		;nc ⠪ 䠩   ਥ
  94++A706 ~            ;  ⠭ ⠫-筨
  95++A706 ~            	push	hl
  96++A706 ~            	call	excngCLSCurrDir		;⠫-筨
  97++A706 ~            	pop	de
  98++A706 ~            	sbc	hl,hl			;hl=#0000
  99++A706 ~
 100++A706 ~            ;ᮧ   ⠫-ਥ
 101++A706 ~            goto191	call	fatWriteEntry		;ᮧ 
 102++A706 ~            	pop	bc
 103++A706 ~            	ret	c			;訡
 104++A706 ~
 105++A706 ~            ;㤠   ⠫-筨
 106++A706 ~            	ld	a,#FF
 107++A706 ~            	ld	(SecDIRinBuf+#03),a	;  ᥪ ⠫
 108++A706 ~            	jp	fatMarkDelEntry		;㤠   ⪨ 楯窨 ஢
 109++A706 ~
 110++A706 ~            ;訡
 111++A706 ~            goto192	pop	bc
 112++A706 ~            	scf
 113++A706 ~            	jr	proc_17			;⠫-筨 (  / fatWriteEntry)
 114++A706 ~
 115++A706 ~
 116++A706 ~            /* ਠ. ४
 117++A706 ~            ;fatRenMoveEntry
 118++A706 ~            ;
 119++A706 ~            ;⠭ ਧ ⠫
 120++A706 ~            	ld	a,(ix+fcbAttr)
 121++A706 ~            	and	#10
 122++A706 ~            	ld	(ix+fcbType),a
 123++A706 ~
 124++A706 ~            ;஢塞 ⢮ 䠩  ⠫ ਥ/⥪饬
 125++A706 ~            	push	hl
 126++A706 ~            	push	de
 127++A706 ~            	ex	de,hl
 128++A706 ~            	call	excngCLSCurrDir		;⠫-ਥ
 129++A706 ~            	push	ix
 130++A706 ~            	pop	hl
 131++A706 ~            	call	fatFindEntryDir
 132++A706 ~            	jr	c,goto188		;訡 ⥭
 133++A706 ~            	ld	a,errFileExist
 134++A706 ~            	jr	z,goto188		;nc ⠪ 䠩   ਥ
 135++A706 ~            	pop	hl
 136++A706 ~            	push	hl
 137++A706 ~            	call	excngCLSCurrDir		;⠭ ClsDIR 筨
 138++A706 ~
 139++A706 ~            ;稬   室 䠩  ⠫ 筨
 140++A706 ~            	push	ix
 141++A706 ~            	pop	hl
 142++A706 ~            	call	fatFindEntryDir		;bc -    ⠫
 143++A706 ~            	jr	c,goto189		;訡
 144++A706 ~            	ld	a,errFileNotFound
 145++A706 ~            	jr	nz,goto189		;  ⠪  
 146++A706 ~            	call	fatMarkDelEntry		;㤠   ⪨ 楯窨 ஢
 147++A706 ~            	jr	c,goto189		;訡
 148++A706 ~
 149++A706 ~            ;ᮧ   ⠫ ਥ
 150++A706 ~            	pop	de
 151++A706 ~            	pop	hl
 152++A706 ~            	call	fatWriteEntry
 153++A706 ~
 154++A706 ~            ;室  訡
 155++A706 ~            goto188	pop	hl
 156++A706 ~            	push	hl
 157++A706 ~            	call	proc_17			;⠫-ਥ
 158++A706 ~            goto189	pop	hl
 159++A706 ~            	pop	de
 160++A706 ~            	ret
 161++A706 ~            */
 162++A706              	endif
 163++A706
 164++A706              ;------------------------------------------------------------------------------
 165++A706              fatWriteEntry	ifused
 166++A706 ~            ;ᮧ   ⠫ (⮫쪮 )
 167++A706 ~            ;  䠩/⠫  ⢮
 168++A706 ~            ;   fcb   ⠭: fcbName, fcbExt, fcbAttr, fcbClsFile,
 169++A706 ~            ;    fcbClsDIR, fcbSize
 170++A706 ~            ;:  ix -   fcb
 171++A706 ~            ;     fcbName, fcbExt -    ७  ࠡ  SFN
 172++A706 ~            ;     hl -  ப     ଠ ASCIIZ  (fcbName, fcbExt   ⠭)
 173++A706 ~            ;        =#0000  SFN
 174++A706 ~            ;     de -  ६   ஬ ⠫ ਥ, ᫨ ࠢ
 175++A706 ~            ;        fcbClsDIR   २
 176++A706 ~            ;: cy=1 訡 ⥭/
 177++A706 ~            ;       a=errRWnum
 178++A706 ~            ;       a=errInvalidPart
 179++A706 ~            ;       a=errEoF - 䠩 ࢠ
 180++A706 ~            ;       a=errFileEmpty - ⮩ ୥ ⠫
 181++A706 ~            ;       a=errInvFileName 䠩  ⠪  /⮥ 
 182++A706 ~            ;       a=errDiskNoSpace
 183++A706 ~            ;     cy=0  ᥭ  ⫮
 184++A706 ~            ;     hl,de,bc - ???
 185++A706 ~            ;
 186++A706 ~            ;fatWriteEntry
 187++A706 ~            ;
 188++A706 ~            ;⠭ ਧ ⠫
 189++A706 ~            	ld	a,(ix+fcbAttr)
 190++A706 ~            	and	#10
 191++A706 ~            	ld	(ix+fcbType),a
 192++A706 ~
 193++A706 ~            ;ᮧ   ⠫-ਥ
 194++A706 ~            	push	hl
 195++A706 ~            	push	de
 196++A706 ~            	ex	de,hl
 197++A706 ~            	call	excngCLSCurrDir		;⠫-ਥ
 198++A706 ~            	call	fcbSetCLSCurrDir	;⠭  fcb   ⠫-த⥫
 199++A706 ~            	pop	hl
 200++A706 ~            	ex	(sp),hl
 201++A706 ~            	call	fatAddFileEntry
 202++A706 ~            	jr	c,goto190		;訡
 203++A706 ~
 204++A706 ~            ; ⠫ ⠭ 뫪   த⥫
 205++A706 ~            	bit	4,(ix+fcbType)
 206++A706 ~            	jr	z,goto190		;nc  䠩
 207++A706 ~            ;  ஢ਬ ⠫  稥 ᥩ
 208++A706 ~            	push	ix
 209++A706 ~            	pop	hl
 210++A706 ~            	ld	de,fcbClsFile
 211++A706 ~            	add	hl,de
 212++A706 ~            	push	hl
 213++A706 ~            	call	excngCLSCurrDir
 214++A706 ~            	ld	bc,#0000		;bc=#0000  ⥪饩   ⠫
 215++A706 ~            	call	ReadSectorDIR		;⥭ ᥪ ⠫     
 216++A706 ~            	call	nc,LD_DEHL_fcbClsFile	;᫨  訡
 217++A706 ~            	ld	(Buf4DIR+#20+#14),de	;  .. (뫪  த⥫)
 218++A706 ~            	ld	(Buf4DIR+#20+#1A),hl
 219++A706 ~            	call	nc,SaveSecBuf2DIR	;᫨  訡
 220++A706 ~            	pop	hl
 221++A706 ~            	call	proc_17			;⠭ ClsFile
 222++A706 ~            goto190	pop	hl
 223++A706 ~            proc_17	push	af
 224++A706 ~            	call	excngCLSCurrDir		;⠭ CLSCurrDir
 225++A706 ~            	pop	af
 226++A706 ~            	ret
 227++A706 ~
 228++A706              	endif
 229++A706
 230++A706              ;------------------------------------------------------------------------------
 231++A706              FindPathFile	ifused
 232++A706 ~            ; 䠩     ⥪饬 ⠫  室  ⠫
 233++A706 ~            ; ஢મ ᨭ⠪
 234++A706 ~            ;:  hl -   䠩,     (⠭  室)
 235++A706 ~            ;: cy=1 訡 ⥭/  ⠫  / ⮩
 236++A706 ~            ;       z  -  ⮩, ⥪騩 ⠫  
 237++A706 ~            ;         a=errPathEmpty
 238++A706 ~            ;       nz - 訡 ⥭/  ⠫  
 239++A706 ~            ;         a=errInvFileName
 240++A706 ~            ;         a=errRWnum
 241++A706 ~            ;         a=errInvalidPart
 242++A706 ~            ;         a=errEoF - 䠩 ࢠ
 243++A706 ~            ;         a=errFileEmpty - ⮩ ୥ ⠫
 244++A706 ~            ;         a=errFileNotFound
 245++A706 ~            ;     cy=0   ⠫ 
 246++A706 ~            ;       z  -> a=#00 -  ⠫
 247++A706 ~            ;       nz -> a=#00 -  䠩,   ᫥  
 248++A706 ~            ;       nz -> a<>#00 -  䠩,   ᫥  
 249++A706 ~            ;       b - ࠡ⠭ 
 250++A706 ~            ;       hl -  砫 ਯ 䠩
 251++A706 ~            ;       de -  砫 
 252++A706 ~            ;       (de) -  
 253++A706 ~            ;
 254++A706 ~            ;FindPathFile
 255++A706 ~            ;
 256++A706 ~            	call	SetPathFile
 257++A706 ~            	ret	c
 258++A706 ~            	scf			;⠭  ४ਨ
 259++A706 ~            	call	StoreCLSCurrDir
 260++A706 ~            	ccf
 261++A706 ~            	ret
 262++A706 ~
 263++A706              	endif
 264++A706
 265++A706              ;------------------------------------------------------------------------------
 266++A706              SetPathFile	ifused
 267++A706 ~            ; 䠩     ⥪饬 ⠫  室  ⠫
 268++A706 ~            ; ஢મ ᨭ⠪  ⠭  ⠫ ⥪騬
 269++A706 ~            ;ଠ : [Drive:][\][DIR\DIR\..\DIR\]filename.ext
 270++A706 ~            ;:  hl -   䠩,     (⠭  室)
 271++A706 ~            ;: cy=1 訡 ⥭/  ⠫  / ⮩
 272++A706 ~            ;       z  -  ⮩, ⥪騩 ⠫  
 273++A706 ~            ;         a=errPathEmpty
 274++A706 ~            ;       nz - 訡 ⥭/  ⠫  
 275++A706 ~            ;         a=errInvFileName
 276++A706 ~            ;         a=errRWnum
 277++A706 ~            ;         a=errInvalidPart
 278++A706 ~            ;         a=errEoF - 䠩 ࢠ
 279++A706 ~            ;         a=errFileEmpty - ⮩ ୥ ⠫
 280++A706 ~            ;         a=errFileNotFound
 281++A706 ~            ;     cy=0   ⠫ 
 282++A706 ~            ;       z  -> a=#00 -  ⠫, ⥪騩  = ⠫
 283++A706 ~            ;       nz -> a=#00 -  䠩,   ᫥  
 284++A706 ~            ;                      ⥪騩  = ⠫  䠩
 285++A706 ~            ;       nz -> a<>#00 -  䠩,   ᫥  
 286++A706 ~            ;                      ⥪騩  = ⠫  䠩
 287++A706 ~            ;       b - ࠡ⠭ 
 288++A706 ~            ;       hl -  砫 ਯ 䠩
 289++A706 ~            ;       de -  砫 
 290++A706 ~            ;       (de) -  
 291++A706 ~            ;       (DescInCurrDir) -   (䠩)  ⠫
 292++A706 ~            ;     (tmpDIR) ।饥 祭 (CLS_CurrDir)
 293++A706 ~            ;
 294++A706 ~            ;SetPathFile
 295++A706 ~            ;
 296++A706 ~            ;  ⥪饣 ⠫
 297++A706 ~            	or	a
 298++A706 ~            	call	StoreCLSCurrDir
 299++A706 ~
 300++A706 ~            ;஢ઠ /  䠩
 301++A706 ~                    push	hl
 302++A706 ~            	inc	hl
 303++A706 ~            	call	TestPathFile	;஢ઠ /  䠩
 304++A706 ~            	ld	a,errInvFileName
 305++A706 ~            	jr	c,goto134	;訡   䠩
 306++A706 ~            	ld	a,errPathEmpty
 307++A706 ~            	jr	z,goto135	; ⮩
 308++A706 ~            	xor	a		;a - 
 309++A706 ~            	push	af
 310++A706 ~            loop049	call	SkipSeparator	;ய ࠧ⥫   
 311++A706 ~            	or	a
 312++A706 ~            	jr	z,goto128	; 
 313++A706 ~
 314++A706 ~            ;   ⥪饬 ⠫
 315++A706 ~            	push	hl
 316++A706 ~            	call	fatFindEntryDir
 317++A706 ~            	jr	c,goto126	;訡 ⥭
 318++A706 ~            	jr	nz,goto125	;  ⠫  
 319++A706 ~            	ex	(sp),hl
 320++A706 ~            	ld	hl,#000B
 321++A706 ~            	add	hl,de
 322++A706 ~            	bit	4,(hl)
 323++A706 ~            	jr	z,goto127	; 䠩
 324++A706 ~            	ld	h,d
 325++A706 ~            	ld	l,e		; ਯ  
 326++A706 ~            	call	CP_TwoDot
 327++A706 ~            	push	af
 328++A706 ~            	call	SetDirCurrent
 329++A706 ~            	pop	af
 330++A706 ~            	pop	hl
 331++A706 ~            	pop	bc
 332++A706 ~            	jr	nz,goto130
 333++A706 ~            	dec	b
 334++A706 ~            	dec	b		; -1
 335++A706 ~            goto130	inc	b		; +1
 336++A706 ~            	push	bc
 337++A706 ~            	ld	a,(hl)
 338++A706 ~            	or	a
 339++A706 ~            	jr	nz,loop049
 340++A706 ~            	jr	goto128
 341++A706 ~
 342++A706 ~            ; 䠩
 343++A706 ~            ;(sp)b - 
 344++A706 ~            ;(sp)hl -    䠩
 345++A706 ~            ;de -  ਯ  
 346++A706 ~            goto127	dec	h		;⠭ 䫠 nz
 347++A706 ~            	pop	hl		; ᫥饣   
 348++A706 ~            	ld	a,(hl)
 349++A706 ~
 350++A706 ~            ; 
 351++A706 ~            ;: z,a=#00  -  ⠫
 352++A706 ~            ;    nz,a=#nn -  䠩
 353++A706 ~            ;    hl -  ᫥饣    (㪠뢠  #00/#nn)
 354++A706 ~            ;    de -  ਯ  
 355++A706 ~            goto128	ex	af,af'
 356++A706 ~            	pop	af		;
 357++A706 ~            	pop	bc		;砫   䠩
 358++A706 ~            	push	af
 359++A706 ~            ;    ࠭  
 360++A706 ~            	ld	(hl),#00
 361++A706 ~            	or	a
 362++A706 ~            	sbc	hl,bc
 363++A706 ~            	ld	h,b
 364++A706 ~            	ld	b,l
 365++A706 ~            	ld	l,c		;hl 砫   䠩
 366++A706 ~            	ld	(hl),b
 367++A706 ~            	ex	de,hl
 368++A706 ~            	pop	bc		;b = 
 369++A706 ~            	ex	af,af'
 370++A706 ~            	ret
 371++A706 ~
 372++A706 ~            ;  ⠫  
 373++A706 ~            goto125	ld	a,errFileNotFound
 374++A706 ~
 375++A706 ~            ;訡 ⥭/
 376++A706 ~            ;:  a -  訡
 377++A706 ~            ;: cy=1
 378++A706 ~            goto126	pop	hl
 379++A706 ~            	pop	hl
 380++A706 ~            goto134	or	a		;䫠 nz
 381++A706 ~            goto135	scf			;⠭  ४ਨ
 382++A706 ~            	pop	hl
 383++A706 ~            	jp	StoreCLSCurrDir
 384++A706 ~
 385++A706              	endif
 386++A706
 387++A706              ;------------------------------------------------------------------------------
 388++A706              Enter2DIR	ifused
 389++A706              ;室  ४
 390++A706              ;:  hl -  ਯ ४ਨ/䠩
 391++A706              ;     a - attr 
 392++A706              ;     7,e =0  䠩/⠫
 393++A706              ;         =1    த⥫᪨ ⠫
 394++A706              ;     0,e =1   
 395++A706              ;: hl,de,bc,a - ???
 396++A706              ;
 397++A706              ;Enter2DIR
 398++A706              ;
 399++A706 CB 67        	bit	4,a
 400++A708 CA BE B1     	jp	z,RenewPath	; 䠩.  ப ⥪饣 
 401++A70B CB 7B        	bit	7,e
 402++A70D 01 83 8D     	ld	bc,CurrentLevel	;㡨   ⥪饬 ⠫
 403++A710 0A           	ld	a,(bc)
 404++A711 28 04        	jr	z,goto124	;室  ⠫
 405++A713
 406++A713              ;室  த⥫᪨ ⠫
 407++A713 B7           	or	a
 408++A714 C8           	ret	z		;  ୥ ⠫
 409++A715 3D           	dec	a
 410++A716 3D           	dec	a
 411++A717
 412++A717              ;室  ⠫
 413++A717 3C           goto124	inc	a
 414++A718 FE 10        	cp	#10
 415++A71A C8           	ret	z		;᫨誮  
 416++A71B 02           	ld	(bc),a
 417++A71C CD BE B1     	call	RenewPath	; ப ⥪饣 
 418++A71F 18 FE        	jr	SetDirCurrent
 419++A721              	org	$-2
 420++A71F
 421++A71F              	endif
 422++A71F
 423++A71F              ;------------------------------------------------------------------------------
 424++A71F              SetDirCurrent	ifused
 425++A71F              ;⠭ ४ਨ ⥪饩
 426++A71F              ;:  hl -  ਯ ४ਨ
 427++A71F              ;: bc=#0005
 428++A71F              ;
 429++A71F              ;SetDirCurrent
 430++A71F              ;
 431++A71F D5           	push	de
 432++A720 01 14 00     	ld	bc,#0014
 433++A723 09           	add	hl,bc
 434++A724 5E           	ld	e,(hl)
 435++A725 23           	inc	hl
 436++A726 56           	ld	d,(hl)		;  (襥 ᫮)
 437++A727 0E 05        	ld	c,#05
 438++A729 09           	add	hl,bc
 439++A72A 7E           	ld	a,(hl)
 440++A72B 23           	inc	hl
 441++A72C 66           	ld	h,(hl)		;  (襥 ᫮)
 442++A72D 6F           	ld	l,a
 443++A72E B4           	or	h
 444++A72F B2           	or	d
 445++A730 B3           	or	e
 446++A731 20 07        	jr	nz,goto123	; ୥ ⠫
 447++A733 2A 77 8D     	ld	hl,(RootClaster)
 448++A736 ED 5B 79 8D  	ld	de,(RootClaster+2)
 449++A73A 22 84 8D     goto123	ld	(CLS_CurrDir),hl
 450++A73D ED 53 86 8D  	ld	(CLS_CurrDir+2),de
 451++A741 D1           	pop	de
 452++A742 C9           	ret
 453++A743
 454++A743              	endif
 455++A743
 456++A743              ;------------------------------------------------------------------------------
 457++A743              fatEraseEntry	ifused
 458++A743              ;㤠   ⥪饬 ⠫ (䠩/⮣ ⠫)
 459++A743              ;   fcb   ⠭: fcbName, fcbExt
 460++A743              ;:  ix -   fcb
 461++A743              ;: cy=1 訡 ⥭/
 462++A743              ;       a=errRWnum
 463++A743              ;       a=errInvalidPart
 464++A743              ;       a=errEoF - 䠩 ࢠ
 465++A743              ;       a=errFileEmpty - ⮩ ୥ ⠫
 466++A743              ;       a=errDirNotEmpty
 467++A743              ;     cy=0, nz - 䠩     
 468++A743              ;       a=errFileNotFound
 469++A743              ;     cy=0, z - 䠩/⠫ 㤠
 470++A743              ;
 471++A743              ;fatEraseEntry
 472++A743              ;
 473++A743              ;஢ઠ ⢮ 䠩/⠫
 474++A743 DD E5        	push	ix
 475++A745 E1           	pop	hl
 476++A746 CD 29 A8     	call	fatFindEntryDir
 477++A749 D8           	ret	c			;訡
 478++A74A 3E 48        	ld	a,errFileNotFound
 479++A74C C0           	ret	nz			;  ⠪  
 480++A74D C5           	push	bc			;   ⠫
 481++A74E EB           	ex	de,hl
 482++A74F CD D9 AC     	call	fcbSetFromEntry
 483++A752
 484++A752              ;᫨  ⠫, ஢ਬ ⮩   
 485++A752 DD CB 0B 66  	bit	4,(ix+fcbAttr)
 486++A756 28 1B        	jr	z,goto120		; 䠩
 487++A758              ;  ஢ਬ ⠫  稥 ᥩ
 488++A758 DD E5        	push	ix
 489++A75A E1           	pop	hl
 490++A75B 11 0C 00     	ld	de,fcbClsFile
 491++A75E 19           	add	hl,de
 492++A75F E5           	push	hl
 493++A760 CD 6A B3     	call	excngCLSCurrDir
 494++A763 CD CD A7     	call	fatTestEmptyDir
 495++A766 E1           	pop	hl
 496++A767 F5           	push	af
 497++A768 CD 6A B3     	call	excngCLSCurrDir
 498++A76B F1           	pop	af
 499++A76C C1           	pop	bc
 500++A76D D8           	ret	c
 501++A76E 3E 74        	ld	a,errDirNotEmpty
 502++A770 37           	scf
 503++A771 C0           	ret	nz
 504++A772 C5           	push	bc
 505++A773
 506++A773              ;㤠 
 507++A773              ;  ᢮ ⮩ 楯窨 ஢
 508++A773 CD 97 AD     goto120	call	LD_DEHL_fcbClsFile
 509++A776 CD 12 B0     	call	FreeClsChain
 510++A779 C1           	pop	bc			;   ⠫
 511++A77A D8           	ret	c			;訡 ⥭/
 512++A77B 18 FE        	jr	fatMarkDelEntry
 513++A77D              	org	$-2
 514++A77B
 515++A77B              	endif
 516++A77B
 517++A77B              ;------------------------------------------------------------------------------
 518++A77B              fatMarkDelEntry	ifused
 519++A77B              ;⪠  䠩  ⠫   ﬨ   㤠묨
 520++A77B              ;:  bc -    ⠫
 521++A77B              ;: cy=1 訡 ⥭/ -> a -  訡
 522++A77B              ;       =0 襭 ᯥ譮 -> a=#00
 523++A77B              ;     hl,de,bc - ???
 524++A77B              ;
 525++A77B              ;fatMarkDelEntry
 526++A77B              ;
 527++A77B CD 90 A7     loop046	call	fatGetEntryLong
 528++A77E D8           	ret	c
 529++A77F C5           	push	bc
 530++A780 D5           	push	de
 531++A781 36 E5        	ld	(hl),#E5
 532++A783 CD 54 B1     	call	SaveSecBuf2DIR
 533++A786 D1           	pop	de
 534++A787 C1           	pop	bc
 535++A788 D8           	ret	c
 536++A789 0B           	dec	bc
 537++A78A CB 1B        	rr	e
 538++A78C 38 ED        	jr	c,loop046
 539++A78E AF           	xor	a
 540++A78F C9           	ret
 541++A790
 542++A790              	endif
 543++A790
 544++A790              ;------------------------------------------------------------------------------
 545++A790              fatGetEntryLBA	ifused
 546++A790 ~            ;  ⥪饬 ⠫ ਯ   LBA 
 547++A790 ~            ;:  bc -    ⠫/   ᥪ
 548++A790 ~            ;     dehl - LBA  ᥪ  
 549++A790 ~            	;     a - ਡ ।饩  (᫨ )
 550++A790 ~            ;: bc  
 551++A790 ~            ;     cy=1 訡 ⥭/
 552++A790 ~            ;       a=errRWnum
 553++A790 ~            ;       a=errInvalidPart
 554++A790 ~            ;       a=errEoF - 䠩 ࢠ
 555++A790 ~            ;     cy=0  
 556++A790 ~            ;       hl    
 557++A790 ~            ;       a - attr   
 558++A790 ~            ;       7,d =0  䠩/⠫
 559++A790 ~            ;           =1    த⥫᪨ ⠫
 560++A790 ~            ;       7,e =0  䠩/⠫
 561++A790 ~            ;           =1    த⥫᪨ ⠫
 562++A790 ~            ;
 563++A790 ~            ;fatGetEntryLBA
 564++A790 ~            ;
 565++A790 ~            	push	bc
 566++A790 ~            ;	push	af
 567++A790 ~            	call	LoadSecDIR2Buf	;: hl=Buf4DIR
 568++A790 ~            ;	pop	bc
 569++A790 ~            ;	ld	e,b
 570++A790 ~            	pop	bc
 571++A790 ~            	jr	proc_16
 572++A790 ~            	jr	fatGetEntry
 573++A790 ~            	org	$-2
 574++A790 ~
 575++A790              	endif
 576++A790
 577++A790              ;------------------------------------------------------------------------------
 578++A790              fatGetEntryLong	ifused
 579++A790              ;  ⥪饬 ⠫ ਯ   
 580++A790              ;:  bc -    ⠫
 581++A790              ;: bc  
 582++A790              ;     cy=1 訡 ⥭/
 583++A790              ;       a=errRWnum
 584++A790              ;       a=errInvalidPart
 585++A790              ;       a=errEoF - 䠩 ࢠ
 586++A790              ;     cy=0  
 587++A790              ;       hl    
 588++A790              ;        a - attr   
 589++A790              ;        7,d =0  䠩/⠫
 590++A790              ;            =1    த⥫᪨ ⠫
 591++A790              ;        7,e =0  䠩/⠫
 592++A790              ;            =1    த⥫᪨ ⠫
 593++A790              ;        0,e =1   
 594++A790              ;
 595++A790              ;fatGetEntryLong
 596++A790              ;
 597++A790 78           	ld	a,b
 598++A791 B1           	or	c		; ⥪饩   ⠫ =#00?
 599++A792 5F           	ld	e,a
 600++A793 28 07        	jr	z,fatGetEntry	;।騩   ஢塞
 601++A795 0B           	dec	bc		;஢ਬ ।騩 
 602++A796 CD 9C A7     	call	fatGetEntry
 603++A799 03           	inc	bc
 604++A79A D8           	ret	c		;訡 ⥭
 605++A79B 5F           	ld	e,a		;ਡ ।饩 
 606++A79C
 607++A79C              	endif
 608++A79C
 609++A79C              ;------------------------------------------------------------------------------
 610++A79C              fatGetEntry	ifused
 611++A79C              ;  ⥪饬 ⠫ ਯ   
 612++A79C              ;:  bc -    ⠫
 613++A79C              ;      e - ਡ ।饩 
 614++A79C              ;: bc  
 615++A79C              ;     cy=1 訡 ⥭/
 616++A79C              ;       a=errRWnum
 617++A79C              ;       a=errInvalidPart
 618++A79C              ;       a=errEoF - 䠩 ࢠ
 619++A79C              ;     cy=0  
 620++A79C              ;       hl    
 621++A79C              ;       a - attr   
 622++A79C              ;       7,d =0  䠩/⠫
 623++A79C              ;           =1    த⥫᪨ ⠫
 624++A79C              ;       7,e =0  䠩/⠫
 625++A79C              ;           =1    த⥫᪨ ⠫
 626++A79C              ;       0,e =1   
 627++A79C              ;
 628++A79C              ;fatGetEntry
 629++A79C              ;
 630++A79C              ;proc_08
 631++A79C D5           	push	de
 632++A79D CD AD A8     	call	ReadSectorDIR	;⠥ ᥪ   ஬ 
 633++A7A0 D1           	pop	de		;hl=Buf4DIR
 634++A7A1 D8           proc_16	ret	c		;訡
 635++A7A2 7B           	ld	a,e		;稥/⢨  
 636++A7A3 08           	ex	af,af'
 637++A7A4 79           	ld	a,c
 638++A7A5 E6 0F        	and	#0F		;   ᥪ
 639++A7A7 5F           	ld	e,a
 640++A7A8 16 00        	ld	d,#00
 641++A7AA EB           	ex	de,hl
 642++A7AB 29           	add	hl,hl
 643++A7AC 29           	add	hl,hl
 644++A7AD 29           	add	hl,hl
 645++A7AE 29           	add	hl,hl
 646++A7AF 29           	add	hl,hl		;hl=hl*#20
 647++A7B0 19           	add	hl,de		;   
 648++A7B1 11 0B 00     	ld	de,#000B
 649++A7B4 7E           	ld	a,(hl)		;  
 650++A7B5 EB           	ex	de,hl
 651++A7B6 19           	add	hl,de
 652++A7B7 6E           	ld	l,(hl)		; ਡ⮢
 653++A7B8 67           	ld	h,a		;  
 654++A7B9 EB           	ex	de,hl
 655++A7BA CD 95 A8     	call	CP_TwoDot
 656++A7BD 16 00        	ld	d,#00
 657++A7BF 20 02        	jr	nz,goto119	;㤥 室  ⠫
 658++A7C1 16 80        	ld	d,#80		;㤥 室  த⥫᪨
 659++A7C3 08           goto119	ex	af,af'
 660++A7C4 FE 0F        	cp	#0F		;஢塞 ਡ ।饩 
 661++A7C6 37           	scf
 662++A7C7 3F           	ccf
 663++A7C8 7B           	ld	a,e		;ਡ ⥪饩 
 664++A7C9 5A           	ld	e,d		;ࠢ /।
 665++A7CA C0           	ret	nz
 666++A7CB 1C           	inc	e		;bit 0,e=1   
 667++A7CC C9           	ret
 668++A7CD
 669++A7CD              	endif
 670++A7CD
 671++A7CD              ;------------------------------------------------------------------------------
 672++A7CD              fatTestEmptyDir	ifused
 673++A7CD              ;஢ઠ ⥪飮 ⠫ ⮩  
 674++A7CD              ;:  (CLS_CurrDir) -  ࢮ  ⠫
 675++A7CD              ;: cy=1 訡 ⥭/
 676++A7CD              ;       a=errRWnum
 677++A7CD              ;       a=errInvalidPart
 678++A7CD              ;       a=errEoF - 䠩 ࢠ
 679++A7CD              ;     cy=0 ⠫ ஢७
 680++A7CD              ;       z -  ⮩ ⠫
 681++A7CD              ;       7,a =0/1 ⠫ ୥/
 682++A7CD              ;
 683++A7CD              ;fatTestEmptyDir
 684++A7CD              ;
 685++A7CD              ;⠥  ᥪ  ஢塞 稥 䨪஢ 
 686++A7CD 01 00 00     	ld	bc,#0000	;bc=#0000  ⥪饩   ⠫
 687++A7D0 CD AD A8     	call	ReadSectorDIR	;⥭ ᥪ ⠫     
 688++A7D3 D8           	ret	c		;訡
 689++A7D4 CD A1 A8     	call	CP_OneDot	;hl=Buf4DIR
 690++A7D7 28 05        	jr	z,goto116	; ࢠ  "."
 691++A7D9 7E           	ld	a,(hl)
 692++A7DA B7           	or	a
 693++A7DB C8           	ret	z		;⮩ ⠫ (   ⮫쪮 ୥)
 694++A7DC 3E 80        	ld	a,#80		; ୥ ⠫
 695++A7DE
 696++A7DE              ;ᥪ 㦥, 饬 ᮢ   
 697++A7DE F5           goto116	push	af		;⢮  ᥩ
 698++A7DF C5           loop045	push	bc		; 
 699++A7E0 0E 00        	ld	c,#00		;   ᥪ
 700++A7E2 11 0B 00     loop044	ld	de,#000B
 701++A7E5 19           	add	hl,de
 702++A7E6 7E           	ld	a,(hl)		;ਡ
 703++A7E7 ED 52        	sbc	hl,de
 704++A7E9 5E           	ld	e,(hl)		; ᨬ 
 705++A7EA FE 0F        	cp	#0F
 706++A7EC 28 15        	jr	z,goto117	;   
 707++A7EE FE 08        	cp	#08
 708++A7F0 28 11        	jr	z,goto117	;Volume ID
 709++A7F2 7B           	ld	a,e
 710++A7F3 B7           	or	a
 711++A7F4 28 28        	jr	z,goto118	; .  稫
 712++A7F6 FE E5        	cp	#E5
 713++A7F8 28 09        	jr	z,goto117	;㤠 
 714++A7FA              ;  ⨬  
 715++A7FA D1           	pop	de
 716++A7FB F1           	pop	af
 717++A7FC 3C           	inc	a
 718++A7FD F5           	push	af
 719++A7FE D5           	push	de
 720++A7FF FE 03        	cp	#03
 721++A801 30 1B        	jr	nc,goto118	;⠫  ⮩
 722++A803              ;  ᫥   ᥪ
 723++A803 11 20 00     goto117	ld	de,#0020
 724++A806 19           	add	hl,de
 725++A807 0C           	inc	c
 726++A808 79           	ld	a,c
 727++A809 FE 10        	cp	#10
 728++A80B 38 D5        	jr	c,loop044
 729++A80D
 730++A80D              ;  ᥪ  , 㧨 ᫥騩 ᥪ
 731++A80D E1           	pop	hl
 732++A80E 42           	ld	b,d
 733++A80F 09           	add	hl,bc
 734++A810 4D           	ld	c,l
 735++A811 44           	ld	b,h		; ࢮ   ᫥饬 ᥪ
 736++A812 CD AD A8     	call	ReadSectorDIR
 737++A815 30 C8        	jr	nc,loop045
 738++A817 FE 71        	cp	errEoF
 739++A819 28 04        	jr	z,goto184
 740++A81B
 741++A81B              ;訡 ⥭/  㣠
 742++A81B E1           	pop	hl
 743++A81C 37           	scf
 744++A81D C9           	ret
 745++A81E
 746++A81E              ;室. ⠫ ஢७
 747++A81E C1           goto118	pop	bc
 748++A81F F1           goto184	pop	af
 749++A820 FE 80        	cp	#80
 750++A822 C8           	ret	z
 751++A823 B7           	or	a
 752++A824 C8           	ret	z
 753++A825 F8           	ret	m
 754++A826 FE 02        	cp	#02
 755++A828 C9           	ret
 756++A829
 757++A829              	endif
 758++A829
 759++A829              ;------------------------------------------------------------------------------
 760++A829              SortFoundedEntries	ifused
 761++A829 ~            ;஢ ᯨ᪠  ਯ஢ (䠩/⠫)
 762++A829 ~            ;
 763++A829 ~            ;SortFoundedEntries
 764++A829 ~            ;
 765++A829 ~            /* ਠ
 766++A829 ~            	ld	hl,(DescInDIR)
 767++A829 ~            	ld	a,h
 768++A829 ~            	or	l
 769++A829 ~            	ret	z		;⮩ ⠫
 770++A829 ~            	dec	hl
 771++A829 ~            	ld	a,h
 772++A829 ~            	or	l
 773++A829 ~            	ret	z		;⮫쪮 1 
 774++A829 ~            	push	hl
 775++A829 ~            	exx
 776++A829 ~            	ld	hl,Buf4SortDesc
 777++A829 ~            	pop	bc
 778++A829 ~            	ld	e,#00
 779++A829 ~            	exx
 780++A829 ~            	call	proc_07		;஢ ᥩ ⠫  
 781++A829 ~            	exx
 782++A829 ~            	ld	e,#FF
 783++A829 ~            	exx
 784++A829 ~            	call	proc_07		;஢ ᥩ 䠩  
 785++A829 ~
 786++A829 ~            ;஢ १  ࠡ稩 
 787++A829 ~            	ld	hl,Buf4SortDesc
 788++A829 ~            	ld	de,Buf4Desc
 789++A829 ~            	ld	bc,#200
 790++A829 ~            	ldir
 791++A829 ~            	ret
 792++A829 ~            */
 793++A829 ~            	ld	hl,(DescInDIR)
 794++A829 ~            	ld	a,h
 795++A829 ~            	or	l
 796++A829 ~            	ret	z			;⮩ ⠫
 797++A829 ~            	ld	hl,Buf4Desc
 798++A829 ~            	ld	b,h
 799++A829 ~            	ld	c,l
 800++A829 ~            	ld	e,#80
 801++A829 ~            	call	proc_07			;஢ ᥩ ⠫  
 802++A829 ~            	ld	e,#00
 803++A829 ~            ;	call	proc_07			;஢ ᥩ 䠩  
 804++A829 ~            ;	ret
 805++A829 ~
 806++A829 ~
 807++A829 ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 808++A829 ~            /* ਠ
 809++A829 ~            ;஢ ᥩ  
 810++A829 ~            ;:  hl' -   楫 
 811++A829 ~            ;     bc' - ⢮ ᥩ
 812++A829 ~            ;      e' =#00/#FF ஢ ⮫쪮 ⠫/䠩
 813++A829 ~            ;: bc' - ⢮ ᥩ
 814++A829 ~            ;
 815++A829 ~            proc_07	ld	bc,Sym4Sort
 816++A829 ~            loop038	ld	hl,Buf4FirstSym
 817++A829 ~            	ld	de,Buf4Desc
 818++A829 ~            loop037	ld	a,(hl)
 819++A829 ~            	exx
 820++A829 ~            	xor	e
 821++A829 ~            	exx
 822++A829 ~            ;	and	#10
 823++A829 ~            	and	#80
 824++A829 ~            	jr	z,goto093	; ⠫/䠩
 825++A829 ~            	ld	a,(bc)
 826++A829 ~            	cp	#FF
 827++A829 ~            	jr	z,goto198		; 㪢
 828++A829 ~            	inc	hl
 829++A829 ~            	cp	(hl)
 830++A829 ~            	dec	hl
 831++A829 ~            	jr	nz,goto093
 832++A829 ~            goto198	ld	a,(de)
 833++A829 ~            	inc	de
 834++A829 ~            	exx
 835++A829 ~            	ld	(hl),a
 836++A829 ~            	inc	hl
 837++A829 ~            	exx
 838++A829 ~            	ld	a,(de)
 839++A829 ~            	inc	de
 840++A829 ~            	exx
 841++A829 ~            	ld	(hl),a
 842++A829 ~            	inc	hl
 843++A829 ~
 844++A829 ~            goto095	dec	bc
 845++A829 ~            	ld	a,b
 846++A829 ~            	or	c
 847++A829 ~            	exx
 848++A829 ~            	jr	z,goto094
 849++A829 ~            	inc	hl
 850++A829 ~            	inc	hl
 851++A829 ~            	jr	loop037
 852++A829 ~            ;᫥ 
 853++A829 ~            goto093	inc	de
 854++A829 ~            	inc	de
 855++A829 ~            	exx
 856++A829 ~            	jr	goto095
 857++A829 ~            ;᫥騩 ᨬ
 858++A829 ~            goto094	exx
 859++A829 ~            	ld	bc,(DescInDIR)
 860++A829 ~            	exx
 861++A829 ~            	inc	bc
 862++A829 ~            	ld	a,(bc)
 863++A829 ~            	or	a
 864++A829 ~            	jr	nz,loop038
 865++A829 ~
 866++A829 ~            	ret
 867++A829 ~            */
 868++A829 ~            ;஢ ᥩ  ⨯  
 869++A829 ~            ;:  hl -  ࢮ   -筨
 870++A829 ~            ;     bc -   楫 
 871++A829 ~            ;      e =#00/#80 ஢ ⮫쪮 䠩/⠫
 872++A829 ~            ;: hl -   ࢮ   -筨
 873++A829 ~            ;     bc - ।   楫 
 874++A829 ~            ;
 875++A829 ~            proc_07	exx
 876++A829 ~            	ld	bc,Sym4Sort
 877++A829 ~            	exx
 878++A829 ~            loop074	inc	hl
 879++A829 ~            	inc	(hl)
 880++A829 ~            	dec	(hl)
 881++A829 ~            	dec	hl
 882++A829 ~            	ret	z			; ⠫
 883++A829 ~            	push	hl
 884++A829 ~            loop073	ld	a,(hl)
 885++A829 ~            	inc	hl
 886++A829 ~            	xor	e
 887++A829 ~            	jp	m,goto199		; 㥬
 888++A829 ~            	ex	af,af'
 889++A829 ~            	exx
 890++A829 ~            	ld	a,(bc)
 891++A829 ~            	exx
 892++A829 ~            	cp	#FF
 893++A829 ~            	jr	z,goto200		; 㪢
 894++A829 ~            	cp	(hl)
 895++A829 ~            	jr	nz,goto199		;  㪢
 896++A829 ~            goto200	dec	hl			;+0
 897++A829 ~            	ex	de,hl
 898++A829 ~            	ex	(sp),hl
 899++A829 ~            ;    ( , 訩 )
 900++A829 ~            	ldi
 901++A829 ~            	inc	bc
 902++A829 ~            	ex	af,af'
 903++A829 ~            	ld	(bc),a
 904++A829 ~            	inc	bc
 905++A829 ~            ;  ன  (ࢠ 㪢)
 906++A829 ~            	ldi
 907++A829 ~            	inc	bc
 908++A829 ~            ;  ⨩  ( , 訩 )
 909++A829 ~            	ld	a,(de)
 910++A829 ~            	ldi
 911++A829 ~            	inc	bc
 912++A829 ~            	ld	(bc),a
 913++A829 ~            	inc	bc
 914++A829 ~            	ex	(sp),hl
 915++A829 ~            	ex	de,hl
 916++A829 ~            ;  ᫥ 
 917++A829 ~            	inc	hl
 918++A829 ~            	ld	a,(hl)
 919++A829 ~            	dec	hl
 920++A829 ~            	or	a			;=#00 ਧ  ᯨ᪠
 921++A829 ~            	jr	nz,loop073
 922++A829 ~
 923++A829 ~            ;᫥騩 ᨬ
 924++A829 ~            goto201	pop	hl
 925++A829 ~            	exx
 926++A829 ~            	inc	bc
 927++A829 ~            	ld	a,(bc)
 928++A829 ~            	exx
 929++A829 ~            	or	a
 930++A829 ~            	jr	nz,loop074
 931++A829 ~            	ret
 932++A829 ~
 933++A829 ~            ;᫥ ,  ᮢ 㪢
 934++A829 ~            goto199	inc	hl
 935++A829 ~            	inc	hl			;+3
 936++A829 ~            	inc	hl			;+1 next
 937++A829 ~            	ld	a,(hl)
 938++A829 ~            	dec	hl			;+0 next
 939++A829 ~            	or	a			;=#00 ਧ  ᯨ᪠
 940++A829 ~            	jr	nz,loop073
 941++A829 ~            	jr	goto201
 942++A829 ~
 943++A829              	endif
 944++A829
 945++A829              ;------------------------------------------------------------------------------
 946++A829              GetNumOfEntries	ifused
 947++A829 ~            ; ⢠ ⨬ ( 256) ᥩ  ⥪饬 ⠫
 948++A829 ~            ;:  (Ext4Found) -  ᯨ᪠ ७
 949++A829 ~            ;: cy=1 訡 ⥭
 950++A829 ~            ;     (DescInDIR),hl - ⢮  ᥩ
 951++A829 ~            ;
 952++A829 ~            ;GetNumOfEntries
 953++A829 ~            ;
 954++A829 ~            /* ਠ
 955++A829 ~            	ld	hl,#0000		;  ᯨ᪥ ⮡ࠦ ᥩ
 956++A829 ~            	ld	(DescInDIR),hl		;⢮  ᥩ
 957++A829 ~            	ld	bc,#FFFF		;稪 ᥩ
 958++A829 ~            	push	hl
 959++A829 ~            loop035	inc	bc
 960++A829 ~            	call	ReadSectorDIR		;⠥ ᥪ   ஬ 
 961++A829 ~            	jr	c,goto090
 962++A829 ~            	ex	de,hl			;de = Buf4DIR
 963++A829 ~            	ld	l,c			;   ⠫
 964++A829 ~            	add	hl,hl
 965++A829 ~            	add	hl,hl
 966++A829 ~            	add	hl,hl
 967++A829 ~            	add	hl,hl
 968++A829 ~            	ld	h,#00
 969++A829 ~            	add	hl,hl			;ᬥ饭  ᥪ
 970++A829 ~            	add	hl,de			; ਯ
 971++A829 ~            	ld	a,(hl)
 972++A829 ~            	or	a
 973++A829 ~            	jr	z,goto091		; ⠫
 974++A829 ~            	call	CP_OneDot
 975++A829 ~            	jr	z,loop035		;: .
 976++A829 ~            	ld	a,(hl)
 977++A829 ~            	cp	#E5
 978++A829 ~            	jr	z,loop035		;㤠 
 979++A829 ~            	ex	af,af'			; ᨬ 
 980++A829 ~            	ld	de,#000B
 981++A829 ~            	add	hl,de
 982++A829 ~            	ld	a,(hl)			;ਡ
 983++A829 ~            	cp	#0F
 984++A829 ~            	jr	z,loop035		;  
 985++A829 ~            	bit	3,a
 986++A829 ~            	jr	nz,loop035		;⪠ ⮬
 987++A829 ~            	and	#10
 988++A829 ~            	jr	nz,goto092		; ⠫
 989++A829 ~
 990++A829 ~            ;ࠢ ७  ᯨ᪮
 991++A829 ~            	ld	de,(Ext4Found)
 992++A829 ~            	ld	a,(de)
 993++A829 ~            	or	a
 994++A829 ~            	jr	z,goto092		;⮡ࠦ 
 995++A829 ~            loop036	ld	a,(de)
 996++A829 ~            	or	a
 997++A829 ~            	jr	z,loop035		; ᯨ᪠.  ⠪ ७  ⮡ࠦ
 998++A829 ~            	push	de
 999++A829 ~            	push	hl
1000++A829 ~            	dec	hl
1001++A829 ~            	dec	hl
1002++A829 ~            	dec	hl
1003++A829 ~            	call	cmp_adrDE_adrHL_3b	 ;ࠢ  ७
1004++A829 ~            	pop	hl
1005++A829 ~            	pop	de
1006++A829 ~            	inc	de
1007++A829 ~            	inc	de
1008++A829 ~            	inc	de
1009++A829 ~            	jr	nz,loop036
1010++A829 ~
1011++A829 ~            ; ⮡ࠦ
1012++A829 ~            goto092	ld	a,(hl)			;ਡ
1013++A829 ~            	pop	de			;  ᯨ᪥ ⮡ࠦ ᥩ
1014++A829 ~            	ld	hl,Buf4Desc		;ᯨ᮪  ஢
1015++A829 ~            	add	hl,de
1016++A829 ~            	add	hl,de
1017++A829 ~            	ld	(hl),c
1018++A829 ~            	inc	hl
1019++A829 ~            	ld	(hl),b			; 
1020++A829 ~            	ld	hl,Buf4FirstSym		;ᯨ᮪  㪢  ਡ⮢
1021++A829 ~            	add	hl,de
1022++A829 ~            	add	hl,de
1023++A829 ~            	ld	(hl),a
1024++A829 ~            	inc	hl
1025++A829 ~            	ex	af,af'			;	 ᨬ 
1026++A829 ~            	ld	(hl),a
1027++A829 ~            	inc	de			;+1  
1028++A829 ~            	push	de
1029++A829 ~            	ld	a,d
1030++A829 ~            ;	cp	#01
1031++A829 ~            ;	jr	c,loop035		;  256 ᥩ
1032++A829 ~            	or	a
1033++A829 ~            	jr	z,loop035		;  256 ᥩ
1034++A829 ~
1035++A829 ~            ; ᪠
1036++A829 ~            goto091	ld	a,errEoF
1037++A829 ~            goto090	pop	hl
1038++A829 ~            	ld	(DescInDIR),hl
1039++A829 ~            	cp	errEoF
1040++A829 ~            	ret	z
1041++A829 ~            	scf
1042++A829 ~            	ret
1043++A829 ~            */
1044++A829 ~            ;⠥  ᥪ  ஢塞 稥 䨪஢ 
1045++A829 ~            	ld	bc,#0000		; ࢮ   ⠫
1046++A829 ~            	call	ReadSectorDIR		;⥭ ᥪ ⠫     
1047++A829 ~            	exx
1048++A829 ~            	ld	hl,#0000		;⢮  ᥩ
1049++A829 ~            	exx
1050++A829 ~            	ld	de,Buf4Desc
1051++A829 ~            	jr	c,goto197		;訡 ⥭
1052++A829 ~            	call	CP_OneDot		;hl=Buf4DIR
1053++A829 ~            	scf
1054++A829 ~            	jr	z,loop072		;cy=1,  ࢠ  "."
1055++A829 ~            	or	a
1056++A829 ~
1057++A829 ~            ;ᥪ 㦥, 饬 ᮢ   
1058++A829 ~            loop072	call	findEntryInSector
1059++A829 ~            	ld	a,errEoF
1060++A829 ~            	jr	c,goto197		; ᨬ ᥩ/ ⠫ 稫
1061++A829 ~
1062++A829 ~            ;㧨 ᫥騩 ᥪ
1063++A829 ~            ;bc -  ࢮ   ᫥饬 ᥪ
1064++A829 ~            	exx
1065++A829 ~            	push	hl
1066++A829 ~            	exx
1067++A829 ~            	push	de
1068++A829 ~            	call	ReadSectorDIR
1069++A829 ~            	pop	de
1070++A829 ~            	exx
1071++A829 ~            	pop	hl
1072++A829 ~            	exx
1073++A829 ~            	jr	nc,loop072
1074++A829 ~
1075++A829 ~            ;訡 ⥭/  㣠, ⠫ 稫
1076++A829 ~            ;a=errEoF ⠫ 稫
1077++A829 ~            ;a -  訡
1078++A829 ~            goto197	inc	de
1079++A829 ~            	ex	de,hl
1080++A829 ~            	ld	(hl),#00
1081++A829 ~            	exx
1082++A829 ~            	ld	(DescInDIR),hl		;⢮  ᥩ
1083++A829 ~            	cp	errEoF
1084++A829 ~            	ret	z			;nc
1085++A829 ~            	scf
1086++A829 ~            	ret
1087++A829 ~
1088++A829 ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1089++A829 ~            ;   㦥 ᥪ
1090++A829 ~            ;:  hl' - ⢮  ᥩ
1091++A829 ~            ;     hl = Buf4DIR (  ᥪ஬)
1092++A829 ~            ;     de = Buf4Desc+n (।   )
1093++A829 ~            ;     bc -    ⠫ (ࢠ   ᥪ)
1094++A829 ~            ;     cy=1 ய   ( 뫪  ᥡ ( 窠))
1095++A829 ~            ;     (Ext4Found) -  ᯨ᪠ ७
1096++A829 ~            ;: hl' - ⢮  ᥩ
1097++A829 ~            ;     de = Buf4Desc+n (।   )
1098++A829 ~            ;     bc -  ।   ⠫
1099++A829 ~            ;     hl,a,a' - ???
1100++A829 ~            ;     cy=1 -  ᨬ ᥩ/ ⠫ 稫
1101++A829 ~            ;
1102++A829 ~            findEntryInSector
1103++A829 ~            ;
1104++A829 ~            ;ᥪ 㦥, 饬 ⨬ 
1105++A829 ~            	push	de
1106++A829 ~            	jr	c,goto193		;ய ࢮ 
1107++A829 ~            loop070	ld	a,(hl)
1108++A829 ~            	or	a
1109++A829 ~            	jr	z,goto194		; .  ⠫
1110++A829 ~            	cp	#E5
1111++A829 ~            	jr	z,goto193		;㤠 
1112++A829 ~            	ex	af,af'			; ᨬ 
1113++A829 ~            	ld	de,#000B
1114++A829 ~            	add	hl,de
1115++A829 ~            	ld	a,(hl)			;ਡ
1116++A829 ~            	sbc	hl,de
1117++A829 ~            	cp	#0F
1118++A829 ~            	jr	z,goto193		;  
1119++A829 ~            	bit	3,a
1120++A829 ~            	jr	nz,goto193		;⪠ ⮬
1121++A829 ~            	set	7,b			;ਧ ⠫
1122++A829 ~            	and	#10
1123++A829 ~            	jr	nz,goto195		; ⠫, ⮡ࠦ ᥣ
1124++A829 ~            	res	7,b			;ਧ 䠩
1125++A829 ~
1126++A829 ~            ;ࠢ ७  ᯨ᪮
1127++A829 ~            	ld	de,(Ext4Found)
1128++A829 ~            	ld	a,(de)
1129++A829 ~            	or	a
1130++A829 ~            	jr	z,goto195		;⮡ࠦ 
1131++A829 ~            	push	bc
1132++A829 ~            	ld	bc,#0008
1133++A829 ~            loop071	ld	a,(de)
1134++A829 ~            	or	a
1135++A829 ~            	jr	z,goto196		; ᯨ᪠.  ⠪ ७  ⮡ࠦ
1136++A829 ~            	push	de
1137++A829 ~            	push	hl
1138++A829 ~            	add	hl,bc
1139++A829 ~            	call	cmp_adrDE_adrHL_3b 	;ࠢ  ७
1140++A829 ~            	pop	hl
1141++A829 ~            	pop	de
1142++A829 ~            	inc	de
1143++A829 ~            	inc	de
1144++A829 ~            	inc	de
1145++A829 ~            	jr	nz,loop071
1146++A829 ~            	pop	bc
1147++A829 ~
1148++A829 ~            ; ⮡ࠦ
1149++A829 ~            goto195	ex	(sp),hl
1150++A829 ~            	ld	(hl),b			;  (訩 )
1151++A829 ~            	res	7,b
1152++A829 ~            	inc	hl
1153++A829 ~            	ex	af,af'
1154++A829 ~            	ld	(hl),a			;  (ࢠ 㪢)
1155++A829 ~            	inc	hl
1156++A829 ~            	ld	(hl),c			;  (訩 )
1157++A829 ~            	inc	hl
1158++A829 ~            /*
1159++A829 ~            	inc	h
1160++A829 ~            	inc	h
1161++A829 ~            	ld	(hl),b
1162++A829 ~            	inc	hl
1163++A829 ~            	ex	af,af'
1164++A829 ~            	ld	(hl),a
1165++A829 ~            	dec	hl
1166++A829 ~            	dec	h
1167++A829 ~            	dec	h
1168++A829 ~            	res	7,b
1169++A829 ~            	ld	(hl),c			;  (訩 )
1170++A829 ~            	inc	hl
1171++A829 ~            	ld	(hl),b			;  (訩 )
1172++A829 ~            	inc	hl
1173++A829 ~            */
1174++A829 ~            	ex	(sp),hl
1175++A829 ~            	exx
1176++A829 ~            	inc	hl			;+1  
1177++A829 ~            	ld	a,h
1178++A829 ~            	exx
1179++A829 ~            	dec	a
1180++A829 ~            	jr	z,goto194		; ᨬ ᥩ
1181++A829 ~
1182++A829 ~            ;᫥   ᥪ
1183++A829 ~            	push	bc
1184++A829 ~            goto196	pop	bc
1185++A829 ~            goto193	inc	bc
1186++A829 ~            	bit	7,b
1187++A829 ~            	jr	nz,goto194		; ᪠  , ९
1188++A829 ~            	ld	de,#0020
1189++A829 ~            	add	hl,de
1190++A829 ~            	ld	de,Buf4DIR+#200
1191++A829 ~            	sbc	hl,de
1192++A829 ~            	add	hl,de
1193++A829 ~            	jr	nz,loop070
1194++A829 ~
1195++A829 ~            ;ᥪ 稫
1196++A829 ~            	pop	de
1197++A829 ~            	xor	a
1198++A829 ~            	ret
1199++A829 ~
1200++A829 ~            ; ᨬ ᥩ/ ⠫ 稫
1201++A829 ~            goto194	pop	de
1202++A829 ~            	scf
1203++A829 ~            	ret
1204++A829 ~
1205++A829              	endif
1206++A829
1207++A829              ;------------------------------------------------------------------------------
1208++A829              fatCreateDIR	ifused
1209++A829 ~            ;ᮧ ⠫  ⥪饬 FAT32 ⠫
1210++A829 ~            ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType=1
1211++A829 ~            ;  fcbSize=#00000000
1212++A829 ~            ;:  ix -   fcb
1213++A829 ~            ;: cy=1 뫨 訡
1214++A829 ~            ;       a=errRWnum
1215++A829 ~            ;       a=errInvalidPart
1216++A829 ~            ;       a=errEoF - 䠩 ࢠ
1217++A829 ~            ;       a=errFileEmpty - ⮩ ୥ ⠫
1218++A829 ~            ;       a=errFileExist
1219++A829 ~            ;       a=errDiskNoSpace
1220++A829 ~            ;       a=errNumTooBig - ᫨誮 让 ࠧ
1221++A829 ~            ;     cy=0  ᥭ  ⫮
1222++A829 ~            ;
1223++A829 ~            ;fatCreateDIR
1224++A829 ~            ;
1225++A829 ~            	ld	hl,#0000
1226++A829 ~            	jr	fatCreateDIRlfn
1227++A829 ~            	org	$-2
1228++A829              	endif
1229++A829
1230++A829
1231++A829              fatCreateDIRlfn		ifused
1232++A829 ~            ;ᮧ ⠫     ⥪饬 FAT32 ⠫
1233++A829 ~            ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType=1
1234++A829 ~            ;:  ix -   fcb
1235++A829 ~            ;     hl -  ப     ଠ ASCIIZ
1236++A829 ~            ;       =#0000 ᯮ짮 ⪮   fcb
1237++A829 ~            ;
1238++A829 ~            ;fatCreateDIRlfn
1239++A829 ~            ;
1240++A829 ~            ;fcbSize=#00000000
1241++A829 ~            	push	hl
1242++A829 ~            	call	SetZeroDEHL
1243++A829 ~            	call	DEHL2fcbSize
1244++A829 ~            	pop	hl
1245++A829 ~
1246++A829 ~            ;ᮧ  ⠫   
1247++A829 ~            	call	fatCreateFileLFN
1248++A829 ~            	ret	c
1249++A829 ~
1250++A829 ~            ;⨬  ⠫
1251++A829 ~            	call	LD_DEHL_fcbClsFile
1252++A829 ~            	push	ix
1253++A829 ~            	ld	ix,Buf4MBR
1254++A829 ~            	call	fatClearCls
1255++A829 ~            	pop	ix
1256++A829 ~            	ret	c
1257++A829 ~
1258++A829 ~            ;ᮧ  ⮬ ⠫   뫪  ᥡ
1259++A829 ~            ;  ᪮㥬 fcb  ६ 
1260++A829 ~            	push	ix
1261++A829 ~            	pop	hl
1262++A829 ~            	ld	de,tmp_fcb
1263++A829 ~            	push	de
1264++A829 ~            	ld	bc,#0020
1265++A829 ~            	ldir
1266++A829 ~            	ex	(sp),ix
1267++A829 ~            ;  ⠭  
1268++A829 ~            	ld	hl,tmp_fcb
1269++A829 ~            	ld	(hl),"."
1270++A829 ~            	ld	b,#0B-1
1271++A829 ~            loop029	inc	hl
1272++A829 ~            	ld	(hl),#20
1273++A829 ~            	djnz	loop029
1274++A829 ~            ;  뫪  ᥡ
1275++A829 ~            	call	fcbClsFile2fcbClsDIR
1276++A829 ~            	call	addFileEntry
1277++A829 ~            	jr	c,goto049
1278++A829 ~
1279++A829 ~            ;ᮧ  ⮬ ⠫   뫪  த⥫
1280++A829 ~            	ld	(ix+fcbName+1),"."
1281++A829 ~            	pop	hl
1282++A829 ~            	push	hl		; fcb
1283++A829 ~            	ld	bc,fcbClsDIR
1284++A829 ~            	add	hl,bc		; fcbClsDIR
1285++A829 ~            	ld	de,RootClaster
1286++A829 ~            	call	cmp_adrDE_adrHL
1287++A829 ~            	ld	de,tmp_fcb+fcbClsFile
1288++A829 ~            	call	nz,CopyDWORD_HL_DE
1289++A829 ~            	call	SetZeroDEHL
1290++A829 ~            	call	z,DEHL2fcbClsFile
1291++A829 ~            	call	addFileEntry
1292++A829 ~            goto049	pop	ix
1293++A829 ~            	ret
1294++A829 ~
1295++A829              	endif
1296++A829
1297++A829              ;------------------------------------------------------------------------------
1298++A829              fatFindEntryDir	ifused
1299++A829              ;   ⥪饬 ⠫    ଠ name[.][ext]\
1300++A829              ;     ஢७  ॢ  孨 ॣ
1301++A829              ;:  hl -    ଠ name[.][ext]\ (  ଠ 8+3)
1302++A829              ;: cy=1 訡 ⥭/
1303++A829              ;       a=errRWnum
1304++A829              ;       a=errInvalidPart
1305++A829              ;       a=errEoF - 䠩 ࢠ
1306++A829              ;       a=errFileEmpty - ⮩ ୥ ⠫
1307++A829              ;       hl -  ᫥饣   
1308++A829              ;       bc -    ⠫  ன ࢠ 
1309++A829              ;     nc, z  
1310++A829              ;       hl -  ᫥饣    (㪠뢠  "\")
1311++A829              ;       de -  ਯ  
1312++A829              ;       bc -  ஢塞   ⠫
1313++A829              ;       (DescInCurrDir) -  ᫥   ⠫
1314++A829              ;     nc, nz   
1315++A829              ;       hl -  ᫥饣   
1316++A829              ;       bc -  ᫥   ⠫
1317++A829              ;       (DescInCurrDir) -  ᫥   ⠫
1318++A829              ;
1319++A829              ;fatFindEntryDir
1320++A829              ;
1321++A829              ;ନ㥬  䠩  ᪠  ⠫
1322++A829 11 AD 8D     	ld	de,Name4Find
1323++A82C CD 30 B2     	call	FileNameTo8dot3	;hl -  ᫥饣   
1324++A82F
1325++A82F              ;⠥  ᥪ  ஢塞 稥 䨪஢ 
1326++A82F E5           	push	hl
1327++A830 48           	ld	c,b		;bc=#0000  ⥪饩   ⠫
1328++A831 CD AD A8     	call	ReadSectorDIR	;⥭ ᥪ ⠫     
1329++A834 38 53        	jr	c,goto065	;訡
1330++A836 CD A1 A8     	call	CP_OneDot	;hl=Buf4DIR
1331++A839 28 04        	jr	z,loop028	; ࢠ  "."
1332++A83B 7E           	ld	a,(hl)
1333++A83C B7           	or	a
1334++A83D              ;	ld	a,errFileEmpty	;⮩ ⠫ (   ⮫쪮 ୥)
1335++A83D              ;	jr	z,goto065
1336++A83D 28 4E        	jr	z,goto129
1337++A83F
1338++A83F
1339++A83F              ;ᥪ 㦥, 饬 ᮢ   
1340++A83F C5           loop028	push	bc		; 
1341++A840 0E 00        	ld	c,#00		;   ᥪ
1342++A842 11 0B 00     loop027	ld	de,#000B
1343++A845 19           	add	hl,de
1344++A846 7E           	ld	a,(hl)		;ਡ
1345++A847 ED 52        	sbc	hl,de
1346++A849 5E           	ld	e,(hl)		; ᨬ 
1347++A84A FE 0F        	cp	#0F
1348++A84C 28 23        	jr	z,goto066	;   
1349++A84E FE 08        	cp	#08
1350++A850 28 1F        	jr	z,goto066	;Volume ID
1351++A852 7B           	ld	a,e
1352++A853 B7           	or	a
1353++A854 28 36        	jr	z,goto067	; .  稫
1354++A856 FE E5        	cp	#E5
1355++A858 28 17        	jr	z,goto066	;㤠 
1356++A85A              ;  ࠢ     Name4Find
1357++A85A              ;  hl -  ਯ  
1358++A85A 11 AD 8D     	ld	de,Name4Find
1359++A85D 06 0B        	ld	b,#0B
1360++A85F E5           	push	hl
1361++A860 1A           loop026	ld	a,(de)		;ॢ  孨 ॣ
1362++A861 BE           	cp	(hl)
1363++A862 20 0C        	jr	nz,goto068
1364++A864 13           	inc	de
1365++A865 23           	inc	hl
1366++A866 10 F8        	djnz	loop026
1367++A868              ;   
1368++A868 D1           	pop	de		; ਯ  
1369++A869 E1           	pop	hl		; ஢塞   ⠫
1370++A86A 09           	add	hl,bc		;+   ᥪ
1371++A86B 4D           	ld	c,l
1372++A86C 44           	ld	b,h		;    ⠫
1373++A86D AF           	xor	a		;nc z
1374++A86E 18 1F        	jr	goto183
1375++A870              ;  ᫥   ᥪ
1376++A870 E1           goto068	pop	hl
1377++A871 11 20 00     goto066	ld	de,#0020
1378++A874 19           	add	hl,de
1379++A875 0C           	inc	c
1380++A876 79           	ld	a,c
1381++A877 FE 10        	cp	#10
1382++A879 38 C7        	jr	c,loop027
1383++A87B
1384++A87B
1385++A87B              ;  ᥪ  , 㧨 ᫥騩 ᥪ
1386++A87B E1           	pop	hl
1387++A87C 42           	ld	b,d
1388++A87D 09           	add	hl,bc
1389++A87E 4D           	ld	c,l
1390++A87F 44           	ld	b,h		; ࢮ   ᫥饬 ᥪ
1391++A880 CD AD A8     	call	ReadSectorDIR
1392++A883 30 BA        	jr	nc,loop028
1393++A885 FE 71        	cp	errEoF
1394++A887 28 04        	jr	z,goto129
1395++A889
1396++A889
1397++A889              ;訡 ⥭/  㣠
1398++A889 E1           goto065	pop	hl
1399++A88A 37           	scf
1400++A88B C9           	ret
1401++A88C
1402++A88C
1403++A88C              ;nc, nz   
1404++A88C C1           goto067	pop	bc
1405++A88D AF           goto129	xor	a
1406++A88E 3C           	inc	a		;nc, nz
1407++A88F E1           goto183	pop	hl
1408++A890 ED 43 8C 8D  	ld	(DescInCurrDir),bc
1409++A894 C9           	ret
1410++A895
1411++A895              	endif
1412++A895
1413++A895              ;------------------------------------------------------------------------------
1414++A895              CP_TwoDot	ifused
1415++A895              ;஢ઠ  䠩   窨 (뫪  த⥫)
1416++A895              ;:  hl -  砫  䠩
1417++A895              ;: nz -  ᮢ
1418++A895              ;      z -    -> a=#00, nc
1419++A895              ;
1420++A895              ;CP_TwoDot
1421++A895              ;
1422++A895 7E           	ld	a,(hl)
1423++A896 FE 2E        	cp	"."
1424++A898 C0           	ret	nz
1425++A899 23           	inc	hl
1426++A89A 7E           	ld	a,(hl)
1427++A89B 2B           	dec	hl
1428++A89C FE 2E        	cp	"."
1429++A89E C0           	ret	nz
1430++A89F AF           	xor	a
1431++A8A0 C9           	ret
1432++A8A1
1433++A8A1              	endif
1434++A8A1
1435++A8A1              ;------------------------------------------------------------------------------
1436++A8A1              CP_OneDot	ifused
1437++A8A1              ;஢ઠ  䠩   窠 (뫪  ᥡ)
1438++A8A1              ;:  hl -  砫  䠩
1439++A8A1              ;: nz -  ᮢ
1440++A8A1              ;      z -  ࢠ  -> a=#00, nc
1441++A8A1              ;
1442++A8A1              ;CP_OneDot
1443++A8A1              ;
1444++A8A1 7E           	ld	a,(hl)
1445++A8A2 FE 2E        	cp	"."
1446++A8A4 C0           	ret	nz
1447++A8A5 23           	inc	hl
1448++A8A6 7E           	ld	a,(hl)
1449++A8A7 2B           	dec	hl
1450++A8A8 FE 20        	cp	" "
1451++A8AA C0           	ret	nz
1452++A8AB AF           	xor	a
1453++A8AC C9           	ret
1454++A8AD
1455++A8AD              	endif
1456++A8AD
1457++A8AD              ;------------------------------------------------------------------------------
1458++A8AD              ReadSectorDIR	ifused
1459++A8AD              ;⥭ ᥪ ⠫     
1460++A8AD              ;:  bc -    ⠫
1461++A8AD              ;: cy=1 訡 ⥭/
1462++A8AD              ;       a=errRWnum
1463++A8AD              ;       a=errInvalidPart
1464++A8AD              ;       a=errEoF - 䠩 ࢠ
1465++A8AD              ;     cy=0 ᥪ ⠭
1466++A8AD              ;       hl=Buf4DIR
1467++A8AD              ;     bc  
1468++A8AD              ;     hl',de',bc' - ???
1469++A8AD              ;
1470++A8AD              ;ReadSectorDIR
1471++A8AD              ;
1472++A8AD C5           	push	bc
1473++A8AE 60           	ld	h,b
1474++A8AF 69           	ld	l,c
1475++A8B0 11 00 00     	ld	de,#0000
1476++A8B3 3E 10        	ld	a,#10
1477++A8B5 CD 2F B4     	call	SRL_dehl_A	;dehl=dehl/32
1478++A8B8 7D           	ld	a,l		;ᬥ饭  ᥪ  砫 ⠫
1479++A8B9 F5           	push	af
1480++A8BA 3A 76 8D     	ld	a,(LenCLSInSec)	;ࠧ   ᥪ
1481++A8BD F5           	push	af
1482++A8BE CD 2F B4     	call	SRL_dehl_A	;hl ᬥ饭    砫 ⠫
1483++A8C1 4D           	ld	c,l
1484++A8C2 44           	ld	b,h
1485++A8C3 ED 5B 86 8D  	ld	de,(CLS_CurrDir+2)
1486++A8C7 2A 84 8D     	ld	hl,(CLS_CurrDir);dehl  ࢮ  ⠫
1487++A8CA CD 3B AC     	call	FindCLSinFile	;    ᬥ饭  砫 䠩/⠫
1488++A8CD 38 02        	jr	c,goto059	;訡
1489++A8CF 20 04        	jr	nz,goto058	; 
1490++A8D1 C1           goto059	pop	bc		;室  訡
1491++A8D2 C1           	pop	bc
1492++A8D3 C1           	pop	bc
1493++A8D4 C9           	ret
1494++A8D5
1495++A8D5              ;  ᥪ  㧪  
1496++A8D5 CD 60 AF     goto058	call	GetAdrRealSector
1497++A8D8 F1           	pop	af		;dehl -  ᥪ
1498++A8D9              				;a - ࠧ   ᥪ
1499++A8D9 3D           	dec	a
1500++A8DA 4F           	ld	c,a
1501++A8DB F1           	pop	af		;ᬥ饭  ᥪ  砫 ⠫
1502++A8DC A1           	and	c
1503++A8DD 4F           	ld	c,a
1504++A8DE 06 00        	ld	b,#00		;ᬥ饭  
1505++A8E0 09           	add	hl,bc
1506++A8E1 EB           	ex	de,hl
1507++A8E2 48           	ld	c,b
1508++A8E3 ED 4A        	adc	hl,bc
1509++A8E5 EB           	ex	de,hl		;dehl -  ᥪ  ਯ஬ 䠩
1510++A8E6 CD 67 B1     	call	LoadSecDIR2Buf
1511++A8E9 C1           	pop	bc
1512++A8EA C9           	ret
1513++A8EB
1514++A8EB              	endif
1515++A8EB
1516++A8EB              ;------------------------------------------------------------------------------
1517++A8EB              fatSetTmpDir	ifused
1518++A8EB ~            ;⠭ ६ ⥪饩 ४ਨ
1519++A8EB ~            ;:  hl -  砫 ਯ
1520++A8EB ~            ;: hl,bc,a - ???
1521++A8EB ~            ;
1522++A8EB ~            ;fatSetTmpDir
1523++A8EB ~            ;
1524++A8EB ~            	push	de
1525++A8EB ~            	ld	de,#0014
1526++A8EB ~            	add	hl,de
1527++A8EB ~            	ld	c,(hl)
1528++A8EB ~            	inc	hl
1529++A8EB ~            	ld	b,(hl)		;  (襥 ᫮)
1530++A8EB ~            	ld	e,#05
1531++A8EB ~            	add	hl,de
1532++A8EB ~            	ld	e,(hl)
1533++A8EB ~            	inc	hl
1534++A8EB ~            	ld	d,(hl)		;  (襥 ᫮)
1535++A8EB ~            	ld	a,b
1536++A8EB ~            	or	c
1537++A8EB ~            	or	d
1538++A8EB ~            	or	e
1539++A8EB ~            	jr	nz,goto056
1540++A8EB ~            	ld	de,(RootClaster);訡   . 室  ७
1541++A8EB ~            	ld	bc,(RootClaster+2)
1542++A8EB ~            goto056	ld	(CLS_CurrDir),de
1543++A8EB ~            	ld	(CLS_CurrDir+2),bc
1544++A8EB ~            	pop	de
1545++A8EB ~            	ret
1546++A8EB ~
1547++A8EB              	endif
1548++A8EB
1549++A8EB              ;==============================================================================
1550++A8EB
# file closed: Drivers/DrvFAT/DrvFAT.dir.a80
 132+ A8EB              	INCLUDE	"DrvFAT.file.a80"
# file opened: Drivers/DrvFAT/DrvFAT.file.a80
   1++A8EB              ;楤  FAT Driver.   䠩  ⠫
   2++A8EB              ;䠩 DrvFAT.file.a80
   3++A8EB              ;
   4++A8EB              ;addBytesToFile		㢥祭 ࠧ 䠩   ⢮ 
   5++A8EB              ;fatCreateFile		ᮧ 䠩  ⥪饬 FAT32 ࠧ
   6++A8EB              ;fatCreateFileLFN	ᮧ 䠩     ⥪饬 FAT32 ࠧ
   7++A8EB              ;fatAddFileEntry	  ⠫   /⪨  䠩
   8++A8EB              ;addFileEntrysLFN	  ⠫ ᥩ    䠩
   9++A8EB              ;addFileEntry		  ⠫ 䠩
  10++A8EB              ;findFreeDirEntry	 ⮩   ⠫
  11++A8EB              ;newFileFreeSpace	ᮧ 楯窨 ஢   ⢮ 
  12++A8EB              ;addFileFreeSpace	  ⢠   楯窥 ஢
  13++A8EB              ;fatAddFreeSpace_var	  楯 ஢  ⢠
  14++A8EB              ;			஢
  15++A8EB              ;fatAddFreeSpace_dehl	  楯 ஢  ⢠
  16++A8EB              ;			஢
  17++A8EB              ;WriteSectorHDD		 ᥪ  
  18++A8EB              ;ReadSectorHDD		⥭ ᥪ  
  19++A8EB              ;CalcAdrSecInMountFile	 LBA  ᥪ    ਬ஢ 䠩 (.trd)
  20++A8EB              ;CalcAdrSecInFile	 LBA  ᥪ 䠩  
  21++A8EB              ;FindCLSinFile		    ᬥ饭  砫 䠩/⠫
  22++A8EB              ;
  23++A8EB              ;------------------------------------------------------------------------------
  24++A8EB              addBytesToFile	ifused
  25++A8EB              ;㢥祭 ࠧ 䠩   ⢮ 
  26++A8EB              ;:  ix -   fcb
  27++A8EB              ;     dehl - 稭  ,    㢥 ࠧ 䠩
  28++A8EB              ;: cy=1 訡
  29++A8EB              ;        a=errNumTooBig - ᫨誮 让 ࠧ,  #FFFF ஢
  30++A8EB              ;        a=errRWnum -  訡
  31++A8EB              ;        a=errFileEmpty - 㫥 ࠧ 䠩
  32++A8EB              ;        a=errDiskNoSpace
  33++A8EB              ;        a=errInvalidPart
  34++A8EB              ;        a=errEoF - 䠩 ࢠ
  35++A8EB              ;        a=errFileNotFound
  36++A8EB              ;
  37++A8EB              ;addBytesToFile
  38++A8EB              ;
  39++A8EB              ;⠥ ᢮   ᫥  䠩
  40++A8EB D5           	push	de
  41++A8EC E5           	push	hl
  42++A8ED CD 92 AD     	call	LD_DEHL_fcbSize
  43++A8F0 CD 79 B3     	call	sizeBytes2Cls	;bc ⢮   ᫥  䠩
  44++A8F3 30 29        	jr	nc,goto097
  45++A8F5 C2 8F A9     	jp	nz,goto104	;᫨誮  ஢ 塞
  46++A8F8              ;  䠩 ⮩, 塞  ࠧ
  47++A8F8              ;	call	FindFreeClsRoot
  48++A8F8 CD 8B AF     	call	FindFreeClsFSinfo
  49++A8FB DA 8F A9     	jp	c,goto104
  50++A8FE 3E 49         	ld	a,errDiskNoSpace
  51++A900 CA 8F A9     	jp	z,goto104
  52++A903 CD 80 AD     	call	DEHL2fcbClsFile
  53++A906 E1           	pop	hl
  54++A907 D1           	pop	de
  55++A908 D5           	push	de
  56++A909 E5           	push	hl
  57++A90A CD 26 AB     	call	newFileFreeSpace
  58++A90D 30 69        	jr	nc,goto098	;  ᯥ譮
  59++A90F FE 49        	cp	errDiskNoSpace
  60++A911 20 7C        	jr	nz,goto104
  61++A913 CD 12 B0     	call	FreeClsChain	;᢮ ࠭ ⮩ 楯窨
  62++A916 CD BF B3     	call	SetZeroDEHL
  63++A919 CD 80 AD     	call	DEHL2fcbClsFile
  64++A91C 18 6A        	jr	goto103
  65++A91E              ;  ⠥ ⮥ ⮢ ᫥  䠩
  66++A91E 78           goto097	ld	a,b
  67++A91F B1           	or	c
  68++A920              ;	jr	z,goto098	; ᫥   
  69++A920 28 0C        	jr	z,goto177	; ᫥   
  70++A922 3A 76 8D     	ld	a,(LenCLSInSec)
  71++A925 67           	ld	h,a
  72++A926 2E 00        	ld	l,#00
  73++A928 29           	add	hl,hl		;hl ࠧ    0=65536
  74++A929 B7           	or	a
  75++A92A ED 42        	sbc	hl,bc		;hl ᢮   ᫥  䠩
  76++A92C 44           	ld	b,h
  77++A92D 4D           	ld	c,l		;bc ᢮   ᫥  䠩
  78++A92E E1           goto177	pop	hl
  79++A92F D1           	pop	de
  80++A930
  81++A930              ;஢ਬ    
  82++A930 D5           	push	de
  83++A931 E5           	push	hl
  84++A932 B7           	or	a
  85++A933 ED 42        	sbc	hl,bc
  86++A935 30 01        	jr	nc,goto099
  87++A937 1B           	dec	de
  88++A938 7A           goto099	ld	a,d
  89++A939 A3           	and	e
  90++A93A 3C           	inc	a
  91++A93B 28 3B        	jr	z,goto098	;   
  92++A93D 7C           	ld	a,h
  93++A93E B5           	or	l
  94++A93F B3           	or	e
  95++A940 B2           	or	d
  96++A941 28 35        	jr	z,goto098	;   
  97++A943              ;dehl 稭  ,    䠪᪨ 㢥 ࠧ 䠩
  98++A943              ;      
  99++A943
 100++A943              ; 楯窨 ஢  饩 楯窥
 101++A943              ;  ⠥ ᪮쪮 ஢  
 102++A943 CD 79 B3     	call	sizeBytes2Cls	;᫥ ࠧ  
 103++A946 38 47        	jr	c,goto104
 104++A948              ;  ।  ᫥  䠩
 105++A948 E5           	push	hl
 106++A949 CD 97 AD     	call	LD_DEHL_fcbClsFile
 107++A94C E5           loop041	push	hl
 108++A94D D5           	push	de
 109++A94E CD DD B0     	call	ReadFATnextCls	;dehl  ᫥饣 
 110++A951 38 39        	jr	c,goto102
 111++A953 CD CA B0     	call	TestLastCLS
 112++A956 38 04        	jr	c,goto100
 113++A958 C1           	pop	bc
 114++A959 C1           	pop	bc
 115++A95A 18 F0        	jr	loop041
 116++A95C D1           goto100	pop	de
 117++A95D E1           	pop	hl		;dehl  ᫥ 
 118++A95E C1           	pop	bc		;bc 塞 ⢮ ஢
 119++A95F              ;  塞 楯 ஢
 120++A95F D5           	push	de
 121++A960 E5           	push	hl
 122++A961 CD 3D AB     	call	fatAddFreeSpace_dehl
 123++A964 E1           	pop	hl
 124++A965 D1           	pop	de
 125++A966 30 10        	jr	nc,goto098	;訡  뫮
 126++A968 FE 49        	cp	errDiskNoSpace
 127++A96A 20 23        	jr	nz,goto104
 128++A96C              ;   ᢮ . ᢮  楯
 129++A96C D5           	push	de
 130++A96D E5           	push	hl
 131++A96E CD 12 B0     	call	FreeClsChain	;᢮ ࠭ ⮩ 楯窨
 132++A971 E1           	pop	hl
 133++A972 D1           	pop	de
 134++A973 CD 73 B0     	call	SetLastClsInFAT
 135++A976 18 10        	jr	goto103
 136++A978
 137++A978              ; ࠧ 䠩    ⠫
 138++A978 CD 92 AD     goto098 call	LD_DEHL_fcbSize
 139++A97B C1           	pop	bc
 140++A97C 09           	add	hl,bc
 141++A97D C1           	pop	bc
 142++A97E EB           	ex	de,hl
 143++A97F ED 4A        	adc	hl,bc
 144++A981 EB           	ex	de,hl
 145++A982 CD 73 AD     	call	DEHL2fcbSize
 146++A985              ;     ⠫
 147++A985 C3 63 AC     	jp	fcbWriteToEntry
 148++A988
 149++A988              ;室  訡
 150++A988 3E 49        goto103	ld	a,errDiskNoSpace
 151++A98A 18 03        	jr	goto104
 152++A98C D1           goto102	pop	de
 153++A98D D1           	pop	de
 154++A98E C1           	pop	bc
 155++A98F E1           goto104	pop	hl
 156++A990 D1           	pop	de
 157++A991 37           	scf
 158++A992 C9           	ret
 159++A993
 160++A993              	endif
 161++A993
 162++A993              ;------------------------------------------------------------------------------
 163++A993              fatCreateFile	ifused
 164++A993              ;ᮧ 䠩  ⥪饬 FAT32 ࠧ
 165++A993              ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType
 166++A993              ;  fcbSize
 167++A993              ;:  ix -   fcb
 168++A993              ;: cy=1 뫨 訡
 169++A993              ;       a=errRWnum
 170++A993              ;       a=errInvalidPart
 171++A993              ;       a=errEoF - 䠩 ࢠ
 172++A993              ;       a=errFileEmpty - ⮩ ୥ ⠫
 173++A993              ;       a=errFileExist
 174++A993              ;       a=errDiskNoSpace
 175++A993              ;       a=errNumTooBig - ᫨誮 让 ࠧ
 176++A993              ;       a=errInvFileName 䠩  ⠪  /⮥ 
 177++A993              ;     cy=0  ᥭ  ⠫
 178++A993              ;
 179++A993              ;fatCreateFile
 180++A993              ;
 181++A993 21 00 00     	ld	hl,#0000
 182++A996 18 FE        	jr	fatCreateFileLFN
 183++A998              	org	$-2
 184++A996              	endif
 185++A996
 186++A996
 187++A996              fatCreateFileLFN	ifused
 188++A996              ;ᮧ 䠩     ⥪饬 FAT32 ࠧ
 189++A996              ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType=1
 190++A996              ;  fcbSize
 191++A996              ;:  ix -   fcb
 192++A996              ;     hl -  ப     ଠ ASCIIZ
 193++A996              ;       =#0000 ᯮ짮 ⪮   fcb
 194++A996              ;
 195++A996              ;fatCreateFileLFN
 196++A996              ;
 197++A996 E5           	push	hl
 198++A997 7C           	ld	a,h
 199++A998 B5           	or	l
 200++A999 20 0C        	jr	nz,goto172
 201++A99B
 202++A99B              ;஢ઠ ⢮ 䠩
 203++A99B DD E5        	push	ix
 204++A99D E1           	pop	hl
 205++A99E CD 29 A8     	call	fatFindEntryDir
 206++A9A1              ;	call	fcbFindEntry		; 䠩  ⠫
 207++A9A1 38 38        	jr	c,error1		;訡
 208++A9A3 3E 73        	ld	a,errFileExist
 209++A9A5 28 34        	jr	z,error1		;䠩  ⠪  
 210++A9A7
 211++A9A7              ; ᢮ 
 212++A9A7 CD 8B AF     goto172	call	FindFreeClsFSinfo
 213++A9AA              ;	call	FindFreeClsRoot
 214++A9AA 38 2F        	jr	c,error1		;訡
 215++A9AC 3E 49        	ld	a,errDiskNoSpace
 216++A9AE 28 2B        	jr	z,error1
 217++A9B0 CD 80 AD     	call	DEHL2fcbClsFile
 218++A9B3
 219++A9B3              ;१ࢨ㥬 楯 ஢
 220++A9B3 DD CB 1E 66  	bit	4,(ix+fcbType)
 221++A9B7 28 0A        	jr	z,goto072		;ᮧ 䠩
 222++A9B9              ;  ᮧ ⠫ ࠧ 1 
 223++A9B9 2A 76 8D     	ld	hl,(LenCLSInSec)
 224++A9BC 26 00        	ld	h,#00
 225++A9BE 54           	ld	d,h
 226++A9BF 29           	add	hl,hl
 227++A9C0 5C           	ld	e,h
 228++A9C1 65           	ld	h,l
 229++A9C2 6A           	ld	l,d
 230++A9C3 CC 92 AD     goto072	call	z,LD_DEHL_fcbSize
 231++A9C6 CD 26 AB     	call	newFileFreeSpace
 232++A9C9 30 1B        	jr	nc,goto071
 233++A9CB FE 75        	cp	errFileEmpty
 234++A9CD 28 0F        	jr	z,goto070		; 㫥 ࠧ 䠩
 235++A9CF FE 49        	cp	errDiskNoSpace
 236++A9D1 20 08        	jr	nz,error1
 237++A9D3 F5           goto069	push	af
 238++A9D4 CD 97 AD     	call	LD_DEHL_fcbClsFile
 239++A9D7 CD 12 B0     	call	FreeClsChain		;᢮ ࠭ ⮩ 楯窨
 240++A9DA F1           	pop	af
 241++A9DB E1           error1	pop	hl
 242++A9DC 37           	scf
 243++A9DD C9           	ret
 244++A9DE              ;  䠩 㫥 
 245++A9DE 21 00 00     goto070	ld	hl,#0000
 246++A9E1 5D           	ld	e,l
 247++A9E2 55           	ld	d,l
 248++A9E3 CD 80 AD     	call	DEHL2fcbClsFile
 249++A9E6
 250++A9E6              ;ᮧ   ⠫
 251++A9E6 E1           goto071	pop	hl
 252++A9E7 E5           	push	hl
 253++A9E8 CD EF A9     	call	fatAddFileEntry
 254++A9EB 38 E6        	jr	c,goto069
 255++A9ED E1           	pop	hl
 256++A9EE C9           	ret
 257++A9EF ~            /*뫮
 258++A9EF ~            	push	hl
 259++A9EF ~            	ld	a,h
 260++A9EF ~            	or	l
 261++A9EF ~            	jr	z,goto173
 262++A9EF ~            	call	addFileEntrysLFN
 263++A9EF ~            	jr	goto174
 264++A9EF ~            goto173	call	addFileEntry
 265++A9EF ~            goto174	jr	c,goto069
 266++A9EF ~            	pop	hl
 267++A9EF ~            	ret
 268++A9EF ~            */
 269++A9EF              	endif
 270++A9EF
 271++A9EF              ;------------------------------------------------------------------------------
 272++A9EF              fatAddFileEntry	ifused
 273++A9EF              ;  ⠫   /⪨  䠩
 274++A9EF              ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType
 275++A9EF              ;  fcbClsFile, fcbSize
 276++A9EF              ;:  ix -   fcb
 277++A9EF              ;     hl -  ப     ଠ ASCIIZ
 278++A9EF              ;       =#0000 䠩  ⪨   fcb (fcbName, fcbExt   ⠭)
 279++A9EF              ;:   fcb ⠭   ७  ᭮  
 280++A9EF              ;     cy=1 訡 ⥭/
 281++A9EF              ;       a=errRWnum
 282++A9EF              ;       a=errInvalidPart
 283++A9EF              ;       a=errEoF - 䠩 ࢠ
 284++A9EF              ;       a=errFileEmpty - ⮩ ୥ ⠫
 285++A9EF              ;       a=errInvFileName 䠩  ⠪  /⮥ 
 286++A9EF              ;       a=errDiskNoSpace
 287++A9EF              ;     cy=0  ᥭ  ⫮
 288++A9EF              ;
 289++A9EF              ;fatAddFileEntry
 290++A9EF              ;
 291++A9EF 7C           	ld	a,h
 292++A9F0 B5           	or	l
 293++A9F1 28 68        	jr	z,addFileEntry
 294++A9F3 18 FE        	jr	addFileEntrysLFN
 295++A9F5              	org	$-2
 296++A9F3
 297++A9F3              	endif
 298++A9F3
 299++A9F3              ;------------------------------------------------------------------------------
 300++A9F3              addFileEntrysLFN	ifused
 301++A9F3              ;  ⠫ ᥩ    䠩
 302++A9F3              ;  ᭮   ⪨  ⮦ 
 303++A9F3              ;   fcb   ⠭: fcbClsDIR, bit4 fcbType, fcbClsFile, fcbSize
 304++A9F3              ;:  ix -   fcb
 305++A9F3              ;     hl -  ப     ଠ ASCIIZ
 306++A9F3              ;:   fcb ⠭   ७  ᭮  
 307++A9F3              ;     cy=1 訡 ⥭/
 308++A9F3              ;       a=errRWnum
 309++A9F3              ;       a=errInvalidPart
 310++A9F3              ;       a=errEoF - 䠩 ࢠ
 311++A9F3              ;       a=errFileEmpty - ⮩ ୥ ⠫
 312++A9F3              ;       a=errInvFileName 䠩  ⠪  /⮥ 
 313++A9F3              ;       a=errDiskNoSpace
 314++A9F3              ;     cy=0  ᥭ  ⫮
 315++A9F3              ;
 316++A9F3              ;addFileEntrysLFN
 317++A9F3              ;
 318++A9F3              ;ନ஢ ⪮   ஢મ ⢮ 䠩
 319++A9F3 CD 7D A5     	call	fatSetSFNname		;b=#00
 320++A9F6 D8           	ret	c
 321++A9F7
 322++A9F7              ;⠥ 室 ⢮ ᥩ   
 323++A9F7 E5           	push	hl
 324++A9F8 05           	dec	b			;b=#FF
 325++A9F9 7E           loop063	ld	a,(hl)
 326++A9FA 04           	inc	b
 327++A9FB 23           	inc	hl
 328++A9FC B7           	or	a
 329++A9FD 20 FA        	jr	nz,loop063
 330++A9FF D1           	pop	de			;de -  ப   
 331++AA00 78           	ld	a,b
 332++AA01 B7           	or	a
 333++AA02 3E 45        	ld	a,errInvFileName
 334++AA04 37           	scf
 335++AA05 C8           	ret	z			;⮥ 
 336++AA06 78           	ld	a,b			;b -  
 337++AA07 06 FF        	ld	b,#FF
 338++AA09 C6 0C        	add	a,LenEntryLFN-1
 339++AA0B 04           loop064	inc	b
 340++AA0C D6 0D        	sub	LenEntryLFN
 341++AA0E 30 FB        	jr	nc,loop064
 342++AA10              ;de -  ப   
 343++AA10              ;b - ⢮ ᥩ    (   ᫥ ) [1..20]
 344++AA10              ;c - ஫쭠 㬬 
 345++AA10
 346++AA10              ;⠭ ਯ஢    
 347++AA10 C5           	push	bc
 348++AA11 21 B8 8F     	ld	hl,Buf4LFN
 349++AA14 E5           	push	hl
 350++AA15 D5           loop065	push	de
 351++AA16 C5           	push	bc
 352++AA17 05           	dec	b
 353++AA18 78           	ld	a,b
 354++AA19 87           	add	a,a
 355++AA1A 87           	add	a,a
 356++AA1B 4F           	ld	c,a
 357++AA1C 87           	add	a,a
 358++AA1D 81           	add	a,c
 359++AA1E 80           	add	a,b			;a=b*13
 360++AA1F 83           	add	a,e
 361++AA20 5F           	ld	e,a
 362++AA21 30 01        	jr	nc,goto171
 363++AA23 14           	inc	d			;de   ப   䠩
 364++AA24 C1           goto171	pop	bc
 365++AA25              ;	inc	b
 366++AA25 CD 12 A5     	call	lfnSetOneEntry		;⠭   LFN
 367++AA28              ;	pop	bc
 368++AA28 D1           	pop	de
 369++AA29 10 EA        	djnz	loop065
 370++AA2B E1           	pop	hl
 371++AA2C C1           	pop	bc
 372++AA2D              ;b - ⢮ ᥩ    (   ᫥ ) [1..20]
 373++AA2D              ;c - ஫쭠 㬬 
 374++AA2D              ;hl -    ਯࠬ
 375++AA2D              ;de -  ப   
 376++AA2D
 377++AA2D              ; ਯ஢     
 378++AA2D              ;   ࢮ ⮩   ⠫ ( 㤥 ᫥   ⠫)
 379++AA2D              ;    (㤠   ஢)
 380++AA2D CB F6        	set	6,(hl)
 381++AA2F C5           loop066	push	bc
 382++AA30 E5           	push	hl
 383++AA31 CD C4 AA     	call	findFreeDirEntry
 384++AA34 DA 37 AC     	jp	c,error2		;訡
 385++AA37              ;  ⠥ ᥪ ⠫
 386++AA37              ;loop066
 387++AA37 C5           	push	bc
 388++AA38              	hddSetCurrSec			;⠭  LBA  ⥭
 388++AA38 CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 389++AA3B 21 B8 8D     	ld	hl,Buf4File
 390++AA3E              	hddReadSec2HL			;⠫ ᥪ
 390++AA3E CD 93 9B    >	call	DrvHDD.RdSecHDD_HL
 391++AA41 D1           	pop	de			; ਯ  ⠭ ᥪ
 392++AA42 DA 37 AC     	jp	c,error2		;訡
 393++AA45 19           	add	hl,de
 394++AA46 EB           	ex	de,hl			;  ᥪ ⠫
 395++AA47 E1           	pop	hl
 396++AA48 01 20 00     	ld	bc,#0020
 397++AA4B ED B0        	ldir
 398++AA4D E5           	push	hl			; ᫥饣 ਯ
 399++AA4E              ;  襬 ᥪ ⠫
 400++AA4E 21 B8 8D     	ld	hl,Buf4File
 401++AA51              	hddWriteSecHL			;ᠫ ᥪ
 401++AA51 CD BF 9B    >	call	DrvHDD.WrSecHDD_HL
 402++AA54 DA 37 AC     	jp	c,error2		;訡
 403++AA57 E1           	pop	hl
 404++AA58 C1           	pop	bc
 405++AA59 10 D4        	djnz	loop066
 406++AA5B
 407++AA5B              ;襬 ᭮ ਯ  ⪨ 
 408++AA5B 18 FE        	jr	addFileEntry
 409++AA5D              	org	$-2
 410++AA5B
 411++AA5B              	endif
 412++AA5B
 413++AA5B              ;------------------------------------------------------------------------------
 414++AA5B              addFileEntry	ifused
 415++AA5B              ;  ⠫ 䠩
 416++AA5B              ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType
 417++AA5B              ;  fcbClsFile, fcbSize
 418++AA5B              ;:  ix -   fcb
 419++AA5B              ;: cy=1 뫨 訡.  訡  A
 420++AA5B              ;       a=errRWnum
 421++AA5B              ;       a=errInvalidPart
 422++AA5B              ;       a=errFileEmpty
 423++AA5B              ;       a=errDiskNoSpace
 424++AA5B              ;     cy=0  ᥭ  ⫮
 425++AA5B              ;
 426++AA5B              ;addFileEntry
 427++AA5B              ;
 428++AA5B              ; ⮩   ⠫
 429++AA5B CD C4 AA     	call	findFreeDirEntry
 430++AA5E D8           	ret	c		;訡
 431++AA5F
 432++AA5F              ;⠥ ᥪ ⠫
 433++AA5F C5           	push	bc
 434++AA60              	hddSetCurrSec		;⠭  LBA  ⥭
 434++AA60 CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 435++AA63 21 B8 8D     	ld	hl,Buf4File
 436++AA66              	hddReadSec2HL		;⠫ ᥪ
 436++AA66 CD 93 9B    >	call	DrvHDD.RdSecHDD_HL
 437++AA69 C1           	pop	bc
 438++AA6A D8           	ret	c		;訡
 439++AA6B
 440++AA6B              ;ᨬ  ᥪ 
 441++AA6B 09           	add	hl,bc		;   
 442++AA6C EB           	ex	de,hl
 443++AA6D DD E5        	push	ix
 444++AA6F E1           	pop	hl		;fcb 
 445++AA70              ;   䠩
 446++AA70 01 0B 00     	ld	bc,#000B
 447++AA73 ED B0        	ldir
 448++AA75              ;  ਡ 䠩
 449++AA75 DD 7E 1E     	ld	a,(ix+fcbType)
 450++AA78              ;	rra
 451++AA78              ;	rra
 452++AA78 E6 10        	and	%00010000
 453++AA7A F6 20        	or	%00100000
 454++AA7C 12           	ld	(de),a
 455++AA7D 13           	inc	de
 456++AA7E              ;   NT
 457++AA7E AF           	xor	a
 458++AA7F 12           	ld	(de),a
 459++AA80 13           	inc	de
 460++AA81 EB           	ex	de,hl
 461++AA82              ;  ⠭ ६   ᮧ
 462++AA82 77           	ld	(hl),a
 463++AA83 23           	inc	hl		;ᥪ㭤    ᥪ㭤
 464++AA84              	IFDEF	forProfROM
 465++AA84 ~            	 ld	a,(iy-#1E)	;ᥪ㭤
 466++AA84 ~            	 rlca
 467++AA84 ~            	 rlca
 468++AA84 ~            	 ld	c,(iy-#1D)	;
 469++AA84 ~            	 ld	b,#03
 470++AA84 ~            loop020	 rr	c
 471++AA84 ~            	 rra
 472++AA84 ~            	 djnz	loop020
 473++AA84 ~            	 ld	e,a
 474++AA84 ~            	 ld	(hl),a
 475++AA84 ~            	 inc	hl
 476++AA84 ~            	 ld	a,(iy-#1C)	;
 477++AA84 ~            	 rlca
 478++AA84 ~            	 rlca
 479++AA84 ~            	 rlca
 480++AA84 ~            	 or	c
 481++AA84 ~            	 ld	d,a
 482++AA84 ~            	 ld	(hl),a
 483++AA84 ~            	 inc	hl
 484++AA84 ~            	 ld	c,(iy-#1B)	;
 485++AA84 ~            	 ld	a,(iy-#1A)	;
 486++AA84 ~            	 rrca
 487++AA84 ~            	 rrca
 488++AA84 ~            	 rrca
 489++AA84 ~            	 ld	b,a
 490++AA84 ~            	 and	%11100000
 491++AA84 ~            	 or	c
 492++AA84 ~            	 ld	c,a
 493++AA84 ~            	 ld	(hl),a
 494++AA84 ~            	 inc	hl
 495++AA84 ~            	 ld	a,(iy-#19)	;
 496++AA84 ~            	 add	a,20
 497++AA84 ~            	 rr	b
 498++AA84 ~            	 rla
 499++AA84 ~            	 ld	b,a
 500++AA84 ~            	 ld	(hl),a
 501++AA84 ~            	 inc	hl
 502++AA84              	ELSE
 503++AA84 77           	 ld	(hl),a
 504++AA85 23           	 inc	hl
 505++AA86 77           	 ld	(hl),a
 506++AA87 23           	 inc	hl
 507++AA88 77           	 ld	(hl),a
 508++AA89 23           	 inc	hl
 509++AA8A 77           	 ld	(hl),a
 510++AA8B 23           	 inc	hl
 511++AA8C 5F           	 ld	e,a
 512++AA8D 57           	 ld	d,a
 513++AA8E 4F           	 ld	c,a
 514++AA8F 47           	 ld	b,a
 515++AA90              	ENDIF
 516++AA90              ;   ᫥ 㯠
 517++AA90 71           	ld	(hl),c
 518++AA91 23           	inc	hl
 519++AA92 70           	ld	(hl),b
 520++AA93 23           	inc	hl
 521++AA94              ;  襥 ᫮  ࢮ 
 522++AA94 DD 7E 0E     	ld	a,(ix+fcbClsFile+2)
 523++AA97 77           	ld	(hl),a
 524++AA98 23           	inc	hl
 525++AA99 DD 7E 0F     	ld	a,(ix+fcbClsFile+3)
 526++AA9C 77           	ld	(hl),a
 527++AA9D 23           	inc	hl
 528++AA9E              ;  ६   ᫥  䠩
 529++AA9E 73           	ld	(hl),e
 530++AA9F 23           	inc	hl
 531++AAA0 72           	ld	(hl),d
 532++AAA1 23           	inc	hl
 533++AAA2 71           	ld	(hl),c
 534++AAA3 23           	inc	hl
 535++AAA4 70           	ld	(hl),b
 536++AAA5 23           	inc	hl
 537++AAA6              ;  襥 ᫮  ࢮ 
 538++AAA6 DD 7E 0C     	ld	a,(ix+fcbClsFile)
 539++AAA9 77           	ld	(hl),a
 540++AAAA 23           	inc	hl
 541++AAAB DD 7E 0D     	ld	a,(ix+fcbClsFile+1)
 542++AAAE 77           	ld	(hl),a
 543++AAAF 23           	inc	hl
 544++AAB0              ;  ࠧ 䠩
 545++AAB0 DD E5        	push	ix
 546++AAB2 E3           	ex	(sp),hl
 547++AAB3 11 14 00     	ld	de,fcbSize
 548++AAB6 19           	add	hl,de
 549++AAB7 D1           	pop	de
 550++AAB8 01 04 00     	ld	bc,#0004
 551++AABB ED B0        	ldir
 552++AABD
 553++AABD              ;襬 ᥪ ⠫
 554++AABD 21 B8 8D     	ld	hl,Buf4File
 555++AAC0              	hddWriteSecHL		;ᠫ ᥪ
 555++AAC0 CD BF 9B    >	call	DrvHDD.WrSecHDD_HL
 556++AAC3 C9           	ret
 557++AAC4
 558++AAC4              	endif
 559++AAC4
 560++AAC4              ;------------------------------------------------------------------------------
 561++AAC4              findFreeDirEntry	ifused
 562++AAC4              ; ⮩   ⠫
 563++AAC4              ;   ४⭮    㤠   ஢
 564++AAC4              ;   fcb   ⠭: fcbClsDIR
 565++AAC4              ;:  ix -   fcb
 566++AAC4              ;: cy=1 뫨 訡.  訡  A
 567++AAC4              ;       a=errRWnum
 568++AAC4              ;       a=errInvalidPart
 569++AAC4              ;       a=errFileEmpty
 570++AAC4              ;       a=errDiskNoSpace
 571++AAC4              ;     cy=0  
 572++AAC4              ;	dehl -  ᥪ  ⮩ 
 573++AAC4              ;       bc - ᬥ饭  ᥪ
 574++AAC4              ;
 575++AAC4              ;findFreeDirEntry
 576++AAC4              ;
 577++AAC4 DD E5        	push	ix
 578++AAC6
 579++AAC6              ;⠭ ࠬ஢  fcb
 580++AAC6 DD E5        	push	ix
 581++AAC8 E1           	pop	hl
 582++AAC9 11 10 00     	ld	de,fcbClsDIR
 583++AACC 19           	add	hl,de		; ६  ஬ ࢮ  ⠫
 584++AACD 5A           	ld	e,d
 585++AACE
 586++AACE              ;⥭ ᥪ   
 587++AACE E5           loop019	push	hl		; ६  ஬ ࢮ 
 588++AACF D5           	push	de		;ᬥ饭  砫 ⠫  ᥪ
 589++AAD0 CD 8E AB     	call	ReadSectorHDD
 590++AAD3 30 2A        	jr	nc,goto048	;ᥪ ⠭
 591++AAD5 FE 71        	cp	errEoF
 592++AAD7 20 40        	jr	nz,goto046	;訡 ⥭
 593++AAD9              ;   . 塞   ⠫
 594++AAD9              ;	call	FindFreeClsRoot
 595++AAD9 CD 8B AF     	call	FindFreeClsFSinfo
 596++AADC 38 3C        	jr	c,goto047
 597++AADE 3E 49        	ld	a,errDiskNoSpace
 598++AAE0 28 37        	jr	z,goto046
 599++AAE2 22 A5 8D     	ld	(tmpDWORD),hl
 600++AAE5 ED 53 A7 8D  	ld	(tmpDWORD+2),de	; ᢮ 
 601++AAE9 C1           	pop	bc
 602++AAEA E3           	ex	(sp),hl
 603++AAEB D5           	push	de
 604++AAEC CD 0D B4     	call	LD_DEHL_adrHL
 605++AAEF CD 51 B0     	call	AddCls2Chain
 606++AAF2 38 26        	jr	c,goto047	;訡 ⥭/
 607++AAF4              ;  ⪠  
 608++AAF4 D1           	pop	de
 609++AAF5 E1           	pop	hl
 610++AAF6 DD 21 B8 8D  	ld	ix,Buf4File
 611++AAFA CD 27 AF     	call	fatClearCls
 612++AAFD 18 24        	jr	goto050
 613++AAFF              ;   ⮩   ⠭ ᥪ
 614++AAFF 01 00 00     goto048	ld	bc,#0000	;ᬥ饭  ᥪ
 615++AB02 DD E5        loop017	push	ix
 616++AB04 E1           	pop	hl
 617++AB05 09           	add	hl,bc
 618++AB06 7E           	ld	a,(hl)
 619++AB07 B7           	or	a
 620++AB08 28 10        	jr	z,goto047	;  
 621++AB0A 21 20 00     	ld	hl,#0020
 622++AB0D 09           	add	hl,bc
 623++AB0E 4D           	ld	c,l
 624++AB0F 44           	ld	b,h
 625++AB10 CB 48        	bit	1,b
 626++AB12 28 EE        	jr	z,loop017
 627++AB14              ;  ⠥ ᫥騩 ᥪ ⠫
 628++AB14 D1           	pop	de
 629++AB15 E1           	pop	hl
 630++AB16 13           	inc	de
 631++AB17 18 B5        	jr	loop019
 632++AB19 37           goto046	scf
 633++AB1A              ;  
 634++AB1A D1           goto047	pop	de
 635++AB1B E1           	pop	hl
 636++AB1C 2A A1 8D     	ld	hl,(SecFileInBuf)
 637++AB1F ED 5B A3 8D  	ld	de,(SecFileInBuf+2)
 638++AB23 DD E1        goto050	pop	ix
 639++AB25 C9           	ret
 640++AB26
 641++AB26              	endif
 642++AB26
 643++AB26 ~            /* ਠ  頥묨 ⥫묨 ࠬࠬ
 644++AB26 ~            findFreeDirEntry	ifused
 645++AB26 ~            ; ⮩   ⠫
 646++AB26 ~            ;   fcb   ⠭: fcbClsDIR
 647++AB26 ~            ;:  ix -   fcb
 648++AB26 ~            ;: cy=1 뫨 訡.  訡  A
 649++AB26 ~            ;       a=errRWnum
 650++AB26 ~            ;       a=errInvalidPart
 651++AB26 ~            ;       a=errFileEmpty
 652++AB26 ~            ;       a=errDiskNoSpace
 653++AB26 ~            ;       hl,de,bc,hl',de',bc' - ???
 654++AB26 ~            ;     cy=0  
 655++AB26 ~            ;	dehl -  ᥪ  ⮩ 
 656++AB26 ~            ;       bc - ᬥ饭  ᥪ  
 657++AB26 ~            ;       a -    ⥪饬 ᥪ
 658++AB26 ~            ;       bc' - ᬥ饭  砫 ⠫  ᥪ
 659++AB26 ~            ;
 660++AB26 ~            ;findFreeDirEntry
 661++AB26 ~            ;
 662++AB26 ~            ;⠭ ࠬ஢  fcb
 663++AB26 ~            	push	ix
 664++AB26 ~            	pop	hl
 665++AB26 ~            	ld	de,fcbClsDIR
 666++AB26 ~            	add	hl,de		; ६  ஬ ࢮ  ⠫
 667++AB26 ~            	jr	findFreeEntryCurDir
 668++AB26 ~            	org	$-2
 669++AB26 ~
 670++AB26 ~            	endif
 671++AB26 ~
 672++AB26 ~
 673++AB26 ~            findFreeEntryCurDir	ifused
 674++AB26 ~            ; ⮩   ⥪饬 ⠫
 675++AB26 ~            ;ࠬ ⠪ , ஬ fcb
 676++AB26 ~            ;:  hl -  ६  ஬ ࢮ  ⠫
 677++AB26 ~            ;
 678++AB26 ~            ;findFreeEntryCurDir
 679++AB26 ~            ;
 680++AB26 ~            	push	ix
 681++AB26 ~            	ld	de,#0000
 682++AB26 ~
 683++AB26 ~            ;⥭ ᥪ   
 684++AB26 ~            loop019	push	hl		; ६  ஬ ࢮ 
 685++AB26 ~            	push	de		;ᬥ饭  砫 ⠫  ᥪ
 686++AB26 ~            	call	ReadSectorHDD
 687++AB26 ~            	jr	nc,goto048	;ᥪ ⠭
 688++AB26 ~            	cp	errEoF
 689++AB26 ~            	jr	nz,goto046	;訡 ⥭
 690++AB26 ~            ;   . 塞   ⠫
 691++AB26 ~            	call	FindFreeClsFSinfo
 692++AB26 ~            ;	call	FindFreeClsRoot
 693++AB26 ~            	jr	c,goto047
 694++AB26 ~            	ld	a,errDiskNoSpace
 695++AB26 ~            	jr	z,goto046
 696++AB26 ~            	ld	(tmpDWORD),hl
 697++AB26 ~            	ld	(tmpDWORD+2),de	; ᢮ 
 698++AB26 ~            	pop	bc		;ᬥ饭  砫 ⠫  ᥪ
 699++AB26 ~            	ex	(sp),hl
 700++AB26 ~            	push	bc
 701++AB26 ~            	push	de
 702++AB26 ~            	call	LD_DEHL_adrHL
 703++AB26 ~            	call	AddCls2Chain
 704++AB26 ~            	jr	c,goto169	;訡 ⥭/
 705++AB26 ~            ;  ⪠  
 706++AB26 ~            	pop	de
 707++AB26 ~            	pop	bc
 708++AB26 ~            	pop	hl
 709++AB26 ~            	push	bc
 710++AB26 ~            	ld	ix,Buf4File
 711++AB26 ~            	call	fatClearCls	;bc=#0000
 712++AB26 ~            	jr	c,goto170
 713++AB26 ~            	exx
 714++AB26 ~            	pop	bc		;ᬥ饭  砫 ⠫  ᥪ
 715++AB26 ~            	exx
 716++AB26 ~            	pop	hl
 717++AB26 ~            	xor	a
 718++AB26 ~            	jr	goto050
 719++AB26 ~            ;   ⮩   ⠭ ᥪ
 720++AB26 ~            goto048	xor	a
 721++AB26 ~            	ld	b,a
 722++AB26 ~            	ld	c,a		;ᬥ饭  ᥪ
 723++AB26 ~            loop017	push	ix
 724++AB26 ~            	pop	hl
 725++AB26 ~            	add	hl,bc		;nc
 726++AB26 ~            	inc	(hl)
 727++AB26 ~            	dec	(hl)
 728++AB26 ~            	jr	z,goto047	;  
 729++AB26 ~            	inc	a
 730++AB26 ~            	ld	hl,#0020
 731++AB26 ~            	add	hl,bc
 732++AB26 ~            	ld	c,l
 733++AB26 ~            	ld	b,h
 734++AB26 ~            	bit	1,b
 735++AB26 ~            	jr	z,loop017
 736++AB26 ~            ;  ⠥ ᫥騩 ᥪ ⠫
 737++AB26 ~            	pop	de
 738++AB26 ~            	pop	hl
 739++AB26 ~            	inc	de
 740++AB26 ~            	jr	loop019
 741++AB26 ~            goto169	pop	bc
 742++AB26 ~            goto046	scf
 743++AB26 ~            ;  
 744++AB26 ~            goto047	exx
 745++AB26 ~            	pop	bc		;ᬥ饭  ᥪ
 746++AB26 ~            	exx
 747++AB26 ~            goto170	pop	hl
 748++AB26 ~            	ld	hl,(SecFileInBuf)
 749++AB26 ~            	ld	de,(SecFileInBuf+2)
 750++AB26 ~            goto050	pop	ix
 751++AB26 ~            	ret
 752++AB26 ~
 753++AB26 ~            	endif
 754++AB26 ~            */
 755++AB26              ;------------------------------------------------------------------------------
 756++AB26              newFileFreeSpace	ifused
 757++AB26              ;ᮧ 楯窨 ஢   ⢮ 
 758++AB26              ;   fcb   ⠭: fcbClsFile
 759++AB26              ;:  dehl - ࠧ  
 760++AB26              ;     ix -  fcb 
 761++AB26              ;: cy=1 訡
 762++AB26              ;        a=errRWnum -  訡
 763++AB26              ;        a=errNumTooBig - ᫨誮 让 ࠧ
 764++AB26              ;        a=errFileEmpty - 㫥 ࠧ 䠩
 765++AB26              ;        a=errDiskNoSpace -> bc - ⢮  뤥 ஢
 766++AB26              ;                            dehl -  ࢮ    楯窥
 767++AB26              ;     cy=0  ᯥ譮
 768++AB26              ;        dehl -  ண   ᮧ 楯窥
 769++AB26              ;
 770++AB26              ;newFileFreeSpace
 771++AB26              ;
 772++AB26 CD 79 B3     	call	sizeBytes2Cls	;᫥ ࠧ  
 773++AB29 D8           	ret	c
 774++AB2A
 775++AB2A              ;   襬 ਧ  楯窨
 776++AB2A E5           	push	hl
 777++AB2B CD 97 AD     	call	LD_DEHL_fcbClsFile
 778++AB2E D5           	push	de
 779++AB2F E5           	push	hl
 780++AB30 CD 73 B0     	call	SetLastClsInFAT
 781++AB33 E1           	pop	hl
 782++AB34 D1           	pop	de
 783++AB35 C1           	pop	bc
 784++AB36 D8           	ret	c
 785++AB37              ;dehl -  ࢮ  䠩
 786++AB37              ;bc - ࠧ  
 787++AB37
 788++AB37              ;襬 ⠫ 楯, ᫨  
 789++AB37 0B           	dec	bc
 790++AB38 78           	ld	a,b
 791++AB39 B1           	or	c
 792++AB3A C8           	ret	z
 793++AB3B 18 00        	jr	fatAddFreeSpace_dehl
 794++AB3D
 795++AB3D              	endif
 796++AB3D
 797++AB3D              ;------------------------------------------------------------------------------
 798++AB3D              addFileFreeSpace	ifused
 799++AB3D ~            ;  ⢠   饩 楯窥 ஢
 800++AB3D ~            ;:  dehl - ࠧ  
 801++AB3D ~            ;     (tmpDWORD) -  ᫥  楯窨
 802++AB3D ~            ;: cy=1 訡
 803++AB3D ~            ;        a=errRWnum -  訡
 804++AB3D ~            ;        a=errNumTooBig - ᫨誮 让 ࠧ
 805++AB3D ~            ;        a=errFileEmpty - 㫥 ࠧ 䠩
 806++AB3D ~            ;        a=errDiskNoSpace -> bc - ⢮  뤥 ஢
 807++AB3D ~            ;                            dehl -  ࢮ    楯窥
 808++AB3D ~            ;     cy=0  ᯥ譮
 809++AB3D ~            ;        dehl -  ࢮ    楯窥
 810++AB3D ~            ;
 811++AB3D ~            ;addFileFreeSpace
 812++AB3D ~            ;
 813++AB3D ~            	call	sizeBytes2Cls	;᫥ ࠧ  
 814++AB3D ~            	ret	c
 815++AB3D ~            	ld	c,l
 816++AB3D ~            	ld	b,h
 817++AB3D ~            	jr	fatAddFreeSpace_var
 818++AB3D ~            	org	$-2
 819++AB3D ~
 820++AB3D              	endif
 821++AB3D
 822++AB3D              ;------------------------------------------------------------------------------
 823++AB3D              fatAddFreeSpace_var	ifused
 824++AB3D ~            ;  楯 ஢  ⢠ ஢
 825++AB3D ~            ;:  bc - ⢮ ஢
 826++AB3D ~            ;     (tmpDWORD) -  ࢮ  楯窨
 827++AB3D ~            ;: cy=1 訡 ⥭/
 828++AB3D ~            ;        a=errRWnum -  訡
 829++AB3D ~            ;        a=errDiskNoSpace -> bc - ⢮  뤥 ஢
 830++AB3D ~            ;                            dehl -  ࢮ    楯窥
 831++AB3D ~            ;     cy=0  ᯥ譮
 832++AB3D ~            ;        dehl -  ࢮ    楯窥
 833++AB3D ~            ;
 834++AB3D ~            ;fatAddFreeSpace_var
 835++AB3D ~            ;
 836++AB3D ~            	ld	hl,(tmpDWORD)
 837++AB3D ~            	ld	de,(tmpDWORD+2)
 838++AB3D ~            	jr	fatAddFreeSpace_dehl
 839++AB3D ~            	org	$-2
 840++AB3D ~
 841++AB3D              	endif
 842++AB3D
 843++AB3D              ;------------------------------------------------------------------------------
 844++AB3D              fatAddFreeSpace_dehl	ifused
 845++AB3D              ;  楯 ஢  ⢠ ஢
 846++AB3D              ;:  bc - ⢮ ஢
 847++AB3D              ;     dehl -  ᫥  楯窨
 848++AB3D              ;: cy=1 訡 ⥭/
 849++AB3D              ;        a=errRWnum -  訡
 850++AB3D              ;        a=errDiskNoSpace -> bc - ⢮  뤥 ஢
 851++AB3D              ;                            dehl -  ࢮ    楯窥
 852++AB3D              ;     cy=0  ᯥ譮
 853++AB3D              ;        dehl -  ࢮ    楯窥
 854++AB3D              ;
 855++AB3D              ;fatAddFreeSpace_dehl
 856++AB3D              ;
 857++AB3D              ;	call	setFsInfoEmpty		;  ࢮ ᢮ 
 858++AB3D              ;	ret	c
 859++AB3D
 860++AB3D              ; ᢮   砫 ࠧ
 861++AB3D C5           	push	bc
 862++AB3E D5           	push	de
 863++AB3F E5           	push	hl
 864++AB40 CD 8B AF     	call	FindFreeClsFSinfo	;饬 ᢮   砫 ࠧ
 865++AB43              ;	call	FindFreeClsRoot		;饬 ᢮   砫 ࠧ
 866++AB43 22 A9 8D     	ld	(tmpDWORD2),hl
 867++AB46 ED 53 AB 8D  	ld	(tmpDWORD2+2),de	; ࢮ    楯窥
 868++AB4A 18 0B        	jr	goto038
 869++AB4C
 870++AB4C              ;塞 楯 ஢
 871++AB4C C5           loop013	push	bc
 872++AB4D D5           	push	de
 873++AB4E E5           	push	hl
 874++AB4F CD 05 B4     	call	Inc_DEHL
 875++AB52 28 30        	jr	z,goto043
 876++AB54 CD A0 AF     	call	FindFreeCls		;饬 ᢮ 
 877++AB57 22 A5 8D     goto038	ld	(tmpDWORD),hl
 878++AB5A ED 53 A7 8D  	ld	(tmpDWORD+2),de		; ᢮ 
 879++AB5E E1           	pop	hl
 880++AB5F D1           	pop	de			; ⥪饣 
 881++AB60 38 2A        	jr	c,goto039		;訡 ⥭/
 882++AB62 28 22        	jr	z,goto040		; ᢮ ஢
 883++AB64 CD 80 B0     	call	SetNClsInFAT
 884++AB67 38 23        	jr	c,goto039		;訡 ⥭/
 885++AB69 2A A5 8D     	ld	hl,(tmpDWORD)
 886++AB6C ED 5B A7 8D  	ld	de,(tmpDWORD+2)
 887++AB70 C1           	pop	bc
 888++AB71 0B           	dec	bc
 889++AB72 78           	ld	a,b
 890++AB73 B1           	or	c
 891++AB74 20 D6        	jr	nz,loop013
 892++AB76 CD 0E B1     	call	setFsInfoFreeCls
 893++AB79              ;dehl -  ᫥   楯窨
 894++AB79
 895++AB79              ;襬  ᫥  ਧ  楯窨
 896++AB79              ;dehl -  
 897++AB79 CD 73 B0     proc_05	call	SetLastClsInFAT
 898++AB7C 2A A9 8D     	ld	hl,(tmpDWORD2)
 899++AB7F ED 5B AB 8D  	ld	de,(tmpDWORD2+2)
 900++AB83 C9           	ret
 901++AB84
 902++AB84              ; ᢮ ஢
 903++AB84 E1           goto043	pop	hl
 904++AB85 D1           	pop	de
 905++AB86 CD 79 AB     goto040	call	proc_05
 906++AB89 3E 49        	ld	a,errDiskNoSpace	;disk no space
 907++AB8B 37           	scf
 908++AB8C              ;訡 ⥭/
 909++AB8C C1           goto039	pop	bc
 910++AB8D C9           	ret
 911++AB8E
 912++AB8E              	endif
 913++AB8E
 914++AB8E              ;------------------------------------------------------------------------------
 915++AB8E              WriteSectorHDD	ifused
 916++AB8E ~            ; ᥪ  
 917++AB8E ~            ;:  hl -  ६  ஬ ࢮ  䠩
 918++AB8E ~            ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 919++AB8E ~            ;: hl -    
 920++AB8E ~            ;     cy=1 뫨 訡.  訡  A
 921++AB8E ~            ;       a=errRWnum
 922++AB8E ~            ;       a=errInvalidPart
 923++AB8E ~            ;       a=errEoF - 䠩 ࢠ
 924++AB8E ~            ;       a=errFileEmpty
 925++AB8E ~            ;
 926++AB8E ~            ;WriteSectorHDD
 927++AB8E ~            ;
 928++AB8E ~            	call	CalcAdrSecInFile	; LBA  ᥪ 䠩  
 929++AB8E ~            					;dehl - LBA  ᥪ
 930++AB8E ~            	ret	c			;訡:   । ࠧ ᪠
 931++AB8E ~            	hddSetCurrSec			;  ⠭  ६  LBA/CHS  ᨬ  ஥
 932++AB8E ~            	ld	hl,Buf4File
 933++AB8E ~            	hddWriteSecHL			; ᥪ    
 934++AB8E ~            	ret	nc			; 訡 
 935++AB8E ~            	ld	a,errRWnum		; 訡: 訡  ⥭   ᥪ 㭪ﬨ 5  6
 936++AB8E ~            	ret
 937++AB8E ~
 938++AB8E              	endif
 939++AB8E
 940++AB8E              ;------------------------------------------------------------------------------
 941++AB8E              ReadSectorHDD	ifused
 942++AB8E              ;⥭ ᥪ  
 943++AB8E              ;:  hl -  ६  ஬ ࢮ  䠩
 944++AB8E              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 945++AB8E              ;: ix,hl -    ⥭
 946++AB8E              ;     cy=1 뫨 訡.  訡  A
 947++AB8E              ;       a=errRWnum
 948++AB8E              ;       a=errInvalidPart
 949++AB8E              ;       a=errEoF - 䠩 ࢠ
 950++AB8E              ;       a=errFileEmpty
 951++AB8E              ;
 952++AB8E              ;ReadSectorHDD
 953++AB8E              ;
 954++AB8E CD A0 AB     	call	CalcAdrSecInFile; LBA  ᥪ 䠩  
 955++AB91              				;dehl - LBA  ᥪ
 956++AB91 D8           	ret	c		;訡:   । ࠧ ᪠
 957++AB92              	hddSetCurrSec		;  ⠭  ६  LBA/CHS  ᨬ  ஥
 957++AB92 CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 958++AB95 DD 21 B8 8D  	ld	ix,Buf4File
 959++AB99              	hddReadSec2IX		;⥭ ᥪ    
 959++AB99 CD 8B 9B    >	call	DrvHDD.RdSecHDD_IX
 960++AB9C D0           	ret	nc		;訡  뫮
 961++AB9D 3E 50        	ld	a,errRWnum
 962++AB9F C9           	ret
 963++ABA0
 964++ABA0              	endif
 965++ABA0
 966++ABA0              ;------------------------------------------------------------------------------
 967++ABA0              CalcAdrSecInMountFile	ifused		; 䏇
 968++ABA0 ~            ; LBA  ᥪ    ਬ஢ 䠩 (.trd)
 969++ABA0 ~            ;  ᫥ ࠡ⪨  楤 ᥪ   ⠭
 970++ABA0 ~            ;:  de - ᬥ饭  砫 䠩  ᥪ (512b)
 971++ABA0 ~            ;: cy=1 訡:   । ࠧ ᪠
 972++ABA0 ~            ;       a=errRWnum
 973++ABA0 ~            ;       a=errInvalidPart
 974++ABA0 ~            ;       a=errEoF - 䠩 ࢠ
 975++ABA0 ~            ;       a=errFileEmpty
 976++ABA0 ~            ;     cy=0 dehl - ᬥ饭  ᥪ (512b)  砫   㦭 ᥪ
 977++ABA0 ~            ;
 978++ABA0 ~            ;CalcAdrSecInMountFile
 979++ABA0 ~            ;
 980++ABA0 ~            	ld	hl,xE590+#01	;६  ஬ ࢮ  䠩
 981++ABA0 ~            	call	InitCurrMountFAT
 982++ABA0 ~            	jr	goto057
 983++ABA0 ~            	jr	CalcAdrSecInFile
 984++ABA0 ~            	org	$-2
 985++ABA0 ~
 986++ABA0              	endif
 987++ABA0
 988++ABA0              ;------------------------------------------------------------------------------
 989++ABA0              CalcAdrSecInFile	ifused
 990++ABA0              ; LBA  ᥪ 䠩  
 991++ABA0              ;  ᫥ ࠡ⪨  楤 ᥪ   ⠭
 992++ABA0              ;:  hl -  ६  ஬ ࢮ  䠩
 993++ABA0              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 994++ABA0              ;: cy=1 訡:   । ࠧ ᪠
 995++ABA0              ;       a=errRWnum
 996++ABA0              ;       a=errInvalidPart
 997++ABA0              ;       a=errEoF - 䠩 ࢠ
 998++ABA0              ;       a=errFileEmpty
 999++ABA0              ;     cy=0 dehl - LBA  ᥪ
1000++ABA0              ;
1001++ABA0              ;CalcAdrSecInFile
1002++ABA0              ;
1003++ABA0 CD A1 AD     	call	InitCurrFAT	;樠 ࠧ FAT, ᫨ 㦭
1004++ABA3 D8           goto057	ret	c
1005++ABA4
1006++ABA4              ; ᬥ饭  
1007++ABA4 7B           	ld	a,e
1008++ABA5 4B           	ld	c,e		;a,c -   ᬥ饭  
1009++ABA6 F5           	push	af
1010++ABA7 3A 76 8D     	ld	a,(LenCLSInSec)
1011++ABAA 47           	ld	b,a		;a,b - ࠧ   ᥪ
1012++ABAB F5           	push	af
1013++ABAC EB           	ex	de,hl
1014++ABAD D5           	push	de
1015++ABAE D5           	push	de
1016++ABAF 11 00 00     	ld	de,#0000	;dehl ᬥ饭  ᥪ  砫 䠩
1017++ABB2 CD 2F B4     	call	SRL_dehl_A	;hl ᬥ饭    砫 䠩
1018++ABB5
1019++ABB5              ;஢ઠ  㦥  ᥪ ⮣   
1020++ABB5              ;  hl - ᬥ饭    砫 䠩
1021++ABB5              ;  b  - ࠧ   ᥪ
1022++ABB5              ;  c  -   ᬥ饭  
1023++ABB5              ;
1024++ABB5              ;  ஢ਬ   䠩  ࠡ⠥
1025++ABB5 E3           	ex	(sp),hl
1026++ABB6 11 9A 8D     	ld	de,NumFstCluster
1027++ABB9 CD AD B3     	call	cmp_adrDE_adrHL	;ࠢ  4- ᫠  ᠬ  de  hl
1028++ABBC E1           	pop	hl
1029++ABBD 20 3D        	jr	nz,goto019	;䠩 㣮
1030++ABBF              ;  ஢ਬ   ஬ 䠩 ࠡ⠥
1031++ABBF ED 5B 9E 8D  	ld	de,(NumCluster)	;浪    ।騬 ⠭ ᥪ஬
1032++ABC3 EB           	ex	de,hl
1033++ABC4 B7           	or	a
1034++ABC5 ED 52        	sbc	hl,de
1035++ABC7 EB           	ex	de,hl
1036++ABC8 20 32        	jr	nz,goto019	;ᥪ 㣮 
1037++ABCA              ;   ᬥ饭  ᥪ  ⥪饬 
1038++ABCA 78           	ld	a,b
1039++ABCB 3D           	dec	a
1040++ABCC A1           	and	c
1041++ABCD 4F           	ld	c,a		;ᬥ饭    ᥪ
1042++ABCE 3A A0 8D     	ld	a,(NumSecCls)	;浪  ᥪ   
1043++ABD1 57           	ld	d,a
1044++ABD2 ED 44        	neg
1045++ABD4 81           	add	a,c
1046++ABD5 4F           	ld	c,a		;ᬥ饭 ⭮⥫쭮 㦥 ᥪ
1047++ABD6 5F           	ld	e,a		;ᬥ饭 ⭮⥫쭮 㦥 ᥪ
1048++ABD7 7A           	ld	a,d		;浪  ᥪ   
1049++ABD8 81           	add	a,c
1050++ABD9 B8           	cp	b
1051++ABDA 30 20        	jr	nc,goto019	;諨  ।  (᫮ த  ⭮)
1052++ABDC              ;     ᥪ
1053++ABDC E1           	pop	hl		; ६  ஬ ࢮ  䠩
1054++ABDD 32 A0 8D     	ld	(NumSecCls),a	;浪  ᥪ   
1055++ABE0 F1           	pop	af
1056++ABE1 F1           	pop	af
1057++ABE2 7B           	ld	a,e
1058++ABE3 07           	rlca
1059++ABE4 9F           	sbc	a,a
1060++ABE5 47           	ld	b,a
1061++ABE6 4B           	ld	c,e
1062++ABE7 ED 5B A3 8D  	ld	de,(SecFileInBuf+2)
1063++ABEB 2A A1 8D     	ld	hl,(SecFileInBuf)
1064++ABEE 38 06        	jr	c,goto020	;⠭
1065++ABF0 09           	add	hl,bc		;᫮
1066++ABF1 30 34        	jr	nc,goto021
1067++ABF3 13           	inc	de
1068++ABF4 18 31        	jr	goto021
1069++ABF6 09           goto020	add	hl,bc		;⠭
1070++ABF7 38 2E        	jr	c,goto021
1071++ABF9 1B           	dec	de
1072++ABFA 18 2B        	jr	goto021
1073++ABFC
1074++ABFC              ;  ᥪ
1075++ABFC 22 9E 8D     goto019	ld	(NumCluster),hl
1076++ABFF 4D           	ld	c,l
1077++AC00 44           	ld	b,h
1078++AC01 E1           	pop	hl
1079++AC02 CD 0D B4     	call	LD_DEHL_adrHL	;dehl - ; ࢮ  䠩
1080++AC05 ED 53 9C 8D  	ld	(NumFstCluster+2),de
1081++AC09 22 9A 8D     	ld	(NumFstCluster),hl
1082++AC0C CD 3B AC     	call	FindCLSinFile	;    ᬥ饭  砫 䠩/⠫
1083++AC0F 38 21        	jr	c,goto023	;訡. 뢠 㭪
1084++AC11 28 1D        	jr	z,goto022	;䠩 ⮩
1085++AC13 CD 60 AF     	call	GetAdrRealSector;dehl  ᥪ
1086++AC16 F1           	pop	af		;a - ࠧ   ᥪ
1087++AC17 3D           	dec	a
1088++AC18 4F           	ld	c,a
1089++AC19 F1           	pop	af		;ᬥ饭  ᥪ  砫 䠩
1090++AC1A A1           	and	c
1091++AC1B 4F           	ld	c,a
1092++AC1C 06 00        	ld	b,#00		;ᬥ饭    ᥪ
1093++AC1E 32 A0 8D     	ld	(NumSecCls),a
1094++AC21 09           	add	hl,bc
1095++AC22 EB           	ex	de,hl
1096++AC23 48           	ld	c,b
1097++AC24 ED 4A        	adc	hl,bc
1098++AC26 EB           	ex	de,hl		;dehl -   ᥪ
1099++AC27 ED 53 A3 8D  goto021	ld	(SecFileInBuf+2),de
1100++AC2B 22 A1 8D     	ld	(SecFileInBuf),hl
1101++AC2E B7           	or	a
1102++AC2F C9           	ret
1103++AC30
1104++AC30              ;訡: 䠩 ⮩
1105++AC30 3E 75        goto022	ld	a,errFileEmpty	; 訡:   । ࠧ ᪠
1106++AC32              ;訡 ⥭/
1107++AC32 21 9F 8D     goto023	ld	hl,NumCluster+#01
1108++AC35 36 FF        	ld	(hl),#FF
1109++AC37 C1           error2	pop	bc
1110++AC38 C1           	pop	bc
1111++AC39 37           	scf
1112++AC3A C9           	ret
1113++AC3B
1114++AC3B              	endif
1115++AC3B
1116++AC3B              ;------------------------------------------------------------------------------
1117++AC3B              FindCLSinFile	ifused
1118++AC3B              ;    ᬥ饭  砫 䠩/⠫
1119++AC3B              ;:  dehl -  ࢮ  䠩/⠫
1120++AC3B              ;     bc - ᬥ饭  砫 䠩/⠫  
1121++AC3B              ;: cy=1 訡 ⥭/
1122++AC3B              ;       a=errRWnum
1123++AC3B              ;       a=errInvalidPart
1124++AC3B              ;       a=errEoF - 䠩 ࢠ
1125++AC3B              ;     cy=0
1126++AC3B              ;        z - 䠩 ⮩
1127++AC3B              ;        nz -> a =#01 - dehl   
1128++AC3B              ;     hl',de',bc' - ???
1129++AC3B              ;
1130++AC3B              ;FindCLSinFile
1131++AC3B              ;
1132++AC3B              ;஢ਬ  㤠  䠩
1133++AC3B              	IFDEF	forProfROM
1134++AC3B ~            	 CheckDelFile
1135++AC3B ~            	 jr	nz,loop010	;஢ઠ  㦭
1136++AC3B ~            	 push	hl
1137++AC3B ~            	 push	de
1138++AC3B ~            	 push	bc
1139++AC3B ~            	 call	ReadFATnextCls	;⥭  ண 
1140++AC3B ~            	 jr	c,goto045
1141++AC3B ~            	 ld	a,d
1142++AC3B ~            	 or	e
1143++AC3B ~            	 or	h
1144++AC3B ~            	 or	l
1145++AC3B ~            	 pop	bc
1146++AC3B ~            	 pop	de
1147++AC3B ~            	 pop	hl
1148++AC3B ~            	 scf
1149++AC3B ~            	 jr	z,goto017	;᫨ =0,  䠩 㤠
1150++AC3B              	ENDIF
1151++AC3B              	IFDEF	forRRL
1152++AC3B ~            	 CheckDelFile
1153++AC3B ~            	 jr	nz,loop010	;஢ઠ  㦭
1154++AC3B ~            	 push	hl
1155++AC3B ~            	 push	de
1156++AC3B ~            	 push	bc
1157++AC3B ~            	 call	ReadFATnextCls	;⥭  ண 
1158++AC3B ~            	 jr	c,goto045
1159++AC3B ~            	 ld	a,d
1160++AC3B ~            	 or	e
1161++AC3B ~            	 or	h
1162++AC3B ~            	 or	l
1163++AC3B ~            	 pop	bc
1164++AC3B ~            	 pop	de
1165++AC3B ~            	 pop	hl
1166++AC3B ~            	 scf
1167++AC3B ~            	 jr	z,goto017	;᫨ =0,  䠩 㤠
1168++AC3B              	ENDIF
1169++AC3B
1170++AC3B              ;஢ઠ  ⮩  䠩
1171++AC3B 7A           loop010	ld	a,d
1172++AC3C B3           	or	e
1173++AC3D B4           	or	h
1174++AC3E B5           	or	l
1175++AC3F C8           	ret	z		;䠩 ⮩
1176++AC40 7C           	ld	a,h
1177++AC41 A5           	and	l
1178++AC42 A3           	and	e
1179++AC43 3C           	inc	a
1180++AC44 20 05        	jr	nz,goto145
1181++AC46 7A           	ld	a,d
1182++AC47 FE 0F        	cp	#0F
1183++AC49 28 14        	jr	z,goto144	;䠩 稫
1184++AC4B              ;      ⠡ FAT
1185++AC4B 78           goto145	ld	a,b
1186++AC4C B1           	or	c
1187++AC4D 28 0E        	jr	z,goto018	;dehl -   
1188++AC4F CD CA B0     	call	TestLastCLS
1189++AC52 38 0C        	jr	c,goto017	;䠩 ࢠ
1190++AC54 C5           	push	bc
1191++AC55 CD DD B0     	call	ReadFATnextCls	;⥭  ᫥饣 
1192++AC58 C1           	pop	bc
1193++AC59 D8           	ret	c
1194++AC5A 0B           	dec	bc
1195++AC5B 18 DE        	jr	loop010
1196++AC5D 3C           goto018	inc	a
1197++AC5E C9           	ret
1198++AC5F 37           goto144	scf
1199++AC60 3E 71        goto017	ld	a,errEoF
1200++AC62 C9           	ret
1201++AC63              	IFDEF	forProfROM
1202++AC63 ~            goto045  pop	bc
1203++AC63 ~             	 pop	de
1204++AC63 ~            	 pop	hl
1205++AC63 ~            	 ret
1206++AC63              	ENDIF
1207++AC63              	IFDEF	forRRL
1208++AC63 ~            goto045  pop	bc
1209++AC63 ~             	 pop	de
1210++AC63 ~            	 pop	hl
1211++AC63 ~            	 ret
1212++AC63              	ENDIF
1213++AC63
1214++AC63              	endif
1215++AC63
1216++AC63              ;==============================================================================
1217++AC63
# file closed: Drivers/DrvFAT/DrvFAT.file.a80
 133+ AC63              	INCLUDE	"DrvFAT.fcb.a80"
# file opened: Drivers/DrvFAT/DrvFAT.fcb.a80
   1++AC63              ;楤  FAT Driver.   ஬ fcb
   2++AC63              ;䠩 DrvFAT.fcb.a80
   3++AC63              ;
   4++AC63              ;fcbRenameEntry		२   ⠫
   5++AC63              ;fcbWriteToEntry	  fcb  ⠫
   6++AC63              ;fcbFindEntry		   ⠫  ࠭ ⥪饣 
   7++AC63              ;			 ࠧ  fcb
   8++AC63              ;--fcbSetInEntryClsSize	⠭  ਯ 䠩  ࢮ  
   9++AC63              ;			ࠧ  fcb
  10++AC63              ;fcbSetEntryFromFcb	⠭  ਯ 䠩 , ਡ⮢, 
  11++AC63              ;			ࢮ   ࠧ  fcb
  12++AC63              ;fcbExxCLSCurrDir	६ ⠭()  fcb  
  13++AC63              ;			⥪饣 ⠫  ⥪饣 ࠧ
  14++AC63              ;fcbSetCLSCurrDir	⠭  fcb   ⠫-த⥫
  15++AC63              ;fcbSetFromEntry	⠭ fcb   ᭮ ਯ 䠩
  16++AC63              ;fcbClsFile2fcbClsDIR	஢  fcbClsFile   fcbClsDIR
  17++AC63              ;add2OffsetEOF_L	饭 㪠⥫  䠩  ஫ 室 
  18++AC63              ;			। 䠩
  19++AC63              ;add2OffsetEOF_HL	饭 㪠⥫  䠩  ஫ 室 
  20++AC63              ;			। 䠩
  21++AC63              ;add2OffsetEOF_EHL	饭 㪠⥫  䠩  ஫ 室 
  22++AC63              ;			। 䠩
  23++AC63              ;add2OffsetEOF_DEHL	饭 㪠⥫  䠩  ஫ 室 
  24++AC63              ;			। 䠩
  25++AC63              ;DEHL2fcbOffset_EoF	㧪  fcbOffset 㪠⥫  䠩  dehl
  26++AC63              ;			 ஫ 室  । 䠩
  27++AC63              ;DEHL2fcbOffset		㧪  fcbOffset 㪠⥫  䠩
  28++AC63              ;DEHL2fcbClsDIR		㧪  fcbClsDIR  ࢮ  ⠫
  29++AC63              ;			 䠩
  30++AC63              ;DEHL2fcbSize		㧪  fcbSize ࠧ 䠩    dehl
  31++AC63              ;DEHL2fcbClsFile	㧪  fcbClsFile  ࢮ   dehl
  32++AC63              ;LD_DEHL_fcbOffset	㧪  dehl  fcbOffset  fcb
  33++AC63              ;LD_DEHL_fcbSize	㧪  dehl  fcbSize  fcb
  34++AC63              ;LD_DEHL_fcbClsFile	㧪  dehl  ࢮ  䠩  fcb
  35++AC63              ;
  36++AC63              ;------------------------------------------------------------------------------
  37++AC63              fcbRenameEntry	ifused
  38++AC63 ~            ;२   ⠫
  39++AC63 ~            ;   fcb   ⠭: fcbName, fcbExt
  40++AC63 ~            ;:  ix -  fcb   塞  ⠫
  41++AC63 ~            ;     hl -     asciz  ଠ 8+3  8.3
  42++AC63 ~            ;: cy=1 訡 ⥭/
  43++AC63 ~            ;       a=errRWnum
  44++AC63 ~            ;       a=errInvalidPart
  45++AC63 ~            ;       a=errEoF - 䠩 ࢠ
  46++AC63 ~            ;       a=errFileEmpty - ⮩ ୥ ⠫
  47++AC63 ~            ;       a=errFileNotFound
  48++AC63 ~            ;
  49++AC63 ~            ;fcbRenameEntry
  50++AC63 ~            ;
  51++AC63 ~            ;饬   ⠫
  52++AC63 ~            	push	ix
  53++AC63 ~            	ex	(sp),hl
  54++AC63 ~            	call	fcbFindEntry
  55++AC63 ~            	jr	c,goto136
  56++AC63 ~
  57++AC63 ~            ; 
  58++AC63 ~            	ex	de,hl
  59++AC63 ~            	ex	(sp),hl
  60++AC63 ~            	push	hl
  61++AC63 ~            	call	FileNameTo8dot3		;⠭    fcb 
  62++AC63 ~            	pop	hl
  63++AC63 ~            	pop	de
  64++AC63 ~            	call	FileNameTo8dot3		;⠭    ਯ
  65++AC63 ~            	jr	goto137			; ᥪ     Buf4DIR
  66++AC63 ~
  67++AC63 ~            ;室
  68++AC63 ~            goto136	pop	hl
  69++AC63 ~            	ret
  70++AC63 ~
  71++AC63              	endif
  72++AC63
  73++AC63              ;------------------------------------------------------------------------------
  74++AC63              fcbWriteToEntry	ifused
  75++AC63              ;  fcb  ⠫
  76++AC63              ;   fcb   ⠭: fcbName, fcbExt, fcbAttr, fcbClsFile, fcbSize)
  77++AC63              ;:  ix -  fcb   塞  ⠫
  78++AC63              ;: cy=1 訡 ⥭/
  79++AC63              ;       a=errRWnum
  80++AC63              ;       a=errInvalidPart
  81++AC63              ;       a=errEoF - 䠩 ࢠ
  82++AC63              ;       a=errFileEmpty - ⮩ ୥ ⠫
  83++AC63              ;       a=errFileNotFound
  84++AC63              ;
  85++AC63              ;fcbWriteToEntry
  86++AC63              ;
  87++AC63              ;饬   ⠫
  88++AC63 DD E5        	push	ix
  89++AC65 E1           	pop	hl
  90++AC66 CD 70 AC     	call	fcbFindEntry
  91++AC69 D8           	ret	c
  92++AC6A
  93++AC6A              ; 
  94++AC6A CD 85 AC     	call	fcbSetEntryFromFcb	;⠭ ࠬ  ਯ
  95++AC6D C3 54 B1     goto137	jp	SaveSecBuf2DIR		; ᥪ     Buf4DIR
  96++AC70
  97++AC70              	endif
  98++AC70
  99++AC70              ;------------------------------------------------------------------------------
 100++AC70              fcbFindEntry	ifused
 101++AC70              ;   ⠫  ࠭ ⥪饣   ࠧ  fcb
 102++AC70              ;   fcb   ⠭: fcbName, fcbExt
 103++AC70              ;:  ix -  fcb 
 104++AC70              ;     hl -   䠩 asciz  ଠ 8+3  8.3
 105++AC70              ;: cy=1 訡 ⥭/,   
 106++AC70              ;       a=errRWnum
 107++AC70              ;       a=errInvalidPart
 108++AC70              ;       a=errEoF - 䠩 ࢠ
 109++AC70              ;       a=errFileEmpty - ⮩ ୥ ⠫
 110++AC70              ;	a=errFileNotFound
 111++AC70              ;     cy=0   (fcb  !!!)
 112++AC70              ;       de -  ਯ  
 113++AC70              ;       bc -    ⠫
 114++AC70              ;     hl -  
 115++AC70              ;
 116++AC70              ;fcbFindEntry
 117++AC70              ;
 118++AC70 E5           	push	hl
 119++AC71 CD AB AC     	call	fcbExxCLSCurrDir
 120++AC74 CD 29 A8     	call	fatFindEntryDir
 121++AC77 E1           	pop	hl
 122++AC78 38 05        	jr	c,goto101
 123++AC7A 28 03        	jr	z,goto101
 124++AC7C 37           	scf
 125++AC7D 3E 48        	ld	a,errFileNotFound
 126++AC7F
 127++AC7F              ;室
 128++AC7F F5           goto101	push	af
 129++AC80 CD AB AC     	call	fcbExxCLSCurrDir
 130++AC83 F1           	pop	af
 131++AC84 C9           	ret
 132++AC85
 133++AC85              	endif
 134++AC85
 135++AC85              ;------------------------------------------------------------------------------
 136++AC85              fcbSetEntryFromFcb	ifused
 137++AC85              ;⠭  ਯ 䠩 , ਡ⮢,  ࢮ 
 138++AC85              ;   ࠧ  fcb
 139++AC85              ;:  ix -  fcb 
 140++AC85              ;     de -  ਯ  
 141++AC85              ;: bc=#0000
 142++AC85              ;
 143++AC85              ;fcbSetEntryFromFcb
 144++AC85              ;
 145++AC85              ;⠭   ਡ
 146++AC85 DD E5        	push	ix
 147++AC87 E1           	pop	hl
 148++AC88 01 0C 00     	ld	bc,#000C
 149++AC8B ED B0        	ldir
 150++AC8D
 151++AC8D              ;⠭  ࢮ 
 152++AC8D EB           	ex	de,hl
 153++AC8E 0E 0E        	ld	c,#0E
 154++AC90 09           	add	hl,bc		;nc (   )
 155++AC91 EB           	ex	de,hl		;de +#1A
 156++AC92 ED A0        	ldi			;襥 ᫮ 
 157++AC94 ED A0        	ldi
 158++AC96 EB           	ex	de,hl
 159++AC97 0E 08        	ld	c,#08
 160++AC99 ED 42        	sbc	hl,bc
 161++AC9B EB           	ex	de,hl		;de +#14
 162++AC9C ED A0        	ldi			;襥 ᫮ 
 163++AC9E ED A0        	ldi
 164++ACA0 EB           	ex	de,hl
 165++ACA1 0E 06        	ld	c,#06
 166++ACA3 09           	add	hl,bc
 167++ACA4 EB           	ex	de,hl		;de +#1C
 168++ACA5 0E 04        	ld	c,#04
 169++ACA7 09           	add	hl,bc
 170++ACA8 ED B0        	ldir			;ࠧ
 171++ACAA
 172++ACAA C9           	ret
 173++ACAB
 174++ACAB              	endif
 175++ACAB
 176++ACAB              ;------------------------------------------------------------------------------
 177++ACAB              fcbExxCLSCurrDir	ifused
 178++ACAB              ;६ ⠭()  fcb   ⥪饣 ⠫   ⥪饣
 179++ACAB              ;  ࠧ
 180++ACAB              ;:  ix -  fcb 
 181++ACAB              ;: hl,de,bc -  
 182++ACAB              ;
 183++ACAB              ;fcbExxCLSCurrDir
 184++ACAB              ;
 185++ACAB E5           	push	hl
 186++ACAC D5           	push	de
 187++ACAD C5           	push	bc
 188++ACAE 3A 83 8D     	ld	a,(CurrentLevel)
 189++ACB1 F5           	push	af
 190++ACB2 21 5B 8B     	ld	hl,PartitionNum
 191++ACB5 4E           	ld	c,(hl)
 192++ACB6 DD 71 1C     	ld	(ix+fcbStore),c
 193++ACB9 DD 7E 1F     	ld	a,(ix+fcbPart)
 194++ACBC 77           	ld	(hl),a
 195++ACBD DD 71 1F     	ld	(ix+fcbPart),c
 196++ACC0 CD A4 AD     	call	InitFAT32
 197++ACC3 F1           	pop	af
 198++ACC4 32 83 8D     	ld	(CurrentLevel),a
 199++ACC7
 200++ACC7 DD E5        	push	ix
 201++ACC9 E1           	pop	hl
 202++ACCA 11 10 00     	ld	de,fcbClsDIR
 203++ACCD 19           	add	hl,de
 204++ACCE CD 6A B3     	call	excngCLSCurrDir
 205++ACD1 C1           	pop	bc
 206++ACD2 D1           	pop	de
 207++ACD3 E1           	pop	hl
 208++ACD4 C9           	ret
 209++ACD5
 210++ACD5              	endif
 211++ACD5
 212++ACD5              ;------------------------------------------------------------------------------
 213++ACD5              fcbSetCLSCurrDir	ifused
 214++ACD5              ;⠭  fcb   ⠫-த⥫
 215++ACD5              ;:  ix -  fcb 
 216++ACD5              ;: cy=1 訡 ⥭/
 217++ACD5              ;       a=errRWnum
 218++ACD5              ;       a=errInvalidPart
 219++ACD5              ;       a=errEoF - 䠩 ࢠ
 220++ACD5              ;       a=errFileEmpty - ⮩ ୥ ⠫
 221++ACD5              ;       a=errFileNotFound
 222++ACD5              ;
 223++ACD5              ;fcbSetCLSCurrDir
 224++ACD5              ;
 225++ACD5 D5           	push	de
 226++ACD6 E5           	push	hl
 227++ACD7 18 34        	jr	goto175
 228++ACD9 18 FE        	jr	fcbSetFromEntry
 229++ACDB              	org	$-2
 230++ACD9
 231++ACD9              	endif
 232++ACD9
 233++ACD9              ;------------------------------------------------------------------------------
 234++ACD9              fcbSetFromEntry	ifused
 235++ACD9              ;⠭ fcb   ᭮ ਯ 䠩
 236++ACD9              ;:  ix -  fcb 
 237++ACD9              ;     hl -  ਯ 䠩
 238++ACD9              ;     (CLS_CurrDir)  ⠫  䠩
 239++ACD9              ;: hl -  ਯ 䠩
 240++ACD9              ;
 241++ACD9              ;fcbSetFromEntry
 242++ACD9              ;
 243++ACD9 D5           	push	de
 244++ACDA E5           	push	hl
 245++ACDB F5           	push	af
 246++ACDC
 247++ACDC              ; 䠩  ਡ
 248++ACDC DD E5        	push	ix
 249++ACDE D1           	pop	de
 250++ACDF 01 0C 00     	ld	bc,#000C
 251++ACE2 ED B0        	ldir
 252++ACE4
 253++ACE4              ; ࢮ 
 254++ACE4 0E 08        	ld	c,#08
 255++ACE6 09           	add	hl,bc		;   (hi)
 256++ACE7 E5           	push	hl
 257++ACE8 0E 08        	ld	c,#08
 258++ACEA 09           	add	hl,bc		; ࠧ 䠩
 259++ACEB E3           	ex	(sp),hl
 260++ACEC 5E           	ld	e,(hl)
 261++ACED 23           	inc	hl
 262++ACEE 56           	ld	d,(hl)
 263++ACEF 0E 05        	ld	c,#05
 264++ACF1 09           	add	hl,bc
 265++ACF2 7E           	ld	a,(hl)
 266++ACF3 23           	inc	hl
 267++ACF4 66           	ld	h,(hl)
 268++ACF5 6F           	ld	l,a
 269++ACF6 CD 80 AD     	call	DEHL2fcbClsFile
 270++ACF9 E1           	pop	hl		; ࠧ 䠩
 271++ACFA
 272++ACFA              ;ࠧ 䠩
 273++ACFA CD 0D B4     	call	LD_DEHL_adrHL
 274++ACFD CD 73 AD     	call	DEHL2fcbSize
 275++AD00
 276++AD00              ;㪠⥫  䠩 =#00000000
 277++AD00 CD BF B3     	call	SetZeroDEHL
 278++AD03 CD 59 AD     	call	DEHL2fcbOffset
 279++AD06
 280++AD06              ; ⥪饣   ࠧ  
 281++AD06 3A 5B 8B     	ld	a,(PartitionNum)
 282++AD09 DD 77 1F     	ld	(ix+fcbPart),a
 283++AD0C
 284++AD0C F1           	pop	af
 285++AD0D
 286++AD0D              ;  ⠫
 287++AD0D ED 5B 86 8D  goto175	ld	de,(CLS_CurrDir+2)
 288++AD11 2A 84 8D     	ld	hl,(CLS_CurrDir)
 289++AD14 CD 66 AD     	call	DEHL2fcbClsDIR
 290++AD17
 291++AD17 E1           	pop	hl
 292++AD18 D1           	pop	de
 293++AD19 C9           	ret
 294++AD1A
 295++AD1A              	endif
 296++AD1A
 297++AD1A              ;------------------------------------------------------------------------------
 298++AD1A              fcbClsFile2fcbClsDIR	ifused
 299++AD1A ~            ;஢  fcbClsFile   cbClsDIR
 300++AD1A ~            ;:  ix -  fcb 
 301++AD1A ~            ;
 302++AD1A ~            ;fcbClsFile2fcbClsDIR
 303++AD1A ~            ;
 304++AD1A ~            	push	ix
 305++AD1A ~            	pop	hl
 306++AD1A ~            	ld	de,fcbClsFile
 307++AD1A ~            	add	hl,de
 308++AD1A ~            	ex	de,hl
 309++AD1A ~            	ld	l,fcbClsDIR-fcbClsFile
 310++AD1A ~            	add	hl,de
 311++AD1A ~            	ex	de,hl
 312++AD1A ~            	jp	CopyDWORD_HL_DE
 313++AD1A ~
 314++AD1A              	endif
 315++AD1A
 316++AD1A              ;------------------------------------------------------------------------------
 317++AD1A              ;饭 㪠⥫  䠩
 318++AD1A              ;:  ix -  fcb 
 319++AD1A              ;:  [d][e][h]l - 稭 饭
 320++AD1A              ;: cy=0 㪠⥫ ⠭
 321++AD1A              ;       dehl - 㪠⥫
 322++AD1A              ;
 323++AD1A              add2Offset_L	ifused
 324++AD1A ~            ;
 325++AD1A ~            	ld	h,#00
 326++AD1A ~            	jr	add2Offset_HL
 327++AD1A ~            	org	$-2
 328++AD1A              	endif
 329++AD1A
 330++AD1A              add2Offset_HL	ifused
 331++AD1A              ;
 332++AD1A 1E 00        	ld	e,#00
 333++AD1C 18 FE        	jr	add2Offset_EHL
 334++AD1E              	org	$-2
 335++AD1C              	endif
 336++AD1C
 337++AD1C
 338++AD1C              add2Offset_EHL	ifused
 339++AD1C              ;
 340++AD1C 16 00        	ld	d,#00
 341++AD1E 18 FE        	jr	add2Offset_DEHL
 342++AD20              	org	$-2
 343++AD1E              	endif
 344++AD1E
 345++AD1E
 346++AD1E              add2Offset_DEHL	ifused
 347++AD1E              ;
 348++AD1E C5           	push	bc
 349++AD1F D5           	push	de
 350++AD20 E5           	push	hl
 351++AD21 CD 8D AD     	call	LD_DEHL_fcbOffset
 352++AD24 C1           	pop	bc
 353++AD25 09           	add	hl,bc
 354++AD26 C1           	pop	bc
 355++AD27 EB           	ex	de,hl
 356++AD28 ED 4A        	adc	hl,bc
 357++AD2A EB           	ex	de,hl
 358++AD2B C1           	pop	bc
 359++AD2C 18 2B        	jr	DEHL2fcbOffset
 360++AD2E
 361++AD2E              	endif
 362++AD2E
 363++AD2E              ;------------------------------------------------------------------------------
 364++AD2E              ;饭 㪠⥫  䠩  ஫ 室  । 䠩
 365++AD2E              ;:  ix -  fcb 
 366++AD2E              ;:  [d][e][h]l - 稭 饭
 367++AD2E              ;: cy=1 㪠⥫   । 䠩 -> ⠭  砫
 368++AD2E              ;       dehl =#00000000
 369++AD2E              ;     cy=0 㪠⥫ ⠭
 370++AD2E              ;       dehl - 㪠⥫
 371++AD2E              ;
 372++AD2E              add2OffsetEOF_L		ifused
 373++AD2E              ;
 374++AD2E 26 00        	ld	h,#00
 375++AD30 18 FE        	jr	add2OffsetEOF_HL
 376++AD32              	org	$-2
 377++AD30              	endif
 378++AD30
 379++AD30              add2OffsetEOF_HL	ifused
 380++AD30              ;
 381++AD30 1E 00        	ld	e,#00
 382++AD32 18 FE        	jr	add2OffsetEOF_EHL
 383++AD34              	org	$-2
 384++AD32              	endif
 385++AD32
 386++AD32
 387++AD32              add2OffsetEOF_EHL	ifused
 388++AD32              ;
 389++AD32 16 00        	ld	d,#00
 390++AD34 18 FE        	jr	add2OffsetEOF_DEHL
 391++AD36              	org	$-2
 392++AD34              	endif
 393++AD34
 394++AD34
 395++AD34              add2OffsetEOF_DEHL	ifused
 396++AD34              ;
 397++AD34 C5           	push	bc
 398++AD35 D5           	push	de
 399++AD36 E5           	push	hl
 400++AD37 CD 8D AD     	call	LD_DEHL_fcbOffset
 401++AD3A C1           	pop	bc
 402++AD3B 09           	add	hl,bc
 403++AD3C C1           	pop	bc
 404++AD3D EB           	ex	de,hl
 405++AD3E ED 4A        	adc	hl,bc
 406++AD40 EB           	ex	de,hl
 407++AD41 C1           	pop	bc
 408++AD42 18 FE        	jr	DEHL2fcbOffset_EoF
 409++AD44              	org	$-2
 410++AD42
 411++AD42              	endif
 412++AD42
 413++AD42              ;------------------------------------------------------------------------------
 414++AD42              DEHL2fcbOffset_EoF	ifused
 415++AD42              ;㧪  fcbOffset 㪠⥫  䠩  dehl  ஫ 室  ।
 416++AD42              ;  䠩
 417++AD42              ;:  ix -  fcb 
 418++AD42              ;     dehl - 㪠⥫  䠩
 419++AD42              ;: cy=1 㪠⥫   । 䠩 -> ⠭  砫
 420++AD42              ;       dehl =#00000000
 421++AD42              ;     cy=0 㪠⥫ ⠭
 422++AD42              ;       dehl - 㪠⥫
 423++AD42              ;
 424++AD42              ;DEHL2fcbOffset_EoF
 425++AD42              ;
 426++AD42 C5           	push	bc
 427++AD43 DD E5        	push	ix
 428++AD45 E3           	ex	(sp),hl
 429++AD46 01 14 00     	ld	bc,fcbSize
 430++AD49 09           	add	hl,bc
 431++AD4A 4D           	ld	c,l
 432++AD4B 44           	ld	b,h
 433++AD4C E1           	pop	hl
 434++AD4D CD D1 B3     	call	cmp_DEHL_adrBC
 435++AD50 C1           	pop	bc
 436++AD51 38 03        	jr	c,goto096
 437++AD53 20 04        	jr	nz,DEHL2fcbOffset
 438++AD55 37                   scf
 439++AD56 CD BF B3     goto096	call	SetZeroDEHL
 440++AD59
 441++AD59              	endif
 442++AD59
 443++AD59              ;------------------------------------------------------------------------------
 444++AD59              DEHL2fcbOffset	ifused
 445++AD59              ;㧪  fcbOffset 㧪  fcbOffset 㪠⥫  䠩
 446++AD59              ;:  ix -  fcb 
 447++AD59              ;     dehl - 㪠⥫  䠩
 448++AD59              ;
 449++AD59              ;DEHL2fcbOffset
 450++AD59              ;
 451++AD59 DD 75 18     	ld	(ix+fcbOffset),l
 452++AD5C DD 74 19     	ld	(ix+fcbOffset+1),h
 453++AD5F DD 73 1A     	ld	(ix+fcbOffset+2),e
 454++AD62 DD 72 1B     	ld	(ix+fcbOffset+3),d
 455++AD65 C9           	ret
 456++AD66
 457++AD66              	endif
 458++AD66
 459++AD66              ;------------------------------------------------------------------------------
 460++AD66              DEHL2fcbClsDIR	ifused
 461++AD66              ;㧪  fcbClsDIR  ࢮ  ⠫  䠩
 462++AD66              ;:  ix -  fcb 
 463++AD66              ;     dehl -   ⠫
 464++AD66              ;
 465++AD66              ;DEHL2fcbClsDIR
 466++AD66              ;
 467++AD66 DD 75 10     	ld	(ix+fcbClsDIR),l
 468++AD69 DD 74 11     	ld	(ix+fcbClsDIR+1),h
 469++AD6C DD 73 12     	ld	(ix+fcbClsDIR+2),e
 470++AD6F DD 72 13     	ld	(ix+fcbClsDIR+3),d
 471++AD72 C9           	ret
 472++AD73
 473++AD73              	endif
 474++AD73
 475++AD73              ;------------------------------------------------------------------------------
 476++AD73              DEHL2fcbSize	ifused
 477++AD73              ;㧪  fcbSize ࠧ 䠩    dehl
 478++AD73              ;:  ix -  fcb 
 479++AD73              ;     dehl - ࠧ 䠩
 480++AD73              ;
 481++AD73              ;DEHL2fcbSize
 482++AD73              ;
 483++AD73 DD 75 14     	ld	(ix+fcbSize),l
 484++AD76 DD 74 15     	ld	(ix+fcbSize+1),h
 485++AD79 DD 73 16     	ld	(ix+fcbSize+2),e
 486++AD7C DD 72 17     	ld	(ix+fcbSize+3),d
 487++AD7F C9           	ret
 488++AD80
 489++AD80              	endif
 490++AD80
 491++AD80              ;------------------------------------------------------------------------------
 492++AD80              DEHL2fcbClsFile	ifused
 493++AD80              ;㧪  fcbClsFile  ࢮ   dehl
 494++AD80              ;:  ix -  fcb 
 495++AD80              ;     dehl -  ࢮ  䠩
 496++AD80              ;
 497++AD80              ;DEHL2fcbClsFile
 498++AD80              ;
 499++AD80 DD 75 0C     	ld	(ix+fcbClsFile),l
 500++AD83 DD 74 0D     	ld	(ix+fcbClsFile+1),h
 501++AD86 DD 73 0E     	ld	(ix+fcbClsFile+2),e
 502++AD89 DD 72 0F     	ld	(ix+fcbClsFile+3),d
 503++AD8C C9           	ret
 504++AD8D
 505++AD8D              	endif
 506++AD8D
 507++AD8D              ;------------------------------------------------------------------------------
 508++AD8D              LD_DEHL_fcbOffset	ifused
 509++AD8D              ;㧪  dehl  fcbOffset  fcb
 510++AD8D              ;:  ix -  fcb 
 511++AD8D              ;: dehl - 㪠⥫  䠩
 512++AD8D              ;
 513++AD8D              ;LD_DEHL_fcbOffset
 514++AD8D              ;
 515++AD8D 11 18 00     	ld	de,fcbOffset
 516++AD90 18 08        	jr	goto044
 517++AD92 18 03        	jr	LD_DEHL_fcbClsFile
 518++AD94              	org	$-2
 519++AD92
 520++AD92              	endif
 521++AD92
 522++AD92              ;------------------------------------------------------------------------------
 523++AD92              LD_DEHL_fcbSize	ifused
 524++AD92              ;㧪  dehl  fcbSize  fcb
 525++AD92              ;:  ix -  fcb 
 526++AD92              ;: dehl - ࠧ 䠩  
 527++AD92              ;
 528++AD92              ;LD_DEHL_fcbSize
 529++AD92              ;
 530++AD92 11 14 00     	ld	de,fcbSize
 531++AD95 18 03        	jr	goto044
 532++AD97 18 FE        	jr	LD_DEHL_fcbClsFile
 533++AD99              	org	$-2
 534++AD97
 535++AD97              	endif
 536++AD97
 537++AD97              ;------------------------------------------------------------------------------
 538++AD97              LD_DEHL_fcbClsFile	ifused
 539++AD97              ;㧪  dehl  ࢮ  䠩  fcb
 540++AD97              ;:  ix -  fcb 
 541++AD97              ;: dehl -  ࢮ  䠩
 542++AD97              ;
 543++AD97              ;LD_DEHL_fcbClsFile
 544++AD97              ;
 545++AD97 11 0C 00     	ld	de,fcbClsFile
 546++AD9A DD E5        goto044	push	ix
 547++AD9C E1           	pop	hl
 548++AD9D 19           	add	hl,de
 549++AD9E C3 0D B4     	jp	LD_DEHL_adrHL
 550++ADA1
 551++ADA1              	endif
 552++ADA1
 553++ADA1              ;==============================================================================
 554++ADA1
# file closed: Drivers/DrvFAT/DrvFAT.fcb.a80
 134+ ADA1              	INCLUDE	"DrvFAT.init.a80"
# file opened: Drivers/DrvFAT/DrvFAT.init.a80
   1++ADA1              ;楤  FAT Driver. 樠 ६ FAT32 ࠧ.
   2++ADA1              ;䠩 DrvFAT.init.a80
   3++ADA1              ;
   4++ADA1              ;InitCurrMountFAT	樠 ࠧ FAT  ⥪騬 祭 ࠧ
   5++ADA1              ;InitCurrFAT		樠 ⥪饣 ࠧ FAT  室
   6++ADA1              ;InitFAT32		樠 ࠧ FAT
   7++ADA1              ;InitFATpartition	樠 ६ ࠭ ࠧ FAT
   8++ADA1              ;setRootDir		⠭ ୥ ⠫ ⥪騬
   9++ADA1              ;DeinitFATpart		樠 ६ ࠧ FAT
  10++ADA1              ;DeinitFATbuf		樠 ஢ ࠧ FAT
  11++ADA1              ;
  12++ADA1              ;------------------------------------------------------------------------------
  13++ADA1              	IFDEF	forProfROM
  14++ADA1 ~            ;樠 ࠧ FAT  ⥪騬 祭 ࠧ
  15++ADA1 ~            ;: cy=1 訡 樠樨
  16++ADA1 ~            ;       a=errRWnum
  17++ADA1 ~            ;       a=errInvalidPart
  18++ADA1 ~            ;     cy =0, nz - ࠧ 樠஢
  19++ADA1 ~            ;     cy =0, z - ࠧ  ॡ 樠樨
  20++ADA1 ~            ;
  21++ADA1 ~            InitCurrMountFAT
  22++ADA1 ~            ;
  23++ADA1 ~            ;	ld	a,(xE590+#05)	;ࠧ  ࠧ
  24++ADA1 ~            	ld	a,(xE590+#15)	;ࠧ  ࠧ
  25++ADA1 ~            	and	#7F
  26++ADA1 ~            	jr	InitFAT32
  27++ADA1 ~
  28++ADA1              	ENDIF
  29++ADA1
  30++ADA1              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  31++ADA1              	IFDEF	forRRL
  32++ADA1 ~            InitCurrMountFAT
  33++ADA1 ~            ;
  34++ADA1 ~            ;	 ld	a,(descCurrFDD+#05)	;ࠧ  ࠧ
  35++ADA1 ~            	 ld	a,(descCurrFDD+#15)	;ࠧ  ࠧ
  36++ADA1 ~            	 and	#7F
  37++ADA1 ~            	 jr	InitFAT32
  38++ADA1              	ENDIF
  39++ADA1
  40++ADA1
  41++ADA1              ;------------------------------------------------------------------------------
  42++ADA1              InitCurrFAT	ifused
  43++ADA1              ;樠 ⥪饣 ࠧ FAT  室
  44++ADA1              ;: cy=1 訡 樠樨
  45++ADA1              ;       a=errRWnum
  46++ADA1              ;       a=errInvalidPart
  47++ADA1              ;     cy =0, nz - ࠧ 樠஢
  48++ADA1              ;     cy =0, z - ࠧ  ॡ 樠樨
  49++ADA1              ;
  50++ADA1              ;InitCurrFAT
  51++ADA1              ;
  52++ADA1 3A 5B 8B     	ld	a,(PartitionNum)	;࠭ ࠧ
  53++ADA4 18 FE        	jr	InitFAT32
  54++ADA6              	org	$-2
  55++ADA4
  56++ADA4              	endif
  57++ADA4
  58++ADA4              ;------------------------------------------------------------------------------
  59++ADA4              InitFAT32	ifused
  60++ADA4              ;樠 ࠧ FAT
  61++ADA4              ;:  a -  ࠧ
  62++ADA4              ;: cy=1 訡 樠樨
  63++ADA4              ;       a=errRWnum
  64++ADA4              ;       a=errInvalidPart
  65++ADA4              ;     cy =0, nz - ࠧ 樠஢
  66++ADA4              ;     cy =0, z - ࠧ  ॡ 樠樨
  67++ADA4              ;
  68++ADA4              ;InitFAT32
  69++ADA4              ;
  70++ADA4 E5           goto028	push	hl
  71++ADA5 D5           	push	de
  72++ADA6 21 5D 8D     	ld	hl,CurrentPart		;ந樫஢ ࠧ
  73++ADA9 BE           	cp	(hl)
  74++ADAA 32 5B 8B     	ld	(PartitionNum),a
  75++ADAD              ;	jr	z,goto027
  76++ADAD 28 0A        	jr	z,goto139
  77++ADAF 6F           	ld	l,a
  78++ADB0 CD C4 AE     	call	GetAdrMFSorFAT
  79++ADB3 D4 C0 AD     	call	nc,InitFATpartition
  80++ADB6 D1           goto027	pop	de
  81++ADB7 E1           	pop	hl
  82++ADB8 C9           	ret
  83++ADB9              goto139
  84++ADB9              ;	call	setRootDir
  85++ADB9              	SetHDDpart
  85++ADB9 CD 6E 99    >	call	DrvHDD.hddSetDevice
  86++ADBC 3E 56        	ld	a,errHddNotFound
  87++ADBE 18 F6        	jr	goto027
  88++ADC0
  89++ADC0              	endif
  90++ADC0
  91++ADC0              ;------------------------------------------------------------------------------
  92++ADC0              InitFATpartition	ifused
  93++ADC0              ;樠 ६ ࠭ ࠧ FAT
  94++ADC0              ;:  dehl - LBA  ࢮ ᥪ ࠧ
  95++ADC0              ;: cy =1 - 訡 樠樨
  96++ADC0              ;       a=errRWnum
  97++ADC0              ;       a=errInvalidPart
  98++ADC0              ;     cy =0, nz - ࠧ 樠஢
  99++ADC0              ;     dehl -   
 100++ADC0              ;
 101++ADC0              ;InitFATpartition
 102++ADC0              ;
 103++ADC0 CD AC AE     	call	DeinitFATpart		;樠 ࠧ FAT32
 104++ADC3 22 5F 8D     	ld	(AdrPartBegin),hl
 105++ADC6 ED 53 61 8D  	ld	(AdrPartBegin+2),de	; 砫 ࠧ
 106++ADCA CD 67 B1     	call	LoadSecDIR2Buf		;⠬ ᥪ 0 ࠧ
 107++ADCD D8           	ret	c			;訡 ⥭
 108++ADCE E5           	push	hl
 109++ADCF DD E3        	ex	(sp),ix			;ix    ᥪ஬
 110++ADD1
 111++ADD1              ;஢ઠ 0 ᥪ ࠧ FAT  
 112++ADD1 2A B6 92     	ld	hl,(Buf4DIR+#1FE)
 113++ADD4 11 55 AA     	ld	de,#AA55
 114++ADD7 B7           	or	a
 115++ADD8 ED 52        	sbc	hl,de
 116++ADDA C2 8D AE     	jp	nz,goto024		;訡.  ᨣ
 117++ADDD              ;  ஢ਬ ⢮   ᥪ
 118++ADDD DD 7E 0C     	ld	a,(ix+BPB_BytesPerSec+1)
 119++ADE0 D6 02        	sub	#02
 120++ADE2 DD B6 0B     	or	(ix+BPB_BytesPerSec)
 121++ADE5 C2 8D AE     	jp	nz,goto024		;ᥪ  512b  ন
 122++ADE8              ;  ⢮ ᥪ஢  
 123++ADE8 DD 56 0D     	ld	d,(ix+BPB_SecPerClus)
 124++ADEB B2           	or	d
 125++ADEC CA 8D AE     	jp	z,goto024		;୮ 祭
 126++ADEF ED 44        	neg
 127++ADF1 A2           	and	d
 128++ADF2 BA           	cp	d
 129++ADF3 C2 8D AE     	jp	nz,goto024		;୮ 祭
 130++ADF6 7A           	ld	a,d
 131++ADF7 32 76 8D     	ld	(LenCLSInSec),a
 132++ADFA              ;  ⢮ ᥪ஢  FAT ⠡
 133++ADFA 2A CE 90     	ld	hl,(Buf4DIR+BPB_FATSz16)
 134++ADFD 7D           	ld	a,l
 135++ADFE B4           	or	h
 136++ADFF C2 8D AE     	jp	nz,goto024		;  FAT32
 137++AE02 2A DC 90     	ld	hl,(Buf4DIR+BPB_FATSz32)
 138++AE05 22 71 8D     	ld	(LenFATinSec),hl
 139++AE08 2A DE 90     	ld	hl,(Buf4DIR+BPB_FATSz32+2)
 140++AE0B 22 73 8D     	ld	(LenFATinSec+2),hl
 141++AE0E              ;  ᬥ饭 ᥪ FSInfo
 142++AE0E 2A E8 90     	ld	hl,(Buf4DIR+BPB_FAT32_FsInfo)
 143++AE11 22 63 8D     	ld	(AdrFsInfo),hl
 144++AE14              ;  ⢮ ᥪ஢  ࠧ
 145++AE14 2A CB 90     	ld	hl,(Buf4DIR+BPB_TotSec16)
 146++AE17 7D           	ld	a,l
 147++AE18 B4           	or	h
 148++AE19 20 72        	jr	nz,goto024		;FAT16  ন
 149++AE1B 2A D8 90     	ld	hl,(Buf4DIR+BPB_TotSec32)
 150++AE1E 22 6D 8D     	ld	(LenOfPartFAT),hl
 151++AE21 2A DA 90     	ld	hl,(Buf4DIR+BPB_TotSec32+2)
 152++AE24 22 6F 8D     	ld	(LenOfPartFAT+2),hl
 153++AE27              ;  ⢮  FAT
 154++AE27 DD 7E 10     	ld	a,(ix+BPB_NumFATs)
 155++AE2A 32 75 8D     	ld	(NumsFATonPart),a
 156++AE2D 3D           	dec	a
 157++AE2E FE 07        	cp	#07
 158++AE30 D2 8D AE     	jp	nc,goto024		; FAT ⠡
 159++AE33 3C           	inc	a
 160++AE34              ;   砫 
 161++AE34 2A 71 8D     	ld	hl,(LenFATinSec)
 162++AE37 ED 5B 73 8D  	ld	de,(LenFATinSec+2)
 163++AE3B 3D           	dec	a
 164++AE3C 28 08        	jr	z,goto025
 165++AE3E 29           loop011	add	hl,hl			;!!!୮   FAT  3
 166++AE3F EB           	ex	de,hl
 167++AE40 ED 6A        	adc	hl,hl
 168++AE42 EB           	ex	de,hl
 169++AE43 3D           	dec	a
 170++AE44 20 F8        	jr	nz,loop011
 171++AE46 ED 4B C6 90  goto025	ld	bc,(Buf4DIR+BPB_RsvdSecCnt)
 172++AE4A C5           	push	bc
 173++AE4B 09           	add	hl,bc
 174++AE4C 30 01        	jr	nc,goto026
 175++AE4E 13           	inc	de
 176++AE4F 22 69 8D     goto026	ld	(AdrDataBegin),hl
 177++AE52 ED 53 6B 8D  	ld	(AdrDataBegin+2),de	; ࢮ ᥪ 
 178++AE56              ;   ୥ ४ਨ
 179++AE56 2A E4 90     	ld	hl,(Buf4DIR+BPB_RootClus)
 180++AE59 ED 5B E6 90  	ld	de,(Buf4DIR+BPB_RootClus+2)
 181++AE5D 22 77 8D     	ld	(RootClaster),hl
 182++AE60 ED 53 79 8D  	ld	(RootClaster+2),de
 183++AE64 22 84 8D     	ld	(CLS_CurrDir),hl
 184++AE67 ED 53 86 8D  	ld	(CLS_CurrDir+2),de
 185++AE6B              ;   ࢮ FAT
 186++AE6B E3           	ex	(sp),hl			;⢮ १ࢨ஢ ᥪ஢
 187++AE6C D5           	push	de
 188++AE6D 11 00 00     	ld	de,#0000
 189++AE70 01 5F 8D     	ld	bc,AdrPartBegin
 190++AE73 CD 17 B4     	call	Add_DEHL_adrBC
 191++AE76 22 65 8D     	ld	(AdrFATonHDD),hl
 192++AE79 ED 53 67 8D  	ld	(AdrFATonHDD+2),de
 193++AE7D
 194++AE7D              ; ⥪饣 ࠧ
 195++AE7D 3A 5B 8B     	ld	a,(PartitionNum)
 196++AE80 32 5D 8D     	ld	(CurrentPart),a
 197++AE83              ;	ld	hl,"/"*#100+#02
 198++AE83              ;	ld	(CurrentPath),hl
 199++AE83 AF           	xor	a
 200++AE84 32 83 8D     	ld	(CurrentLevel),a	;㡨   ⥪饬 ⠫
 201++AE87 3C           	inc	a
 202++AE88 D1           	pop	de
 203++AE89 E1           	pop	hl
 204++AE8A DD E1        	pop	ix
 205++AE8C C9           	ret
 206++AE8D 3E 6D        goto024	ld	a,errInvalidPart
 207++AE8F 37           	scf
 208++AE90 DD E1        	pop	ix
 209++AE92 C9           	ret
 210++AE93
 211++AE93              	endif
 212++AE93
 213++AE93              ;------------------------------------------------------------------------------
 214++AE93              setRootDir	ifused
 215++AE93              ;⠭ ୥ ⠫ ⥪騬
 216++AE93              ;: ---
 217++AE93              ;
 218++AE93              ;setRootDir
 219++AE93              ;
 220++AE93 E5           	push	hl
 221++AE94 D5           	push	de
 222++AE95 21 02 2F     	ld	hl,"/"*#100+#02
 223++AE98 22 B8 94     	ld	(CurrentPath),hl
 224++AE9B 2E 00        	ld	l,#00
 225++AE9D 22 BA 94     	ld	(CurrentPath+2),hl
 226++AEA0 21 77 8D     	ld	hl,RootClaster
 227++AEA3 11 84 8D     	ld	de,CLS_CurrDir
 228++AEA6 CD F9 B3     	call	CopyDWORD_HL_DE
 229++AEA9 D1           	pop	de
 230++AEAA E1           	pop	hl
 231++AEAB C9           	ret
 232++AEAC
 233++AEAC              	endif
 234++AEAC
 235++AEAC              ;------------------------------------------------------------------------------
 236++AEAC              DeinitFATpart	ifused
 237++AEAC              ;樠 ६ ࠧ FAT
 238++AEAC              ;
 239++AEAC              ;DeinitFATpart
 240++AEAC              ;
 241++AEAC F5           	push	af
 242++AEAD 3E FF        	ld	a,#FF
 243++AEAF 32 5D 8D     	ld	(CurrentPart),a
 244++AEB2 F1           	pop	af
 245++AEB3 18 FE        	jr	DeinitFATbuf
 246++AEB5              	org	$-2
 247++AEB3
 248++AEB3              	endif
 249++AEB3
 250++AEB3              ;------------------------------------------------------------------------------
 251++AEB3              DeinitFATbuf	ifused
 252++AEB3              ;樠 ஢ ࠧ FAT
 253++AEB3              ;
 254++AEB3              ;DeinitFATbuf
 255++AEB3              ;
 256++AEB3 F5           	push	af
 257++AEB4 3E FF        	ld	a,#FF
 258++AEB6 32 95 8D     	ld	(SecFATinBuf+3),a
 259++AEB9 32 99 8D     	ld	(SecDIRinBuf+3),a
 260++AEBC 32 A4 8D     	ld	(SecFileInBuf+3),a
 261++AEBF 32 9D 8D     	ld	(NumFstCluster+3),a
 262++AEC2 F1           	pop	af
 263++AEC3 C9           	ret
 264++AEC4
 265++AEC4              	endif
 266++AEC4
 267++AEC4              ;==============================================================================
 268++AEC4
# file closed: Drivers/DrvFAT/DrvFAT.init.a80
 135+ AEC4              	INCLUDE	"DrvFAT.part.a80"
# file opened: Drivers/DrvFAT/DrvFAT.part.a80
   1++AEC4              ;楤  FAT Driver.   ࠧ
   2++AEC4              ;䠩 DrvFAT.part.a80
   3++AEC4              ;
   4++AEC4              ;FindMFSorFAT		।    ࠧ MFS/FAT32  ⥪饬 
   5++AEC4              ;GetAdrMFSorFAT		 ࠧ MFS/FAT32  
   6++AEC4              ;
   7++AEC4              ;------------------------------------------------------------------------------
   8++AEC4              FindMFSorFAT	ifused
   9++AEC4 ~            ;।    ࠧ MFS/FAT32  ⥪饬 
  10++AEC4 ~            ;  MFS ⮫쪮  䏇
  11++AEC4 ~            ;: cy=1 ࠧ  
  12++AEC4 ~            ;       a=errRWnum
  13++AEC4 ~            ;       a=errPartNotFound
  14++AEC4 ~            ;     cy=0 ࠧ 
  15++AEC4 ~            ;        a -  ⨯ ࠧ
  16++AEC4 ~            ;FindMFSorFAT
  17++AEC4 ~            ;
  18++AEC4 ~            	push	ix
  19++AEC4 ~            	call	SetZeroDEHL
  20++AEC4 ~            	SetNumSectors_1		;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
  21++AEC4 ~            	ReadSecMBR		;⥭ 㫥 ᥪ     Buf4MBR
  22++AEC4 ~            	ld	a,errRWnum
  23++AEC4 ~            	jr	c,goto036	;訡 ⥭
  24++AEC4 ~
  25++AEC4 ~            ; ࠧ MFS/FAT32  MBR
  26++AEC4 ~            	ld	hl,(Buf4MBR+#1FE)
  27++AEC4 ~            	ld	de,#AA55	;ᨣ (55h AAh)
  28++AEC4 ~            	or	a
  29++AEC4 ~            	sbc	hl,de
  30++AEC4 ~            	jr	nz,goto036	;ᨣ : MBR 
  31++AEC4 ~            	ld	b,#04
  32++AEC4 ~            	ld	ix,Buf4MBR+#1BE	;砫 ਯ஢ ࠧ HDD
  33++AEC4 ~            loop012	ld	a,(ix+#04)	; ⨯ ࠧ
  34++AEC4 ~            	ifdef	withMFS
  35++AEC4 ~            	cp	#53		; MFS
  36++AEC4 ~            	jr	z,goto037
  37++AEC4 ~            	endif
  38++AEC4 ~            	cp	#0B
  39++AEC4 ~            	jr	z,goto037
  40++AEC4 ~            	cp	#0C
  41++AEC4 ~            	jr	z,goto037
  42++AEC4 ~            	ld	de,#0010
  43++AEC4 ~            	add	ix,de		;ਯ ᫥饣 ࠧ
  44++AEC4 ~            	djnz	loop012
  45++AEC4 ~            goto036	ld	a,errPartNotFound
  46++AEC4 ~            goto035	scf
  47++AEC4 ~            goto037	pop	ix
  48++AEC4 ~            	ret
  49++AEC4 ~
  50++AEC4              	endif
  51++AEC4
  52++AEC4              ;------------------------------------------------------------------------------
  53++AEC4              GetAdrMFSorFAT	ifused
  54++AEC4              ; ࠧ MFS/FAT32  
  55++AEC4              ;:  l -  ࠧ
  56++AEC4              ;: cy=1 訡 ⥭/,  ࠧ  
  57++AEC4              ;       a=errRWnum
  58++AEC4              ;       a=errPartNotFound
  59++AEC4              ;       a=errInvalidPart
  60++AEC4              ;     cy=0 ࠧ 
  61++AEC4              ;       a =#53 ࠧ MFS (⮫쪮  䏇)
  62++AEC4              ;         =#0B FAT32
  63++AEC4              ;         =#0C FAT32 (LBA)
  64++AEC4              ;       bc -  ਯ ࠧ  
  65++AEC4              ;       dehl - ᬥ饭 ࢮ ᥪ ࠧ
  66++AEC4              ;
  67++AEC4              ;GetAdrMFSorFAT
  68++AEC4              ;
  69++AEC4              ;⠭ 
  70++AEC4 DD E5        	push	ix
  71++AEC6 E5           	push	hl
  72++AEC7
  73++AEC7              ;⠭  ᮣ᭮  ࠧ
  74++AEC7 7D           	ld	a,l
  75++AEC8              	SetHDDpart
  75++AEC8 CD 6E 99    >	call	DrvHDD.hddSetDevice
  76++AECB 3E 56        	ld	a,errHddNotFound
  77++AECD 38 53        	jr	c,goto031	; 
  78++AECF
  79++AECF              ;⥭ ᥪ MBR
  80++AECF CD BF B3     	call	SetZeroDEHL	;hl=de=#0000 (㫥 ᥪ)
  81++AED2              	SetNumSectors_1		;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
  81++AED2 3E 01       >	ld	a,#01
  81++AED4 32 D9 A4    >	ld	(DrvHDD.idePort1F2),a	;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
  82++AED7              	ReadSecMBR		;⥭ 㫥 ᥪ     Buf4MBR
  82++AED7 CD 86 9B    >	call	DrvHDD.RdSecHDD_DEHL
  83++AEDA 3E 50        	ld	a,errRWnum
  84++AEDC 38 44        	jr	c,goto031	;訡 ⥭
  85++AEDE
  86++AEDE              ; ࠧ MFS/FAT32  MBR
  87++AEDE 2A 5B 8D     	ld	hl,(Buf4MBR+#1FE)
  88++AEE1 11 55 AA     	ld	de,#AA55	;ᨣ (55h AAh)
  89++AEE4 B7           	or	a
  90++AEE5 ED 52        	sbc	hl,de
  91++AEE7 20 37        	jr	nz,goto032	;ᨣ : MBR 
  92++AEE9 E1           	pop	hl
  93++AEEA 7D           	ld	a,l
  94++AEEB E6 03        	and	#03
  95++AEED 6F           	ld	l,a
  96++AEEE 26 00        	ld	h,#00
  97++AEF0 29           	add	hl,hl
  98++AEF1 29           	add	hl,hl
  99++AEF2 29           	add	hl,hl
 100++AEF3 29           	add	hl,hl
 101++AEF4 EB           	ex	de,hl
 102++AEF5 DD 21 1B 8D  	ld	ix,Buf4MBR+#1BE	;砫 ਯ஢ ࠧ HDD
 103++AEF9 DD 19        	add	ix,de
 104++AEFB DD 7E 04     	ld	a,(ix+#04)
 105++AEFE              	IFDEF	withMFS
 106++AEFE FE 53        	 cp	#53		; ⨯ ࠧ MFS
 107++AF00 28 0C        	 jr	z,goto033
 108++AF02              	ENDIF
 109++AF02 FE 0B        	cp	#0B
 110++AF04 28 08        	jr	z,goto033
 111++AF06 FE 0C        	cp	#0C
 112++AF08 28 04        	jr	z,goto033
 113++AF0A 3E 6D        	ld	a,errInvalidPart
 114++AF0C 18 15        	jr	goto034		;ࠧ  
 115++AF0E DD 6E 08     goto033	ld	l,(ix+#08)
 116++AF11 DD 66 09     	ld	h,(ix+#09)
 117++AF14 DD 5E 0A     	ld	e,(ix+#0A)
 118++AF17 DD 56 0B     	ld	d,(ix+#0B)	;dehl - ᬥ饭 ࢮ ᥪ ࠤ
 119++AF1A DD E5        	push	ix
 120++AF1C C1           	pop	bc
 121++AF1D DD E1        	pop	ix
 122++AF1F C9           	ret
 123++AF20 3E 66        goto032	ld	a,errPartNotFound;ᮮ饭: partition not found
 124++AF22 E1           goto031	pop	hl
 125++AF23 DD E1        goto034	pop	ix
 126++AF25 37           	scf
 127++AF26 C9           	ret
 128++AF27
 129++AF27              	endif
 130++AF27
 131++AF27              ;==============================================================================
 132++AF27
# file closed: Drivers/DrvFAT/DrvFAT.part.a80
 136+ AF27              	INCLUDE	"DrvFAT.table.a80"
# file opened: Drivers/DrvFAT/DrvFAT.table.a80
   1++AF27              ;楤  FAT Driver.   ⠡楩 FAT
   2++AF27              ;䠩 DrvFAT.table.a80
   3++AF27              ;
   4++AF27              ;fatClearCls		⪠  FAT
   5++AF27              ;GetAdrRealSector	᫥  䨧᪮ ᥪ
   6++AF27              ;FindFreeClsFSinfo	 ᢮  稭  ࠬ  FSinfo
   7++AF27              ;FindFreeClsRoot	 ᢮  稭  ୥ ⠫
   8++AF27              ;			(砫 )
   9++AF27              ;FindFreeCls		 ᢮ 
  10++AF27              ;FreeClsChain		  楯 ஢  ᢮
  11++AF27              ;AddCls2Chain		   楯
  12++AF27              ;SetLastClsInFAT	 ਧ ᫥   楯 ஢
  13++AF27              ;SetNClsInFAT		    楯 ஢
  14++AF27              ;SaveSecFAT2Buf		 ᥪ ⠡ FAT   Buf4FAT
  15++AF27              ;TestLastCLS		஢ઠ  ᫥  䠩
  16++AF27              ;ReadFATnextCls		⥭  ᫥饣 
  17++AF27              ;setFsInfoEmpty		  ࢮ ᢮   FsInfo
  18++AF27              ;setFsInfoFreeCls	⠭  FsInfo  ᫥饣 ᢮ 
  19++AF27              ;ReadFsIFreeCls		⥭  ࢮ ᢮   FSinfo
  20++AF27              ;CountFreeCls		 ⢠ ᢮ ஢  ⥪饬 ࠧ 
  21++AF27              ;SaveSecBuf2DIR		㧪 ᥪ ⠫   Buf4DIR
  22++AF27              ;LoadSecDIR2Buf		㧪 ᥪ ⠫   Buf4DIR
  23++AF27              ;LoadSecFAT2Buf		㧪 ᥪ   Buf4FAT
  24++AF27              ;
  25++AF27              ;------------------------------------------------------------------------------
  26++AF27              fatClearCls	ifused
  27++AF27              ;⪠  FAT
  28++AF27              ;:  dehl -   FAT
  29++AF27              ;     ix -  
  30++AF27              ;: cy=1 訡 ⥭/
  31++AF27              ;       a=errRWnum
  32++AF27              ;     cy=0  饭
  33++AF27              ;	dehl -  ࢮ ᥪ 
  34++AF27              ;       bc=#0000
  35++AF27              ;
  36++AF27              ;fatClearCls
  37++AF27              ;
  38++AF27 CD 60 AF     	call	GetAdrRealSector
  39++AF2A 3A 76 8D     	ld	a,(LenCLSInSec)
  40++AF2D 47           	ld	b,a
  41++AF2E D5           	push	de
  42++AF2F E5           	push	hl
  43++AF30 C5           loop018	push	bc
  44++AF31 E5           	push	hl
  45++AF32 D5           	push	de		;LBA  ᥪ
  46++AF33              	hddSetCurrSec		;  ⠭  ६  LBA/CHS  ᨬ  ஥
  46++AF33 CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
  47++AF36              	hddReadSec2IX		;⥭ ᥪ     ix
  47++AF36 CD 8B 9B    >	call	DrvHDD.RdSecHDD_IX
  48++AF39 38 1D        	jr	c,goto073	;訡 ⥭/
  49++AF3B DD E5        	push	ix
  50++AF3D E1           	pop	hl
  51++AF3E 5D           	ld	e,l
  52++AF3F 54           	ld	d,h
  53++AF40 13           	inc	de
  54++AF41 01 FF 01     	ld	bc,#01FF
  55++AF44 36 00        	ld	(hl),#00
  56++AF46 ED B0        	ldir
  57++AF48              	hddWriteSecIX		; ⮣ ᥪ
  57++AF48 CD BA 9B    >	call	DrvHDD.WrSecHDD_IX
  58++AF4B 38 0B        	jr	c,goto073	;訡 ⥭/
  59++AF4D D1           	pop	de
  60++AF4E E1           	pop	hl
  61++AF4F C1           	pop	bc
  62++AF50 CD 05 B4     	call	Inc_DEHL
  63++AF53 10 DB        	djnz	loop018
  64++AF55 48           	ld	c,b
  65++AF56 18 05        	jr	goto074
  66++AF58 3E 50        goto073	ld	a,errRWnum
  67++AF5A D1           	pop	de
  68++AF5B E1           	pop	hl
  69++AF5C C1           	pop	bc
  70++AF5D E1           goto074	pop	hl
  71++AF5E D1           	pop	de
  72++AF5F C9           	ret
  73++AF60
  74++AF60              	endif
  75++AF60
  76++AF60              ;------------------------------------------------------------------------------
  77++AF60              GetAdrRealSector	ifused
  78++AF60              ;᫥  䨧᪮ ᥪ
  79++AF60              ;:  dehl -   FAT
  80++AF60              ;: dehl -  ᥪ
  81++AF60              ;     hl',de',bc' -  
  82++AF60              ;
  83++AF60              ;GetAdrRealSector
  84++AF60              ;
  85++AF60 7A           	ld	a,d
  86++AF61 B3           	or	e
  87++AF62 B4           	or	h
  88++AF63 B5           	or	l
  89++AF64 28 09        	jr	z,goto015	; 㫥  ->  ୥ ⠫.  2
  90++AF66              ;	jr	nz,goto015	; 㫥  ->  ୥ ⠫.  2
  91++AF66              ;	ld	hl,(AdrFATonHDD)
  92++AF66              ;	ld	de,(AdrFATonHDD+2)
  93++AF66              ;	ld	bc,LenFATinSec
  94++AF66              ;	push	bc
  95++AF66              ;	call	Add_DEHL_adrBC
  96++AF66              ;	pop	bc
  97++AF66              ;	jp	Add_DEHL_adrBC
  98++AF66              ;goto015
  99++AF66
 100++AF66              ;   묨
 101++AF66 01 FE FF     	ld	bc,#FFFE
 102++AF69 09           	add	hl,bc
 103++AF6A 03           	inc	bc
 104++AF6B EB           	ex	de,hl
 105++AF6C ED 4A        	adc	hl,bc
 106++AF6E EB           	ex	de,hl		; -2
 107++AF6F 3A 76 8D     goto015	ld	a,(LenCLSInSec)	;ࠧ   ᥪ
 108++AF72 18 08        	jr	goto016
 109++AF74 CB 25        loop009	sla	l
 110++AF76 CB 14        	rl	h
 111++AF78 CB 13        	rl	e
 112++AF7A CB 12        	rl	d
 113++AF7C 0F           goto016	rrca
 114++AF7D 30 F5        	jr	nc,loop009	;㬭  ࠧ 
 115++AF7F 01 5F 8D     	ld	bc,AdrPartBegin
 116++AF82 CD 17 B4     	call	Add_DEHL_adrBC	;ਡ ᬥ饭 砫 ࠧ  ᪥
 117++AF85 01 69 8D     	ld	bc,AdrDataBegin	; ࢮ ᥪ  ࠧ  BPB
 118++AF88 C3 17 B4     	jp	Add_DEHL_adrBC	;ਡ ᬥ饭 砫   ࠧ
 119++AF8B
 120++AF8B              	endif
 121++AF8B
 122++AF8B              ;------------------------------------------------------------------------------
 123++AF8B              FindFreeClsFSinfo	ifused
 124++AF8B              ; ᢮  稭  ࠬ  FSinfo
 125++AF8B              ;: cy=1 訡 ⥭/
 126++AF8B              ;        a=errRWnum -  訡
 127++AF8B              ;     nc,z - ᢮   . FAT 稫
 128++AF8B              ;     nc,nz - ⮩  
 129++AF8B              ;       dehl -  ⮣ 
 130++AF8B              ;
 131++AF8B              ;FindFreeClsFSinfo
 132++AF8B              ;
 133++AF8B CD 25 B1     	call	ReadFsIFreeCls
 134++AF8E D8           	ret	c			;訡
 135++AF8F 28 08        	jr	z,FindFreeClsRoot	;  ⠭
 136++AF91 CD A0 AF     	call	FindFreeCls
 137++AF94 D8           	ret	c
 138++AF95 C0           	ret	nz			;nc,nz ⮩  
 139++AF96 CD F9 B0     	call	setFsInfoEmpty
 140++AF99 18 FE        	jr	FindFreeClsRoot
 141++AF9B              	org	$-2
 142++AF99
 143++AF99              	endif
 144++AF99
 145++AF99              ;------------------------------------------------------------------------------
 146++AF99              FindFreeClsRoot	ifused
 147++AF99              ; ᢮  稭  ୥ ⠫ (砫 )
 148++AF99              ;: cy=1 訡 ⥭/
 149++AF99              ;        a=errRWnum -  訡
 150++AF99              ;     nc,z - ᢮   . FAT 稫
 151++AF99              ;     nc,nz - ⮩  
 152++AF99              ;       dehl -  ⮣ 
 153++AF99              ;
 154++AF99              ;FindFreeClsRoot
 155++AF99              ;
 156++AF99 2A 77 8D     	ld	hl,(RootClaster)
 157++AF9C ED 5B 79 8D  	ld	de,(RootClaster+2)
 158++AFA0 18 FE        	jr	FindFreeCls
 159++AFA2              	org	$-2
 160++AFA0
 161++AFA0              	endif
 162++AFA0
 163++AFA0              ;------------------------------------------------------------------------------
 164++AFA0              FindFreeCls	ifused
 165++AFA0              ; ᢮ 
 166++AFA0              ;:  dehl -    ண 稭 
 167++AFA0              ;: cy=1 訡 ⥭/
 168++AFA0              ;        a=errRWnum -  訡
 169++AFA0              ;     nc,z - ᢮   . FAT 稫
 170++AFA0              ;     nc,nz - ⮩  
 171++AFA0              ;       dehl -  ⮣ 
 172++AFA0              ;
 173++AFA0              ;FindFreeCls
 174++AFA0              ;
 175++AFA0              ;ᬥ饭  砫쭮   =#00
 176++AFA0 D5           	push	de
 177++AFA1 E5           	push	hl
 178++AFA2 CD C5 B3     	call	SetZero2tmpDWORD
 179++AFA5
 180++AFA5              ;㧨 ᥪ  ஬
 181++AFA5              ;  ⠥ ᬥ饭  ᥪ  砫 FAT ⠡
 182++AFA5 29           	add	hl,hl
 183++AFA6 EB           	ex	de,hl
 184++AFA7 ED 6A        	adc	hl,hl		;hlde=dehl*2
 185++AFA9 EB           	ex	de,hl		;dehl=dehl*2
 186++AFAA 4D           	ld	c,l
 187++AFAB CB 39        	srl	c
 188++AFAD 06 00        	ld	b,#00		;bc    ᥪ
 189++AFAF 6C           	ld	l,h
 190++AFB0 63           	ld	h,e
 191++AFB1 5A           	ld	e,d
 192++AFB2 50           	ld	d,b		;dehl - ᬥ饭  ᥪ  砫 FAT ⠡
 193++AFB3              ;  ஢ਬ  諨   ࠭ FAT
 194++AFB3 D5           loop008	push	de
 195++AFB4 E5           	push	hl
 196++AFB5 C5           	push	bc
 197++AFB6 01 71 8D     	ld	bc,LenFATinSec
 198++AFB9 CD D1 B3     	call	cmp_DEHL_adrBC
 199++AFBC 28 3D        	jr	z,goto012		;FAT 稫
 200++AFBE 38 3B        	jr	c,goto012		;FAT 稫
 201++AFC0 CD 87 B1     	call	LoadSecFAT2Buf
 202++AFC3 38 37        	jr	c,goto013		;訡 ⥭/
 203++AFC5 C1           	pop	bc
 204++AFC6 09           	add	hl,bc
 205++AFC7 09           	add	hl,bc
 206++AFC8 09           	add	hl,bc
 207++AFC9 09           	add	hl,bc
 208++AFCA
 209++AFCA              ;饬  㦥 ᥪ ⮩ 
 210++AFCA E5           loop007	push	hl
 211++AFCB CD 0D B4     	call	LD_DEHL_adrHL		;ld dehl,(hl)
 212++AFCE 7D           	ld	a,l
 213++AFCF B4           	or	h
 214++AFD0 B3           	or	e
 215++AFD1 B2           	or	d
 216++AFD2 E1           	pop	hl
 217++AFD3 28 16        	jr	z,goto014		;⮩  
 218++AFD5 23           	inc	hl
 219++AFD6 23           	inc	hl
 220++AFD7 23           	inc	hl
 221++AFD8 23           	inc	hl
 222++AFD9 04           	inc	b
 223++AFDA 0C           	inc	c
 224++AFDB F2 CA AF     	jp	p,loop007
 225++AFDE
 226++AFDE              ;᫥騩 ᥪ  FAT
 227++AFDE CD 02 B0     	call	proc_04		;ਡ  (tmpDWORD) + b
 228++AFE1 E1           	pop	hl
 229++AFE2 D1           	pop	de
 230++AFE3 CD 05 B4     	call	Inc_DEHL	;६  ᥪ
 231++AFE6 01 00 00     	ld	bc,#0000
 232++AFE9 18 C8        	jr	loop008
 233++AFEB
 234++AFEB              ; ⮢  + b + (tmpDWORD)
 235++AFEB              ;nc,nz - ⮩  
 236++AFEB E1           goto014	pop	hl
 237++AFEC D1           	pop	de
 238++AFED CD 02 B0     	call	proc_04		;ਡ  (tmpDWORD) + b
 239++AFF0 E1           	pop	hl
 240++AFF1 D1           	pop	de
 241++AFF2 01 A5 8D     	ld	bc,tmpDWORD
 242++AFF5 CD 17 B4     	call	Add_DEHL_adrBC	;dehl=dehl+(tmpDWORD)
 243++AFF8 AF           	xor	a
 244++AFF9 3C           	inc	a
 245++AFFA C9           	ret
 246++AFFB
 247++AFFB              ;nc,z - ᢮   . FAT 稫
 248++AFFB AF           goto012	xor	a
 249++AFFC
 250++AFFC              ;cy=1 訡 ⥭/
 251++AFFC C1           goto013	pop	bc
 252++AFFD C1           	pop	bc
 253++AFFE C1           	pop	bc
 254++AFFF E1           	pop	hl
 255++B000 D1           	pop	de
 256++B001 C9           	ret
 257++B002
 258++B002              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 259++B002              ;ਡ  (tmpDWORD) + b
 260++B002 21 A5 8D     proc_04	ld	hl,tmpDWORD
 261++B005 7E           	ld	a,(hl)
 262++B006 80           	add	a,b
 263++B007 77           	ld	(hl),a
 264++B008 D0           	ret	nc
 265++B009 23           	inc	hl
 266++B00A 34           	inc	(hl)
 267++B00B C0           	ret	nz
 268++B00C 23           	inc	hl
 269++B00D 34           	inc	(hl)
 270++B00E C0           	ret	nz
 271++B00F 23           	inc	hl
 272++B010 34           	inc	(hl)
 273++B011 C9           	ret
 274++B012
 275++B012              	endif
 276++B012
 277++B012              ;------------------------------------------------------------------------------
 278++B012              FreeClsChain	ifused
 279++B012              ;  楯 ஢  ᢮
 280++B012              ;:  dehl -  (ࢮ)  楯窥
 281++B012              ;: cy=1 訡 ⥭/
 282++B012              ;        a=errRWnum -  訡
 283++B012              ;
 284++B012              ;FreeClsChain
 285++B012              ;
 286++B012              ;⠥    FSinfo
 287++B012 E5           	push	hl
 288++B013 D5           	push	de
 289++B014 CD 25 B1     	call	ReadFsIFreeCls
 290++B017 D1           	pop	de
 291++B018 E1           	pop	hl
 292++B019 D8           	ret	c
 293++B01A
 294++B01A              ;  
 295++B01A CD C5 B3     	call	SetZero2tmpDWORD
 296++B01D
 297++B01D              ;஢ਬ  ᫥ 
 298++B01D CD CA B0     loop006	call	TestLastCLS
 299++B020 3F           	ccf
 300++B021 D2 08 B1     	jp	nc,setFsInfoVar		; ᫥ 
 301++B024              ;	ret	nc			; ᫥ 
 302++B024 7D           	ld	a,l
 303++B025 B4           	or	h
 304++B026 B3           	or	e
 305++B027 B2           	or	d
 306++B028 CA 08 B1     	jp	z,setFsInfoVar		; ⮩ 
 307++B02B              ;	ret	z			; ⮩ 
 308++B02B
 309++B02B              ;⠭    ६ FSinfo
 310++B02B              ;  dehl -    楯窥
 311++B02B 01 7F 8D     	ld	bc,FsINextCls
 312++B02E CD D1 B3     	call	cmp_DEHL_adrBC
 313++B031 FA 3B B0     	jp	m,goto203
 314++B034 22 7F 8D     	ld	(FsINextCls+0),hl
 315++B037 ED 53 81 8D  	ld	(FsINextCls+2),de
 316++B03B
 317++B03B              ;⠥  ᫥饣 
 318++B03B E5           goto203	push	hl
 319++B03C D5           	push	de
 320++B03D CD DD B0     	call	ReadFATnextCls		;⠥  ᫥饣 
 321++B040 C1           	pop	bc
 322++B041 38 0C        	jr	c,goto009		;訡
 323++B043 E3           	ex	(sp),hl
 324++B044 D5           	push	de
 325++B045 59           	ld	e,c
 326++B046 50           	ld	d,b
 327++B047 CD 80 B0     	call	SetNClsInFAT		;襬  ⥪騩 祭 0
 328++B04A D1           	pop	de
 329++B04B E1           	pop	hl
 330++B04C 30 CF        	jr	nc,loop006
 331++B04E C9           	ret
 332++B04F C1           goto009	pop	bc
 333++B050 C9           	ret
 334++B051
 335++B051              	endif
 336++B051
 337++B051              ;------------------------------------------------------------------------------
 338++B051              AddCls2Chain	ifused
 339++B051              ;   楯
 340++B051              ;:  dehl -  (ࢮ)  楯窥
 341++B051              ;     (tmpDWORD) -  ,  㤥 뢠  楯 ஢
 342++B051              ;: cy=1 訡 ⥭/
 343++B051              ;        a=errRWnum -  訡
 344++B051              ;
 345++B051              ;AddCls2Chain
 346++B051              ;
 347++B051 E5           loop005	push	hl
 348++B052 D5           	push	de
 349++B053 CD DD B0     	call	ReadFATnextCls	;dehl  ᫥饣 
 350++B056 38 09        	jr	c,goto008	;訡 ⥭
 351++B058 CD CA B0     	call	TestLastCLS
 352++B05B 38 0A        	jr	c,goto007
 353++B05D C1           	pop	bc
 354++B05E C1           	pop	bc
 355++B05F 18 F0        	jr	loop005
 356++B061
 357++B061              ;室  訡
 358++B061 D1           goto008	pop	de
 359++B062 E1           	pop	hl
 360++B063 3E 50        	ld	a,errRWnum	;R/W error _᫮_
 361++B065 37           	scf
 362++B066 C9           	ret			;訡
 363++B067
 364++B067              ;   楯
 365++B067 D1           goto007	pop	de
 366++B068 E1           	pop	hl
 367++B069 CD 80 B0     	call	SetNClsInFAT	;    楯 ஢
 368++B06C D8           	ret	c
 369++B06D 21 A5 8D     	ld	hl,tmpDWORD
 370++B070 CD 0D B4     	call	LD_DEHL_adrHL
 371++B073 18 FE        	jr	SetLastClsInFAT
 372++B075              	org	$-2
 373++B073
 374++B073 ~            /* ஥, ਢ ࠡ⠥
 375++B073 ~            loop005	call	TestLastCLS
 376++B073 ~            	jr	c,goto007	; ᫥ 
 377++B073 ~            	ld	a,l
 378++B073 ~            	or	h
 379++B073 ~            	or	e
 380++B073 ~            	or	d
 381++B073 ~            	jr	z,goto008	; ⮩ 
 382++B073 ~            	call	ReadFATnextCls	;dehl -  ᫥饣 
 383++B073 ~            	jr	nc,loop005
 384++B073 ~            goto008	ld	a,errRWnum	;R/W error _᫮_
 385++B073 ~            	scf
 386++B073 ~            	ret			;訡
 387++B073 ~            goto007	pop	de
 388++B073 ~            	pop	hl
 389++B073 ~            	call	SetNClsInFAT	;    楯 ஢
 390++B073 ~            	ret	c
 391++B073 ~            	ld	hl,tmpDWORD
 392++B073 ~            	call	LD_DEHL_adrHL
 393++B073 ~            	jr	SetLastClsInFAT
 394++B073 ~            	org	$-2
 395++B073 ~            */
 396++B073              	endif
 397++B073
 398++B073              ;------------------------------------------------------------------------------
 399++B073              SetLastClsInFAT	ifused
 400++B073              ; ਧ ᫥   楯 ஢
 401++B073              ;:  dehl -     襬  
 402++B073              ;: cy=1 訡 ⥭/
 403++B073              ;        a=errRWnum -  訡
 404++B073              ;
 405++B073              ;SetLastClsInFAT
 406++B073              ;
 407++B073 01 FF FF     	ld	bc,#FFFF
 408++B076 ED 43 A5 8D  	ld	(tmpDWORD),bc
 409++B07A 06 0F        	ld	b,#0F
 410++B07C ED 43 A7 8D  	ld	(tmpDWORD+2),bc
 411++B080 18 FE        	jr	SetNClsInFAT
 412++B082              	org	$-2
 413++B080
 414++B080              	endif
 415++B080
 416++B080              ;------------------------------------------------------------------------------
 417++B080              SetNClsInFAT	ifused
 418++B080              ;    楯 ஢
 419++B080              ;:  dehl -     襬  
 420++B080              ;     (tmpDWORD) -  ,  㤥 뢠  楯 ஢
 421++B080              ;: cy=1 訡 ⥭/
 422++B080              ;        a=errRWnum -  訡
 423++B080              ;
 424++B080              ;SetNClsInFAT
 425++B080              ;
 426++B080 29           	add	hl,hl
 427++B081 EB           	ex	de,hl
 428++B082 ED 6A        	adc	hl,hl		;hlde=dehl*2
 429++B084 EB           	ex	de,hl		;dehl=dehl*2
 430++B085 4D           	ld	c,l
 431++B086 6C           	ld	l,h
 432++B087 63           	ld	h,e
 433++B088 5A           	ld	e,d
 434++B089 16 00        	ld	d,#00		;dehl - ᬥ饭  ᥪ  砫 FAT ⠡
 435++B08B D5           	push	de
 436++B08C E5           	push	hl
 437++B08D C5            	push	bc		;a - ᬥ饭  ᥪ/2
 438++B08E CD 87 B1     	call	LoadSecFAT2Buf	;hl    ᥪ஬
 439++B091 D1           	pop	de
 440++B092 38 10        	jr	c,goto006	;訡
 441++B094 16 00        	ld	d,#00
 442++B096 19           	add	hl,de
 443++B097 19           	add	hl,de		;   ஬ ᫥饣 
 444++B098 EB           	ex	de,hl
 445++B099 21 A5 8D     	ld	hl,tmpDWORD
 446++B09C CD F9 B3     	call	CopyDWORD_HL_DE
 447++B09F E1           	pop	hl
 448++B0A0 D1           	pop	de
 449++B0A1 C3 A7 B0     	jp	SaveSecFAT2Buf
 450++B0A4 E1           goto006	pop	hl
 451++B0A5 D1           	pop	de
 452++B0A6 C9           	ret
 453++B0A7
 454++B0A7              	endif
 455++B0A7
 456++B0A7              ;------------------------------------------------------------------------------
 457++B0A7              SaveSecFAT2Buf	ifused
 458++B0A7              ; ᥪ ⠡ FAT   Buf4FAT
 459++B0A7              ;:  dehl -  ᥪ  ⠡ FAT (  )
 460++B0A7              ;: cy=1 뫨 訡 ⥭/
 461++B0A7              ;        a=errRWnum -  訡
 462++B0A7              ;
 463++B0A7              ;SaveSecFAT2Buf
 464++B0A7              ;
 465++B0A7 3A 75 8D     	ld	a,(NumsFATonPart)
 466++B0AA 01 65 8D     	ld	bc,AdrFATonHDD
 467++B0AD F5           loop004	push	af
 468++B0AE CD 17 B4     	call	Add_DEHL_adrBC	;᫮ 4-⭮ ᫠   bc  dehl
 469++B0B1
 470++B0B1              ; ᥪ  ⠡ FAT
 471++B0B1 D5           	push	de
 472++B0B2 E5           	push	hl		;dehl - LBA  ᥪ FAT
 473++B0B3              	hddSetCurrSec		;  ⠭  ६  LBA/CHS
 473++B0B3 CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 474++B0B6 21 B8 92     	ld	hl,Buf4FAT
 475++B0B9              	hddWriteSecHL		; ᥪ     hl
 475++B0B9 CD BF 9B    >	call	DrvHDD.WrSecHDD_HL
 476++B0BC E1           	pop	hl
 477++B0BD D1           	pop	de
 478++B0BE C1           	pop	bc
 479++B0BF 3E 50        	ld	a,errRWnum	;R/W error _᫮_
 480++B0C1 D8           	ret	c		;訡
 481++B0C2 78           	ld	a,b
 482++B0C3 01 71 8D     	ld	bc,LenFATinSec
 483++B0C6 3D           	dec	a
 484++B0C7 20 E4        	jr	nz,loop004
 485++B0C9 C9           	ret
 486++B0CA
 487++B0CA              	endif
 488++B0CA
 489++B0CA              ;------------------------------------------------------------------------------
 490++B0CA              TestLastCLS	ifused
 491++B0CA              ;஢ઠ  ᫥  䠩
 492++B0CA              ;:  dehl -  
 493++B0CA              ;: nz,nc -    ᫥
 494++B0CA              ;      z,nc -  ०
 495++B0CA              ;     nz,c  -  ᫥
 496++B0CA              ;
 497++B0CA              ;TestLastCLS
 498++B0CA              ;
 499++B0CA B7           	or	a
 500++B0CB E5           	push	hl
 501++B0CC 21 FF 0F     	ld	hl,#0FFF
 502++B0CF ED 52        	sbc	hl,de
 503++B0D1 E1           	pop	hl
 504++B0D2 C0           	ret	nz
 505++B0D3 D5           	push	de
 506++B0D4 11 F7 FF     	ld	de,#FFF7
 507++B0D7 EB           	ex	de,hl
 508++B0D8 ED 52        	sbc	hl,de
 509++B0DA EB           	ex	de,hl
 510++B0DB D1           	pop	de
 511++B0DC C9           	ret
 512++B0DD
 513++B0DD              	endif
 514++B0DD
 515++B0DD              ;------------------------------------------------------------------------------
 516++B0DD              ReadFATnextCls	ifused
 517++B0DD              ;⥭  ᫥饣 
 518++B0DD              ;:  dehl -  
 519++B0DD              ;: cy=1 訡 ⥭
 520++B0DD              ;        a=errRWnum -  訡
 521++B0DD              ;     dehl -  ᫥饣 
 522++B0DD              ;     hl',de',bc' - ???
 523++B0DD              ;
 524++B0DD              ;ReadFATnextCls
 525++B0DD              ;
 526++B0DD 29           	add	hl,hl
 527++B0DE EB           	ex	de,hl
 528++B0DF ED 6A        	adc	hl,hl		;hlde=dehl*2
 529++B0E1 EB           	ex	de,hl		;dehl=dehl*2
 530++B0E2 7D           	ld	a,l
 531++B0E3 6C           	ld	l,h
 532++B0E4 63           	ld	h,e
 533++B0E5 5A           	ld	e,d
 534++B0E6 16 00        	ld	d,#00		;dehl - ᬥ饭  ᥪ  砫 FAT ⠡
 535++B0E8 F5           	push	af		;a - ᬥ饭  ᥪ/2
 536++B0E9 CD 87 B1     	call	LoadSecFAT2Buf	;hl    ᥪ஬
 537++B0EC 38 09        	jr	c,goto005	;訡
 538++B0EE F1           	pop	af
 539++B0EF 5F           	ld	e,a
 540++B0F0 16 00        	ld	d,#00
 541++B0F2 19           	add	hl,de
 542++B0F3 19           	add	hl,de		;   ஬ ᫥饣 
 543++B0F4 C3 0D B4     	jp	LD_DEHL_adrHL	;ld dehl,(hl)
 544++B0F7 C1           goto005	pop	bc
 545++B0F8 C9           	ret
 546++B0F9
 547++B0F9              	endif
 548++B0F9
 549++B0F9              ;------------------------------------------------------------------------------
 550++B0F9              setFsInfoEmpty	ifused
 551++B0F9              ;  ࢮ ᢮   FsInfo
 552++B0F9              ;  (⠭  #FFFFFFFF)
 553++B0F9              ;: cy=1 訡 ⥭/
 554++B0F9              ;        a=errRWnum -  訡
 555++B0F9              ;     de,hl,bc -  
 556++B0F9              ;
 557++B0F9              ;setFsInfoEmpty
 558++B0F9              ;
 559++B0F9 E5           	push	hl
 560++B0FA D5           	push	de
 561++B0FB C5           	push	bc
 562++B0FC 21 FF FF     	ld	hl,#FFFF
 563++B0FF 5C           	ld	e,h
 564++B100 54           	ld	d,h
 565++B101 CD 0E B1     	call	setFsInfoFreeCls
 566++B104 C1           	pop	bc
 567++B105 D1           	pop	de
 568++B106 E1           	pop	hl
 569++B107 C9           	ret
 570++B108
 571++B108              	endif
 572++B108
 573++B108              ;------------------------------------------------------------------------------
 574++B108              setFsInfoVar	ifused
 575++B108              ;⠭  FsInfo  ᫥饣 ᢮   ६ FsINextCls
 576++B108              ;:  (FsINextCls) -  ᢮ 
 577++B108              ;: cy=1 訡 ⥭/
 578++B108              ;        a=errRWnum -  訡
 579++B108              ;     dehl -  
 580++B108              ;
 581++B108              ;setFsInfoVar
 582++B108              ;
 583++B108 21 7F 8D     	ld	hl,FsINextCls
 584++B10B CD 0D B4     	call	LD_DEHL_adrHL
 585++B10E 18 FE        	jr	setFsInfoFreeCls
 586++B110              	org	$-2
 587++B10E
 588++B10E              	endif
 589++B10E
 590++B10E              ;------------------------------------------------------------------------------
 591++B10E              setFsInfoFreeCls	ifused
 592++B10E              ;⠭  FsInfo  ᫥饣 ᢮ 
 593++B10E              ;:  dehl -  ᢮ 
 594++B10E              ;: cy=1 訡 ⥭/
 595++B10E              ;        a=errRWnum -  訡
 596++B10E              ;     dehl -  
 597++B10E              ;
 598++B10E              ;setFsInfoFreeCls
 599++B10E              ;
 600++B10E E5           	push	hl
 601++B10F D5           	push	de
 602++B110 CD 25 B1     	call	ReadFsIFreeCls
 603++B113 D1           	pop	de
 604++B114 E1           	pop	hl
 605++B115 D8           	ret	c
 606++B116 22 49 8D     	ld	(Buf4MBR+#1EC+0),hl
 607++B119 ED 53 4B 8D  	ld	(Buf4MBR+#1EC+2),de
 608++B11D 21 5D 8B     	ld	hl,Buf4MBR
 609++B120              	hddWriteSecHL
 609++B120 CD BF 9B    >	call	DrvHDD.WrSecHDD_HL
 610++B123 18 18        	jr	goto030
 611++B125
 612++B125              	endif
 613++B125
 614++B125              ;------------------------------------------------------------------------------
 615++B125              ReadFsIFreeCls	ifused
 616++B125              ;⥭  ࢮ ᢮   FSinfo
 617++B125              ;: cy=1 訡 ⥭
 618++B125              ;        a=errRWnum -  訡
 619++B125              ;     cy=0   ⠭
 620++B125              ;        (FsINextCls),dehl -  ᢮   FSinfo
 621++B125              ;        z -   =#FFFFFFFF
 622++B125              ;     bc,a - ???
 623++B125              ;
 624++B125              ;ReadFsIFreeCls
 625++B125              ;
 626++B125 2A 5F 8D     	ld	hl,(AdrPartBegin)
 627++B128 ED 5B 61 8D  	ld	de,(AdrPartBegin+2)
 628++B12C ED 4B 63 8D  	ld	bc,(AdrFsInfo)
 629++B130 09           	add	hl,bc
 630++B131 30 01        	jr	nc,goto029
 631++B133 13           	inc	de
 632++B134              goto029	hddSetCurrSec			;  ⠭  ६  LBA/CHS
 632++B134 CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 633++B137 21 5D 8B     	ld	hl,Buf4MBR
 634++B13A              	hddReadSec2HL			;⥭ ᥪ     hl
 634++B13A CD 93 9B    >	call	DrvHDD.RdSecHDD_HL
 635++B13D 3E 50        goto030	ld	a,errRWnum		;R/W error _᫮_
 636++B13F D8           	ret	c
 637++B140 2A 49 8D     	ld	hl,(Buf4MBR+#1EC+0)
 638++B143 ED 5B 4B 8D  	ld	de,(Buf4MBR+#1EC+2)
 639++B147 22 7F 8D     	ld	(FsINextCls+0),hl
 640++B14A ED 53 81 8D  	ld	(FsINextCls+2),de
 641++B14E 7D           	ld	a,l
 642++B14F A4           	and	h
 643++B150 A3           	and	e
 644++B151 A2           	and	d
 645++B152 3C           	inc	a
 646++B153 C9           	ret
 647++B154
 648++B154              	endif
 649++B154
 650++B154              ;------------------------------------------------------------------------------
 651++B154              CountFreeCls	ifused
 652++B154 ~            ; ⢠ ᢮ ஢  ⥪饬 ࠧ 
 653++B154 ~            ;: cy=1 訡 ⥭ hdd
 654++B154 ~            ;        a=errRWnum -  訡
 655++B154 ~            ;     cy=0 訡  뫮
 656++B154 ~            ;        dehl - ⢮ ᢮ ஢
 657++B154 ~            ;
 658++B154 ~            ;CountFreeCls
 659++B154 ~            ;
 660++B154 ~            	call	SetZero2tmpDWORD
 661++B154 ~            	ld	hl,(LenFATinSec)
 662++B154 ~            	ld	de,(LenFATinSec+2)
 663++B154 ~
 664++B154 ~            ;㧪 । ᥪ FAT
 665++B154 ~            ;  dehl 浪  ᥪ  ⠡ FAT
 666++B154 ~            loop003	call	Dec_DEHL
 667++B154 ~            	push	hl
 668++B154 ~            	push	de
 669++B154 ~            	call	LoadSecFAT2Buf	;㧪 ᥪ FAT
 670++B154 ~            	jr	c,goto003
 671++B154 ~
 672++B154 ~            ;  ஢  ᥪ FAT
 673++B154 ~            	ld	b,#80
 674++B154 ~            loop002	ld	a,(hl)
 675++B154 ~            	inc	hl
 676++B154 ~            	or	(hl)
 677++B154 ~            	inc	hl
 678++B154 ~            	or	(hl)
 679++B154 ~            	inc	hl
 680++B154 ~            	or	(hl)
 681++B154 ~            	inc	hl
 682++B154 ~            	jr	nz,goto004
 683++B154 ~            	ex	de,hl
 684++B154 ~            	ld	hl,tmpDWORD
 685++B154 ~            	call	Inc_addrHL
 686++B154 ~            	ex	de,hl
 687++B154 ~            goto004	djnz	loop002
 688++B154 ~
 689++B154 ~            ;᫥騩 ᥪ FAT
 690++B154 ~            	pop	de
 691++B154 ~            	pop	hl
 692++B154 ~            	ld	a,l
 693++B154 ~            	or	h
 694++B154 ~            	or	e
 695++B154 ~            	or	d
 696++B154 ~            	jr	nz,loop003
 697++B154 ~
 698++B154 ~            ;⢮  ஢
 699++B154 ~            	ld	hl,(tmpDWORD)
 700++B154 ~            	ld	de,(tmpDWORD+2)
 701++B154 ~            	ret
 702++B154 ~
 703++B154 ~            ;訡 ⥭ 
 704++B154 ~            goto003	pop	de
 705++B154 ~            	pop	hl
 706++B154 ~            	ret
 707++B154 ~
 708++B154              	endif
 709++B154
 710++B154              ;------------------------------------------------------------------------------
 711++B154              SaveSecBuf2DIR	ifused
 712++B154              ; ᥪ ⠫   Buf4DIR
 713++B154              ;:  (SecDIRinBuf) - LBA  ᥪ ⠫
 714++B154              ;: cy=1 뫨 訡 ⥭/
 715++B154              ;        a=errRWnum -  訡
 716++B154              ;
 717++B154              ;SaveSecBuf2DIR
 718++B154              ;
 719++B154 21 96 8D     	ld	hl,SecDIRinBuf
 720++B157 CD 0D B4     	call	LD_DEHL_adrHL
 721++B15A              	hddSetCurrSec		;  ⠭  ६  LBA/CHS
 721++B15A CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 722++B15D 21 B8 90     	ld	hl,Buf4DIR	;(xE046) ࠬ LBA/CHS  ᨬ  ஥
 723++B160              	hddWriteSecHL
 723++B160 CD BF 9B    >	call	DrvHDD.WrSecHDD_HL
 724++B163 D0           	ret	nc
 725++B164 3E 50        	ld	a,errRWnum	;R/W error _᫮_
 726++B166 C9           	ret
 727++B167
 728++B167              	endif
 729++B167
 730++B167              ;------------------------------------------------------------------------------
 731++B167              LoadSecDIR2Buf	ifused
 732++B167              ;㧪 ᥪ ⠫   Buf4DIR
 733++B167              ;:  dehl - LBA  ᥪ ⠫
 734++B167              ;: hl=Buf4DIR
 735++B167              ;     cy=1 뫨 訡 ⥭/
 736++B167              ;        a=errRWnum -  訡
 737++B167              ;     hl',de',bc' - ???
 738++B167              ;
 739++B167              ;LoadSecDIR2Buf
 740++B167              ;
 741++B167 01 96 8D     	ld	bc,SecDIRinBuf
 742++B16A CD AF B1     	call	proc_02		;஢ઠ,  㦥  ᥪ  
 743++B16D 20 04        	jr	nz,goto002	;㦠
 744++B16F 21 B8 90     	ld	hl,Buf4DIR
 745++B172 C9           	ret
 746++B173              ;⥭ ᥪ
 747++B173 22 96 8D     goto002	ld	(SecDIRinBuf),hl
 748++B176 ED 53 98 8D  	ld	(SecDIRinBuf+2),de
 749++B17A              	hddSetCurrSec		;  ⠭  ६  LBA/CHS
 749++B17A CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 750++B17D 21 B8 90     	ld	hl,Buf4DIR	;(xE046) ࠬ LBA/CHS  ᨬ  ஥
 751++B180 CD A3 B1     	call	proc_03
 752++B183 21 B8 90     	ld	hl,Buf4DIR
 753++B186 C9           	ret
 754++B187
 755++B187 18 FE        	jr	LoadSecFAT2Buf
 756++B189              	org	$-2
 757++B187              	endif
 758++B187
 759++B187              ;------------------------------------------------------------------------------
 760++B187              LoadSecFAT2Buf	ifused
 761++B187              ;㧪 ᥪ ⠡ FAT   Buf4FAT
 762++B187              ;:  dehl -  ᥪ  ⠡ FAT (  )
 763++B187              ;: hl=Buf4FAT
 764++B187              ;     cy=1 뫨 訡 ⥭/
 765++B187              ;        a=errRWnum -  訡
 766++B187              ;     hl',de',bc' - ???
 767++B187              ;
 768++B187              ;LoadSecFAT2Buf
 769++B187              ;
 770++B187 01 65 8D     	ld	bc,AdrFATonHDD
 771++B18A CD 17 B4     	call	Add_DEHL_adrBC	;᫮ 4-⭮ ᫠   bc  dehl
 772++B18D CD AC B1     	call	proc_01		;஢ઠ,  㦥  ᥪ  
 773++B190 20 04        	jr	nz,goto001	;㦠
 774++B192 21 B8 92     	ld	hl,Buf4FAT
 775++B195 C9           	ret
 776++B196              ;⥭ ᥪ
 777++B196 22 92 8D     goto001	ld	(SecFATinBuf),hl
 778++B199 ED 53 94 8D  	ld	(SecFATinBuf+2),de
 779++B19D              	hddSetCurrSec		;  ⠭  ६  LBA/CHS
 779++B19D CD E6 9B    >	call	DrvHDD.hddSetVarLBAadr
 780++B1A0 21 B8 92     	ld	hl,Buf4FAT	;(xE046) ࠬ LBA/CHS  ᨬ  ஥
 781++B1A3 E5           proc_03	push	hl
 782++B1A4              	hddReadSec2HL		;⥭ ᥪ     hl
 782++B1A4 CD 93 9B    >	call	DrvHDD.RdSecHDD_HL
 783++B1A7 E1           	pop	hl
 784++B1A8 D0           	ret	nc
 785++B1A9 3E 50        	ld	a,errRWnum	;R/W error _᫮_
 786++B1AB C9           	ret
 787++B1AC              ;஢ઠ,  㦥  ᥪ  
 788++B1AC              ;: z - ᥪ 㦥 㦥
 789++B1AC 01 92 8D     proc_01	ld	bc,SecFATinBuf
 790++B1AF 0A           proc_02	ld	a,(bc)
 791++B1B0 03           	inc	bc
 792++B1B1 BD           	cp	l
 793++B1B2 C0           	ret	nz
 794++B1B3 0A           	ld	a,(bc)
 795++B1B4 03           	inc	bc
 796++B1B5 BC           	cp	h
 797++B1B6 C0           	ret	nz
 798++B1B7 0A           	ld	a,(bc)
 799++B1B8 03           	inc	bc
 800++B1B9 BB           	cp	e
 801++B1BA C0           	ret	nz
 802++B1BB 0A           	ld	a,(bc)
 803++B1BC BA           	cp	d
 804++B1BD C9           	ret
 805++B1BE
 806++B1BE              	endif
 807++B1BE
 808++B1BE              ;==============================================================================
 809++B1BE
# file closed: Drivers/DrvFAT/DrvFAT.table.a80
 137+ B1BE              	INCLUDE	"DrvFAT.str.a80"
# file opened: Drivers/DrvFAT/DrvFAT.str.a80
   1++B1BE              ;楤  FAT Driver. ࠡ  ப
   2++B1BE              ;䠩 DrvFAT.str.a80
   3++B1BE              ;
   4++B1BE              ;strSetExtToName	⠭  ७   䠩
   5++B1BE              ;RenewPath		室  㣮 ⠫ (䨪 ப   ⠫)
   6++B1BE              ;strHddPart		뤥    ࠧ  ப
   7++B1BE              ;FileName2NameExt	஢  䠩  ଠ 8+3  ଠ name.ext
   8++B1BE              ;FileNameLFNto8dot3	ॢ  䠩  ଠ name.ext  ଠ 8+3
   9++B1BE              ;			(  ⪮   ਯ)
  10++B1BE              ;FileNameTo8dot3	ॢ  䠩  ଠ name.ext  ଠ 8+3
  11++B1BE              ;			(   ਯ)
  12++B1BE              ;strCopyName		ନ㥬  䠩/७    B, 
  13++B1BE              ;			窨    ப
  14++B1BE              ;TestPathFile		஢ઠ /  䠩  ⨬ ᨬ
  15++B1BE              ;			 ॢ 㪢  孨 ॣ
  16++B1BE              ;strTestFileName	஢ઠ  䠩  ⨬ ᨬ 
  17++B1BE              ;			ॢ 㪢  孨 ॣ
  18++B1BE              ;strTestNameLFN		஢ઠ  ⨬ ᨬ   LFN
  19++B1BE              ;chrCheckLFN		஢ઠ  ⨬ ᨬ  LFN
  20++B1BE              ;SkipSeparator		ய   ࠧ⥫   
  21++B1BE              ;toUpCaseHL		ॢ ᨬ [a..z], [..]  ப  孨
  22++B1BE              ;			ॣ, 㤠 㡫 ࠧ⥫
  23++B1BE              ;
  24++B1BE              ;------------------------------------------------------------------------------
  25++B1BE              strSetExtToName	ifused
  26++B1BE ~            ;⠭  ७   䠩
  27++B1BE ~            ;     ஢७  ॢ  孨 ॣ
  28++B1BE ~            ;  ᨬ  ப <#20
  29++B1BE ~            ;:  hl -  ப   䠩  ଠ 8.3
  30++B1BE ~            ;     de -  ப  ७
  31++B1BE ~            ;: de -    䠩
  32++B1BE ~            ;
  33++B1BE ~            ;strSetExtToName
  34++B1BE ~            ;
  35++B1BE ~            	push	hl
  36++B1BE ~            	push	bc
  37++B1BE ~            loop052	ld	a,(hl)
  38++B1BE ~            	inc	hl
  39++B1BE ~            	cp	#20
  40++B1BE ~            	jr	c,goto138	; 
  41++B1BE ~            	cp	"."
  42++B1BE ~            	jr	nz,loop052	; ७
  43++B1BE ~            goto138	dec	hl
  44++B1BE ~            	ld	(hl),"."
  45++B1BE ~            	inc	hl
  46++B1BE ~            	ex	de,hl
  47++B1BE ~            	ldi
  48++B1BE ~            	ldi
  49++B1BE ~            	ldi
  50++B1BE ~            	xor	a
  51++B1BE ~            	ld	(de),a
  52++B1BE ~            	pop	bc
  53++B1BE ~            	pop	hl
  54++B1BE ~            	ret
  55++B1BE ~
  56++B1BE              	endif
  57++B1BE
  58++B1BE              ;------------------------------------------------------------------------------
  59++B1BE              RenewPath	ifused
  60++B1BE              ;室  㣮 ⠫ (䨪 ப   ⠫)
  61++B1BE              ;:  hl -  ਯ 䠩
  62++B1BE              ;     7,e =0  䠩/⠫
  63++B1BE              ;         =1    த⥫᪨ ⠫
  64++B1BE              ;     0,e =1   
  65++B1BE              ;: a -   
  66++B1BE              ;
  67++B1BE              ;RenewPath
  68++B1BE              ;
  69++B1BE E5           	push	hl
  70++B1BF CB 7B        	bit	7,e
  71++B1C1 EB           	ex	de,hl
  72++B1C2 21 B8 94     	ld	hl,CurrentPath
  73++B1C5 4E           	ld	c,(hl)		; 
  74++B1C6 06 00        	ld	b,#00
  75++B1C8 09           	add	hl,bc
  76++B1C9 20 14        	jr	nz,goto121	;室  த⥫᪨ ⠫
  77++B1CB
  78++B1CB              ;室  ⠫ ( ४ਨ  ⥪饬 )
  79++B1CB EB           	ex	de,hl
  80++B1CC CD E8 B1     	call	FileName2NameExt
  81++B1CF EB           	ex	de,hl
  82++B1D0 36 2F        	ld	(hl),fnSep	;"/" ᨬ ࠧ⥫
  83++B1D2 23           goto122	inc	hl
  84++B1D3 36 00        	ld	(hl),#00
  85++B1D5 01 B8 94     	ld	bc,CurrentPath
  86++B1D8 B7           	or	a
  87++B1D9 ED 42        	sbc	hl,bc
  88++B1DB 7D           	ld	a,l
  89++B1DC 02           	ld	(bc),a		;  
  90++B1DD E1           	pop	hl
  91++B1DE C9           	ret
  92++B1DF
  93++B1DF              ;室  த⥫᪨ ⠫
  94++B1DF 2B           goto121	dec	hl
  95++B1E0 2B           loop048	dec	hl
  96++B1E1 7E           	ld	a,(hl)
  97++B1E2 FE 2F        	cp	fnSep		;"/"
  98++B1E4 20 FA        	jr	nz,loop048
  99++B1E6 18 EA        	jr	goto122
 100++B1E8
 101++B1E8              	endif
 102++B1E8
 103++B1E8              ;------------------------------------------------------------------------------
 104++B1E8              strHddPart	ifused
 105++B1E8 ~            ;뤥    ࠧ  ப
 106++B1E8 ~            ;:  hl -  ப, ᮤঠ饩   䠩  asciz
 107++B1E8 ~            ;        ଠ  䠩: [hd{0|1},{0|1|2|3}:]\[DIR\DIR\..\DIR\]filename.ext
 108++B1E8 ~            ;: cy=1 - ᯥ譮
 109++B1E8 ~            ;        c -   [0..1]
 110++B1E8 ~            ;        b -  ࠧ   [0..3]
 111++B1E8 ~            ;        a -   ப ࠧ
 112++B1E8 ~            ;     cy=0 - ࠧ  ப 
 113++B1E8 ~            ;        a - ⥪騩 ࠧ
 114++B1E8 ~            ;     hl - 砫   䠩,   
 115++B1E8 ~            ;
 116++B1E8 ~            ;strHddPart
 117++B1E8 ~            ;
 118++B1E8 ~            ;뤥    ࠧ  ப
 119++B1E8 ~            	push	hl
 120++B1E8 ~            	ld	a,(hl)
 121++B1E8 ~            	and	#5F
 122++B1E8 ~            	cp	"H"
 123++B1E8 ~            	jr	nz,goto055	;ࠧ  㪠
 124++B1E8 ~            	inc	hl
 125++B1E8 ~            	ld	a,(hl)
 126++B1E8 ~            	and	#5F
 127++B1E8 ~            	cp	"D"
 128++B1E8 ~            	jr	nz,goto055	;ࠧ  㪠
 129++B1E8 ~            	inc	hl
 130++B1E8 ~            	ld	c,(hl)		; 
 131++B1E8 ~            	inc	hl
 132++B1E8 ~            	ld	a,(hl)		;ࠧ⥫.   
 133++B1E8 ~            	cp	","
 134++B1E8 ~            	jr	nz,goto055	;ࠧ  㪠
 135++B1E8 ~            	inc	hl
 136++B1E8 ~            	ld	b,(hl)		; ࠧ
 137++B1E8 ~            	inc	hl
 138++B1E8 ~            	ld	a,":"
 139++B1E8 ~            	cp	(hl)
 140++B1E8 ~            	jr	nz,goto055	;ࠧ  㪠
 141++B1E8 ~            	inc	hl
 142++B1E8 ~
 143++B1E8 ~            ;뤥  ࠧ
 144++B1E8 ~            	ld	a,b
 145++B1E8 ~            	sub	"0"
 146++B1E8 ~            	jr	c,goto055	;nz 騩 ࠧ
 147++B1E8 ~            	cp	#04
 148++B1E8 ~            	ld	b,a		; ࠧ [0..3]
 149++B1E8 ~            	jr	nc,goto055	;nz 騩 ࠧ
 150++B1E8 ~
 151++B1E8 ~            ;뤥  
 152++B1E8 ~            	ld	a,c
 153++B1E8 ~            	sub	"0"
 154++B1E8 ~            	jr	c,goto055	;nz 騩 ࠧ
 155++B1E8 ~            	IFDEF	ZC
 156++B1E8 ~            	cp	#03
 157++B1E8 ~            	ELSE
 158++B1E8 ~            	cp	#02
 159++B1E8 ~            	ENDIF
 160++B1E8 ~            	jr	nc,goto055	;nz 騩 ࠧ
 161++B1E8 ~            	ld	c,a
 162++B1E8 ~            	add	a,a
 163++B1E8 ~            	add	a,a
 164++B1E8 ~            	or	b
 165++B1E8 ~            	ex	(sp),hl
 166++B1E8 ~            	pop	hl
 167++B1E8 ~            	scf
 168++B1E8 ~            	ret
 169++B1E8 ~
 170++B1E8 ~            ;  ࠧ  ப  㦥
 171++B1E8 ~            goto055	xor	a
 172++B1E8 ~            	pop	hl
 173++B1E8 ~            	ld	a,(PartitionNum)
 174++B1E8 ~            	ret
 175++B1E8 ~
 176++B1E8              	endif
 177++B1E8
 178++B1E8              ;------------------------------------------------------------------------------
 179++B1E8              FileName2NameExt	ifused
 180++B1E8              ;஢  䠩  ଠ 8+3  ଠ name.ext
 181++B1E8              ;:  hl -  ਯ 䠩 (  ଠ 8+3)
 182++B1E8              ;     de -  ਥ
 183++B1E8              ;: de - ॢ ᢮  ਥ
 184++B1E8              ;     hl=hl+#0B ( ਡ⮢  ਯ)
 185++B1E8              ;
 186++B1E8              ;FileName2NameExt
 187++B1E8              ;
 188++B1E8 3E 08        	ld	a,#08
 189++B1EA CD F7 B1     	call	proc_09
 190++B1ED 7E           	ld	a,(hl)		; ७, ᫨ 
 191++B1EE FE 20        	cp	" "
 192++B1F0 C8           	ret	z		;७ 
 193++B1F1 3E 2E        	ld	a,"."
 194++B1F3 12           	ld	(de),a		;ࠧ⥫
 195++B1F4 13           	inc	de
 196++B1F5 3E 03        	ld	a,#03
 197++B1F7 06 00        proc_09	ld	b,#00
 198++B1F9 4F           	ld	c,a
 199++B1FA ED B0        	ldir
 200++B1FC 47           	ld	b,a
 201++B1FD 1B           loop047	dec	de		;㤠 ᫥ ஡
 202++B1FE 1A           	ld	a,(de)
 203++B1FF 13           	inc	de
 204++B200 FE 20        	cp	" "
 205++B202 C0           	ret	nz
 206++B203 1B           	dec	de
 207++B204 10 F7        	djnz	loop047
 208++B206 C9           	ret
 209++B207
 210++B207              	endif
 211++B207
 212++B207              ;------------------------------------------------------------------------------
 213++B207              FileNameLFNto8dot3	ifused
 214++B207              ;ॢ  䠩  ଠ name.ext  ଠ 8+3(  ⪮
 215++B207              ;    ਯ)
 216++B207              ;  ᨬ  ப <#20, ࠧ⥫  ⠫ fnSep
 217++B207              ;:  hl -    ଠ [\]name[.][ext]\
 218++B207              ;     de -  ਥ 
 219++B207              ;: hl -  ᫥饣   
 220++B207              ;     b=#00
 221++B207              ;
 222++B207              ;FileNameLFNto8dot3
 223++B207              ;
 224++B207 CD 07 B3     	call	SkipSeparator
 225++B20A
 226++B20A              ;ନ㥬  䠩
 227++B20A D5           	push	de
 228++B20B 01 7F 08     	ld	bc,#087F
 229++B20E CD 41 B2     	call	strCopyName
 230++B211
 231++B211              ;饬  砫 ७
 232++B211 7E           loop060	ld	a,(hl)
 233++B212 FE 20        	cp	#20
 234++B214 38 09        	jr	c,goto158		; ப
 235++B216 FE 2F        	cp	fnSep			;"/"
 236++B218 28 05        	jr	z,goto158		; 
 237++B21A 23           	inc	hl
 238++B21B FE 2E        	cp	"."
 239++B21D 20 F2        	jr	nz,loop060
 240++B21F
 241++B21F              ;ନ㥬 ७ 䠩
 242++B21F 06 03        goto158	ld	b,#03
 243++B221 CD 41 B2     	call	strCopyName
 244++B224
 245++B224              ;ॢ  孨 ॣ
 246++B224 E3           	ex	(sp),hl
 247++B225 1A           	ld	a,(de)
 248++B226 F5           	push	af
 249++B227 AF           	xor	a
 250++B228 12           	ld	(de),a
 251++B229 CD 12 B3     	call	toUpCaseHL
 252++B22C F1           	pop	af
 253++B22D 12           	ld	(de),a
 254++B22E E1           	pop	hl
 255++B22F
 256++B22F C9           	ret
 257++B230
 258++B230              	endif
 259++B230
 260++B230              ;------------------------------------------------------------------------------
 261++B230              FileNameTo8dot3	ifused
 262++B230              ;ॢ  䠩  ଠ name.ext  ଠ 8+3(   ਯ)
 263++B230              ;     ஢७  ॢ  孨 ॣ
 264++B230              ;  ᨬ  ப <#20, ࠧ⥫  ⠫ fnSep
 265++B230              ;:  hl -    ଠ [\]name[.][ext]\
 266++B230              ;     de -  ਥ 
 267++B230              ;: hl -  ᫥饣   
 268++B230              ;
 269++B230              ;FileNameTo8dot3
 270++B230              ;
 271++B230 CD 07 B3     	call	SkipSeparator
 272++B233
 273++B233              ;ନ㥬  䠩/७
 274++B233 01 FF 08     	ld	bc,#08FF
 275++B236 CD 41 B2     	call	strCopyName
 276++B239 7E           	ld	a,(hl)
 277++B23A FE 2E        	cp	"."
 278++B23C 20 01        	jr	nz,goto062
 279++B23E 23           	inc	hl
 280++B23F
 281++B23F              ;ନ㥬 ७ 䠩
 282++B23F 06 03        goto062	ld	b,#03
 283++B241 18 FE        	jr	strCopyName
 284++B243              	org	$-2
 285++B241
 286++B241 ~            /*  
 287++B241 ~            ;FileNameTo8dot3
 288++B241 ~            ;
 289++B241 ~            	ld	bc,#08FF
 290++B241 ~            	ld	a,(hl)
 291++B241 ~            	cp	fnSep		;"/"
 292++B241 ~            	jr	nz,loop022
 293++B241 ~            	inc	hl
 294++B241 ~
 295++B241 ~            ;ନ㥬  䠩
 296++B241 ~            loop022	ld	a,(hl)
 297++B241 ~            	cp	#20
 298++B241 ~            	jr	c,goto060	; 
 299++B241 ~            	cp	fnSep		;"/"
 300++B241 ~            	jr	z,goto060	; 
 301++B241 ~            	cp	"."
 302++B241 ~            	jr	z,goto061	; ७
 303++B241 ~            	ldi
 304++B241 ~            	djnz	loop022
 305++B241 ~            	ld	a,(hl)
 306++B241 ~            	cp	"."
 307++B241 ~            	jr	nz,goto062
 308++B241 ~            	inc	hl
 309++B241 ~            	jr	goto062
 310++B241 ~            goto061	inc	hl
 311++B241 ~            ;  塞 ⮪  ஡
 312++B241 ~            goto060	ld	a," "
 313++B241 ~            loop023	ld	(de),a
 314++B241 ~            	inc	de
 315++B241 ~            	djnz	loop023
 316++B241 ~
 317++B241 ~            ;ନ㥬 ७ 䠩
 318++B241 ~            goto062	ld	b,#03
 319++B241 ~            loop024	ld	a,(hl)
 320++B241 ~            	cp	#20
 321++B241 ~            	jr	c,goto064	; 
 322++B241 ~            	cp	fnSep		;"/"
 323++B241 ~            	jr	z,goto064	; 
 324++B241 ~            	ldi
 325++B241 ~            	djnz	loop024
 326++B241 ~            	ret
 327++B241 ~            ;  塞 ⮪ ७ ஡
 328++B241 ~            goto064	ld	a," "
 329++B241 ~            loop025	ld	(de),a
 330++B241 ~            	inc	de
 331++B241 ~            	djnz	loop025
 332++B241 ~            	ret
 333++B241 ~            */
 334++B241
 335++B241              	endif
 336++B241
 337++B241              ;------------------------------------------------------------------------------
 338++B241              strCopyName	ifused
 339++B241              ;ନ㥬  䠩/७    B,  窨    ப
 340++B241              ;:  hl -  ப   筨
 341++B241              ;     de -  ப ਥ
 342++B241              ;     b -  /७
 343++B241              ;     c=#7F/#FF   /  8.3  8+3
 344++B241              ;: hl - 㪠뢠   ப///᫥騩 ᨬ 
 345++B241              ;     de - ନ஢   ஡
 346++B241              ;     b=#00
 347++B241              ;
 348++B241              ;strCopyName
 349++B241              ;
 350++B241 7E           loop022	ld	a,(hl)
 351++B242 FE 20        	cp	#20
 352++B244 38 15        	jr	c,goto060	; 
 353++B246 20 06        	jr	nz,goto176
 354++B248 CB 79        	bit	7,c
 355++B24A 23           	inc	hl
 356++B24B 28 F4        	jr	z,loop022	;஡ ய᪠
 357++B24D 2B           	dec	hl
 358++B24E FE 2F        goto176	cp	fnSep		;"/"
 359++B250 28 09        	jr	z,goto060	; 
 360++B252 FE 2E        	cp	"."
 361++B254 28 05        	jr	z,goto060	; ७
 362++B256 ED A0        	ldi
 363++B258 10 E7        	djnz	loop022
 364++B25A C9           	ret
 365++B25B
 366++B25B              ;塞 ⮪  ஡
 367++B25B 3E 20        goto060	ld	a," "
 368++B25D 12           loop023	ld	(de),a
 369++B25E 13           	inc	de
 370++B25F 10 FC        	djnz	loop023
 371++B261 C9           	ret
 372++B262
 373++B262              	endif
 374++B262
 375++B262              ;------------------------------------------------------------------------------
 376++B262              TestPathFile	ifused
 377++B262              ;஢ઠ /  䠩  ⨬ ᨬ  ॢ 㪢  孨
 378++B262              ;  ॣ,   ࠧ⥫  /
 379++B262              ;  ᨬ  ப <#20, ࠧ⥫  ⠫ \  /
 380++B262              ;:  hl -  砫 
 381++B262              ;: cy=1  ᮤন ⨬ ᨬ,  ᫨誮 
 382++B262              ;     cy=0 ᨭ⠪ ஢ઠ ன
 383++B262              ;       z -  ⮩ -> a,e=#00
 384++B262              ;       nz -   ⮩
 385++B262              ;         a -  (a=#00 ⮫쪮  䠩  )
 386++B262              ;         b=c=#00  稢 ࠧ⥫
 387++B262              ;
 388++B262              ;TestPathFile
 389++B262              ;
 390++B262 CD 12 B3     	call	toUpCaseHL
 391++B265
 392++B265              ; 砩. ⮥ 
 393++B265 1E 00        	ld	e,#00		;
 394++B267 7E           	ld	a,(hl)
 395++B268 FE 20        	cp	#20
 396++B26A 38 4B        	jr	c,goto133
 397++B26C
 398++B26C              ;ய⨬  ࠧ⥫
 399++B26C E5           	push	hl
 400++B26D CD 07 B3     	call	SkipSeparator
 401++B270              ;	cp	fnSep		;"/"
 402++B270              ;	jr	nz,loop032
 403++B270              ;	inc	hl
 404++B270
 405++B270 01 00 00     loop032	ld	bc,#0000	; /७
 406++B273 51           	ld	d,c
 407++B274 7E           loop030	ld	a,(hl)
 408++B275 FE 20        	cp	#20
 409++B277 38 24        	jr	c,goto075	; 
 410++B279 FE 2F        	cp	fnSep		;"/"
 411++B27B 28 17        	jr	z,goto076	;  䠩/⠫
 412++B27D FE 2E        	cp	"."
 413++B27F 20 0B        	jr	nz,goto077
 414++B281 14           	inc	d
 415++B282 15           	dec	d
 416++B283 20 07        	jr	nz,goto077	;㦥 ࠡ⪠ ७
 417++B285 14           	inc	d		;ࢠ 窠  
 418++B286 41           	ld	b,c		; 
 419++B287 0E 00        	ld	c,#00		;⥯ ⠥ ७
 420++B289 23           	inc	hl
 421++B28A 18 E8        	jr	loop030
 422++B28C CD C0 B2     goto077	call	proc_11		;஢ઠ  ⨬ ᨬ
 423++B28F 20 E3        	jr	nz,loop030	;⨬ ᨬ   䠩
 424++B291
 425++B291              ;⨬ ᬢ  
 426++B291 37           goto078	scf
 427++B292 E1           	pop	hl
 428++B293 C9           	ret
 429++B294
 430++B294              ;ய᪠ 騥  ࠧ⥫ 
 431++B294              ;b -  
 432++B294              ;c -  ७
 433++B294 CD A4 B2     goto076	call	proc_06
 434++B297 38 F8        	jr	c,goto078	;⨬ ࠧ 
 435++B299 1C           	inc	e
 436++B29A 23           	inc	hl
 437++B29B 18 D3        	jr	loop032
 438++B29D
 439++B29D              ; ப, ஢ਬ 祬 稢 ப
 440++B29D 2B           goto075	dec	hl
 441++B29E 7E           	ld	a,(hl)
 442++B29F E1           	pop	hl
 443++B2A0 FE 2F        	cp	fnSep		;"/"
 444++B2A2 28 13        	jr	z,goto133	;஢ਬ ⮫쪮 
 445++B2A4
 446++B2A4              ;஢ઠ ࠬ஢   
 447++B2A4              ;:  d=1    ७
 448++B2A4              ;      =0  ⮫쪮 
 449++B2A4              ;     b -  
 450++B2A4              ;     c -  ७
 451++B2A4              ;     e -  
 452++B2A4              ;: cy=1  ᮤন ⨬ ᨬ,  ᫨誮 
 453++B2A4 7A           proc_06	ld	a,d
 454++B2A5 B7           	or	a
 455++B2A6 20 02        	jr	nz,goto080
 456++B2A8 41           	ld	b,c
 457++B2A9 4F           	ld	c,a
 458++B2AA 78           goto080	ld	a,b
 459++B2AB B7           	or	a
 460++B2AC 37           	scf
 461++B2AD C8           	ret	z		;⮥  ⨬
 462++B2AE FE 09        	cp	#09
 463++B2B0 3F           	ccf
 464++B2B1 D8           	ret	c		;  8 ᨬ ⨬
 465++B2B2 79           	ld	a,c
 466++B2B3 FE 04        	cp	#04
 467++B2B5 3F           	ccf
 468++B2B6 D8           	ret	c		;७  3 ᨬ ⨬
 469++B2B7 7B           goto133	ld	a,e
 470++B2B8 B7           	or	a
 471++B2B9 C8           	ret	z		;nc,z - ⮩ 
 472++B2BA E6 7F        	and	#7F
 473++B2BC FE 10        	cp	#10
 474++B2BE 3F           	ccf
 475++B2BF C9           	ret			;nz
 476++B2C0
 477++B2C0              ;஢ઠ  ⨬ ᨬ
 478++B2C0 0C           proc_11	inc	c
 479++B2C1 CB FB        	set	7,e
 480++B2C3 E5           proc_18	push	hl
 481++B2C4 C5           	push	bc
 482++B2C5 21 58 B3     	ld	hl,IllegalSym
 483++B2C8 01 12 00     	ld	bc,endIllegalSym-IllegalSym
 484++B2CB ED B1        	cpir
 485++B2CD C1           	pop	bc
 486++B2CE E1           	pop	hl
 487++B2CF 23           	inc	hl
 488++B2D0 C9           	ret
 489++B2D1
 490++B2D1              	endif
 491++B2D1
 492++B2D1              ;------------------------------------------------------------------------------
 493++B2D1              strTestFileName	ifused
 494++B2D1              ;஢ઠ  䠩  ⨬ ᨬ  ॢ 㪢  孨
 495++B2D1              ;  ॣ
 496++B2D1              ;  ᨬ  ப <#20
 497++B2D1              ;:  hl -  砫 
 498++B2D1              ;: cy=1  ᮤন ⨬ ᨬ,  ᫨誮 ,  ⮩
 499++B2D1              ;     cy=0 ᨭ⠪ ஢ઠ ன
 500++B2D1              ;
 501++B2D1              ;strTestFileName
 502++B2D1              ;
 503++B2D1 CD 12 B3     	call	toUpCaseHL
 504++B2D4
 505++B2D4              ; 砩. ⮥ 
 506++B2D4 7E           	ld	a,(hl)
 507++B2D5 FE 20        	cp	#20
 508++B2D7 D8           	ret	c
 509++B2D8
 510++B2D8              ;ࠢ 
 511++B2D8 E5           	push	hl
 512++B2D9 11 01 00     	ld	de,#0001
 513++B2DC 42           	ld	b,d		; /७
 514++B2DD 4A           	ld	c,d
 515++B2DE 7E           loop051	ld	a,(hl)
 516++B2DF FE 20        	cp	#20
 517++B2E1 38 BA        	jr	c,goto075	; 
 518++B2E3 FE 2E        	cp	"."
 519++B2E5 20 0B        	jr	nz,goto079
 520++B2E7 14           	inc	d
 521++B2E8 15           	dec	d
 522++B2E9 20 07        	jr	nz,goto079	;㦥 ࠡ⪠ ७
 523++B2EB 14           	inc	d		;ࢠ 窠  
 524++B2EC 41           	ld	b,c		; 
 525++B2ED 0E 00        	ld	c,#00		;⥯ ⠥ ७
 526++B2EF 23           	inc	hl
 527++B2F0 18 EC        	jr	loop051
 528++B2F2 CD C0 B2     goto079	call	proc_11		;஢ઠ  ⨬ ᨬ
 529++B2F5 20 E7        	jr	nz,loop051	;⨬ ᨬ   䠩
 530++B2F7
 531++B2F7              ;⨬ ᬢ  
 532++B2F7 37           	scf
 533++B2F8 E1           	pop	hl
 534++B2F9 C9           	ret
 535++B2FA C3 62 B2     	jp	TestPathFile
 536++B2FD              	org	$-3
 537++B2FA
 538++B2FA              	endif
 539++B2FA
 540++B2FA              ;------------------------------------------------------------------------------
 541++B2FA              strTestNameLFN	ifused
 542++B2FA ~            ;஢ઠ  ⨬ ᨬ   LFN
 543++B2FA ~            ;  ᨬ  ப <#20
 544++B2FA ~            ;:  hl - ப  
 545++B2FA ~            ;: cy=1 ⨬ 
 546++B2FA ~            ;     a -  ।
 547++B2FA ~            ;     㣨 ॣ  
 548++B2FA ~            ;
 549++B2FA ~            ;strTestNameLFN
 550++B2FA ~            ;
 551++B2FA ~            ; 砩. ⮥ 
 552++B2FA ~            	ld	a,(hl)
 553++B2FA ~            	cp	#20
 554++B2FA ~            	ret	c
 555++B2FA ~
 556++B2FA ~            ;஢ઠ  ⨬ ᨬ
 557++B2FA ~            	push	hl
 558++B2FA ~            loop075	call	chrCheckLFN
 559++B2FA ~            	jr	z,goto202		; ⨬ ᨬ
 560++B2FA ~            	inc	hl
 561++B2FA ~            	ld	a,(hl)
 562++B2FA ~            	cp	#20
 563++B2FA ~            	jr	nc,loop075
 564++B2FA ~            goto202	pop	hl
 565++B2FA ~            	ccf
 566++B2FA ~            	ret
 567++B2FA ~
 568++B2FA              	endif
 569++B2FA
 570++B2FA              ;------------------------------------------------------------------------------
 571++B2FA              chrCheckLFN	ifused
 572++B2FA              ;஢ઠ  ⨬ ᨬ  LFN
 573++B2FA              ;: z -  ⨬ ᨬ   䠩
 574++B2FA              ;
 575++B2FA              ;chrCheckLFN
 576++B2FA              ;
 577++B2FA E5           	push	hl
 578++B2FB C5           	push	bc
 579++B2FC 01 09 00     	ld	bc,endIllegalSym-IllegalLFN
 580++B2FF 21 61 B3     	ld	hl,IllegalLFN
 581++B302 ED B1        	cpir
 582++B304 C1           	pop	bc
 583++B305 E1           	pop	hl
 584++B306 C9           	ret
 585++B307
 586++B307              	endif
 587++B307
 588++B307              ;------------------------------------------------------------------------------
 589++B307              SkipSeparator	ifused
 590++B307              ;ய   ࠧ⥫   
 591++B307              ;:  hl -   , 㪠뢠騩  ࠧ⥫
 592++B307              ;: hl -  砫   
 593++B307              ;
 594++B307              ;SkipSeparator
 595++B307              ;
 596++B307 7E           loop031	ld	a,(hl)
 597++B308 FE 2F        	cp	fnSep1		;"/"
 598++B30A 28 03        	jr	z,goto063
 599++B30C FE 5C        	cp	fnSep2		;"\"
 600++B30E C0           	ret	nz
 601++B30F 23           goto063	inc	hl
 602++B310 18 F5        	jr	loop031
 603++B312
 604++B312              	endif
 605++B312
 606++B312              ;------------------------------------------------------------------------------
 607++B312              toUpCaseHL	ifused
 608++B312              ;ॢ ᨬ [a..z], [..]  ப  孨 ॣ, 㤠
 609++B312              ;  㡫 ࠧ⥫
 610++B312              ;:  hl -  ப ᨬ
 611++B312              ;
 612++B312              ;toUpCaseHL
 613++B312              ;
 614++B312 D5           	push	de
 615++B313 E5           	push	hl
 616++B314
 617++B314 2B           	dec	hl
 618++B315 54           	ld	d,h
 619++B316 5D           	ld	e,l
 620++B317
 621++B317 23           loop050	inc	hl
 622++B318 13           loop021	inc	de
 623++B319 7E           	ld	a,(hl)
 624++B31A 12           	ld	(de),a
 625++B31B FE 20        	cp	#20
 626++B31D 38 2E        	jr	c,goto051
 627++B31F FE 5C        	cp	fnSep2		;"\"
 628++B321 28 2D        	jr	z,goto131
 629++B323 FE 2F        	cp	fnSep1		;"/"
 630++B325 28 29        	jr	z,goto131
 631++B327 FE 61        	cp	"a"
 632++B329 38 EC        	jr	c,loop050
 633++B32B FE 7B        	cp	"z"+1
 634++B32D 38 19        	jr	c,goto052
 635++B32F FE A0        	cp	#A0		;rus 
 636++B331 38 E4        	jr	c,loop050
 637++B333 FE B0        	cp	#B0		;rus 
 638++B335 38 11        	jr	c,goto052
 639++B337 FE E0        	cp	#E0		;rus 
 640++B339 38 DC        	jr	c,loop050
 641++B33B FE F0        	cp	#F0		;rus 
 642++B33D 38 07        	jr	c,goto053
 643++B33F FE F1        	cp	#F1		;rus 
 644++B341 20 D4        	jr	nz,loop050
 645++B343 3D           	dec	a
 646++B344 18 04        	jr	goto054
 647++B346 E6 9F        goto053	and	#9F
 648++B348 E6 DF        goto052	and	#DF
 649++B34A 12           goto054	ld	(de),a
 650++B34B 18 CA        	jr	loop050
 651++B34D
 652++B34D E1           goto051	pop	hl
 653++B34E D1           	pop	de
 654++B34F C9           	ret
 655++B350
 656++B350 CD 07 B3     goto131	call	SkipSeparator
 657++B353 3E 2F        	ld	a,fnSep		;"/"
 658++B355 12           	ld	(de),a
 659++B356 18 C0        	jr	loop021
 660++B358
 661++B358              	endif
 662++B358
 663++B358              ;==============================================================================
 664++B358              ;⨬ ᨬ   䠩
 665++B358 20 2E        IllegalSym	db " ."
 666++B35A 2B 5B 5D 3D  		db "+[]=,"
 666++B35E 2C
 667++B35F 7F 3B        		db #7F,#3B
 668++B361 2F 3A 2A 3F  IllegalLFN	db "/:*?<>|",#22,#5C
 668++B365 3C 3E 7C 22
 668++B369 5C
 669++B36A              endIllegalSym
 670++B36A              ;==============================================================================
 671++B36A
# file closed: Drivers/DrvFAT/DrvFAT.str.a80
 138+ B36A              	INCLUDE	"DrvFAT.misc.a80"
# file opened: Drivers/DrvFAT/DrvFAT.misc.a80
   1++B36A              ;楤  FAT Driver. 楤 饣 祭
   2++B36A              ;䠩 DrvFAT.misc.a80
   3++B36A              ;
   4++B36A              ;excngCLSCurrDir	 ⠬  砫 ⥪饣 ⠫
   5++B36A              ;sizeBytes2Cls		᫥ ࠧ  
   6++B36A              ;altDEHLdivBC		 de'hl'=de'hl'/bc
   7++B36A              ;cmp_adrDE_adrHL	ࠢ 4- ᫠/ப  ᠬ  de  hl
   8++B36A              ;cmp_adrDE_adrHL_3b	ࠢ 3- ᫠/ப  ᠬ  de  hl
   9++B36A              ;SetZeroDEHL		㫥 dehl
  10++B36A              ;SetZero2tmpDWORD	⠭   ६ tmpDWORD
  11++B36A              ;cmp_DEHL_adrBC		ࠢ ᫠ dehl  ᫠    bc
  12++B36A              ;StoreCLSCurrDir	࠭/⠭  砫 ⥪饣
  13++B36A              ;			⠫  ६ ६
  14++B36A              ;CopyDWORD_HL_DE	஢  ᫮    hl    de
  15++B36A              ;Inc_addrHL		६ ६ DWORD    hl
  16++B36A              ;Inc_DEHL		६ dehl=dehl+1
  17++B36A              ;Dec_DEHL		६ dehl=dehl-1
  18++B36A              ;LD_DEHL_adrHL		㧪 ᫠  ॣ  
  19++B36A              ;Add_DEHL_adrBC		᫮ 4-⭮ ᫠   bc  dehl
  20++B36A              ;SRL_dehl_A		 dehl=dehl/a (a - ⥯ )
  21++B36A              ;
  22++B36A              ;------------------------------------------------------------------------------
  23++B36A              excngCLSCurrDir	ifused
  24++B36A              ; ⠬  砫 ⥪饣 ⠫
  25++B36A              ;:  hl -  ६   ஬ ⠫
  26++B36A              ;
  27++B36A              ;excngCLSCurrDir
  28++B36A              ;
  29++B36A 11 84 8D     	ld	de,CLS_CurrDir
  30++B36D 06 04        	ld	b,#04
  31++B36F 4E           loop042	ld	c,(hl)
  32++B370 1A           	ld	a,(de)
  33++B371 77           	ld	(hl),a
  34++B372 79           	ld	a,c
  35++B373 12           	ld	(de),a
  36++B374 13           	inc	de
  37++B375 23           	inc	hl
  38++B376 10 F7        	djnz	loop042
  39++B378
  40++B378 C9           	ret
  41++B379
  42++B379              	endif
  43++B379
  44++B379              ;------------------------------------------------------------------------------
  45++B379              sizeBytes2Cls	ifused
  46++B379              ;᫥ ࠧ  
  47++B379              ;:  dehl - ࠧ  
  48++B379              ;: cy=1, nz -> a=errNumTooBig - ᫨誮 让 ࠧ,  #FFFF ஢
  49++B379              ;                 ehl - ࠧ  
  50++B379              ;                 bc - ⢮   ᫥ 
  51++B379              ;     cy=1, z ->  a=errFileEmpty - 㫥 ࠧ 䠩
  52++B379              ;     cy=0 ⠫ ᯥ譮
  53++B379              ;        hl - ࠧ  
  54++B379              ;        bc - ⢮   ᫥ 
  55++B379              ;        a,de=#0000
  56++B379              ;
  57++B379              ;sizeBytes2Cls
  58++B379              ;
  59++B379              ;஢ਬ   
  60++B379 7D           	ld	a,l
  61++B37A B4           	or	h
  62++B37B B3           	or	e
  63++B37C B2           	or	d
  64++B37D 3E 75        	ld	a,errFileEmpty
  65++B37F 37           	scf
  66++B380 C8           	ret	z		;㫥 
  67++B381
  68++B381              ;᫥ ࠧ  
  69++B381 3A 76 8D     	ld	a,(LenCLSInSec)
  70++B384 0E FF        	ld	c,#FF
  71++B386 CB 3A        loop039	srl	d
  72++B388 CB 1B        	rr	e
  73++B38A CB 1C        	rr	h
  74++B38C CB 1D        	rr	l
  75++B38E CB 19        	rr	c
  76++B390 1F           	rra
  77++B391 30 F3        	jr	nc,loop039
  78++B393 45           	ld	b,l
  79++B394 18 04        	jr	goto089
  80++B396 CB 38        loop040	srl	b
  81++B398 CB 19        	rr	c
  82++B39A 0F           goto089	rrca
  83++B39B 30 F9        	jr	nc,loop040
  84++B39D              ;bc ࠧ ⪠ 䠩  
  85++B39D              ;deh ⢮ ஢
  86++B39D
  87++B39D 6C           	ld	l,h
  88++B39E 63           	ld	h,e
  89++B39F 5A           	ld	e,d
  90++B3A0 78           	ld	a,b
  91++B3A1 B1           	or	c
  92++B3A2 C4 05 B4     	call	nz,Inc_DEHL
  93++B3A5 7B           	ld	a,e
  94++B3A6 B2           	or	d
  95++B3A7 C8           	ret	z
  96++B3A8
  97++B3A8              ;訡 ८ࠧ
  98++B3A8 3E 11        	ld	a,errNumTooBig	;number too big
  99++B3AA B7           	or	a
 100++B3AB 37           	scf
 101++B3AC C9           	ret
 102++B3AD
 103++B3AD              	endif
 104++B3AD
 105++B3AD ~            /*     ᨨ 室 㣮
 106++B3AD ~            sizeBytes2Cls	ifused
 107++B3AD ~            ;᫥ ࠧ  
 108++B3AD ~            ;:  dehl - ࠧ  
 109++B3AD ~            ;: cy=1 訡
 110++B3AD ~            ;        a=errNumTooBig - ᫨誮 让 ࠧ
 111++B3AD ~            ;        a=errFileEmpty - 㫥 ࠧ 䠩
 112++B3AD ~            ;     cy=0 ⠫ ᯥ譮
 113++B3AD ~            ;        bc,hl - ࠧ  
 114++B3AD ~            ;        a,de=#0000
 115++B3AD ~            ;
 116++B3AD ~            ;sizeBytes2Cls
 117++B3AD ~            ;
 118++B3AD ~            ;᫥ ࠧ  
 119++B3AD ~            	ld	a,l
 120++B3AD ~            	or	h
 121++B3AD ~            	or	e
 122++B3AD ~            	or	d
 123++B3AD ~            	ld	a,errFileEmpty
 124++B3AD ~            	scf
 125++B3AD ~            	ret	z
 126++B3AD ~            	ld	a,l
 127++B3AD ~            	ld	l,h
 128++B3AD ~            	ld	h,e
 129++B3AD ~            	ld	e,d
 130++B3AD ~            	ld	d,#00
 131++B3AD ~            	push	af
 132++B3AD ~            	exx
 133++B3AD ~            	ld	a,(LenCLSInSec)
 134++B3AD ~            	add	a,a
 135++B3AD ~            	ld	c,a
 136++B3AD ~            	ld	a,#00
 137++B3AD ~            	adc	a,#00
 138++B3AD ~            	ld	b,a
 139++B3AD ~            	call	altDEHLdivBC
 140++B3AD ~            	pop	af
 141++B3AD ~            	or	l
 142++B3AD ~            	or	h
 143++B3AD ~            	exx
 144++B3AD ~            	call	nz,Inc_DEHL	; ⮪  . ਡ  
 145++B3AD ~            	ld	c,l
 146++B3AD ~            	ld	b,h		;ࠧ  
 147++B3AD ~            	ld	a,d
 148++B3AD ~            	or	e
 149++B3AD ~            	ret	z
 150++B3AD ~            ;訡 ८ࠧ
 151++B3AD ~            	ld	a,errNumTooBig	;number too big
 152++B3AD ~            	scf
 153++B3AD ~            	ret
 154++B3AD ~
 155++B3AD ~            	endif
 156++B3AD ~            */
 157++B3AD
 158++B3AD              ;------------------------------------------------------------------------------
 159++B3AD              altDEHLdivBC	ifused
 160++B3AD ~            ; de'hl'=de'hl'/bc
 161++B3AD ~            ;:  de'hl' - 
 162++B3AD ~            ;     bc - ⥫
 163++B3AD ~            ;: de'hl' - 祭
 164++B3AD ~            ;     hl ⮪  
 165++B3AD ~            ;
 166++B3AD ~            ;altDEHLdivBC
 167++B3AD ~            ;
 168++B3AD ~            	ld	hl,#0000
 169++B3AD ~            	push	hl
 170++B3AD ~            	ld	e,l
 171++B3AD ~            	ld	d,h
 172++B3AD ~            	exx
 173++B3AD ~            	ld	b,#20
 174++B3AD ~            loop015	xor	a
 175++B3AD ~            	rl	l
 176++B3AD ~            	rl	h
 177++B3AD ~            	rl	e
 178++B3AD ~            	rl	d
 179++B3AD ~            	exx
 180++B3AD ~            	rl	l
 181++B3AD ~            	rl	h
 182++B3AD ~            	rl	e
 183++B3AD ~            	rl	d
 184++B3AD ~            	rla
 185++B3AD ~            	or	a
 186++B3AD ~            	sbc	hl,bc
 187++B3AD ~            	ex	(sp),hl
 188++B3AD ~            	ex	de,hl
 189++B3AD ~            	sbc	hl,de
 190++B3AD ~            	ex	de,hl
 191++B3AD ~            	ex	(sp),hl
 192++B3AD ~            	exx
 193++B3AD ~            	sbc	a,#00
 194++B3AD ~            	jr	nz,goto041
 195++B3AD ~            loop016	inc	l
 196++B3AD ~            	djnz	loop015
 197++B3AD ~            	inc	sp
 198++B3AD ~            	inc	sp
 199++B3AD ~            	exx
 200++B3AD ~            	ret
 201++B3AD ~            loop014	xor	a
 202++B3AD ~            	rl	l
 203++B3AD ~            	rl	h
 204++B3AD ~            	rl	e
 205++B3AD ~            	rl	d
 206++B3AD ~            	exx
 207++B3AD ~            	rl	l
 208++B3AD ~            	rl	h
 209++B3AD ~            	rl	e
 210++B3AD ~            	rl	d
 211++B3AD ~            	rla
 212++B3AD ~            	add	hl,bc
 213++B3AD ~            	ex	(sp),hl
 214++B3AD ~            	ex	de,hl
 215++B3AD ~            	adc	hl,de
 216++B3AD ~            	ex	de,hl
 217++B3AD ~            	ex	(sp),hl
 218++B3AD ~            	exx
 219++B3AD ~            	sbc	a,#00
 220++B3AD ~            	jr	z,loop016
 221++B3AD ~            goto041	djnz	loop014
 222++B3AD ~            	exx
 223++B3AD ~            	add	hl,bc
 224++B3AD ~            	jr	nc,goto042
 225++B3AD ~            	inc	de
 226++B3AD ~            goto042	inc	sp
 227++B3AD ~            	inc	sp
 228++B3AD ~            	ret
 229++B3AD ~
 230++B3AD              	endif
 231++B3AD
 232++B3AD              ;------------------------------------------------------------------------------
 233++B3AD              cmp_adrDE_adrHL	ifused
 234++B3AD              ;ࠢ  4- ᫠/ப  ᠬ  de  hl
 235++B3AD              ;:  z - ࠢ
 236++B3AD              ;     nz -  ࠢ
 237++B3AD              ;cmp_adrDE_adrHL
 238++B3AD              ;
 239++B3AD 1A           	ld	a,(de)
 240++B3AE BE           	cp	(hl)
 241++B3AF C0           	ret	nz
 242++B3B0 23           	inc	hl
 243++B3B1 13           	inc	de
 244++B3B2 18 FE        	jr	cmp_adrDE_adrHL_3b
 245++B3B4              	org	$-2
 246++B3B2
 247++B3B2              	endif
 248++B3B2
 249++B3B2              ;------------------------------------------------------------------------------
 250++B3B2              cmp_adrDE_adrHL_3b	ifused
 251++B3B2              ;ࠢ  3- ᫠/ப  ᠬ  de  hl
 252++B3B2              ;:  z - ࠢ
 253++B3B2              ;     nz -  ࠢ
 254++B3B2              ;cmp_adrDE_adrHL_3b
 255++B3B2              ;
 256++B3B2 1A           	ld	a,(de)
 257++B3B3 BE           	cp	(hl)
 258++B3B4 C0           	ret	nz
 259++B3B5 23           	inc	hl
 260++B3B6 13           	inc	de
 261++B3B7 1A           	ld	a,(de)
 262++B3B8 BE           	cp	(hl)
 263++B3B9 C0           	ret	nz
 264++B3BA 23           	inc	hl
 265++B3BB 13           	inc	de
 266++B3BC 1A           	ld	a,(de)
 267++B3BD BE           	cp	(hl)
 268++B3BE C9           	ret
 269++B3BF
 270++B3BF              	endif
 271++B3BF
 272++B3BF              ;------------------------------------------------------------------------------
 273++B3BF              SetZeroDEHL	ifused
 274++B3BF              ;㫥 dehl
 275++B3BF              ;: dehl=#00000000
 276++B3BF              ;
 277++B3BF              ;SetZeroDEHL
 278++B3BF              ;
 279++B3BF 21 00 00     	ld	hl,#0000
 280++B3C2 5D           	ld	e,l
 281++B3C3 55           	ld	d,l
 282++B3C4 C9           	ret
 283++B3C5
 284++B3C5              	endif
 285++B3C5
 286++B3C5              ;------------------------------------------------------------------------------
 287++B3C5              SetZero2tmpDWORD	ifused
 288++B3C5              ;⠭   ६ tmpDWORD
 289++B3C5              ;
 290++B3C5              ;SetZero2tmpDWORD
 291++B3C5              ;
 292++B3C5 01 00 00     	ld	bc,#0000
 293++B3C8 ED 43 A5 8D  	ld	(tmpDWORD),bc
 294++B3CC ED 43 A7 8D  	ld	(tmpDWORD+2),bc
 295++B3D0 C9           	ret
 296++B3D1
 297++B3D1              	endif
 298++B3D1
 299++B3D1              ;------------------------------------------------------------------------------
 300++B3D1              cmp_DEHL_adrBC	ifused
 301++B3D1              ;ࠢ ᫠ dehl  ᫠    bc
 302++B3D1              ;:  dehl - 4 ⭮ ᫮
 303++B3D1              ;     bc -  4 ⭮ ᫠
 304++B3D1              ;: nz,nc,p - dehl<(bc)
 305++B3D1              ;     nz,c,m - dehl>(bc)
 306++B3D1              ;     z,nc,p  - dehl=(bc)
 307++B3D1              ;
 308++B3D1              ;cmp_DEHL_adrBC
 309++B3D1              ;
 310++B3D1 03           	inc	bc
 311++B3D2 03           	inc	bc
 312++B3D3 03           	inc	bc
 313++B3D4 0A           	ld	a,(bc)			;ࠢ  +3
 314++B3D5 BA           	cp	d
 315++B3D6 38 19        	jr	c,goto010		;d > (bc)
 316++B3D8 20 1B        	jr	nz,goto011		;d < (bc)
 317++B3DA 0B           	dec	bc
 318++B3DB 0A           	ld	a,(bc)			;ࠢ  +2
 319++B3DC BB           	cp	e
 320++B3DD 38 12        	jr	c,goto010		;e > (bc)
 321++B3DF 20 14        	jr	nz,goto011		;e < (bc)
 322++B3E1 0B           	dec	bc
 323++B3E2 0A           	ld	a,(bc)			;ࠢ  +1
 324++B3E3 BC           	cp	h
 325++B3E4 38 0B        	jr	c,goto010		;h > (bc)
 326++B3E6 20 0D        	jr	nz,goto011		;h < (bc)
 327++B3E8 0B           	dec	bc
 328++B3E9 0A           	ld	a,(bc)			;ࠢ  +0
 329++B3EA BD           	cp	l
 330++B3EB 38 04        	jr	c,goto010		;l > (bc)
 331++B3ED 20 06        	jr	nz,goto011		;l < (bc)
 332++B3EF
 333++B3EF              ;z,nc,p  - dehl=(bc)
 334++B3EF AF           	xor	a
 335++B3F0 C9           	ret
 336++B3F1
 337++B3F1              ;nz,c,m - dehl>(bc)
 338++B3F1 AF           goto010	xor	a
 339++B3F2 D6 01        	sub	#01
 340++B3F4 C9           	ret
 341++B3F5
 342++B3F5              ;nz,nc,p - dehl<(bc)
 343++B3F5 AF           goto011	xor	a
 344++B3F6 C6 01        	add	a,#01
 345++B3F8 C9           	ret
 346++B3F9
 347++B3F9              	endif
 348++B3F9
 349++B3F9              ;------------------------------------------------------------------------------
 350++B3F9              StoreCLSCurrDir	ifused
 351++B3F9 ~            ;࠭/⠭  砫 ⥪饣 ⠫  ६ ६
 352++B3F9 ~            ;:  cy=0 ࠭ 
 353++B3F9 ~            ;     cy=1 ⠭ 
 354++B3F9 ~            ;
 355++B3F9 ~            ;StoreCLSCurrDir
 356++B3F9 ~            ;
 357++B3F9 ~            	push	hl
 358++B3F9 ~            	push	de
 359++B3F9 ~            	ld	hl,CLS_CurrDir
 360++B3F9 ~            	ld	de,tmpDIR
 361++B3F9 ~            	jr	nc,goto132
 362++B3F9 ~            	ex	de,hl
 363++B3F9 ~            	jr	goto132
 364++B3F9 ~            	jr	CopyDWORD_HL_DE
 365++B3F9 ~            	org	$-2
 366++B3F9 ~
 367++B3F9              	endif
 368++B3F9
 369++B3F9              ;------------------------------------------------------------------------------
 370++B3F9              CopyDWORD_HL_DE	ifused
 371++B3F9              ;஢  ᫮    hl    de
 372++B3F9              ;
 373++B3F9              ;CopyDWORD_HL_DE
 374++B3F9              ;
 375++B3F9 E5           	push	hl
 376++B3FA D5           	push	de
 377++B3FB C5           goto132	push	bc
 378++B3FC 01 04 00     	ld	bc,#0004
 379++B3FF ED B0        	ldir
 380++B401 C1           	pop	bc
 381++B402 D1           	pop	de
 382++B403 E1           	pop	hl
 383++B404 C9           	ret
 384++B405
 385++B405              	endif
 386++B405
 387++B405              ;------------------------------------------------------------------------------
 388++B405              Inc_addrHL	ifused
 389++B405 ~            ;६ ६ DWORD    hl
 390++B405 ~            ;: z - ९ ६ ⠫ =#00000000
 391++B405 ~            ;Inc_addrHL
 392++B405 ~            ;
 393++B405 ~            	inc	(hl)
 394++B405 ~            	ret	nz
 395++B405 ~            	inc	hl
 396++B405 ~            	inc	(hl)
 397++B405 ~            	ret	nz
 398++B405 ~            	inc	hl
 399++B405 ~            	inc	(hl)
 400++B405 ~            	ret	nz
 401++B405 ~            	inc	hl
 402++B405 ~            	inc	(hl)
 403++B405 ~            	ret
 404++B405 ~
 405++B405              	endif
 406++B405
 407++B405              ;------------------------------------------------------------------------------
 408++B405              Inc_DEHL	ifused
 409++B405              ;६ dehl=dehl+1
 410++B405              ;: z - ९ dehl=#00000000
 411++B405              ;Inc_DEHL
 412++B405              ;
 413++B405 2C           	inc	l
 414++B406 C0           	ret	nz
 415++B407 24           	inc	h
 416++B408 C0           	ret	nz
 417++B409 1C           	inc	e
 418++B40A C0           	ret	nz
 419++B40B 14           	inc	d
 420++B40C C9           	ret
 421++B40D
 422++B40D              	endif
 423++B40D
 424++B40D              ;------------------------------------------------------------------------------
 425++B40D              Dec_DEHL	ifused
 426++B40D ~            ;६ dehl=dehl-1
 427++B40D ~            ;Dec_DEHL
 428++B40D ~            ;
 429++B40D ~            	dec	hl
 430++B40D ~            	ld	a,l
 431++B40D ~            	and	h
 432++B40D ~            	inc	a
 433++B40D ~            	ret	nz
 434++B40D ~            	dec	de
 435++B40D ~            	ret
 436++B40D ~
 437++B40D              	endif
 438++B40D
 439++B40D              ;------------------------------------------------------------------------------
 440++B40D              LD_DEHL_adrHL	ifused
 441++B40D              ;㧪 ᫠  ॣ  
 442++B40D              ;:  hl -  㤠 㧨
 443++B40D              ;: dehl - ᫮
 444++B40D              ;
 445++B40D              ;LD_DEHL_adrHL
 446++B40D              ;
 447++B40D 5E           	ld	e,(hl)
 448++B40E 23           	inc	hl
 449++B40F 56           	ld	d,(hl)
 450++B410 23           	inc	hl
 451++B411 D5           	push	de
 452++B412 5E           	ld	e,(hl)
 453++B413 23           	inc	hl
 454++B414 56           	ld	d,(hl)
 455++B415 E1           	pop	hl
 456++B416 C9           	ret
 457++B417
 458++B417              	endif
 459++B417
 460++B417              ;------------------------------------------------------------------------------
 461++B417              Add_DEHL_adrBC	ifused
 462++B417              ;᫮ 4-⭮ ᫠   bc  dehl
 463++B417              ;: dehl=dehl+(bc)
 464++B417              ;
 465++B417              ;Add_DEHL_adrBC
 466++B417              ;
 467++B417 0A           	ld	a,(bc)
 468++B418 03           	inc	bc
 469++B419 85           	add	a,l
 470++B41A 6F           	ld	l,a
 471++B41B 0A           	ld	a,(bc)
 472++B41C 03           	inc	bc
 473++B41D 8C           	adc	a,h
 474++B41E 67           	ld	h,a
 475++B41F 0A           	ld	a,(bc)
 476++B420 03           	inc	bc
 477++B421 8B           	adc	a,e
 478++B422 5F           	ld	e,a
 479++B423 0A           	ld	a,(bc)
 480++B424 8A           	adc	a,d
 481++B425 57           	ld	d,a
 482++B426 C9           	ret
 483++B427
 484++B427              	endif
 485++B427
 486++B427              ;------------------------------------------------------------------------------
 487++B427              ; dehl=dehl/a (a - ⥯ )
 488++B427              ;
 489++B427 CB 3A        loop034	srl	d
 490++B429 CB 1B        	rr	e
 491++B42B CB 1C        	rr	h
 492++B42D CB 1D        	rr	l
 493++B42F              ;
 494++B42F              SRL_dehl_A
 495++B42F              ;
 496++B42F 0F           	rrca
 497++B430 30 F5        	jr	nc,loop034
 498++B432 C9           	ret
 499++B433
 500++B433              ;==============================================================================
 501++B433
# file closed: Drivers/DrvFAT/DrvFAT.misc.a80
 139+ B433              	INCLUDE	"DrvFAT.var.a80"
# file opened: Drivers/DrvFAT/DrvFAT.var.a80
   1++B433              ;६ FAT Driver
   2++B433              ;䠩 DrvFAT.var.a80
   3++B433              ;
   4++B433              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   5++B433              	ifdef	VarsInDrv
   6++B433 ~            VarsFAT	ds	#5B
   7++B433              	else
   8++B433
   9++B433              ;६ ⥪饣 FAT32 ࠧ
  10++B433              CurrentPart	equ VarsFAT+#00	;1 bit 1-0,  ந樫஢ ࠧ FAT
  11++B433                                              ;  bit 3-2,  ன⢠
  12++B433              				;           =00 HDD master
  13++B433              				;           =01 HDD slave
  14++B433              				;           =10 SD card
  15++B433              FlgFAT		equ VarsFAT+#01	;1 䫠
  16++B433              				;  0,=1 NextFreeCluster  ⠭  #FF
  17++B433              AdrPartBegin	equ VarsFAT+#02	;4  砫 ࠧ
  18++B433              AdrFsInfo	equ VarsFAT+#06	;2 ᬥ饭 ᥪ FSInfo  砫 ࠧ
  19++B433              AdrFATonHDD	equ VarsFAT+#08	;4 砫 ࢮ FAT-⠡
  20++B433              AdrDataBegin	equ VarsFAT+#0C	;4  ࢮ ᥪ  ࠧ  BPB
  21++B433              				;  (ᬥ饭  砫 ࠧ)
  22++B433              LenOfPartFAT	equ VarsFAT+#10	;4 ⢮ ᥪ஢  ࠧ
  23++B433              LenFATinSec	equ VarsFAT+#14	;4 ⢮ ᥪ஢   FAT
  24++B433              NumsFATonPart	equ VarsFAT+#18	;1 ⢮  FAT  ⥪饬 ࠧ
  25++B433              LenCLSInSec	equ VarsFAT+#19	;1 ࠧ   ᥪ
  26++B433              RootClaster	equ VarsFAT+#1A	;4  ࢮ   ⠫
  27++B433              FsIFreeCls	equ VarsFAT+#1E	;4 ᫮ ᢮ ஢
  28++B433              				;  =#FFFFFFFF ⭮
  29++B433              FsINextCls	equ VarsFAT+#22	;4    ண  ᪠
  30++B433              				;  ᢮ 
  31++B433              				;  =#FFFFFFFF ⭮
  32++B433
  33++B433
  34++B433              ;६  ࠡ  FAT
  35++B433              @CurrentLevel	equ VarsFAT+#26	;1 㡨   ⥪饬 ⠫
  36++B433              @CLS_CurrDir	equ VarsFAT+#27	;4   ⥪饩 ४ਨ
  37++B433              tmpDIR		equ VarsFAT+#2B	;4   ६ ४ਨ
  38++B433              @DescInCurrDir	equ VarsFAT+#2F	;2  ⥪饩   ⠫
  39++B433              @DescInDIR	equ VarsFAT+#31	;2 ⢮ ᥩ  ⥪饬 ⠫
  40++B433              @Ext4Found	equ VarsFAT+#33	;2  ᯨ᪠ ७  ⮡ࠦ
  41++B433              @SecFATinBuf	equ VarsFAT+#35	;4  ᥪ FAT, 㦥
  42++B433              				;    Buf4FAT
  43++B433              @SecDIRinBuf	equ VarsFAT+#39	;4  ᥪ ⠫, 㦥
  44++B433              				;    Buf4DIR
  45++B433
  46++B433
  47++B433              ; ᪮७ ⥭ 䠩
  48++B433              NumFstCluster	equ VarsFAT+#3D	;4  ࢮ  ⥪饣 䠩
  49++B433              NumCluster	equ VarsFAT+#41	;2 浪    ।騬
  50++B433              				;  ⠭ ᥪ஬ ⥪饣 䠩
  51++B433              NumSecCls	equ VarsFAT+#43	;1 浪  ᥪ  
  52++B433              				;  ।騩 ⠭ ᥪ ண 
  53++B433              				;  
  54++B433              SecFileInBuf	equ VarsFAT+#44	;4  ᥪ 䠩, 㦥  
  55++B433
  56++B433              ; ६ ࠭ ६
  57++B433              tmpDWORD	equ VarsFAT+#48	;4 ६ ६  ࠧ 㦤
  58++B433              				;  ᯮ  楤:
  59++B433              				;  CountFreeCls
  60++B433              				;  SetNClsInFAT
  61++B433              				;  AddCls2Chain
  62++B433              				;  FreeClsChain
  63++B433              				;  FindFreeCls
  64++B433              				;  fatAddFreeSpace_dehl
  65++B433              				;  fatAddFreeSpace_var
  66++B433              				;  addFileFreeSpace
  67++B433              				;  findFreeDirEntry
  68++B433              				;  fatFormatPart
  69++B433              tmpDWORD2	equ VarsFAT+#4C	;+4 ६ ६  ࠧ 㦤
  70++B433              				;  ᯮ  楤:
  71++B433              				;  fatAddFreeSpace
  72++B433              @Name4Find	equ VarsFAT+#50	;11  䠩 FAT  ᪠  ⠫
  73++B433
  74++B433              	endif
  75++B433
  76++B433              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  77++B433              ; ஢  䠩/⠫
  78++B433              	ifused	Sym4Sort
  79++B433 ~            Sym4Sort	db ".!#$%&'()-0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`{}~",#7F
  80++B433 ~            		db "",#FF,0
  81++B433              	endif
  82++B433
  83++B433              ;------------------------------------------------------------------------------
  84++B433
# file closed: Drivers/DrvFAT/DrvFAT.var.a80
 140+ B433              End	;SAVEBIN	"drvfat.bin",Start,End-Start
 141+ B433              	DISPLAY "Lenght DrvFAT = ",/A,End-Start
 142+ B433
 143+ B433              	ENDMODULE
 144+ B433
# file closed: Drivers/DrvFAT/DrvFAT.main.a80
5244  B433
5245  B433 00 00 00...  		align 8
5246  B438 5A 58 4E     trn_buf	db	"ZXN" ;тут пакет для передачи
5247  B43B
5248  B43B              end_ ;ниже буферы, в файл не выгружаются
5249  B43B
5250  B43B 00 00 00...  	ds 2048
5251  BC3B
5252  BC3B 00 00 00...  cipstart_line ds 256 ;буфер для строки соединения
5253  BD3B
5254  BD3B 00 00 00...  file_fcb_tmp ds 32 ;временно
5255  BD5B 00 00 00...  file_name_cur ds file_name_len+3 ;временно
5256  BD6A 00 00 00...  file_cfg_name_buf ds 256
5257  BE6A
5258  BE6A
5259  BE6A 00 00 00...  	align 8
5260  BE70 00 00 00...  cat_r2 ds  2048 ;буфер каталога справа (временная копия)
5261  C670              	align 8
5262  C670 00 00 00...  cat_open_trd ds 9*256+16 ;буфер каталога открытого образа (правая панель)
5263  CF80              	align 128
5264  CF80 00 00 00...  cat_mark_l ds 128 ;база отмеченных файлов слева
5265  D000 00 00 00...  cat_mark_r ds 128 ;база отмеченных файлов справа
5266  D080 00 00 00...  cat_l ds cat_size_max ;9*256 ;буфер каталога диска (левая панель)
5267  EE80              cat_l_end
5268  EE80 00 00 00...  cat_r ds 2048 ;буфер каталога справа
5269  F680              cat_r_end
5270  F680 00 00 00...  rec_buf ds  2048 ;буфер приёма
5271  FE80
5272  FE80              ;сохранение файла настроек
5273  FE80              start_ini
5274  FE80              	incbin 'AY232K_i.C'
5275  FF2D              end_ini
5276  FF2D
5277  FF2D              	SAVETRD "AY232K.TRD",|"AY232K_i.C",start_ini,end_ini-start_ini
5278  FF2D              ;сохранение
5279  FF2D              end_all
5280  FF2D              	SAVETRD "AY232K.TRD",|"AY232K.C",start_,end_-start_
5281  FF2D
# file closed: ay232k.asm
