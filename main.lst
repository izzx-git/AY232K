# file opened: ay232k.asm
   1  0000              ;AY232K (izzx)
   2  0000              ;Клиент для обмена ZX-PC
   3  0000                  device ZXSPECTRUM128
   4  0000
   5  0000              	org #6000
   6  6000              start_
   7  6000              col_fon equ 7 ;цвет фона
   8  6000              ;col_len equ 9 ;атрибутов на имя файла
   9  6000              col_win equ 4*8+7 ;цвет окна сообщения
  10  6000              col_win2 equ 2*8+7 ;цвет окна сообщения
  11  6000              win_size equ 11 ;длина атрибутов окна сообщения
  12  6000              win_pos equ #5800+768/2+10+32+32 ;позиция окна сообщения
  13  6000              file_name_len equ 12 ;длина имени файла
  14  6000              lenghtName equ 16 ;длина имени файла в каталоге
  15  6000              scroll_len equ 13 ;длина области скрола сообщений
  16  6000              pack_size_1024_com equ 1024 ;длина основной части большого пакета
  17  6000              pack_size_1024 equ pack_size_1024_com+pack_size_32_com+2 ;длина пакета полная
  18  6000              pack_size_1024_full equ pack_size_1024+40 ;длина большого пакета со служебной информацией
  19  6000              pack_size_1024_echo equ 26 ;длина ответа ESP на отправку большого пакета
  20  6000              pack_size_32_com equ 32 ;длина основной части малого пакета (заголовка)
  21  6000              pack_size_32 equ pack_size_32_com+2 ;длина пакета заголовка полная
  22  6000              pack_size_32_full equ pack_size_32+40 ;длина малого пакета со служебной информацией ??
  23  6000              pack_size_32_echo equ 24 ;длина ответа ESP на отправку малого пакета
  24  6000              pack_size_256_com equ 256 ;длина основной части пакета 256
  25  6000              pack_size_256 equ pack_size_256_com+pack_size_32_com+2 ;длина пакета полная
  26  6000              pack_size_256_full equ pack_size_256+39 ;длина пакета 256 со служебной информацией
  27  6000              pack_size_256_echo equ 25 ;длина ответа ESP на отправку пакета 256
  28  6000              files_view equ 24-3 ;показывать файлов в каталоге
  29  6000              col_pos_l equ #5800 ;позиция для покраски левая панель
  30  6000              col_pos_r equ #5800+31-9 ;позиция для покраски правая панель
  31  6000              colorcatc_act equ 7*8+1 ;цвет выбранного файла активной панели
  32  6000              colorcat_ equ     1*8+7; фон панели файлов
  33  6000              retry_rec_count_max equ 50 ;число фреймов ожидания приёма байта
  34  6000              launch_name equ #5dd4 ;адрес имени файла в загрузчике для запуска
  35  6000              max_files equ 64 ;макс файлов в каталоге
  36  6000              max_files_trd equ 128 ;макс файлов в образе
  37  6000              ;fix equ 500 ;дополнительная длина пакета для надёжного приёма
  38  6000              check_init_max equ 10 ;число отправки повторного пакета до внеочередного сброса устройства
  39  6000              cat_size_max equ 15*512 ;максимум буфер каталога слева
  40  6000
  41  6000
  42  6000              start
  43  6000 3E 10            ld      a,#10
  44  6002 32 5C 5B         ld      (#5b5c),a ;sys var
  45  6005 3A 19 5D     	ld      a,(#5d19) ;текущий диск
  46  6008 32 60 73         ld      (cur_drive) ,a
  47  600B 3E 52        	ld a,"R"
  48  600D 32 6D 73     	ld (panel),a ;выбрать правую панель
  49  6010
  50  6010              	; DI
  51  6010              	; ;установим прерывания 2
  52  6010              	; ld a,interrupt_vec/256 ;вектор
  53  6010              	; ld i,a
  54  6010              	; im 2
  55  6010              	; ld hl,interrupt ;адрес обработчика
  56  6010              	; ld ((interrupt_vec/256)*256+#ff),hl ;
  57  6010              	; ei
  58  6010 CD B9 6E     	call cls_pic
  59  6013 CD AD 7B     	call read_cfg
  60  6016 CD 96 71     	call init_dev
  61  6019 CD 32 7C     	call init_hdd ;проверить разделы FAT
  62  601C              start_h
  63  601C CD B9 6E     	call cls_pic
  64  601F 21 70 75     	ld hl,mes_title
  65  6022 CD 82 77     	call print
  66  6025 21 E2 76     	ld hl,mes_server
  67  6028 CD 82 77     	call print
  68  602B 21 FD 76     	ld hl,mes_port
  69  602E CD 82 77     	call print
  70  6031
  71  6031 AF           	xor a ;обнулить переменные
  72  6032 32 67 73     	ld     (files),a
  73  6035 32 61 73     	ld     (shiftcat),a
  74  6038 32 68 73     	ld     (curfile),a
  75  603B 32 7D 73     	ld (cur_cat_pag),a
  76  603E 32 7E 73     	ld (cur_cat_pag+1),a
  77  6041              	;call init_dev
  78  6041 CD E1 62     	call renewcat_r
  79  6044 CD A9 62     	call renewcat_l
  80  6047
  81  6047              wait ;ожидание клавиши
  82  6047 CD C4 60     		call input_key
  83  604A
  84  604A              ;waitPass
  85  604A 79           			ld      a,c ;вспомним клавишу
  86  604B FE 45                    cp 		"E"
  87  604D CA 3C 61                 jp      z,exit
  88  6050 FE 06                    cp 		6 ;#36-" "
  89  6052 CA 71 61                 jp      z,down
  90  6055 FE 07                    cp 		7 ;#37-" "
  91  6057 CA BA 61                 jp      z,up
  92  605A FE 54                    cp 		"T" ;
  93  605C CA 91 6A                 jp      z,TRD ;copy TRD
  94  605F FE 52                    cp 		"R"
  95  6061 CA C1 60                 jp      z,readc
  96  6064 FE 31                    cp 		"1"
  97  6066 CA 71 62                 jp      z,driveA ;1
  98  6069 FE 41                    cp 		"A"
  99  606B CA 71 62                 jp      z,driveA ;A
 100  606E FE 32                    cp 		"2"
 101  6070 CA 7F 62                 jp      z,driveB ;2
 102  6073 FE 42                    cp 		"B"
 103  6075 CA 7F 62                 jp      z,driveB ;B
 104  6078 FE 33                    cp 		"3"
 105  607A CA 8D 62                 jp      z,driveC ;3
 106  607D FE 43                    cp 		"C"
 107  607F CA 8D 62                 jp      z,driveC ;C
 108  6082 FE 34                    cp 		"4"
 109  6084 CA 9B 62                 jp      z,driveD ;4
 110  6087 FE 44                    cp 		"D"
 111  6089 CA 9B 62                 jp      z,driveD ;D
 112  608C FE 48        			cp 		"H"
 113  608E CA 4B 7E                 jp      z,select_hdd ;снова на выбор HDD
 114  6091 FE 0E                    cp 		#0e ;-" " ;CS+SS
 115  6093 CA 24 71                 jp      z,change_panel ;S
 116  6096 FE 05                    cp 		5 ;#35-" "
 117  6098 CA 06 62                 jp      z,left
 118  609B FE 08                    cp 		8 ;#38-" "
 119  609D CA 2A 62                 jp      z,right
 120  60A0                          ; cp 		"I"
 121  60A0                          ; jp      z,ShowInfo ;I
 122  60A0              			; cp 		"S"
 123  60A0                          ; jp      z,check_sum_tog ;S
 124  60A0 FE 0D                    cp 		#0d
 125  60A2 CA 97 63                 jp      z,run_open ;enter
 126  60A5 FE 49        			cp 		"I"
 127  60A7 CA D6 65                 jp      z,esp_rst ;сброс ESP
 128  60AA FE 4B        			cp 		"K"
 129  60AC CA 7F 72                 jp      z,mark_all ;отметить все
 130  60AF FE 4A        			cp 		"J"
 131  60B1 CA 30 73                 jp      z,unmark_all ;включить ESP в режим translink
 132  60B4 FE 35                    cp 		"5"
 133  60B6 CA 07 66                 jp      z,copyF ;копирование по файлам
 134  60B9 FE 20                    cp 		" "
 135  60BB CA 2B 72                 jp      z,markF ;отметка файла
 136  60BE
 137  60BE C3 47 60                 jp      wait
 138  60C1
 139  60C1              readc
 140  60C1 C3 1C 60     			jp start_h
 141  60C4
 142  60C4
 143  60C4              input_key ;на выходе в c - код клавиши
 144  60C4 76                       halt
 145  60C5
 146  60C5 3A 65 73     			ld      a,(keyLast) ;предыдущая нажатая клавиша
 147  60C8 47           			ld		b,a
 148  60C9 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
 149  60CC              			;ld 		c,a
 150  60CC CD 08 61     			call 	input_key_curs
 151  60CF 7B           			ld 		a,e
 152  60D0 4F           			ld 		c,a
 153  60D1              			;ld      (23556),a
 154  60D1 32 65 73     			ld 		(keyLast),a ;запомним клавишу
 155  60D4 FE FF        			cp		#ff ;если сейчас ничего не нажато
 156  60D6 20 06        			jr		nz,wait1
 157  60D8 AF           			xor		a
 158  60D9 32 66 73     			ld		(keyDelayF),a ;обнулим флаг задержки
 159  60DC 18 E6        			jr      input_key ;и снова на ожидание
 160  60DE              wait1
 161  60DE 79           			ld		a,c
 162  60DF B8           			cp		b
 163  60E0 C0           			ret		nz ;если нажата первый раз, пропустим задержку
 164  60E1
 165  60E1 3A 66 73     			ld 		a,(keyDelayF)
 166  60E4 B7           			or		a
 167  60E5 C0           			ret		nz ;если всё ещё нажата и была пауза, пропустим
 168  60E6
 169  60E6              ;waitDelay
 170  60E6 3A 64 73     			ld      a,(keyRepeat) ;пауза
 171  60E9 47           			ld b,a
 172  60EA              waitDelay
 173  60EA 76                       halt
 174  60EB 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
 175  60EE CD 08 61     			call 	input_key_curs
 176  60F1 7B           			ld 		a,e
 177  60F2              			;ld      (23556),a
 178  60F2 32 65 73     			ld 		(keyLast),a ;запомним клавишу
 179  60F5 FE FF        			cp		#ff ;если сейчас ничего не нажато
 180  60F7 20 06        			jr		nz,waitDelay1
 181  60F9 AF           			xor		a
 182  60FA 32 66 73     			ld		(keyDelayF),a ;обнулим флаг задержки
 183  60FD 18 C5        			jr      input_key ;и снова на ожидание
 184  60FF              waitDelay1
 185  60FF 10 E9        			djnz waitDelay
 186  6101 3E 01        			ld		a,1
 187  6103 32 66 73     			ld		(keyDelayF),a ;установить флаг была пауза
 188  6106 18 BC        			jr      input_key ;и снова на ожидание
 189  6108
 190  6108              input_key_curs ;перехват курсора
 191  6108 5F           			ld e,a
 192  6109 3E FE        			ld a,#fe
 193  610B DB FE        			in a,(#fe)
 194  610D CB 47        			bit 0,a ;Caps
 195  610F C0           			ret nz
 196  6110 3E F7        			ld a,#f7
 197  6112 DB FE        			in a,(#fe)
 198  6114 CB 67        			bit 4,a
 199  6116 20 03        			jr nz,input_key_curs_1
 200  6118 1E 05        			ld e,5 ;left
 201  611A C9           			ret
 202  611B              input_key_curs_1
 203  611B 3E EF        			ld a,#ef
 204  611D DB FE        			in a,(#fe)
 205  611F CB 67        			bit 4,a
 206  6121 20 03        			jr nz,input_key_curs_2
 207  6123 1E 06        			ld e,6 ;down
 208  6125 C9           			ret
 209  6126              input_key_curs_2
 210  6126 CB 5F        			bit 3,a
 211  6128 20 03        			jr nz,input_key_curs_3
 212  612A 1E 07        			ld e,7 ;up
 213  612C C9           			ret
 214  612D              input_key_curs_3
 215  612D CB 57        			bit 2,a
 216  612F 20 03        			jr nz,input_key_curs_4
 217  6131 1E 08        			ld e,8 ;right
 218  6133 C9           			ret
 219  6134              input_key_curs_4
 220  6134 CB 47        			bit 0,a
 221  6136 C0           			ret nz
 222  6137 1E 00        			ld e,0 ;Back Space
 223  6139 C9           			ret
 224  613A
 225  613A
 226  613A              input_key_curs_e
 227  613A 79           			ld a,c
 228  613B C9           			ret
 229  613C
 230  613C
 231  613C              exit ;выход в DOS
 232  613C 3E 10                    ld      a,#10
 233  613E 32 5C 5B                 ld      (#5b5c),a ;sys var
 234  6141 21 58 27     			LD 		HL,10072
 235  6144 D9           			EXX
 236  6145              			;ld		bc,0
 237  6145 C9                       ret
 238  6146
 239  6146              wait_cont ;обновить переменные и продолжить
 240  6146 3A 6D 73     	ld a,(panel)
 241  6149 FE 4C        	cp "L"
 242  614B 20 12        	jr nz,wait_cont_r
 243  614D 3A 61 73     	ld     a,(shiftcat)
 244  6150 32 63 73     	ld     (shiftcat_l),a
 245  6153 3A 68 73     	ld     a,(curfile)
 246  6156 32 6C 73     	ld     (curfile_l),a
 247  6159 CD 37 71     	call   printcat
 248  615C C3 47 60         jp     wait
 249  615F              wait_cont_r
 250  615F 3A 61 73     	ld     a,(shiftcat)
 251  6162 32 62 73     	ld     (shiftcat_r),a
 252  6165 3A 68 73     	ld     a,(curfile)
 253  6168 32 6A 73     	ld     (curfile_r),a
 254  616B CD 37 71     	call   printcat
 255  616E C3 47 60         jp     wait
 256  6171
 257  6171              down ; вниз по каталогу
 258  6171 3A 67 73                 ld     a,(files)
 259  6174 4F                       ld     c,a
 260  6175 3A 61 73     			ld     a,(shiftcat)
 261  6178 47           			ld     b,a
 262  6179 3A 68 73                 ld     a,(curfile)
 263  617C 3C                       inc    a
 264  617D B9                       cp     c
 265  617E D2 91 61                 jp     nc,downE_upd ;подгрузка если дошли до конца
 266  6181 32 68 73                 ld     (curfile),a
 267  6184 90           			sub b
 268  6185                      ;    ld     a,(cursor)
 269  6185 FE 15                    cp     files_view ;не пора ли сдвинуться вниз всему каталогу
 270  6187 38 05                    jr     c,downE
 271  6189 04                       inc b
 272  618A 78                       ld   a,b
 273  618B 32 61 73                 ld     (shiftcat),a
 274  618E              downE
 275  618E C3 46 61                 jp     wait_cont
 276  6191              downE_upd
 277  6191              			;подгрузка страницы каталога
 278  6191 3A 6D 73     			ld a,(panel)
 279  6194 FE 52        			cp "R"
 280  6196 C2 46 61     			jp nz,wait_cont ;только для правой панели
 281  6199 3A 7C 73     			ld a,(open_trd_flag)
 282  619C B7           			or a
 283  619D C2 46 61     			jp nz,wait_cont ;не при открытом образе
 284  61A0 2A 7D 73     			ld hl,(cur_cat_pag)
 285  61A3 23           			inc hl
 286  61A4 22 7D 73     			ld (cur_cat_pag),hl
 287  61A7 AF           			xor a
 288  61A8 32 68 73     			ld (curfile),a
 289  61AB 32 61 73     			ld (shiftcat),a
 290  61AE 32 67 73     			ld (files),a
 291  61B1 CD 4C 65     			call cls_r
 292  61B4 CD E1 62     			call renewcat_r
 293  61B7 C3 46 61     			jp wait_cont
 294  61BA
 295  61BA
 296  61BA              up ; ; вверх по каталогу
 297  61BA
 298  61BA 3A 68 73                 ld     a,(curfile)
 299  61BD B7                       or     a
 300  61BE CA D8 61                 jp     z,upE_upd
 301  61C1 3D                       dec    a
 302  61C2 32 68 73                 ld     (curfile),a
 303  61C5 4F           			ld     c,a
 304  61C6 3A 61 73                 ld     a,(shiftcat)
 305  61C9 47           			ld b,a
 306  61CA 79           			ld a,c
 307  61CB 90           			sub b
 308  61CC FE 15        			cp files_view
 309  61CE 38 05        			jr c,upE
 310  61D0 05           			dec b
 311  61D1 78           			ld a,b
 312  61D2 32 61 73                 ld     (shiftcat),a
 313  61D5              upE
 314  61D5 C3 46 61                 jp     wait_cont
 315  61D8              upE_upd
 316  61D8              			;подгрузка страницы каталога
 317  61D8 3A 6D 73     			ld a,(panel)
 318  61DB FE 52        			cp "R"
 319  61DD C2 46 61     			jp nz,wait_cont ;только для правой панели
 320  61E0 3A 7C 73     			ld a,(open_trd_flag)
 321  61E3 B7           			or a
 322  61E4 C2 46 61     			jp nz,wait_cont ;не при открытом образе
 323  61E7 2A 7D 73     			ld hl,(cur_cat_pag)
 324  61EA 7C           			ld a,h
 325  61EB B5           			or l
 326  61EC CA 47 60     			jp z,wait
 327  61EF 2B           			dec hl
 328  61F0 22 7D 73     			ld (cur_cat_pag),hl
 329  61F3 AF           			xor a
 330  61F4 32 68 73     			ld (curfile),a
 331  61F7 32 61 73     			ld (shiftcat),a
 332  61FA 32 67 73     			ld (files),a
 333  61FD CD 4C 65     			call cls_r
 334  6200 CD E1 62     			call renewcat_r
 335  6203 C3 46 61     			jp wait_cont
 336  6206
 337  6206
 338  6206              left ; на страницу вверх
 339  6206
 340  6206 3A 68 73                 ld     a,(curfile)
 341  6209 B7                       or     a
 342  620A CA 47 60                 jp     z,wait
 343  620D D6 14                    sub    files_view-1
 344  620F 30 01                    jr     nc,left02
 345  6211 AF                       xor    a
 346  6212              left02
 347  6212 32 68 73                 ld     (curfile),a
 348  6215 4F                       ld     c,a
 349  6216              			;проверка сдвига
 350  6216 3A 61 73     			ld     a,(shiftcat)
 351  6219 47           			ld b,a
 352  621A 79           			ld     a,c
 353  621B 90           			sub b
 354  621C              			;cp files_view
 355  621C 30 09        			jr nc,leftE ;листать не надо
 356  621E
 357  621E 78           			ld a,b
 358  621F D6 14        			sub files_view-1
 359  6221 30 01        			jr nc,left03
 360  6223 AF           			xor a
 361  6224              left03
 362  6224 32 61 73                 ld     (shiftcat),a
 363  6227              leftE
 364  6227 C3 46 61                 jp     wait_cont
 365  622A
 366  622A
 367  622A
 368  622A
 369  622A              right; на страницу вниз
 370  622A 3A 67 73                 ld     a,(files) ;всего
 371  622D B7           			or     a
 372  622E CA 47 60                 jp     z,wait
 373  6231 4F                       ld     c,a
 374  6232 3A 68 73                 ld     a,(curfile) ;текущий
 375  6235 C6 14                    add    a,files_view-1 ;листаем вперёд
 376  6237 B9                       cp     c
 377  6238 38 04                    jr     c,right01 ;если не дошли до конца
 378  623A 3A 67 73                 ld     a,(files) ;иначе на последний файл
 379  623D 3D                       dec    a
 380  623E              right01
 381  623E 32 68 73                 ld     (curfile),a
 382  6241
 383  6241              			;проверка сдвига, листать каталог или нет
 384  6241 3A 67 73     			ld     a,(files)
 385  6244 4F           			ld c,a
 386  6245 FE 16        			cp files_view+1
 387  6247 38 25        			jr c,rightE ;выход если файлов меньше 25
 388  6249 3A 61 73                 ld     a,(shiftcat)
 389  624C 47           			ld b,a
 390  624D 3A 68 73     			ld     a,(curfile) ;текущий
 391  6250 90           			sub b
 392  6251 FE 15        			cp files_view
 393  6253 38 19        			jr c,rightE ;если не пора пролистать на страницу
 394  6255 3E 14        			ld a,files_view-1
 395  6257 80           			add b
 396  6258 B9           			cp c ;если больше чем всего файлов
 397  6259 38 05        			jr c,right04
 398  625B 79           			ld a,c
 399  625C D6 15        			sub files_view ;тогда максимум файлов - 24
 400  625E 18 0B        			jr right05
 401  6260              right04
 402  6260 47           			ld b,a ;и если до последнего файла не меньше 24х
 403  6261 79           			ld a,c
 404  6262 90           			sub b
 405  6263 FE 15        			cp files_view
 406  6265 78           			ld a,b
 407  6266 30 03        			jr nc,right05
 408  6268 79           			ld a,c
 409  6269 D6 15        			sub files_view ;тогда максимум файлов - 24
 410  626B
 411  626B              right05
 412  626B 32 61 73                 ld     (shiftcat),a ;новое смещение от начала каталога
 413  626E              rightE
 414  626E C3 46 61                 jp     wait_cont
 415  6271
 416  6271
 417  6271              ; check_sum_tog ;переключение использовать контрольную сумму или нет
 418  6271              			; ld a,(check_sum_on)
 419  6271              			; or a
 420  6271              			; jr z,check_sum_tog3
 421  6271              			; xor a
 422  6271              			; ld (check_sum_on),a
 423  6271              			; ld a,"N"
 424  6271              			; ld (mes_check_sum),a
 425  6271              			; jr check_sum_tog1
 426  6271
 427  6271              ; check_sum_tog3
 428  6271              			; ld a,1
 429  6271              			; ld (check_sum_on),a
 430  6271              			; ld a,"Y"
 431  6271              			; ld (mes_check_sum),a
 432  6271              ; check_sum_tog1
 433  6271              			; ld hl,mes_title
 434  6271              			; call print
 435  6271              			; call wait_releas
 436  6271                          ; jp     wait
 437  6271
 438  6271              driveA
 439  6271 3E 00                    ld      a,0
 440  6273 32 19 5D                 ld      (#5d19) ,a
 441  6276 32 60 73     			ld 		(cur_drive),a
 442  6279                          ; ld      c,1
 443  6279                          ; call    #3d13
 444  6279                          ; ld      c,#18
 445  6279                          ; call    #3d13
 446  6279 CD A9 62                 call    renewcat_l
 447  627C C3 47 60                 jp      wait
 448  627F              driveB
 449  627F 3E 01                    ld      a,1
 450  6281 32 19 5D                 ld      (#5d19) ,a
 451  6284 32 60 73     			ld 		(cur_drive),a
 452  6287                          ; ld      c,1
 453  6287                          ; call    #3d13
 454  6287                          ; ld      c,#18
 455  6287                          ; call    #3d13
 456  6287 CD A9 62                 call    renewcat_l
 457  628A C3 47 60                 jp      wait
 458  628D              driveC
 459  628D 3E 02                    ld      a,2
 460  628F 32 19 5D                 ld      (#5d19) ,a
 461  6292 32 60 73     			ld 		(cur_drive),a
 462  6295                          ; ld      c,1
 463  6295                          ; call    #3d13
 464  6295                          ; ld      c,#18
 465  6295                          ; call    #3d13
 466  6295 CD A9 62                 call    renewcat_l
 467  6298 C3 47 60                 jp      wait
 468  629B              driveD
 469  629B 3E 03                    ld      a,3
 470  629D 32 19 5D                 ld      (#5d19) ,a
 471  62A0 32 60 73     			ld 		(cur_drive),a
 472  62A3                          ; ld      c,1
 473  62A3                          ; call    #3d13
 474  62A3                          ; ld      c,#18
 475  62A3                          ; call    #3d13
 476  62A3 CD A9 62                 call    renewcat_l
 477  62A6 C3 47 60                 jp      wait
 478  62A9
 479  62A9
 480  62A9              renewcat_l   ;обновить каталог слева
 481  62A9 AF                       xor     a
 482  62AA 32 6C 73                 ld      (curfile_l),a ;каталог перелистнуть в начало
 483  62AD 32 63 73                 ld      (shiftcat_l),a
 484  62B0 3A 6D 73     			ld a,(panel)
 485  62B3 FE 4C        			cp "L"
 486  62B5 20 07        			jr nz,renewcat_l1
 487  62B7 AF           			xor a
 488  62B8 32 68 73                 ld      (curfile),a ;
 489  62BB 32 61 73                 ld      (shiftcat),a
 490  62BE              renewcat_l1
 491  62BE 21 00 CF     			ld hl,cat_mark_l ;очистить таблицу отмеченных файлов
 492  62C1 11 01 CF     			ld de,cat_mark_l+1
 493  62C4 36 00        			ld (hl),0
 494  62C6 01 7F 00     			ld bc,128-1
 495  62C9 ED B0        			ldir
 496  62CB CD 67 65     			call cls_l
 497  62CE              			;ld hl,mes_title
 498  62CE                          ;call    printFI
 499  62CE CD FD 70                 call    readcat
 500  62D1                          ; ld      a,(files)
 501  62D1                          ; or      a
 502  62D1                          ; jr      nz,renew01
 503  62D1                          ; ld      hl,mesnofile
 504  62D1                          ; call    print
 505  62D1              ; renew01
 506  62D1 CD 73 6F                 call    printcat_l
 507  62D4                          ; xor     a
 508  62D4                          ; ld      (finmem),a ;no files in mem
 509  62D4 3A 6D 73     			ld a,(panel)
 510  62D7 FE 4C        			cp "L"
 511  62D9 C0           			ret nz
 512  62DA 3A 6B 73     			ld     a,(files_l) ;обновить количество файлов
 513  62DD 32 67 73     			ld     (files),a
 514  62E0
 515  62E0 C9                       ret
 516  62E1
 517  62E1
 518  62E1              renewcat_r ;обновить каталог справа
 519  62E1 CD 37 79     	call check_init_r ;авто проверка инициализации
 520  62E4
 521  62E4              ;renewcat_r_
 522  62E4 21 00 F6     	ld hl,rec_buf ;очистить буфер
 523  62E7 11 01 F6     	ld de,rec_buf+1
 524  62EA 36 00        	ld (hl),0
 525  62EC 01 20 00     	ld bc,pack_size_32_com ;только начало ;
 526  62EF ED B0        	ldir
 527  62F1 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
 528  62F4 FE 20        			cp " "
 529  62F6 20 0B        			jr nz,renewcat_r1 ;продолжим
 530  62F8 21 5F 75     			ld hl,mes_stopped ;прервём
 531  62FB CD 62 77     			call print_sys
 532  62FE CD 9A 6E     			call wait_releas
 533  6301 18 55        			jr cat_pass2
 534  6303              renewcat_r1
 535  6303              ;запросим каталог
 536  6303              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 537  6303
 538  6303 3E 00        	ld a,0 ;Тип пакета Запроса каталога
 539  6305 32 B3 B3     	ld (trn_buf+3),a
 540  6308 ED 5B 7D 73  	ld de,(cur_cat_pag)
 541  630C ED 53 B4 B3  	ld (trn_buf+4),de ;смещение каталога (текущая страница)
 542  6310              	; ld (trn_buf+4),a ;смещение обнулить
 543  6310              	; ld (trn_buf+5),a
 544  6310              	;ld de,rec_buf ;где будет начало каталога пока точно не знаем
 545  6310              	; ld (rec_buf_adr_pack),de
 546  6310              	; ld (rec_buf_adr_pack1),de
 547  6310
 548  6310 21 B0 B3     	ld hl,trn_buf ;откуда
 549  6313 11 20 00     	ld de,pack_size_32_com ;размер
 550  6316 CD 4B 7A     	call Wifi.tcpSend ;отправить
 551  6319 38 C6        	jr c,renewcat_r ;сначала если не удачно
 552  631B
 553  631B 21 B0 73     	ld hl,mes_req_cat
 554  631E CD 62 77     	call print_sys ;печать сообщения пока ждём ответ
 555  6321
 556  6321              	; ld b,1 ;подождать ещё, пока ESP сообразит
 557  6321              	; call pause1
 558  6321
 559  6321 21 00 F6     	ld hl,rec_buf ;куда
 560  6324 22 D8 79     	ld (Wifi.buffer_pointer),hl
 561  6327 CD 8D 7A     	call Wifi.getPacket ;приём
 562  632A 30 02        	jr nc,cat_pass1
 563  632C              	;call init_dev
 564  632C 18 B3        	jr renewcat_r ;сначала если не удачно
 565  632E              cat_pass1
 566  632E 21 00 F6     	ld hl,rec_buf
 567  6331 01 20 04     	ld bc,pack_size_1024_com+pack_size_32_com
 568  6334 ED 43 91 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
 569  6338 0E 01        	ld c,1 ;Тип пакета Каталог
 570  633A CD 3B 6E     	call check_pack ;проверить пакет
 571  633D 30 02        	jr nc,cat_pass
 572  633F              	;call init_dev
 573  633F 18 A0        	jr renewcat_r ;сначала если не удачно
 574  6341              cat_pass
 575  6341 2A 7D 73     	ld hl,(cur_cat_pag)
 576  6344 CD 8C 70     	call toDecimal
 577  6347 21 E4 70     	ld hl,decimalS+2 ;
 578  634A 11 C5 73     	ld de,mes_rec_cat_num
 579  634D 01 03 00     	ld bc,3
 580  6350 ED B0        	ldir
 581  6352 21 C1 73     	ld hl,mes_rec_cat
 582  6355 CD 62 77     	call print_sys ;печать сообщения
 583  6358              cat_pass2
 584  6358 21 20 F6     	ld hl,rec_buf+32
 585  635B 11 00 EE     	ld de,cat_r
 586  635E              	;ld (rec_buf_adr_pack1),de ;перенесём каталог из буфера приёма
 587  635E 01 00 08     	ld bc,cat_r_end-cat_r
 588  6361 ED B0        	ldir
 589  6363
 590  6363 AF           	xor a
 591  6364 32 6A 73     	ld (curfile_r),a ;выберем первый файл
 592  6367 32 62 73     	ld (shiftcat_r),a ;в начало каталога
 593  636A 32 69 73     	ld (files_r),a	;всего
 594  636D 32 7C 73     	ld (open_trd_flag),a
 595  6370              	;посчитаем сколько файлов
 596  6370 DD 21 00 EE  	ld ix,cat_r ;тут принятый каталог
 597  6374 21 69 73     	ld hl,files_r
 598  6377 11 10 00     	ld de,16 ;шаг
 599  637A 06 40        	ld b,max_files ;цикл строк и ограничение на количество файлов
 600  637C              calc_cat
 601  637C DD 7E 00     	ld a,(ix)
 602  637F B7           	or a
 603  6380 28 05        	jr z,calc_cat1 ;выход если в начале имени 0
 604  6382 34           	inc (hl) ;прибавим количество
 605  6383 DD 19        	add ix,de
 606  6385 10 F5        	djnz calc_cat
 607  6387              calc_cat1
 608  6387              	;call sel_right_pan ;выбор панели
 609  6387 CD CE 6E     	call printcat_r
 610  638A
 611  638A 3A 6D 73     			ld a,(panel)
 612  638D FE 52        			cp "R"
 613  638F C0           			ret nz
 614  6390 3A 69 73     			ld     a,(files_r) ;обновить количество файлов
 615  6393 32 67 73     			ld     (files),a
 616  6396 C9           	ret
 617  6397
 618  6397
 619  6397
 620  6397              run_open ;запуск файла или открытие образа
 621  6397 3A 67 73         ld     a,(files)
 622  639A B7               or     a      ;no files?
 623  639B CA 47 60         jp     z,wait
 624  639E
 625  639E 3A 6D 73     	ld a,(panel)
 626  63A1 FE 4C        	cp "L"
 627  63A3 CA 82 65     	jp z,open_left ;если в левой панели, то запуск файла
 628  63A6
 629  63A6
 630  63A6              open_trd	;открытие образа справа
 631  63A6 3A 7C 73     			ld a,(open_trd_flag)
 632  63A9 B7           			or a
 633  63AA 28 47        			jr z,open_trd0 ;продолжить, если образ ещё не открыт
 634  63AC
 635  63AC 3A 68 73     			ld a,(curfile) ;текущ файл
 636  63AF B7           			or a
 637  63B0 C2 47 60     			jp nz,wait ;выход, если не на первом файле (..)
 638  63B3              	;выход из образа
 639  63B3 21 80 CF     	ld hl,cat_mark_r
 640  63B6 11 81 CF     	ld de,cat_mark_r+1
 641  63B9 36 00        	ld (hl),0
 642  63BB 01 7F 00     	ld bc,128-1
 643  63BE ED B0        	ldir
 644  63C0              	;вернём позицию курсора до открытия образа
 645  63C0 3A 7F 73     	ld a,(curfile_r2)
 646  63C3 32 68 73     	ld (curfile),a ;
 647  63C6 32 6A 73     	ld (curfile_r),a ;
 648  63C9 3A 80 73     	ld a,(shiftcat_r2)
 649  63CC 32 61 73     	ld (shiftcat),a ;
 650  63CF 32 62 73     	ld (shiftcat_r),a ;
 651  63D2 3A 81 73     	ld a,(files_r2)
 652  63D5 32 69 73     	ld (files_r),a
 653  63D8 32 67 73     	ld (files),a
 654  63DB AF           	xor a
 655  63DC 32 7C 73     	ld (open_trd_flag),a
 656  63DF              	;вернём каталог сервера
 657  63DF 11 00 EE     	ld de,cat_r
 658  63E2 21 E8 BD     	ld hl,cat_r2
 659  63E5 01 00 04     	ld bc,max_files*16
 660  63E8 ED B0        	ldir
 661  63EA CD 4C 65     	call cls_r
 662  63ED CD CE 6E     	call printcat_r ;напечатаем каталог
 663  63F0 C3 46 61     	jp wait_cont
 664  63F3
 665  63F3              open_trd0
 666  63F3              	;проверить расширение
 667  63F3 3A 68 73     	ld a,(curfile) ;текущ файл
 668  63F6 01 00 EE     	ld bc,cat_r
 669  63F9 6F           			ld l,a
 670  63FA 26 00        			ld h,0
 671  63FC 29                       add    hl,hl ;2
 672  63FD 29           			add    hl,hl ;4
 673  63FE 29           			add    hl,hl ;8
 674  63FF 29           			add    hl,hl ;16
 675  6400 09           			add hl,bc
 676  6401 CD 48 70     	call format_name_net
 677  6404 01 09 00     	ld bc,9
 678  6407 09           	add hl,bc
 679  6408 7E           	ld a,(hl)
 680  6409 FE 74        	cp "t"
 681  640B 20 02        	jr nz,open_trd0_ckeck
 682  640D 18 05        	jr open_trd0_ckeck_ext_ok
 683  640F              open_trd0_ckeck
 684  640F FE 54        	cp "T"
 685  6411 C2 47 60     	jp nz,wait ;выход
 686  6414
 687  6414
 688  6414              open_trd0_ckeck_ext_ok
 689  6414              	;сохраним каталог сервера
 690  6414 21 00 EE     	ld hl,cat_r
 691  6417 11 E8 BD     	ld de,cat_r2
 692  641A 01 00 04     	ld bc,max_files*16
 693  641D ED B0        	ldir
 694  641F
 695  641F 21 80 CF     			ld hl,cat_mark_r ;очистить таблицу отмеченных файлов
 696  6422 11 81 CF     			ld de,cat_mark_r+1
 697  6425 36 00        			ld (hl),0
 698  6427 01 7F 00     			ld bc,128-1
 699  642A ED B0        			ldir
 700  642C
 701  642C 3A 68 73     			ld a,(curfile) ;текущ файл
 702  642F 01 00 EE     			ld bc,cat_r
 703  6432 6F           			ld l,a
 704  6433 26 00        			ld h,0
 705  6435 29                       add    hl,hl ;2
 706  6436 29           			add    hl,hl ;4
 707  6437 29           			add    hl,hl ;8
 708  6438 29           			add    hl,hl ;16
 709  6439 09           			add hl,bc
 710  643A
 711  643A 11 C0 B3     			ld de,trn_buf+16 ;перекинем имя файла в запрос
 712  643D 01 0C 00     			ld bc,file_name_len
 713  6440 ED B0        			ldir
 714  6442
 715  6442 AF           			xor a
 716  6443 32 BC B3     			ld (trn_buf+12),a ;размер файла 655360
 717  6446 32 BD B3     			ld (trn_buf+13),a
 718  6449 32 BF B3     			ld (trn_buf+15),a
 719  644C 3E 0A        			ld a,#a
 720  644E 32 BE B3     			ld (trn_buf+14),a
 721  6451
 722  6451 3E 06        			ld a,6 ;Тип пакета Запрос приёма файла 256 байт
 723  6453 32 B3 B3     			ld (trn_buf+3),a
 724  6456 21 00 00     			ld hl,0 ;счётчик частей
 725  6459 22 B4 B3     			ld (trn_buf+4),hl
 726  645C DD 2E 09     			ld xl,9 ;частей всего цикл
 727  645F DD 26 00     			ld xh,0 ;начать с сектора 0
 728  6462
 729  6462              open_trd3	;цикл
 730  6462 CD 37 79     	call check_init_r ;авто проверка инициализации
 731  6465
 732  6465 DD 7D        			ld a,xl
 733  6467 6F           			ld l,a
 734  6468 26 00        			ld h,0
 735  646A CD 01 72     			call print_progress
 736  646D
 737  646D 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
 738  6470 FE 20        			cp " "
 739  6472 20 0C        			jr nz,open_trd2 ;продолжим
 740  6474 21 5F 75     			ld hl,mes_stopped ;прервём
 741  6477 CD 62 77     			call print_sys
 742  647A CD 9A 6E     			call wait_releas
 743  647D C3 1C 60     			jp start_h
 744  6480
 745  6480              open_trd2
 746  6480
 747  6480 21 B0 B3     			ld hl,trn_buf ;откуда
 748  6483 11 20 00     			ld de,pack_size_32_com ;размер
 749  6486 CD 4B 7A     			call Wifi.tcpSend ;отправить
 750  6489 38 D7        			jr c,open_trd3 ;если ошибка, то новая попытка
 751  648B
 752  648B 21 D2 73     			ld hl,mes_req_part_file ;сообщение пока ждём ответ
 753  648E CD 62 77     			call print_sys
 754  6491
 755  6491 21 00 F6     			ld hl,rec_buf ;куда
 756  6494 22 D8 79     			ld (Wifi.buffer_pointer),hl
 757  6497 CD 8D 7A     			call Wifi.getPacket ;приём
 758  649A 30 02        			jr nc,open_check_pass1
 759  649C              			;call init_dev
 760  649C 18 C4        			jr open_trd3 ;если ошибка, то новая попытка
 761  649E
 762  649E              open_check_pass1	;принят пакет
 763  649E 21 16 74     			ld hl,mes_rec_part_file ;сообщение
 764  64A1 CD 62 77     			call print_sys
 765  64A4 21 00 F6     			ld hl,rec_buf
 766  64A7 01 20 01     	ld bc,pack_size_256_com+pack_size_32_com
 767  64AA ED 43 91 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
 768  64AE 0E 07        			ld c,7 ; Тип пакета Файл 256
 769  64B0 CD 3B 6E     			call check_pack
 770  64B3 30 02        			jr nc,open_check_pass
 771  64B5              			;call init_dev
 772  64B5 18 AB        			jr open_trd3 ;если ошибка, то новая попытка
 773  64B7
 774  64B7              open_check_pass	;проверка прошла
 775  64B7
 776  64B7 DD 7C        	ld a,xh ;какой сектор по счёту
 777  64B9 DD 24        	inc xh
 778  64BB 21 20 F6     	ld hl,rec_buf+32
 779  64BE 11 F8 C5     	ld de,cat_open_trd+16 ;первый файл пропустим, он будет ".."
 780  64C1 82           	add d ;прибавить смещение на сектор
 781  64C2 57           	ld d,a
 782  64C3 01 00 01     	ld bc,pack_size_256_com
 783  64C6 ED B0        	ldir ;перекинем часть каталога
 784  64C8
 785  64C8 2A B4 B3     			ld hl,(trn_buf+4) ;следующая честь файла
 786  64CB 23           			inc hl
 787  64CC 22 B4 B3     			ld (trn_buf+4),hl
 788  64CF
 789  64CF DD 2D        			dec xl
 790  64D1 C2 62 64     			jp nz,open_trd3
 791  64D4
 792  64D4
 793  64D4              	;обработаем каталог
 794  64D4 3E 2E        	ld a,"." ;в начале двоеточие для возврата
 795  64D6 32 E8 C5     	ld (cat_open_trd),a
 796  64D9 32 E9 C5     	ld (cat_open_trd+1),a
 797  64DC AF           	xor a
 798  64DD 32 EA C5     	ld (cat_open_trd+2),a
 799  64E0 01 0A 00     	ld bc,13-3
 800  64E3 21 EA C5     	ld hl,cat_open_trd+2
 801  64E6 11 EB C5     	ld de,cat_open_trd+3
 802  64E9 ED B0        	ldir
 803  64EB
 804  64EB              	; ld ixl,max_files_trd+1 ;отформатируем для красоты имён
 805  64EB              	; ld hl,cat_open_trd
 806  64EB              	; ld de,cat_open_trd ;(rec_buf_adr_pack1) ;перенос обратно
 807  64EB              ; open_trd_frm
 808  64EB              	; push hl
 809  64EB              	; push de
 810  64EB              	; call formatName
 811  64EB              	; pop de
 812  64EB              	; ld bc,16
 813  64EB              	; ldir
 814  64EB              	; pop hl
 815  64EB              	; ld bc,16
 816  64EB              	; add hl,bc
 817  64EB              	; dec ixl
 818  64EB              	; jr nz,open_trd_frm
 819  64EB
 820  64EB              	;запомнить на каком файле были в правой панели
 821  64EB 3A 68 73     	ld a,(curfile)
 822  64EE 32 7F 73     	ld (curfile_r2),a ;
 823  64F1 3A 61 73     	ld a,(shiftcat)
 824  64F4 32 80 73     	ld (shiftcat_r2),a ;
 825  64F7 3A 67 73     	ld a,(files)
 826  64FA 32 82 73     	ld (files2),a
 827  64FD 3A 69 73     	ld a,(files_r)
 828  6500 32 81 73     	ld (files_r2),a
 829  6503
 830  6503 AF           	xor a
 831  6504 32 6A 73     	ld (curfile_r),a ;выберем первый файл
 832  6507 32 62 73     	ld (shiftcat_r),a ;в начало каталога
 833  650A 32 69 73     	ld (files_r),a	;всего
 834  650D 32 61 73     	ld     (shiftcat),a
 835  6510 32 68 73     	ld     (curfile),a
 836  6513 3E 01        	ld a,1
 837  6515 32 7C 73     	ld (open_trd_flag),a ;открыт образ
 838  6518
 839  6518              	;посчитаем сколько файлов
 840  6518 DD 21 E8 C5  	ld ix,cat_open_trd ;тут принятый каталог
 841  651C 21 69 73     	ld hl,files_r
 842  651F 11 10 00     	ld de,16 ;шаг
 843  6522 06 81        	ld b,max_files_trd+1 ;цикл строк и ограничение на количество файлов
 844  6524              open_trd_calc_cat
 845  6524 DD 7E 00     	ld a,(ix)
 846  6527 B7           	or a
 847  6528 28 05        	jr z,open_trd_calc_cat1 ;выход если в начале имени 0
 848  652A 34           	inc (hl) ;прибавим количество
 849  652B DD 19        	add ix,de
 850  652D 10 F5        	djnz open_trd_calc_cat
 851  652F              open_trd_calc_cat1
 852  652F
 853  652F CD 4C 65     	call cls_r ;очистить правую панель
 854  6532 CD CE 6E     	call printcat_r
 855  6535
 856  6535 21 87 76     	ld hl,mes_progress_off
 857  6538 CD 82 77     	call print
 858  653B
 859  653B 3A 6D 73     			ld a,(panel)
 860  653E FE 52        			cp "R"
 861  6540 C2 47 60     			jp nz,wait
 862  6543 3A 69 73     			ld     a,(files_r) ;обновить количество файлов
 863  6546 32 67 73     			ld     (files),a
 864  6549
 865  6549 C3 47 60     	jp wait
 866  654C
 867  654C
 868  654C              cls_r ;очистка правой панели
 869  654C AF                       xor     a
 870  654D              cls_r1
 871  654D F5                       push    af
 872  654E 32 9C 73                 ld      (catposit_r+1),a
 873  6551 21 9B 73                 ld      hl,catposit_r ;установим позицию печати
 874  6554 CD 82 77                 call    print
 875  6557 21 9F 73     			ld      hl,cat_space ;пробелами забьём
 876  655A 01 0C 00     			ld 		bc,12 ;длина
 877  655D CD 71 77                 call    print_ ;печать одного имени файла
 878  6560 F1                       pop     af
 879  6561 3C                       inc     a
 880  6562 FE 15                    cp      files_view
 881  6564 38 E7                    jr      c,cls_r1
 882  6566 C9           			ret
 883  6567
 884  6567              cls_l ;очистка левой панели
 885  6567 AF                       xor     a
 886  6568              cls_l1
 887  6568 F5                       push    af
 888  6569 32 98 73                 ld      (catposit_l+1),a
 889  656C 21 97 73                 ld      hl,catposit_l ;установим позицию печати
 890  656F CD 82 77                 call    print
 891  6572 21 9F 73     			ld      hl,cat_space ;пробелами забьём
 892  6575 01 0C 00     			ld 		bc,12 ;длина
 893  6578 CD 71 77                 call    print_ ;печать одного имени файла
 894  657B F1                       pop     af
 895  657C 3C                       inc     a
 896  657D FE 15                    cp      files_view
 897  657F 38 E7                    jr      c,cls_l1
 898  6581 C9           			ret
 899  6582
 900  6582              open_left ;enter в левой панели
 901  6582 3A 60 73     	ld a,(cur_drive)
 902  6585 FE 04        	cp 4
 903  6587 D2 09 7E     	jp nc,open_dir_l
 904  658A
 905  658A              launch_basic ;запуск бэйсик файла из левой панели
 906  658A
 907  658A              	;Подставим имя файла в загрузчик
 908  658A
 909  658A 3A 68 73     			ld a,(curfile) ;текущ файл
 910  658D 01 00 D0     			ld bc,cat_l
 911  6590 6F           			ld l,a
 912  6591 26 00        			ld h,0
 913  6593 29                       add    hl,hl ;2
 914  6594 29           			add    hl,hl ;4
 915  6595 29           			add    hl,hl ;8
 916  6596 29           			add    hl,hl ;16
 917  6597 09           			add hl,bc
 918  6598 E5           			push hl
 919  6599 DD E1        			pop ix ;запомним
 920  659B 01 08 00     			ld bc,8
 921  659E 09           			add hl,bc
 922  659F 7E           			ld a,(hl)
 923  65A0 FE 42        			cp "B"
 924  65A2 C2 47 60     			jp nz,wait ;если не бэйсик файл
 925  65A5
 926  65A5              	;ищем заготовленную бэйсик строку
 927  65A5 21 00 5B     	ld hl,#5b00
 928  65A8 01 00 25     	ld bc,#8000-#5b00
 929  65AB
 930  65AB              launch_find
 931  65AB 3E 2D        	ld a,"-" ;символ, который забит временно вместо имени
 932  65AD BE           	cp (hl)
 933  65AE 20 0B        	jr nz,launch_find_next
 934  65B0 16 07        	ld d,7 ;сколько символов сравнить
 935  65B2              launch_find1
 936  65B2 23           	inc hl
 937  65B3 BE           	cp (hl)
 938  65B4 20 05        	jr nz,launch_find_next
 939  65B6 15           	dec d
 940  65B7 20 F9        	jr nz,launch_find1
 941  65B9 18 09        	jr launch_find_ok ;нашли
 942  65BB
 943  65BB              launch_find_next
 944  65BB 23           	inc hl
 945  65BC 0B           	dec bc
 946  65BD 78           	ld a,b
 947  65BE B1           	or c
 948  65BF 20 EA        	jr nz,launch_find
 949  65C1 C3 47 60     	jp wait ;не нашли строки
 950  65C4
 951  65C4              launch_find_ok
 952  65C4 01 07 00     	ld bc,7 ;в начало имени
 953  65C7 A7           	and a
 954  65C8 ED 42        	sbc hl,bc
 955  65CA EB           	ex de,hl
 956  65CB DD E5        	push ix ;вспомним
 957  65CD E1           	pop hl
 958  65CE 01 08 00     	ld bc,8
 959  65D1 ED B0        	ldir
 960  65D3
 961  65D3 C3 3C 61     	jp exit
 962  65D6
 963  65D6
 964  65D6
 965  65D6              ; link_off ;попытка вывести ESP из режима моста translink
 966  65D6              	; ld hl,mes_translink_off
 967  65D6              	; call print_sys
 968  65D6
 969  65D6              	; ;call clear_input
 970  65D6
 971  65D6              	; ld hl,cmd_brk
 972  65D6              	; ld de,cmd_brk_end-cmd_brk
 973  65D6              	; call start_trn1 ;оправка
 974  65D6              	; call pause
 975  65D6              	; ;call clear_input
 976  65D6
 977  65D6              	; ld hl,cmd_savetrans_0 ;выключение моста
 978  65D6              	; ld de,cmd_savetrans_0_end-cmd_savetrans_0
 979  65D6              	; call start_trn1 ;оправка
 980  65D6              	; call pause
 981  65D6              	; ;call clear_input
 982  65D6
 983  65D6              	; ld hl,cmd_rst
 984  65D6              	; ld de,cmd_rst_end-cmd_rst
 985  65D6              	; call start_trn1
 986  65D6              	; call pause
 987  65D6              	; ;call clear_input
 988  65D6
 989  65D6              	; ld hl,mes_ok
 990  65D6              	; call print_sys
 991  65D6
 992  65D6              	; jp wait
 993  65D6
 994  65D6              ; link_on ;попытка включить ESP в режим моста translink
 995  65D6              	; ld hl,mes_translink_on
 996  65D6              	; call print_sys
 997  65D6
 998  65D6              	; ;call clear_input
 999  65D6              	; halt
1000  65D6              	; halt
1001  65D6              	; ;call clear_input
1002  65D6
1003  65D6              	; ld hl,cmd_uart
1004  65D6              	; ld de,cmd_uart_end-cmd_uart
1005  65D6              	; call start_trn1
1006  65D6              	; ld b,150
1007  65D6              	; call pause1
1008  65D6              	; ;call clear_input
1009  65D6
1010  65D6              	; ld hl,cmd_cwmode
1011  65D6              	; ld de,cmd_cwmode_end-cmd_cwmode
1012  65D6              	; call start_trn1 ;оправка
1013  65D6              	; ld b,150
1014  65D6              	; call pause1
1015  65D6              	; ;call clear_input
1016  65D6
1017  65D6              	; ld hl,cmd_cwjap
1018  65D6              	; ld de,cmd_cwjap_end-cmd_cwjap
1019  65D6              	; call start_trn1 ;оправка
1020  65D6              	; ld b,255
1021  65D6              	; call pause1
1022  65D6              	; ld b,255
1023  65D6              	; call pause1
1024  65D6              	; ;call clear_input
1025  65D6
1026  65D6              	; ld hl,cmd_savetrans_1
1027  65D6              	; ld de,cmd_savetrans_1_end-cmd_savetrans_1
1028  65D6              	; call start_trn1
1029  65D6              	; ld b,150
1030  65D6              	; call pause1
1031  65D6              	; ;call clear_input
1032  65D6
1033  65D6              	; ld hl,cmd_rst
1034  65D6              	; ld de,cmd_rst_end-cmd_rst
1035  65D6              	; call start_trn1
1036  65D6              	; ld b,150
1037  65D6              	; call pause1
1038  65D6              	; ;call clear_input
1039  65D6
1040  65D6              	; ld hl,mes_ok
1041  65D6              	; call print_sys
1042  65D6
1043  65D6              	; jp wait
1044  65D6
1045  65D6
1046  65D6              esp_rst ;сброс ESP
1047  65D6 21 6B 74     	ld hl,mes_esp_rst
1048  65D9 CD 62 77     	call print_sys
1049  65DC
1050  65DC              	;call clear_input
1051  65DC
1052  65DC 21 55 7B     	ld hl,cmd_brk
1053  65DF 11 03 00     	ld de,cmd_brk_end-cmd_brk
1054  65E2 CD 26 79     	call start_trn1 ;оправка
1055  65E5 06 05        	ld b,5
1056  65E7 CD 03 66     	call pause1
1057  65EA              	;call clear_input
1058  65EA
1059  65EA 21 4D 7B     	ld hl,cmd_rst
1060  65ED 11 08 00     	ld de,cmd_rst_end-cmd_rst
1061  65F0 CD 26 79     	call start_trn1
1062  65F3 06 05        	ld b,5
1063  65F5 CD 03 66     	call pause1
1064  65F8              	;call clear_input
1065  65F8
1066  65F8 21 7C 74     	ld hl,mes_ok
1067  65FB CD 62 77     	call print_sys
1068  65FE
1069  65FE C3 47 60     	jp wait
1070  6601
1071  6601              pause
1072  6601 06 32        	ld b,50 ;пауза секунду
1073  6603              pause1
1074  6603 76           	halt
1075  6604 10 FD        	djnz pause1
1076  6606 C9           	ret
1077  6607
1078  6607
1079  6607
1080  6607
1081  6607
1082  6607
1083  6607
1084  6607              copyF ;копирование по файлам
1085  6607 3A 67 73                 ld     a,(files)
1086  660A B7                       or     a      ;если нет файлов там, где курсор, то выход
1087  660B CA 47 60                 jp     z,wait
1088  660E
1089  660E              			;определить панель
1090  660E 3A 6D 73     			ld a,(panel)
1091  6611 FE 52        			cp "R"
1092  6613 CA 3E 68     			jp z,copyF_RL
1093  6616
1094  6616
1095  6616
1096  6616              copyF_LR
1097  6616              			;из левой панели в правую файлы TRD
1098  6616
1099  6616 3A 60 73     			ld a,(cur_drive)
1100  6619 FE 04        			cp 4
1101  661B D2 57 7E     			jp nc,copyF_LR_FAT ;если слева FAT
1102  661E
1103  661E
1104  661E              			;копирование файлов TRD слева направо
1105  661E 3A 7C 73     			ld     a,(open_trd_flag)
1106  6621 B7                       or     a      ;если не открыт образ справа, то выход
1107  6622 CA 47 60     			jp 		z,wait
1108  6625
1109  6625
1110  6625              			;окно запроса с выбором диска
1111  6625 3A 60 73     			ld a,(cur_drive)
1112  6628 C6 41        			add a,"A"
1113  662A 32 17 75     			ld (mes_trd_dsk+3),a
1114  662D 21 42 76     			ld hl,mes_copy_file
1115  6630 CD 82 77     			call print
1116  6633 21 14 75     			ld hl,mes_trd_dsk
1117  6636 CD 82 77     			call print
1118  6639 3E 27        			ld a,col_win
1119  663B CD 16 6E     			call paint_win
1120  663E              copyF_LR_w ;ожидание согласия
1121  663E 76           			halt
1122  663F 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
1123  6642 FE 4E        			cp 		"N"
1124  6644 CA 4B 6A     			jp z,copyF_exit ;выход если нет согласия
1125  6647 FE 59        			cp 		"Y"
1126  6649 20 F3        			jr nz,copyF_LR_w
1127  664B
1128  664B              			;узнать сколько отмеченных файлов
1129  664B 21 00 CF     			ld hl,cat_mark_l
1130  664E 06 80        			ld b,128 ;размер таблицы
1131  6650 DD 2E 00     			ld xl,0 ;счётчик
1132  6653              copyF_LR_no_one_chk
1133  6653 7E           			ld a,(hl)
1134  6654 B7           			or a
1135  6655 28 02        			jr z,copyF_LR_no_one_chk1
1136  6657 DD 2C        			inc xl
1137  6659              copyF_LR_no_one_chk1
1138  6659 23           			inc hl
1139  665A 10 F7        			djnz copyF_LR_no_one_chk
1140  665C DD 2C        			inc xl
1141  665E DD 2D        			dec xl
1142  6660 20 11        			jr nz,copyF_LR_no_one ;не один
1143  6662 3A 68 73     			ld a,(curfile) ;тогда только текущий файл
1144  6665 CD B5 66     			call copyF_LR_one
1145  6668 D2 4B 6A     			jp nc,copyF_exit ;выход без ошибки
1146  666B FE FF        			cp 255
1147  666D CA 4B 6A     			jp z,copyF_exit ;выход после останова
1148  6670 C3 6B 6A     			jp copyF_error ;выход с ошибкой
1149  6673
1150  6673
1151  6673              copyF_LR_no_one ;копировать несколько
1152  6673 21 00 CF     			ld hl,cat_mark_l
1153  6676 DD 7D        			ld a,xl
1154  6678 32 96 73     			ld (cat_mark_cur_tot),a
1155  667B AF           			xor a
1156  667C              copyF_LR_no_one_cl
1157  667C 32 95 73     			ld (cat_mark_cur_cl),a
1158  667F 22 93 73     			ld (cat_mark_cur),hl
1159  6682 7E           			ld a,(hl) ;есть отметка?
1160  6683 B7           			or a
1161  6684 28 1E        			jr z,copyF_LR_no_one_cl1
1162  6686 3A 96 73     			ld a,(cat_mark_cur_tot)
1163  6689 6F           			ld l,a
1164  668A 26 00        			ld h,0
1165  668C 3D           			dec a
1166  668D 32 96 73     			ld (cat_mark_cur_tot),a
1167  6690 CD 16 72     			call print_progress_tot ;прогресс
1168  6693 3A 95 73     			ld a,(cat_mark_cur_cl) ;очередной номер файла
1169  6696 CD B5 66     			call copyF_LR_one ;скопировать
1170  6699 D2 A4 66     			jp nc,copyF_LR_no_one_cl1 ;продолжить без ошибки
1171  669C FE FF        			cp 255
1172  669E CA 4B 6A     			jp z,copyF_exit ;выход после останова
1173  66A1 C3 6B 6A     			jp copyF_error ;выход с ошибкой
1174  66A4
1175  66A4              copyF_LR_no_one_cl1
1176  66A4 2A 93 73     			ld hl,(cat_mark_cur)
1177  66A7 36 00        			ld (hl),0 ;снять отметку
1178  66A9 23           			inc hl
1179  66AA 3A 95 73     			ld a,(cat_mark_cur_cl)
1180  66AD 3C           			inc a
1181  66AE FE 80        			cp 128
1182  66B0 38 CA        			jr c,copyF_LR_no_one_cl
1183  66B2
1184  66B2 C3 4B 6A     			jp copyF_exit
1185  66B5
1186  66B5
1187  66B5
1188  66B5
1189  66B5              copyF_LR_one ;скопировать один файл слева направо
1190  66B5              			;на входе в A - номер файла
1191  66B5              			;на выходе C=1, если ошибка; A=255, если остановлено
1192  66B5 08           			ex af,af'
1193  66B6              			;узнать есть ли место на диске
1194  66B6 3A DC CE     			ld a,(cat_open_trd+8*256+#e4+16) ; общее количество файлов в образе
1195  66B9 FE 80        			cp 128
1196  66BB D2 3B 68     			jp nc,copyF_LR_error ;если уже максимум
1197  66BE 08           			ex af,af'
1198  66BF              			;узнать параметры файла
1199  66BF              			; ld de,0
1200  66BF              			; ld      (#5ceb),de ;начало сектор дорожка
1201  66BF 01 00 D0     			ld bc,cat_l ;каталог диска слева
1202  66C2              			;ld a,(curfile) ;текущ файл
1203  66C2 6F           			ld l,a
1204  66C3 26 00        			ld h,0
1205  66C5 29                       add    hl,hl ;2
1206  66C6 29           			add    hl,hl ;4
1207  66C7 29           			add    hl,hl ;8
1208  66C8 29           			add    hl,hl ;16
1209  66C9 09           			add hl,bc
1210  66CA
1211  66CA 22 88 73     			ld (copyF_RL_source_file),hl ;указатель на запись о файле
1212  66CD 01 0D 00     			ld bc,13
1213  66D0 09           			add hl,bc
1214  66D1 7E           			ld a,(hl) ;объём файла в секторах
1215  66D2 32 8A 73     			ld (copyF_RL_source_sec_size),a ;
1216  66D5 4F           			ld c,a
1217  66D6 06 00        			ld b,0
1218  66D8 23           			inc hl
1219  66D9 5E           			ld e,(hl)
1220  66DA 23           			inc hl
1221  66DB 56           			ld d,(hl)
1222  66DC ED 53 8C 73  			ld (copyF_RL_source_trk),de ;исходные дорожка-сектор
1223  66E0 ED 53 EB 5C  			ld (#5ceb),de ;отсюда начнём считывать
1224  66E4
1225  66E4 2A DD CE     			ld hl,(cat_open_trd+8*256+#e5+16) ; количество свободных секторов в образе
1226  66E7 A7           			and a
1227  66E8 ED 42        			sbc hl,bc
1228  66EA DA 3B 68     			jp c,copyF_LR_error ;если не хватает места
1229  66ED
1230  66ED              			;цикл по размеру в секторах
1231  66ED DD 6F        			ld xl,a
1232  66EF
1233  66EF 2A D9 CE     			ld hl,(cat_open_trd+8*256+#e1+16) ;первые свободные сектор-дорожка назначения
1234  66F2              			;узнаем где будет файл
1235  66F2              			;пересчитать дорожки-секторы в пакеты
1236  66F2 4D           			ld c,l ;секторы
1237  66F3 06 00        			ld b,0
1238  66F5 6C           			ld l,h ;дорожки
1239  66F6 26 00        			ld h,0
1240  66F8 29           			add hl,hl ;*2
1241  66F9 29           			add hl,hl ;*4
1242  66FA 29           			add hl,hl ;*8
1243  66FB 29           			add hl,hl ;*16
1244  66FC 09           			add hl,bc ;добавить секторы
1245  66FD              			;ld hl,0 ;счётчик частей
1246  66FD 22 B4 B3     			ld (trn_buf+4),hl
1247  6700
1248  6700              			;начинаем копировать файл
1249  6700
1250  6700 3A 7F 73     			ld a,(curfile_r2) ;текущ файл образа
1251  6703 01 E8 BD     			ld bc,cat_r2
1252  6706 6F           			ld l,a
1253  6707 26 00        			ld h,0
1254  6709 29                       add    hl,hl ;2
1255  670A 29           			add    hl,hl ;4
1256  670B 29           			add    hl,hl ;8
1257  670C 29           			add    hl,hl ;16
1258  670D 09           			add hl,bc
1259  670E
1260  670E 11 C0 B3     			ld de,trn_buf+16 ;перекинем имя файла в запрос
1261  6711 01 0C 00     			ld bc,file_name_len
1262  6714 ED B0        			ldir
1263  6716 3E 08        			ld a,8 ;Тип пакета Запрос на передачу файла 256 байт
1264  6718 32 B3 B3     			ld (trn_buf+3),a
1265  671B
1266  671B AF           			xor a
1267  671C 32 BC B3     			ld (trn_buf+12),a ;размер файла 655360
1268  671F 32 BD B3     			ld (trn_buf+13),a
1269  6722 32 BF B3     			ld (trn_buf+15),a
1270  6725 3E 0A        			ld a,#a
1271  6727 32 BE B3     			ld (trn_buf+14),a
1272  672A
1273  672A
1274  672A
1275  672A              			;цикл
1276  672A              copyF_LR3
1277  672A DD 7D        			ld a,xl
1278  672C 6F           			ld l,a
1279  672D 26 00        			ld h,0
1280  672F CD 01 72     			call print_progress
1281  6732
1282  6732 21 D0 B3     	ld hl,trn_buf+pack_size_32_com ;адрес отправляемого пакета
1283  6735 ED 5B EB 5C  	ld de,(#5ceb)
1284  6739 01 05 01     	ld bc,#0105
1285  673C CD 13 3D     	call #3d13 ;считать 1 сектор
1286  673F
1287  673F CD DE 67     	call sec256_to_srv ;отправить на сервер
1288  6742
1289  6742              copyF_LR_check_pass	;проверка прошла
1290  6742
1291  6742 ED 5B EB 5C  	ld de,(#5ceb)
1292  6746 06 01        	ld b,1
1293  6748 CD A9 6E     	call calc_next_pos2 ;сменить позицию на 1 сектор
1294  674B
1295  674B 2A B4 B3     			ld hl,(trn_buf+4) ;следующая честь файла
1296  674E 23           			inc hl
1297  674F 22 B4 B3     			ld (trn_buf+4),hl
1298  6752
1299  6752 DD 2D        			dec xl
1300  6754 C2 2A 67     			jp nz,copyF_LR3
1301  6757
1302  6757              			;теперь поправить каталог
1303  6757
1304  6757              			;запись о файле
1305  6757 3A DC CE     			ld a,(cat_open_trd+8*256+#e4+16) ; общее количество файлов
1306  675A 6F           			ld l,a ;узнать в каком секторе будет запись о файле
1307  675B 26 00        			ld h,0
1308  675D 29           			add hl,hl ;*2
1309  675E 29           			add hl,hl ;*4
1310  675F 29           			add hl,hl ;*8
1311  6760 29           			add hl,hl ;*16
1312  6761 7C           			ld a,h ;запомнить номер сетора в каталоге
1313  6762 32 8E 73     			ld (copyF_RL_dest_sec_cat),a
1314  6765 01 F8 C5     			ld bc,cat_open_trd+16
1315  6768 09           			add hl,bc ;здесь будет запись о новом файле
1316  6769 EB           			ex de,hl
1317  676A
1318  676A 2A 88 73     			ld hl,(copyF_RL_source_file) ;запись о файле
1319  676D 01 10 00     			ld bc,16
1320  6770 ED B0        			ldir ;скопировать
1321  6772 EB           			ex de,hl
1322  6773 2B           			dec hl
1323  6774 ED 5B D9 CE  			ld de,(cat_open_trd+8*256+#e1+16) ;первые свободные сектор-дорожка назначения
1324  6778 72           			ld (hl),d ;дорожка
1325  6779 2B           			dec hl
1326  677A 73           			ld (hl),e ;сектор
1327  677B
1328  677B 3A 8E 73     			ld a,(copyF_RL_dest_sec_cat)
1329  677E 67           			ld h,a
1330  677F 2E 00        			ld l,0
1331  6781 01 F8 C5     			ld bc,cat_open_trd+16 ;скопировать сектор с учётом первой записи ".."
1332  6784 09           			add hl,bc
1333  6785 11 D0 B3     			ld de,trn_buf+pack_size_32_com
1334  6788 01 00 01     			ld bc,256
1335  678B ED B0        			ldir
1336  678D
1337  678D 26 00        			ld h,0
1338  678F 3A 8E 73     			ld a,(copyF_RL_dest_sec_cat)
1339  6792 6F           			ld l,a ;номер сектора
1340  6793 22 B4 B3     			ld (trn_buf+4),hl ;номер части
1341  6796              			;отправка сектора в образ
1342  6796 CD DE 67     			call sec256_to_srv
1343  6799
1344  6799              			;служебный сектор
1345  6799 ED 5B D9 CE  			ld de,(cat_open_trd+8*256+#e1+16) ;первые свободные сектор-дорожка назначения
1346  679D 3A 8A 73     			ld a,(copyF_RL_source_sec_size) ;размер файла
1347  67A0 47           			ld b,a
1348  67A1 CD A9 6E     			call calc_next_pos2
1349  67A4 ED 53 D9 CE  			ld (cat_open_trd+8*256+#e1+16),de
1350  67A8
1351  67A8 2A DD CE     			ld hl,(cat_open_trd+8*256+#e5+16) ; количество свободных секторов на диске
1352  67AB 3A 8A 73     			ld a,(copyF_RL_source_sec_size) ;размер файла
1353  67AE 4F           			ld c,a
1354  67AF 06 00        			ld b,0
1355  67B1 A7           			and a
1356  67B2 ED 42        			sbc hl,bc
1357  67B4 22 DD CE     			ld (cat_open_trd+8*256+#e5+16),hl
1358  67B7
1359  67B7 21 DC CE     			ld hl,cat_open_trd+8*256+#e4+16 ; общее количество файлов
1360  67BA 34           			inc (hl)
1361  67BB
1362  67BB 21 F8 CD     			ld hl,cat_open_trd+8*256+16
1363  67BE 11 D0 B3     			ld de,trn_buf+pack_size_32_com
1364  67C1 01 00 01     			ld bc,256
1365  67C4 ED B0        			ldir
1366  67C6
1367  67C6              			;отправка сектора в образ
1368  67C6 21 08 00     			ld hl,#0008
1369  67C9 22 B4 B3     			ld (trn_buf+4),hl ;номер части
1370  67CC CD DE 67     			call sec256_to_srv
1371  67CF
1372  67CF 3A 69 73     			ld     a,(files_r) ;обновить количество файлов
1373  67D2 3C           			inc a
1374  67D3 32 69 73     			ld     (files_r),a
1375  67D6
1376  67D6              			;call cls_r ;очистить правую панель
1377  67D6 CD 73 6F     			call printcat_l
1378  67D9 CD CE 6E     			call printcat_r
1379  67DC
1380  67DC AF           			xor a ;С=0, нет ошибок
1381  67DD C9           			ret
1382  67DE
1383  67DE
1384  67DE              sec256_to_srv
1385  67DE              			;отправка сектора 256 в образ. заголовок пакета уже должен быть готов
1386  67DE CD 37 79     			call check_init_r ;авто проверка инициализации
1387  67E1
1388  67E1 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
1389  67E4 FE 20        			cp " "
1390  67E6 20 0E        			jr nz,sec256_to_srv2 ;продолжим
1391  67E8 21 5F 75     			ld hl,mes_stopped ;прервём
1392  67EB CD 62 77     			call print_sys
1393  67EE CD 9A 6E     			call wait_releas
1394  67F1 E1           			pop hl ;поправить адрес возврата
1395  67F2 3E FF        			ld a,255 ;ошибка останов
1396  67F4 3F           			ccf ;С=1
1397  67F5 C9           			ret
1398  67F6
1399  67F6              sec256_to_srv2
1400  67F6
1401  67F6
1402  67F6 11 B0 B3     			ld de,trn_buf
1403  67F9 01 20 01     			ld bc,pack_size_256_com+pack_size_32_com
1404  67FC ED 43 91 73  			ld (check_sum_size),bc
1405  6800 CD E7 70     			call calc_check_sum ;проверить сумму
1406  6803 22 D0 B4     			ld (trn_buf+pack_size_256_com+pack_size_32_com),hl ;записать её в пакет
1407  6806
1408  6806 21 B0 B3     			ld hl,trn_buf ;откуда
1409  6809 11 22 01     			ld de,pack_size_256 ;размер
1410  680C CD 4B 7A     			call Wifi.tcpSend ;отправить
1411  680F 38 CD        			jr c,sec256_to_srv ;если ошибка, повтор
1412  6811
1413  6811 21 E3 73     			ld hl,mes_trq_part_file ;сообщение пока ждём ответ
1414  6814 CD 62 77     			call print_sys
1415  6817
1416  6817 21 00 F6     			ld hl,rec_buf ;куда
1417  681A 22 D8 79     			ld (Wifi.buffer_pointer),hl
1418  681D CD 8D 7A     			call Wifi.getPacket ;приём
1419  6820 38 BC        			jr c,sec256_to_srv ;если ошибка, повтор
1420  6822
1421  6822              			;принят пакет
1422  6822 21 27 74     			ld hl,mes_trn_part_file ;сообщение
1423  6825 CD 62 77     			call print_sys
1424  6828 21 00 F6     			ld hl,rec_buf
1425  682B 01 20 00     			ld bc,pack_size_32_com
1426  682E ED 43 91 73  			ld (check_sum_size),bc ;задать длину пакета для подсчёта
1427  6832 0E 09        			ld c,9 ; Тип пакета Файл 256
1428  6834 CD 3B 6E     			call check_pack
1429  6837 38 A5        			jr c,sec256_to_srv ;если ошибка]повтор
1430  6839 AF           			xor a
1431  683A C9           			ret ;выход без ошибок
1432  683B
1433  683B              copyF_LR_error ;выход с ошибкой
1434  683B AF           			xor a
1435  683C 3F           			ccf ;C=1
1436  683D C9           			ret
1437  683E
1438  683E
1439  683E
1440  683E
1441  683E
1442  683E
1443  683E
1444  683E
1445  683E
1446  683E              copyF_RL ;копирование файлов справа налево TRD
1447  683E
1448  683E 3A 60 73     			ld a,(cur_drive)
1449  6841 FE 04        			cp 4
1450  6843 D2 10 80     			jp nc,copyF_RL_FAT ;если слева FAT
1451  6846
1452  6846 3A 7C 73     			ld a,(open_trd_flag)
1453  6849 B7           			or a
1454  684A CA 47 60     			jp z,wait ;выход, если справа не открыт образ
1455  684D
1456  684D              			;узнать сколько отмеченных файлов
1457  684D 21 80 CF     			ld hl,cat_mark_r
1458  6850 06 80        			ld b,128 ;размер таблицы
1459  6852 DD 2E 00     			ld xl,0 ;счётчик
1460  6855              copyF_RL_no_one_chk
1461  6855 7E           			ld a,(hl)
1462  6856 B7           			or a
1463  6857 28 02        			jr z,copyF_RL_no_one_chk1
1464  6859 DD 2C        			inc xl
1465  685B              copyF_RL_no_one_chk1
1466  685B 23           			inc hl
1467  685C 10 F7        			djnz copyF_RL_no_one_chk
1468  685E DD 2C        			inc xl
1469  6860 DD 2D        			dec xl
1470  6862 20 07        			jr nz,copyF_RL_no_one2 ;не ноль
1471  6864              			;не отмечено
1472  6864 3A 68 73     			ld a,(curfile) ;текущ файл
1473  6867 B7           			or a ;если стоит на ".."
1474  6868 CA 47 60     			jp z,wait
1475  686B              copyF_RL_no_one2
1476  686B              			;окно запроса с выбором диска
1477  686B 3A 60 73     			ld a,(cur_drive)
1478  686E C6 41        			add a,"A"
1479  6870 32 17 75     			ld (mes_trd_dsk+3),a
1480  6873 21 42 76     			ld hl,mes_copy_file
1481  6876 CD 82 77     			call print
1482  6879 21 14 75     			ld hl,mes_trd_dsk
1483  687C CD 82 77     			call print
1484  687F 3E 27        			ld a,col_win
1485  6881 CD 16 6E     			call paint_win
1486  6884
1487  6884              copyF_RL_w ;ожидание согласия
1488  6884 76           			halt
1489  6885 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
1490  6888 FE 4E        			cp 		"N"
1491  688A CA 4B 6A     			jp z,copyF_exit ;выход если нет согласия
1492  688D FE 59        			cp 		"Y"
1493  688F 20 F3        			jr nz,copyF_RL_w
1494  6891
1495  6891 DD 2C        			inc xl
1496  6893 DD 2D        			dec xl
1497  6895 20 11        			jr nz,copyF_RL_no_one ;не один
1498  6897 3A 68 73     			ld a,(curfile) ;тогда только текущий файл
1499  689A CD EA 68     			call copyF_RL_one
1500  689D D2 4B 6A     			jp nc,copyF_exit ;выход без ошибки
1501  68A0 FE FF        			cp 255
1502  68A2 CA 4B 6A     			jp z,copyF_exit ;выход после останова
1503  68A5 C3 6B 6A     			jp copyF_error ;выход с ошибкой
1504  68A8
1505  68A8
1506  68A8              copyF_RL_no_one ;копировать несколько
1507  68A8 21 80 CF     			ld hl,cat_mark_r
1508  68AB DD 7D        			ld a,xl
1509  68AD 32 96 73     			ld (cat_mark_cur_tot),a
1510  68B0 AF           			xor a
1511  68B1              copyF_RL_no_one_cl
1512  68B1 32 95 73     			ld (cat_mark_cur_cl),a
1513  68B4 22 93 73     			ld (cat_mark_cur),hl
1514  68B7 7E           			ld a,(hl) ;есть отметка?
1515  68B8 B7           			or a
1516  68B9 28 1E        			jr z,copyF_RL_no_one_cl1
1517  68BB 3A 96 73     			ld a,(cat_mark_cur_tot)
1518  68BE 6F           			ld l,a
1519  68BF 26 00        			ld h,0
1520  68C1 3D           			dec a
1521  68C2 32 96 73     			ld (cat_mark_cur_tot),a
1522  68C5 CD 16 72     			call print_progress_tot ;прогресс
1523  68C8 3A 95 73     			ld a,(cat_mark_cur_cl) ;очередной номер файла
1524  68CB CD EA 68     			call copyF_RL_one ;скопировать
1525  68CE D2 D9 68     			jp nc,copyF_RL_no_one_cl1 ;продолжить без ошибки
1526  68D1 FE FF        			cp 255
1527  68D3 CA 4B 6A     			jp z,copyF_exit ;выход после останова
1528  68D6 C3 6B 6A     			jp copyF_error ;выход с ошибкой
1529  68D9              copyF_RL_no_one_cl1
1530  68D9 2A 93 73     			ld hl,(cat_mark_cur)
1531  68DC 36 00        			ld (hl),0 ;снять отметку
1532  68DE 23           			inc hl
1533  68DF 3A 95 73     			ld a,(cat_mark_cur_cl)
1534  68E2 3C           			inc a
1535  68E3 FE 80        			cp 128
1536  68E5 38 CA        			jr c,copyF_RL_no_one_cl
1537  68E7
1538  68E7 C3 4B 6A     			jp copyF_exit
1539  68EA
1540  68EA
1541  68EA              copyF_RL_one ;по одному файлу справа налево
1542  68EA              			;на входе в A - номер файла
1543  68EA              			;на выходе C=1, если ошибка; A=255, если остановлено
1544  68EA 08           			ex af,af'
1545  68EB              			;узнать есть ли место на диске
1546  68EB 3A E4 D8     			ld a,(cat_l+8*256+#e4) ; общее количество файлов
1547  68EE FE 80        			cp 128
1548  68F0 D2 83 6A     			jp nc,copyF_RL_one_error ;если уже максимум
1549  68F3 08           			ex af,af'
1550  68F4              			;узнать параметры файла
1551  68F4              			; ld de,0
1552  68F4              			; ld      (#5ceb),de ;начало сектор дорожка
1553  68F4 01 E8 C5     			ld bc,cat_open_trd
1554  68F7              			;ld a,(curfile) ;текущ файл
1555  68F7 6F           			ld l,a
1556  68F8 26 00        			ld h,0
1557  68FA 29                       add    hl,hl ;2
1558  68FB 29           			add    hl,hl ;4
1559  68FC 29           			add    hl,hl ;8
1560  68FD 29           			add    hl,hl ;16
1561  68FE 09           			add hl,bc
1562  68FF
1563  68FF 22 88 73     			ld (copyF_RL_source_file),hl ;указатель на запись о файле
1564  6902 01 0D 00     			ld bc,13
1565  6905 09           			add hl,bc
1566  6906 7E           			ld a,(hl) ;объём файла в секторах
1567  6907 32 8A 73     			ld (copyF_RL_source_sec_size),a ;
1568  690A 4F           			ld c,a
1569  690B 06 00        			ld b,0
1570  690D 23           			inc hl
1571  690E 5E           			ld e,(hl)
1572  690F 23           			inc hl
1573  6910 56           			ld d,(hl)
1574  6911 ED 53 8C 73  			ld (copyF_RL_source_trk),de ;исходные дорожка-сектор
1575  6915
1576  6915 2A E5 D8     			ld hl,(cat_l+8*256+#e5) ; количество свободных секторов на диске
1577  6918 A7           			and a
1578  6919 ED 42        			sbc hl,bc
1579  691B DA 83 6A     			jp c,copyF_RL_one_error ;если не хватает места
1580  691E
1581  691E              			;цикл по размеру в секторах
1582  691E DD 6F        			ld xl,a
1583  6920
1584  6920 ED 5B E1 D8  			ld de,(cat_l+8*256+#e1) ;первые свободные сектор-дорожка назначения
1585  6924 ED 53 EB 5C  			ld (#5ceb),de
1586  6928              			;узнаем где находится искодный файл
1587  6928 2A 8C 73     			ld hl,(copyF_RL_source_trk) ;пересчитать дорожки-секторы в пакеты
1588  692B 4D           			ld c,l ;секторы
1589  692C 06 00        			ld b,0
1590  692E 6C           			ld l,h ;дорожки
1591  692F 26 00        			ld h,0
1592  6931 29           			add hl,hl ;*2
1593  6932 29           			add hl,hl ;*4
1594  6933 29           			add hl,hl ;*8
1595  6934 29           			add hl,hl ;*16
1596  6935 09           			add hl,bc ;добавить секторы
1597  6936              			;ld hl,0 ;счётчик частей
1598  6936 22 B4 B3     			ld (trn_buf+4),hl
1599  6939
1600  6939              			;начинаем копировать файл
1601  6939
1602  6939 3A 7F 73     			ld a,(curfile_r2) ;текущ файл образа
1603  693C 01 E8 BD     			ld bc,cat_r2
1604  693F 6F           			ld l,a
1605  6940 26 00        			ld h,0
1606  6942 29                       add    hl,hl ;2
1607  6943 29           			add    hl,hl ;4
1608  6944 29           			add    hl,hl ;8
1609  6945 29           			add    hl,hl ;16
1610  6946 09           			add hl,bc
1611  6947
1612  6947 11 C0 B3     			ld de,trn_buf+16 ;перекинем имя файла в запрос
1613  694A 01 0C 00     			ld bc,file_name_len
1614  694D ED B0        			ldir
1615  694F 3E 06        			ld a,6 ;Тип пакета Запрос приёма файла 256 байт
1616  6951 32 B3 B3     			ld (trn_buf+3),a
1617  6954
1618  6954 AF           			xor a
1619  6955 32 BC B3     			ld (trn_buf+12),a ;размер файла 655360
1620  6958 32 BD B3     			ld (trn_buf+13),a
1621  695B 32 BF B3     			ld (trn_buf+15),a
1622  695E 3E 0A        			ld a,#a
1623  6960 32 BE B3     			ld (trn_buf+14),a
1624  6963
1625  6963              			;цикл
1626  6963
1627  6963              copyF_RL3
1628  6963 CD 37 79     	call check_init_r ;авто проверка инициализации
1629  6966
1630  6966 DD 7D        			ld a,xl
1631  6968 6F           			ld l,a
1632  6969 26 00        			ld h,0
1633  696B CD 01 72     			call print_progress
1634  696E
1635  696E 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
1636  6971 FE 20        			cp " "
1637  6973 20 0D        			jr nz,copyF_RL2 ;продолжим
1638  6975 21 5F 75     			ld hl,mes_stopped ;прервём
1639  6978 CD 62 77     			call print_sys
1640  697B CD 9A 6E     			call wait_releas
1641  697E 3E FF        			ld a,255
1642  6980 3F           			ccf ;C=1
1643  6981 C9           			ret
1644  6982
1645  6982              copyF_RL2
1646  6982
1647  6982 21 B0 B3     			ld hl,trn_buf ;откуда
1648  6985 11 20 00     			ld de,pack_size_32_com ;размер
1649  6988 CD 4B 7A     			call Wifi.tcpSend ;отправить
1650  698B 38 D6        			jr c,copyF_RL3 ;если ошибка, то новая попытка
1651  698D
1652  698D 21 D2 73     			ld hl,mes_req_part_file ;сообщение пока ждём ответ
1653  6990 CD 62 77     			call print_sys
1654  6993
1655  6993 21 00 F6     			ld hl,rec_buf ;куда
1656  6996 22 D8 79     			ld (Wifi.buffer_pointer),hl
1657  6999 CD 8D 7A     			call Wifi.getPacket ;приём
1658  699C 30 02        			jr nc,copyF_RL_check_pass1
1659  699E              			;call init_dev
1660  699E 18 C3        			jr copyF_RL3 ;если ошибка, то новая попытка
1661  69A0
1662  69A0              copyF_RL_check_pass1	;принят пакет
1663  69A0 21 16 74     			ld hl,mes_rec_part_file ;сообщение
1664  69A3 CD 62 77     			call print_sys
1665  69A6 21 00 F6     			ld hl,rec_buf
1666  69A9 01 20 01     	ld bc,pack_size_256_com+pack_size_32_com
1667  69AC ED 43 91 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
1668  69B0 0E 07        			ld c,7 ; Тип пакета Файл 256
1669  69B2 CD 3B 6E     			call check_pack
1670  69B5 30 03        			jr nc,copyF_RL_check_pass
1671  69B7              			;call init_dev
1672  69B7 C3 63 69     			jp copyF_RL3 ;если ошибка, то новая попытка
1673  69BA
1674  69BA              copyF_RL_check_pass	;проверка прошла
1675  69BA
1676  69BA 21 20 F6     	ld hl,rec_buf+32 ;адрес принятого пакета
1677  69BD ED 5B EB 5C  	ld de,(#5ceb)
1678  69C1 01 06 01     	ld bc,#0106
1679  69C4 CD 13 3D     	call #3d13 ;запишем 1 сектор
1680  69C7
1681  69C7 ED 5B EB 5C  	ld de,(#5ceb)
1682  69CB 06 01        	ld b,1
1683  69CD CD A9 6E     	call calc_next_pos2 ;сменить позицию на 1 сектор
1684  69D0
1685  69D0 2A B4 B3     			ld hl,(trn_buf+4) ;следующая честь файла
1686  69D3 23           			inc hl
1687  69D4 22 B4 B3     			ld (trn_buf+4),hl
1688  69D7
1689  69D7 DD 2D        			dec xl
1690  69D9 C2 63 69     			jp nz,copyF_RL3
1691  69DC
1692  69DC              			;теперь поправить каталог
1693  69DC
1694  69DC              			;запись о файле
1695  69DC 3A E4 D8     			ld a,(cat_l+8*256+#e4) ; общее количество файлов
1696  69DF 6F           			ld l,a ;узнать в каком секторе будет запись о файле
1697  69E0 26 00        			ld h,0
1698  69E2 29           			add hl,hl ;*2
1699  69E3 29           			add hl,hl ;*4
1700  69E4 29           			add hl,hl ;*8
1701  69E5 29           			add hl,hl ;*16
1702  69E6 7C           			ld a,h ;запомнить номер сетора в каталоге
1703  69E7 32 8E 73     			ld (copyF_RL_dest_sec_cat),a
1704  69EA 01 00 D0     			ld bc,cat_l
1705  69ED 09           			add hl,bc ;здесь будет запись о новом файле
1706  69EE EB           			ex de,hl
1707  69EF
1708  69EF 2A 88 73     			ld hl,(copyF_RL_source_file) ;запись о файле
1709  69F2 01 10 00     			ld bc,16
1710  69F5 ED B0        			ldir ;скопировать
1711  69F7 EB           			ex de,hl
1712  69F8 2B           			dec hl
1713  69F9 ED 5B E1 D8  			ld de,(cat_l+8*256+#e1) ;первые свободные сектор-дорожка назначения
1714  69FD 72           			ld (hl),d ;дорожка
1715  69FE 2B           			dec hl
1716  69FF 73           			ld (hl),e ;сектор
1717  6A00
1718  6A00 2E 00        			ld l,0 ;записать сектор целиком по ровному адресу
1719  6A02 16 00        			ld d,0
1720  6A04 3A 8E 73     			ld a,(copyF_RL_dest_sec_cat)
1721  6A07 5F           			ld e,a ;номер сектора
1722  6A08 01 06 01     			ld bc,#0106 ;1 сектор записать
1723  6A0B CD 13 3D     			call #3d13
1724  6A0E
1725  6A0E              			;служебный сектор
1726  6A0E ED 5B E1 D8  			ld de,(cat_l+8*256+#e1) ;первые свободные сектор-дорожка назначения
1727  6A12 3A 8A 73     			ld a,(copyF_RL_source_sec_size) ;размер файла
1728  6A15 47           			ld b,a
1729  6A16 CD A9 6E     			call calc_next_pos2
1730  6A19 ED 53 E1 D8  			ld (cat_l+8*256+#e1),de
1731  6A1D
1732  6A1D 2A E5 D8     			ld hl,(cat_l+8*256+#e5) ; количество свободных секторов на диске
1733  6A20 3A 8A 73     			ld a,(copyF_RL_source_sec_size) ;размер файла
1734  6A23 4F           			ld c,a
1735  6A24 06 00        			ld b,0
1736  6A26 A7           			and a
1737  6A27 ED 42        			sbc hl,bc
1738  6A29 22 E5 D8     			ld (cat_l+8*256+#e5),hl
1739  6A2C
1740  6A2C 21 E4 D8     			ld hl,cat_l+8*256+#e4 ; общее количество файлов
1741  6A2F 34           			inc (hl)
1742  6A30
1743  6A30 21 00 D8     			ld hl,cat_l+8*256
1744  6A33 11 08 00     			ld de,#0008
1745  6A36 01 06 01     			ld bc,#0106 ;1 сектор записать
1746  6A39 CD 13 3D     			call #3d13
1747  6A3C
1748  6A3C 3A 6B 73     			ld     a,(files_l) ;обновить количество файлов
1749  6A3F 3C           			inc a
1750  6A40 32 6B 73     			ld     (files_l),a
1751  6A43
1752  6A43 CD 73 6F     			call printcat_l
1753  6A46 CD CE 6E     			call printcat_r
1754  6A49 AF           			xor a ;C=0
1755  6A4A C9           			ret
1756  6A4B
1757  6A4B
1758  6A4B              copyF_exit	;общий выход из копирования файлов
1759  6A4B 3E 07        			ld a,col_fon ;стереть окно
1760  6A4D CD 16 6E     			call paint_win
1761  6A50              			;call cls_l ;очистить левую панель
1762  6A50 21 8D 74     			ld hl,mes_win_cls ;стереть текст
1763  6A53 CD 82 77     			call print
1764  6A56
1765  6A56 21 87 76     			ld hl,mes_progress_off ;стереть прогресс
1766  6A59 CD 82 77     			call print
1767  6A5C 21 99 76     			ld hl,mes_progress_tot_off ;стереть общий прогресс
1768  6A5F CD 82 77     			call print
1769  6A62 CD 73 6F     			call printcat_l
1770  6A65 CD CE 6E     			call printcat_r
1771  6A68 C3 47 60     			jp wait
1772  6A6B
1773  6A6B
1774  6A6B              copyF_error ;общий выход из копирования файлов с ошибкой
1775  6A6B 3E 17        			ld a,col_win2
1776  6A6D CD 16 6E     			call paint_win ;окно ошибки
1777  6A70 21 55 76     			ld hl,mes_copy_error
1778  6A73 CD 82 77     			call print
1779  6A76 CD 9A 6E     			call wait_releas ;ждать клавишу
1780  6A79              copyF_error1
1781  6A79 76           			halt
1782  6A7A 3A 04 5C     			ld 	a,(23556) ;сист. переменная нажатая клавиша
1783  6A7D FE FF        			cp #ff
1784  6A7F 28 F8        			jr z,copyF_error1
1785  6A81 18 C8        			jr copyF_exit
1786  6A83
1787  6A83
1788  6A83              copyF_RL_one_error
1789  6A83 AF           			xor a
1790  6A84 3F           			ccf ;C=1
1791  6A85 C9           			ret
1792  6A86
1793  6A86
1794  6A86              exit_h ;выход после операции с ожиданием клавиши
1795  6A86 76           			halt
1796  6A87 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
1797  6A8A FE FF        			cp #ff
1798  6A8C 28 F8        			jr z,exit_h
1799  6A8E C3 1C 60     			jp start_h ;на горячий старт
1800  6A91
1801  6A91
1802  6A91
1803  6A91
1804  6A91
1805  6A91
1806  6A91
1807  6A91
1808  6A91
1809  6A91
1810  6A91              TRD ;выбор записи или считывания
1811  6A91 3A 60 73     	ld a,(cur_drive)
1812  6A94 FE 04        	cp 4
1813  6A96 D2 47 60     	jp     nc,wait ;когда слева FAT, не работает копирование TRD
1814  6A99
1815  6A99 3A 7C 73     	ld a,(open_trd_flag)
1816  6A9C B7           	or a
1817  6A9D C2 47 60     	jp     nz,wait ;когда открыт образ справа, нельзя копировать целиком образ
1818  6AA0
1819  6AA0 3A 6D 73     			ld a,(panel)
1820  6AA3 FE 52        			cp "R"
1821  6AA5 CA 04 6D     			jp z,write_trd_
1822  6AA8
1823  6AA8
1824  6AA8              read_trd_ ;прочитать TRD с диска на сервер
1825  6AA8 3A 67 73                 ld     a,(files)
1826  6AAB B7                       or     a      ;no files?
1827  6AAC CA 47 60                 jp     z,wait
1828  6AAF
1829  6AAF              			;запросить имя образа
1830  6AAF 21 F5 D8     			ld hl,cat_l+8*256+#f5 ;имя диска тут
1831  6AB2 11 D0 74     			ld de,trd_name
1832  6AB5 01 08 00     			ld bc,8
1833  6AB8 ED B0        			ldir ;подставить имя диска
1834  6ABA
1835  6ABA CD E2 6B     			call input_name
1836  6ABD
1837  6ABD              			;call wait_releas
1838  6ABD
1839  6ABD              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
1840  6ABD
1841  6ABD 3A 60 73     			ld a,(cur_drive) ;подготовка сообщения для подтверждения
1842  6AC0 C6 41        			add a,"A"
1843  6AC2 32 17 75     			ld (mes_trd_dsk+3),a
1844  6AC5 21 EE 74     			ld hl,mes_read_trd
1845  6AC8 CD 82 77     			call print
1846  6ACB 21 14 75     			ld hl,mes_trd_dsk
1847  6ACE CD 82 77     			call print
1848  6AD1              			;call paint_win
1849  6AD1
1850  6AD1 CD 86 6C     			call trd_w ;
1851  6AD4 FE 59        			cp "Y"
1852  6AD6 C2 1C 60     			jp nz,start_h ;выход если нет согласия
1853  6AD9
1854  6AD9
1855  6AD9              read_trd	;чтение образа TRD
1856  6AD9 3A 60 73     			ld      a,(cur_drive) ;текущий диск
1857  6ADC 32 19 5D                 ld      (#5d19) ,a
1858  6ADF 0E 01                    ld      c,1
1859  6AE1 CD 13 3D                 call    #3d13
1860  6AE4 0E 18                    ld      c,#18
1861  6AE6 CD 13 3D                 call    #3d13
1862  6AE9 11 00 00     			ld de,0
1863  6AEC ED 53 EB 5C  			ld      (#5ceb),de ;начало сектор дорожка
1864  6AF0
1865  6AF0 21 C0 B3     			ld hl,trn_buf+16 ;очистим имя файла в пакете для отправки
1866  6AF3 36 00        			ld (hl),0
1867  6AF5 11 C1 B3     			ld de,trn_buf+16+1
1868  6AF8 01 0C 00     			ld bc,file_name_len
1869  6AFB ED B0        			ldir
1870  6AFD
1871  6AFD
1872  6AFD              			;обрежем лишние пробелы в конце имени, если есть
1873  6AFD 01 07 00     			ld bc,7
1874  6B00 21 D7 74     			ld hl,trd_name+7
1875  6B03              read_trd_chk_n
1876  6B03 7E           			ld a,(hl)
1877  6B04 FE 20        			cp " "
1878  6B06 20 04        			jr nz,read_trd_chk_n2
1879  6B08 2B           			dec hl
1880  6B09 0D           			dec c
1881  6B0A 20 F7        			jr nz,read_trd_chk_n
1882  6B0C
1883  6B0C              read_trd_chk_n2
1884  6B0C 21 D0 74     			ld hl,trd_name
1885  6B0F 11 C0 B3     			ld de,trn_buf+16 ;перекинем имя файла в запрос
1886  6B12              			;ld bc,file_name_len
1887  6B12 0C           			inc c
1888  6B13 ED B0        			ldir
1889  6B15              			;добавить расширение
1890  6B15 EB           			ex de,hl
1891  6B16 36 2E        			ld (hl),"."
1892  6B18 23           			inc hl
1893  6B19 36 74        			ld (hl),"t"
1894  6B1B 23           			inc hl
1895  6B1C 36 72        			ld (hl),"r"
1896  6B1E 23           			inc hl
1897  6B1F 36 64        			ld (hl),"d"
1898  6B21
1899  6B21 AF           			xor a
1900  6B22 32 BC B3     			ld (trn_buf+12),a ;размер файла 655360
1901  6B25 32 BD B3     			ld (trn_buf+13),a
1902  6B28 32 BF B3     			ld (trn_buf+15),a
1903  6B2B 3E 0A        			ld a,#a
1904  6B2D 32 BE B3     			ld (trn_buf+14),a
1905  6B30
1906  6B30
1907  6B30 3E 04        			ld a,4 ;Тип пакета Запрос передачи файла
1908  6B32 32 B3 B3     			ld (trn_buf+3),a
1909  6B35 21 00 00     			ld hl,0 ;счётчик частей
1910  6B38 22 B4 B3     			ld (trn_buf+4),hl
1911  6B3B DD 21 80 02  			ld ix,640 ;частей всего цикл
1912  6B3F              read_trd3	;цикл
1913  6B3F 2A B4 B3     			ld hl,(trn_buf+4) ;чтения части файла
1914  6B42 CD 8C 70     			call toDecimal
1915  6B45 21 E4 70     		    ld hl,decimalS+2 ;
1916  6B48 11 4E 74     			ld de,mes_rd_part_file_num
1917  6B4B 01 03 00     			ld bc,3
1918  6B4E ED B0        			ldir
1919  6B50 21 49 74     			ld hl,mes_rd_part_file ;сообщение
1920  6B53 CD 62 77     			call print_sys
1921  6B56
1922  6B56 DD E5        			push ix
1923  6B58 E1           			pop hl
1924  6B59 CD 01 72     			call print_progress
1925  6B5C
1926  6B5C ED 5B EB 5C  			ld  de,(#5ceb) ;сектор дорожка
1927  6B60 21 D0 B3     			ld hl,trn_buf+pack_size_32_com
1928  6B63 01 05 04     			ld bc,#0405 ;чтение 4 сектора
1929  6B66 CD 13 3D     			call #3d13
1930  6B69              read_trd3_retr
1931  6B69 CD 3C 79     	call check_init_t ;авто проверка инициализации
1932  6B6C
1933  6B6C 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
1934  6B6F FE 20        			cp " "
1935  6B71 20 0C        			jr nz,r_calc_next_pos3 ;продолжим
1936  6B73 21 5F 75     			ld hl,mes_stopped ;прервём
1937  6B76 CD 62 77     			call print_sys
1938  6B79 CD 9A 6E     			call wait_releas
1939  6B7C C3 86 6A     			jp exit_h
1940  6B7F
1941  6B7F              r_calc_next_pos3
1942  6B7F 11 B0 B3     			ld de,trn_buf
1943  6B82 01 20 04     			ld bc,pack_size_1024_com+pack_size_32_com
1944  6B85 ED 43 91 73  			ld (check_sum_size),bc
1945  6B89 CD E7 70     			call calc_check_sum ;проверить сумму
1946  6B8C 22 D0 B7     			ld (trn_buf+pack_size_1024_com+pack_size_32_com),hl ;записать её в пакет
1947  6B8F
1948  6B8F 21 B0 B3     			ld hl,trn_buf ;откуда
1949  6B92 11 22 04     			ld de,pack_size_1024 ;размер
1950  6B95 CD 4B 7A     			call Wifi.tcpSend ;отправить
1951  6B98 38 CF        			jr c,read_trd3_retr ;если ошибка, то новая попытка
1952  6B9A
1953  6B9A 21 E3 73     			ld hl,mes_trq_part_file ;сообщение пока ждём ответ
1954  6B9D CD 62 77     			call print_sys
1955  6BA0
1956  6BA0 21 00 F6     			ld hl,rec_buf ;куда
1957  6BA3 22 D8 79     			ld (Wifi.buffer_pointer),hl
1958  6BA6 CD 8D 7A     			call Wifi.getPacket ;приём
1959  6BA9 30 02        			jr nc,r_check_pass1 ;
1960  6BAB              			;call init_dev ;сбросить приёмник
1961  6BAB 18 BC        			jr read_trd3_retr ;если ошибка, то новая попытка
1962  6BAD
1963  6BAD              r_check_pass1	;принято
1964  6BAD 21 27 74     			ld hl,mes_trn_part_file ;сообщение
1965  6BB0 CD 62 77     			call print_sys
1966  6BB3              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
1967  6BB3              			; ld a,(check_sum_on) ;временно выключим контроль суммы
1968  6BB3              			; ld (check_sum_on_tmp),a
1969  6BB3              			; xor a
1970  6BB3              			; ld (check_sum_on),a
1971  6BB3 21 00 F6     			ld hl,rec_buf
1972  6BB6 01 20 00     	ld bc,pack_size_32_com
1973  6BB9 ED 43 91 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
1974  6BBD 0E 05        			ld c,5 ; Тип пакета Файл
1975  6BBF CD 3B 6E     			call check_pack
1976  6BC2              			; ld (check_sum_on_tmp),a ;вернём флаг
1977  6BC2              			; ld (check_sum_on),a
1978  6BC2 30 02        			jr nc,r_check_pass ;
1979  6BC4              			;call init_dev ;сбросить приёмник
1980  6BC4 18 A3        			jr read_trd3_retr ;если ошибка, то новая попытка
1981  6BC6
1982  6BC6              r_check_pass	;проверка прошла
1983  6BC6
1984  6BC6 CD A3 6E     			call calc_next_pos
1985  6BC9
1986  6BC9 2A B4 B3     			ld hl,(trn_buf+4) ;следующая честь файла
1987  6BCC 23           			inc hl
1988  6BCD 22 B4 B3     			ld (trn_buf+4),hl
1989  6BD0
1990  6BD0 DD 2B        			dec ix
1991  6BD2 DD 7D        			ld a,ixl
1992  6BD4 DD B4        			or ixh
1993  6BD6 C2 3F 6B     			jp nz,read_trd3
1994  6BD9
1995  6BD9 21 05 74     			ld hl,mes_trn_file ;сообщение что передали
1996  6BDC CD 62 77     			call print_sys
1997  6BDF              			;call wait_releas
1998  6BDF C3 1C 60     			jp start_h
1999  6BE2
2000  6BE2
2001  6BE2              input_name ;ввод имени файла
2002  6BE2 DD 21 D0 74  			ld ix,trd_name
2003  6BE6              			;ld de,trd_name ;указатель на имя файла
2004  6BE6              input_name_
2005  6BE6              			;очистим место под курсор
2006  6BE6 21 DD 74     			ld hl,mes_trd_name_curs+3
2007  6BE9 36 20        			ld (hl)," "
2008  6BEB 11 DE 74     			ld de,mes_trd_name_curs+3+1
2009  6BEE 01 0F 00     			ld bc,16-1
2010  6BF1 ED B0        			ldir
2011  6BF3              			;нарисуем курсор
2012  6BF3 21 13 00     			ld hl,14+11-6  ;поле метка курсора
2013  6BF6 DD E5        			push ix
2014  6BF8 D1           			pop de
2015  6BF9 19           			add hl,de
2016  6BFA 36 5E        			ld (hl),"^"
2017  6BFC 21 C7 74     			ld hl,mes_trd_name ;напечатать имя
2018  6BFF CD 82 77     			call print
2019  6C02 3E 27        			ld a,col_win
2020  6C04 CD 16 6E     			call paint_win
2021  6C07
2022  6C07 CD C4 60     			call input_key ;запросить клавишу
2023  6C0A 79           			ld a,c
2024  6C0B FE 0D        			cp  #0d ;Enter
2025  6C0D C8           			ret z
2026  6C0E
2027  6C0E FE 05                    cp 		5
2028  6C10 CA 51 6C                 jp      z,input_name_left
2029  6C13 FE 08                    cp 		8
2030  6C15 CA 68 6C                 jp      z,input_name_right
2031  6C18 FE 07                    cp 		7
2032  6C1A CA 43 6C                 jp      z,input_name_up
2033  6C1D FE 06                    cp 		6
2034  6C1F CA 4A 6C                 jp      z,input_name_down
2035  6C22 FE 00                    cp 		0
2036  6C24 CA 80 6C                 jp      z,input_name_BS ;стереть, backspace
2037  6C27              ;input_name_sym
2038  6C27              			;ld a,c
2039  6C27 FE 20        			cp 		" "
2040  6C29 38 BB        			jr      c,input_name_ ;если недопустимы символ, в начало
2041  6C2B FE 7B        			cp 		"{"
2042  6C2D 30 B7        			jr      nc,input_name_ ;если недопустимы символ, в начало
2043  6C2F DD 77 00     			ld      (ix),a ; записать букву в имя
2044  6C32 DD 23        			inc ix
2045  6C34 DD E5        			push ix
2046  6C36 D1           			pop de
2047  6C37 21 D7 74     			ld hl,trd_name+ 7;проверка на пределы имени
2048  6C3A A7           			and a
2049  6C3B ED 52        			sbc hl,de
2050  6C3D 30 A7        			jr nc,input_name_ ; в начало
2051  6C3F DD 2B        			dec ix ;иначе отмена
2052  6C41 18 A3        			jr input_name_ ; в начало
2053  6C43
2054  6C43              input_name_up
2055  6C43 3E FF        			ld a,255
2056  6C45 32 04 5C     			ld 	(23556),a
2057  6C48 18 9C        			jr input_name_
2058  6C4A              input_name_down
2059  6C4A 3E FF        			ld a,255
2060  6C4C 32 04 5C     			ld 	(23556),a
2061  6C4F 18 95        			jr input_name_
2062  6C51
2063  6C51              input_name_left
2064  6C51 3E FF        			ld a,255
2065  6C53 32 04 5C     			ld 	(23556),a
2066  6C56 DD 2B        			dec ix
2067  6C58 DD E5        			push ix
2068  6C5A D1           			pop de
2069  6C5B 21 CF 74     			ld hl,trd_name-1 ;проверка на пределы имени
2070  6C5E A7           			and a
2071  6C5F ED 52        			sbc hl,de
2072  6C61 38 83        			jr c,input_name_ ; в начало
2073  6C63 DD 23        			inc ix ;иначе отмена
2074  6C65 C3 E6 6B     			jp input_name_
2075  6C68              input_name_right
2076  6C68 3E FF        			ld a,255
2077  6C6A 32 04 5C     			ld 	(23556),a
2078  6C6D DD 23        			inc ix
2079  6C6F DD E5        			push ix
2080  6C71 D1           			pop de
2081  6C72 21 D7 74     			ld hl,trd_name+ 7;проверка на пределы имени
2082  6C75 A7           			and a
2083  6C76 ED 52        			sbc hl,de
2084  6C78 D2 E6 6B     			jp nc,input_name_ ; в начало
2085  6C7B DD 2B        			dec ix ;иначе отмена
2086  6C7D C3 E6 6B     			jp input_name_ ; в начало
2087  6C80              input_name_BS
2088  6C80 DD 36 00 20  			ld (ix)," "
2089  6C84 18 CB        			jr input_name_left
2090  6C86
2091  6C86              trd_w ;ожидание согласия и выбор диска
2092  6C86 76           			halt
2093  6C87 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
2094  6C8A FE 31        			cp 		"1"
2095  6C8C CA B8 6C                 jp      z,trd_w_driveA ;1
2096  6C8F FE 41                    cp 		"A"
2097  6C91 CA B8 6C                 jp      z,trd_w_driveA ;A
2098  6C94 FE 32                    cp 		"2"
2099  6C96 CA CB 6C                 jp      z,trd_w_driveB ;2
2100  6C99 FE 42                    cp 		"B"
2101  6C9B CA CB 6C                 jp      z,trd_w_driveB ;B
2102  6C9E FE 33                    cp 		"3"
2103  6CA0 CA DE 6C                 jp      z,trd_w_driveC ;3
2104  6CA3 FE 43                    cp 		"C"
2105  6CA5 CA DE 6C                 jp      z,trd_w_driveC ;C
2106  6CA8 FE 34                    cp 		"4"
2107  6CAA 28 45                    jr      z,trd_w_driveD ;4
2108  6CAC FE 44                    cp 		"D"
2109  6CAE 28 41                    jr      z,trd_w_driveD ;D
2110  6CB0 FE 4E        			cp 		"N"
2111  6CB2 C8                       ret z
2112  6CB3 FE 59        			cp 		"Y"
2113  6CB5 C8                       ret z ;
2114  6CB6 18 CE        			jr trd_w
2115  6CB8
2116  6CB8              trd_w_driveA
2117  6CB8 3E 00        			ld a,0
2118  6CBA 32 60 73     			ld (cur_drive),a
2119  6CBD C6 41        			add a,"A"
2120  6CBF 32 17 75     			ld (mes_trd_dsk+3),a
2121  6CC2 21 14 75     			ld hl,mes_trd_dsk
2122  6CC5 CD 82 77     			call print
2123  6CC8 C3 86 6C     			jp trd_w
2124  6CCB              trd_w_driveB
2125  6CCB 3E 01        			ld a,1
2126  6CCD 32 60 73     			ld (cur_drive),a
2127  6CD0 C6 41        			add a,"A"
2128  6CD2 32 17 75     			ld (mes_trd_dsk+3),a
2129  6CD5 21 14 75     			ld hl,mes_trd_dsk
2130  6CD8 CD 82 77     			call print
2131  6CDB C3 86 6C     			jp trd_w
2132  6CDE              trd_w_driveC
2133  6CDE 3E 02        			ld a,2
2134  6CE0 32 60 73     			ld (cur_drive),a
2135  6CE3 C6 41        			add a,"A"
2136  6CE5 32 17 75     			ld (mes_trd_dsk+3),a
2137  6CE8 21 14 75     			ld hl,mes_trd_dsk
2138  6CEB CD 82 77     			call print
2139  6CEE C3 86 6C     			jp trd_w
2140  6CF1              trd_w_driveD
2141  6CF1 3E 03        			ld a,3
2142  6CF3 32 60 73     			ld (cur_drive),a
2143  6CF6 C6 41        			add a,"A"
2144  6CF8 32 17 75     			ld (mes_trd_dsk+3),a
2145  6CFB 21 14 75     			ld hl,mes_trd_dsk
2146  6CFE CD 82 77     			call print
2147  6D01 C3 86 6C     			jp trd_w
2148  6D04
2149  6D04
2150  6D04
2151  6D04
2152  6D04              write_trd_ ;записать TRD с сервера на диск
2153  6D04 3A 67 73                 ld     a,(files)
2154  6D07 B7                       or     a      ;no files?
2155  6D08 CA 47 60                 jp     z,wait
2156  6D0B                          ; ld     a,(open_trd_flag)
2157  6D0B                          ; or     a      ;нельзя скопировать, если открыт образ
2158  6D0B                          ; jp     nz,wait
2159  6D0B
2160  6D0B 3A 60 73     			ld a,(cur_drive)
2161  6D0E C6 41        			add a,"A"
2162  6D10 32 17 75     			ld (mes_trd_dsk+3),a
2163  6D13 21 01 75     			ld hl,mes_write_trd
2164  6D16 CD 82 77     			call print
2165  6D19 21 14 75     			ld hl,mes_trd_dsk
2166  6D1C CD 82 77     			call print
2167  6D1F 3E 27        			ld a,col_win
2168  6D21 CD 16 6E     			call paint_win
2169  6D24
2170  6D24 CD 86 6C     			call trd_w
2171  6D27 FE 59        			cp "Y"
2172  6D29 C2 1C 60     			jp nz,start_h ;выход если нет согласия
2173  6D2C
2174  6D2C              write_trd	;запись образа TRD на диск
2175  6D2C 3A 60 73     			ld      a,(cur_drive) ;текущий диск
2176  6D2F 32 19 5D                 ld      (#5d19) ,a
2177  6D32 0E 01                    ld      c,1
2178  6D34 CD 13 3D                 call    #3d13
2179  6D37 0E 18                    ld      c,#18
2180  6D39 CD 13 3D                 call    #3d13
2181  6D3C 11 00 00     			ld de,0
2182  6D3F ED 53 EB 5C  			ld      (#5ceb),de ;начало сектор дорожка
2183  6D43 01 00 EE     			ld bc,cat_r
2184  6D46 3A 7C 73     			ld     a,(open_trd_flag)
2185  6D49 B7                       or     a      ;если открыт образ
2186  6D4A 3A 68 73     			ld a,(curfile) ;текущ файл если образ не открыт
2187  6D4D 28 06                    jr     z,write_trd2
2188  6D4F 01 E8 BD     			ld bc,cat_r2
2189  6D52 3A 7F 73     			ld a,(curfile_r2) ;текущ файл если образ открыт
2190  6D55              write_trd2
2191  6D55 6F           			ld l,a
2192  6D56 26 00        			ld h,0
2193  6D58 29                       add    hl,hl ;2
2194  6D59 29           			add    hl,hl ;4
2195  6D5A 29           			add    hl,hl ;8
2196  6D5B 29           			add    hl,hl ;16
2197  6D5C 09           			add hl,bc
2198  6D5D              			; dec a
2199  6D5D              			; jr nz,write_trd2
2200  6D5D              ;write_trd1
2201  6D5D 11 C0 B3     			ld de,trn_buf+16 ;перекинем имя файла в запрос
2202  6D60 01 0C 00     			ld bc,file_name_len
2203  6D63 ED B0        			ldir
2204  6D65
2205  6D65 AF           			xor a
2206  6D66 32 BC B3     			ld (trn_buf+12),a ;размер файла 655360
2207  6D69 32 BD B3     			ld (trn_buf+13),a
2208  6D6C 32 BF B3     			ld (trn_buf+15),a
2209  6D6F 3E 0A        			ld a,#a
2210  6D71 32 BE B3     			ld (trn_buf+14),a
2211  6D74
2212  6D74 3E 02        			ld a,2 ;Тип пакета Запрос приёма файла
2213  6D76 32 B3 B3     			ld (trn_buf+3),a
2214  6D79 21 00 00     			ld hl,0 ;счётчик частей
2215  6D7C 22 B4 B3     			ld (trn_buf+4),hl
2216  6D7F DD 21 80 02  			ld ix,640 ;частей всего
2217  6D83              write_trd3 ;цикл
2218  6D83 CD 37 79     	call check_init_r ;авто проверка инициализации
2219  6D86
2220  6D86 DD E5        			push ix
2221  6D88 E1           			pop hl
2222  6D89 CD 01 72     			call print_progress
2223  6D8C
2224  6D8C 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
2225  6D8F FE 20        			cp " "
2226  6D91 20 0C        			jr nz,calc_next_pos3 ;продолжим
2227  6D93 21 5F 75     			ld hl,mes_stopped ;прервём
2228  6D96 CD 62 77     			call print_sys
2229  6D99 CD 9A 6E     			call wait_releas
2230  6D9C C3 86 6A     			jp exit_h
2231  6D9F
2232  6D9F              calc_next_pos3
2233  6D9F
2234  6D9F 21 B0 B3     			ld hl,trn_buf ;откуда
2235  6DA2 11 20 00     			ld de,pack_size_32_com ;размер
2236  6DA5 CD 4B 7A     			call Wifi.tcpSend ;отправить
2237  6DA8 38 D9        			jr c,write_trd3 ;если ошибка, то новая попытка
2238  6DAA
2239  6DAA 21 D2 73     			ld hl,mes_req_part_file ;сообщение пока ждём ответ
2240  6DAD CD 62 77     			call print_sys
2241  6DB0
2242  6DB0 21 00 F6     			ld hl,rec_buf ;куда
2243  6DB3 22 D8 79     			ld (Wifi.buffer_pointer),hl
2244  6DB6 CD 8D 7A     			call Wifi.getPacket ;приём
2245  6DB9 30 02        			jr nc,check_pass1
2246  6DBB              			;call init_dev
2247  6DBB 18 C6        			jr write_trd3 ;если ошибка, то новая попытка
2248  6DBD
2249  6DBD              check_pass1	;принят пакет
2250  6DBD 21 16 74     			ld hl,mes_rec_part_file ;сообщение
2251  6DC0 CD 62 77     			call print_sys
2252  6DC3              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
2253  6DC3 21 00 F6     			ld hl,rec_buf
2254  6DC6 01 20 04     	ld bc,pack_size_1024_com+pack_size_32_com
2255  6DC9 ED 43 91 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
2256  6DCD 0E 03        			ld c,3 ; Тип пакета Файл
2257  6DCF CD 3B 6E     			call check_pack
2258  6DD2 30 02        			jr nc,check_pass
2259  6DD4              			;call init_dev
2260  6DD4 18 AD        			jr write_trd3 ;если ошибка, то новая попытка
2261  6DD6
2262  6DD6              check_pass	;проверка прошла
2263  6DD6 2A B4 B3     			ld hl,(trn_buf+4)
2264  6DD9 CD 8C 70     			call toDecimal
2265  6DDC 21 E4 70     		    ld hl,decimalS+2 ;
2266  6DDF 11 3E 74     			ld de,mes_wrt_part_file_num
2267  6DE2 01 03 00     			ld bc,3
2268  6DE5 ED B0        			ldir
2269  6DE7 21 38 74     			ld hl,mes_wrt_part_file ;сообщение
2270  6DEA CD 62 77     			call print_sys
2271  6DED
2272  6DED ED 5B EB 5C  			ld  de,(#5ceb) ;сектор дорожка
2273  6DF1 21 20 F6     			ld hl,rec_buf+32
2274  6DF4 01 06 04     			ld bc,#0406 ;запись 4 сектора
2275  6DF7 CD 13 3D     			call #3d13
2276  6DFA
2277  6DFA CD A3 6E     			call calc_next_pos
2278  6DFD
2279  6DFD 2A B4 B3     			ld hl,(trn_buf+4)
2280  6E00 23           			inc hl
2281  6E01 22 B4 B3     			ld (trn_buf+4),hl
2282  6E04
2283  6E04 DD 2B        			dec ix
2284  6E06 DD 7D        			ld a,ixl
2285  6E08 DD B4        			or ixh
2286  6E0A C2 83 6D     			jp nz,write_trd3
2287  6E0D
2288  6E0D 21 F4 73     			ld hl,mes_rec_file ;сообщение что приняли
2289  6E10 CD 62 77     			call print_sys
2290  6E13              			;call wait_releas
2291  6E13 C3 1C 60     			jp start_h
2292  6E16
2293  6E16
2294  6E16              paint_win
2295  6E16              			;покрасим окно сообщения
2296  6E16 21 CA 59     			ld hl,win_pos
2297  6E19 77           			ld (hl),a
2298  6E1A 54           			ld d,h
2299  6E1B 5D           			ld e,l
2300  6E1C 13           			inc de
2301  6E1D 01 0B 00     			ld bc,win_size
2302  6E20 ED B0        			ldir
2303  6E22 21 EA 59     			ld hl,win_pos+32
2304  6E25 77           			ld (hl),a
2305  6E26 54           			ld d,h
2306  6E27 5D           			ld e,l
2307  6E28 13           			inc de
2308  6E29 01 0B 00     			ld bc,win_size
2309  6E2C ED B0        			ldir
2310  6E2E 21 0A 5A     			ld hl,win_pos+32+32
2311  6E31 77           			ld (hl),a
2312  6E32 54           			ld d,h
2313  6E33 5D           			ld e,l
2314  6E34 13           			inc de
2315  6E35 01 0B 00     			ld bc,win_size
2316  6E38 ED B0        			ldir
2317  6E3A C9           			ret
2318  6E3B
2319  6E3B              check_pack
2320  6E3B              			;проверка пакета
2321  6E3B              			;на входе в C - Тип пакета, в HL - адрес
2322  6E3B 7E           			ld a,(hl)
2323  6E3C FE 5A        			cp "Z"
2324  6E3E C2 8A 6E     			jp nz,check_pac_error
2325  6E41 23           			inc hl
2326  6E42 7E           			ld a,(hl)
2327  6E43 FE 58        			cp "X"
2328  6E45 C2 8A 6E     			jp nz,check_pac_error
2329  6E48 23           			inc hl
2330  6E49 7E           			ld a,(hl)
2331  6E4A FE 4E        			cp "N"
2332  6E4C C2 8A 6E     			jp nz,check_pac_error
2333  6E4F 23           			inc hl
2334  6E50 7E           			ld a,(hl)
2335  6E51 B9           			cp c ;Тип пакета
2336  6E52 C2 8A 6E     			jp nz,check_pac_error
2337  6E55 23           			inc hl
2338  6E56 7E           			ld a,(hl)
2339  6E57 EB           			ex de,hl
2340  6E58 21 B4 B3     			ld hl,trn_buf+4
2341  6E5B BE           			cp (hl) ;смещение
2342  6E5C EB           			ex de,hl
2343  6E5D C2 8A 6E     			jp nz,check_pac_error
2344  6E60 23           			inc hl
2345  6E61 7E           			ld a,(hl)
2346  6E62 EB           			ex de,hl
2347  6E63 21 B5 B3     			ld hl,trn_buf+5
2348  6E66 BE           			cp (hl) ;смещение старший
2349  6E67 EB           			ex de,hl
2350  6E68 20 20        			jr nz,check_pac_error
2351  6E6A
2352  6E6A 3A 58 73     			ld a,(check_sum_on) ;проверять или нет сумму
2353  6E6D B7           			or a
2354  6E6E 28 18        			jr z,check_pack_sk
2355  6E70 11 00 F6     			ld de,rec_buf
2356  6E73 CD E7 70     			call calc_check_sum ;проверить сумму
2357  6E76 EB           			ex de,hl
2358  6E77 01 00 F6     			ld bc,rec_buf
2359  6E7A 2A 91 73     			ld hl,(check_sum_size) ;pack_size_1024_com+pack_size_32_com
2360  6E7D 09           			add hl,bc
2361  6E7E EB           			ex de,hl
2362  6E7F 1A           			ld a,(de)
2363  6E80 BD           			cp l
2364  6E81 20 0F        			jr nz,check_chs_error
2365  6E83 13           			inc de
2366  6E84 1A           			ld a,(de)
2367  6E85 BC           			cp h
2368  6E86 20 0A        			jr nz,check_chs_error
2369  6E88              check_pack_sk
2370  6E88 A7           			and a ;флаг сбросим С=0
2371  6E89 C9           			ret ;успешно проверен
2372  6E8A
2373  6E8A              check_pac_error ;проверка пакета не прошла
2374  6E8A 21 4E 75     			ld hl,mes_pac_error
2375  6E8D CD 62 77     			call print_sys
2376  6E90 3F           			ccf ;C=1
2377  6E91 C9           			ret
2378  6E92
2379  6E92
2380  6E92              check_chs_error
2381  6E92                          ;проверка суммы не прошла
2382  6E92 21 3D 75     			ld hl,mes_chs_error
2383  6E95 CD 62 77     			call print_sys
2384  6E98 3F           			ccf
2385  6E99 C9           			ret
2386  6E9A
2387  6E9A              wait_releas
2388  6E9A 76           			halt ;ждём отпускания клавиши
2389  6E9B 3A 04 5C     			ld 	a,(23556) ;сист. переменная нажатая клавиша
2390  6E9E FE FF        			cp #ff
2391  6EA0 20 F8        			jr nz,wait_releas
2392  6EA2 C9           			ret
2393  6EA3
2394  6EA3
2395  6EA3              calc_next_pos		;вперёд на 4 сектора
2396  6EA3 06 04        			ld b,4
2397  6EA5 ED 5B EB 5C  			ld  de,(#5ceb)
2398  6EA9              calc_next_pos2
2399  6EA9 1C           			inc e
2400  6EAA 7B           			ld a,e
2401  6EAB FE 10        			cp 16
2402  6EAD 38 03        			jr c,calc_next_pos1
2403  6EAF 14           			inc d
2404  6EB0 1E 00        			ld e,0
2405  6EB2              calc_next_pos1
2406  6EB2 10 F5        			djnz calc_next_pos2
2407  6EB4 ED 53 EB 5C  			ld (#5ceb),de
2408  6EB8 C9           			ret
2409  6EB9
2410  6EB9
2411  6EB9              cls_pic
2412  6EB9 21 00 40     			ld hl,#4000
2413  6EBC 11 01 40     			ld de,#4001
2414  6EBF 01 00 18     			ld bc,6144
2415  6EC2 36 00        			ld (hl),0
2416  6EC4 ED B0        			ldir
2417  6EC6 36 07        			ld (hl),col_fon
2418  6EC8 01 FF 02     			ld bc,768-1
2419  6ECB ED B0        			ldir
2420  6ECD C9           			ret
2421  6ECE
2422  6ECE
2423  6ECE              printcat_r ;печать каталога правая панель
2424  6ECE 3A 6D 73     			ld a,(panel) ;проверка надо ли скрыть курсор
2425  6ED1 FE 52        			cp "R"
2426  6ED3 3E 39        			ld a,colorcatc_act
2427  6ED5 28 02        			jr z,printcat_r1
2428  6ED7 3E 0F        			ld a,colorcat_
2429  6ED9              printcat_r1
2430  6ED9 32 5C 73     			ld (colorcatc_r),a
2431  6EDC
2432  6EDC 21 16 58                 ld      hl,col_pos_r ;
2433  6EDF AF                       xor		a
2434  6EE0              clscat_r
2435  6EE0 54                       ld      d,h
2436  6EE1 5D                       ld      e,l
2437  6EE2 13                       inc     de
2438  6EE3 4F                       ld      c,a  ;keep
2439  6EE4 3A 62 73                 ld      a,(shiftcat_r)
2440  6EE7 47                       ld      b,a
2441  6EE8 3A 6A 73                 ld      a,(curfile_r)
2442  6EEB A7                       and     a
2443  6EEC 98                       sbc     a,b
2444  6EED B9                       cp      c
2445  6EEE 32 5F 73                 ld      (cursor_r),a ;posit
2446  6EF1 3A 5D 73                 ld      a,(colorcat_r)
2447  6EF4 20 03                    jr      nz,clscat01_r
2448  6EF6 3A 5C 73                 ld      a,(colorcatc_r) ;mark
2449  6EF9              clscat01_r
2450  6EF9 77                       ld      (hl),a  ;раскраска атрибутами
2451  6EFA 79                       ld      a,c  ;restor
2452  6EFB 01 09 00                 ld      bc,9
2453  6EFE ED B0                    ldir
2454  6F00 01 17 00                 ld      bc,32-9
2455  6F03 09                       add     hl,bc
2456  6F04 3C                       inc     a
2457  6F05 FE 15                    cp      files_view
2458  6F07 38 D7                    jr      c,clscat_r
2459  6F09
2460  6F09                     ;     ld      hl,catposit
2461  6F09                     ;     call    print
2462  6F09
2463  6F09 3A 69 73     			ld a,(files_r)
2464  6F0C B7           			or a
2465  6F0D C8           			ret z ;выход если нет файлов
2466  6F0E
2467  6F0E                           ;теперь печать имён файлов
2468  6F0E 3A 62 73                 ld      a,(shiftcat_r)
2469  6F11 DD 6F        			ld xl,a
2470  6F13                          ; or      a
2471  6F13                          ; jr      z,printcat00
2472  6F13 6F           			ld      l,a
2473  6F14 26 00        			ld 		h,0
2474  6F16              ;printcat01  ;find name file
2475  6F16 29                       add    hl,hl ;2
2476  6F17 29           			add    hl,hl ;4
2477  6F18 29           			add    hl,hl ;8
2478  6F19 29           			add    hl,hl ;16
2479  6F1A 01 00 EE     			ld bc,cat_r ;адрес обычного каталога
2480  6F1D 3A 7C 73     			ld a,(open_trd_flag)
2481  6F20 B7           			or a
2482  6F21 28 03        			jr z,printcat00_r
2483  6F23 01 E8 C5     			ld bc,cat_open_trd ;адрес каталога образа
2484  6F26              printcat00_r
2485  6F26 09           			add hl,bc
2486  6F27                          ;dec    a
2487  6F27                          ;jr    nz,printcat01
2488  6F27              ;printcat00
2489  6F27
2490  6F27 AF                       xor     a
2491  6F28              printcat02_r
2492  6F28 F5                       push    af
2493  6F29 E5                       push    hl
2494  6F2A                                     ;print 24 row
2495  6F2A
2496  6F2A 32 9C 73                 ld      (catposit_r+1),a
2497  6F2D 21 9B 73                 ld      hl,catposit_r ;установим позицию печати
2498  6F30 CD 82 77                 call    print
2499  6F33 E1                       pop     hl
2500  6F34 E5                       push    hl
2501  6F35 3A 7C 73     			ld a,(open_trd_flag)
2502  6F38 B7           			or a
2503  6F39 28 05        			jr z,printcat02_r_net
2504  6F3B CD 0C 70     			call format_name_trd ;подготовим имя, если это открытый образ
2505  6F3E 18 03        			jr printcat02_r_skip
2506  6F40              printcat02_r_net
2507  6F40 CD 48 70     			call format_name_net
2508  6F43              printcat02_r_skip
2509  6F43              			;отметка галкой
2510  6F43 EB           			ex de,hl
2511  6F44 21 80 CF     			ld hl,cat_mark_r
2512  6F47 DD 7D        			ld a,xl
2513  6F49 85           			add l
2514  6F4A 6F           			ld l,a
2515  6F4B 7E           			ld a,(hl)
2516  6F4C EB           			ex de,hl
2517  6F4D B7           			or a
2518  6F4E 28 09        			jr z,printcat_mark_r
2519  6F50 E5           			push hl
2520  6F51 3E FB        			ld a,0-5 ;знак галка
2521  6F53 01 08 00     			ld bc,8
2522  6F56 09           			add hl,bc
2523  6F57 77           			ld (hl),a
2524  6F58 E1           			pop hl
2525  6F59              printcat_mark_r
2526  6F59 DD 2C        			inc xl
2527  6F5B              			;
2528  6F5B
2529  6F5B 01 0C 00     			ld bc,12 ;длина
2530  6F5E CD 71 77                 call    print_ ;печать одного имени файла
2531  6F61                          ;ld      hl,catspace
2532  6F61                          ;call    print
2533  6F61 E1                       pop     hl
2534  6F62 01 10 00                 ld      bc,lenghtName ;на след. имя
2535  6F65 09                       add     hl,bc
2536  6F66 F1                       pop     af
2537  6F67 3C                       inc     a
2538  6F68 ED 4B 69 73  			ld 		bc,(files_r) ;проверка сколько всего файлов
2539  6F6C B9           			cp 		c
2540  6F6D D0           			ret		nc
2541  6F6E FE 15                    cp      files_view
2542  6F70 38 B6                    jr      c,printcat02_r
2543  6F72 C9           			ret
2544  6F73
2545  6F73
2546  6F73              printcat_l ;печать каталога левая панель
2547  6F73 3A 60 73     		ld a,(cur_drive)
2548  6F76 FE 04        		cp 4
2549  6F78 D2 77 7D     		jp nc,printcat_l_fat ;если FAT
2550  6F7B 3A 6D 73     			ld a,(panel) ;проверка надо ли скрыть курсор
2551  6F7E FE 4C        			cp "L"
2552  6F80 3E 39        			ld a,colorcatc_act
2553  6F82 28 02        			jr z,printcat_l1
2554  6F84 3E 0F        			ld a,colorcat_
2555  6F86              printcat_l1
2556  6F86 32 5A 73     			ld (colorcatc_l),a
2557  6F89
2558  6F89 21 00 58                 ld      hl,col_pos_l ;
2559  6F8C AF                       xor		a
2560  6F8D              clscat_l
2561  6F8D 54                       ld      d,h
2562  6F8E 5D                       ld      e,l
2563  6F8F 13                       inc     de
2564  6F90 4F                       ld      c,a  ;keep
2565  6F91 3A 63 73                 ld      a,(shiftcat_l)
2566  6F94 47                       ld      b,a
2567  6F95 3A 6C 73                 ld      a,(curfile_l)
2568  6F98 A7                       and     a
2569  6F99 98                       sbc     a,b
2570  6F9A B9                       cp      c
2571  6F9B 32 5E 73                 ld      (cursor_l),a ;posit
2572  6F9E 3A 5B 73                 ld      a,(colorcat_l)
2573  6FA1 20 03                    jr      nz,clscat01_l
2574  6FA3 3A 5A 73                 ld      a,(colorcatc_l) ;mark
2575  6FA6              clscat01_l
2576  6FA6 77                       ld      (hl),a  ;раскраска атрибутами
2577  6FA7 79                       ld      a,c  ;restor
2578  6FA8 01 09 00                 ld      bc,9
2579  6FAB ED B0                    ldir
2580  6FAD 01 17 00                 ld      bc,32-9
2581  6FB0 09                       add     hl,bc
2582  6FB1 3C                       inc     a
2583  6FB2 FE 15                    cp      files_view
2584  6FB4 38 D7                    jr      c,clscat_l
2585  6FB6
2586  6FB6                     ;     ld      hl,catposit
2587  6FB6                     ;     call    print
2588  6FB6
2589  6FB6 3A 6B 73     			ld a,(files_l)
2590  6FB9 B7           			or a
2591  6FBA C8           			ret z ;выход если нет файлов
2592  6FBB
2593  6FBB 01 00 D0                 ld      bc,cat_l  ;теперь печать имён файлов
2594  6FBE 3A 63 73                 ld      a,(shiftcat_l)
2595  6FC1 DD 6F        			ld xl,a
2596  6FC3                          ; or      a
2597  6FC3                          ; jr      z,printcat00
2598  6FC3 6F           			ld      l,a
2599  6FC4 26 00        			ld 		h,0
2600  6FC6              ;printcat01  ;find name file
2601  6FC6 29                       add    hl,hl ;2
2602  6FC7 29           			add    hl,hl ;4
2603  6FC8 29           			add    hl,hl ;8
2604  6FC9 29           			add    hl,hl ;16
2605  6FCA 09           			add hl,bc
2606  6FCB                          ;dec    a
2607  6FCB                          ;jr    nz,printcat01
2608  6FCB              ;printcat00
2609  6FCB
2610  6FCB AF                       xor     a
2611  6FCC              printcat02_l
2612  6FCC F5                       push    af
2613  6FCD E5                       push    hl
2614  6FCE                                     ;print 24 row
2615  6FCE
2616  6FCE 32 98 73                 ld      (catposit_l+1),a
2617  6FD1 21 97 73                 ld      hl,catposit_l ;установим позицию печати
2618  6FD4 CD 82 77                 call    print
2619  6FD7 E1                       pop     hl
2620  6FD8 E5                       push    hl
2621  6FD9 CD 0C 70     			call 	format_name_trd ;подготовим
2622  6FDC              			;отметка галкой
2623  6FDC EB           			ex de,hl
2624  6FDD 21 00 CF     			ld hl,cat_mark_l
2625  6FE0 DD 7D        			ld a,xl
2626  6FE2 85           			add l
2627  6FE3 6F           			ld l,a
2628  6FE4 7E           			ld a,(hl)
2629  6FE5 EB           			ex de,hl
2630  6FE6 B7           			or a
2631  6FE7 28 09        			jr z,printcat_mark_l
2632  6FE9 E5           			push hl
2633  6FEA 3E FB        			ld a,0-5 ;знак галка
2634  6FEC 01 08 00     			ld bc,8
2635  6FEF 09           			add hl,bc
2636  6FF0 77           			ld (hl),a
2637  6FF1 E1           			pop hl
2638  6FF2              printcat_mark_l
2639  6FF2 DD 2C        			inc xl
2640  6FF4              			;
2641  6FF4
2642  6FF4 01 0C 00     			ld bc,12 ;длина
2643  6FF7 CD 71 77                 call    print_ ;печать одного имени файла
2644  6FFA                          ;ld      hl,catspace
2645  6FFA                          ;call    print
2646  6FFA E1                       pop     hl
2647  6FFB 01 10 00                 ld      bc,lenghtName ;на след. имя
2648  6FFE 09                       add     hl,bc
2649  6FFF F1                       pop     af
2650  7000 3C                       inc     a
2651  7001 ED 4B 6B 73  			ld 		bc,(files_l) ;проверка сколько всего файлов
2652  7005 B9           			cp 		c
2653  7006 D0           			ret		nc
2654  7007 FE 15                    cp      files_view ;проверка сколько файлов показывать
2655  7009 38 C1                    jr      c,printcat02_l
2656  700B C9           			ret
2657  700C
2658  700C
2659  700C
2660  700C              format_name_trd ;подготавливает имя файла для печати в каталоге, на выходе адрес в HL
2661  700C 11 6E 73                 ld      de,catFName ;здесь временное имя файла
2662  700F 01 08 00                 ld      bc,8   ;name 8 sym
2663  7012 ED B0                    ldir
2664  7014 3E 20        			ld		a," " ;добавим пробел перед расширением
2665  7016 12           			ld		(de),a
2666  7017 13           			inc		de
2667  7018 7E           			ld 		a,(hl) ;если это строчная буква, то расширение 3 символа
2668  7019 ED A0        			ldi			;перенесём первую букву расширения
2669  701B FE 61        			cp 		"a"
2670  701D 38 1B        			jr 		c,format_name_trd05
2671  701F 7E           			ld 		a,(hl)		;перенесём ещё две буквы
2672  7020 B7           			or		a
2673  7021 20 0A        			jr		nz,format_name_trd021
2674  7023 3E 20        			ld		a," " ;если второй нуль, то забъём пробелами
2675  7025 12           			ld		(de),a
2676  7026 23           			inc		hl
2677  7027 13           			inc 	de
2678  7028 12           			ld 		(de),a
2679  7029 23           			inc 	hl
2680  702A 13           			inc		de
2681  702B 18 15        			jr		format_name_trd06
2682  702D              format_name_trd021
2683  702D ED A0        			ldi		;перенесли вторую букву
2684  702F 7E           			ld 		a,(hl)
2685  7030 B7           			or		a
2686  7031 20 02        			jr		nz,format_name_trd022
2687  7033 3E 20        			ld		a," " ;если третий нуль, добъём пробелом
2688  7035              format_name_trd022
2689  7035 12           			ld		(de),a ;перенесли третью
2690  7036 23           			inc		hl
2691  7037 13           			inc 	de
2692  7038 18 08        			jr		format_name_trd06
2693  703A              format_name_trd05 ;забъём пробелами если расширение одна буква
2694  703A 23           			inc		hl
2695  703B 23           			inc		hl
2696  703C 3E 20        			ld		a," "
2697  703E 12           			ld 		(de),a
2698  703F 13           			inc 	de
2699  7040 12           			ld		(de),a
2700  7041 13           			inc 	de
2701  7042              format_name_trd06
2702  7042 AF                       xor		a
2703  7043 12                       ld      (de),a ;marker end line
2704  7044 21 6E 73     			ld 		hl,catFName
2705  7047 C9           			ret
2706  7048
2707  7048
2708  7048              ;для каталога сервера
2709  7048              format_name_net ;подготавливает имя файла для печати в каталоге, на выходе адрес в HL
2710  7048 E5           			push hl
2711  7049 21 6E 73                 ld      hl,catFName ;здесь временное имя файла
2712  704C 11 6F 73     			ld      de,catFName+1
2713  704F 36 20        			ld (hl)," "
2714  7051 01 0A 00     			ld bc,8+3-1
2715  7054 ED B0        			ldir ;почистить
2716  7056 E1           			pop hl
2717  7057 11 6E 73     			ld      de,catFName ;здесь временное имя файла
2718  705A 01 FF 08                 ld      bc,#08ff   ;name 8 sym
2719  705D              format_name_net_cl
2720  705D 7E           			ld a,(hl)
2721  705E FE 2E        			cp "."
2722  7060 28 04        			jr z,format_name_net_ext
2723  7062 ED A0        			ldi
2724  7064 10 F7        			djnz format_name_net_cl
2725  7066              format_name_net_ext
2726  7066 23           			inc hl
2727  7067 11 77 73     			ld      de,catFName+9
2728  706A 01 03 00                 ld      bc,3   ;ext 3 sym
2729  706D ED B0        			ldir
2730  706F AF           			xor		a
2731  7070 12                       ld      (de),a ;marker end line
2732  7071 21 6E 73     			ld 		hl,catFName
2733  7074 C9           			ret
2734  7075
2735  7075
2736  7075              format_name_fat_l ;подготавливает имя файла для печати в каталоге, на выходе адрес в HL
2737  7075 11 6E 73                 ld      de,catFName ;здесь временное имя файла
2738  7078 01 08 00                 ld      bc,8   ;name 8 sym
2739  707B ED B0                    ldir
2740  707D 3E 20        			ld		a," " ;добавим пробел перед расширением
2741  707F 12           			ld		(de),a
2742  7080 13           			inc		de
2743  7081
2744  7081              			;ld bc,#0b-8
2745  7081              			;push hl
2746  7081              			;add hl,bc
2747  7081              			;ld a,(hl)
2748  7081              			;pop hl
2749  7081              			; bit 4,a ;признак каталога
2750  7081              			; jr z,format_name_fat_l_no_dir
2751  7081              			; ;если папка
2752  7081              			; ld a,"<"
2753  7081              			; ld (de),a
2754  7081              			; inc de
2755  7081              			; ld a,"."
2756  7081              			; ld (de),a
2757  7081              			; inc de
2758  7081              			; ld a,">"
2759  7081              			; ld (de),a
2760  7081              			; inc de
2761  7081              			; jr format_name_fat_l_ex
2762  7081              format_name_fat_l_no_dir
2763  7081 01 03 00     			ld bc,3
2764  7084 ED B0        			ldir		;перенесём расширение
2765  7086              format_name_fat_l_ex
2766  7086 AF           			xor		a
2767  7087 12                       ld      (de),a ;marker end line
2768  7088 21 6E 73     			ld 		hl,catFName
2769  708B C9           			ret
2770  708C
2771  708C
2772  708C
2773  708C              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
2774  708C              				;на входе в HL число
2775  708C 11 10 27     			ld de,10000 ;десятки тысяч
2776  708F 3E FF        			ld a,255
2777  7091              toDecimal10k
2778  7091 A7           			and a
2779  7092 ED 52        			sbc hl,de
2780  7094 3C           			inc a
2781  7095 30 FA        			jr nc,toDecimal10k
2782  7097 19           			add hl,de
2783  7098 C6 30        			add a,48
2784  709A 32 E2 70     			ld (decimalS),a
2785  709D 11 E8 03     			ld de,1000 ;тысячи
2786  70A0 3E FF        			ld a,255
2787  70A2              toDecimal1k
2788  70A2 A7           			and a
2789  70A3 ED 52        			sbc hl,de
2790  70A5 3C           			inc a
2791  70A6 30 FA        			jr nc,toDecimal1k
2792  70A8 19           			add hl,de
2793  70A9 C6 30        			add a,48
2794  70AB 32 E3 70     			ld (decimalS+1),a
2795  70AE 11 64 00     			ld de,100 ;сотни
2796  70B1 3E FF        			ld a,255
2797  70B3              toDecimal01k
2798  70B3 A7           			and a
2799  70B4 ED 52        			sbc hl,de
2800  70B6 3C           			inc a
2801  70B7 30 FA        			jr nc,toDecimal01k
2802  70B9 19           			add hl,de
2803  70BA C6 30        			add a,48
2804  70BC 32 E4 70     			ld (decimalS+2),a
2805  70BF 11 0A 00     			ld de,10 ;десятки
2806  70C2 3E FF        			ld a,255
2807  70C4              toDecimal001k
2808  70C4 A7           			and a
2809  70C5 ED 52        			sbc hl,de
2810  70C7 3C           			inc a
2811  70C8 30 FA        			jr nc,toDecimal001k
2812  70CA 19           			add hl,de
2813  70CB C6 30        			add a,48
2814  70CD 32 E5 70     			ld (decimalS+3),a
2815  70D0 11 01 00     			ld de,1 ;единицы
2816  70D3 3E FF        			ld a,255
2817  70D5              toDecimal0001k
2818  70D5 A7           			and a
2819  70D6 ED 52        			sbc hl,de
2820  70D8 3C           			inc a
2821  70D9 30 FA        			jr nc,toDecimal0001k
2822  70DB 19           			add hl,de
2823  70DC C6 30        			add a,48
2824  70DE 32 E6 70     			ld (decimalS+4),a
2825  70E1
2826  70E1 C9           			ret
2827  70E2
2828  70E2 00 00 00...  decimalS	ds 5 ;десятичные цифры
2829  70E7
2830  70E7
2831  70E7              calc_check_sum ;подсчёт контрольной суммы
2832  70E7 21 00 00     	ld hl,0
2833  70EA              	;ld de,rec_buf
2834  70EA ED 4B 91 73  	ld bc,(check_sum_size) ;pack_size_1024_com+pack_size_32_com
2835  70EE              calc_check_sum1
2836  70EE C5           	push bc
2837  70EF EB           	ex de,hl
2838  70F0 4E           	ld c,(hl)
2839  70F1 06 00        	ld b,0
2840  70F3 EB           	ex de,hl
2841  70F4 09           	add hl,bc
2842  70F5 13           	inc de
2843  70F6 C1           	pop bc
2844  70F7 0B           	dec bc
2845  70F8 78           	ld a,b
2846  70F9 B1           	or c
2847  70FA 20 F2        	jr nz,calc_check_sum1
2848  70FC C9           	ret
2849  70FD
2850  70FD              readcat ;чтение каталога
2851  70FD 3A 60 73     			ld 		a,(cur_drive)
2852  7100 FE 04        			cp 4
2853  7102 D2 E9 7C     			jp nc,readcat_fat ;начиная с 4 будет диск FAT
2854  7105 0E 01                    ld      c,1 ;настройка на диск
2855  7107 CD 13 3D                 call    #3d13
2856  710A 0E 18                    ld      c,#18
2857  710C CD 13 3D                 call    #3d13
2858  710F 21 00 D0                 ld      hl,cat_l ;to
2859  7112 11 00 00                 ld      de,#0000 ;0 trk 0 sec
2860  7115 06 09                    ld      b,9      ;9 sect
2861  7117 0E 05                    ld      c,5 ;read
2862  7119 CD 13 3D                 call    #3d13
2863  711C 21 E4 D8                 ld      hl,cat_l+2048+#e4;
2864  711F 7E                       ld      a,(hl) ;total files
2865  7120 32 6B 73     			ld      (files_l),a ;всего файлов на диске
2866  7123                          ;or      a
2867  7123                          ;ret     z  ;exit if no fales
2868  7123
2869  7123                          ; ld      c,a
2870  7123                          ; ld      a,128
2871  7123                          ; sub     c
2872  7123                          ; ld      (catend),a ;fill end cat
2873  7123                          ;ld      a,c
2874  7123                          ;call    markdrive
2875  7123 C9                       ret
2876  7124
2877  7124              change_panel ;смена панели
2878  7124 3A 6D 73     	ld a,(panel)
2879  7127 FE 4C        	cp "L"
2880  7129 28 06        	jr z,change_panel_r
2881  712B CD 6C 71     	call sel_left_pan
2882  712E C3 47 60         jp     wait
2883  7131              change_panel_r
2884  7131 CD 42 71     	call sel_right_pan
2885  7134 C3 47 60         jp     wait
2886  7137
2887  7137              printcat ;печать активного каталога
2888  7137 3A 6D 73     	ld a,(panel)
2889  713A FE 4C        	cp "L"
2890  713C CA 73 6F     	jp z,printcat_l
2891  713F C3 CE 6E     	jp printcat_r
2892  7142
2893  7142              sel_right_pan ;выбор правой панели
2894  7142 3A 69 73     	ld     a,(files_r)
2895  7145 32 67 73     	ld     (files),a
2896  7148 3A 61 73     	ld     a,(shiftcat)
2897  714B 32 63 73     	ld     (shiftcat_l),a
2898  714E 3A 68 73     	ld     a,(curfile)
2899  7151 32 6C 73     	ld     (curfile_l),a
2900  7154 3A 62 73     	ld     a,(shiftcat_r)
2901  7157 32 61 73     	ld     (shiftcat),a
2902  715A 3A 6A 73     	ld     a,(curfile_r)
2903  715D 32 68 73     	ld     (curfile),a
2904  7160 3E 52        	ld a,"R"
2905  7162 32 6D 73     	ld (panel),a
2906  7165 CD 73 6F     	call printcat_l
2907  7168 CD CE 6E     	call printcat_r
2908  716B C9           	ret
2909  716C              sel_left_pan ;выбор левой панели
2910  716C 3A 6B 73     	ld     a,(files_l)
2911  716F 32 67 73     	ld     (files),a
2912  7172 3A 61 73     	ld     a,(shiftcat)
2913  7175 32 62 73     	ld     (shiftcat_r),a
2914  7178 3A 68 73     	ld     a,(curfile)
2915  717B 32 6A 73     	ld     (curfile_r),a
2916  717E 3A 63 73     	ld     a,(shiftcat_l)
2917  7181 32 61 73     	ld     (shiftcat),a
2918  7184 3A 6C 73     	ld     a,(curfile_l)
2919  7187 32 68 73     	ld     (curfile),a
2920  718A 3E 4C        	ld a,"L"
2921  718C 32 6D 73     	ld (panel),a
2922  718F CD 73 6F     	call printcat_l
2923  7192 CD CE 6E     	call printcat_r
2924  7195 C9           	ret
2925  7196
2926  7196              init_dev ;инициализация устройства передачи
2927  7196              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
2928  7196 21 5A 74     	ld hl,mes_req_init
2929  7199 CD 62 77     	call print_sys
2930  719C CD 6B 79     	call Uart.init
2931  719F
2932  719F              	; ld de,pack_size_1024 ;размер полного пакета
2933  719F              	; call start_rcv ;всё примем
2934  719F              	;call read_buf
2935  719F
2936  719F              	; ld hl,cmd_brk ;прервать передачу
2937  719F              	; ld de,cmd_brk_end-cmd_brk
2938  719F              	; call start_trn1 ;оправка
2939  719F              	; call read_buf
2940  719F
2941  719F 21 6B 7B     	ld hl,cmd_ipclose ;закрыть соединение
2942  71A2 11 0D 00     	ld de,cmd_ipclose_e-cmd_ipclose
2943  71A5 CD 26 79     	call start_trn1 ;оправка
2944  71A8
2945  71A8 11 4A 04     	ld de,pack_size_1024_full ;размер полного пакета
2946  71AB CD F6 78     	call start_rcv ;всё примем
2947  71AE              	;call read_buf
2948  71AE
2949  71AE              	;подготовить строку открытия соединения
2950  71AE 21 58 7B     	ld hl,cmd_ipstart
2951  71B1 01 13 00     	ld bc,cmd_ipstart_e-cmd_ipstart
2952  71B4 DD 60 DD 69  	ld ix,bc ;длина
2953  71B8 11 B3 BB     	ld de,cipstart_line
2954  71BB ED B0        	ldir
2955  71BD              	;имя сервера
2956  71BD 21 ED 76     	ld hl,server_name
2957  71C0              init_dev_server
2958  71C0 7E           	ld a,(hl)
2959  71C1 FE 20        	cp " "
2960  71C3 38 06        	jr c,init_dev1
2961  71C5 ED A0        	ldi
2962  71C7 DD 23        	inc ix
2963  71C9 18 F5        	jr init_dev_server
2964  71CB              init_dev1
2965  71CB 3E 22        	ld a,'"'
2966  71CD 12           	ld (de),a
2967  71CE 13           	inc de
2968  71CF DD 23        	inc ix
2969  71D1 3E 2C        	ld a,','
2970  71D3 12           	ld (de),a
2971  71D4 13           	inc de
2972  71D5 DD 23        	inc ix
2973  71D7              	;порт
2974  71D7 21 06 77     	ld hl,server_port
2975  71DA              init_dev_server2
2976  71DA 7E           	ld a,(hl)
2977  71DB FE 20        	cp " "
2978  71DD 38 06        	jr c,init_dev2
2979  71DF ED A0        	ldi
2980  71E1 DD 23        	inc ix
2981  71E3 18 F5        	jr init_dev_server2
2982  71E5              init_dev2
2983  71E5 3E 0D        	ld a,13
2984  71E7 12           	ld (de),a
2985  71E8 13           	inc de
2986  71E9 DD 23        	inc ix
2987  71EB 3E 0A        	ld a,10
2988  71ED 12           	ld (de),a
2989  71EE DD 23        	inc ix
2990  71F0
2991  71F0 21 B3 BB     	ld hl,cipstart_line
2992  71F3 DD 54 DD 5D  	ld de,ix ;длина
2993  71F7 CD 26 79     	call start_trn1 ;оправка
2994  71FA
2995  71FA 11 4A 04     	ld de,pack_size_1024_full ;размер полного пакета
2996  71FD CD F6 78     	call start_rcv ;всё примем
2997  7200              	;call read_buf
2998  7200 C9           	ret
2999  7201
3000  7201              ;read_buf	;чтение в буфер
3001  7201              	; ld bc,257 ;очистить буфер - убрать!
3002  7201              	; ld hl,rec_buf
3003  7201              	; ld de,rec_buf+1
3004  7201              	; ld (hl),0
3005  7201              	; ldir
3006  7201
3007  7201              	; ld b,0 ;чтение данных
3008  7201              	; ld hl,rec_buf
3009  7201              ; read_buf1
3010  7201              	; call Uart.read
3011  7201              	; ret nc
3012  7201              	; ld (hl),a
3013  7201              	; inc hl
3014  7201              	; djnz read_buf1
3015  7201              	; ret
3016  7201
3017  7201              	; ;проверка заголовка UDP
3018  7201              ; check_id
3019  7201              	; ld hl,rec_buf
3020  7201              	; ld de,pack_id ;образец для сравнения
3021  7201              	; ld b,0 ;ограничение на поиск
3022  7201              	; ld c,pack_id_e-pack_id ;символов для сравнения
3023  7201              ; compar1
3024  7201              	; ld a,(de)
3025  7201              	; cp (hl)
3026  7201              	; jr z,compar2
3027  7201              	; ld c,pack_id_e-pack_id
3028  7201              	; ld de,pack_id	;с начала образца
3029  7201              	; inc hl
3030  7201              	; djnz compar1
3031  7201              	; jr compar_no
3032  7201              ; compar2
3033  7201              	; inc de
3034  7201              	; inc hl
3035  7201              	; dec c
3036  7201              	; jr nz,compar1
3037  7201              	; ;и в конце найти ещё ":"
3038  7201              ; compar3
3039  7201              	; ld a,(hl)
3040  7201              	; inc hl
3041  7201              	; cp ":"
3042  7201              	; jr z,compar_ok
3043  7201              	; djnz compar3
3044  7201              ; compar_no ;не нашли
3045  7201              	; xor a
3046  7201              	; ret ;
3047  7201              ; compar_ok ;нашли
3048  7201              	; ;в hl указатель на начало ответного пакета
3049  7201              	; ld (rec_buf_adr_pack),hl
3050  7201              	; ex de,hl
3051  7201              	; ld hl,pack_size_32_com
3052  7201              	; add hl,de
3053  7201              	; ld (rec_buf_adr_pack1),hl
3054  7201              	; ex de,hl
3055  7201              	; scf
3056  7201              	; ret
3057  7201
3058  7201
3059  7201              print_progress ;печать текущего прогресса
3060  7201 CD 8C 70     			call toDecimal
3061  7204 21 E2 70     		    ld hl,decimalS ;
3062  7207 11 81 76     			ld de,mes_progress+3
3063  720A 01 05 00     			ld bc,5
3064  720D ED B0        			ldir
3065  720F 21 7E 76     			ld hl,mes_progress
3066  7212 CD 62 77     			call print_sys
3067  7215 C9           			ret
3068  7216
3069  7216              print_progress_tot ;печать общего прогресса
3070  7216 CD 8C 70     			call toDecimal
3071  7219 21 E2 70     		    ld hl,decimalS ;
3072  721C 11 93 76     			ld de,mes_progress_tot+3
3073  721F 01 05 00     			ld bc,5
3074  7222 ED B0        			ldir
3075  7224 21 90 76     			ld hl,mes_progress_tot
3076  7227 CD 62 77     			call print_sys
3077  722A C9           			ret
3078  722B
3079  722B
3080  722B
3081  722B              markF ;отметка файлов для копирования
3082  722B 3A 67 73     	ld a,(files) ;всего
3083  722E B7           	or a
3084  722F CA 46 61     	jp z,wait_cont	;если 0
3085  7232
3086  7232 3A 6D 73     	ld a,(panel)
3087  7235 FE 52        	cp "R"
3088  7237 C2 59 72     	jp nz,markF_l ;если левая панель
3089  723A              	;правая панель
3090  723A 3A 7C 73     	ld a,(open_trd_flag)
3091  723D B7           	or a
3092  723E CA 48 72     	jp z,markF_r1 ;если не открыт образ
3093  7241              	;правая панель
3094  7241 3A 68 73     	ld a,(curfile) ;номер файла
3095  7244 B7           	or a
3096  7245 CA 46 61     	jp z,wait_cont	;многоточие нельзя выбрать
3097  7248              markF_r1
3098  7248 3A 68 73     	ld a,(curfile) ;номер файла
3099  724B 21 80 CF     	ld hl,cat_mark_r
3100  724E 06 00        	ld b,0
3101  7250 4F           	ld c,a
3102  7251 09           	add hl,bc
3103  7252 7E           	ld a,(hl)
3104  7253 EE 01        	xor 1 ;меняем на противоположное
3105  7255 77           	ld (hl),a
3106  7256              	;call wait_releas
3107  7256 C3 46 61     	jp wait_cont
3108  7259
3109  7259              markF_l ;левая панель
3110  7259 3A 60 73     	ld a,(cur_drive)
3111  725C FE 04        	cp 4
3112  725E 38 0E        	jr c,markF_l_TRD ;
3113  7260 3A 68 73     	ld a,(curfile) ;номер файла
3114  7263              	;если FAT
3115  7263 CD 38 82     	call calc_cat_fat_deskr
3116  7266 DD 7E 0B     	ld a,(ix+#0b)
3117  7269 CB 67        	bit 4,a
3118  726B C2 46 61     	jp nz,wait_cont ;если папка, то нельзя пометить
3119  726E              markF_l_TRD
3120  726E 3A 68 73     	ld a,(curfile)
3121  7271 21 00 CF     	ld hl,cat_mark_l
3122  7274 06 00        	ld b,0
3123  7276 4F           	ld c,a
3124  7277 09           	add hl,bc
3125  7278 7E           	ld a,(hl)
3126  7279 EE 01        	xor 1 ;меняем на противоположное
3127  727B 77           	ld (hl),a
3128  727C              	;call wait_releas
3129  727C C3 46 61     	jp wait_cont
3130  727F
3131  727F
3132  727F
3133  727F              mark_all ;отметить все файлы
3134  727F 3A 6D 73     	ld a,(panel)
3135  7282 FE 52        	cp "R"
3136  7284 C2 CF 72     	jp nz,mark_all_l ;если левая панель
3137  7287
3138  7287              	;правая панель
3139  7287 3A 7C 73     	ld a,(open_trd_flag)
3140  728A B7           	or a
3141  728B CA B1 72     	jp z,mark_all_r_fat ;не если не открыт образ
3142  728E 3A 67 73     	ld a,(files) ;всего
3143  7291 FE 02        	cp 2
3144  7293 DA 46 61     	jp c,wait_cont	;если только точки
3145  7296 21 81 CF     	ld hl,cat_mark_r+1
3146  7299 FE 02        	cp 2 ;если один
3147  729B 20 05        	jr nz,mark_all_r
3148  729D              	;если 1 файл
3149  729D 36 01        	ld (hl),1 ;отметить второй
3150  729F CA 46 61     	jp z,wait_cont
3151  72A2              mark_all_r
3152  72A2 D6 02        	sub 2
3153  72A4 06 00        	ld b,0
3154  72A6 4F           	ld c,a
3155  72A7 11 82 CF     	ld de,cat_mark_r+2
3156  72AA 36 01        	ld (hl),1 ;отметить много
3157  72AC ED B0        	ldir
3158  72AE C3 46 61     	jp wait_cont
3159  72B1              mark_all_r_fat
3160  72B1              	;правая fat
3161  72B1 3A 67 73     	ld a,(files) ;всего
3162  72B4 21 80 CF     	ld hl,cat_mark_r
3163  72B7 FE 02        	cp 2 ;если один
3164  72B9 30 05        	jr nc,mark_all_r_fat1
3165  72BB              	;если 1 файл
3166  72BB 36 01        	ld (hl),1
3167  72BD C3 46 61     	jp wait_cont
3168  72C0              mark_all_r_fat1
3169  72C0 D6 01        	sub 1
3170  72C2 06 00        	ld b,0
3171  72C4 4F           	ld c,a
3172  72C5 11 81 CF     	ld de,cat_mark_r+1
3173  72C8 36 01        	ld (hl),1 ;отметить много
3174  72CA ED B0        	ldir
3175  72CC C3 46 61     	jp wait_cont
3176  72CF
3177  72CF
3178  72CF
3179  72CF              mark_all_l ;левая панель
3180  72CF 3A 67 73     	ld a,(files) ;всего
3181  72D2 B7           	or a
3182  72D3 CA 46 61     	jp z,wait_cont	;если 0
3183  72D6
3184  72D6 3A 60 73     	ld a,(cur_drive)
3185  72D9 FE 04        	cp 4
3186  72DB 38 36        	jr c,mark_all_l_TRD ;
3187  72DD
3188  72DD              	;если FAT
3189  72DD 3A 67 73     	ld a,(files) ;всего
3190  72E0 FE 01        	cp 1
3191  72E2 20 13        	jr nz,mark_all_l1_fat
3192  72E4 3A 68 73     	ld a,(curfile) ;номер файла
3193  72E7 CD 38 82     	call calc_cat_fat_deskr
3194  72EA DD 7E 0B     	ld a,(ix+#0b)
3195  72ED CB 67        	bit 4,a
3196  72EF C2 46 61     	jp nz,wait_cont ;если папка, то нельзя пометить
3197  72F2 36 01        	ld (hl),1 ;отметить первый
3198  72F4 C3 46 61     	jp wait_cont
3199  72F7
3200  72F7              mark_all_l1_fat
3201  72F7 5F           	ld e,a ;счётчик
3202  72F8 16 00        	ld d,0
3203  72FA 21 00 CF     	ld hl,cat_mark_l
3204  72FD              mark_all_l1_fat_cl ;цикл
3205  72FD 7A           	ld a,d
3206  72FE CD 38 82     	call calc_cat_fat_deskr
3207  7301 DD 7E 0B     	ld a,(ix+#0b)
3208  7304 CB 67        	bit 4,a
3209  7306 C2 0B 73     	jp nz,mark_all_l1_fat_cl1 ;если папка, то нельзя пометить
3210  7309 36 01        	ld (hl),1 ;отметить много
3211  730B              mark_all_l1_fat_cl1
3212  730B 23           	inc hl
3213  730C 14           	inc d
3214  730D 1D           	dec e
3215  730E 20 ED        	jr nz,mark_all_l1_fat_cl
3216  7310 C3 46 61     	jp wait_cont
3217  7313
3218  7313
3219  7313
3220  7313              	;если TRD
3221  7313              mark_all_l_TRD
3222  7313 3A 67 73     	ld a,(files) ;всего
3223  7316 21 00 CF     	ld hl,cat_mark_l
3224  7319 FE 01        	cp 1
3225  731B 20 05        	jr nz,mark_all_l1
3226  731D 36 01        	ld (hl),1 ;отметить первый
3227  731F CA 46 61     	jp z,wait_cont
3228  7322              mark_all_l1
3229  7322 3D           	dec a
3230  7323 06 00        	ld b,0
3231  7325 4F           	ld c,a
3232  7326 11 01 CF     	ld de,cat_mark_l+1
3233  7329 36 01        	ld (hl),1 ;отметить много
3234  732B ED B0        	ldir
3235  732D C3 46 61     	jp wait_cont
3236  7330
3237  7330
3238  7330
3239  7330              unmark_all ;снять отметку со всех файлов
3240  7330 3A 6D 73     	ld a,(panel)
3241  7333 FE 52        	cp "R"
3242  7335 C2 48 73     	jp nz,unmark_all_l ;если левая панель
3243  7338              	;правая
3244  7338 21 80 CF     	ld hl,cat_mark_r
3245  733B 11 81 CF     	ld de,cat_mark_r+1
3246  733E 36 00        	ld (hl),0
3247  7340 01 7F 00     	ld bc,128-1
3248  7343 ED B0        	ldir
3249  7345 C3 46 61     	jp wait_cont
3250  7348              unmark_all_l ;левая
3251  7348 21 00 CF     	ld hl,cat_mark_l
3252  734B 11 01 CF     	ld de,cat_mark_l+1
3253  734E 36 00        	ld (hl),0
3254  7350 01 7F 00     	ld bc,128-1
3255  7353 ED B0        	ldir
3256  7355 C3 46 61     	jp wait_cont
3257  7358
3258  7358              ;pack_size dw 0 ;размер пакета
3259  7358 01           check_sum_on db 1; флаг включения проверки контрольной суммы
3260  7359 01           check_sum_on_tmp db 1; сохранение флага
3261  735A 39           colorcatc_l db colorcatc_act ;цвет выбранного файла слева
3262  735B 0F           colorcat_l db  colorcat_; цвет окна каталога слева
3263  735C 39           colorcatc_r db colorcatc_act ;цвет выбранного файла справа
3264  735D 0F           colorcat_r db  colorcat_; цвет окна каталога	справа
3265  735E 00           cursor_l   db     0; строка курсора слева
3266  735F 00           cursor_r   db     0; строка курсора справа
3267  7360 00           cur_drive db 0 ; дисковод
3268  7361 00           shiftcat db 0;сдвиг по каталогу
3269  7362 00           shiftcat_r db 0;сдвиг по каталогу правая панель
3270  7363 00           shiftcat_l db 0;сдвиг по каталогу левая панель
3271  7364 14           keyRepeat db 20 ;пауза перед повтором нажатия клавиши
3272  7365 FF           keyLast db 255; последняя нажатая клавиша
3273  7366 00           keyDelayF db 0 ;флаг что уже была пауза нажатия
3274  7367 00           files db 0 ;всего файлов
3275  7368 00           curfile db 0 ; текущий файл
3276  7369 00           files_r db 0 ;всего файлов правая панель
3277  736A 00           curfile_r db 0 ; текущий файл правая панель
3278  736B 00           files_l db 0 ;всего файлов левая панель
3279  736C 00           curfile_l db 0 ; текущий файл левая панель
3280  736D              ;col_pos dw #5800 ;позиция для покраски
3281  736D 00           panel db 0; текущая панель
3282  736E 00 00 00...  catFName  ds		13 ;имя файла для каталога
3283  737B 00           		 db		0 ;маркер конца имени
3284  737C 00           open_trd_flag db 0 ;открыт образ
3285  737D              ;rec_buf_adr_pack dw 0 ;адрес начала принятого пакета без заголовка UDP
3286  737D              ;rec_buf_adr_pack1 dw 0 ;адрес начала принятого пакета без заголовка ZXN
3287  737D 00 00        cur_cat_pag dw 0 ;текущая страница каталога сервера
3288  737F              ;rec_buf_adr_pack1_tmp dw 0 ;временное хранилище
3289  737F 00           curfile_r2 db 0 ;хранение позиции курсора при открытии образа
3290  7380 00           shiftcat_r2 db 0
3291  7381 00           files_r2 db 0
3292  7382 00           files2 db 0
3293  7383 00 00        check_init_val dw 0 ;контрольная сумма для системы внеочередной инициализации
3294  7385 00           check_init_count db 0 ;счётчик системы
3295  7386 00 00        cur_trk dw 0 ;текущие сектор-дорожка
3296  7388 00 00        copyF_RL_source_file dw 0 ;указатель на исходный файл для копирования
3297  738A 00 00        copyF_RL_source_sec_size dw 0 ;размер в секторах исходного файла
3298  738C 00 00        copyF_RL_source_trk dw 0 ;исходные дорожка-сектор файла
3299  738E 00           copyF_RL_dest_sec_cat db 0 ;сектор каталога где запись о файле назначения
3300  738F 00 00        copyF_FAT_RL_last_part dw 0 ;последний кусок файла для записи
3301  7391              ;copyF_RL_first_pack_flag db 0; флаг для первого пакета файла
3302  7391 00 00        check_sum_size dw 0 ;длина области для подсчёта суммы
3303  7393 00 00        cat_mark_cur dw 0 ;текущая позиция в таблице отмеченных файлов слева
3304  7395 00           cat_mark_cur_cl db 0 ;позиция цикла копирования слева
3305  7396 00           cat_mark_cur_tot db 0 ;осталось копировать файлов
3306  7397
3307  7397              catposit_l ;позиция печати каталога слева
3308  7397 16 00 00 00  	db 22,0,0,0
3309  739B              catposit_r ;позиция печати каталога справа
3310  739B 16 00 1E 00  	db 22,0,30,0
3311  739F 20 20 20 20  cat_space db "            ",0 ;пробелы для очистки
3311  73A3 20 20 20 20
3311  73A7 20 20 20 20
3311  73AB 00
3312  73AC              mes_sys_at ;позиция печати сист. сообщений
3313  73AC 16 17 00 00  	db 22,23,0,0
3314  73B0              mes_req_cat
3315  73B0 43 61 74 20  	db "Cat in request  ",0
3315  73B4 69 6E 20 72
3315  73B8 65 71 75 65
3315  73BC 73 74 20 20
3315  73C0 00
3316  73C1              mes_rec_cat
3317  73C1 43 61 74 20  	db "Cat "
3318  73C5              mes_rec_cat_num
3319  73C5 30 30 30 20  	db "000 in OK   ",0
3319  73C9 69 6E 20 4F
3319  73CD 4B 20 20 20
3319  73D1 00
3320  73D2              mes_req_part_file
3321  73D2 46 69 6C 65  	db "File in request ",0
3321  73D6 20 69 6E 20
3321  73DA 72 65 71 75
3321  73DE 65 73 74 20
3321  73E2 00
3322  73E3              mes_trq_part_file
3323  73E3 46 69 6C 65  	db "File out request",0
3323  73E7 20 6F 75 74
3323  73EB 20 72 65 71
3323  73EF 75 65 73 74
3323  73F3 00
3324  73F4              mes_rec_file
3325  73F4 46 69 6C 65  	db "File in OK      ",0
3325  73F8 20 69 6E 20
3325  73FC 4F 4B 20 20
3325  7400 20 20 20 20
3325  7404 00
3326  7405              mes_trn_file
3327  7405 46 69 6C 65  	db "File out OK     ",0
3327  7409 20 6F 75 74
3327  740D 20 4F 4B 20
3327  7411 20 20 20 20
3327  7415 00
3328  7416              mes_rec_part_file
3329  7416 50 61 72 74  	db "Part in OK      ",0
3329  741A 20 69 6E 20
3329  741E 4F 4B 20 20
3329  7422 20 20 20 20
3329  7426 00
3330  7427              mes_trn_part_file
3331  7427 50 61 72 74  	db "Part out OK     ",0
3331  742B 20 6F 75 74
3331  742F 20 4F 4B 20
3331  7433 20 20 20 20
3331  7437 00
3332  7438              mes_wrt_part_file
3333  7438 57 72 69 74  	db "Write "
3333  743C 65 20
3334  743E              mes_wrt_part_file_num
3335  743E 30 30 30 20  	db "000       ",0
3335  7442 20 20 20 20
3335  7446 20 20 00
3336  7449              mes_rd_part_file
3337  7449 52 65 61 64  	db "Read "
3337  744D 20
3338  744E              mes_rd_part_file_num
3339  744E 30 30 30 20  	db "000        ",0
3339  7452 20 20 20 20
3339  7456 20 20 20 00
3340  745A              mes_req_init
3341  745A 49 6E 69 74  	db "Init            ",0
3341  745E 20 20 20 20
3341  7462 20 20 20 20
3341  7466 20 20 20 20
3341  746A 00
3342  746B              ; mes_translink_off
3343  746B              	; db "ESP link off    ",0
3344  746B              ; mes_translink_on
3345  746B              	; db "ESP link on     ",0
3346  746B              mes_esp_rst
3347  746B 45 53 50 20  	db "ESP reset       ",0
3347  746F 72 65 73 65
3347  7473 74 20 20 20
3347  7477 20 20 20 20
3347  747B 00
3348  747C              mes_ok
3349  747C 4F 4B 20 20  	db "OK              ",0
3349  7480 20 20 20 20
3349  7484 20 20 20 20
3349  7488 20 20 20 20
3349  748C 00
3350  748D
3351  748D              mes_win_cls
3352  748D 16 0E 0D 20  	db 22,14,13,"                "
3352  7491 20 20 20 20
3352  7495 20 20 20 20
3352  7499 20 20 20 20
3352  749D 20 20 20
3353  74A0 16 0F 0D 20  	db 22,15,13,"                "
3353  74A4 20 20 20 20
3353  74A8 20 20 20 20
3353  74AC 20 20 20 20
3353  74B0 20 20 20
3354  74B3 16 10 0D 20  	db 22,16,13,"                ",0
3354  74B7 20 20 20 20
3354  74BB 20 20 20 20
3354  74BF 20 20 20 20
3354  74C3 20 20 20 00
3355  74C7              mes_trd_name
3356  74C7 16 0F 0D 4E  	db 22,15,13,"Name: ";
3356  74CB 61 6D 65 3A
3356  74CF 20
3357  74D0 20 20 20 20  trd_name db "          "
3357  74D4 20 20 20 20
3357  74D8 20 20
3358  74DA              mes_trd_name_curs
3359  74DA 16 10 0D 20  	db 22,16,13,"                ",0
3359  74DE 20 20 20 20
3359  74E2 20 20 20 20
3359  74E6 20 20 20 20
3359  74EA 20 20 20 00
3360  74EE
3361  74EE              mes_read_trd
3362  74EE 16 0E 0D 20  	db 22,14,13," READ TRD, dsk:",0;
3362  74F2 52 45 41 44
3362  74F6 20 54 52 44
3362  74FA 2C 20 64 73
3362  74FE 6B 3A 00
3363  7501              mes_write_trd
3364  7501 16 0E 0D 57  	db 22,14,13,"WRITE TRD, dsk:",0;
3364  7505 52 49 54 45
3364  7509 20 54 52 44
3364  750D 2C 20 64 73
3364  7511 6B 3A 00
3365  7514 16 0E 1C 41  mes_trd_dsk db 22,14,28,"A"
3366  7518 16 0F 0D 20  	db 22,15,13,"  Y to start   "
3366  751C 20 59 20 74
3366  7520 6F 20 73 74
3366  7524 61 72 74 20
3366  7528 20 20
3367  752A 16 10 0D 20  	db 22,16,13,"  N to cancel  ",0
3367  752E 20 4E 20 74
3367  7532 6F 20 63 61
3367  7536 6E 63 65 6C
3367  753A 20 20 00
3368  753D              mes_chs_error
3369  753D 43 68 65 63  	db "Check sum error ",0
3369  7541 6B 20 73 75
3369  7545 6D 20 65 72
3369  7549 72 6F 72 20
3369  754D 00
3370  754E              mes_pac_error
3371  754E 50 61 63 6B  	db "Packet error    ",0
3371  7552 65 74 20 65
3371  7556 72 72 6F 72
3371  755A 20 20 20 20
3371  755E 00
3372  755F              mes_stopped
3373  755F 53 74 6F 70  	db "Stopped         ",0
3373  7563 70 65 64 20
3373  7567 20 20 20 20
3373  756B 20 20 20 20
3373  756F 00
3374  7570              mes_title
3375  7570 16 00 0E 41  	db 22,0,14,"AY232K v0.1.2"
3375  7574 59 32 33 32
3375  7578 4B 20 76 30
3375  757C 2E 31 2E 32
3376  7580 16 02 0E 41  	db 22,2,14,"Arrow keys"
3376  7584 72 72 6F 77
3376  7588 20 6B 65 79
3376  758C 73
3377  758D 16 03 0E 52  	db 22,3,14,"R - renew"
3377  7591 20 2D 20 72
3377  7595 65 6E 65 77
3378  7599 16 04 0E 41  	db 22,4,14,"A-D, H - disk"
3378  759D 2D 44 2C 20
3378  75A1 48 20 2D 20
3378  75A5 64 69 73 6B
3379  75A9 16 05 0E 45  	db 22,5,14,"En - run/open"
3379  75AD 6E 20 2D 20
3379  75B1 72 75 6E 2F
3379  75B5 6F 70 65 6E
3380  75B9 16 06 0E 35  	db 22,6,14,"5 - copy"
3380  75BD 20 2D 20 63
3380  75C1 6F 70 79
3381  75C4 16 07 0E 54  	db 22,7,14,"T - TRD copy"
3381  75C8 20 2D 20 54
3381  75CC 52 44 20 63
3381  75D0 6F 70 79
3382  75D3 16 08 0E 45  	db 22,8,14,"Ext - panel"
3382  75D7 78 74 20 2D
3382  75DB 20 70 61 6E
3382  75DF 65 6C
3383  75E1 16 09 0E 53  	db 22,9,14,"Sp - mark/stop"
3383  75E5 70 20 2D 20
3383  75E9 6D 61 72 6B
3383  75ED 2F 73 74 6F
3383  75F1 70
3384  75F2 16 0A 0E 4B  	db 22,10,14,"K - mark all"
3384  75F6 20 2D 20 6D
3384  75FA 61 72 6B 20
3384  75FE 61 6C 6C
3385  7601 16 0B 0E 4A  	db 22,11,14,"J - unmark all"
3385  7605 20 2D 20 75
3385  7609 6E 6D 61 72
3385  760D 6B 20 61 6C
3385  7611 6C
3386  7612 16 0C 0E 45  	db 22,12,14,"E - exit"
3386  7616 20 2D 20 65
3386  761A 78 69 74
3387  761D              	;db 22,11,15,"S - Sum: "
3388  761D              ;mes_check_sum
3389  761D              	;db "Y"
3390  761D              	; db 22,13,15,"Dangerous(!):"
3391  761D 16 0D 0E 49  	db 22,13,14,"I - ESP Reset"
3391  7621 20 2D 20 45
3391  7625 53 50 20 52
3391  7629 65 73 65 74
3392  762D
3393  762D 00           	db 0
3394  762E              mes_wait
3395  762E 16 11 12 57  	db 22,17,18,"Wait..",0
3395  7632 61 69 74 2E
3395  7636 2E 00
3396  7638              mes_wait_off
3397  7638 16 11 12 20  	db 22,17,18,"      ",0
3397  763C 20 20 20 20
3397  7640 20 00
3398  7642              mes_copy_file
3399  7642 16 0E 0D 43  	db 22,14,13,         "COPY FILE, dsk:",0;
3399  7646 4F 50 59 20
3399  764A 46 49 4C 45
3399  764E 2C 20 64 73
3399  7652 6B 3A 00
3400  7655              mes_copy_error
3401  7655 16 0F 0D 10  	db 22,15,13,16,2*8+7,"Error copy file "
3401  7659 17 45 72 72
3401  765D 6F 72 20 63
3401  7661 6F 70 79 20
3401  7665 66 69 6C 65
3401  7669 20
3402  766A 16 10 0D 20  	db 22,16,13,         "                ",0
3402  766E 20 20 20 20
3402  7672 20 20 20 20
3402  7676 20 20 20 20
3402  767A 20 20 20 00
3403  767E
3404  767E              mes_progress
3405  767E 16 13 12 30  	db 22,19,18,"00000",0
3405  7682 30 30 30 30
3405  7686 00
3406  7687              mes_progress_off
3407  7687 16 13 12 20  	db 22,19,18,"     ",0
3407  768B 20 20 20 20
3407  768F 00
3408  7690
3409  7690              mes_progress_tot
3410  7690 16 14 12 30  	db 22,20,18,"00000",0
3410  7694 30 30 30 30
3410  7698 00
3411  7699              mes_progress_tot_off
3412  7699 16 14 12 20  	db 22,20,18,"     ",0
3412  769D 20 20 20 20
3412  76A1 00
3413  76A2
3414  76A2 16 00 00 53  mes_curent_drive	db 22,0,0,"Select ("
3414  76A6 65 6C 65 63
3414  76AA 74 20 28
3415  76AD 20 29 00     mes_curent_drive_letter db " )",0
3416  76B0 16 01 00 41  mes_fdd	db 22,1,0,"A-D - FDD",0
3416  76B4 2D 44 20 2D
3416  76B8 20 46 44 44
3416  76BC 00
3417  76BD 16 02 00 00  mes_fat_found db 22,2,0,0
3418  76C1 16 02 00 46  mes_fat_not_found db 22,2,0,"FAT not found",13,0
3418  76C5 41 54 20 6E
3418  76C9 6F 74 20 66
3418  76CD 6F 75 6E 64
3418  76D1 0D 00
3419  76D3 0D 00        mes_next_line db 13,0
3420  76D5
3421  76D5 4E 6F 20     mes_read_cfg_err db "No "
3422  76D8 41 59 32 33  file_cfg_name db "AY232K_iC",0
3422  76DC 32 4B 5F 69
3422  76E0 43 00
3423  76E2
3424  76E2              mes_server
3425  76E2 16 16 12 53  	db 22,22,18,"Server: "
3425  76E6 65 72 76 65
3425  76EA 72 3A 20
3426  76ED 00 00 00...  server_name ds 15 ;имя сервера
3427  76FC 00           	db 0
3428  76FD              mes_port
3429  76FD 16 17 12 50  	db 22,23,18,"Port: "
3429  7701 6F 72 74 3A
3429  7705 20
3430  7706 00 00 00 00  server_port ds 4 ;порт
3431  770A 00           	db 0
3432  770B
3433  770B
3434  770B
3435  770B              scroll_sys ;скрол области системных сообщений
3436  770B              	; ld de,#4000+2048+2048+3*32
3437  770B              	; ld hl,#4000+2048+2048+4*32
3438  770B              	; ld a,8
3439  770B              ; scroll_sys1
3440  770B              	; push hl
3441  770B              	; push de
3442  770B              	; ld bc,scroll_len ; длина области для сдвига
3443  770B              	; ldir
3444  770B              	; pop de
3445  770B              	; pop hl
3446  770B              	; inc h
3447  770B              	; inc d
3448  770B              	; dec a
3449  770B              	; jr nz,scroll_sys1
3450  770B
3451  770B              	; ld de,#4000+2048+2048+4*32
3452  770B              	; ld hl,#4000+2048+2048+5*32
3453  770B              	; ld a,8
3454  770B              ; scroll_sys2
3455  770B              	; push hl
3456  770B              	; push de
3457  770B              	; ld bc,scroll_len ; длина области для сдвига
3458  770B              	; ldir
3459  770B              	; pop de
3460  770B              	; pop hl
3461  770B              	; inc h
3462  770B              	; inc d
3463  770B              	; dec a
3464  770B              	; jr nz,scroll_sys2
3465  770B
3466  770B 11 A0 50     	ld de,#4000+2048+2048+5*32
3467  770E 21 C0 50     	ld hl,#4000+2048+2048+6*32
3468  7711 3E 08        	ld a,8
3469  7713              scroll_sys3
3470  7713 E5           	push hl
3471  7714 D5           	push de
3472  7715              	dup scroll_len ; длина области для сдвига
3473  7715 ED A0       >	ldi
3473  7717 ED A0       >	ldi
3473  7719 ED A0       >	ldi
3473  771B ED A0       >	ldi
3473  771D ED A0       >	ldi
3473  771F ED A0       >	ldi
3473  7721 ED A0       >	ldi
3473  7723 ED A0       >	ldi
3473  7725 ED A0       >	ldi
3473  7727 ED A0       >	ldi
3473  7729 ED A0       >	ldi
3473  772B ED A0       >	ldi
3473  772D ED A0       >	ldi
3474  772F              	edup
3475  772F D1           	pop de
3476  7730 E1           	pop hl
3477  7731 24           	inc h
3478  7732 14           	inc d
3479  7733 3D           	dec a
3480  7734 20 DD        	jr nz,scroll_sys3
3481  7736
3482  7736 11 C0 50     	ld de,#4000+2048+2048+6*32
3483  7739 21 E0 50     	ld hl,#4000+2048+2048+7*32
3484  773C 3E 08        	ld a,8
3485  773E              scroll_sys4
3486  773E E5           	push hl
3487  773F D5           	push de
3488  7740              	dup scroll_len ; длина области для сдвига
3489  7740 ED A0       >	ldi
3489  7742 ED A0       >	ldi
3489  7744 ED A0       >	ldi
3489  7746 ED A0       >	ldi
3489  7748 ED A0       >	ldi
3489  774A ED A0       >	ldi
3489  774C ED A0       >	ldi
3489  774E ED A0       >	ldi
3489  7750 ED A0       >	ldi
3489  7752 ED A0       >	ldi
3489  7754 ED A0       >	ldi
3489  7756 ED A0       >	ldi
3489  7758 ED A0       >	ldi
3490  775A              	edup
3491  775A D1           	pop de
3492  775B E1           	pop hl
3493  775C 24           	inc h
3494  775D 14           	inc d
3495  775E 3D           	dec a
3496  775F 20 DD        	jr nz,scroll_sys4
3497  7761 C9           	ret
3498  7762
3499  7762
3500  7762              print_sys
3501  7762 E5           	push hl
3502  7763 CD 0B 77     	call scroll_sys
3503  7766 21 AC 73     	ld hl,mes_sys_at
3504  7769 CD 82 77     	call print ;установка позиции
3505  776C E1           	pop hl
3506  776D CD 82 77     	call print
3507  7770 C9           	ret
3508  7771              ;печать до символа 0
3509  7771              ;hl - text address
3510  7771              ;13-enter
3511  7771              ;16-color(атрибуты 128+64+pap*8+ink)
3512  7771              ;20-inverse
3513  7771              ;21-отступ от левого края
3514  7771              ;22-at
3515  7771              print_  ;var 2: print text lenght in bc
3516  7771 7E                   ld      a,(hl)
3517  7772 CD F4 77             call    prsym
3518  7775 23                   inc     hl
3519  7776 0B                   dec     bc
3520  7777 78                   ld      a,b
3521  7778 B1                   or      c
3522  7779 20 F6                jr      nz,print_
3523  777B C9                   ret
3524  777C E1           aupr    pop     hl
3525  777D CD 82 77             call    print
3526  7780 E5                   push    hl
3527  7781 C9                   ret
3528  7782              ;start print to 0
3529  7782 7E           print   ld      a,(hl)
3530  7783 23                   inc     hl
3531  7784 B7                   or      a
3532  7785 C8                   ret     z
3533  7786 FE 17                cp      23
3534  7788 38 05                jr      c,prin
3535  778A CD F4 77             call    prsym
3536  778D 18 F3                jr      print
3537  778F              prin
3538  778F FE 0D                cp      13
3539  7791 20 14                jr      nz,prin0
3540  7793 3A F3 78             ld      a,(space)
3541  7796 32 F5 78             ld      (xtxt),a
3542  7799 3A F4 78             ld      a,(ytxt)
3543  779C 3C                   inc     a
3544  779D FE 17                cp      23
3545  779F 38 01                jr      c,pr13_0
3546  77A1 AF                   xor     a
3547  77A2 32 F4 78     pr13_0  ld      (ytxt),a
3548  77A5 18 DB                jr      print
3549  77A7 FE 10        prin0   cp      16
3550  77A9 20 07                jr      nz,prin1
3551  77AB 7E                   ld      a,(hl)
3552  77AC 23                   inc     hl
3553  77AD 32 8F 5C             ld      (23695),a
3554  77B0 18 D0                jr      print
3555  77B2 FE 14        prin1   cp      20
3556  77B4 20 23                jr      nz,prin2
3557  77B6 7E                   ld      a,(hl)
3558  77B7 23                   inc     hl
3559  77B8 B7                   or      a
3560  77B9 28 10                jr      z,pr20_0
3561  77BB 3E 2F                ld      a,#2f
3562  77BD 32 63 78             ld      (pr0),a
3563  77C0 32 7F 78             ld      (pr1),a
3564  77C3 32 8F 78             ld      (pr2),a
3565  77C6 32 AA 78             ld      (pr3),a
3566  77C9 18 B7                jr      print
3567  77CB 32 63 78     pr20_0  ld      (pr0),a
3568  77CE 32 7F 78             ld      (pr1),a
3569  77D1 32 8F 78             ld      (pr2),a
3570  77D4 32 AA 78             ld      (pr3),a
3571  77D7 18 A9                jr      print
3572  77D9 FE 16        prin2   cp      22
3573  77DB 20 0C                jr      nz,prin3
3574  77DD 7E                   ld      a,(hl)
3575  77DE 32 F4 78             ld      (ytxt),a
3576  77E1 23                   inc     hl
3577  77E2 7E                   ld      a,(hl)
3578  77E3 32 F5 78             ld      (xtxt),a
3579  77E6 23                   inc     hl
3580  77E7 18 99                jr      print
3581  77E9 FE 15        prin3   cp      21
3582  77EB 20 95                jr      nz,print
3583  77ED 7E                   ld      a,(hl)
3584  77EE 23                   inc     hl
3585  77EF 32 F3 78             ld      (space),a
3586  77F2 18 8E                jr      print
3587  77F4              prsym
3588  77F4 F5                   push    af
3589  77F5 C5                   push    bc
3590  77F6 D5                   push    de
3591  77F7 E5                   push    hl
3592  77F8 DD E5                push    ix
3593  77FA ED 5B F4 78          ld      de,(ytxt)
3594  77FE 14                   inc     d
3595  77FF ED 53 F4 78          ld      (ytxt),de
3596  7803 15                   dec     d
3597  7804 08                   ex      af,af'
3598  7805 7A                   ld      a,d
3599  7806 FE 29                cp      41
3600  7808 38 10                jr      c,prs
3601  780A 7B                   ld      a,e
3602  780B 3C                   inc     a
3603  780C FE 18                cp      24
3604  780E 38 01                jr      c,prs1
3605  7810 AF                   xor     a
3606  7811 32 F4 78     prs1    ld      (ytxt),a
3607  7814 3A F3 78             ld      a,(space)
3608  7817 32 F5 78             ld      (xtxt),a
3609  781A 08           prs     ex      af,af'
3610  781B 6F                   ld      l,a
3611  781C 26 00                ld      h,#00
3612  781E 29                   add     hl,hl
3613  781F 29                   add     hl,hl
3614  7820 29                   add     hl,hl
3615  7821 01 D3 82             ld      bc,font
3616  7824 09                   add     hl,bc
3617  7825 E5                   push    hl
3618  7826 7A                   ld      a,d
3619  7827 87                   add     a,a
3620  7828 57                   ld      d,a
3621  7829 87                   add     a,a
3622  782A 82                   add     a,d
3623  782B C6 02                add     a,#02
3624  782D 57                   ld      d,a
3625  782E E6 07                and     #07
3626  7830 08                   ex      af,af'
3627  7831 7A                   ld      a,d
3628  7832 0F                   rrca
3629  7833 0F                   rrca
3630  7834 0F                   rrca
3631  7835 E6 1F                and     #1F
3632  7837 57                   ld      d,a
3633  7838 7B                   ld      a,e
3634  7839 E6 18                and     #18
3635  783B C6 40                add     a,#40
3636  783D 67                   ld      h,a
3637  783E 7B                   ld      a,e
3638  783F E6 07                and     #07
3639  7841 0F                   rrca
3640  7842 0F                   rrca
3641  7843 0F                   rrca
3642  7844 82                   add     a,d
3643  7845 6F                   ld      l,a
3644  7846 22 F1 78             ld      (posit),hl
3645  7849 D1                   pop     de
3646  784A 06 08                ld      b,#08
3647  784C 08                   ex      af,af'
3648  784D 28 2B                jr      z,L73C7
3649  784F DD 60                ld      xh,b
3650  7851 FE 02                cp      #02
3651  7853 28 35                jr      z,L73D6
3652  7855 FE 04                cp      #04
3653  7857 28 45                jr      z,L73E9
3654  7859 7E           L73A7   ld      a,(hl)
3655  785A 0F                   rrca
3656  785B 0F                   rrca
3657  785C 47                   ld      b,a
3658  785D 23                   inc     hl
3659  785E 7E                   ld      a,(hl)
3660  785F E6 0F                and     #0F
3661  7861 4F                   ld      c,a
3662  7862 1A                   ld      a,(de)
3663  7863 00           pr0     nop
3664  7864 E6 FC                and     #FC
3665  7866 CB 27                sla     a
3666  7868 CB 10                rl      b
3667  786A CB 27                sla     a
3668  786C CB 10                rl      b
3669  786E B1                   or      c
3670  786F 77                   ld      (hl),a
3671  7870 2B                   dec     hl
3672  7871 70                   ld      (hl),b
3673  7872 24                   inc     h
3674  7873 13                   inc     de
3675  7874 DD 25                dec     xh
3676  7876 20 E1                jr      nz,L73A7
3677  7878 18 60                jr      prsc1
3678  787A 7E           L73C7   ld      a,(hl)
3679  787B E6 03                and     #03
3680  787D 4F                   ld      c,a
3681  787E 1A                   ld      a,(de)
3682  787F 00           pr1     nop
3683  7880 E6 FC                and     #FC
3684  7882 B1                   or      c
3685  7883 77                   ld      (hl),a
3686  7884 24                   inc     h
3687  7885 13                   inc     de
3688  7886 10 F2                djnz    L73C7
3689  7888 18 3F                jr      prsc
3690  788A 7E           L73D6   ld      a,(hl)
3691  788B E6 C0                and     #C0
3692  788D 47                   ld      b,a
3693  788E 1A                   ld      a,(de)
3694  788F 00           pr2     nop
3695  7890 E6 FC                and     #FC
3696  7892 0F                   rrca
3697  7893 0F                   rrca
3698  7894 B0                   or      b
3699  7895 77                   ld      (hl),a
3700  7896 24                   inc     h
3701  7897 13                   inc     de
3702  7898 DD 25                dec     xh
3703  789A 20 EE                jr      nz,L73D6
3704  789C 18 2B                jr      prsc
3705  789E 7E           L73E9   ld      a,(hl)
3706  789F 0F                   rrca
3707  78A0 0F                   rrca
3708  78A1 0F                   rrca
3709  78A2 0F                   rrca
3710  78A3 47                   ld      b,a
3711  78A4 23                   inc     hl
3712  78A5 7E                   ld      a,(hl)
3713  78A6 E6 3F                and     #3F
3714  78A8 4F                   ld      c,a
3715  78A9 1A                   ld      a,(de)
3716  78AA 00           pr3     nop
3717  78AB E6 FC                and     #FC
3718  78AD CB 27                sla     a
3719  78AF CB 10                rl      b
3720  78B1 CB 27                sla     a
3721  78B3 CB 10                rl      b
3722  78B5 CB 27                sla     a
3723  78B7 CB 10                rl      b
3724  78B9 CB 27                sla     a
3725  78BB CB 10                rl      b
3726  78BD B1                   or      c
3727  78BE 77                   ld      (hl),a
3728  78BF 2B                   dec     hl
3729  78C0 70                   ld      (hl),b
3730  78C1 24                   inc     h
3731  78C2 13                   inc     de
3732  78C3 DD 25                dec     xh
3733  78C5 20 D7                jr      nz,L73E9
3734  78C7 18 11                jr      prsc1
3735  78C9 2A F1 78     prsc    ld      hl,(posit)
3736  78CC 7C                   ld      a,h
3737  78CD E6 18                and     #18
3738  78CF 0F                   rrca
3739  78D0 0F                   rrca
3740  78D1 0F                   rrca
3741  78D2 C6 58                add     a,#58
3742  78D4 67                   ld      h,a
3743  78D5 3A 8F 5C             ld      a,(23695)
3744  78D8                      ;ld      (hl),a ;отключена раскраска
3745  78D8 18 10                jr      prse
3746  78DA 2A F1 78     prsc1   ld      hl,(posit)
3747  78DD 7C                   ld      a,h
3748  78DE E6 18                and     #18
3749  78E0 0F                   rrca
3750  78E1 0F                   rrca
3751  78E2 0F                   rrca
3752  78E3 C6 58                add     a,#58
3753  78E5 67                   ld      h,a
3754  78E6 3A 8F 5C             ld      a,(23695)
3755  78E9                      ;ld      (hl),a
3756  78E9 23                   inc     hl
3757  78EA                      ;ld      (hl),a
3758  78EA DD E1        prse    pop     ix
3759  78EC E1                   pop     hl
3760  78ED D1                   pop     de
3761  78EE C1                   pop     bc
3762  78EF F1                   pop     af
3763  78F0 C9                   ret
3764  78F1 00 00        posit   dw      0
3765  78F3 00           space   nop
3766  78F4 00           ytxt    nop
3767  78F5 00           xtxt    nop
3768  78F6
3769  78F6
3770  78F6              ;Приём пакета
3771  78F6              start_rcv
3772  78F6 D5           		push de
3773  78F7 21 2E 76     		ld hl,mes_wait
3774  78FA CD 82 77     		call print
3775  78FD D1           		pop de
3776  78FE 21 00 F6     		ld	hl,rec_buf ; куда принимать
3777  7901              		;ld	de,pack_size_1024_full ;размер
3778  7901              start_rcv1
3779  7901 CD AC 79     		call Uart.read
3780  7904 30 0F        		jr nc,start_rcv_ex
3781  7906 77           		ld (hl),a
3782  7907 23           		inc hl
3783  7908 1B           		dec de
3784  7909 7A           		ld a,d
3785  790A B3           		or e
3786  790B 20 F4        		jr nz,start_rcv1
3787  790D
3788  790D 21 38 76     		ld hl,mes_wait_off
3789  7910 CD 82 77     		call print
3790  7913 37           		scf ;флаг C=1, значит приём успешный
3791  7914 C9           		ret
3792  7915              start_rcv_ex
3793  7915 21 38 76     		ld hl,mes_wait_off
3794  7918 CD 82 77     		call print
3795  791B AF           		xor a ;C=0, если не успешно
3796  791C C9           		ret
3797  791D
3798  791D
3799  791D              ;Передача пакета
3800  791D              start_trn
3801  791D 21 2E 76     		ld hl,mes_wait
3802  7920 CD 82 77     		call print
3803  7923
3804  7923 21 B0 B3     		ld	hl,trn_buf ;откуда
3805  7926              		;ld	de,(pack_size)
3806  7926              start_trn1
3807  7926 7E           		ld a,(hl)
3808  7927 CD C5 79     		call Uart.write
3809  792A 23           		inc hl
3810  792B 1B           		dec de
3811  792C 7A           		ld a,d
3812  792D B3           		or e
3813  792E 20 F6        		jr nz,start_trn1
3814  7930
3815  7930 21 38 76     		ld hl,mes_wait_off
3816  7933 CD 82 77     		call print
3817  7936 C9           		ret
3818  7937
3819  7937              check_init_r ;при приёме
3820  7937 21 B3 B3     	ld hl,trn_buf+3
3821  793A              	;ld hl,trn_buf+pack_size_32_com
3822  793A 18 03        	jr check_init
3823  793C              check_init_t ;при передаче
3824  793C 21 B3 B3     	ld hl,trn_buf+3
3825  793F              	;ld hl,trn_buf+pack_size_1024_com+pack_size_32_com
3826  793F              check_init
3827  793F              	;проверка не пора ли сбросить устройство
3828  793F              	;если слишком часто передаётся один и тот же пакет
3829  793F              	;значит нужно снова инициализировать
3830  793F ED 5B 83 73  	ld de,(check_init_val)
3831  7943 7E           	ld a,(hl)
3832  7944 BB           	cp e
3833  7945 20 18        	jr nz,check_init1
3834  7947 23           	inc hl
3835  7948 7E           	ld a,(hl)
3836  7949 2B           	dec hl
3837  794A BA           	cp d
3838  794B 20 12        	jr nz,check_init1
3839  794D              	;если суммы совпадают
3840  794D 3A 85 73     	ld a,(check_init_count) ;счётчик попыток
3841  7950 3C           	inc a
3842  7951 32 85 73     	ld (check_init_count),a
3843  7954 FE 0A        	cp check_init_max ;сколько попыток максимум
3844  7956 D8           	ret c
3845  7957 AF           	xor a
3846  7958 32 85 73     	ld (check_init_count),a
3847  795B CD 96 71     	call init_dev ;пора сбросить
3848  795E C9           	ret
3849  795F              check_init1 ;не равны
3850  795F 5E           	ld e,(hl) ;запомнить новое значение
3851  7960 23           	inc hl
3852  7961 56           	ld d,(hl)
3853  7962 ED 53 83 73  	ld (check_init_val),de
3854  7966 AF           	xor a ;сбросить счётчик
3855  7967 32 85 73     	ld (check_init_count),a
3856  796A C9           	ret
3857  796B
3858  796B              ;здесь драйвер устройства
3859  796B              		include "drivers/zx-wifi.asm"
# file opened: drivers/zx-wifi.asm
   1+ 796B              ; This driver works with 16c550 uart that's support AFE
   2+ 796B                  module Uart
   3+ 796B              ; Make init shorter and readable:-)
   4+ 796B                  macro outp port, value
   5+ 796B ~            	ld b, port
   6+ 796B ~            	ld c, #EF
   7+ 796B ~                ld a, value
   8+ 796B ~                out (c), a
   9+ 796B                  endm
  10+ 796B
  11+ 796B              ; Internal port constants
  12+ 796B              RBR_THR = #F8
  13+ 796B              IER     = RBR_THR + 1
  14+ 796B              IIR_FCR = RBR_THR + 2
  15+ 796B              LCR     = RBR_THR + 3
  16+ 796B              MCR     = RBR_THR + 4
  17+ 796B              LSR     = RBR_THR + 5
  18+ 796B              MSR     = RBR_THR + 6
  19+ 796B              SR      = RBR_THR + 7
  20+ 796B
  21+ 796B              init:
  22+ 796B                  outp MCR,     #0d  // Assert RTS
  22+ 796B 06 FC       >	ld b, MCR
  22+ 796D 0E EF       >	ld c, #EF
  22+ 796F 3E 0D       >    ld a, #0d
  22+ 7971 ED 79       >    out (c), a
  23+ 7973                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  23+ 7973 06 FA       >	ld b, IIR_FCR
  23+ 7975 0E EF       >	ld c, #EF
  23+ 7977 3E 87       >    ld a, #87
  23+ 7979 ED 79       >    out (c), a
  24+ 797B                  outp LCR,     #83  // 8n1, DLAB=1
  24+ 797B 06 FB       >	ld b, LCR
  24+ 797D 0E EF       >	ld c, #EF
  24+ 797F 3E 83       >    ld a, #83
  24+ 7981 ED 79       >    out (c), a
  25+ 7983                  outp RBR_THR, #01  // 115200 (divider 1)
  25+ 7983 06 F8       >	ld b, RBR_THR
  25+ 7985 0E EF       >	ld c, #EF
  25+ 7987 3E 01       >    ld a, #01
  25+ 7989 ED 79       >    out (c), a
  26+ 798B                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  26+ 798B 06 F9       >	ld b, IER
  26+ 798D 0E EF       >	ld c, #EF
  26+ 798F 3E 00       >    ld a, #00
  26+ 7991 ED 79       >    out (c), a
  27+ 7993
  28+ 7993                  outp LCR,     #03 // 8n1, DLAB=0
  28+ 7993 06 FB       >	ld b, LCR
  28+ 7995 0E EF       >	ld c, #EF
  28+ 7997 3E 03       >    ld a, #03
  28+ 7999 ED 79       >    out (c), a
  29+ 799B                  outp IER,     #00 // Disable int
  29+ 799B 06 F9       >	ld b, IER
  29+ 799D 0E EF       >	ld c, #EF
  29+ 799F 3E 00       >    ld a, #00
  29+ 79A1 ED 79       >    out (c), a
  30+ 79A3                  outp MCR,     #2f // Enable AFE
  30+ 79A3 06 FC       >	ld b, MCR
  30+ 79A5 0E EF       >	ld c, #EF
  30+ 79A7 3E 2F       >    ld a, #2f
  30+ 79A9 ED 79       >    out (c), a
  31+ 79AB C9               ret
  32+ 79AC
  33+ 79AC              retry_rec_count_max equ 20 ;ждать данных максимум столько прерываний
  34+ 79AC
  35+ 79AC              ; Flag C <- Data available
  36+ 79AC              ; isAvailable:
  37+ 79AC                  ; ld a, LSR
  38+ 79AC                  ; in a, (#EF)
  39+ 79AC                  ; rrca
  40+ 79AC                  ; ret
  41+ 79AC
  42+ 79AC              ; Non-blocking read
  43+ 79AC              ; Flag C <- is byte was readen
  44+ 79AC              ; A <- byte
  45+ 79AC              ; read1:
  46+ 79AC                  ; ld a, LSR
  47+ 79AC                  ; in a, (#EF)
  48+ 79AC                  ; rrca
  49+ 79AC                  ; ret nc
  50+ 79AC                  ; ld a, RBR_THR
  51+ 79AC                  ; in a, (#EF)
  52+ 79AC                  ; scf
  53+ 79AC                  ; ret
  54+ 79AC
  55+ 79AC              ; Tries read byte with timeout
  56+ 79AC              ; Flag C <- is byte read
  57+ 79AC              ; A <- byte
  58+ 79AC              read:
  59+ 79AC AF           	xor a ;4
  60+ 79AD 32 78 5C     	ld (#5C78),a ;обнулить счётчик ожидания ;13
  61+ 79B0              .wait
  62+ 79B0 3E FD            ld a, LSR
  63+ 79B2 DB EF            in a, (#EF)
  64+ 79B4 0F               rrca
  65+ 79B5 30 05        	jr nc, .readW
  66+ 79B7 3E F8            ld a, RBR_THR
  67+ 79B9 DB EF            in a, (#EF)
  68+ 79BB C9           	ret
  69+ 79BC              .readW
  70+ 79BC 3A 78 5C     	ld a,(#5C78)
  71+ 79BF FE 14        	cp retry_rec_count_max
  72+ 79C1 38 ED        	jr c, .wait ;ещё попытка
  73+ 79C3 AF           	xor a ;выключим флаг переноса если время вышло
  74+ 79C4 C9           	ret
  75+ 79C5
  76+ 79C5
  77+ 79C5
  78+ 79C5
  79+ 79C5              ; Blocking read
  80+ 79C5              ; A <- Byte
  81+ 79C5              ; readB:
  82+ 79C5                  ; ld a, LSR
  83+ 79C5                  ; in a, (#EF)
  84+ 79C5                  ; rrca
  85+ 79C5                  ; jr nc, readB
  86+ 79C5              	; ld a, RBR_THR
  87+ 79C5                  ; in a, (#EF)
  88+ 79C5                  ; ret
  89+ 79C5
  90+ 79C5              ; A -> byte to send
  91+ 79C5              write:
  92+ 79C5 F5               push af
  93+ 79C6              .wait
  94+ 79C6 3E FD        	ld a, LSR
  95+ 79C8 DB EF            in a, (#EF)
  96+ 79CA E6 20            and #20
  97+ 79CC 28 F8            jr z, .wait
  98+ 79CE F1               pop af
  99+ 79CF 06 F8        	ld b, RBR_THR
 100+ 79D1 0E EF        	ld c, #EF
 101+ 79D3 ED 79            out (c), a
 102+ 79D5 C9               ret
 103+ 79D6
 104+ 79D6                  endmodule
# file closed: drivers/zx-wifi.asm
3860  79D6              		include "drivers/wifi.asm"
# file opened: drivers/wifi.asm
   1+ 79D6                  MODULE Wifi
   2+ 79D6 00 00        bytes_avail dw 0 ;байт для приёма
   3+ 79D8 00 00        buffer_pointer dw 0 ;указатель на адрес буфера
   4+ 79DA 01           closed db 1 ;флаг "соединение закрыто"
   5+ 79DB              ; ;link_id db 0 ;текущий id соединения
   6+ 79DB              buffer_end equ #ff ;ограничение буфера адрес #ff00
   7+ 79DB
   8+ 79DB              ; ; Initialize Wifi chip to work
   9+ 79DB              ; init:
  10+ 79DB                  ; ld hl, .uartIniting : call drvgmx.printZ
  11+ 79DB                  ; call Uart.init ;
  12+ 79DB                  ; ld hl, .chipIniting : call drvgmx.printZ
  13+ 79DB                  ; ;EspCmdOkErr "ATE0"
  14+ 79DB              	; ld hl,cmd_ATE0
  15+ 79DB              	; call espSendZ
  16+ 79DB              	; call checkOkErr
  17+ 79DB                  ; jr c, .initError
  18+ 79DB
  19+ 79DB                  ; ;EspCmdOkErr "AT+CIPSERVER=0"
  20+ 79DB              	; ld hl,cmd_CIPSERVER
  21+ 79DB              	; call espSendZ
  22+ 79DB              	; call checkOkErr
  23+ 79DB                  ; ;jr c, .initError ;не проверяем ошибку
  24+ 79DB                  ; ;EspCmdOkErr "AT+CIPCLOSE" ;  Close if there some connection was. Don't care about result
  25+ 79DB              	; ld hl,cmd_CIPCLOSE
  26+ 79DB              	; call espSendZ
  27+ 79DB              	; ld a,'5' ;закрыть все соединения
  28+ 79DB              	; call Uart.write
  29+ 79DB                  ; ld a, 13 : call Uart.write
  30+ 79DB                  ; ld a, 10 : call Uart.write
  31+ 79DB              	; call checkOkErr
  32+ 79DB                  ; ;jr c, .initError ;не проверяем ошибку
  33+ 79DB                  ; ;EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  34+ 79DB              	; ld hl,cmd_CIPMUX
  35+ 79DB              	; call espSendZ
  36+ 79DB              	; call checkOkErr
  37+ 79DB                  ; jr c, .initError
  38+ 79DB
  39+ 79DB                  ; ;EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  40+ 79DB              	; ld hl,cmd_CIPDINFO
  41+ 79DB              	; call espSendZ
  42+ 79DB              	; call checkOkErr
  43+ 79DB                  ; jr c, .initError
  44+ 79DB
  45+ 79DB                  ; ld hl, .doneInit : call drvgmx.printZ
  46+ 79DB
  47+ 79DB                  ; or a
  48+ 79DB                  ; ret
  49+ 79DB              ; .initError
  50+ 79DB                  ; ld hl, .errMsg : call drvgmx.printZ
  51+ 79DB                  ; scf
  52+ 79DB                  ; ret
  53+ 79DB              ; .errMsg db "WiFi chip init failed!",13,0
  54+ 79DB              ; .uartIniting db "Uart initing...",13,0
  55+ 79DB              ; .chipIniting db "Chip initing...",13,0
  56+ 79DB              ; .doneInit    db "Done!",13,0
  57+ 79DB                  ; IFNDEF PROXY
  58+ 79DB              ; ; HL - host pointer in gopher row
  59+ 79DB              ; ; DE - port pointer in gopher row
  60+ 79DB              ; openTCP:
  61+ 79DB                  ; push de
  62+ 79DB                  ; push hl
  63+ 79DB                  ; ;EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  64+ 79DB              	; ld hl,cmd_CIPCLOSE
  65+ 79DB              	; call espSendZ
  66+ 79DB              	; ; ld a,(link_id)
  67+ 79DB              	; ; call Uart.write
  68+ 79DB                  ; ld a, 13 : call Uart.write
  69+ 79DB                  ; ld a, 10 : call Uart.write
  70+ 79DB              	; call checkOkErr
  71+ 79DB
  72+ 79DB                  ; ;EspSend 'AT+CIPSTART,"TCP","' ;
  73+ 79DB              	; ld hl,cmd_CIPSTART
  74+ 79DB              	; call espSendZ
  75+ 79DB              	; ; ld a,(link_id)
  76+ 79DB              	; ; call Uart.write
  77+ 79DB              	; ; ld hl,cmd_CIPSTART2
  78+ 79DB              	; ; call espSendZ
  79+ 79DB
  80+ 79DB
  81+ 79DB                  ; pop hl
  82+ 79DB                  ; call espSendT
  83+ 79DB                  ; ;EspSend '",'
  84+ 79DB                  ; ld a, '"' : call Uart.write
  85+ 79DB                  ; ld a, ',' : call Uart.write
  86+ 79DB                  ; pop hl
  87+ 79DB                  ; call espSendT
  88+ 79DB                  ; ld a, 13 : call Uart.write
  89+ 79DB                  ; ld a, 10 : call Uart.write
  90+ 79DB                  ; xor a : ld (closed), a
  91+ 79DB                  ; jp checkOkErr
  92+ 79DB
  93+ 79DB              ; continue:
  94+ 79DB                  ; ret
  95+ 79DB                  ; ENDIF
  96+ 79DB
  97+ 79DB
  98+ 79DB
  99+ 79DB              checkOkErr:
 100+ 79DB CD AC 79         call Uart.read
 101+ 79DE FE 4F            cp 'O'
 101+ 79E0 28 0A          jr z, .okStart ; OK
 102+ 79E2 FE 45            cp 'E'
 102+ 79E4 28 19          jr z, .errStart ; ERROR
 103+ 79E6 FE 46            cp 'F'
 103+ 79E8 28 36          jr z, .failStart ; FAIL
 104+ 79EA 18 EF            jr checkOkErr
 105+ 79EC              .okStart
 106+ 79EC CD AC 79         call Uart.read
 106+ 79EF FE 4B          cp 'K'
 106+ 79F1 20 E8          jr nz, checkOkErr
 107+ 79F3 CD AC 79         call Uart.read
 107+ 79F6 FE 0D          cp 13
 107+ 79F8 20 E1          jr nz, checkOkErr
 108+ 79FA CD 3A 7A         call .flushToLF
 109+ 79FD B7               or a
 110+ 79FE C9               ret
 111+ 79FF              .errStart
 112+ 79FF CD AC 79         call Uart.read
 112+ 7A02 FE 52          cp 'R'
 112+ 7A04 20 D5          jr nz, checkOkErr
 113+ 7A06 CD AC 79         call Uart.read
 113+ 7A09 FE 52          cp 'R'
 113+ 7A0B 20 CE          jr nz, checkOkErr
 114+ 7A0D CD AC 79         call Uart.read
 114+ 7A10 FE 4F          cp 'O'
 114+ 7A12 20 C7          jr nz, checkOkErr
 115+ 7A14 CD AC 79         call Uart.read
 115+ 7A17 FE 52          cp 'R'
 115+ 7A19 20 C0          jr nz, checkOkErr
 116+ 7A1B CD 3A 7A         call .flushToLF
 117+ 7A1E 37               scf
 118+ 7A1F C9               ret
 119+ 7A20              .failStart
 120+ 7A20 CD AC 79         call Uart.read
 120+ 7A23 FE 41          cp 'A'
 120+ 7A25 20 B4          jr nz, checkOkErr
 121+ 7A27 CD AC 79         call Uart.read
 121+ 7A2A FE 49          cp 'I'
 121+ 7A2C 20 AD          jr nz, checkOkErr
 122+ 7A2E CD AC 79         call Uart.read
 122+ 7A31 FE 4C          cp 'L'
 122+ 7A33 20 A6          jr nz, checkOkErr
 123+ 7A35 CD 3A 7A         call .flushToLF
 124+ 7A38 37               scf
 125+ 7A39 C9               ret
 126+ 7A3A              .flushToLF
 127+ 7A3A CD AC 79         call Uart.read
 128+ 7A3D FE 0A            cp 10
 128+ 7A3F 20 F9          jr nz, .flushToLF
 129+ 7A41 C9               ret
 130+ 7A42
 131+ 7A42              ; Send buffer to UART
 132+ 7A42              ; HL - buff
 133+ 7A42              ; E - count
 134+ 7A42              ; espSend:
 135+ 7A42                  ; ld a, (hl) : call Uart.write
 136+ 7A42                  ; inc hl
 137+ 7A42                  ; dec e
 138+ 7A42                  ; jr nz, espSend
 139+ 7A42                  ; ret
 140+ 7A42
 141+ 7A42              ; Send buffer to UART
 142+ 7A42              ; HL - buff (0 - end!)
 143+ 7A42              espSendZ:
 144+ 7A42 7E               ld a, (hl)
 145+ 7A43 B7           	or a
 146+ 7A44 C8           	ret z
 147+ 7A45 CD C5 79     	call Uart.write
 148+ 7A48 23               inc hl
 149+ 7A49 18 F7            jr espSendZ
 150+ 7A4B
 151+ 7A4B
 152+ 7A4B              ; ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 153+ 7A4B              ; espSendT:
 154+ 7A4B                  ; ld a, (hl)
 155+ 7A4B
 156+ 7A4B                  ; and a : ret z
 157+ 7A4B                  ; cp 9 : ret z
 158+ 7A4B                  ; cp 13 : ret z
 159+ 7A4B                  ; cp 10 : ret z
 160+ 7A4B
 161+ 7A4B                  ; call Uart.write
 162+ 7A4B                  ; inc hl
 163+ 7A4B                  ; jr espSendT
 164+ 7A4B
 165+ 7A4B              ; HL - stringZ to send
 166+ 7A4B              ; Adds CR LF
 167+ 7A4B              ; tcpSendZ:
 168+ 7A4B                  ; push hl
 169+ 7A4B                  ; ;EspSend "AT+CIPSEND=" ;
 170+ 7A4B              	; ld hl,cmd_CIPSEND
 171+ 7A4B              	; call espSendZ
 172+ 7A4B              	; ; ld a,(link_id)
 173+ 7A4B              	; ; call Uart.write
 174+ 7A4B                  ; ;ld a, ',' : call Uart.write
 175+ 7A4B
 176+ 7A4B                  ; pop de : push de
 177+ 7A4B                  ; call strLen
 178+ 7A4B                  ; inc hl : inc hl ; +CRLF
 179+ 7A4B                  ; call hlToNumEsp
 180+ 7A4B                  ; ld a, 13 : call Uart.write
 181+ 7A4B                  ; ld a, 10 : call Uart.write
 182+ 7A4B                  ; call checkOkErr : jr c,.exit_err
 183+ 7A4B              ; .wait
 184+ 7A4B                  ; call Uart.read : cp '>' : jr nz, .wait
 185+ 7A4B                  ; pop hl
 186+ 7A4B              ; .loop
 187+ 7A4B                  ; ld a, (hl) : and a : jr z, .exit
 188+ 7A4B                  ; call Uart.write
 189+ 7A4B                  ; inc hl
 190+ 7A4B                  ; jp .loop
 191+ 7A4B              ; .exit
 192+ 7A4B                  ; ld a, 13 : call Uart.write
 193+ 7A4B                  ; ld a, 10 : call Uart.write
 194+ 7A4B                  ; jp checkOkErr
 195+ 7A4B              ; .exit_err
 196+ 7A4B              	; pop hl
 197+ 7A4B              	; ret
 198+ 7A4B
 199+ 7A4B
 200+ 7A4B
 201+ 7A4B              ; HL - string to send
 202+ 7A4B              ; DE - lenght
 203+ 7A4B              ; Adds CR LF
 204+ 7A4B              tcpSend:
 205+ 7A4B E5               push hl
 206+ 7A4C D5           	push de ;
 207+ 7A4D                  ;EspSend "AT+CIPSEND=" ;
 208+ 7A4D 21 41 7B     	ld hl,cmd_CIPSEND
 209+ 7A50 CD 42 7A     	call espSendZ
 210+ 7A53              	; ld a,(link_id)
 211+ 7A53              	; call Uart.write
 212+ 7A53                  ;ld a, ',' : call Uart.write
 213+ 7A53
 214+ 7A53 E1               pop hl
 214+ 7A54 E5             push hl ;длина
 215+ 7A55                  ;call strLen
 216+ 7A55 23               inc hl
 216+ 7A56 23             inc hl ; +CRLF
 217+ 7A57 CD 1A 7B         call hlToNumEsp
 218+ 7A5A 3E 0D            ld a, 13
 218+ 7A5C CD C5 79       call Uart.write
 219+ 7A5F 3E 0A            ld a, 10
 219+ 7A61 CD C5 79       call Uart.write
 220+ 7A64 CD DB 79         call checkOkErr
 220+ 7A67 38 21          jr c,.exit_err2
 221+ 7A69              .wait2
 222+ 7A69 CD AC 79         call Uart.read
 222+ 7A6C FE 3E          cp '>'
 222+ 7A6E 20 F9          jr nz, .wait2
 223+ 7A70 D1           	pop de ;длина
 224+ 7A71 E1               pop hl
 225+ 7A72              .loop2
 226+ 7A72 7E               ld a, (hl)
 227+ 7A73 CD C5 79         call Uart.write
 228+ 7A76 23               inc hl
 229+ 7A77 1B           	dec de
 230+ 7A78 7A           	ld a,d
 231+ 7A79 B3           	or e
 232+ 7A7A C2 72 7A         jp nz, .loop2
 233+ 7A7D              .exit2
 234+ 7A7D 3E 0D            ld a, 13
 234+ 7A7F CD C5 79       call Uart.write
 235+ 7A82 3E 0A            ld a, 10
 235+ 7A84 CD C5 79       call Uart.write
 236+ 7A87 C3 DB 79         jp checkOkErr
 237+ 7A8A              .exit_err2
 238+ 7A8A D1           	pop de
 239+ 7A8B E1           	pop hl
 240+ 7A8C C9           	ret
 241+ 7A8D
 242+ 7A8D
 243+ 7A8D
 244+ 7A8D
 245+ 7A8D              getPacket:
 246+ 7A8D CD AC 79         call Uart.read
 247+ 7A90 FE 2B            cp '+'
 247+ 7A92 28 28          jr z, .ipdBegun    ; "+IPD," packet
 248+ 7A94 FE 4F            cp 'O'
 248+ 7A96 28 02          jr z, .closedBegun ; It enough to check "OSED\n" :-)
 249+ 7A98 18 F3            jr getPacket
 250+ 7A9A              .closedBegun
 251+ 7A9A CD AC 79         call Uart.read
 251+ 7A9D FE 53          cp 'S'
 251+ 7A9F 20 EC          jr nz, getPacket
 252+ 7AA1 CD AC 79         call Uart.read
 252+ 7AA4 FE 45          cp 'E'
 252+ 7AA6 20 E5          jr nz, getPacket
 253+ 7AA8 CD AC 79         call Uart.read
 253+ 7AAB FE 44          cp 'D'
 253+ 7AAD 20 DE          jr nz, getPacket
 254+ 7AAF CD AC 79         call Uart.read
 254+ 7AB2 FE 0D          cp 13
 254+ 7AB4 20 D7          jr nz, getPacket
 255+ 7AB6 3E 01 32 DA      ld a, 1, (closed), a
 255+ 7ABA 79
 256+ 7ABB C9               ret
 257+ 7ABC              .ipdBegun
 258+ 7ABC CD AC 79         call Uart.read
 258+ 7ABF FE 49          cp 'I'
 258+ 7AC1 20 CA          jr nz, getPacket
 259+ 7AC3 CD AC 79         call Uart.read
 259+ 7AC6 FE 50          cp 'P'
 259+ 7AC8 20 C3          jr nz, getPacket
 260+ 7ACA CD AC 79         call Uart.read
 260+ 7ACD FE 44          cp 'D'
 260+ 7ACF 20 BC          jr nz, getPacket
 261+ 7AD1 CD AC 79         call Uart.read ; Comma
 262+ 7AD4              	; call Uart.read ; link ID
 263+ 7AD4              	; ld (link_id),a ;запомнить
 264+ 7AD4              	;call Uart.read ; Comma
 265+ 7AD4 CD 01 7B         call .count_ipd_lenght
 265+ 7AD7 22 D6 79       ld (bytes_avail), hl
 266+ 7ADA 44 4D            ld bc, hl
 267+ 7ADC 2A D8 79         ld hl, (buffer_pointer)
 268+ 7ADF              .readp
 269+ 7ADF 7C               ld a, h
 269+ 7AE0 FE FF          cp buffer_end
 269+ 7AE2 30 12          jr nc, .skipbuff ;
 270+ 7AE4 C5 E5            push bc, hl
 271+ 7AE6 CD AC 79         call Uart.read
 272+ 7AE9 E1 C1            pop hl, bc
 273+ 7AEB 77               ld (hl), a
 274+ 7AEC 0B               dec bc
 274+ 7AED 23             inc hl
 275+ 7AEE 78               ld a, b
 275+ 7AEF B1             or c
 275+ 7AF0 20 ED          jr nz, .readp
 276+ 7AF2 22 D8 79         ld (buffer_pointer), hl
 277+ 7AF5 C9               ret
 278+ 7AF6              .skipbuff
 279+ 7AF6 C5               push bc
 280+ 7AF7 CD AC 79         call Uart.read
 281+ 7AFA C1               pop bc
 282+ 7AFB 0B               dec bc
 282+ 7AFC 78             ld a, b
 282+ 7AFD B1             or c
 282+ 7AFE 20 F6          jr nz, .skipbuff
 283+ 7B00 C9               ret
 284+ 7B01              .count_ipd_lenght
 285+ 7B01 21 00 00     		ld hl,0			; count lenght
 286+ 7B04 E5           .cil1	push  hl
 287+ 7B05 CD AC 79             call Uart.read
 288+ 7B08 E1                   pop hl
 289+ 7B09 FE 3A        		cp ':'
 289+ 7B0B C8             ret z
 290+ 7B0C D6 30        		sub 0x30
 290+ 7B0E 4D             ld c,l
 290+ 7B0F 44             ld b,h
 290+ 7B10 29             add hl,hl
 290+ 7B11 29             add hl,hl
 290+ 7B12 09             add hl,bc
 290+ 7B13 29             add hl,hl
 290+ 7B14 4F             ld c,a
 290+ 7B15 06 00          ld b,0
 290+ 7B17 09             add hl,bc
 291+ 7B18 18 EA        		jr .cil1
 292+ 7B1A
 293+ 7B1A              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 294+ 7B1A              ; HL - number
 295+ 7B1A              ; It will be written to UART
 296+ 7B1A              hlToNumEsp:
 297+ 7B1A 01 F0 D8     	ld	bc,-10000
 298+ 7B1D CD 33 7B     	call	.n1
 299+ 7B20 01 18 FC     	ld	bc,-1000
 300+ 7B23 CD 33 7B     	call	.n1
 301+ 7B26 01 9C FF     	ld	bc,-100
 302+ 7B29 CD 33 7B     	call	.n1
 303+ 7B2C 0E F6        	ld	c,-10
 304+ 7B2E CD 33 7B     	call	.n1
 305+ 7B31 0E FF        	ld	c,-1
 306+ 7B33 3E 2F        .n1	ld	a,'0'-1
 307+ 7B35 3C           .n2	inc	a
 308+ 7B36 09           	add	hl,bc
 309+ 7B37 38 FC        	jr	c, .n2
 310+ 7B39 ED 42        	sbc	hl,bc
 311+ 7B3B C5               push bc
 312+ 7B3C CD C5 79     	call Uart.write
 313+ 7B3F C1               pop bc
 314+ 7B40 C9               ret
 315+ 7B41
 316+ 7B41
 317+ 7B41              ; ;команды
 318+ 7B41              ; cmd_ATE0 db "ATE0",13,10,0 ;эхо?
 319+ 7B41              ; cmd_CIPSERVER db "AT+CIPSERVER=0",13,10,0 ;удалить сервер
 320+ 7B41              ; cmd_CIPSTART db 'AT+CIPSTART="' ;продолжение
 321+ 7B41              	; ;тут тип
 322+ 7B41              ; cmd_CIPSTART2 db 'TCP","',0 ;продолжение
 323+ 7B41 41 54 2B 43  cmd_CIPSEND db "AT+CIPSEND=",0 ;отправить данные
 323+ 7B45 49 50 53 45
 323+ 7B49 4E 44 3D 00
 324+ 7B4D              	; ;тут ID
 325+ 7B4D              ; cmd_CIPCLOSE db "AT+CIPCLOSE",0 ;закрыть соединение
 326+ 7B4D              	; ;тут ID
 327+ 7B4D              ; cmd_CIPMUX db "AT+CIPMUX=0",13,10,0 ; Single connection mode
 328+ 7B4D              ; cmd_CIPDINFO db "AT+CIPDINFO=0",13,10,0 ; Disable additional info
 329+ 7B4D
 330+ 7B4D                  ENDMODULE
# file closed: drivers/wifi.asm
3861  7B4D              		include "at_command.asm"
# file opened: at_command.asm
   1+ 7B4D              ; cmd_uart
   2+ 7B4D              	; db "AT+UART_DEF=115200,8,1,0,3",13,10
   3+ 7B4D              ; cmd_uart_end
   4+ 7B4D
   5+ 7B4D              ; cmd_cwmode
   6+ 7B4D              	; db "AT+CWMODE=1",13,10
   7+ 7B4D              ; cmd_cwmode_end
   8+ 7B4D
   9+ 7B4D              ; cmd_cwjap
  10+ 7B4D              	; db "AT+CWJAP_DEF=\"\",\"\"",13,10
  11+ 7B4D              ; cmd_cwjap_end
  12+ 7B4D
  13+ 7B4D              ; cmd_savetrans_1
  14+ 7B4D              	; db "AT+SAVETRANSLINK=1,\"PC5\",8888,\"UDP\"",13,10
  15+ 7B4D              ; cmd_savetrans_1_end
  16+ 7B4D
  17+ 7B4D              ; cmd_savetrans_0
  18+ 7B4D              	; db "AT+SAVETRANSLINK=0",13,10
  19+ 7B4D              ; cmd_savetrans_0_end
  20+ 7B4D
  21+ 7B4D              cmd_rst
  22+ 7B4D 41 54 2B 52  	db "AT+RST",13,10
  22+ 7B51 53 54 0D 0A
  23+ 7B55              cmd_rst_end
  24+ 7B55
  25+ 7B55              cmd_brk
  26+ 7B55 2B 2B 2B     	db "+++"
  27+ 7B58              cmd_brk_end
  28+ 7B58
  29+ 7B58 41 54 2B 43  cmd_ipstart db 'AT+CIPSTART="UDP","' ;    
  29+ 7B5C 49 50 53 54
  29+ 7B60 41 52 54 3D
  29+ 7B64 22 55 44 50
  29+ 7B68 22 2C 22
  30+ 7B6B              cmd_ipstart_e
  31+ 7B6B
  32+ 7B6B
  33+ 7B6B 41 54 2B 43  cmd_ipclose db "AT+CIPCLOSE",13,10
  33+ 7B6F 49 50 43 4C
  33+ 7B73 4F 53 45 0D
  33+ 7B77 0A
  34+ 7B78              cmd_ipclose_e
  35+ 7B78
  36+ 7B78 41 54 2B 43  cmd_ipsend_34 db "AT+CIPSEND=34",13,10
  36+ 7B7C 49 50 53 45
  36+ 7B80 4E 44 3D 33
  36+ 7B84 34 0D 0A
  37+ 7B87              cmd_ipsend_34_e
  38+ 7B87
  39+ 7B87 41 54 2B 43  cmd_ipsend_1058 db "AT+CIPSEND=1058",13,10
  39+ 7B8B 49 50 53 45
  39+ 7B8F 4E 44 3D 31
  39+ 7B93 30 35 38 0D
  39+ 7B97 0A
  40+ 7B98              cmd_ipsend_1058_e
  41+ 7B98
  42+ 7B98 41 54 2B 43  cmd_ipsend_290 db "AT+CIPSEND=290",13,10
  42+ 7B9C 49 50 53 45
  42+ 7BA0 4E 44 3D 32
  42+ 7BA4 39 30 0D 0A
  43+ 7BA8              cmd_ipsend_290_e
  44+ 7BA8
  45+ 7BA8 2B 49 50 44  pack_id db "+IPD," ;   
  45+ 7BAC 2C
  46+ 7BAD              pack_id_e
  47+ 7BAD
  48+ 7BAD              ; -
  49+ 7BAD              			; ld hl,trn_buf ;
  50+ 7BAD              			; ld de,pack_size_32_com ;
  51+ 7BAD              			; call Wifi.tcpSend ;
  52+ 7BAD              			; jr c, ; ,   
  53+ 7BAD
  54+ 7BAD              			; ld hl,rec_buf ;
  55+ 7BAD              			; ld (Wifi.buffer_pointer),hl
  56+ 7BAD              			; call Wifi.getPacket ;
  57+ 7BAD              			; jr c, ; ,   
  58+ 7BAD
# file closed: at_command.asm
3862  7BAD
3863  7BAD
3864  7BAD
3865  7BAD              	; ;org #6450 ;обработчик прерывания
3866  7BAD              ; interrupt
3867  7BAD              	; ; push af
3868  7BAD              	; ; push bc
3869  7BAD              	; ; push de
3870  7BAD              	; push hl
3871  7BAD              	; ; exx
3872  7BAD              	; ; ex af,af'
3873  7BAD              	; ; push af
3874  7BAD              	; ; push bc
3875  7BAD              	; ; push de
3876  7BAD              	; ; push hl
3877  7BAD              	; ; push ix
3878  7BAD              	; ; push iy
3879  7BAD              	; ; call #6500
3880  7BAD              	; ld hl,frame
3881  7BAD              	; inc (hl)
3882  7BAD              	; ; pop iy
3883  7BAD              	; ; pop ix
3884  7BAD              	; ; pop hl
3885  7BAD              	; ; pop de
3886  7BAD              	; ; pop bc
3887  7BAD              	; ; pop af
3888  7BAD              	; ; ex af,af'
3889  7BAD              	; ; exx
3890  7BAD              	; pop hl
3891  7BAD              	; ; pop de
3892  7BAD              	; ; pop bc
3893  7BAD              	; ; pop af
3894  7BAD              	; rst #38 ;вместо прерывания im 1
3895  7BAD              	; ei
3896  7BAD              	; ret
3897  7BAD              ; frame dw 0
3898  7BAD              		; align 256
3899  7BAD              ; interrupt_vec equ $-1 ;указатель на обработчик прерываний
3900  7BAD              	; dw 0
3901  7BAD
3902  7BAD
3903  7BAD              read_cfg ;прочитать файл конфигурации
3904  7BAD 21 D8 76     	ld hl,file_cfg_name
3905  7BB0 0E 13        	ld      c,#13 ;move file info to syst var
3906  7BB2 CD 13 3D         call    #3d13
3907  7BB5 79           	ld      a,c
3908  7BB6 FE FF        	cp 		#ff
3909  7BB8 28 71        	jr 		z,read_cfg_err
3910  7BBA 0E 0A            ld      c,#0a ;find file
3911  7BBC CD 13 3D         call    #3d13
3912  7BBF 79               ld      a,c
3913  7BC0 FE FF        	cp 		#ff
3914  7BC2 28 67        	jr 		z,read_cfg_err ;если не нашли файла
3915  7BC4 0E 08            ld      c,#08 ;read file title
3916  7BC6 CD 13 3D         call    #3d13
3917  7BC9 79           	ld      a,c
3918  7BCA FE FF        	cp 		#ff
3919  7BCC 28 5D        	jr 		z,read_cfg_err
3920  7BCE 21 E2 BC         ld      hl,file_cfg_name_buf ;куда
3921  7BD1 ED 5B EB 5C      ld      de,(#5ceb) ;начало файла сектор дорожка
3922  7BD5 01 05 01         ld      bc,#0105 ;считать один сектор
3923  7BD8 CD 13 3D         call    #3d13
3924  7BDB 79           	ld      a,c
3925  7BDC FE FF        	cp 		#ff
3926  7BDE 28 4B        	jr 		z,read_cfg_err
3927  7BE0
3928  7BE0              	;распознать файл настроек
3929  7BE0 21 E2 BC     	ld  hl,file_cfg_name_buf ;откуда
3930  7BE3 11 ED 76     	ld 	de,server_name ;куда
3931  7BE6 01 FF 0F     	ld bc,#0fff ;максимум имя сервера 15 символов
3932  7BE9              read_cfg_cl
3933  7BE9 7E           	ld a,(hl)
3934  7BEA FE 20        	cp " "
3935  7BEC 38 04        	jr c,read_cfg_cl_skip
3936  7BEE              	;тут нашли имя сервера
3937  7BEE ED A0        	ldi
3938  7BF0 10 F7        	djnz read_cfg_cl
3939  7BF2
3940  7BF2
3941  7BF2              read_cfg_cl_skip
3942  7BF2              	;пропустить конец строки
3943  7BF2 01 FF 0F     	ld bc,#0fff ;максимум имя сервера15 символов
3944  7BF5              read_cfg_cl1
3945  7BF5 7E           	ld a,(hl)
3946  7BF6 FE 20        	cp " "
3947  7BF8 30 03        	jr nc,read_cfg_cl_skip2
3948  7BFA              	;тут нашли имя сервера
3949  7BFA 23           	inc hl
3950  7BFB 10 F8        	djnz read_cfg_cl1
3951  7BFD
3952  7BFD              read_cfg_cl_skip2
3953  7BFD              	;порт
3954  7BFD 11 06 77     	ld 	de,server_port ;куда
3955  7C00 01 FF 04     	ld bc,#04ff ;максимум длина порта 4
3956  7C03              	;ld ixl,0 ;счётчик
3957  7C03              read_cfg_cl2
3958  7C03 7E           	ld a,(hl)
3959  7C04 FE 20        	cp " "
3960  7C06 38 04        	jr c,read_cfg_cl_skip3
3961  7C08 ED A0        	ldi
3962  7C0A 10 F7        	djnz read_cfg_cl2
3963  7C0C
3964  7C0C              read_cfg_cl_skip3
3965  7C0C              	;настройки определения HDD
3966  7C0C              ;пропустить конец строки
3967  7C0C 01 FF 05     	ld bc,#05ff ;максимум 5
3968  7C0F              read_cfg_cl3
3969  7C0F 7E           	ld a,(hl)
3970  7C10 FE 20        	cp " "
3971  7C12 30 03        	jr nc,read_cfg_cl_skip4
3972  7C14              	;тут нашли имя сервера
3973  7C14 23           	inc hl
3974  7C15 10 F8        	djnz read_cfg_cl3
3975  7C17
3976  7C17              read_cfg_cl_skip4
3977  7C17 01 FF 08     	ld bc,#08ff ;максимум 8
3978  7C1A 1E 00        	ld e,0
3979  7C1C              read_cfg_cl4
3980  7C1C 7E           	ld a,(hl)
3981  7C1D D6 30        	sub "0"
3982  7C1F CB 1F        	rr a
3983  7C21 CB 13        	rl e
3984  7C23 23           	inc hl
3985  7C24 10 F6        	djnz read_cfg_cl4
3986  7C26 7B           	ld a,e
3987  7C27 32 D7 97     	ld (cng_19+1),a
3988  7C2A
3989  7C2A C9           	ret
3990  7C2B
3991  7C2B
3992  7C2B              read_cfg_err
3993  7C2B 21 D5 76     	ld hl,mes_read_cfg_err
3994  7C2E CD 62 77     	call print_sys
3995  7C31 C9           	ret
3996  7C32
3997  7C32
3998  7C32              init_hdd ;
3999  7C32              ;инициализация файловой системы FAT
4000  7C32              	;xor a
4001  7C32 CD C9 97     	call navGetNumDrives ;узнаем какая буква последняя, сколько разделов FAT
4002  7C35 FD 21 3A 5C  	ld	iy,#5C3A
4003  7C39 FE 05        	cp 5 ;если только дисководы
4004  7C3B 30 0A        	jr nc,init_fs_fat_prn2
4005  7C3D              init_hdd_err
4006  7C3D 21 C1 76     	ld hl,mes_fat_not_found
4007  7C40 CD 82 77     	call print
4008  7C43 CD 60 7D     	call wait_key
4009  7C46              	;scf ;ошибка
4010  7C46 C9           	ret
4011  7C47
4012  7C47
4013  7C47              init_fs_fat_prn2
4014  7C47              	;печать букв дисководов
4015  7C47 3A 60 73     	ld a,(cur_drive)
4016  7C4A C6 41        	add a,"A"
4017  7C4C 32 AD 76     	ld (mes_curent_drive_letter),a
4018  7C4F 21 A2 76     	ld hl,mes_curent_drive ;
4019  7C52 CD 82 77     	call print
4020  7C55 21 B0 76     	ld hl,mes_fdd ;
4021  7C58 CD 82 77     	call print
4022  7C5B              	;печать списка разделов
4023  7C5B 21 BD 76     	ld hl,mes_fat_found
4024  7C5E CD 82 77     	call print
4025  7C61 21 C4 98     	ld hl,typeDrive
4026  7C64 3A E4 98     	ld a,(numDrives)
4027  7C67 FE 05        	cp 5
4028  7C69 38 4D        	jr c,init_fs_select_
4029  7C6B D6 04        	sub 4 ;убрать дисководы
4030  7C6D 47           	ld b,a ;цикл по количеству разделов
4031  7C6E 0E 45        	ld c,"E" ;первая буква диска FAT
4032  7C70              init_fs_fat_prn1
4033  7C70 C5           	push bc
4034  7C71 E5           	push hl
4035  7C72 79           	ld a,c ;имя диска
4036  7C73 CD F4 77     	call prsym
4037  7C76 3E 3A        	ld a,":" ;
4038  7C78 CD F4 77     	call prsym
4039  7C7B              	;тип S или H
4040  7C7B 3E 48        	ld a,"H"
4041  7C7D E1           	pop hl
4042  7C7E E5           	push hl
4043  7C7F CB 6E        	bit 5,(hl) ;SD?
4044  7C81 28 06        	jr z,init_fs_fat_prn3
4045  7C83 CB 66        	bit 4,(hl) ;SD?
4046  7C85 28 02        	jr z,init_fs_fat_prn3
4047  7C87 3E 53        	ld a,"S"
4048  7C89              init_fs_fat_prn3
4049  7C89
4050  7C89 CD F4 77     	call prsym ;первая буква
4051  7C8C 3E 44        	ld a,"D"
4052  7C8E CD F4 77     	call prsym ;вторая буква
4053  7C91              	;номер диска
4054  7C91 E1           	pop hl
4055  7C92 E5           	push hl
4056  7C93 7E           	ld a,(hl)
4057  7C94 E6 04        	and %00000100
4058  7C96 0F           	rrca
4059  7C97 0F           	rrca
4060  7C98 C6 30        	add "0"
4061  7C9A CD F4 77     	call prsym ;номер диска
4062  7C9D              	;номер раздела
4063  7C9D 3E 2C        	ld a,","
4064  7C9F CD F4 77     	call prsym ;разделитель
4065  7CA2 E1           	pop hl
4066  7CA3 E5           	push hl
4067  7CA4 7E           	ld a,(hl)
4068  7CA5 E6 03        	and %00000011
4069  7CA7 C6 30        	add "0"
4070  7CA9 CD F4 77     	call prsym ;номер раздела
4071  7CAC 21 D3 76     	ld hl,mes_next_line ;новая строка
4072  7CAF CD 82 77     	call print
4073  7CB2 E1           	pop hl
4074  7CB3 23           	inc hl
4075  7CB4 C1           	pop bc
4076  7CB5 0C           	inc c
4077  7CB6 10 B8        	djnz init_fs_fat_prn1
4078  7CB8
4079  7CB8              	;ждём выбора буквы
4080  7CB8              init_fs_select_
4081  7CB8 3A E4 98     	ld a,(numDrives)
4082  7CBB C6 41        	add "A"
4083  7CBD 32 5F 7D     	ld (numDrives_last),a ;последняя свободная буква
4084  7CC0 21 5F 7D     	ld hl,numDrives_last
4085  7CC3              init_fs_select
4086  7CC3 CD C4 60     	call input_key
4087  7CC6 FE 41        	cp "A"
4088  7CC8 38 F9        	jr c,init_fs_select ;не в диапазоне
4089  7CCA
4090  7CCA BE           	cp (hl)
4091  7CCB 30 F6        	jr nc,init_fs_select ;не в диапазоне
4092  7CCD
4093  7CCD D6 41        	sub "A"
4094  7CCF 32 60 73     	ld (cur_drive),a ;сменить текущий диск
4095  7CD2
4096  7CD2              	;ld a,(cur_drive)
4097  7CD2 D6 04        	sub 4
4098  7CD4 4F           	ld c,a
4099  7CD5 06 00        	ld b,0
4100  7CD7 21 C4 98     	ld hl,typeDrive
4101  7CDA 09           	add hl,bc
4102  7CDB              	;инициализация
4103  7CDB 7E           	ld a,(hl) ;выбранный раздел
4104  7CDC CD 1C AD     	call DrvFAT.InitFAT32
4105  7CDF DC 87 82     	call c,print_hdd_error
4106  7CE2
4107  7CE2              	;в корневой каталог
4108  7CE2 CD 0B AE     	call DrvFAT.setRootDir
4109  7CE5 DC 87 82     	call c,print_hdd_error
4110  7CE8
4111  7CE8              	;подсчет количества легинтимных (первых 256) записей в текущем каталоге
4112  7CE8              	;call DrvFAT.GetNumOfEntries
4113  7CE8 C9           	ret
4114  7CE9
4115  7CE9
4116  7CE9
4117  7CE9              readcat_fat
4118  7CE9 CD 69 7D     	call cat_cls ;почистить место
4119  7CEC AF           	xor a
4120  7CED 32 6B 73     	ld (files_l),a
4121  7CF0 21 00 D0     	ld hl,cat_l
4122  7CF3 22 5D 7D     	ld (cat_target_tmp),hl ;указатель на начало
4123  7CF6              	;прочитать сектор каталога
4124  7CF6 01 00 00     	ld bc,0 ;первый сектор
4125  7CF9 1E 0F        	ld e,cat_size_max/512 ;максимум секторов влезет в буфер
4126  7CFB              readcat_fat_cl
4127  7CFB D5           	push de
4128  7CFC CD 25 A8     	call DrvFAT.ReadSectorDIR
4129  7CFF D1           	pop de
4130  7D00 DC 87 82     	call c,print_hdd_error
4131  7D03 38 57        	jr c,init_fs_ex
4132  7D05
4133  7D05
4134  7D05 E5           	push hl
4135  7D06 DD E1        	pop ix ;уазатель на запись о файле
4136  7D08              	;перенести 1 сектор в каталог, кроме лишних записей
4137  7D08 C5           	push bc
4138  7D09 06 10        	ld b,16 ;цикл записей в секторе
4139  7D0B              readcat_fat_cl_one
4140  7D0B C5           	push bc
4141  7D0C DD 7E 00     	ld a,(ix)
4142  7D0F B7           	or a ;конец каталога
4143  7D10 28 38        	jr z,readcat_fat_cl_skip
4144  7D12 FE E5        	cp #e5 ;удалённый
4145  7D14 28 34        	jr z,readcat_fat_cl_skip
4146  7D16 FE 05        	cp #05 ;удалённый
4147  7D18 28 30        	jr z,readcat_fat_cl_skip
4148  7D1A DD 7E 0B     	ld a,(ix+#0b)
4149  7D1D FE 0F        	cp #0f ;длинный
4150  7D1F 28 29        	jr z,readcat_fat_cl_skip
4151  7D21 FE 08        	cp #08 ;метка тома
4152  7D23 28 25        	jr z,readcat_fat_cl_skip
4153  7D25              	;проверка на папку "." (этот же каталог)
4154  7D25 DD 7E 00     	ld a,(ix+#00)
4155  7D28 FE 2E        	cp "." ;
4156  7D2A 20 07        	jr nz,readcat_fat__add
4157  7D2C DD 7E 01     	ld a,(ix+#01)
4158  7D2F FE 20        	cp " " ;
4159  7D31 28 17        	jr z,readcat_fat_cl_skip
4160  7D33              readcat_fat__add
4161  7D33              	;перенести одну запись
4162  7D33 DD E5        	push ix
4163  7D35 E1           	pop hl
4164  7D36 ED 5B 5D 7D  	ld de,(cat_target_tmp)
4165  7D3A 01 20 00     	ld bc,32
4166  7D3D ED B0        	ldir
4167  7D3F ED 53 5D 7D  	ld (cat_target_tmp),de
4168  7D43 3A 6B 73     	ld a,(files_l)
4169  7D46 3C           	inc a
4170  7D47 32 6B 73     	ld (files_l),a
4171  7D4A
4172  7D4A              readcat_fat_cl_skip
4173  7D4A
4174  7D4A 01 20 00     	ld bc,32 ;на следующую запись
4175  7D4D DD 09        	add ix,bc
4176  7D4F C1           	pop bc
4177  7D50 10 B9        	djnz readcat_fat_cl_one
4178  7D52 C1           	pop bc
4179  7D53              	;
4180  7D53
4181  7D53
4182  7D53
4183  7D53 21 10 00     	ld hl,16 ;на следующий сектор (512/32)
4184  7D56 09           	add hl,bc
4185  7D57 44           	ld b,h
4186  7D58 4D           	ld c,l
4187  7D59 1D           	dec e
4188  7D5A 20 9F        	jr nz,readcat_fat_cl
4189  7D5C
4190  7D5C
4191  7D5C              init_fs_ex
4192  7D5C              	; ld a,(cur_drive)
4193  7D5C              	; or a
4194  7D5C C9           	ret
4195  7D5D 00 00        cat_target_tmp dw 0 ;временно
4196  7D5F 00           numDrives_last db 0 ;временно
4197  7D60
4198  7D60              wait_key ;ждёт любой клавиши
4199  7D60 76           	halt
4200  7D61 3A 04 5C     	ld a,(23556)
4201  7D64 FE FF        	cp 255
4202  7D66 28 F8        	jr z,wait_key
4203  7D68 C9           	ret
4204  7D69
4205  7D69
4206  7D69              cat_cls ;очистить каталог слева
4207  7D69 21 00 D0     	ld hl,cat_l
4208  7D6C 11 01 D0     	ld de,cat_l+1
4209  7D6F 01 FF 1D     	ld bc,cat_l_end-cat_l-1
4210  7D72 36 00        	ld (hl),0
4211  7D74 ED B0        	ldir
4212  7D76 C9           	ret
4213  7D77
4214  7D77
4215  7D77              ;печать каталога левая панель FAT
4216  7D77              printcat_l_fat
4217  7D77 3A 6D 73     			ld a,(panel) ;проверка надо ли скрыть курсор
4218  7D7A FE 4C        			cp "L"
4219  7D7C 3E 39        			ld a,colorcatc_act
4220  7D7E 28 02        			jr z,printcat_l_fat1
4221  7D80 3E 0F        			ld a,colorcat_
4222  7D82              printcat_l_fat1
4223  7D82 32 5A 73     			ld (colorcatc_l),a
4224  7D85
4225  7D85 21 00 58                 ld      hl,col_pos_l ;
4226  7D88 AF                       xor		a
4227  7D89              clscat_fat_l
4228  7D89 54                       ld      d,h
4229  7D8A 5D                       ld      e,l
4230  7D8B 13                       inc     de
4231  7D8C 4F                       ld      c,a  ;keep
4232  7D8D 3A 63 73                 ld      a,(shiftcat_l)
4233  7D90 47                       ld      b,a
4234  7D91 3A 6C 73                 ld      a,(curfile_l)
4235  7D94 A7                       and     a
4236  7D95 98                       sbc     a,b
4237  7D96 B9                       cp      c
4238  7D97 32 5E 73                 ld      (cursor_l),a ;posit
4239  7D9A 3A 5B 73                 ld      a,(colorcat_l)
4240  7D9D 20 03                    jr      nz,clscat_fat01_l
4241  7D9F 3A 5A 73                 ld      a,(colorcatc_l) ;mark
4242  7DA2              clscat_fat01_l
4243  7DA2 77                       ld      (hl),a  ;раскраска атрибутами
4244  7DA3 79                       ld      a,c  ;restor
4245  7DA4 01 09 00                 ld      bc,9
4246  7DA7 ED B0                    ldir
4247  7DA9 01 17 00                 ld      bc,32-9
4248  7DAC 09                       add     hl,bc
4249  7DAD 3C                       inc     a
4250  7DAE FE 15                    cp      files_view
4251  7DB0 38 D7                    jr      c,clscat_fat_l
4252  7DB2
4253  7DB2                     ;     ld      hl,catposit
4254  7DB2                     ;     call    print
4255  7DB2
4256  7DB2 3A 6B 73     			ld a,(files_l)
4257  7DB5 B7           			or a
4258  7DB6 C8           			ret z ;выход если нет файлов
4259  7DB7
4260  7DB7 01 00 D0                 ld      bc,cat_l  ;теперь печать имён файлов
4261  7DBA 3A 63 73                 ld      a,(shiftcat_l)
4262  7DBD DD 6F        			ld xl,a
4263  7DBF                          ; or      a
4264  7DBF                          ; jr      z,printcat00
4265  7DBF 6F           			ld      l,a
4266  7DC0 26 00        			ld 		h,0
4267  7DC2              ;printcat01  ;find name file
4268  7DC2 29                       add    hl,hl ;2
4269  7DC3 29           			add    hl,hl ;4
4270  7DC4 29           			add    hl,hl ;8
4271  7DC5 29           			add    hl,hl ;16
4272  7DC6 29           			add    hl,hl ;32
4273  7DC7 09           			add hl,bc
4274  7DC8                          ;dec    a
4275  7DC8                          ;jr    nz,printcat01
4276  7DC8              ;printcat00
4277  7DC8
4278  7DC8 AF                       xor     a
4279  7DC9              printcat_fat02_l
4280  7DC9 F5                       push    af
4281  7DCA E5                       push    hl
4282  7DCB                                     ;print 24 row
4283  7DCB
4284  7DCB 32 98 73                 ld      (catposit_l+1),a
4285  7DCE 21 97 73                 ld      hl,catposit_l ;установим позицию печати
4286  7DD1 CD 82 77                 call    print
4287  7DD4 E1                       pop     hl
4288  7DD5 E5                       push    hl
4289  7DD6 CD 75 70     			call 	format_name_fat_l ;подготовим
4290  7DD9              			;отметка галкой
4291  7DD9 EB           			ex de,hl
4292  7DDA 21 00 CF     			ld hl,cat_mark_l
4293  7DDD DD 7D        			ld a,xl
4294  7DDF 85           			add l
4295  7DE0 6F           			ld l,a
4296  7DE1 7E           			ld a,(hl)
4297  7DE2 EB           			ex de,hl
4298  7DE3 B7           			or a
4299  7DE4 28 09        			jr z,printcat_mark_fat_l
4300  7DE6 E5           			push hl
4301  7DE7 3E FB        			ld a,0-5 ;знак галка
4302  7DE9 01 08 00     			ld bc,8
4303  7DEC 09           			add hl,bc
4304  7DED 77           			ld (hl),a
4305  7DEE E1           			pop hl
4306  7DEF              printcat_mark_fat_l
4307  7DEF DD 2C        			inc xl
4308  7DF1              			;
4309  7DF1
4310  7DF1 01 0C 00     			ld bc,12 ;длина
4311  7DF4 CD 71 77                 call    print_ ;печать одного имени файла
4312  7DF7                          ;ld      hl,catspace
4313  7DF7                          ;call    print
4314  7DF7 E1                       pop     hl
4315  7DF8 01 20 00                 ld      bc,lenghtName*2 ;на след. имя
4316  7DFB 09                       add     hl,bc
4317  7DFC F1                       pop     af
4318  7DFD 3C                       inc     a
4319  7DFE ED 4B 6B 73  			ld 		bc,(files_l) ;проверка сколько всего файлов
4320  7E02 B9           			cp 		c
4321  7E03 D0           			ret		nc
4322  7E04 FE 15                    cp      files_view ;проверка сколько файлов показывать
4323  7E06 38 C1                    jr      c,printcat_fat02_l
4324  7E08 C9           			ret
4325  7E09
4326  7E09              ;открыть папку слева
4327  7E09              open_dir_l
4328  7E09 3A 68 73     			ld a,(curfile) ;текущ файл
4329  7E0C 01 00 D0     			ld bc,cat_l
4330  7E0F 6F           			ld l,a
4331  7E10 26 00        			ld h,0
4332  7E12 29                       add    hl,hl ;2
4333  7E13 29           			add    hl,hl ;4
4334  7E14 29           			add    hl,hl ;8
4335  7E15 29           			add    hl,hl ;16
4336  7E16 29           			add    hl,hl ;32
4337  7E17 09           			add hl,bc
4338  7E18 E5           			push hl
4339  7E19 DD E1        			pop ix ;запомним
4340  7E1B DD 7E 0B     	ld a,(ix+#0b)
4341  7E1E CB 67        	bit 4,a ;это папка?
4342  7E20 CA 47 60     	jp z,wait
4343  7E23 1E 00        	ld e,0
4344  7E25              	;проверка на папку ".." (каталог выше)
4345  7E25 DD 7E 00     	ld a,(ix+#00)
4346  7E28 FE 2E        	cp "." ;
4347  7E2A 20 10        	jr nz,open_dir_l1
4348  7E2C DD 7E 01     	ld a,(ix+#01)
4349  7E2F FE 2E        	cp "." ;
4350  7E31 20 09        	jr nz,open_dir_l1
4351  7E33 DD 7E 02     	ld a,(ix+#02)
4352  7E36 FE 20        	cp " " ;
4353  7E38 20 02        	jr nz,open_dir_l1
4354  7E3A 1E 80        	ld e,#80 ;7,e =1 это возврат в родительский каталог
4355  7E3C              open_dir_l1
4356  7E3C DD 7E 0B     	ld a,(ix+#0b)
4357  7E3F CD 7E A6     	call DrvFAT.Enter2DIR
4358  7E42 DC 87 82     	call c,print_hdd_error
4359  7E45 CD A9 62     	call    renewcat_l
4360  7E48 C3 47 60         jp      wait
4361  7E4B
4362  7E4B              ;повторный выбор раздела
4363  7E4B              select_hdd
4364  7E4B CD 67 65     	call cls_l
4365  7E4E CD 47 7C     	call init_fs_fat_prn2
4366  7E51              	; ld a,24 ;скрыть курсор
4367  7E51              	; ld (curfile),a
4368  7E51              	; xor a
4369  7E51              	; ld (shiftcat_),a
4370  7E51 CD A9 62     	call renewcat_l
4371  7E54 C3 47 60     	jp wait
4372  7E57
4373  7E57
4374  7E57
4375  7E57
4376  7E57
4377  7E57              copyF_LR_FAT	;копирование файлов слева направо FAT
4378  7E57 3A 7C 73     			ld a,(open_trd_flag)
4379  7E5A B7           			or a
4380  7E5B C2 47 60     			jp nz,wait ;если открыт образ справа, то нельзя
4381  7E5E
4382  7E5E
4383  7E5E              			;окно запроса с выбором диска
4384  7E5E 3A 60 73     			ld a,(cur_drive)
4385  7E61 C6 41        			add a,"A"
4386  7E63 32 17 75     			ld (mes_trd_dsk+3),a
4387  7E66 21 42 76     			ld hl,mes_copy_file
4388  7E69 CD 82 77     			call print
4389  7E6C 21 14 75     			ld hl,mes_trd_dsk
4390  7E6F CD 82 77     			call print
4391  7E72 3E 27        			ld a,col_win
4392  7E74 CD 16 6E     			call paint_win
4393  7E77              copyF_LR_FAT_w ;ожидание согласия
4394  7E77 76           			halt
4395  7E78 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
4396  7E7B FE 4E        			cp 		"N"
4397  7E7D CA 4B 6A     			jp z,copyF_exit ;выход если нет согласия
4398  7E80 FE 59        			cp 		"Y"
4399  7E82 20 F3        			jr nz,copyF_LR_FAT_w
4400  7E84
4401  7E84              			;узнать сколько отмеченных файлов
4402  7E84 21 00 CF     			ld hl,cat_mark_l
4403  7E87 06 80        			ld b,128 ;размер таблицы
4404  7E89 DD 2E 00     			ld xl,0 ;счётчик
4405  7E8C              copyF_LR_FAT_no_one_chk
4406  7E8C 7E           			ld a,(hl)
4407  7E8D B7           			or a
4408  7E8E 28 02        			jr z,copyF_LR_FAT_no_one_chk1
4409  7E90 DD 2C        			inc xl
4410  7E92              copyF_LR_FAT_no_one_chk1
4411  7E92 23           			inc hl
4412  7E93 10 F7        			djnz copyF_LR_FAT_no_one_chk
4413  7E95 DD 2C        			inc xl
4414  7E97 DD 2D        			dec xl
4415  7E99 20 11        			jr nz,copyF_LR_FAT_no_one ;не один
4416  7E9B 3A 68 73     			ld a,(curfile) ;тогда только текущий файл
4417  7E9E CD FA 7E     			call copyF_LR_FAT_one
4418  7EA1 D2 EE 7E     			jp nc,copyF_LR_fat_exit ;выход без ошибки
4419  7EA4 FE FF        			cp 255
4420  7EA6 CA EE 7E     			jp z,copyF_LR_fat_exit ;выход после останова
4421  7EA9 C3 F4 7E     			jp copyF_LR_fat_error ;выход с ошибкой
4422  7EAC
4423  7EAC
4424  7EAC              copyF_LR_FAT_no_one ;копировать несколько
4425  7EAC 21 00 CF     			ld hl,cat_mark_l
4426  7EAF DD 7D        			ld a,xl
4427  7EB1 32 96 73     			ld (cat_mark_cur_tot),a
4428  7EB4 AF           			xor a
4429  7EB5              copyF_LR_FAT_no_one_cl
4430  7EB5 32 95 73     			ld (cat_mark_cur_cl),a
4431  7EB8 22 93 73     			ld (cat_mark_cur),hl
4432  7EBB 7E           			ld a,(hl) ;есть отметка?
4433  7EBC B7           			or a
4434  7EBD 28 1E        			jr z,copyF_LR_FAT_no_one_cl1
4435  7EBF 3A 96 73     			ld a,(cat_mark_cur_tot)
4436  7EC2 6F           			ld l,a
4437  7EC3 26 00        			ld h,0
4438  7EC5 3D           			dec a
4439  7EC6 32 96 73     			ld (cat_mark_cur_tot),a
4440  7EC9 CD 16 72     			call print_progress_tot ;прогресс
4441  7ECC 3A 95 73     			ld a,(cat_mark_cur_cl) ;очередной номер файла
4442  7ECF CD FA 7E     			call copyF_LR_FAT_one ;скопировать
4443  7ED2 D2 DD 7E     			jp nc,copyF_LR_FAT_no_one_cl1 ;продолжить без ошибки
4444  7ED5 FE FF        			cp 255
4445  7ED7 CA EE 7E     			jp z,copyF_LR_fat_exit ;выход после останова
4446  7EDA C3 F4 7E     			jp copyF_LR_fat_error ;выход с ошибкой
4447  7EDD
4448  7EDD              copyF_LR_FAT_no_one_cl1
4449  7EDD 2A 93 73     			ld hl,(cat_mark_cur)
4450  7EE0 36 00        			ld (hl),0 ;снять отметку
4451  7EE2 23           			inc hl
4452  7EE3 3A 95 73     			ld a,(cat_mark_cur_cl)
4453  7EE6 3C           			inc a
4454  7EE7 FE 80        			cp 128
4455  7EE9 38 CA        			jr c,copyF_LR_FAT_no_one_cl
4456  7EEB
4457  7EEB C3 EE 7E     			jp copyF_LR_fat_exit ;без ошибки
4458  7EEE
4459  7EEE              copyF_LR_fat_exit
4460  7EEE CD E1 62     	call renewcat_r
4461  7EF1 C3 4B 6A     	jp copyF_exit
4462  7EF4
4463  7EF4              copyF_LR_fat_error
4464  7EF4 CD E1 62     	call renewcat_r
4465  7EF7 C3 6B 6A     	jp copyF_error
4466  7EFA
4467  7EFA              copyF_LR_FAT_one ;скопировать один файл слева направо
4468  7EFA              			;на входе в A - номер файла
4469  7EFA              			;на выходе C=1, если ошибка; A=255, если остановлено
4470  7EFA
4471  7EFA              			;узнать параметры файла
4472  7EFA 01 00 D0     			ld bc,cat_l ;каталог диска слева
4473  7EFD              			;ld a,(curfile) ;текущ файл
4474  7EFD 6F           			ld l,a
4475  7EFE 26 00        			ld h,0
4476  7F00 29                       add    hl,hl ;2
4477  7F01 29           			add    hl,hl ;4
4478  7F02 29           			add    hl,hl ;8
4479  7F03 29           			add    hl,hl ;16
4480  7F04 29           			add    hl,hl ;32
4481  7F05 09           			add hl,bc
4482  7F06
4483  7F06 22 88 73     			ld (copyF_RL_source_file),hl ;указатель на запись о файле
4484  7F09 01 1F 00     			ld bc,#1c+3
4485  7F0C 09           			add hl,bc
4486  7F0D 7E           			ld a,(hl) ;размер файла 4й байт
4487  7F0E FE 04        			cp 4
4488  7F10 D2 3B 68     			jp nc,copyF_LR_error ;если слишком большой
4489  7F13 4F           			ld c,a ;4й
4490  7F14 2B           			dec hl
4491  7F15 7E           			ld a,(hl) ;размер файла 3й байт
4492  7F16 57           			ld d,a ;3й
4493  7F17 2B           			dec hl
4494  7F18 7E           			ld a,(hl) ;
4495  7F19 5F           			ld e,a ;2й
4496  7F1A
4497  7F1A
4498  7F1A CB 39        			srl c ;/2 на старший бит придёт 0
4499  7F1C CB 1A        			rr d ;
4500  7F1E CB 1B        			rr e ; на старший бит придёт флаг С
4501  7F20 CB 39        			srl c ;/4
4502  7F22 CB 1A        			rr d ;
4503  7F24 CB 1B        			rr e
4504  7F26
4505  7F26 7E           			ld a,(hl) ;2й байт
4506  7F27 E6 03        			and %00000011
4507  7F29 4F           			ld c,a
4508  7F2A 2B           			dec hl
4509  7F2B 7E           			ld a,(hl) ;1й байт
4510  7F2C B1           			or c
4511  7F2D 28 01        			jr z,copyF_LR_FAT_one_fix
4512  7F2F 13           			inc de ;фикс
4513  7F30              copyF_LR_FAT_one_fix
4514  7F30
4515  7F30              			;ld (copyF_RL_source_sec_size),de ;два байта длины в секторах по 1024
4516  7F30
4517  7F30              			;цикл по размеру в секторах
4518  7F30 DD 62 DD 6B  			ld ix,de
4519  7F34
4520  7F34
4521  7F34              			;начинаем копировать файл
4522  7F34
4523  7F34
4524  7F34 2A 88 73     			ld hl,(copyF_RL_source_file) ;указатель
4525  7F37 CD 4D 82     			call format_name_fat_dot
4526  7F3A 11 C0 B3     			ld de,trn_buf+16 ;перекинем имя файла в запрос
4527  7F3D 01 0C 00     			ld bc,file_name_len
4528  7F40 ED B0        			ldir
4529  7F42 3E 04        			ld a,4 ;Тип пакета Запрос на передачу файла 1024 байт
4530  7F44 32 B3 B3     			ld (trn_buf+3),a
4531  7F47
4532  7F47 21 00 00     			ld hl,0
4533  7F4A 22 B4 B3     			ld (trn_buf+4),hl ;с нулевой части
4534  7F4D
4535  7F4D              			;размер файла
4536  7F4D 2A 88 73     			ld hl,(copyF_RL_source_file) ;указатель
4537  7F50 01 1C 00     			ld bc,#1c
4538  7F53 09           			add hl,bc
4539  7F54 7E           			ld a,(hl)
4540  7F55 32 BC B3     			ld (trn_buf+12),a
4541  7F58 23           			inc hl
4542  7F59 7E           			ld a,(hl)
4543  7F5A 32 BD B3     			ld (trn_buf+13),a
4544  7F5D 23           			inc hl
4545  7F5E 7E           			ld a,(hl)
4546  7F5F 32 BE B3     			ld (trn_buf+14),a
4547  7F62 23           			inc hl
4548  7F63 7E           			ld a,(hl)
4549  7F64 32 BF B3     			ld (trn_buf+15),a
4550  7F67
4551  7F67
4552  7F67
4553  7F67              	;открыть файл
4554  7F67 2A 88 73     	ld hl,(copyF_RL_source_file) ;указатель
4555  7F6A DD E5        	push ix
4556  7F6C DD 21 B3 BC  	ld ix,file_fcb_tmp
4557  7F70
4558  7F70              ;установка fcb буфера на основании дескриптора файла
4559  7F70              ;вх:  ix - адрес fcb буфера
4560  7F70              ;     hl - адрес дескриптора файла
4561  7F70              ;     (CLS_CurrDir) кластер каталога с файлом
4562  7F70              ;вых: hl - адрес дескриптора файла
4563  7F70 CD 51 AC     	call DrvFAT.fcbSetFromEntry
4564  7F73 DD E1        	pop ix
4565  7F75 DC 87 82     	call c,print_hdd_error
4566  7F78 DA 3B 68     	jp c,copyF_LR_error
4567  7F7B
4568  7F7B
4569  7F7B
4570  7F7B
4571  7F7B              			;цикл
4572  7F7B              copyF_LR_FAT3
4573  7F7B DD E5        			push ix
4574  7F7D E1           			pop hl
4575  7F7E CD 01 72     			call print_progress
4576  7F81
4577  7F81
4578  7F81              	;считать 1 сектор 1024
4579  7F81 DD E5        	push ix
4580  7F83 DD 21 B3 BC  	ld ix,file_fcb_tmp
4581  7F87 21 D0 B3     	ld hl,trn_buf+pack_size_32_com ;адрес отправляемого пакета
4582  7F8A 01 00 04     	ld bc,2*512
4583  7F8D              ;чтение данных из файла в память
4584  7F8D              ;  файл должен быть открыт
4585  7F8D              ;  в fcb должны быть установлены: fcbClsFile, fcbOffset
4586  7F8D              ;вх:  ix - адрес fcb
4587  7F8D              ;     hl - адрес для чтения
4588  7F8D              ;     bc - количество байт для чтения
4589  7F8D CD DA A5     	call DrvFAT.ReadDataFromFile
4590  7F90 DD E1        	pop ix
4591  7F92 DC 87 82     	call c,print_hdd_error
4592  7F95 DA 3B 68     	jp c,copyF_LR_error
4593  7F98
4594  7F98 CD B3 7F     	call sec1024_to_srv ;отправить на сервер
4595  7F9B DA 3B 68     		jp c,copyF_LR_error
4596  7F9E
4597  7F9E              copyF_LR_FAT_check_pass	;проверка прошла
4598  7F9E
4599  7F9E
4600  7F9E 2A B4 B3     			ld hl,(trn_buf+4) ;следующая честь файла
4601  7FA1 23           			inc hl
4602  7FA2 22 B4 B3     			ld (trn_buf+4),hl
4603  7FA5
4604  7FA5 DD 2B        			dec ix
4605  7FA7 DD 7D        			ld a,xl
4606  7FA9 DD B4        			or xh
4607  7FAB C2 7B 7F     			jp nz,copyF_LR_FAT3
4608  7FAE
4609  7FAE
4610  7FAE              			;call cls_r ;очистить правую панель
4611  7FAE CD 73 6F     			call printcat_l
4612  7FB1              			;call renewcat_r
4613  7FB1
4614  7FB1 AF           			xor a ;С=0, нет ошибок
4615  7FB2 C9           			ret
4616  7FB3
4617  7FB3
4618  7FB3              sec1024_to_srv
4619  7FB3              			;отправка сектора 1024 в образ. заголовок пакета уже должен быть готов
4620  7FB3 CD 37 79     			call check_init_r ;авто проверка инициализации
4621  7FB6
4622  7FB6 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
4623  7FB9 FE 20        			cp " "
4624  7FBB 20 0E        			jr nz,sec1024_to_srv2 ;продолжим
4625  7FBD 21 5F 75     			ld hl,mes_stopped ;прервём
4626  7FC0 CD 62 77     			call print_sys
4627  7FC3 CD 9A 6E     			call wait_releas
4628  7FC6 E1           			pop hl ;поправить адрес возврата
4629  7FC7 3E FF        			ld a,255 ;ошибка останов
4630  7FC9 3F           			ccf ;С=1
4631  7FCA C9           			ret
4632  7FCB
4633  7FCB              sec1024_to_srv2
4634  7FCB
4635  7FCB
4636  7FCB 11 B0 B3     			ld de,trn_buf
4637  7FCE 01 20 04     			ld bc,pack_size_1024_com+pack_size_32_com
4638  7FD1 ED 43 91 73  			ld (check_sum_size),bc
4639  7FD5 CD E7 70     			call calc_check_sum ;проверить сумму
4640  7FD8 22 D0 B7     			ld (trn_buf+pack_size_1024_com+pack_size_32_com),hl ;записать её в пакет
4641  7FDB
4642  7FDB 21 B0 B3     			ld hl,trn_buf ;откуда
4643  7FDE 11 22 04     			ld de,pack_size_1024 ;размер
4644  7FE1 CD 4B 7A     			call Wifi.tcpSend ;отправить
4645  7FE4 38 CD        			jr c,sec1024_to_srv ;если ошибка, повтор
4646  7FE6
4647  7FE6 21 E3 73     			ld hl,mes_trq_part_file ;сообщение пока ждём ответ
4648  7FE9 CD 62 77     			call print_sys
4649  7FEC
4650  7FEC 21 00 F6     			ld hl,rec_buf ;куда
4651  7FEF 22 D8 79     			ld (Wifi.buffer_pointer),hl
4652  7FF2 CD 8D 7A     			call Wifi.getPacket ;приём
4653  7FF5 38 BC        			jr c,sec1024_to_srv ;если ошибка, повтор
4654  7FF7
4655  7FF7              			;принят пакет
4656  7FF7
4657  7FF7 21 27 74     			ld hl,mes_trn_part_file ;сообщение
4658  7FFA CD 62 77     			call print_sys
4659  7FFD 21 00 F6     			ld hl,rec_buf
4660  8000 01 20 00     			ld bc,pack_size_32_com
4661  8003 ED 43 91 73  			ld (check_sum_size),bc ;задать длину пакета для подсчёта
4662  8007 0E 05        			ld c,5 ; Тип пакета Файл 1024
4663  8009 CD 3B 6E     			call check_pack
4664  800C 38 A5        			jr c,sec1024_to_srv ;если ошибка]повтор
4665  800E AF           			xor a
4666  800F C9           			ret ;выход без ошибок
4667  8010
4668  8010
4669  8010
4670  8010
4671  8010
4672  8010
4673  8010
4674  8010
4675  8010
4676  8010              copyF_RL_FAT ;копирование файлов справа налево FAT
4677  8010 3A 7C 73     			ld a,(open_trd_flag)
4678  8013 B7           			or a
4679  8014 C2 47 60     			jp nz,wait ;если открыт образ справа
4680  8017
4681  8017
4682  8017              			;узнать сколько отмеченных файлов
4683  8017 21 80 CF     			ld hl,cat_mark_r
4684  801A 06 80        			ld b,128 ;размер таблицы
4685  801C DD 2E 00     			ld xl,0 ;счётчик
4686  801F              copyF_RL_FAT_no_one_chk
4687  801F 7E           			ld a,(hl)
4688  8020 B7           			or a
4689  8021 28 02        			jr z,copyF_RL_FAT_no_one_chk1
4690  8023 DD 2C        			inc xl
4691  8025              copyF_RL_FAT_no_one_chk1
4692  8025 23           			inc hl
4693  8026 10 F7        			djnz copyF_RL_FAT_no_one_chk
4694  8028 DD 2C        			inc xl
4695  802A DD 2D        			dec xl
4696  802C 20 00        			jr nz,copyF_RL_FAT_no_one2 ;не ноль
4697  802E              			;не отмечено
4698  802E              copyF_RL_FAT_no_one2
4699  802E              			;окно запроса с выбором диска
4700  802E 3A 60 73     			ld a,(cur_drive)
4701  8031 C6 41        			add a,"A"
4702  8033 32 17 75     			ld (mes_trd_dsk+3),a
4703  8036 21 42 76     			ld hl,mes_copy_file
4704  8039 CD 82 77     			call print
4705  803C 21 14 75     			ld hl,mes_trd_dsk
4706  803F CD 82 77     			call print
4707  8042 3E 27        			ld a,col_win
4708  8044 CD 16 6E     			call paint_win
4709  8047
4710  8047              copyF_RL_FAT_w ;ожидание согласия
4711  8047 76           			halt
4712  8048 3A 04 5C     			ld 		a,(23556) ;сист. переменная нажатая клавиша
4713  804B FE 4E        			cp 		"N"
4714  804D CA 4B 6A     			jp z,copyF_exit ;выход если нет согласия
4715  8050 FE 59        			cp 		"Y"
4716  8052 20 F3        			jr nz,copyF_RL_FAT_w
4717  8054
4718  8054 DD 2C        			inc xl
4719  8056 DD 2D        			dec xl
4720  8058 20 11        			jr nz,copyF_RL_FAT_no_one ;не один
4721  805A 3A 68 73     			ld a,(curfile) ;тогда только текущий файл
4722  805D CD B9 80     			call copyF_RL_FAT_one
4723  8060 D2 AD 80     			jp nc,copyF_RL_fat_exit ;выход без ошибки
4724  8063 FE FF        			cp 255
4725  8065 CA AD 80     			jp z,copyF_RL_fat_exit ;выход после останова
4726  8068 C3 B3 80     			jp copyF_RL_fat_error ;выход с ошибкой
4727  806B
4728  806B
4729  806B              copyF_RL_FAT_no_one ;копировать несколько
4730  806B 21 80 CF     			ld hl,cat_mark_r
4731  806E DD 7D        			ld a,xl
4732  8070 32 96 73     			ld (cat_mark_cur_tot),a
4733  8073 AF           			xor a
4734  8074              copyF_RL_FAT_no_one_cl
4735  8074 32 95 73     			ld (cat_mark_cur_cl),a
4736  8077 22 93 73     			ld (cat_mark_cur),hl
4737  807A 7E           			ld a,(hl) ;есть отметка?
4738  807B B7           			or a
4739  807C 28 1E        			jr z,copyF_RL_FAT_no_one_cl1
4740  807E 3A 96 73     			ld a,(cat_mark_cur_tot)
4741  8081 6F           			ld l,a
4742  8082 26 00        			ld h,0
4743  8084 3D           			dec a
4744  8085 32 96 73     			ld (cat_mark_cur_tot),a
4745  8088 CD 16 72     			call print_progress_tot ;прогресс
4746  808B 3A 95 73     			ld a,(cat_mark_cur_cl) ;очередной номер файла
4747  808E CD B9 80     			call copyF_RL_FAT_one ;скопировать
4748  8091 D2 9C 80     			jp nc,copyF_RL_FAT_no_one_cl1 ;продолжить без ошибки
4749  8094 FE FF        			cp 255
4750  8096 CA AD 80     			jp z,copyF_RL_fat_exit ;выход после останова
4751  8099 C3 B3 80     			jp copyF_RL_fat_error ;выход с ошибкой
4752  809C              copyF_RL_FAT_no_one_cl1
4753  809C 2A 93 73     			ld hl,(cat_mark_cur)
4754  809F 36 00        			ld (hl),0 ;снять отметку
4755  80A1 23           			inc hl
4756  80A2 3A 95 73     			ld a,(cat_mark_cur_cl)
4757  80A5 3C           			inc a
4758  80A6 FE 80        			cp 128
4759  80A8 38 CA        			jr c,copyF_RL_FAT_no_one_cl
4760  80AA
4761  80AA C3 AD 80     			jp copyF_RL_fat_exit ;выход без ошибки
4762  80AD
4763  80AD              copyF_RL_fat_exit
4764  80AD CD A9 62     			call renewcat_l
4765  80B0 C3 4B 6A     			jp copyF_exit
4766  80B3
4767  80B3              copyF_RL_fat_error
4768  80B3 CD A9 62     			call renewcat_l
4769  80B6 C3 6B 6A     			jp copyF_error
4770  80B9
4771  80B9              copyF_RL_FAT_one ;по одному файлу справа налево FAT
4772  80B9              			;на входе в A - номер файла
4773  80B9              			;на выходе C=1, если ошибка; A=255, если остановлено
4774  80B9
4775  80B9              			;узнать параметры файла
4776  80B9 01 00 EE     			ld bc,cat_r ;адрес обычного каталога
4777  80BC              			;ld a,(curfile) ;текущ файл
4778  80BC 6F           			ld l,a
4779  80BD 26 00        			ld h,0
4780  80BF 29                       add    hl,hl ;2
4781  80C0 29           			add    hl,hl ;4
4782  80C1 29           			add    hl,hl ;8
4783  80C2 29           			add    hl,hl ;16
4784  80C3 09           			add hl,bc
4785  80C4
4786  80C4 22 88 73     			ld (copyF_RL_source_file),hl ;указатель на запись о файле
4787  80C7
4788  80C7
4789  80C7 01 0F 00     			ld bc,12+3
4790  80CA 09           			add hl,bc
4791  80CB 7E           			ld a,(hl) ;размер файла 4й байт
4792  80CC FE 04        			cp 4
4793  80CE D2 3B 68     			jp nc,copyF_LR_error ;если слишком большой
4794  80D1 4F           			ld c,a ;4й
4795  80D2 2B           			dec hl
4796  80D3 7E           			ld a,(hl) ;размер файла 3й байт
4797  80D4 57           			ld d,a ;3й
4798  80D5 2B           			dec hl
4799  80D6 7E           			ld a,(hl) ;
4800  80D7 5F           			ld e,a ;2й
4801  80D8
4802  80D8              			;разделить на 1024
4803  80D8 CB 39        			srl c ;/2 на старший бит придёт 0
4804  80DA CB 1A        			rr d ;
4805  80DC CB 1B        			rr e ; на старший бит придёт флаг С
4806  80DE CB 39        			srl c ;/4
4807  80E0 CB 1A        			rr d ;
4808  80E2 CB 1B        			rr e
4809  80E4
4810  80E4              			;цикл по размеру в секторах 1024
4811  80E4 DD 62 DD 6B  			ld ix,de
4812  80E8
4813  80E8              			;узнать размер последней части файла. обратно умножим на 1024
4814  80E8              			;ld c,0
4815  80E8 CB 23        			sla e ;*2 на младший бит придёт 0
4816  80EA              			;rl d ;на младший бит придёт флаг C
4817  80EA              			;rl c
4818  80EA CB 23        			sla e ;*2 на младший бит придёт 0
4819  80EC              			;rl d ;на младший бит придёт флаг C
4820  80EC              			;rl c
4821  80EC              			;ld e,d
4822  80EC              			;ld d,c ;в DE 3й и 4й байт
4823  80EC 53           			ld d,e
4824  80ED 1E 00        			ld e,0
4825  80EF 2A 88 73     			ld hl,(copyF_RL_source_file) ;указатель на запись о файле
4826  80F2 01 0D 00     			ld bc,12+1
4827  80F5 09           			add hl,bc
4828  80F6 7E           			ld a,(hl) ;размер файла 2й байт
4829  80F7 2B           			dec hl
4830  80F8 6E           			ld l,(hl) ;1й байт
4831  80F9 67           			ld h,a
4832  80FA A7           			and a
4833  80FB ED 52        			sbc hl,de ;узнали остаток
4834  80FD 22 8F 73     			ld (copyF_FAT_RL_last_part),hl
4835  8100
4836  8100              			;коррекция числа пакетов
4837  8100 2A 88 73     			ld hl,(copyF_RL_source_file) ;указатель на запись о файле
4838  8103 01 0D 00     			ld bc,12+1
4839  8106 09           			add hl,bc
4840  8107 7E           			ld a,(hl) ;2й байт
4841  8108 E6 03        			and %00000011
4842  810A 4F           			ld c,a
4843  810B 2B           			dec hl
4844  810C 7E           			ld a,(hl) ;1й байт
4845  810D B1           			or c
4846  810E 28 02        			jr z,copyF_RL_FAT_one_fix
4847  8110 DD 23        			inc ix ;фикс
4848  8112              copyF_RL_FAT_one_fix
4849  8112
4850  8112
4851  8112              			;пробуем открыть файл
4852  8112 DD E5        			push ix
4853  8114 2A 88 73     			ld hl,(copyF_RL_source_file) ;указатель на запись о файле
4854  8117 11 D3 BC     			ld de,file_name_cur
4855  811A 01 0C 00     			ld bc,file_name_len ;перенести, чтобы в конце был 0
4856  811D ED B0        			ldir
4857  811F AF           			xor a
4858  8120 12           			ld (de),a
4859  8121 21 D3 BC     			ld hl,file_name_cur
4860  8124 CD 49 B2     			call  DrvFAT.strTestFileName
4861  8127 DC 87 82     			call c,print_hdd_error
4862  812A DA 53 81     			jp c,copyF_RL_FAT_one1      ;ошибка в имени
4863  812D 11 B3 BC     			ld  de,file_fcb_tmp
4864  8130 CD A8 B1     			call  DrvFAT.FileNameTo8dot3
4865  8133              			; ld  de,file_fcb_tmp
4866  8133              			; ld  bc,file_name_len
4867  8133              			; ldir
4868  8133 DD 21 B3 BC  			ld  ix,file_fcb_tmp
4869  8137 CD BB A6     			call  DrvFAT.fatEraseEntry
4870  813A DC 87 82     			call c,print_hdd_error
4871  813D DA 53 81     			jp c,copyF_RL_FAT_one1
4872  8140              			; ld  hl,(CLS_CurrDir+0)
4873  8140              			; ld  de,(CLS_CurrDir+2)
4874  8140 CD 4D AC     			call  DrvFAT.fcbSetCLSCurrDir
4875  8143 DD CB 1E A6  			res  4,(ix+DrvFAT.fcbType)    ;файл
4876  8147 11 00 00     			ld  de,#0000
4877  814A 21 00 00     			ld  hl,#0000    ;size
4878  814D CD EB AC     			call  DrvFAT.DEHL2fcbSize
4879  8150 CD 0B A9     			call  DrvFAT.fatCreateFile
4880  8153              copyF_RL_FAT_one1
4881  8153 21 FF FF     			ld  hl,#FFFF
4882  8156 22 10 8D     			ld  (SecDIRinBuf+2),hl
4883  8159 3A D3 8A     			ld  a,(PartitionNum)
4884  815C DD 77 1F     			ld  (ix+DrvFAT.fcbPart),a
4885  815F              			;загрузка в fcbOffset указателя в файле
4886  815F 11 00 00     			ld de,0
4887  8162 21 00 00     			ld hl,0
4888  8165 CD D1 AC     			call DrvFAT.DEHL2fcbOffset
4889  8168 DD E1        			pop ix
4890  816A DC 87 82     			call c,print_hdd_error
4891  816D DA 3B 68     			jp c,copyF_LR_error
4892  8170
4893  8170
4894  8170
4895  8170              			;начинаем копировать файл
4896  8170
4897  8170 2A 88 73     			ld hl,(copyF_RL_source_file) ;указатель на запись о файле
4898  8173
4899  8173 11 C0 B3     			ld de,trn_buf+16 ;перекинем имя файла в запрос
4900  8176 01 0C 00     			ld bc,file_name_len
4901  8179 ED B0        			ldir
4902  817B 3E 02        			ld a,2 ;Тип пакета Запрос приёма файла 1024 байт
4903  817D 32 B3 B3     			ld (trn_buf+3),a
4904  8180
4905  8180 21 00 00     			ld hl,0
4906  8183 22 B4 B3     			ld (trn_buf+4),hl ;с нулевой части
4907  8186
4908  8186              			;размер файла
4909  8186 2A 88 73     			ld hl,(copyF_RL_source_file) ;указатель
4910  8189 01 0C 00     			ld bc,12
4911  818C 09           			add hl,bc
4912  818D 7E           			ld a,(hl)
4913  818E 32 BC B3     			ld (trn_buf+12),a
4914  8191 23           			inc hl
4915  8192 7E           			ld a,(hl)
4916  8193 32 BD B3     			ld (trn_buf+13),a
4917  8196 23           			inc hl
4918  8197 7E           			ld a,(hl)
4919  8198 32 BE B3     			ld (trn_buf+14),a
4920  819B 23           			inc hl
4921  819C 7E           			ld a,(hl)
4922  819D 32 BF B3     			ld (trn_buf+15),a
4923  81A0
4924  81A0              			;цикл
4925  81A0
4926  81A0              copyF_RL_FAT3
4927  81A0 CD 37 79     	call check_init_r ;авто проверка инициализации
4928  81A3
4929  81A3 DD E5        			push ix
4930  81A5 E1           			pop hl
4931  81A6 CD 01 72     			call print_progress
4932  81A9
4933  81A9 3A 04 5C     			ld a,(23556) ;сист. переменная нажатая клавиша
4934  81AC FE 20        			cp " "
4935  81AE 20 0D        			jr nz,copyF_RL_FAT2 ;продолжим
4936  81B0 21 5F 75     			ld hl,mes_stopped ;прервём
4937  81B3 CD 62 77     			call print_sys
4938  81B6 CD 9A 6E     			call wait_releas
4939  81B9 3E FF        			ld a,255
4940  81BB 3F           			ccf ;C=1
4941  81BC C9           			ret
4942  81BD
4943  81BD              copyF_RL_FAT2
4944  81BD 21 B0 B3     			ld hl,trn_buf ;откуда
4945  81C0 11 20 00     			ld de,pack_size_32_com ;размер
4946  81C3 CD 4B 7A     			call Wifi.tcpSend ;отправить
4947  81C6 38 D8        			jr c,copyF_RL_FAT3 ;если ошибка, то новая попытка
4948  81C8
4949  81C8 21 D2 73     			ld hl,mes_req_part_file ;сообщение пока ждём ответ
4950  81CB CD 62 77     			call print_sys
4951  81CE
4952  81CE 21 00 F6     			ld hl,rec_buf ;куда
4953  81D1 22 D8 79     			ld (Wifi.buffer_pointer),hl
4954  81D4 CD 8D 7A     			call Wifi.getPacket ;приём
4955  81D7 30 02        			jr nc,copyF_RL_FAT_check_pass1
4956  81D9 18 C5        			jr copyF_RL_FAT3 ;если ошибка, то новая попытка
4957  81DB
4958  81DB              copyF_RL_FAT_check_pass1	;принят пакет
4959  81DB 21 16 74     			ld hl,mes_rec_part_file ;сообщение
4960  81DE CD 62 77     			call print_sys
4961  81E1 21 00 F6     	ld hl,rec_buf
4962  81E4 01 20 04     	ld bc,pack_size_1024_com+pack_size_32_com
4963  81E7 ED 43 91 73  	ld (check_sum_size),bc ;задать длину пакета для подсчёта
4964  81EB 0E 03        			ld c,3 ; Тип пакета Файл 1024
4965  81ED CD 3B 6E     			call check_pack
4966  81F0 30 03        			jr nc,copyF_RL_FAT_check_pass
4967  81F2              			;call init_dev
4968  81F2 C3 A0 81     			jp copyF_RL_FAT3 ;если ошибка, то новая попытка
4969  81F5
4970  81F5              copyF_RL_FAT_check_pass	;проверка прошла
4971  81F5
4972  81F5
4973  81F5
4974  81F5              	;запишем 1 сектор 1024
4975  81F5 DD E5        	push ix
4976  81F7 01 00 04     	ld bc,2*512 ;на запись 1024
4977  81FA              	;проверка на последнюю часть файла
4978  81FA DD 7C        	ld a,xh
4979  81FC B7           	or a
4980  81FD 20 0F        	jr nz,copyF_RL_FAT_write_no_last
4981  81FF DD 7D        	ld a,xl
4982  8201 FE 01        	cp 1
4983  8203 20 09        	jr nz,copyF_RL_FAT_write_no_last
4984  8205 2A 8F 73     	ld hl,(copyF_FAT_RL_last_part)	;остаток
4985  8208 7C           	ld a,h
4986  8209 B5           	or l
4987  820A 28 02        	jr z,copyF_RL_FAT_write_no_last ;если = 0
4988  820C 44           	ld b,h
4989  820D 4D           	ld c,l
4990  820E
4991  820E              copyF_RL_FAT_write_no_last
4992  820E DD 21 B3 BC  	ld ix,file_fcb_tmp
4993  8212 21 20 F6     	ld hl,rec_buf+32 ;адрес принятого пакета
4994  8215
4995  8215              ;запись данных из памяти в файл
4996  8215              ;  файл должен быть открыт
4997  8215              ;  в fcb должны быть установлены: fcbName, fcbExt, fcbClsFile, fcbClsDIR,
4998  8215              ;    fcbSize, fcbOffset, fcbPart
4999  8215              ;вх:  ix - адрес fcb
5000  8215              ;     hl - адрес в памяти для записи
5001  8215              ;     bc - количество байт для записи
5002  8215              ;вых: cy=1 ошибки
5003  8215              ;        a=errNumTooBig - слишком большой размер, более #FFFF кластеров
5004  8215              ;        a=errRWnum - код ошибки
5005  8215              ;        a=errFileEmpty - нулевой размер файла
5006  8215              ;        a=errDiskNoSpace
5007  8215              ;        a=errInvalidPart
5008  8215              ;        a=errEoF - файл прервался
5009  8215              ;        a=errFileNotFound
5010  8215              ;     cy=0 данные записаны
5011  8215              ;       hl следующий адрес для записи
5012  8215 CD 41 A5     	call DrvFAT.WriteDataToFile
5013  8218 DD E1        	pop ix
5014  821A DC 87 82     	call c,print_hdd_error
5015  821D DA 3B 68     	jp c,copyF_LR_error
5016  8220
5017  8220
5018  8220 2A B4 B3     			ld hl,(trn_buf+4) ;следующая честь файла
5019  8223 23           			inc hl
5020  8224 22 B4 B3     			ld (trn_buf+4),hl
5021  8227
5022  8227 DD 2B        			dec ix
5023  8229 DD 7D        			ld a,xl
5024  822B DD B4        			or xh
5025  822D C2 A0 81     			jp nz,copyF_RL_FAT3
5026  8230
5027  8230
5028  8230 CD 73 6F     			call printcat_l
5029  8233 CD CE 6E     			call printcat_r
5030  8236 AF           			xor a ;C=0
5031  8237 C9           			ret
5032  8238
5033  8238
5034  8238
5035  8238
5036  8238
5037  8238
5038  8238
5039  8238
5040  8238              ;узнать дексриптор файла фат из каталога слева
5041  8238              ;вх: A - номер файла в каталоге
5042  8238              ;вых: ix - дескриптор
5043  8238              calc_cat_fat_deskr
5044  8238 DD 6F        			ld      ixl,a
5045  823A DD 26 00     			ld 		ixh,0
5046  823D DD 29                    add    ix,ix ;2
5047  823F DD 29        			add    ix,ix ;4
5048  8241 DD 29        			add    ix,ix ;8
5049  8243 DD 29        			add    ix,ix ;16
5050  8245 DD 29        			add    ix,ix ;32
5051  8247 01 00 D0     			ld bc,cat_l
5052  824A DD 09        			add ix,bc
5053  824C C9           			ret
5054  824D
5055  824D
5056  824D
5057  824D              format_name_fat_dot ;подогнать имя 8+3 под стандарт filename.ext
5058  824D              ;вх: HL - имя в каталоге
5059  824D E5           	push hl
5060  824E 21 D3 BC     	ld hl,file_name_cur
5061  8251 11 D4 BC     	ld de,file_name_cur+1 ;почистить
5062  8254 01 0B 00     	ld bc,file_name_len-1
5063  8257 36 00        	ld (hl),0
5064  8259 ED B0        	ldir
5065  825B
5066  825B E1           	pop hl
5067  825C E5           	push hl
5068  825D
5069  825D 11 D3 BC     	ld de,file_name_cur ;куда
5070  8260 01 FF 08     	ld bc,#08ff
5071  8263              format_name_fat_dot_cl
5072  8263 7E           	ld a,(hl)
5073  8264 FE 21        	cp " "+1
5074  8266 38 04        	jr c,format_name_fat_dot_skip
5075  8268 ED A0        	ldi
5076  826A 10 F7        	djnz format_name_fat_dot_cl
5077  826C              format_name_fat_dot_skip
5078  826C 3E 2E        	ld a,"."
5079  826E 12           	ld (de),a
5080  826F
5081  826F 13           	inc de
5082  8270 E1           	pop hl
5083  8271 01 08 00     	ld bc,8 ;перейти на расширение
5084  8274 09           	add hl,bc
5085  8275
5086  8275 01 FF 03     	ld bc,#03ff
5087  8278              format_name_fat_dot_cl2
5088  8278 7E           	ld a,(hl)
5089  8279 FE 21        	cp " "+1
5090  827B 38 04        	jr c,format_name_fat_dot_skip2
5091  827D ED A0        	ldi
5092  827F 10 F7        	djnz format_name_fat_dot_cl2
5093  8281              format_name_fat_dot_skip2
5094  8281 AF           	xor a ;в конце 0
5095  8282 12           	ld (de),a
5096  8283 21 D3 BC     	ld hl,file_name_cur
5097  8286 C9           	ret
5098  8287
5099  8287              ;печать номера ошибки HDD в системной строке
5100  8287              print_hdd_error
5101  8287 F5           	push af
5102  8288              	;пропуск некоторых ошибок
5103  8288 FE 71        	cp #71
5104  828A 28 2A        	jr z,print_hdd_error_skip
5105  828C E5           	push hl
5106  828D D5           	push de
5107  828E C5           	push bc
5108  828F DD E5        	push ix
5109  8291 4F           	ld c,a
5110  8292 E6 F0        	and %11110000
5111  8294 CB 3F        	srl a
5112  8296 CB 3F        	srl a
5113  8298 CB 3F        	srl a
5114  829A CB 3F        	srl a
5115  829C CD B8 82     	call print_hdd_error_to_hex
5116  829F 32 D0 82     	ld (mes_hdd_error_num),a
5117  82A2 79           	ld a,c
5118  82A3 E6 0F        	and %00001111
5119  82A5 CD B8 82     	call print_hdd_error_to_hex
5120  82A8 32 D1 82     	ld (mes_hdd_error_num+1),a
5121  82AB 21 C4 82     	ld hl,mes_hdd_error
5122  82AE CD 62 77     	call print_sys
5123  82B1 DD E1        	pop ix
5124  82B3 C1           	pop bc
5125  82B4 D1           	pop de
5126  82B5 E1           	pop hl
5127  82B6              print_hdd_error_skip
5128  82B6 F1           	pop af
5129  82B7 C9           	ret
5130  82B8              print_hdd_error_to_hex
5131  82B8 FE 0A        	cp 10
5132  82BA 30 03        	jr nc,print_hdd_error_to_hex1
5133  82BC C6 30        	add "0" ;0-9
5134  82BE C9           	ret
5135  82BF              print_hdd_error_to_hex1 ;A-F
5136  82BF D6 0A        	sub 10
5137  82C1 C6 41        	add "A"
5138  82C3 C9           	ret
5139  82C4
5140  82C4 44 69 73 6B  mes_hdd_error db "Disk error #"
5140  82C8 20 65 72 72
5140  82CC 6F 72 20 23
5141  82D0 30 30 00     mes_hdd_error_num db "00",0
5142  82D3
5143  82D3              		;align 256
5144  82D3              font    insert  "FONT.C" ;шрифт
5145  8AD3
5146  8AD3              	;org #a000
5147  8AD3              	;incbin "_cat.txt" ;тестовый каталог
5148  8AD3
5149  8AD3              ;для драйвера HDD
5150  8AD3 00           PartitionNum db 0 ;
5151  8AD4 00           _ExtFlags db 0 ;флаги внешней программы
5152  8AD5 00 00 00...  _BufSecHdd ds #200 ;буфер для драйвера HDD
5153  8CD5 00 00 00...  _VarsFAT ds #5B ;адрес блока переменных
5154  8D30              ;различные буфера
5155  8D30 00 00 00...  _Buf4File	ds #200 ;буфер для чтения файла
5156  8F30              _Buf4MBR	equ _BufSecHdd ;ds #200 ;буфер с сектором MBR
5157  8F30 00 00 00...  _Buf4LFN	ds #100 ;буфер для создания записей с длинным именем
5158  9030 00 00 00...  _Buf4DIR	ds #200 ;буфер для загрузки сектора DIR (каталога)
5159  9230 00 00 00...  _Buf4FAT	ds #200 ;буфер для загрузки сектора FAT
5160  9430 00 00 00...  _CurrentPath ds #100 ;буфер текущего пути
5161  9530 00 00 00...  _tmp_fcb	ds #20 ;для временного хранения fcb
5162  9550 00 00 00...  BufIDsd ds #200 ;буфер для SD (нужен?)
5163  9750
5164  9750 00 00 00...  _msSMUC	  ds	11		;SMUC master
5165  975B 00 00 00...  _slSMUC	  ds	11		;SMUC slave
5166  9766 00 00 00...  _msNemo	  ds	11		;Nemo master
5167  9771 00 00 00...  _slNemo	  ds	11		;Nemo slave
5168  977C 00 00 00...  _msATM	  ds	11		;ATM IDE master
5169  9787 00 00 00...  _slATM	  ds	11		;ATM IDE slave
5170  9792 00 00 00...  _msPROFI	  ds	11		;Profi IDE master
5171  979D 00 00 00...  _slPROFI	  ds	11		;Profi IDE slave
5172  97A8 00 00 00...  _cardZC	  ds	11		;ZC SD Є ав 
5173  97B3 00 00 00...  _mDivMMC	  ds	11		;DivMMC master
5174  97BE 00 00 00...  _sDivMMC	  ds	11		;DivMMC slave
5175  97C9
5176  97C9              		include "Drivers/InitHDD/init.a80"
# file opened: Drivers/InitHDD/init.a80
   1+ 97C9              ;------------------------------------------------------------------------------
   2+ 97C9              ; ⢠ 㯭 ࠧ  
   3+ 97C9              ;:  a - ⨢ ஫ HDD/SD
   4+ 97C9              ;: hl,a - ⢮ ன
   5+ 97C9              ;     typeDrive - ନ஢ ⠡
   6+ 97C9              ;
   7+ 97C9              navGetNumDrives
   8+ 97C9              ;
   9+ 97C9              ;஢ઠ  DivMMC
  10+ 97C9              	IFDEF	useDivMMC
  11+ 97C9 ~            	 di
  12+ 97C9 ~            	 ld	a,#80
  13+ 97C9 ~            	 out	(#E3),a
  14+ 97C9 ~            	 ld	hl,(#0002)
  15+ 97C9 ~            	 ld	de,#5E00
  16+ 97C9 ~            	 or	a
  17+ 97C9 ~            	 sbc	hl,de
  18+ 97C9 ~            	 jr	nz,goto514		;DivMMC  
  19+ 97C9 ~            ; ⪫祭 ᪠஢ SMUCv1, ATM-IDE
  20+ 97C9 ~            	 IFDEF	SMUC
  21+ 97C9 ~            	  ld	(_msSMUC+#0A),a
  22+ 97C9 ~            	 ENDIF
  23+ 97C9 ~            	 IFDEF	ATMide
  24+ 97C9 ~            	  ld	(_msATM+#0A),a
  25+ 97C9 ~            	 ENDIF
  26+ 97C9 ~            	 IFDEF	PROFIide
  27+ 97C9 ~            	  ld	(_msPROFI+#0A),a
  28+ 97C9 ~            	 ENDIF
  29+ 97C9 ~            	 call	#1FFA			;몫祭 rom DivMMC
  30+ 97C9 ~            goto514	 ei
  31+ 97C9              	ENDIF
  32+ 97C9
  33+ 97C9              ;樠 ஫஢  ன  
  34+ 97C9 11 C4 98     	ld	de,typeDrive
  35+ 97CC D5           	push	de
  36+ 97CD 06 08        	ld	b,DrvHDD.devNums
  37+ 97CF 21 FF 97     	ld	hl,tablDev
  38+ 97D2 DD 21 D5 8A  	ld	ix,_Buf4MBR
  39+ 97D6 3E FF        cng_19	ld	a,#FF
  40+ 97D8 C5           loop061	push	bc
  41+ 97D9 4E           	ld	c,(hl)
  42+ 97DA 23           	inc	hl
  43+ 97DB 46           	ld	b,(hl)
  44+ 97DC 23           	inc	hl
  45+ 97DD C5           	push	bc
  46+ 97DE FD E1        	pop	iy
  47+ 97E0 0F           	rrca
  48+ 97E1 30 05        	jr	nc,goto532
  49+ 97E3 F5           	push	af
  50+ 97E4 CD 17 98     	call	proc_11			;䨪 ஢/SD 
  51+ 97E7 F1           	pop	af
  52+ 97E8 23           goto532	inc	hl
  53+ 97E9 C1           	pop	bc
  54+ 97EA 10 EC        	djnz	loop061
  55+ 97EC EB           	ex	de,hl
  56+ 97ED D1           	pop	de
  57+ 97EE
  58+ 97EE              ; ⢠  ࠧ
  59+ 97EE B7           	or	a
  60+ 97EF ED 52        	sbc	hl,de			;⢮  ࠧ
  61+ 97F1 7D           	ld	a,l
  62+ 97F2 C6 04        	add	a,#04			;+fdd
  63+ 97F4 2E 16        	ld	l,22
  64+ 97F6 BD           	cp	l
  65+ 97F7 38 01        	jr	c,goto312
  66+ 97F9 7D           	ld	a,l
  67+ 97FA 6F           goto312	ld	l,a
  68+ 97FB 32 E4 98     	ld	(numDrives),a
  69+ 97FE C9           	ret
  70+ 97FF
  71+ 97FF              ;⠡  ࠬ ன
  72+ 97FF              ;                        ccchpp
  73+ 97FF              tablDev
  74+ 97FF              ;	IFDEF	SMUCv2
  75+ 97FF 50 97        	 dw _msSMUC
  75+ 9801 00              db %00000000	;SMUC v2 master
  76+ 9802              ;	ENDIF
  77+ 9802              ;	IFDEF	SMUCv1
  78+ 9802 50 97        	 dw _msSMUC
  78+ 9804 08              db %00001000	;SMUC v1 master
  79+ 9805              ;	ENDIF
  80+ 9805              ;	IFDEF	NemoStd
  81+ 9805 66 97        	 dw _msNemo
  81+ 9807 10              db %00010000	;Nemo master
  82+ 9808              ;	ENDIF
  83+ 9808              ;	IFDEF	NemoA8
  84+ 9808 66 97        	 dw _msNemo
  84+ 980A 18              db %00011000	;Nemo A8 master
  85+ 980B              ;	ENDIF
  86+ 980B              ;	IFDEF	ATMide
  87+ 980B 7C 97        	 dw _msATM
  87+ 980D 20               db %00100000	;ATM ide master
  88+ 980E              ;	ENDIF
  89+ 980E              ;	IFDEF	PROFIide
  90+ 980E 92 97        	 dw _msPROFI
  90+ 9810 28             db %00101000	;ATM ide master
  91+ 9811              ;	ENDIF
  92+ 9811              ;	IFDEF	ZC
  93+ 9811 A8 97        	 dw _cardZC
  93+ 9813 30              db %00110000	;SD ZC
  94+ 9814              ;	ENDIF
  95+ 9814              ;	IFDEF	DivMMC
  96+ 9814 B3 97        	 dw _mDivMMC
  96+ 9816 38             db %00111000	;SD DivMMC master
  97+ 9817              ;	ENDIF
  98+ 9817
  99+ 9817              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 100+ 9817              ;䨪 ஫  ன  
 101+ 9817              ;:  hl -   ⠡  ࠬ ன
 102+ 9817              ;     de -   ⠡ ࠧ typeDrive
 103+ 9817              ;     ix -    㧪 ᥪ 䨪樨
 104+ 9817              ;     iy -  砫  ६  master  SD 
 105+ 9817              ;: de -    ⠡ ࠧ typeDrive
 106+ 9817              ;     iy,bc,a - ???
 107+ 9817              ;
 108+ 9817 7E           proc_11	ld	a,(hl)
 109+ 9818 2F           	cpl
 110+ 9819 E6 30        	and	%00110000
 111+ 981B 28 07        	jr	z,loop060		; SD 
 112+ 981D FD 7E 0A     	ld	a,(iy+#0A)		;master
 113+ 9820 FD B6 15     	or	(iy+#0A+11)		;slave
 114+ 9823 F8           	ret	m			;  ஢ 
 115+ 9824
 116+ 9824              ;䨪 ன
 117+ 9824              ;  ⠭ ன⢠ ⥪騬
 118+ 9824 7E           loop060	ld	a,(hl)
 119+ 9825 07           	rlca
 120+ 9826 07           	rlca
 121+ 9827 E6 10        	and	#10
 122+ 9829 FD 77 0A     	ld	(iy+#0A),a
 123+ 982C 7E           	ld	a,(hl)
 124+ 982D CD E6 98     	call	DrvHDD.hddSetDevice
 125+ 9830              ;  䨪 
 126+ 9830 E5           	push	hl
 127+ 9831 D5           	push	de
 128+ 9832 E6 38        	and	%00111000
 129+ 9834 FE 30        	cp	#30
 130+ 9836 28 0D        	jr	z,goto512		; ZC
 131+ 9838 30 0D        	jr	nc,goto108		; MMC
 132+ 983A CD 7B 99     	call	DrvHDD.kHddCheck	;஢ਬ tr-dos  smuc v1
 133+ 983D D4 7E 99     	call	nc,DrvHDD.kPortsOn	;稬   ATM
 134+ 9840 D4 69 99     	call	nc,DrvHDD.kHddTestInit
 135+ 9843 18 19        	jr	goto513
 136+ 9845              ;  䨪 SD  ZC
 137+ 9845 CB D6        goto512	set	2,(hl)			; ZC ⮫쪮  
 138+ 9847 F3           goto108	di
 139+ 9848 CD 69 99     	call	DrvHDD.kHddTestInit	;樠 SD 
 140+ 984B 21 50 95     	ld	hl,BufIDsd
 141+ 984E D4 D5 9D     	call	nc,DrvHDD.sdReadCID
 142+ 9851 E5           	push	hl
 143+ 9852 D4 D0 9D     	call	nc,DrvHDD.sdReadCSD
 144+ 9855 E1           	pop	hl			;hl=BufIDsd+#10
 145+ 9856 F5           	push	af
 146+ 9857 D4 58 9D     	call	nc,DrvHDD.sdCalcCapacity
 147+ 985A DB 7B        	in	a,(#7B)			;몫稬 
 148+ 985C F1           	pop	af
 149+ 985D FB           	ei
 150+ 985E              ;  ⠭ ६ ன⢠  ନ஢ ⠡  㯭묨 ࠧ
 151+ 985E D1           goto513	pop	de
 152+ 985F D4 FE 98     	call	nc,DrvHDD.devSetVars
 153+ 9862 D4 72 98     	call	nc,proc_10		;ନ஢ ⠡  㯭묨 ࠧ
 154+ 9865 E1           	pop	hl
 155+ 9866 01 0B 00     	ld	bc,11
 156+ 9869 FD 09        	add	iy,bc
 157+ 986B CB 56        	bit	2,(hl)
 158+ 986D CB D6        	set	2,(hl)
 159+ 986F 28 B3        	jr	z,loop060
 160+ 9871 C9           	ret
 161+ 9872
 162+ 9872              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 163+ 9872              ;ନ஢ ⠡  㯭묨 ࠧ  
 164+ 9872              ;:  (drvDevice) -  ஫    
 165+ 9872              ;     de -   ⠡ ࠧ typeDrive
 166+ 9872              ;: de -    ⠡ ࠧ typeDrive
 167+ 9872              ;     b=#00
 168+ 9872              ;     hl,c,a - ???
 169+ 9872              ;
 170+ 9872 D5           proc_10	push	de
 171+ 9873 CD 98 98     	call	navFindPart
 172+ 9876 D1           	pop	de
 173+ 9877 D8           	ret	c			; ⥪饬   ࠧ
 174+ 9878 EB           	ex	de,hl
 175+ 9879 F5           	push	af
 176+ 987A 3A 4F A4     	ld	a,(DrvHDD.drvDevice)
 177+ 987D E6 3C        	and	%00111100
 178+ 987F 4F           	ld	c,a			;   ࢮ ࠧ
 179+ 9880 F1           	pop	af
 180+ 9881 06 04        	ld	b,#04
 181+ 9883 36 00        loop059	ld	(hl),#00
 182+ 9885 1F           	rra
 183+ 9886 30 0A        	jr	nc,goto106		; ࠧ
 184+ 9888 71           	ld	(hl),c
 185+ 9889 CB F6        	set	6,(hl)			;=%01??zhpp MFS
 186+ 988B 1F           	rra
 187+ 988C 30 02        	jr	nc,goto107		; MFS
 188+ 988E CB FE        	set	7,(hl)			;=%11??zhpp  FAT
 189+ 9890 23           goto107	inc	hl
 190+ 9891 17           	rla
 191+ 9892 1F           goto106	rra
 192+ 9893 0C           	inc	c
 193+ 9894 10 ED        	djnz	loop059
 194+ 9896 EB           	ex	de,hl
 195+ 9897 C9           	ret
 196+ 9898
 197+ 9898              ;------------------------------------------------------------------------------
 198+ 9898              ; ࠧ FAT32  MFS  ⥪饬 
 199+ 9898              ;:  ---
 200+ 9898              ;: cy=1 訡 ⥭/ࠧ  
 201+ 9898              ;       a=#66  MBR
 202+ 9898              ;       a=errInvalidPart ࠧ  
 203+ 9898              ;     cy=0 ࠧ() ()
 204+ 9898              ;       a,c - १
 205+ 9898              ;       bit 1-0 ⨯ 0 ࠧ =%00 ࠧ   ⥭
 206+ 9898              ;                               =%01  MFS ࠧ
 207+ 9898              ;                               =%11  FAT32 ࠧ
 208+ 9898              ;       bit 3-2 ⨯ 1 ࠧ
 209+ 9898              ;       bit 5-4 ⨯ 2 ࠧ
 210+ 9898              ;       bit 7-6 ⨯ 3 ࠧ
 211+ 9898              ;
 212+ 9898              navFindPart
 213+ 9898              ;
 214+ 9898 01 00 04     	ld	bc,#0400
 215+ 989B C5           loop058	push	bc
 216+ 989C 3A 4F A4     	ld	a,(DrvHDD.drvDevice)
 217+ 989F E6 FC        	and	#FC
 218+ 98A1 05           	dec	b
 219+ 98A2 B0           	or	b
 220+ 98A3 6F           	ld	l,a			; ࠧ
 221+ 98A4 CD 3C AE     	call	DrvFAT.GetAdrMFSorFAT
 222+ 98A7 C1            	pop	bc
 223+ 98A8 38 09        	jr	c,goto104		;訡 ⥭/ ࠧ  
 224+ 98AA FE 53        	cp	#53
 225+ 98AC              	IFNDEF	useMFS
 226+ 98AC 28 09        	jr	z,goto329
 227+ 98AE              	ENDIF
 228+ 98AE CB 11        	rl	c
 229+ 98B0 37           	scf
 230+ 98B1 18 06        	jr	goto105
 231+ 98B3 FE 6D        goto104	cp	DrvFAT.errInvalidPart
 232+ 98B5 20 0B        	jr	nz,goto092		;訡 ⥭/  MBR
 233+ 98B7 CB 11        goto329	rl	c
 234+ 98B9 CB 11        goto105	rl	c
 235+ 98BB 10 DE        	djnz	loop058
 236+ 98BD 79           	ld	a,c
 237+ 98BE B7           	or	a
 238+ 98BF C0           	ret	nz
 239+ 98C0 3E 6D        	ld	a,DrvFAT.errInvalidPart
 240+ 98C2 37           goto092	scf
 241+ 98C3 C9           	ret
 242+ 98C4
# file closed: Drivers/InitHDD/init.a80
5177  98C4              		include "Drivers/InitHDD/init2.a80"
# file opened: Drivers/InitHDD/init2.a80
   1+ 98C4                         ;!!冷  !!  2 ६
   2+ 98C4              typeCat
   3+ 98C4              ;	   db 0 ;1 ⨯ ⠫ ( ᯮ짮  )
   4+ 98C4              		;=#00 롮 ᪮
   5+ 98C4              		;=#01 롮 䠩  FDD
   6+ 98C4              		;=#02 롮 䠩  .trd 䠩 FAT ࠧ
   7+ 98C4              		;=#03 롮 䠩  ࠧ ࠧ MFS
   8+ 98C4              		;=#04 롮 䠩  FAT ࠧ
   9+ 98C4              		;=#05 롮 ࠧ ࠧ MFS
  10+ 98C4              		;=#06 롮 ࠧ ᪠  ࠧ MFS
  11+ 98C4              		;=#07 롮 䠩  ⠫ WiFi
  12+ 98C4              		;=#08 롮 䠩  ࠧ ⠫ WiFi
  13+ 98C4              		;7,=1  樨: 롮 ᪮
  14+ 98C4
  15+ 98C4              curDrive
  16+ 98C4              ;	   db 0	;1 ⥪饥 ன⢮ ( ⥪饣 ன⢠)
  17+ 98C4              		;=0..3 fdd
  18+ 98C4              		;=4 tape
  19+ 98C4              		;=5..n  ࠧ  ᯨ᪥ typeDrive
  20+ 98C4
  21+ 98C4 00 00 00...  typeDrive  ds 28;28 ᯨ᮪ 㯭 ࠧ  
  22+ 98E0 00 00 00 00             ds 4 ;4 ᯨ᮪ 㯭 ࠧ  SD 
  23+ 98E4              		;7,=0/1 ⨯ ࠧ MFS/FAT
  24+ 98E4              		;6,=1 ࠧ 
  25+ 98E4              		;5-3,=???  ன⢠: =000 SMUC v2
  26+ 98E4              		;                           =001 SMUC v1
  27+ 98E4              		;                           =010 Nemo
  28+ 98E4              		;                           =011 Nemo A8
  29+ 98E4              		;                           =100 ATM IDE
  30+ 98E4              		;                           =101 IDE ???   ᯮ
  31+ 98E4              		;                           =110 SD ZC
  32+ 98E4              		;                           =111 SD ??   ᯮ
  33+ 98E4              		;2,=0/1 hdd master/slave
  34+ 98E4              		;0..1,=??  ࠧ
  35+ 98E4
  36+ 98E4 00 00        numDrives    dw 0		;2 ⢮ ன
  37+ 98E6
# file closed: Drivers/InitHDD/init2.a80
5178  98E6              		include "Drivers/DrvHDD/DrvHDD.main.a80"
# file opened: Drivers/DrvHDD/DrvHDD.main.a80
   1+ 98E6              ;ࠩ ࠡ  ஬
   2+ 98E6              ;HDD Driver v1.00/v1.10
   3+ 98E6              ;(c) 2023-2024 LW aka PLM
   4+ 98E6              ;
   5+ 98E6              ;Date Creating: 24.08.2023
   6+ 98E6              ;Last   Update: 05.09.2024
   7+ 98E6              ;Last  Edition: 07.09.2024
   8+ 98E6              ;
   9+ 98E6              ;:
  10+ 98E6              ;DrvHDD.main.a80	-  䠩
  11+ 98E6              ;DrvHDD.kernal1_00.a80	-  ᠭ ஫஢ IDE  v1.00
  12+ 98E6              ;DrvHDD.kernal1_10.a80	-  ᠭ ஫஢ IDE  v1.10
  13+ 98E6              ;DrvHDD.hdd.a80		- 楤  ࠡ  ⥫
  14+ 98E6              ;DrvHDD.spi.a80		- 楤  ࠡ  ⠬ ஫஢ SD
  15+ 98E6              ;DrvHDD.ide.a80		- 楤  ࠡ  ⠬ ஫஢ IDE
  16+ 98E6              ;DrvHDD.calc.a80	- 楤  ⥬᪨ ⮢
  17+ 98E6              ;DrvHDD.var1_00.a80	- ६  v1.00
  18+ 98E6              ;DrvHDD.var1_10.a80	- ६  v1.10
  19+ 98E6              ;DrvHDD.lua		- LUA
  20+ 98E6              ;
  21+ 98E6              ;------------------------------------------------------------------------------
  22+ 98E6              ; 樨
  23+ 98E6              	DEVICE 	ZXSPECTRUM128
  24+ 98E6              	INCLUDE "DrvHDD.lua"
# file opened: Drivers/DrvHDD/DrvHDD.lua
   1++98E6              	LUA
   2++98E6 ~
   3++98E6 ~            	local nameflog = "DrvHDD.lua.info"
   4++98E6 ~            	local flog = nil
   5++98E6 ~            	local blname={}
   6++98E6 ~            	blname[1] ="DrvHDD.Start"
   7++98E6 ~            	blname[2] ="DrvHDD.End"
   8++98E6 ~
   9++98E6 ~            	if flog==nil then flog=io.open(nameflog,"w") end
  10++98E6 ~
  11++98E6 ~            	plen = sj.get_label(blname[1])
  12++98E6 ~            	flog:write(" 砫 Drv Hdd","\t"," = ",string.format('0x%04X', plen)," = ",plen,"\n")
  13++98E6 ~
  14++98E6 ~            	plen = sj.get_label(blname[2]) - sj.get_label(blname[1])
  15++98E6 ~            	flog:write("  ࠩ","\t"," = ",string.format('0x%04X', plen)," = ",plen,"\n")
  16++98E6 ~
  17++98E6 ~            	flog:flush ()
  18++98E6 ~
  19++98E6              	ENDLUA
  20++98E6
  21++98E6
# file closed: Drivers/DrvHDD/DrvHDD.lua
  25+ 98E6              ;	PAGE	#XX
  26+ 98E6              	MODULE	DrvHDD
  27+ 98E6
  28+ 98E6              ;------------------------------------------------------------------------------
  29+ 98E6              ;᫮ ࠭樨
  30+ 98E6
  31+ 98E6              	DEFINE	ver1_10		;ᡮઠ ᨨ 1.10
  32+ 98E6              ;	DEFINE	ver1_00		;ᡮઠ ᨨ 1.00
  33+ 98E6              	DEFINE	DrvHddExtVars	;६ ࠭  ࠩ
  34+ 98E6              	DEFINE	AllDevice	;ᯮ짮  ஫
  35+ 98E6              	DEFINE	SMUCv2		;প SMUC v2
  36+ 98E6              	DEFINE	SMUCv1		;প SMUC v1 (१ ⥭ )
  37+ 98E6              	DEFINE	NemoStd		;প NEMO
  38+ 98E6              	DEFINE	NemoA8		;প NEMO A8
  39+ 98E6              	DEFINE	ATMide		;প ATM-IDE
  40+ 98E6              	DEFINE	PROFIide	;প PROFI-IDE
  41+ 98E6              	DEFINE	ZC		;প Z-Controller
  42+ 98E6              	DEFINE	DivMMC		;প DivMMC
  43+ 98E6              	DEFINE	MultiRW		;⥭ 㯯 ᥪ஢
  44+ 98E6              	DEFINE	LBA32		;প LBA32 樨
  45+ 98E6              	DEFINE	offCACHE	;⪫ 
  46+ 98E6              ;	DEFINE	scrATM80x25	;⥪⮢ ࠭ ATM
  47+ 98E6              	DEFINE	scrATMstd	;⠭ ࠭ ATM
  48+ 98E6              ;	DEFINE	onlyRead	;⮫쪮 ⥭
  49+ 98E6              ;	DEFINE	noTestTrDos	; ஢ 稥  Tr-Dos 楤 ⥭/    SMUC
  50+ 98E6              ;	DEFINE	openDOS		;⥭  
  51+ 98E6              ;	DEFINE	forGMXloader	; 稪 GMX
  52+ 98E6
  53+ 98E6              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  54+ 98E6              ;४ ᫮ ࠭樨  ᨬ  
  55+ 98E6              	IFDEF	AllDevice
  56+ 98E6              	 IFNDEF	SMUCv2		;প SMUC v2
  57+ 98E6 ~            	 DEFINE	SMUCv2		;প SMUC v2
  58+ 98E6              	 ENDIF
  59+ 98E6              	 IFNDEF	SMUCv1		;প SMUC v1 (१ ⥭ )
  60+ 98E6 ~            	 DEFINE	SMUCv1		;প SMUC v1 (१ ⥭ )
  61+ 98E6              	 ENDIF
  62+ 98E6              	 IFNDEF	NemoStd		;প NEMO
  63+ 98E6 ~            	 DEFINE	NemoStd		;প NEMO
  64+ 98E6              	 ENDIF
  65+ 98E6              	 IFNDEF	NemoA8		;প NEMO A8
  66+ 98E6 ~            	 DEFINE	NemoA8		;প NEMO A8
  67+ 98E6              	 ENDIF
  68+ 98E6              	 IFNDEF	ATMide		;প ATM-IDE
  69+ 98E6 ~            	 DEFINE	ATMide		;প ATM-IDE
  70+ 98E6              	 ENDIF
  71+ 98E6              	 IFNDEF	PROFIide	;প PROFI-IDE
  72+ 98E6 ~            	 DEFINE	PROFIide	;প PROFI-IDE
  73+ 98E6              	 ENDIF
  74+ 98E6              	 IFNDEF	ZC		;প Z-Controller
  75+ 98E6 ~            	 DEFINE	ZC		;প Z-Controller
  76+ 98E6              	 ENDIF
  77+ 98E6              	 IFNDEF	DivMMC		;প DivMMC
  78+ 98E6 ~            	 DEFINE	DivMMC		;প DivMMC
  79+ 98E6              	 ENDIF
  80+ 98E6              	ENDIF
  81+ 98E6              	IFDEF	SMUCv1
  82+ 98E6              	 IFNDEF	SMUC
  83+ 98E6              	 DEFINE	SMUC
  84+ 98E6              	 ENDIF
  85+ 98E6              	ENDIF
  86+ 98E6              	IFDEF	SMUCv2
  87+ 98E6              	 IFNDEF	SMUC
  88+ 98E6 ~            	 DEFINE	SMUC
  89+ 98E6              	 ENDIF
  90+ 98E6              	ENDIF
  91+ 98E6              	IFDEF	NemoStd
  92+ 98E6              	 IFNDEF	NEMO
  93+ 98E6              	 DEFINE	NEMO
  94+ 98E6              	 ENDIF
  95+ 98E6              	ENDIF
  96+ 98E6              	IFDEF	NemoA8
  97+ 98E6              	 IFNDEF	NEMO
  98+ 98E6 ~            	 DEFINE	NEMO
  99+ 98E6              	 ENDIF
 100+ 98E6              	ENDIF
 101+ 98E6              	IFDEF	PROFIide
 102+ 98E6              	 IFDEF	MultiRW
 103+ 98E6              	 UNDEFINE MultiRW
 104+ 98E6              	 ENDIF
 105+ 98E6              	ENDIF
 106+ 98E6              	IFDEF	ZC
 107+ 98E6              	 IFNDEF	LBA32
 108+ 98E6 ~            	 DEFINE	LBA32		;প LBA32 ॠ樨
 109+ 98E6              	 ENDIF
 110+ 98E6              	 IFNDEF	SDcard
 111+ 98E6              	 DEFINE	SDcard
 112+ 98E6              	 ENDIF
 113+ 98E6              	ENDIF
 114+ 98E6              	IFDEF	DivMMC
 115+ 98E6              	 IFNDEF	LBA32
 116+ 98E6 ~            	 DEFINE	LBA32		;প LBA32 ॠ樨
 117+ 98E6              	 ENDIF
 118+ 98E6              	 IFNDEF	SDcard
 119+ 98E6 ~            	 DEFINE	SDcard
 120+ 98E6              	 ENDIF
 121+ 98E6              	ENDIF
 122+ 98E6
 123+ 98E6              ;------------------------------------------------------------------------------
 124+ 98E6              ;⠭ ࠩ
 125+ 98E6
 126+ 98E6              ;ﭨ  #DFFD  祭/몫祭 ⮢ PROFI IDE
 127+ 98E6              baseDFFDon	equ	%00100000	; 祭
 128+ 98E6              baseDFFDoff	equ	%00000000	; 몫祭
 129+ 98E6
 130+ 98E6              		IFDEF	scrATM80x25
 131+ 98E6 ~            atmXX77		 equ	%00000110	; ⥪⮢ ࠭ 80x25
 132+ 98E6              		ENDIF
 133+ 98E6              		IFDEF	scrATMstd
 134+ 98E6              atmXX77		 equ	%00000011	; ⠭⭮ ࠭
 135+ 98E6              		ENDIF
 136+ 98E6
 137+ 98E6              ;------------------------------------------------------------------------------
 138+ 98E6              ;譨 ६
 139+ 98E6
 140+ 98E6              ;䫠 譥 ணࠬ
 141+ 98E6              ;5,=1 ஢     SD
 142+ 98E6              ;
 143+ 98E6              ExtFlags	equ _ExtFlags ;#XXXX
 144+ 98E6
 145+ 98E6              ;⠩ 
 146+ 98E6              busyTimeOut	equ #20;#4FD3
 147+ 98E6              cmdTimeOut	equ #10;#14E6
 148+ 98E6              dataTimeOut	equ #80;#C350
 149+ 98E6
 150+ 98E6              ;᫨  ᫮ DrvHddExtVars
 151+ 98E6              ;	IFDEF	DrvHddExtVars
 152+ 98E6              ;msSMUC	 equ	0	;SMUC master
 153+ 98E6              ;slSMUC	 equ	0	;SMUC slave
 154+ 98E6              ;msNemo	 equ	0	;Nemo master
 155+ 98E6              ;slNemo	 equ	0	;Nemo slave
 156+ 98E6              ;msATM	 equ	0	;ATM IDE master
 157+ 98E6              ;slATM	 equ	0	;ATM IDE slave
 158+ 98E6              ;msPROFI	 equ	0	;PROFI IDE master
 159+ 98E6              ;slPROFI	 equ	0	;PROFI IDE slave
 160+ 98E6              ;cardZC	 equ	0	;ZC SD 
 161+ 98E6              ;mDivMMC	 equ	0	;DivMMC master
 162+ 98E6              ;sDivMMC	 equ	0	;DivMMC slave
 163+ 98E6              ;	ENDIF
 164+ 98E6
 165+ 98E6              ;᫨  ᫮ DrvHddExtVars
 166+ 98E6                IFDEF  DrvHddExtVars
 167+ 98E6              msSMUC  equ  _msSMUC  ;SMUC master
 168+ 98E6              slSMUC  equ  _slSMUC  ;SMUC slave
 169+ 98E6              msNemo  equ  _msNemo  ;Nemo master
 170+ 98E6              slNemo  equ  _slNemo  ;Nemo slave
 171+ 98E6              msATM  equ  _msATM  ;ATM IDE master
 172+ 98E6              slATM  equ  _slATM  ;ATM IDE slave
 173+ 98E6              msPROFI  equ  _msPROFI;PROFI IDE master
 174+ 98E6              slPROFI  equ  _msPROFI;PROFI IDE slave
 175+ 98E6              cardZC  equ  _cardZC  ;ZC SD 
 176+ 98E6              mDivMMC  equ  _mDivMMC;DivMMC master
 177+ 98E6              sDivMMC  equ  _sDivMMC;DivMMC slave
 178+ 98E6                ENDIF
 179+ 98E6
 180+ 98E6              ;------------------------------------------------------------------------------
 181+ 98E6              ;⠭ ࠩ
 182+ 98E6
 183+ 98E6              ; ᥬ஢:
 184+ 98E6              AdrDrvBegin	equ $
 185+ 98E6
 186+ 98E6              ;ࠧ 
 187+ 98E6              BufSecHdd	equ _BufSecHdd ;#XXXX	;  㧪/ ᥪ
 188+ 98E6              Buf4MBR		equ BufSecHdd	;  㧪 ᥪ MBR
 189+ 98E6
 190+ 98E6              ; 楤  Tr-Dos  SMUC
 191+ 98E6              dosOutPort equ	#3FF0		; 楤     SMUC v1
 192+ 98E6              dosInPort  equ	#3FF3		; 楤 ⥭   SMUC v1
 193+ 98E6
 194+ 98E6              ; 訡
 195+ 98E6              errOK		equ #00
 196+ 98E6              errNumTooBig	equ #11 ;number too big
 197+ 98E6              errInvFileName	equ #45 ;invalid file name
 198+ 98E6              errFileNotFound	equ #48 ;file not found
 199+ 98E6              errDiskNoSpace	equ #49	;disk no space
 200+ 98E6              errRWnum	equ #50 ;R/W error _᫮_
 201+ 98E6              errHddNotFound	equ #56 ;hard disk not found
 202+ 98E6              errHddRWerror	equ #57 ;hard disk R/W error #nnnn
 203+ 98E6              errHddBusy	equ #60 ;busy not found
 204+ 98E6              errHddNotReady	equ #61 ;hard disk not ready
 205+ 98E6              errHddNotData	equ #62 ;hard disk data not ready
 206+ 98E6              errInvPartMg	equ #63 ;invalid partition manager
 207+ 98E6              errPartNotFound	equ #66 ;partition not found
 208+ 98E6              errInvalidPart	equ #6D ;invalid partition
 209+ 98E6              errNoMBR	equ #6E ;MBR not found
 210+ 98E6              errInvalidFile	equ #70 ;invalid file
 211+ 98E6              errEoF		equ #71 ;end of file
 212+ 98E6              errPathEmpty	equ #72 ;path empty
 213+ 98E6              errFileExist	equ #73 ;file exist
 214+ 98E6              errDirNotEmpty	equ #74 ;dir not empty
 215+ 98E6              errFileEmpty	equ #75 ;file empty
 216+ 98E6
 217+ 98E6              ;------------------------------------------------------------------------------
 218+ 98E6
 219+ 98E6              	ORG		AdrDrvBegin
 220+ 98E6              Start
 221+ 98E6              	IFDEF		ver1_10
 222+ 98E6              	 INCLUDE	"DrvHDD.kernal1_10.a80"
# file opened: Drivers/DrvHDD/DrvHDD.kernal1_10.a80
   1++98E6              ;६ HDD Driver
   2++98E6              ;䠩 DrvHDD.var.a80
   3++98E6              ;
   4++98E6              ;hddSetDevice		⠭ ⥪騬 ன⢠
   5++98E6              ;devSetVars		⠭ ६ ࠭  Master/Slave
   6++98E6              ;devSetDevice		⠭ ୠ  ஫
   7++98E6              ;
   8++98E6              ;------------------------------------------------------------------------------
   9++98E6              hddSetDevice	ifused
  10++98E6              ;⠭ ⥪騬 ன⢠
  11++98E6              ;:  a -  ⥪饣 ஫   ( ଠ PartitionNum)
  12++98E6              ;: cy=0
  13++98E6              ;
  14++98E6              ;hddSetDevice
  15++98E6              ;
  16++98E6 E5           	push	hl
  17++98E7 F5           	push	af
  18++98E8 D5           	push	de
  19++98E9 C5           	push	bc
  20++98EA
  21++98EA              ;஢ઠ ⥪饣 ன⢠
  22++98EA 2A 4F A4     	ld	hl,(drvDevice)
  23++98ED 67           	ld	h,a
  24++98EE AD           	xor	l
  25++98EF E6 3C        	and	%00111100
  26++98F1 28 28        	jr	z,goto065
  27++98F3
  28++98F3              ;⠭ ६
  29++98F3 E6 38        	and	%00111000
  30++98F5 7C           	ld	a,h
  31++98F6 32 4F A4     	ld	(drvDevice),a
  32++98F9 C4 3A 99     	call	nz,devSetDevice
  33++98FC 18 04        	jr	goto066
  34++98FE 18 FE        	jr	devSetVars
  35++9900              	org	$-2
  36++98FE
  37++98FE              	endif
  38++98FE
  39++98FE              ;------------------------------------------------------------------------------
  40++98FE              devSetVars	ifused
  41++98FE              ;⠭ ६ ࠭ ன⢠
  42++98FE              ;:  5-2,(drvDevice) -  ஫  ன⢠  
  43++98FE              ;: cy=0
  44++98FE              ;
  45++98FE              ;devSetVars
  46++98FE              ;
  47++98FE E5           	push	hl
  48++98FF F5           	push	af
  49++9900 D5           	push	de
  50++9901 C5           	push	bc
  51++9902
  52++9902              ;㥬 ६
  53++9902 3A 4F A4     goto066	ld	a,(drvDevice)
  54++9905 0F           	rrca
  55++9906 E6 1E        	and	#1E
  56++9908 5F           	ld	e,a
  57++9909 16 00        	ld	d,#00
  58++990B 21 69 A4     	ld	hl,tblDev
  59++990E 19           	add	hl,de
  60++990F 5E           	ld	e,(hl)
  61++9910 23           	inc	hl
  62++9911 56           	ld	d,(hl)
  63++9912 EB           	ex	de,hl
  64++9913 11 5E A4     	ld	de,CurrentDev
  65++9916 01 0B 00     	ld	bc,EndCurrentDev-CurrentDev
  66++9919 ED B0        	ldir
  67++991B
  68++991B              ;⠭ 祭   1F6
  69++991B 3A 68 A4     goto065	ld	a,(devFlags)
  70++991E E6 50        	and	%01010000
  71++9920 F6 A0        	or	%10100000
  72++9922 32 55 A4     	ld	(idePort1F6),a
  73++9925
  74++9925              ;⠭ master/slave  DivMMC
  75++9925              	IFDEF	DivMMC
  76++9925 3A 4F A4     	 ld	a,(drvDevice)
  77++9928 E6 3C        	 and	%00111100
  78++992A FE 38        	 cp	#38
  79++992C 38 35        	 jr	c,goto064
  80++992E E6 04        	 and	%00000100
  81++9930 3E FE        	 ld	a,%11111110		;=#FE
  82++9932 28 01        	 jr	z,goto067
  83++9934 07           	 rlca				;=#FD
  84++9935 32 88 99     goto067	 ld	(kPortCSlow),a
  85++9938              	ENDIF
  86++9938 18 29        	jr	goto064
  87++993A 18 FE        	jr	devSetDevice
  88++993C              	org	$-2
  89++993A
  90++993A              	endif
  91++993A
  92++993A              ;------------------------------------------------------------------------------
  93++993A              devSetDevice	ifused
  94++993A              ;⠭ ୠ  ஫
  95++993A              ;:  5-3,(drvDevice) -  ஫
  96++993A              ;: cy=0
  97++993A              ;
  98++993A              ;devSetDevice
  99++993A              ;
 100++993A E5           	push	hl
 101++993B F5           	push	af
 102++993C D5           	push	de
 103++993D C5           	push	bc
 104++993E CD 81 99     	call	kPortsOff		;⪫稬 ।騩
 105++9941 21 96 99     	ld	hl,devKernals
 106++9944 01 2D 00     	ld	bc,endKernal-startKernal
 107++9947 1E FF        	ld	e,devMask
 108++9949 3A 4F A4     	ld	a,(drvDevice)
 109++994C 0F           	rrca
 110++994D 0F           	rrca
 111++994E 0F           	rrca
 112++994F E6 07        	and	#07
 113++9951 28 08        	jr	z,goto062
 114++9953 CB 1B        loop024	rr	e
 115++9955 30 01        	jr	nc,goto063
 116++9957 09           	add	hl,bc
 117++9958 3D           goto063	dec	a
 118++9959 20 F8        	jr	nz,loop024
 119++995B 11 69 99     goto062	ld	de,startKernal
 120++995E ED B0        	ldir
 121++9960 CD 7E 99     	call	kPortsOn
 122++9963 C1           goto064	pop	bc
 123++9964 D1           	pop	de
 124++9965 F1           	pop	af
 125++9966 E1           	pop	hl
 126++9967 B7           	or	a
 127++9968 C9           	ret
 128++9969
 129++9969              	endif
 130++9969
 131++9969              ;------------------------------------------------------------------------------
 132++9969              ;⪫祭 
 133++9969              	MACRO	noCache
 134++9969 ~            	 IFDEF	offCACHE
 135++9969 ~            	  in	a,(#7B)
 136++9969 ~            	  ret
 137++9969 ~            	 ELSE
 138++9969 ~            	  or	a
 139++9969 ~            	  ret
 140++9969 ~            	  nop
 141++9969 ~            	 ENDIF
 142++9969              	ENDM
 143++9969
 144++9969              ;------------------------------------------------------------------------------
 145++9969              ; 㭪
 146++9969              	MACRO	NoFunct
 147++9969 ~            	 or	a
 148++9969 ~            	 ret
 149++9969 ~            	 nop
 150++9969              	ENDM
 151++9969
 152++9969              ;------------------------------------------------------------------------------
 153++9969              ;ୠ    ࠡ  ஫஬ IDE
 154++9969              ; 45 
 155++9969              ;
 156++9969              startKernal
 157++9969              ;
 158++9969              kHddTestInit	NoFunct		;+#00 0 ஢ઠ ⢮ 
 158++9969 B7          >	 or	a
 158++996A C9          >	 ret
 158++996B 00          >	 nop
 159++996C              kOut_C_A	NoFunct		;+#03 1   
 159++996C B7          >	 or	a
 159++996D C9          >	 ret
 159++996E 00          >	 nop
 160++996F              kIn_A_C		NoFunct		;+#06 2 ⥭ 
 160++996F B7          >	 or	a
 160++9970 C9          >	 ret
 160++9971 00          >	 nop
 161++9972              kHddWriteData	NoFunct		;+#09 3  ᥪ
 161++9972 B7          >	 or	a
 161++9973 C9          >	 ret
 161++9974 00          >	 nop
 162++9975              kHddReadData	NoFunct		;+#0C 4 ⥭ ᥪ
 162++9975 B7          >	 or	a
 162++9976 C9          >	 ret
 162++9977 00          >	 nop
 163++9978              kHddReset	NoFunct		;+#0F 5  
 163++9978 B7          >	 or	a
 163++9979 C9          >	 ret
 163++997A 00          >	 nop
 164++997B              kHddCheck	NoFunct		;+#12 6 ஢ઠ 祪 室  tr-dos  smuc v1
 164++997B B7          >	 or	a
 164++997C C9          >	 ret
 164++997D 00          >	 nop
 165++997E              kPortsOn	NoFunct		;+#15 7 祭 ⮢ ( ATM)
 165++997E B7          >	 or	a
 165++997F C9          >	 ret
 165++9980 00          >	 nop
 166++9981              kPortsOff	NoFunct		;+#18 8 ⪫祭 ⮢ ( ATM)
 166++9981 B7          >	 or	a
 166++9982 C9          >	 ret
 166++9983 00          >	 nop
 167++9984
 168++9984              kPortCONF			;+#nn   䨣樨  SD 
 169++9984 00 00        kPort1F0	dw	0	;+#nn   #1F0
 170++9986              kPortDATA			;+#nn     SD 
 171++9986 00 00        kPort1F1	dw	0	;+#nn   #1F1
 172++9988              kPortCSlow
 173++9988 00 00        kPort1F2	dw	0	;+#nn   #1F2
 174++998A              kPortCSHigh
 175++998A 00 00        kPort1F3	dw	0	;+#nn   #1F3
 176++998C 00 00        kPort1F4	dw	0	;+#nn   #1F4
 177++998E 00 00        kPort1F5	dw	0	;+#nn   #1F5
 178++9990 00 00        kPort1F6	dw	0	;+#nn   #1F6
 179++9992 00 00        kPort1F7	dw	0	;+#nn   #1F7
 180++9994 00 00        kPort3F6	dw	0	;+#nn   #3F6
 181++9996              endKernal
 182++9996
 183++9996              ;------------------------------------------------------------------------------
 184++9996              ;ୠ  ࠡ  ஫ࠬ
 185++9996              ;冷 ᯮ  
 186++9996              ;
 187++9996              devKernals
 188++9996              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 189++9996              ;ୠ  ࠡ  SMUC v2
 190++9996              		IFDEF	SMUCv2
 191++9996 C3 95 9B     ideSMUCv2	 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 192++9999 ED 79        		 out	(c),a		;1   
 193++999B C9           		 ret
 194++999C ED 78        		 in	a,(c)		;2 ⥭ 
 195++999E C9           		 ret
 196++999F              		 IFDEF	onlyRead
 197++999F ~            		  NoFunct
 198++999F              		 ELSE
 199++999F C3 65 A2     		  jp	hddWriteDataSv2	;3  ᥪ
 200++99A2              		 ENDIF
 201++99A2 C3 A4 A1     		 jp	hddReadDataSv2	;4 ⥭ ᥪ
 202++99A5 C3 02 A1     		 jp	hddResetSmuc	;5  
 203++99A8              		 NoFunct		;6 誠
 203++99A8 B7          >	 or	a
 203++99A9 C9          >	 ret
 203++99AA 00          >	 nop
 204++99AB              		 IFDEF	forGMXloader
 205++99AB ~            		  jp	Rom0ld.hddOpenDOS
 206++99AB ~            		  jp	Rom0ld.hddCloseDOS
 207++99AB              		 ELSE
 208++99AB              		  NoFunct		;7 誠
 208++99AB B7          >	 or	a
 208++99AC C9          >	 ret
 208++99AD 00          >	 nop
 209++99AE              		  NoFunct		;8 誠
 209++99AE B7          >	 or	a
 209++99AF C9          >	 ret
 209++99B0 00          >	 nop
 210++99B1              		 ENDIF
 211++99B1 BE F8        		 dw	#F8BE		;  #1F0
 212++99B3 BE F9        		 dw	#F9BE		;  #1F1
 213++99B5 BE FA        		 dw	#FABE		;  #1F2
 214++99B7 BE FB        		 dw	#FBBE		;  #1F3
 215++99B9 BE FC        		 dw	#FCBE		;  #1F4
 216++99BB BE FD        		 dw	#FDBE		;  #1F5
 217++99BD BE FE        		 dw	#FEBE		;  #1F6
 218++99BF BE FF        		 dw	#FFBE		;  #1F7
 219++99C1 BE FE        		 dw	#FEBE		;  #3F6
 220++99C3              		ENDIF
 221++99C3
 222++99C3              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 223++99C3              ;ୠ  ࠡ  SMUC v1 ( ⥭묨 ⠬)
 224++99C3              		IFDEF	SMUCv1
 225++99C3 C3 95 9B     ideSMUCv1	 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 226++99C6 C3 8C A3     		 jp	out_C_A		;1   
 227++99C9 C3 9B A3     		 jp	in_A_C		;2 ⥭ 
 228++99CC              		 IFDEF	onlyRead
 229++99CC ~            		  NoFunct
 230++99CC              		 ELSE
 231++99CC C3 F1 A1     		  jp	hddWriteDataSv1	;3  ᥪ
 232++99CF              		 ENDIF
 233++99CF C3 3A A1     		 jp	hddReadDataSv1	;4 ⥭ ᥪ
 234++99D2 C3 02 A1     		 jp	hddResetSmuc	;5  
 235++99D5              		 IFDEF	noTestTrDos
 236++99D5 ~            		  NoFunct		;6 誠
 237++99D5              		 ELSE
 238++99D5 C3 3E A3     		  jp	smucTest3FF0	;6 ஢ઠ 祪 室
 239++99D8              		 ENDIF
 240++99D8              		 NoFunct		;7 誠
 240++99D8 B7          >	 or	a
 240++99D9 C9          >	 ret
 240++99DA 00          >	 nop
 241++99DB              		 NoFunct		;8 誠
 241++99DB B7          >	 or	a
 241++99DC C9          >	 ret
 241++99DD 00          >	 nop
 242++99DE BE F8        		 dw	#F8BE		;  #1F0
 243++99E0 BE F9        		 dw	#F9BE		;  #1F1
 244++99E2 BE FA        		 dw	#FABE		;  #1F2
 245++99E4 BE FB        		 dw	#FBBE		;  #1F3
 246++99E6 BE FC        		 dw	#FCBE		;  #1F4
 247++99E8 BE FD        		 dw	#FDBE		;  #1F5
 248++99EA BE FE        		 dw	#FEBE		;  #1F6
 249++99EC BE FF        		 dw	#FFBE		;  #1F7
 250++99EE BE FE        		 dw	#FEBE		;  #3F6
 251++99F0              		ENDIF
 252++99F0
 253++99F0              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 254++99F0              ;ୠ  ࠡ  NEMO
 255++99F0              		IFDEF	NemoStd
 256++99F0 C3 95 9B     ideNemo		 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 257++99F3 ED 79        		 out	(c),a		;1   
 258++99F5 C9           		 ret
 259++99F6 ED 78        		 in	a,(c)		;2 ⥭ 
 260++99F8 C9           		 ret
 261++99F9              		 IFDEF	onlyRead
 262++99F9 ~            		  NoFunct
 263++99F9              		 ELSE
 264++99F9 C3 7B A2     		  jp	hddWriteDataN	;3  ᥪ
 265++99FC              		 ENDIF
 266++99FC C3 B8 A1     		 jp	hddReadDataN	;4 ⥭ ᥪ
 267++99FF C3 25 A1     		 jp	hddResetNemo	;5  
 268++9A02              		 NoFunct		;6 誠
 268++9A02 B7          >	 or	a
 268++9A03 C9          >	 ret
 268++9A04 00          >	 nop
 269++9A05              		 NoFunct		;7 誠
 269++9A05 B7          >	 or	a
 269++9A06 C9          >	 ret
 269++9A07 00          >	 nop
 270++9A08              		 noCache		;8 誠/⪫ 
 270++9A08             >	 IFDEF	offCACHE
 270++9A08 DB 7B       >	  in	a,(#7B)
 270++9A0A C9          >	  ret
 270++9A0B             >	 ELSE
 270++9A0B ~           >	  or	a
 270++9A0B ~           >	  ret
 270++9A0B ~           >	  nop
 270++9A0B             >	 ENDIF
 271++9A0B 10 FF        		 dw	#FF10		;  #1F0
 272++9A0D 30 FF        		 dw	#FF30		;  #1F1
 273++9A0F 50 FF        		 dw	#FF50		;  #1F2
 274++9A11 70 FF        		 dw	#FF70		;  #1F3
 275++9A13 90 FF        		 dw	#FF90		;  #1F4
 276++9A15 B0 FF        		 dw	#FFB0		;  #1F5
 277++9A17 D0 FF        		 dw	#FFD0		;  #1F6
 278++9A19 F0 FF        		 dw	#FFF0		;  #1F7
 279++9A1B C8 FF        		 dw	#FFC8		;  #3F6
 280++9A1D              		ENDIF
 281++9A1D
 282++9A1D              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 283++9A1D              ;ୠ  ࠡ  NEMO A8
 284++9A1D              		IFDEF	NemoA8
 285++9A1D C3 95 9B     ideNemoA8	 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 286++9A20 ED 79        		 out	(c),a		;1   
 287++9A22 C9           		 ret
 288++9A23 ED 78        		 in	a,(c)		;2 ⥭ 
 289++9A25 C9           		 ret
 290++9A26              		 IFDEF	onlyRead
 291++9A26 ~            		  NoFunct
 292++9A26              		 ELSE
 293++9A26 C3 91 A2     		  jp	hddWriteDataNA8	;3  ᥪ
 294++9A29              		 ENDIF
 295++9A29 C3 CC A1     		 jp	hddReadDataNA8	;4 ⥭ ᥪ
 296++9A2C C3 25 A1     		 jp	hddResetNemo	;5  
 297++9A2F              		 NoFunct		;6 誠
 297++9A2F B7          >	 or	a
 297++9A30 C9          >	 ret
 297++9A31 00          >	 nop
 298++9A32              		 NoFunct		;7 誠
 298++9A32 B7          >	 or	a
 298++9A33 C9          >	 ret
 298++9A34 00          >	 nop
 299++9A35              		 noCache		;8 誠/⪫ 
 299++9A35             >	 IFDEF	offCACHE
 299++9A35 DB 7B       >	  in	a,(#7B)
 299++9A37 C9          >	  ret
 299++9A38             >	 ELSE
 299++9A38 ~           >	  or	a
 299++9A38 ~           >	  ret
 299++9A38 ~           >	  nop
 299++9A38             >	 ENDIF
 300++9A38 10 FE        		 dw	#FE10		;  #1F0
 301++9A3A 30 FE        		 dw	#FE30		;  #1F1
 302++9A3C 50 FE        		 dw	#FE50		;  #1F2
 303++9A3E 70 FE        		 dw	#FE70		;  #1F3
 304++9A40 90 FE        		 dw	#FE90		;  #1F4
 305++9A42 B0 FE        		 dw	#FEB0		;  #1F5
 306++9A44 D0 FE        		 dw	#FED0		;  #1F6
 307++9A46 F0 FE        		 dw	#FEF0		;  #1F7
 308++9A48 C8 FE        		 dw	#FEC8		;  #3F6
 309++9A4A              		ENDIF
 310++9A4A
 311++9A4A              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 312++9A4A              ;ୠ  ࠡ  ATM-IDE
 313++9A4A              		IFDEF	ATMide
 314++9A4A C3 95 9B     ideATM		 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 315++9A4D ED 79        		 out	(c),a		;1   
 316++9A4F C9           		 ret
 317++9A50 ED 78        		 in	a,(c)		;2 ⥭ 
 318++9A52 C9           		 ret
 319++9A53              		 IFDEF	onlyRead
 320++9A53 ~            		  NoFunct
 321++9A53              		 ELSE
 322++9A53 C3 95 A2     		  jp	hddWriteDataAtm	;3  ᥪ
 323++9A56              		 ENDIF
 324++9A56 C3 D1 A1     		 jp	hddReadDataAtm	;4 ⥭ ᥪ
 325++9A59              		 NoFunct		;5 誠 ( )
 325++9A59 B7          >	 or	a
 325++9A5A C9          >	 ret
 325++9A5B 00          >	 nop
 326++9A5C              		 NoFunct		;6 誠
 326++9A5C B7          >	 or	a
 326++9A5D C9          >	 ret
 326++9A5E 00          >	 nop
 327++9A5F C3 7E A3     		 jp	atmPortsOn	;7 祭 ⮢ ATM
 328++9A62 C3 79 A3     		 jp	atmPortsOff	;8 몫祭 ⮢ ATM
 329++9A65 0F FE        		 dw	#FE0F		;  #1F0
 330++9A67 2F FE        		 dw	#FE2F		;  #1F1
 331++9A69 4F FE        		 dw	#FE4F		;  #1F2
 332++9A6B 6F FE        		 dw	#FE6F		;  #1F3
 333++9A6D 8F FE        		 dw	#FE8F		;  #1F4
 334++9A6F AF FE        		 dw	#FEAF		;  #1F5
 335++9A71 CF FE        		 dw	#FECF		;  #1F6
 336++9A73 EF FE        		 dw	#FEEF		;  #1F7
 337++9A75 FF FF        		 dw	#FFFF		;  #3F6 ()
 338++9A77              		ENDIF
 339++9A77
 340++9A77              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 341++9A77              ;ୠ  ࠡ  PROFIide
 342++9A77              		IFDEF	PROFIide
 343++9A77 C3 95 9B     idePROFI	 jp	hddHddIdent	;0 ஢ઠ ⢮ 
 344++9A7A ED 79        		 out	(c),a		;1   
 345++9A7C C9           		 ret
 346++9A7D C3 94 A3     		 jp	in_A_C_profi	;2 ⥭ 
 347++9A80              		 IFDEF	onlyRead
 348++9A80 ~            		  NoFunct
 349++9A80              		 ELSE
 350++9A80 C3 A8 A2     		  jp	hddWriteDataPrf	;3  ᥪ
 351++9A83              		 ENDIF
 352++9A83 C3 DC A1     		 jp	hddReadDataPrf	;4 ⥭ ᥪ
 353++9A86 C3 25 A1     		 jp	hddResetNemo	;5  
 354++9A89              		 NoFunct		;6 誠
 354++9A89 B7          >	 or	a
 354++9A8A C9          >	 ret
 354++9A8B 00          >	 nop
 355++9A8C C3 70 A3     		 jp	profiPortsOn	;7 祭 ⮢ PROFI
 356++9A8F C3 6C A3     		 jp	profiPortsOff	;8 몫祭 ⮢ PROFI
 357++9A92 CB FF        		 dw	#FFCB		;  #1F0
 358++9A94 EB 01        		 dw	#01EB		;  #1F1
 359++9A96 EB 02        		 dw	#02EB		;  #1F2
 360++9A98 EB 03        		 dw	#03EB		;  #1F3
 361++9A9A EB 04        		 dw	#04EB		;  #1F4
 362++9A9C EB 05        		 dw	#05EB		;  #1F5
 363++9A9E EB 06        		 dw	#06EB		;  #1F6
 364++9AA0 EB 07        		 dw	#07EB		;  #1F7
 365++9AA2 AB 06        		 dw	#06AB		;  #3F6
 366++9AA4 ~            /*
 367++9AA4 ~            		 dw	#F8EB		;  #1F0
 368++9AA4 ~            		 dw	#F9EB		;  #1F1
 369++9AA4 ~            		 dw	#FAEB		;  #1F2
 370++9AA4 ~            		 dw	#FBEB		;  #1F3
 371++9AA4 ~            		 dw	#FCEB		;  #1F4
 372++9AA4 ~            		 dw	#FDEB		;  #1F5
 373++9AA4 ~            		 dw	#FEEB		;  #1F6
 374++9AA4 ~            		 dw	#FFEB		;  #1F7
 375++9AA4 ~            		 dw	#00AB		;  #3F6
 376++9AA4 ~            */
 377++9AA4              		ENDIF
 378++9AA4
 379++9AA4              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 380++9AA4              ;ୠ  ࠡ  Z-Controller
 381++9AA4              		IFDEF	ZC
 382++9AA4 C3 ED 9D     sdZC		 jp	sdTestInit	;0 樠 SD 
 383++9AA7 ED 79        		 out	(c),a		;1   
 384++9AA9 C9           		 ret
 385++9AAA ED 78        		 in	a,(c)		;2 ⥭ 
 386++9AAC C9           		 ret
 387++9AAD              		 IFDEF	onlyRead
 388++9AAD ~            		  NoFunct
 389++9AAD              		 ELSE
 390++9AAD C3 39 9C     		  jp	sdWriteSecs_HL	;3  ᥪ/ ᥪ஢
 391++9AB0              		 ENDIF
 392++9AB0 C3 87 9C     		 jp	sdReadSecs_HL	;4 ⥭ ᥪ/ ᥪ஢
 393++9AB3              		 NoFunct		;5 誠
 393++9AB3 B7          >	 or	a
 393++9AB4 C9          >	 ret
 393++9AB5 00          >	 nop
 394++9AB6              		 NoFunct		;6 誠
 394++9AB6 B7          >	 or	a
 394++9AB7 C9          >	 ret
 394++9AB8 00          >	 nop
 395++9AB9              		 NoFunct		;7 誠
 395++9AB9 B7          >	 or	a
 395++9ABA C9          >	 ret
 395++9ABB 00          >	 nop
 396++9ABC              		 NoFunct		;8 誠
 396++9ABC B7          >	 or	a
 396++9ABD C9          >	 ret
 396++9ABE 00          >	 nop
 397++9ABF 77 00        		 dw	#0077		;  䨣樨  SD 
 398++9AC1 57 00        		 dw	#0057		;    SD 
 399++9AC3 01 00        		 dw	#01		; ᯮ
 400++9AC5 03 00        		 dw	#03		; ᯮ
 401++9AC7 00 00        		 dw	0		; ᯮ
 402++9AC9 00 00        		 dw	0		; ᯮ
 403++9ACB 00 00        		 dw	0		; ᯮ
 404++9ACD 00 00        		 dw	0		; ᯮ
 405++9ACF 00 00        		 dw	0		; ᯮ
 406++9AD1              		ENDIF
 407++9AD1
 408++9AD1              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 409++9AD1              ;ୠ  ࠡ  DivMMC
 410++9AD1              		IFDEF	DivMMC
 411++9AD1 C3 ED 9D     sdDivMMC	 jp	sdTestInit	;0 樠 SD 
 412++9AD4 ED 79        		 out	(c),a		;1   
 413++9AD6 C9           		 ret
 414++9AD7 ED 78        		 in	a,(c)		;2 ⥭ 
 415++9AD9 C9           		 ret
 416++9ADA              		 IFDEF	onlyRead
 417++9ADA ~            		  NoFunct
 418++9ADA              		 ELSE
 419++9ADA C3 39 9C     		  jp	sdWriteSecs_HL	;3  ᥪ/ ᥪ஢
 420++9ADD              		 ENDIF
 421++9ADD C3 87 9C     		 jp	sdReadSecs_HL	;4 ⥭ ᥪ/ ᥪ஢
 422++9AE0              		 NoFunct		;5 誠
 422++9AE0 B7          >	 or	a
 422++9AE1 C9          >	 ret
 422++9AE2 00          >	 nop
 423++9AE3              		 NoFunct		;6 誠
 423++9AE3 B7          >	 or	a
 423++9AE4 C9          >	 ret
 423++9AE5 00          >	 nop
 424++9AE6              		 NoFunct		;7 誠
 424++9AE6 B7          >	 or	a
 424++9AE7 C9          >	 ret
 424++9AE8 00          >	 nop
 425++9AE9              		 NoFunct		;8 誠
 425++9AE9 B7          >	 or	a
 425++9AEA C9          >	 ret
 425++9AEB 00          >	 nop
 426++9AEC E7 00        		 dw	#00E7		;  䨣樨  SD 
 427++9AEE EB 00        		 dw	#00EB		;    SD 
 428++9AF0 FE 00        		 dw	#FE		; ᯮ
 429++9AF2 FF 00        		 dw	#FF		; ᯮ
 430++9AF4 00 00        		 dw	0		; ᯮ
 431++9AF6 00 00        		 dw	0		; ᯮ
 432++9AF8 00 00        		 dw	0		; ᯮ
 433++9AFA 00 00        		 dw	0		; ᯮ
 434++9AFC 00 00        		 dw	0		; ᯮ
 435++9AFE              		ENDIF
 436++9AFE
 437++9AFE              ;==============================================================================
 438++9AFE
# file closed: Drivers/DrvHDD/DrvHDD.kernal1_10.a80
 223+ 9AFE              	ELSE
 224+ 9AFE ~            	 INCLUDE	"DrvHDD.kernal1_00.a80"
 225+ 9AFE              	ENDIF
 226+ 9AFE              	INCLUDE		"DrvHDD.hdd.a80"
# file opened: Drivers/DrvHDD/DrvHDD.hdd.a80
   1++9AFE              ;楤  HDD Driver. 楤  ࠡ  ⥫
   2++9AFE              ;䠩 DrvHDD.hdd.a80
   3++9AFE              ;
   4++9AFE              ;hddRdWrSectors		אַ ⥭/ 㯯 ᥪ஢  
   5++9AFE              ;hddSendCmdRW		⠭ ॣ஢    
   6++9AFE              ;			 ⥭/
   7++9AFE              ;hddReadMBRsec		⥭ ᥪ MBR  
   8++9AFE              ;RdSecHDD_DEHL		⥭ ᥪ     xE5A9
   9++9AFE              ;RdSecHDD_IX		⥭ ᥪ     ix
  10++9AFE              ;RdSecHDD_HL		⥭ ᥪ     HL
  11++9AFE              ;RdSecHDD_buf		⥭ ᥪ     xE5A9
  12++9AFE              ;WrSecHDD_DEHL		 ᥪ   xE5A9    
  13++9AFE              ;			 dehl
  14++9AFE              ;WrSecHDD_IX		 ᥪ   ix  
  15++9AFE              ;WrSecHDD_buf		 ᥪ   xE5A9  
  16++9AFE              ;WrSecHDD_HL		 ᥪ   HL  
  17++9AFE              ;hddSetVarLBAadr	  ⠭  ६  LBA/CHS
  18++9AFE              ;			 ᨬ  ஥
  19++9AFE              ;hddHddIdent		䨪 ⥪饣 ⪮ ᪠
  20++9AFE              ;
  21++9AFE              ;------------------------------------------------------------------------------
  22++9AFE              hddRdWrSectors	ifused
  23++9AFE ~            ;אַ ⥭/ 㯯 ᥪ஢  
  24++9AFE ~            ;:   ࢮ ᥪ   ⠭  ६
  25++9AFE ~            ;     hl -   ⥭
  26++9AFE ~            ;     b  - ⢮ ᥪ஢  ⥭
  27++9AFE ~            ;     cy=0/1 - ⥭/
  28++9AFE ~            ;     (AdrLBA32) - LBA  ࢮ ᥪ
  29++9AFE ~            ;: cy=1 訡 ⥭/
  30++9AFE ~            ;       a=#57 -  訡 ࠩ
  31++9AFE ~            ;       a=#60 busy not found
  32++9AFE ~            ;       a=#61 hard disk not ready
  33++9AFE ~            ;       a=#62 hard disk data not ready
  34++9AFE ~            ;
  35++9AFE ~            ;hddRdWrSectors
  36++9AFE ~            ;
  37++9AFE ~            	IFDEF	SDcard
  38++9AFE ~            	 IFDEF	ver1_10			; ᨨ v1.10
  39++9AFE ~            	  ld	a,(drvDevice)
  40++9AFE ~            	  cpl
  41++9AFE ~            	  rla
  42++9AFE ~            	  and	%01100001
  43++9AFE ~            	  rra
  44++9AFE ~            	  jr	nz,goto060		;ࠡ  ஬
  45++9AFE ~            	 ELSE				; ᨨ v1.00
  46++9AFE ~            	  ld	a,(selHdd)
  47++9AFE ~            	  bit	2,a
  48++9AFE ~            	  jr	z,goto060		;ࠡ  ஬
  49++9AFE ~            	 ENDIF
  50++9AFE ~            ;ࠡ  SD ⮩
  51++9AFE ~            	 ld	a,b
  52++9AFE ~            	 ld	(secCounter),a
  53++9AFE ~            	 push	hl
  54++9AFE ~            	 ld	hl,goto061
  55++9AFE ~            	 ex	(sp),hl
  56++9AFE ~            	 jp	c,sdWriteSecs_HL	;
  57++9AFE ~            	 jp	sdReadSecs_HL		;⥭
  58++9AFE ~            goto060
  59++9AFE ~            	ENDIF
  60++9AFE ~
  61++9AFE ~            ;ࠡ  ஬ (⥭ ᥪ஢ 㯯)
  62++9AFE ~            	IFDEF	MultiRW
  63++9AFE ~            	 call	hddSendCmdRW		;    ⥭/
  64++9AFE ~            	 jr	c,goto040		;訡
  65++9AFE ~            ;  ⥭/    㥬 hl
  66++9AFE ~            loop032	 push	bc
  67++9AFE ~            	 rr	c
  68++9AFE ~            	 push	af
  69++9AFE ~            	 call	nc,kHddReadData		;⥭
  70++9AFE ~            	 pop	af
  71++9AFE ~            	 call	c,kHddWriteData		;
  72++9AFE ~            	 pop	bc
  73++9AFE ~            	 inc	h
  74++9AFE ~            	 inc	h
  75++9AFE ~            	 djnz	loop032
  76++9AFE ~            ;ࠡ  ஬ (⥭ ᥪ஢  )
  77++9AFE ~            	ELSE
  78++9AFE ~            loop032	 call	hddSendCmdRW		;    ⥭/
  79++9AFE ~            	 jr	c,goto040		;訡
  80++9AFE ~            ;  ⥭/ ᥪ   㥬 hl
  81++9AFE ~            	 push	bc
  82++9AFE ~            	 rr	c
  83++9AFE ~            	 push	af
  84++9AFE ~            	 call	nc,kHddReadData		;⥭
  85++9AFE ~            	 pop	af
  86++9AFE ~            	 call	c,kHddWriteData		;
  87++9AFE ~            	 inc	h
  88++9AFE ~            	 inc	h
  89++9AFE ~            ;  ⠭  ᫥饣 ᥪ
  90++9AFE ~            	 push	hl
  91++9AFE ~            	 ld	hl,(AdrLBA32+0)		;  LBA32 ᥪ  ६
  92++9AFE ~            	 ld	de,(AdrLBA32+2)
  93++9AFE ~            	 inc	hl
  94++9AFE ~            	 ld	a,h
  95++9AFE ~            	 or	l
  96++9AFE ~            	 jr	nz,goto069
  97++9AFE ~            	 inc	de
  98++9AFE ~            goto069	 call	hddSetVarLBAadr
  99++9AFE ~            	 pop	hl
 100++9AFE ~            	 pop	bc
 101++9AFE ~            	 rr	c
 102++9AFE ~            	 djnz	loop032
 103++9AFE ~            	ENDIF
 104++9AFE ~
 105++9AFE ~            ;室
 106++9AFE ~            	call	hddCheckError		;஢ઠ 訡
 107++9AFE ~            goto040	call	c,kHddReset		;ணࠬ    訡
 108++9AFE ~            goto061	ld	hl,idePort1F2
 109++9AFE ~            	ld	(hl),#01
 110++9AFE ~            	ret
 111++9AFE ~
 112++9AFE              	endif
 113++9AFE
 114++9AFE              ;------------------------------------------------------------------------------
 115++9AFE              hddSendCmdRW	ifused
 116++9AFE ~            ;⠭ ॣ஢      ⥭/
 117++9AFE ~            ;:   ࢮ ᥪ   ⠭  ६
 118++9AFE ~            ;     b  - ⢮ ᥪ஢  ⥭
 119++9AFE ~            ;     cy=0/1 - ⥭/
 120++9AFE ~            ;: cy=1 訡 ⥭/
 121++9AFE ~            ;       a=#57 -  訡 ࠩ
 122++9AFE ~            ;       a=#60 busy not found
 123++9AFE ~            ;       a=#61 hard disk not ready
 124++9AFE ~            ;       a=#62 hard disk data not ready
 125++9AFE ~            ;     cy=0 訡  뫮
 126++9AFE ~            ;       hl,b -  
 127++9AFE ~            ;       0,c/e =0/1 - ⥭/
 128++9AFE ~            ;
 129++9AFE ~            ;hddSendCmdRW
 130++9AFE ~            ;
 131++9AFE ~            	push	hl
 132++9AFE ~            	push	bc
 133++9AFE ~            	push	af
 134++9AFE ~            	IFDEF	MultiRW
 135++9AFE ~            	 ld	a,b
 136++9AFE ~            	ELSE
 137++9AFE ~            	 ld	a,#01
 138++9AFE ~            	ENDIF
 139++9AFE ~            	ld	(idePort1F2),a
 140++9AFE ~            	ld	hl,idePort1F7r		;  : ⥭
 141++9AFE ~            	jr	nc,goto039
 142++9AFE ~            	inc	hl			;  : 
 143++9AFE ~            goto039	ld	a,(hl)
 144++9AFE ~            	call	hddSendCmd		;뫠  
 145++9AFE ~            	call	nc,hddWaitReadyData	; ⮢ HDD  । 
 146++9AFE ~            	pop	de
 147++9AFE ~            	pop	bc
 148++9AFE ~            	ld	c,e			;0,c=0/1 ⥭/
 149++9AFE ~            	pop	hl
 150++9AFE ~            	ret
 151++9AFE ~
 152++9AFE              	endif
 153++9AFE
 154++9AFE              ;------------------------------------------------------------------------------
 155++9AFE              hddReadMBRsec	ifused
 156++9AFE ~            ;⥭ ᥪ MBR  
 157++9AFE ~            ;: cy=1, z/nz 訡 ⥭
 158++9AFE ~            ;       a=errRWnum
 159++9AFE ~            ;     cy=0, nz  ᨣ MBR
 160++9AFE ~            ;     cy=0, z ᨣ 
 161++9AFE ~            ;
 162++9AFE ~            ;hddReadMBRsec
 163++9AFE ~            ;
 164++9AFE ~            	call	SetZeroDEHL
 165++9AFE ~            	ld	a,#01
 166++9AFE ~            	ld	(idePort1F2),a		;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
 167++9AFE ~               	call	RdSecHDD_DEHL		;⥭ 㫥 ᥪ     BufSecHdd
 168++9AFE ~            	ld	a,errRWnum
 169++9AFE ~            	ret	c			;訡 ⥭
 170++9AFE ~
 171++9AFE ~            ;஢ઠ ᨣ MBR
 172++9AFE ~            	ld	hl,(Buf4MBR+#1FE)
 173++9AFE ~            	ld	de,#AA55	;ᨣ (55h AAh)
 174++9AFE ~            	or	a
 175++9AFE ~            	sbc	hl,de
 176++9AFE ~            	scf
 177++9AFE ~            	ccf
 178++9AFE ~            	ret
 179++9AFE ~
 180++9AFE              	endif
 181++9AFE
 182++9AFE              ;------------------------------------------------------------------------------
 183++9AFE              RdSecHDD_DEHL	ifused
 184++9AFE              ;⥭ ᥪ     xE5A9
 185++9AFE              ;:  dehl - ᬥ饭  ᥪ (512b)  砫   㦭 ᥪ
 186++9AFE              ;: cy=0 -> hl -  
 187++9AFE              ;     cy=1 訡   -> a -  訡
 188++9AFE              ;       a=#57 hard disk R/W error
 189++9AFE              ;       a=#60 busy not found
 190++9AFE              ;       a=#61 hard disk not ready
 191++9AFE              ;       a=#62 hard disk data not ready
 192++9AFE              ;
 193++9AFE              ;RdSecHDD_DEHL
 194++9AFE              ;
 195++9AFE CD 5E 9B     	call	hddSetVarLBAadr		;  ⠭  ६  LBA/CHS  ᨬ  ஥
 196++9B01 18 05         	jr	RdSecHDD_buf
 197++9B03
 198++9B03              	endif
 199++9B03
 200++9B03              ;------------------------------------------------------------------------------
 201++9B03              RdSecHDD_IX	ifused
 202++9B03              ;⥭ ᥪ     ix
 203++9B03              ;  LBA  ᥪ   ⠭  ॣ 
 204++9B03              ;:  ix -    ⥭ ᥪ
 205++9B03              ;: cy=1 訡   -> a -  訡
 206++9B03              ;       a=#57 hard disk R/W error
 207++9B03              ;       a=#60 busy not found
 208++9B03              ;       a=#61 hard disk not ready
 209++9B03              ;       a=#62 hard disk data not ready
 210++9B03              ;
 211++9B03              ;RdSecHDD_IX
 212++9B03              ;
 213++9B03 DD E5        	push	ix
 214++9B05 E1           	pop	hl
 215++9B06 18 03        	jr	RdSecHDD_HL
 216++9B08              	endif
 217++9B08
 218++9B08              ;------------------------------------------------------------------------------
 219++9B08              RdSecHDD_buf	ifused
 220++9B08              ;⥭ ᥪ     xE5A9
 221++9B08              ;  LBA  ᥪ   ⠭  ॣ 
 222++9B08              ;: cy=1 訡   -> a -  訡
 223++9B08              ;       a=#57 hard disk R/W error
 224++9B08              ;       a=#60 busy not found
 225++9B08              ;       a=#61 hard disk not ready
 226++9B08              ;       a=#62 hard disk data not ready
 227++9B08              ;
 228++9B08              ;RdSecHDD_buf
 229++9B08              ;
 230++9B08 21 D5 8A     	ld	hl,BufSecHdd
 231++9B0B 18 FE        	jr	RdSecHDD_HL
 232++9B0D              	org	$-2
 233++9B0B              	endif
 234++9B0B
 235++9B0B              RdSecHDD_HL	ifused
 236++9B0B              ;
 237++9B0B              	IFDEF	SDcard
 238++9B0B              	 IFDEF	ver1_10			; ᨨ v1.10
 239++9B0B 3A 4F A4     	  ld	a,(drvDevice)
 240++9B0E 2F           	  cpl
 241++9B0F E6 30        	  and	%00110000
 242++9B11 CA 87 9C     	  jp	z,sdReadSecs_HL		;ࠡ  SD ⮩
 243++9B14              	 ELSE				; ᨨ v1.00
 244++9B14 ~            	  ld	a,(selHdd)
 245++9B14 ~            	  bit	2,a
 246++9B14 ~            	  jp	nz,sdReadSecs_HL	;ࠡ  SD ⮩
 247++9B14              	 ENDIF
 248++9B14              	ENDIF
 249++9B14 3A 59 A4     goto037	ld	a,(idePortErrCnt)	;⢮ ⥫ ⮪  ᥪ
 250++9B17 47           	ld	b,a
 251++9B18 C5           loop031	push	bc
 252++9B19 3A 56 A4     	ld	a,(idePort1F7r)		;  
 253++9B1C E5           	push	hl
 254++9B1D CD BF A2     	call	hddSendCmd		;뫠  
 255++9B20 D4 E4 A2     	call	nc,hddWaitReadyData	; ⮢ HDD  । 
 256++9B23 DC 78 99     	call	c,kHddReset		;訡
 257++9B26 E1           	pop	hl
 258++9B27 D4 75 99     	call	nc,kHddReadData		;⥭ 512b    㥬 hl
 259++9B2A D4 E5 A0     	call	nc,hddCheckError
 260++9B2D C1           	pop	bc
 261++9B2E D0           	ret	nc
 262++9B2F 10 E7        	djnz	loop031
 263++9B31 C9           	ret
 264++9B32
 265++9B32              	endif
 266++9B32
 267++9B32              ;------------------------------------------------------------------------------
 268++9B32              WrSecHDD_DEHL	ifused
 269++9B32 ~            ; ᥪ   xE5A9      dehl
 270++9B32 ~            ;:  dehl - LBA  ᥪ
 271++9B32 ~            ;: cy=1 訡   -> a -  訡
 272++9B32 ~            ;       a=#57 hard disk R/W error
 273++9B32 ~            ;       a=#60 busy not found
 274++9B32 ~            ;       a=#61 hard disk not ready
 275++9B32 ~            ;       a=#62 hard disk data not ready
 276++9B32 ~            ;
 277++9B32 ~            ;WrSecHDD_DEHL
 278++9B32 ~            ;
 279++9B32 ~            	call	hddSetVarLBAadr		;  ⠭  ६  LBA/CHS
 280++9B32 ~            	jr	WrSecHDD_buf		; ᥪ   xE5A9  
 281++9B32 ~
 282++9B32              	endif
 283++9B32
 284++9B32              ;------------------------------------------------------------------------------
 285++9B32              WrSecHDD_IX	ifused
 286++9B32              ; ᥪ   ix  
 287++9B32              ;  LBA  ᥪ   ⠭  ॣ 
 288++9B32              ;:  ix -     ᥪ
 289++9B32              ;: cy=1 訡   -> a -  訡
 290++9B32              ;       a=#57 hard disk R/W error
 291++9B32              ;       a=#60 busy not found
 292++9B32              ;       a=#61 hard disk not ready
 293++9B32              ;       a=#62 hard disk data not ready
 294++9B32              ;
 295++9B32              ;WrSecHDD_IX
 296++9B32              ;
 297++9B32 DD E5        	push	ix
 298++9B34 E1           	pop	hl
 299++9B35 18 00        	jr	WrSecHDD_HL
 300++9B37              	endif
 301++9B37
 302++9B37              ;------------------------------------------------------------------------------
 303++9B37              WrSecHDD_buf	ifused
 304++9B37 ~            ; ᥪ   Buf4MBR  
 305++9B37 ~            ;  LBA  ᥪ   ⠭  ॣ 
 306++9B37 ~            ;: cy=1 訡   -> a -  訡
 307++9B37 ~            ;       a=#57 hard disk R/W error
 308++9B37 ~            ;       a=#60 busy not found
 309++9B37 ~            ;       a=#61 hard disk not ready
 310++9B37 ~            ;       a=#62 hard disk data not ready
 311++9B37 ~            ;
 312++9B37 ~            ;WrSecHDD_buf
 313++9B37 ~            ;
 314++9B37 ~            	ld	hl,BufSecHdd
 315++9B37 ~            	jr	WrSecHDD_HL
 316++9B37 ~            	org	$-2
 317++9B37              	endif
 318++9B37
 319++9B37              WrSecHDD_HL	ifused
 320++9B37              ;
 321++9B37              	IFDEF	SDcard
 322++9B37              	 IFDEF	ver1_10			; ᨨ v1.10
 323++9B37 3A 4F A4     	  ld	a,(drvDevice)
 324++9B3A 2F           	  cpl
 325++9B3B E6 30        	  and	%00110000
 326++9B3D CA 39 9C     	  jp	z,sdWriteSecs_HL	;ࠡ  SD ⮩
 327++9B40              	 ELSE				; ᨨ v1.00
 328++9B40 ~            	  ld	a,(selHdd)
 329++9B40 ~            	  bit	2,a
 330++9B40 ~            	  jp	nz,sdWriteSecs_HL	;ࠡ  SD ⮩
 331++9B40              	 ENDIF
 332++9B40              	ENDIF
 333++9B40 3A 59 A4     goto036	ld	a,(idePortErrCnt)	;⢮ ⥫ ⮪  ᥪ
 334++9B43 47           	ld	b,a
 335++9B44 C5           loop030	push	bc
 336++9B45 3A 57 A4     	ld	a,(idePort1F7w)		;  
 337++9B48 E5           	push	hl
 338++9B49 CD BF A2     	call	hddSendCmd		;뫠  
 339++9B4C D4 E4 A2     	call	nc,hddWaitReadyData	; ⮢ HDD  । 
 340++9B4F DC 78 99     	call	c,kHddReset		;訡
 341++9B52 E1           	pop	hl
 342++9B53 D4 72 99     	call	nc,kHddWriteData	; 512b    㥬 hl
 343++9B56 D4 E5 A0     	call	nc,hddCheckError	;஢ઠ  訡  室
 344++9B59 C1           	pop	bc
 345++9B5A D0           	ret	nc			; 訡
 346++9B5B 10 E7        	djnz	loop030			; ࠧ ⠥ 
 347++9B5D C9           	ret
 348++9B5E
 349++9B5E              	endif
 350++9B5E
 351++9B5E              ;------------------------------------------------------------------------------
 352++9B5E              hddSetVarLBAadr	ifused
 353++9B5E              ;  ⠭  ६  LBA/CHS  ᨬ  ஥
 354++9B5E              ;:  dehl - LBA  ᥪ
 355++9B5E              ;: (idePort1F2) ࠬ LBA/CHS  ᨬ  ஥
 356++9B5E              ;     (AdrLBA32) = dehl 
 357++9B5E              ;
 358++9B5E              ;hddSetVarLBAadr
 359++9B5E              ;
 360++9B5E 22 5A A4     	ld	(AdrLBA32+0),hl		;  LBA32 ᥪ  ६
 361++9B61 ED 53 5C A4  	ld	(AdrLBA32+2),de
 362++9B65              	IFDEF	ver1_10			; ᨨ v1.10
 363++9B65 3A 4F A4     	 ld	a,(drvDevice)
 364++9B68 2F           	 cpl
 365++9B69 E6 30        	 and	%00110000
 366++9B6B C8           	 ret	z			;ࠡ  SD  ० LBA
 367++9B6C 3A 68 A4      	 ld	a,(devFlags)
 368++9B6F E6 F0        	 and	#F0
 369++9B71 F6 A0        	 or	%10100000
 370++9B73              	ELSE				; ᨨ v1.00
 371++9B73 ~            	 ld	a,(selHdd)
 372++9B73 ~            	 bit	2,a
 373++9B73 ~            	 ret	nz			;ࠡ  SD  ० LBA
 374++9B73 ~            	 ld	a,(devPort1F6)
 375++9B73 ~            	 and	#F0
 376++9B73              	ENDIF
 377++9B73 CB 77        	bit	6,a
 378++9B75 20 14        	jr	nz,goto035		;ࠡ  ஬  ० LBA
 379++9B77
 380++9B77              ;ࠡ  ஬  ० CHS
 381++9B77 F5           	push	af
 382++9B78 CD AE A3     	call	hddLBAtoCHS		;८ࠧ  LBA  C/H/S
 383++9B7B E6 0F        	and	#0F
 384++9B7D E1           	pop	hl
 385++9B7E B4           	or	h
 386++9B7F 32 55 A4     	ld	(idePort1F6),a		;
 387++9B82 79           	ld	a,c
 388++9B83 32 52 A4     	ld	(idePort1F3),a		;ᥪ
 389++9B86 ED 53 53 A4  	ld	(idePort1F4),de		;樫
 390++9B8A C9           	ret
 391++9B8B
 392++9B8B              ;  LBA ᥪ  ६
 393++9B8B 22 52 A4     goto035	ld	(idePort1F3),hl
 394++9B8E B2           	or	d
 395++9B8F 57           	ld	d,a
 396++9B90 ED 53 54 A4  	ld	(idePort1F5),de
 397++9B94 C9           	ret
 398++9B95
 399++9B95              	endif
 400++9B95
 401++9B95              ;------------------------------------------------------------------------------
 402++9B95              hddHddIdent	ifused
 403++9B95              ;䨪 ⥪饣 ⪮ ᪠
 404++9B95              ;:  ix -    㧪 ᥪ 䨪樨
 405++9B95              ;     iy -  砫  ६ 
 406++9B95              ;     4,(iy+#0A) =0/1 master/slave
 407++9B95              ;: cy=1 訡
 408++9B95              ;       a=#56 hard disk not found
 409++9B95              ;       a=#57 hard disk R/W error
 410++9B95              ;       a=#58 hard disk undefined
 411++9B95              ;       a=#60 busy not found
 412++9B95              ;       a=#61 hard disk not ready
 413++9B95              ;       a=#62 hard disk data not ready
 414++9B95              ;
 415++9B95              ;hddHddIdent
 416++9B95              ;
 417++9B95 AF           	xor	a
 418++9B96 32 89 A4     	ld	(ideError),a		; 訡 ᪮ 
 419++9B99              	IFDEF	ver1_10			; ᨨ v1.10
 420++9B99 FD 7E 0A     	 ld	a,(iy+#0A)
 421++9B9C E6 10        	 and	%00010000
 422++9B9E FD 77 0A     	 ld	(iy+#0A),a		;ᨬ  ࠬ 
 423++9BA1 F6 A0        	 or	#A0
 424++9BA3              	ELSE				; ᨨ v1.00
 425++9BA3 ~            	 ld	(iy+#0A),a
 426++9BA3 ~            	 ld	a,(iy+#0B)
 427++9BA3 ~            	 and	%10110000
 428++9BA3              	ENDIF
 429++9BA3 32 55 A4     	ld	(idePort1F6),a		;⠭  祭 
 430++9BA6 57           	ld	d,a
 431++9BA7
 432++9BA7              ; SMUC ࠧ蠥 뢠
 433++9BA7              ;	ld	a,(drvDevice)
 434++9BA7              ;	and	%00110000
 435++9BA7              ;	jr	nz,goto029		;  SMUC
 436++9BA7              ;  ࠧ襭 뢠  
 437++9BA7              ;	ld	bc,#FFBA
 438++9BA7              ;	ld	a,#F7			;४祭  ⥭ ॣ  
 439++9BA7              ;	call	out_C_A_2A53		;device control/alt status
 440++9BA7              ;	push	bc
 441++9BA7              ;	ld	bc,#FEBE
 442++9BA7              ;	xor	a
 443++9BA7              ;	call	out_C_A_2A53
 444++9BA7              ;	pop	bc
 445++9BA7              ;	ld	a,#77
 446++9BA7              ;	call	out_C_A_2A53		;୥ ॣ 
 447++9BA7              ;	djnz	$			;প
 448++9BA7 CD 78 99     	call	kHddReset
 449++9BAA ED 4B 90 99  goto029	ld	bc,(kPort1F6)		;⠭   樠஢ master/slave
 450++9BAE 7A           	ld	a,d
 451++9BAF CD 6C 99     	call	kOut_C_A
 452++9BB2              	IFDEF	PROFIide
 453++9BB2 CD A3 A3     	 call	Pause70k
 454++9BB5              	ENDIF
 455++9BB5 ED 4B 92 99  	ld	bc,(kPort1F7)		;bc - ॣ ﭨ
 456++9BB9 CD 6F 99     	call	kIn_A_C			;।塞     
 457++9BBC 3C           	inc	a
 458++9BBD FE 02        	cp	#02			;⠭ #00/#FF ->  
 459++9BBF
 460++9BBF              ;⥭ ᥪ 䨪樨  ⠭ ६ ਨ 
 461++9BBF 7A           	ld	a,d
 462++9BC0 D4 4F A0     	call	nc,hddTestInit		;।  
 463++9BC3 3E 56        	ld	a,#56
 464++9BC5 D8           	ret	c			; 
 465++9BC6
 466++9BC6              ;⥭ ࠬ஢  ᥪ 䨪樨
 467++9BC6 DD E5        	push	ix
 468++9BC8 E1           	pop	hl
 469++9BC9 AF           	xor	a
 470++9BCA B6           	or	(hl)
 471++9BCB 23           	inc	hl
 472++9BCC B6           	or	(hl)
 473++9BCD 23           	inc	hl
 474++9BCE 28 65        	jr	z,goto030		;訡  ᥪ 䨪樨
 475++9BD0 FD E5        	push	iy
 476++9BD2 D1           	pop	de
 477++9BD3 ED A0        	ldi				;樫஢ (訩 )
 478++9BD5 ED A0        	ldi				;樫஢ (訩 )
 479++9BD7 23           	inc	hl
 480++9BD8 23           	inc	hl
 481++9BD9 ED A0        	ldi				;
 482++9BDB 01 05 00     	ld	bc,#0006-1
 483++9BDE 09           	add	hl,bc
 484++9BDF 7E           	ld	a,(hl)			;ᥪ஢
 485++9BE0 ED A0        	ldi				;ᥪ஢
 486++9BE2 0E 6B        	ld	c,#6C-1			;108
 487++9BE4 09           	add	hl,bc			;hl= +120 (᫮ +60) ⢮ LBA ᥪ஢
 488++9BE5 13           	inc	de
 489++9BE6 13           	inc	de
 490++9BE7 0E 04        	ld	c,#04
 491++9BE9 ED B0        	ldir				;⢮ LBA ᥪ஢
 492++9BEB
 493++9BEB              ; ந   ᥪ஢
 494++9BEB FD 5E 02     	ld	e,(iy+#02)		;- 
 495++9BEE              ;	ld	a,(iy+#03)		;- ᥪ஢
 496++9BEE CD E8 A3     	call	calcHLequEmulA
 497++9BF1 FD 75 04     	ld	(iy+#04),l
 498++9BF4 FD 74 05     	ld	(iy+#05),h		;ந head * sectors
 499++9BF7
 500++9BF7              ;஢ઠ ਨ CHS
 501++9BF7 FD 7E 00     	ld	a,(iy+#00)		;樫஢ (訩 )
 502++9BFA FD B6 01     	or	(iy+#01)
 503++9BFD 28 18        	jr	z,goto031		; ன.  樫஢
 504++9BFF AF           	xor	a
 505++9C00 FD B6 02     	or	(iy+#02)
 506++9C03 28 12        	jr	z,goto031		; ன.  
 507++9C05 AF           	xor	a
 508++9C06 FD B6 03     	or	(iy+#03)
 509++9C09 28 0C        	jr	z,goto031		; ன.  ᥪ஢
 510++9C0B FD 7E 04     	ld	a,(iy+#04)
 511++9C0E FD B6 05     	or	(iy+#05)
 512++9C11 28 04        	jr	z,goto031		; ன. 㫥 ந   ᥪ஢
 513++9C13 FD CB 0A EE  	set	5,(iy+#0A)		; প CHS
 514++9C17              	IFDEF	ver1_00			; ᨨ v1.00
 515++9C17 ~            	 res	6,(iy+#0B)		;稬 CHS
 516++9C17              	ENDIF
 517++9C17
 518++9C17              ;஢ઠ ਨ LBA
 519++9C17 FD 7E 06     goto031	ld	a,(iy+#06)
 520++9C1A FD B6 07     	or	(iy+#07)
 521++9C1D FD B6 08     	or	(iy+#08)
 522++9C20 FD B6 09     	or	(iy+#09)
 523++9C23 28 04        	jr	z,goto032
 524++9C25 FD CB 0A F6  	set	6,(iy+#0A)		; প LBA
 525++9C29              	IFDEF	ver1_00			; ᨨ v1.00
 526++9C29 ~            	 set	6,(iy+#0B)		;稬 LBA
 527++9C29              	ENDIF
 528++9C29
 529++9C29              ;᫨ ஢ન ன,    ⥬
 530++9C29 FD 7E 0A     goto032	ld	a,(iy+#0A)
 531++9C2C E6 60        	and	%01100000
 532++9C2E 28 05        	jr	z,goto030		;஢ઠ ਨ   ன
 533++9C30 FD CB 0A FE  	set	7,(iy+#0A)
 534++9C34 C9           	ret
 535++9C35
 536++9C35              ;訡 #58. 訡  ᥪ 䨪樨
 537++9C35 3E 58        goto030	ld	a,#58
 538++9C37 37           	scf
 539++9C38 C9           	ret
 540++9C39
 541++9C39              	endif
 542++9C39
 543++9C39              ;==============================================================================
 544++9C39              ;
 545++9C39              ;==============================================================================
 546++9C39
# file closed: Drivers/DrvHDD/DrvHDD.hdd.a80
 227+ 9C39              	INCLUDE		"DrvHDD.spi.a80"
# file opened: Drivers/DrvHDD/DrvHDD.spi.a80
   1++9C39              ;楤  HDD Driver. 楤  ࠡ  ⠬ ஫஢ SD
   2++9C39              ;䠩 DrvHDD.spi.a80
   3++9C39              ;
   4++9C39              ;sdWriteSecs_HL		  ᥪ஢
   5++9C39              ;sdReadSecs_HL		㧪  ᥪ஢
   6++9C39              ;sdWriteDataSB512	  512b   
   7++9C39              ;sdWriteDataMB512	  512b   
   8++9C39              ;sdReadData512		⥭ 512b    㥬 hl
   9++9C39              ;sdCalcCapacity		 ꥬ   
  10++9C39              ;sdReadCSD		⥭ ॣ CSD
  11++9C39              ;sdReadCID		⥭ ॣ CID
  12++9C39              ;sdTestInit		।   樠 SDC/MMC 
  13++9C39              ;sdSendAcmd_41		 樠樨 (⮫쪮  SDC)
  14++9C39              ;sdSendCmd_24		 ᥪ୮ 
  15++9C39              ;sdSendCmd_25		 -ᥪ୮  (襭 ந  ⮯ ⮪!)
  16++9C39              ;sdSendCmd_17		 ᥪ୮ ⥭
  17++9C39              ;sdSendCmd_18		 -ᥪ୮ ⥭ (襭 ந  cmd12)
  18++9C39              ;sdSendCmd_12		襭 ।  (뢠  襭
  19++9C39              ;			-ᥪ୮ ⥭)
  20++9C39              ;sdSendCmd_10		⥭ CID
  21++9C39              ;sdSendCmd_09		⥭ CSD
  22++9C39              ;sdSendCmd_58		⥭ OCR
  23++9C39              ;sdSendCmd_55		뢠 । ACMD<n>
  24++9C39              ;sdSendCmd_01		 樠樨 (⮫쪮  MMC)
  25++9C39              ;sdSendCmd_A_CS		뤠    c ⠢ ᨣ CS
  26++9C39              ;sdSendCmd_A		뤠   
  27++9C39              ;sdSendCmd_16		뤠  #10   ( ࠧ )
  28++9C39              ;sdSendCmd_08		뤠  #08   (㧭  殮 㦭 )
  29++9C39              ;sdSendCmd_00		뤠  #00   (ணࠬ  )
  30++9C39              ;sdSendCmd_HL		뤠   
  31++9C39              ;sdWaitCmdResp		 cmd. Resp. ( 祭 80 ⠪஢)
  32++9C39              ;sdWaitDR		 Data Response
  33++9C39              ;sdSendEndToken		뤠 ⮪  -ᥪ୮ 樨
  34++9C39              ;sdWait128tact		㧠  128 ⠪஢
  35++9C39              ;sdWaitNoBusy		  BUSY
  36++9C39              ;sdWaitDO		 DO
  37++9C39              ;sdOffSD		몫祭 ⠭ 
  38++9C39              ;sdFakeRead		宫 㧪  ⢠ ⮢  SPI
  39++9C39              ;sdCSlow		⠢ CS  0
  40++9C39              ;sdCShigh		⠢ CS  1
  41++9C39              ;sdWait			 ⮩ 設
  42++9C39              ;
  43++9C39              ;------------------------------------------------------------------------------
  44++9C39              sdWriteSecs_HL	ifused
  45++9C39              ;  ᥪ஢
  46++9C39              ;:  hl -     ᥪ஢
  47++9C39              ;: cy=1 訡 SD  -> a -  訡
  48++9C39              ;       a=#77 SD card error R/W
  49++9C39              ;       a=#78 SD card read only
  50++9C39              ;
  51++9C39              ;sdWriteSecs_HL
  52++9C39              ;
  53++9C39              ;஢ઠ  
  54++9C39 3A D4 8A     	ld	a,(ExtFlags)
  55++9C3C CB 6F        	bit	5,a
  56++9C3E 20 0C        	jr	nz,goto059		;஢ read only
  57++9C40 ED 4B 84 99  	ld	bc,(kPortCONF)
  58++9C44 ED 78        	in	a,(c)
  59++9C46 E6 02        	and	#02
  60++9C48 37           	scf
  61++9C49 3E 78        	ld	a,#78			;SD card read only
  62++9C4B C0           	ret	nz			; 饭
  63++9C4C
  64++9C4C              ; ᥪ/ᥪ஢
  65++9C4C E5           goto059	push	hl
  66++9C4D 2A 5A A4     	ld	hl,(AdrLBA32+0)		; ᥪ
  67++9C50 ED 5B 5C A4  	ld	de,(AdrLBA32+2)
  68++9C54 3A 51 A4     	ld	a,(secCounter)		;⢮ ᥪ஢
  69++9C57 47           	ld	b,a
  70++9C58 3D           	dec	a
  71++9C59 20 07        	jr	nz,goto057		;ᥪ୮ ⥭
  72++9C5B
  73++9C5B              ;ᥪୠ 
  74++9C5B CD C3 9E     	call	sdSendCmd_24
  75++9C5E 3E FE        	ld	a,#FE			;⮪ 砫  
  76++9C60 18 05        	jr	goto058
  77++9C62
  78++9C62              ;ᥪୠ 
  79++9C62 CD C7 9E     goto057	call	sdSendCmd_25		;   ᥪ 
  80++9C65 3E FC        	ld	a,#FC			;⮪ 砫  
  81++9C67 E1           goto058	pop	hl
  82++9C68 38 5D        	jr	c,goto054		;訡 SD 
  83++9C6A CD 22 A0     	call	sdWait			; ⮢  ਥ 
  84++9C6D 38 58        	jr	c,goto054		; 諨  ⮢
  85++9C6F E5           	push	hl
  86++9C70 F5           loop046	push	af
  87++9C71 CD CC 9C     	call	sdWriteData512		;।  ,  ⮪ 砫 + 512    2  crc
  88++9C74 24           	inc	h
  89++9C75 24           	inc	h
  90++9C76 F1           	pop	af
  91++9C77 CD 95 9F     	call	sdWaitDR		; Data Resp.   busy
  92++9C7A 38 4A        	jr	c,goto056		; 諨  ⮢
  93++9C7C 10 F2        	djnz	loop046
  94++9C7E E1           	pop	hl
  95++9C7F FE FC        	cp	#FC
  96++9C81 CA AB 9F     	jp	z,sdSendEndToken
  97++9C84 C3 0C A0     	jp	sdCShigh
  98++9C87
  99++9C87              	endif
 100++9C87
 101++9C87              ;------------------------------------------------------------------------------
 102++9C87              sdReadSecs_HL	ifused
 103++9C87              ;㧪  ᥪ஢
 104++9C87              ;:  hl -    ⥭ ᥪ஢
 105++9C87              ;: cy=1 訡 SD  -> a -  訡
 106++9C87              ;       a=#77 SD card error R/W
 107++9C87              ;
 108++9C87              ;sdReadSecs_HL
 109++9C87              ;
 110++9C87 E5           	push	hl
 111++9C88 2A 5A A4     	ld	hl,(AdrLBA32+0)		; ᥪ
 112++9C8B ED 5B 5C A4  	ld	de,(AdrLBA32+2)
 113++9C8F 3A 51 A4     	ld	a,(secCounter)		;⢮ ᥪ஢
 114++9C92 47           	ld	b,a
 115++9C93 3D           	dec	a
 116++9C94 20 13        	jr	nz,goto053		;ᥪ୮ ⥭
 117++9C96
 118++9C96              ;ᥪ୮ ⥭
 119++9C96 CD CB 9E     	call	sdSendCmd_17
 120++9C99 E1           	pop	hl
 121++9C9A 38 2B        	jr	c,goto054		;訡 SD 
 122++9C9C              ;  ⥭ ᥪ
 123++9C9C E5           	push	hl
 124++9C9D CD D9 9F     loop044	call	sdWaitDO		; ⮪ 砫  (#FE)
 125++9CA0 20 FB        	jr	nz,loop044
 126++9CA2 CD 13 9D     	call	sdReadData512		;ਭ 512   ய᪠ crc
 127++9CA5 10 F6        	djnz	loop044
 128++9CA7 18 1C        	jr	goto055
 129++9CA9
 130++9CA9              ;ᥪ୮ ⥭
 131++9CA9 CD CF 9E     goto053	call	sdSendCmd_18		; ᥪ୮ ⥭
 132++9CAC E1           	pop	hl
 133++9CAD 38 18        	jr	c,goto054		;訡 SD 
 134++9CAF              ;  ⥭ ᥪ஢
 135++9CAF E5           	push	hl
 136++9CB0 CD D9 9F     loop045	call	sdWaitDO		; ⮪ 砫  (#FE)
 137++9CB3 20 FB        	jr	nz,loop045
 138++9CB5 CD 13 9D     	call	sdReadData512		;ਭ 512   ய᪠ crc
 139++9CB8 24           	inc	h
 140++9CB9 24           	inc	h
 141++9CBA 10 F4        	djnz	loop045
 142++9CBC              ;  襭 ⥭
 143++9CBC CD 0C 9F     	call	sdSendCmd_12
 144++9CBF CD BB 9F     	call	sdWait128tact
 145++9CC2 CD CB 9F     	call	sdWaitNoBusy
 146++9CC5 B7           goto055	or	a
 147++9CC6 E1           goto056	pop	hl
 148++9CC7 3E 77        goto054	ld	a,#77			;SD card error R/W
 149++9CC9 C3 0C A0     	jp	sdCShigh
 150++9CCC
 151++9CCC              	endif
 152++9CCC
 153++9CCC              ;------------------------------------------------------------------------------
 154++9CCC              sdWriteDataSB512	ifused
 155++9CCC ~            ;  512b   
 156++9CCC ~            ;:  hl -     
 157++9CCC ~            ;: bc=kPortDATA
 158++9CCC ~            ;     a=#00
 159++9CCC ~            ;     cy=0
 160++9CCC ~            ;
 161++9CCC ~            ;sdWriteDataSB512
 162++9CCC ~            ;
 163++9CCC ~            	ld	a,#FE			;⮪ 砫  
 164++9CCC ~            	jr	goto052
 165++9CCC ~            	jr	sdWriteData512
 166++9CCC ~            	org	$-2
 167++9CCC ~
 168++9CCC              	endif
 169++9CCC
 170++9CCC              ;------------------------------------------------------------------------------
 171++9CCC              sdWriteDataMB512	ifused
 172++9CCC ~            ;  512b   
 173++9CCC ~            ;:  hl -     
 174++9CCC ~            ;: a=#00
 175++9CCC ~            ;     cy=0
 176++9CCC ~            ;
 177++9CCC ~            ;sdWriteDataMB512
 178++9CCC ~            ;
 179++9CCC ~            	ld	a,#FC			;⮪ 砫  
 180++9CCC ~            	jr	sdWriteData512
 181++9CCC ~            	org	$-2
 182++9CCC              	endif
 183++9CCC
 184++9CCC              sdWriteData512	ifused
 185++9CCC              ;
 186++9CCC E5           goto052	push	hl
 187++9CCD C5           	push	bc
 188++9CCE ED 4B 86 99  	ld	bc,(kPortDATA)
 189++9CD2 ED 79        	out	(c),a
 190++9CD4 3E 20        	ld	a,#20
 191++9CD6              loop043	DUP	#10
 192++9CD6 ED A3       >	outi
 193++9CD8 04          >	inc	b
 192++9CD9 ED A3       >	outi
 193++9CDB 04          >	inc	b
 192++9CDC ED A3       >	outi
 193++9CDE 04          >	inc	b
 192++9CDF ED A3       >	outi
 193++9CE1 04          >	inc	b
 192++9CE2 ED A3       >	outi
 193++9CE4 04          >	inc	b
 192++9CE5 ED A3       >	outi
 193++9CE7 04          >	inc	b
 192++9CE8 ED A3       >	outi
 193++9CEA 04          >	inc	b
 192++9CEB ED A3       >	outi
 193++9CED 04          >	inc	b
 192++9CEE ED A3       >	outi
 193++9CF0 04          >	inc	b
 192++9CF1 ED A3       >	outi
 193++9CF3 04          >	inc	b
 192++9CF4 ED A3       >	outi
 193++9CF6 04          >	inc	b
 192++9CF7 ED A3       >	outi
 193++9CF9 04          >	inc	b
 192++9CFA ED A3       >	outi
 193++9CFC 04          >	inc	b
 192++9CFD ED A3       >	outi
 193++9CFF 04          >	inc	b
 192++9D00 ED A3       >	outi
 193++9D02 04          >	inc	b
 192++9D03 ED A3       >	outi
 193++9D05 04          >	inc	b
 194++9D06              	EDUP
 195++9D06 3D           	dec	a
 196++9D07 C2 D6 9C     	jp	nz,loop043
 197++9D0A 3D           	dec	a			;a=#FF
 198++9D0B ED 79        	out	(c),a			;뫠 2  crc ()
 199++9D0D ED 79        	out	(c),a
 200++9D0F C1           	pop	bc
 201++9D10 E1           	pop	hl
 202++9D11 AF           	xor	a
 203++9D12 C9           	ret
 204++9D13
 205++9D13              	endif
 206++9D13
 207++9D13              ;------------------------------------------------------------------------------
 208++9D13              sdReadData512	ifused
 209++9D13              ;⥭ 512b   
 210++9D13              ;:  hl -    ⥭ 
 211++9D13              ;: a=#00
 212++9D13              ;
 213++9D13              ;sdReadData512
 214++9D13              ;
 215++9D13 E5           	push	hl
 216++9D14 C5           	push	bc
 217++9D15 ED 4B 86 99  	ld	bc,(kPortDATA)
 218++9D19 3E 20        	ld	a,#20
 219++9D1B              loop042	DUP	#10
 220++9D1B ED A2       >	ini
 221++9D1D 04          >	inc	b
 220++9D1E ED A2       >	ini
 221++9D20 04          >	inc	b
 220++9D21 ED A2       >	ini
 221++9D23 04          >	inc	b
 220++9D24 ED A2       >	ini
 221++9D26 04          >	inc	b
 220++9D27 ED A2       >	ini
 221++9D29 04          >	inc	b
 220++9D2A ED A2       >	ini
 221++9D2C 04          >	inc	b
 220++9D2D ED A2       >	ini
 221++9D2F 04          >	inc	b
 220++9D30 ED A2       >	ini
 221++9D32 04          >	inc	b
 220++9D33 ED A2       >	ini
 221++9D35 04          >	inc	b
 220++9D36 ED A2       >	ini
 221++9D38 04          >	inc	b
 220++9D39 ED A2       >	ini
 221++9D3B 04          >	inc	b
 220++9D3C ED A2       >	ini
 221++9D3E 04          >	inc	b
 220++9D3F ED A2       >	ini
 221++9D41 04          >	inc	b
 220++9D42 ED A2       >	ini
 221++9D44 04          >	inc	b
 220++9D45 ED A2       >	ini
 221++9D47 04          >	inc	b
 220++9D48 ED A2       >	ini
 221++9D4A 04          >	inc	b
 222++9D4B              	EDUP
 223++9D4B 3D           	dec	a
 224++9D4C C2 1B 9D     	jp	nz,loop042
 225++9D4F ED 78        	in	a,(c)			;ॡ 2  crc
 226++9D51 00           	nop
 227++9D52 00           	nop
 228++9D53 ED 78        	in	a,(c)
 229++9D55 C1           	pop	bc
 230++9D56 E1           	pop	hl
 231++9D57 C9           	ret
 232++9D58
 233++9D58              	endif
 234++9D58
 235++9D58              ;------------------------------------------------------------------------------
 236++9D58              sdCalcCapacity	ifused
 237++9D58              ; ꥬ   
 238++9D58              ;:  hl -  ⠭ CSD
 239++9D58              ;     iy -  砫  ६ SD 
 240++9D58              ;: dehl - ࠧ   
 241++9D58              ;     bc,a - ???
 242++9D58              ;
 243++9D58              ;sdCalcCapacity
 244++9D58              ;
 245++9D58 7E           	ld	a,(hl)
 246++9D59 01 05 00     	ld	bc,#0005
 247++9D5C 09           	add	hl,bc
 248++9D5D E6 C0        	and	#C0
 249++9D5F FE 40        	cp	#40
 250++9D61 28 4A        	jr	z,goto049		;CSD version 2.0
 251++9D63
 252++9D63              ;CSD version 1.0
 253++9D63 7E           	ld	a,(hl)
 254++9D64 E6 0F        	and	#0F
 255++9D66 4F           	ld	c,a			;c - READ_BL_LEN
 256++9D67 06 02        	ld	b,#02
 257++9D69 23           	inc	hl
 258++9D6A 23           loop039	inc	hl
 259++9D6B 23           	inc	hl			;hl +8
 260++9D6C CB 16        	rl	(hl)
 261++9D6E 2B           	dec	hl
 262++9D6F CB 16        	rl	(hl)
 263++9D71 2B           	dec	hl
 264++9D72 CB 16        	rl	(hl)
 265++9D74 10 F4        	djnz	loop039
 266++9D76 7E           	ld	a,(hl)			;hl +6
 267++9D77 E6 0F        	and	#0F
 268++9D79 57           	ld	d,a
 269++9D7A 23           	inc	hl
 270++9D7B 5E           	ld	e,(hl)			;de - C_SIZE
 271++9D7C 23           	inc	hl
 272++9D7D 23           	inc	hl
 273++9D7E 23           	inc	hl
 274++9D7F CB 16        	rl	(hl)
 275++9D81 2B           	dec	hl
 276++9D82 CB 16        	rl	(hl)
 277++9D84 7E           	ld	a,(hl)
 278++9D85 E6 07        	and	#07			;a - C_SIZE_MULT
 279++9D87              ;  dehl = BLOCKNR = (C_SIZE+1) * 2^(C_SIZE_MULT+2)
 280++9D87 3C           	inc	a
 281++9D88 3C           	inc	a
 282++9D89 47           	ld	b,a			;C_SIZE_MULT+2
 283++9D8A 13           	inc	de
 284++9D8B EB           	ex	de,hl
 285++9D8C AF           	xor	a
 286++9D8D 57           	ld	d,a
 287++9D8E 5F           	ld	e,a
 288++9D8F 29           loop040	add	hl,hl
 289++9D90 EB           	ex	de,hl
 290++9D91 ED 6A        	adc	hl,hl
 291++9D93 EB           	ex	de,hl
 292++9D94 10 F9        	djnz	loop040
 293++9D96              ;  adehl = (C_SIZE+1) * 2^(C_SIZE_MULT+2) * 2^READ_BL_LEN
 294++9D96 41           	ld	b,c
 295++9D97 AF           	xor	a
 296++9D98 29           loop041	add	hl,hl
 297++9D99 EB           	ex	de,hl
 298++9D9A ED 6A        	adc	hl,hl
 299++9D9C EB           	ex	de,hl
 300++9D9D 8F           	adc	a,a
 301++9D9E 10 F8        	djnz	loop041
 302++9DA0              ;  adehl/#200 - ⢮ (ᥪ஢)
 303++9DA0 1F           	rra
 304++9DA1 CB 1A        	rr	d
 305++9DA3 CB 1B        	rr	e
 306++9DA5 CB 1C        	rr	h
 307++9DA7 6C           	ld	l,h
 308++9DA8 63           	ld	h,e
 309++9DA9 5A           	ld	e,d
 310++9DAA 57           	ld	d,a
 311++9DAB 18 16        	jr	goto050			;襬  ६
 312++9DAD
 313++9DAD              ;CSD version 2.0
 314++9DAD 23           goto049	inc	hl
 315++9DAE 23           	inc	hl			;+7
 316++9DAF 56           	ld	d,(hl)
 317++9DB0 23           	inc	hl
 318++9DB1 5E           	ld	e,(hl)
 319++9DB2 23           	inc	hl
 320++9DB3 66           	ld	h,(hl)
 321++9DB4 68           	ld	l,b
 322++9DB5 24           	inc	h
 323++9DB6 20 01        	jr	nz,goto051
 324++9DB8 13           	inc	de
 325++9DB9 29           goto051	add	hl,hl
 326++9DBA EB           	ex	de,hl
 327++9DBB ED 6A        	adc	hl,hl
 328++9DBD EB           	ex	de,hl
 329++9DBE 29           	add	hl,hl
 330++9DBF EB           	ex	de,hl
 331++9DC0 ED 6A        	adc	hl,hl
 332++9DC2 EB           	ex	de,hl
 333++9DC3
 334++9DC3              ;襬  ६
 335++9DC3              	IFDEF	ver1_10			; ᨨ v1.10
 336++9DC3              goto050	 ;ld	(sdLBAsec+#00),hl
 337++9DC3              	 ;ld	(sdLBAsec+#02),de
 338++9DC3 FD 75 06     	 ld	(iy+#06),l
 339++9DC6 FD 74 07     	 ld	(iy+#07),h
 340++9DC9 FD 73 08     	 ld	(iy+#08),e
 341++9DCC FD 72 09     	 ld	(iy+#09),d
 342++9DCF              	ELSE				; ᨨ v1.00
 343++9DCF ~            goto050	 ld	(sdLBAsec+#00),hl
 344++9DCF ~            	 ld	(sdLBAsec+#02),de
 345++9DCF              	ENDIF
 346++9DCF
 347++9DCF C9           	ret
 348++9DD0
 349++9DD0              	endif
 350++9DD0
 351++9DD0              ;------------------------------------------------------------------------------
 352++9DD0              sdReadCSD	ifused
 353++9DD0              ;⥭ ॣ CSD
 354++9DD0              ;:  hl -    ⥭
 355++9DD0              ;: cy=1 訡 
 356++9DD0              ;       a=#77 - SD card error R/W
 357++9DD0              ;     cy=0 ⠭ ᯥ譮
 358++9DD0              ;       a=#00
 359++9DD0              ;       hl=hl+#10
 360++9DD0              ;
 361++9DD0              ;sdReadCSD
 362++9DD0              ;
 363++9DD0 CD 1F 9F     	call	sdSendCmd_09
 364++9DD3 18 03        	jr	goto048
 365++9DD5 18 FE        	jr	sdReadCID
 366++9DD7              	org	$-2
 367++9DD5
 368++9DD5              	endif
 369++9DD5
 370++9DD5              ;------------------------------------------------------------------------------
 371++9DD5              sdReadCID	ifused
 372++9DD5              ;⥭ ॣ CID
 373++9DD5              ;:  hl -    ⥭
 374++9DD5              ;: cy=1 訡 
 375++9DD5              ;       a=#77 - SD card error R/W
 376++9DD5              ;     cy=0 ⠭ ᯥ譮
 377++9DD5              ;       a=#00
 378++9DD5              ;       hl=hl+#10
 379++9DD5              ;
 380++9DD5              ;sdReadCID
 381++9DD5              ;
 382++9DD5 CD 1B 9F     	call	sdSendCmd_10
 383++9DD8 3E 77        goto048	ld	a,#77			;SD card error R/W
 384++9DDA D8           	ret	c			;訡 
 385++9DDB CD D9 9F     loop037	call	sdWaitDO		; ⮪ 砫  #FE
 386++9DDE 20 FB        	jr	nz,loop037
 387++9DE0 ED 4B 86 99  	ld	bc,(kPortDATA)
 388++9DE4 3E 10        	ld	a,#10
 389++9DE6 ED A2        loop038	ini
 390++9DE8 3D           	dec	a
 391++9DE9 20 FB        	jr	nz,loop038
 392++9DEB AF           	xor	a
 393++9DEC C9           	ret
 394++9DED
 395++9DED              	endif
 396++9DED
 397++9DED              ;------------------------------------------------------------------------------
 398++9DED              sdTestInit	ifused
 399++9DED              ;।   樠 SDC/MMC 
 400++9DED              ;:  iy -  砫  ६ SD 
 401++9DED              ;: cy=1   
 402++9DED              ;     cy=0  㦥
 403++9DED              ;       a=#00
 404++9DED              ;       hl,de,bc - ????
 405++9DED              ;
 406++9DED              ;sdTestInit
 407++9DED              ;
 408++9DED              	IFDEF	ver1_10			; ᨨ v1.10
 409++9DED              ;	 ld	hl,devFlags		;ᨬ ன 
 410++9DED              ;	 ld	(hl),%01001000
 411++9DED FD 36 0A 48  	 ld	(iy+#0A),%01001000
 412++9DF1              	ELSE				; ᨨ v1.00
 413++9DF1 ~            	 ld	hl,sdFlags		;ᨬ ன 
 414++9DF1 ~            	 ld	(hl),%01001000
 415++9DF1              	ENDIF
 416++9DF1 CD 0C A0     	call	sdCShigh
 417++9DF4 11 0A 02     	ld	de,512+10
 418++9DF7 CD E8 9F     	call	sdFakeRead		;宫 㧪 512+10   直 砩
 419++9DFA
 420++9DFA              ;1000 横 
 421++9DFA 11 E8 03     	ld	de,1000
 422++9DFD 1B           loop033	dec	de
 423++9DFE 7A           	ld	a,d
 424++9DFF B3           	or	e
 425++9E00 CA 97 9E     	jp	z,goto043		;  
 426++9E03 CD 5E 9F     	call	sdSendCmd_00		;  樠 
 427++9E06 38 F5        	jr	c,loop033		;ᨬ  横,   㤥 祭 cmd. Resp. ( ⢥ 80 ⠪஢)
 428++9E08 3D           	dec	a
 429++9E09 20 F2        	jr	nz,loop033		;ᨬ  横,   稬 ⢥  訡   ⠢ Idle State 䫠 (bit 0)
 430++9E0B              ;  ᫨  諮 ᯥ譮,   ४砥  SPI ०
 431++9E0B CD 59 9F     	call	sdSendCmd_08		;  ন 殮 ⠭ (⮫쪮  SDCv2)
 432++9E0E F5           	push	af
 433++9E0F ED 60        	in	h,(c)
 434++9E11 00           	nop
 435++9E12 ED 60        	in	h,(c)
 436++9E14 00           	nop
 437++9E15 ED 60        	in	h,(c)
 438++9E17 00           	nop
 439++9E18 ED 68        	in	l,(c)
 440++9E1A F1           	pop	af
 441++9E1B 38 E0        	jr	c,loop033		;cmd. Resp. 祭?
 442++9E1D CB 57        	bit	2,a
 443++9E1F 28 2C        	jr	z,goto044		;᫨  訡 Illegal command ( 2),  ।  SDCv2
 444++9E21
 445++9E21              ;cmd08  ন, ।   SDCv1,  MMC
 446++9E21 11 40 1F     	ld	de,8000			;8 横 
 447++9E24 1B           loop034	dec	de
 448++9E25 7A           	ld	a,d
 449++9E26 B3           	or	e
 450++9E27 28 0E        	jr	z,goto045		;᫨ ६ 諮, ஡㥬 ।   MMC
 451++9E29 26 00        	ld	h,#00			;HCS  0
 452++9E2B CD 9B 9E     	call	sdSendAcmd_41		;  樠 SDC
 453++9E2E 38 F4        	jr	c,loop034		; cmd. Resp.
 454++9E30 FE 01        	cp	#01
 455++9E32 28 F0        	jr	z,loop034		; 室  Idle State
 456++9E34 B7           	or	a			;᫨  - 訡,  ஡㥬 ।   MMC
 457++9E35 28 58        	jr	z,goto046		;SDv1 Detected
 458++9E37
 459++9E37              ;஡㥬 ।   MMC
 460++9E37 11 40 1F     goto045	ld	de,8000
 461++9E3A 1B           loop035	dec	de
 462++9E3B 7A           	ld	a,d
 463++9E3C B3           	or	e
 464++9E3D 28 58        	jr	z,goto043		; ,   ⨯
 465++9E3F CD 2B 9F     	call	sdSendCmd_01		;  樠 MMC
 466++9E42 38 F6        	jr	c,loop035		; cmd. Resp.
 467++9E44 FE 01        	cp	#01
 468++9E46 28 F2        	jr	z,loop035		; 室  Idle State
 469++9E48 B7           	or	a
 470++9E49 20 4C        	jr	nz,goto043		;  
 471++9E4B 18 42        	jr	goto046			;MMC Ver.3 Detected
 472++9E4D
 473++9E4D              ;஡㥬 ।   SDCv2
 474++9E4D 11 AA 01     goto044	ld	de,#01AA
 475++9E50 B7           	or	a
 476++9E51 ED 52        	sbc	hl,de
 477++9E53 20 42        	jr	nz,goto043		;  
 478++9E55 11 40 1F     	ld	de,8000
 479++9E58 1B           loop036	dec	de
 480++9E59 7A           	ld	a,d
 481++9E5A B3           	or	e
 482++9E5B 28 3A        	jr	z,goto043		;  
 483++9E5D 26 40        	ld	h,#40			;HCS  1
 484++9E5F CD 9B 9E     	call	sdSendAcmd_41		;  樠 SDC
 485++9E62 38 F4        	jr	c,loop036		; cmd. Resp.
 486++9E64 FE 01        	cp	#01
 487++9E66 28 F0        	jr	z,loop036		; 室  Idle State
 488++9E68 B7           	or	a
 489++9E69 20 2C        	jr	nz,goto043		;  
 490++9E6B              ;  SDv2 Detected
 491++9E6B CD 23 9F     	call	sdSendCmd_58		;।塞 ⨯ 樨 (  ⮢)
 492++9E6E 38 27        	jr	c,goto043		;  
 493++9E70 ED 4B 86 99  	ld	bc,(kPortDATA)
 494++9E74 ED 78        	in	a,(c)
 495++9E76 00           	nop
 496++9E77 ED 68        	in	l,(c)
 497++9E79 00           	nop
 498++9E7A ED 68        	in	l,(c)
 499++9E7C 00           	nop
 500++9E7D ED 68        	in	l,(c)
 501++9E7F CB 77        	bit	6,a
 502++9E81 28 0C        	jr	z,goto046		;SDv2 ⮢ 
 503++9E83              ;  SDv2  
 504++9E83              	IFDEF	ver1_10			; ᨨ v1.10
 505++9E83              ;	 ld	hl,devFlags
 506++9E83              ;	 set	2,(hl)			; 
 507++9E83 FD CB 0A D6  	 set	2,(iy+#0A)		; 
 508++9E87              	ELSE				; ᨨ v1.00
 509++9E87 ~            	 ld	hl,sdFlags
 510++9E87 ~            	 set	4,(hl)			; 
 511++9E87              	ENDIF
 512++9E87
 513++9E87              ; ᯥ譮 
 514++9E87              	IFDEF	ver1_10			; ᨨ v1.10
 515++9E87 FD CB 0A FE  goto047	 set	7,(iy+#0A)		; 
 516++9E8B              ;	 ld	hl,devFlags
 517++9E8B              ;	 set	7,(hl)			; 
 518++9E8B              	ELSE				; ᨨ v1.00
 519++9E8B ~            goto047	 ld	hl,sdFlags
 520++9E8B ~            	 set	7,(hl)			; 
 521++9E8B              	ENDIF
 522++9E8B AF           	xor	a
 523++9E8C C3 0C A0     	jp	sdCShigh
 524++9E8F
 525++9E8F              ;⠢塞 ࠧ   512, . .  ᯮ ⮢ 
 526++9E8F CD 54 9F     goto046	call	sdSendCmd_16
 527++9E92 38 03        	jr	c,goto043		;᫨  祭 cmd. Resp.,  ⠥,   
 528++9E94 B7           	or	a
 529++9E95 28 F0        	jr	z,goto047
 530++9E97
 531++9E97              ;  , 뫥⠥  訡
 532++9E97 37           goto043	scf
 533++9E98 C3 0C A0     	jp	sdCShigh
 534++9E9B
 535++9E9B              	endif
 536++9E9B
 537++9E9B              ;------------------------------------------------------------------------------
 538++9E9B              sdSendAcmd_41	ifused
 539++9E9B              ; 樠樨 (⮫쪮  SDC)
 540++9E9B              ;:  h - ࠬ 
 541++9E9B              ;: a - ﭨ  DATA
 542++9E9B              ;     cy=0 - 訡  뫮
 543++9E9B              ;       =1 - 訡 SD 
 544++9E9B              ;
 545++9E9B              ;sdSendAcmd_41
 546++9E9B              ;
 547++9E9B CD 27 9F     	call	sdSendCmd_55
 548++9E9E CD 0C A0     	call	sdCShigh
 549++9EA1 CD F6 9F     	call	sdCSlow
 550++9EA4 ED 4B 86 99  	ld	bc,(kPortDATA)
 551++9EA8 ED 70        	in	(c)
 552++9EAA ED 70        	in	(c)
 553++9EAC 3E 69        	ld	a,sdCmd41
 554++9EAE ED 79        	out	(c),a
 555++9EB0 2E 00        	ld	l,#00
 556++9EB2 ED 61        	out	(c),h
 557++9EB4 00           	nop
 558++9EB5 ED 69        	out	(c),l
 559++9EB7 00           	nop
 560++9EB8 ED 69        	out	(c),l
 561++9EBA 00           	nop
 562++9EBB ED 69        	out	(c),l
 563++9EBD 2D           	dec	l
 564++9EBE ED 69        	out	(c),l
 565++9EC0 C3 80 9F     	jp	sdWaitCmdResp
 566++9EC3
 567++9EC3              	endif
 568++9EC3
 569++9EC3              ;------------------------------------------------------------------------------
 570++9EC3              sdSendCmd_24	ifused
 571++9EC3              ; ᥪ୮ 
 572++9EC3              ;:  dehl -  ᥪ
 573++9EC3              ;: a - ﭨ  DATA
 574++9EC3              ;     cy=0 - 訡  뫮
 575++9EC3              ;       =1 - 訡 SD 
 576++9EC3              ;
 577++9EC3              ;sdSendCmd_24
 578++9EC3              ;
 579++9EC3 3E 58        	ld	a,sdCmd24
 580++9EC5 18 0A        	jr	goto025
 581++9EC7 18 06        	jr	sdSendCmd_18
 582++9EC9              	org	$-2
 583++9EC7
 584++9EC7              	endif
 585++9EC7
 586++9EC7              ;------------------------------------------------------------------------------
 587++9EC7              sdSendCmd_25	ifused
 588++9EC7              ; -ᥪ୮  (襭 ந  ⮯ ⮪!)
 589++9EC7              ;:  dehl -  ᥪ
 590++9EC7              ;: a - ﭨ  DATA
 591++9EC7              ;     cy=0 - 訡  뫮
 592++9EC7              ;       =1 - 訡 SD 
 593++9EC7              ;
 594++9EC7              ;sdSendCmd_25
 595++9EC7              ;
 596++9EC7 3E 59        	ld	a,sdCmd25
 597++9EC9 18 06        	jr	goto025
 598++9ECB 18 02        	jr	sdSendCmd_18
 599++9ECD              	org	$-2
 600++9ECB
 601++9ECB              	endif
 602++9ECB
 603++9ECB              ;------------------------------------------------------------------------------
 604++9ECB              sdSendCmd_17	ifused
 605++9ECB              ; ᥪ୮ ⥭
 606++9ECB              ;:  dehl -  ᥪ
 607++9ECB              ;: a - ﭨ  DATA
 608++9ECB              ;     cy=0 - 訡  뫮
 609++9ECB              ;       =1 - 訡 SD 
 610++9ECB              ;
 611++9ECB              ;sdSendCmd_17
 612++9ECB              ;
 613++9ECB 3E 51        	ld	a,sdCmd17
 614++9ECD 18 02        	jr	goto025
 615++9ECF 18 FE        	jr	sdSendCmd_18
 616++9ED1              	org	$-2
 617++9ECF
 618++9ECF              	endif
 619++9ECF
 620++9ECF              ;------------------------------------------------------------------------------
 621++9ECF              sdSendCmd_18	ifused
 622++9ECF              ; -ᥪ୮ ⥭ (襭 ந  cmd12)
 623++9ECF              ;:  dehl -  ᥪ
 624++9ECF              ;: a - ﭨ  DATA
 625++9ECF              ;     cy=0 - 訡  뫮
 626++9ECF              ;       =1 - 訡 SD 
 627++9ECF              ;
 628++9ECF              ;sdSendCmd_18
 629++9ECF              ;
 630++9ECF 3E 52        	ld	a,sdCmd18
 631++9ED1 CD 0C A0     goto025	call	sdCShigh
 632++9ED4 CD F6 9F     	call	sdCSlow
 633++9ED7 E5           	push	hl
 634++9ED8 D5           	push	de
 635++9ED9 C5           	push	bc
 636++9EDA 4F           	ld	c,a
 637++9EDB              	IFDEF	ver1_10			; ᨨ v1.10
 638++9EDB 3A 68 A4     	 ld	a,(devFlags)		;⨯ 樨
 639++9EDE CB 57        	 bit	2,a
 640++9EE0              	ELSE				; ᨨ v1.00
 641++9EE0 ~            	 ld	a,(sdFlags)		;⨯ 樨
 642++9EE0 ~            	 bit	4,a
 643++9EE0              	ENDIF
 644++9EE0 20 0A        	jr	nz,goto026		;
 645++9EE2 29           	add	hl,hl
 646++9EE3 EB           	ex	de,hl
 647++9EE4 ED 6A        	adc	hl,hl
 648++9EE6 EB           	ex	de,hl
 649++9EE7 53           	ld	d,e
 650++9EE8 5C           	ld	e,h
 651++9EE9 65           	ld	h,l
 652++9EEA 2E 00        	ld	l,#00
 653++9EEC 79           goto026	ld	a,c
 654++9EED ED 4B 86 99  	ld	bc,(kPortDATA)
 655++9EF1 ED 70        	in	(c)
 656++9EF3 ED 70        	in	(c)
 657++9EF5 ED 79        	out	(c),a
 658++9EF7 00           	nop
 659++9EF8 ED 51        	out	(c),d
 660++9EFA 00           	nop
 661++9EFB ED 59        	out	(c),e
 662++9EFD 00           	nop
 663++9EFE ED 61        	out	(c),h
 664++9F00 00           	nop
 665++9F01 ED 69        	out	(c),l
 666++9F03 3E FF        	ld	a,#FF
 667++9F05 ED 79        	out	(c),a
 668++9F07 C1           	pop	bc
 669++9F08 D1           	pop	de
 670++9F09 E1           	pop	hl
 671++9F0A 18 74        	jr	sdWaitCmdResp
 672++9F0C
 673++9F0C              	endif
 674++9F0C
 675++9F0C              ;------------------------------------------------------------------------------
 676++9F0C              sdSendCmd_12	ifused
 677++9F0C              ;襭 ।  (뢠  襭 -ᥪ୮ ⥭)
 678++9F0C              ;:  ---
 679++9F0C              ;: a - ﭨ  DATA
 680++9F0C              ;     cy=0 - 訡  뫮
 681++9F0C              ;       =1 - 訡 SD 
 682++9F0C              ;
 683++9F0C              ;sdSendCmd_12
 684++9F0C              ;
 685++9F0C 3E 4C        	ld	a,sdCmd12
 686++9F0E CD 38 9F     	call	sdSendCmd_A
 687++9F11 C5           	push	bc
 688++9F12 ED 4B 86 99  	ld	bc,(kPortDATA)
 689++9F16 ED 78        	in	a,(c)
 690++9F18 C1           	pop	bc
 691++9F19 18 65        	jr	sdWaitCmdResp
 692++9F1B
 693++9F1B              	endif
 694++9F1B
 695++9F1B              ;------------------------------------------------------------------------------
 696++9F1B              sdSendCmd_10	ifused
 697++9F1B              ;⥭ CID
 698++9F1B              ;:  ---
 699++9F1B              ;: a - ﭨ  DATA
 700++9F1B              ;     cy=0 - 訡  뫮
 701++9F1B              ;       =1 - 訡 SD 
 702++9F1B              ;
 703++9F1B              ;sdSendCmd_10
 704++9F1B              ;
 705++9F1B 3E 4A        	ld	a,sdCmd10
 706++9F1D 18 0E        	jr	goto042
 707++9F1F 18 0A        	jr	sdSendCmd_01
 708++9F21              	org	$-2
 709++9F1F
 710++9F1F              	endif
 711++9F1F
 712++9F1F              ;------------------------------------------------------------------------------
 713++9F1F              sdSendCmd_09	ifused
 714++9F1F              ;⥭ CSD
 715++9F1F              ;:  ---
 716++9F1F              ;: a - ﭨ  DATA
 717++9F1F              ;     cy=0 - 訡  뫮
 718++9F1F              ;       =1 - 訡 SD 
 719++9F1F              ;
 720++9F1F              ;sdSendCmd_09
 721++9F1F              ;
 722++9F1F 3E 49        	ld	a,sdCmd09
 723++9F21 18 0A        	jr	goto042
 724++9F23 18 06        	jr	sdSendCmd_01
 725++9F25              	org	$-2
 726++9F23
 727++9F23              	endif
 728++9F23
 729++9F23              ;------------------------------------------------------------------------------
 730++9F23              sdSendCmd_58	ifused
 731++9F23              ;⥭ OCR
 732++9F23              ;:  ---
 733++9F23              ;: a - ﭨ  DATA
 734++9F23              ;     cy=0 - 訡  뫮
 735++9F23              ;       =1 - 訡 SD 
 736++9F23              ;
 737++9F23              ;sdSendCmd_58
 738++9F23              ;
 739++9F23 3E 7A        	ld	a,sdCmd58
 740++9F25 18 06        	jr	goto042
 741++9F27 18 02        	jr	sdSendCmd_01
 742++9F29              	org	$-2
 743++9F27
 744++9F27              	endif
 745++9F27
 746++9F27              ;------------------------------------------------------------------------------
 747++9F27              sdSendCmd_55	ifused
 748++9F27              ;뢠 । ACMD<n>
 749++9F27              ;:  ---
 750++9F27              ;: a - ﭨ  DATA
 751++9F27              ;     cy=0 - 訡  뫮
 752++9F27              ;       =1 - 訡 SD 
 753++9F27              ;
 754++9F27              ;sdSendCmd_55
 755++9F27              ;
 756++9F27 3E 77        	ld	a,sdCmd55
 757++9F29 18 02        	jr	goto042
 758++9F2B 18 FE        	jr	sdSendCmd_01
 759++9F2D              	org	$-2
 760++9F2B
 761++9F2B              	endif
 762++9F2B
 763++9F2B              ;------------------------------------------------------------------------------
 764++9F2B              sdSendCmd_01	ifused
 765++9F2B              ; 樠樨 (⮫쪮  MMC)
 766++9F2B              ;:  ---
 767++9F2B              ;: a - ﭨ  DATA
 768++9F2B              ;     cy=0 - 訡  뫮
 769++9F2B              ;       =1 - 訡 SD 
 770++9F2B              ;
 771++9F2B              ;sdSendCmd_01
 772++9F2B              ;
 773++9F2B 3E 41        	ld	a,sdCmd01
 774++9F2D CD 32 9F     goto042	call	sdSendCmd_A_CS
 775++9F30 18 4E        	jr	sdWaitCmdResp
 776++9F32
 777++9F32              	endif
 778++9F32
 779++9F32              ;------------------------------------------------------------------------------
 780++9F32              sdSendCmd_A_CS	ifused
 781++9F32              ;뤠    c ⠢ ᨣ CS
 782++9F32              ;:  a -  
 783++9F32              ;: a=#FF
 784++9F32              ;
 785++9F32              ;sdSendCmd_A_CS
 786++9F32              ;
 787++9F32 CD 0C A0     	call	sdCShigh
 788++9F35 CD F6 9F     	call	sdCSlow
 789++9F38 18 FE        	jr	sdSendCmd_A
 790++9F3A              	org	$-2
 791++9F38
 792++9F38              	endif
 793++9F38
 794++9F38              ;------------------------------------------------------------------------------
 795++9F38              sdSendCmd_A	ifused
 796++9F38              ;뤠   
 797++9F38              ;    #nn #00 #00 #00 #00 #FF
 798++9F38              ;:  a -  
 799++9F38              ;: a=#FF
 800++9F38              ;
 801++9F38              ;sdSendCmd_A
 802++9F38              ;
 803++9F38 C5           	push	bc
 804++9F39 ED 4B 86 99  	ld	bc,(kPortDATA)
 805++9F3D ED 70        	in	(c)
 806++9F3F ED 70        	in	(c)
 807++9F41 ED 79        	out	(c),a
 808++9F43 AF           	xor	a
 809++9F44 ED 79        	out	(c),a
 810++9F46 00           	nop
 811++9F47 ED 79        	out	(c),a
 812++9F49 00           	nop
 813++9F4A ED 79        	out	(c),a
 814++9F4C 00           	nop
 815++9F4D ED 79        	out	(c),a
 816++9F4F 3D           	dec	a
 817++9F50 ED 79        	out	(c),a
 818++9F52 C1           	pop	bc
 819++9F53 C9           	ret
 820++9F54
 821++9F54              	endif
 822++9F54
 823++9F54              ;------------------------------------------------------------------------------
 824++9F54              sdSendCmd_16	ifused
 825++9F54              ;뤠  #10   ( ࠧ )   ᥣ 512
 826++9F54              ;:  ---
 827++9F54              ;: bc -  DATA
 828++9F54              ;     a - ﭨ  DATA
 829++9F54              ;     cy=0 - 訡  뫮
 830++9F54              ;       =1 - 訡 SD 
 831++9F54              ;     hl - ???
 832++9F54              ;
 833++9F54              ;sdSendCmd_16
 834++9F54              ;
 835++9F54 21 49 A0     	ld	hl,sdCmd16
 836++9F57 18 08        	jr	sdSendCmd_HL
 837++9F59
 838++9F59              	endif
 839++9F59
 840++9F59              ;------------------------------------------------------------------------------
 841++9F59              sdSendCmd_08	ifused
 842++9F59              ;뤠  #08   (㧭  殮 㦭 )
 843++9F59              ;  ⮫쪮  SDCv2
 844++9F59              ;:  ---
 845++9F59              ;: bc -  DATA
 846++9F59              ;     a - ﭨ  DATA
 847++9F59              ;     cy=0 - 訡  뫮
 848++9F59              ;       =1 - 訡 SD 
 849++9F59              ;     hl - ???
 850++9F59              ;
 851++9F59              ;sdSendCmd_08
 852++9F59              ;
 853++9F59 21 43 A0     	ld	hl,sdCmd08
 854++9F5C 18 03        	jr	sdSendCmd_HL
 855++9F5E
 856++9F5E              	endif
 857++9F5E
 858++9F5E              ;------------------------------------------------------------------------------
 859++9F5E              sdSendCmd_00	ifused
 860++9F5E              ;뤠  #00   (ணࠬ  )
 861++9F5E              ;:  ---
 862++9F5E              ;: bc -  DATA
 863++9F5E              ;     a - ﭨ  DATA
 864++9F5E              ;     cy=0 - 訡  뫮
 865++9F5E              ;       =1 - 訡 SD 
 866++9F5E              ;     hl - ???
 867++9F5E              ;
 868++9F5E              ;sdSendCmd_00
 869++9F5E              ;
 870++9F5E 21 3D A0     	ld	hl,sdCmd00
 871++9F61 18 FE        	jr	sdSendCmd_HL
 872++9F63              	org	$-2
 873++9F61
 874++9F61              	endif
 875++9F61
 876++9F61              ;------------------------------------------------------------------------------
 877++9F61              sdSendCmd_HL	ifused
 878++9F61              ;뤠   
 879++9F61              ;:  hl -  砫 
 880++9F61              ;: bc -  DATA
 881++9F61              ;     a - ﭨ  DATA
 882++9F61              ;     hl=hl+6
 883++9F61              ;     cy=0 - 訡  뫮
 884++9F61              ;       =1 - 訡 SD 
 885++9F61              ;
 886++9F61              ;sdSendCmd_HL
 887++9F61              ;
 888++9F61 CD 0C A0     	call	sdCShigh
 889++9F64 CD F6 9F     	call	sdCSlow
 890++9F67 ED 4B 86 99  	ld	bc,(kPortDATA)
 891++9F6B ED 70        	in	(c)
 892++9F6D ED 70        	in	(c)
 893++9F6F ED A3        	outi
 894++9F71 00           	nop
 895++9F72 ED A3        	outi
 896++9F74 00           	nop
 897++9F75 ED A3        	outi
 898++9F77 00           	nop
 899++9F78 ED A3        	outi
 900++9F7A 00           	nop
 901++9F7B ED A3        	outi
 902++9F7D 00           	nop
 903++9F7E ED A3        	outi
 904++9F80 18 FE        	jr	sdWaitCmdResp
 905++9F82              	org	$-2
 906++9F80
 907++9F80              	endif
 908++9F80
 909++9F80              ;------------------------------------------------------------------------------
 910++9F80              sdWaitCmdResp	ifused
 911++9F80              ; cmd. Resp. ( 祭 80 ⠪஢)
 912++9F80              ;:  ---
 913++9F80              ;: a - ﭨ  DATA
 914++9F80              ;     cy=0 - 訡  뫮
 915++9F80              ;       =1 - 訡 SD 
 916++9F80              ;
 917++9F80              ;sdWaitCmdResp
 918++9F80              ;
 919++9F80 D5           	push	de
 920++9F81 C5           	push	bc
 921++9F82 ED 4B 86 99  	ld	bc,(kPortDATA)
 922++9F86 16 0A        	ld	d,10
 923++9F88 ED 78        loop023	in	a,(c)
 924++9F8A B7           	or	a			;nc
 925++9F8B F2 92 9F     	jp	p,goto024		;7,a=0
 926++9F8E 15           	dec	d
 927++9F8F 20 F7        	jr	nz,loop023
 928++9F91 37           	scf
 929++9F92 C1           goto024	pop	bc
 930++9F93 D1           	pop	de
 931++9F94 C9           	ret
 932++9F95
 933++9F95              	endif
 934++9F95
 935++9F95              ;------------------------------------------------------------------------------
 936++9F95              sdWaitDR	ifused
 937++9F95              ; Data Response
 938++9F95              ;:  ---
 939++9F95              ;: cy=0 - 訡  뫮
 940++9F95              ;       =1 - 訡 SD 
 941++9F95              ;
 942++9F95              ;sdWaitDR
 943++9F95              ;
 944++9F95 F5           	push	af
 945++9F96 CD D9 9F     	call	sdWaitDO
 946++9F99 E6 1F        	and	#1F
 947++9F9B FE 05        	cp	#05
 948++9F9D 20 06        	jr	nz,goto023		;᫨ Data Resp. ਭ  訡,    (%0XXX1, xxx -   [%010 -  ਭ])
 949++9F9F CD CB 9F     	call	sdWaitNoBusy		;  ன busy
 950++9FA2 F1           	pop	af
 951++9FA3 B7           	or	a
 952++9FA4 C9           	ret
 953++9FA5 CD AB 9F     goto023	call	sdSendEndToken		; ⮯ ⮪
 954++9FA8              ;	call	sdOffSD			;㡠 ⠭ 
 955++9FA8 F1           	pop	af
 956++9FA9 37           	scf
 957++9FAA C9           	ret
 958++9FAB
 959++9FAB              	endif
 960++9FAB
 961++9FAB              ;------------------------------------------------------------------------------
 962++9FAB              sdSendEndToken	ifused
 963++9FAB              ;뤠 ⮪  -ᥪ୮ 樨
 964++9FAB              ;:  ---
 965++9FAB              ;: bc -  DATA
 966++9FAB              ;     a=#FD
 967++9FAB              ;
 968++9FAB              ;sdSendEndToken
 969++9FAB              ;
 970++9FAB ED 4B 86 99  	ld	bc,(kPortDATA)
 971++9FAF 3E FD        	ld	a,#FD			;⮪  -ᥪ୮ 樨
 972++9FB1 ED 79        	out	(c),a
 973++9FB3 CD BB 9F     	call	sdWait128tact
 974++9FB6 CD CB 9F     	call	sdWaitNoBusy
 975++9FB9 18 51        	jr	sdCShigh
 976++9FBB
 977++9FBB              	endif
 978++9FBB
 979++9FBB              ;------------------------------------------------------------------------------
 980++9FBB              sdWait128tact	ifused
 981++9FBB              ;㧠  128 ⠪஢
 982++9FBB              ;:  ---
 983++9FBB              ;: ॣ  
 984++9FBB              ;
 985++9FBB              ;sdWait128tact
 986++9FBB              ;
 987++9FBB C5           	push	bc
 988++9FBC F5           	push	af
 989++9FBD 3E 10        	ld	a,#10
 990++9FBF ED 4B 86 99  loop022	ld	bc,(kPortDATA)
 991++9FC3 ED 48        	in	c,(c)
 992++9FC5 3D           	dec	a
 993++9FC6 20 F7        	jr	nz,loop022
 994++9FC8 F1           	pop	af
 995++9FC9 C1           	pop	bc
 996++9FCA C9           	ret
 997++9FCB
 998++9FCB              	endif
 999++9FCB
1000++9FCB              ;------------------------------------------------------------------------------
1001++9FCB              sdWaitNoBusy	ifused
1002++9FCB              ;  BUSY
1003++9FCB              ;:  ---
1004++9FCB              ;: ॣ  
1005++9FCB              ;
1006++9FCB              ;sdWaitNoBusy
1007++9FCB              ;
1008++9FCB C5           	push	bc
1009++9FCC F5           	push	af
1010++9FCD ED 4B 86 99  	ld	bc,(kPortDATA)
1011++9FD1 ED 78        loop021	in	a,(c)
1012++9FD3 B7           	or	a
1013++9FD4 28 FB        	jr	z,loop021
1014++9FD6 F1           	pop	af
1015++9FD7 C1           	pop	bc
1016++9FD8 C9           	ret
1017++9FD9
1018++9FD9              	endif
1019++9FD9
1020++9FD9              ;------------------------------------------------------------------------------
1021++9FD9              sdWaitDO	ifused
1022++9FD9              ; DO
1023++9FD9              ;:  ---
1024++9FD9              ;: a - ﭨ  DATA
1025++9FD9              ;     z -> a=#FE
1026++9FD9              ;
1027++9FD9              ;sdWaitDO
1028++9FD9              ;
1029++9FD9 C5           	push	bc
1030++9FDA ED 4B 86 99  	ld	bc,(kPortDATA)
1031++9FDE ED 78        loop020	in	a,(c)
1032++9FE0 FE FF        	cp	#FF
1033++9FE2 28 FA        	jr	z,loop020
1034++9FE4 C1           	pop	bc
1035++9FE5 FE FE        	cp	#FE
1036++9FE7 C9           	ret
1037++9FE8
1038++9FE8              	endif
1039++9FE8
1040++9FE8              ;------------------------------------------------------------------------------
1041++9FE8              sdOffSD		ifused
1042++9FE8 ~            ;몫祭 ⠭ 
1043++9FE8 ~            ;:  ---
1044++9FE8 ~            ;: a=#00
1045++9FE8 ~            ;
1046++9FE8 ~            ;sdOffSD
1047++9FE8 ~            ;
1048++9FE8 ~            	push	bc
1049++9FE8 ~            	xor	a
1050++9FE8 ~            	ld	bc,(kPortCONF)
1051++9FE8 ~            	out	(c),a
1052++9FE8 ~            	ld	bc,(kPortDATA)
1053++9FE8 ~            	out	(c),a
1054++9FE8 ~            	pop	bc
1055++9FE8 ~            	ret
1056++9FE8 ~
1057++9FE8              	endif
1058++9FE8
1059++9FE8              ;------------------------------------------------------------------------------
1060++9FE8              sdFakeRead	ifused
1061++9FE8              ;宫 㧪  ⢠ ⮢  SPI
1062++9FE8              ;:  de - ⢮ 
1063++9FE8              ;: bc -  DATA
1064++9FE8              ;     de=#0000
1065++9FE8              ;     a=#00
1066++9FE8              ;
1067++9FE8              ;sdFakeRead
1068++9FE8              ;
1069++9FE8 ED 4B 86 99  	ld	bc,(kPortDATA)
1070++9FEC 3E FF        loop019	ld	a,#FF
1071++9FEE ED 79        	out	(c),a
1072++9FF0 1B           	dec	de
1073++9FF1 7A           	ld	a,d
1074++9FF2 B3           	or	e
1075++9FF3 20 F7        	jr	nz,loop019
1076++9FF5 C9           	ret
1077++9FF6
1078++9FF6              	endif
1079++9FF6
1080++9FF6              ;------------------------------------------------------------------------------
1081++9FF6              sdCSlow		ifused
1082++9FF6              ;⠢ CS  0
1083++9FF6              ;:  ---
1084++9FF6              ;: ॣ  
1085++9FF6              ;
1086++9FF6              ;sdCSlow
1087++9FF6              ;
1088++9FF6 C5           	push	bc
1089++9FF7 F5           	push	af
1090++9FF8
1091++9FF8 ED 4B 84 99  	ld	bc,(kPortCONF)
1092++9FFC 3A 88 99     	ld	a,(kPortCSlow)		;%00000001
1093++9FFF ED 79        	out	(c),a
1094++A001 ED 4B 86 99  	ld	bc,(kPortDATA)
1095++A005 3E FF        	ld	a,#FF
1096++A007 ED 79        	out	(c),a
1097++A009
1098++A009 F1           	pop	af
1099++A00A C1           	pop	bc
1100++A00B              ;	jr	sdWait
1101++A00B C9           	ret
1102++A00C
1103++A00C              	endif
1104++A00C
1105++A00C              ;------------------------------------------------------------------------------
1106++A00C              sdCShigh	ifused
1107++A00C              ;⠢ CS  1
1108++A00C              ;:  ---
1109++A00C              ;: ॣ  
1110++A00C              ;
1111++A00C              ;sdCShigh
1112++A00C              ;
1113++A00C C5           	push	bc
1114++A00D F5           	push	af
1115++A00E
1116++A00E ED 4B 84 99  	ld	bc,(kPortCONF)
1117++A012 3A 8A 99     	ld	a,(kPortCSHigh)		;%00000011
1118++A015 ED 79        	out	(c),a
1119++A017 ED 4B 86 99  	ld	bc,(kPortDATA)
1120++A01B 3E FF        	ld	a,#FF
1121++A01D ED 79        	out	(c),a
1122++A01F
1123++A01F F1           	pop	af
1124++A020 C1           	pop	bc
1125++A021 C9           	ret
1126++A022
1127++A022              	endif
1128++A022
1129++A022              ;------------------------------------------------------------------------------
1130++A022              sdWait		ifused
1131++A022              ; ⮩ 設
1132++A022              ;:  ---
1133++A022              ;: ॣ  
1134++A022              ;
1135++A022              ;sdWait
1136++A022              ;
1137++A022 D5           	push	de
1138++A023 C5           	push	bc
1139++A024 F5           	push	af
1140++A025 11 00 10     	ld	de,#1000
1141++A028 ED 4B 86 99  	ld	bc,(kPortDATA)
1142++A02C ED 78        loop018	in	a,(c)
1143++A02E FE FF        	cp	#FF
1144++A030 28 06        	jr	z,goto041
1145++A032 1B           	dec	de
1146++A033 7A           	ld	a,d
1147++A034 B3           	or	e
1148++A035 20 F5        	jr	nz,loop018
1149++A037 37           	scf
1150++A038 C1           goto041	pop	bc
1151++A039 78           	ld	a,b
1152++A03A C1           	pop	bc
1153++A03B D1           	pop	de
1154++A03C C9           	ret
1155++A03D
1156++A03D              	endif
1157++A03D
1158++A03D              ;==============================================================================
1159++A03D              	IFDEF	SDcard
1160++A03D              ;
1161++A03D              sdCmd01	equ #40+#01				;樠
1162++A03D              sdCmd09	equ #40+#09				;⥭ CSD
1163++A03D              sdCmd10	equ #40+#0A				;⥭ CID
1164++A03D              sdCmd12	equ #40+#0C				;⠭ ।
1165++A03D              sdCmd17	equ #40+#11				;ᥪ୮ ⥭
1166++A03D              sdCmd18	equ #40+#12				;ᥪ୮ ⥭
1167++A03D              sdCmd24	equ #40+#18				;ᥪୠ 
1168++A03D              sdCmd25	equ #40+#19				;ᥪୠ 
1169++A03D              sdCmd41	equ #40+#29				;樠 (⮫쪮 SDC)
1170++A03D              sdCmd55	equ #40+#37				; 䨪  ACMD
1171++A03D              sdCmd58	equ #40+#3A				;⥭ OCR
1172++A03D 40 00 00 00  sdCmd00	db  %01000000+#00,#00,#00,#00,#00,#95	;ணࠬ 
1172++A041 00 95
1173++A043 48 00 00 01  sdCmd08	db  %01000000+#08,#00,#00,#01,#AA,#87	;殮  (⮫쪮  SDCv2)
1173++A047 AA 87
1174++A049 50 00 00 02  sdCmd16	db  %01000000+#10,#00,#00,#02,#00,#FF	; ࠧ  (512)
1174++A04D 00 FF
1175++A04F              	ENDIF
1176++A04F              ;==============================================================================
1177++A04F
# file closed: Drivers/DrvHDD/DrvHDD.spi.a80
 228+ A04F              	INCLUDE		"DrvHDD.ide.a80"
# file opened: Drivers/DrvHDD/DrvHDD.ide.a80
   1++A04F              ;楤  HDD Driver. 楤  ࠡ  ⠬ ஫஢ IDE
   2++A04F              ;䠩 DrvHDD.ide.a80
   3++A04F              ;
   4++A04F              ;hddTestInit		஢ઠ ⢮ 
   5++A04F              ;hddReadIdSec		⥭ ᥪ 䨪樨      ix
   6++A04F              ;hddCheckError		஢ઠ  訡  室,  砥 訡  
   7++A04F              ;hddResetSmuc		ணࠬ   SMUC
   8++A04F              ;hddResetNemo		ணࠬ   NEMO
   9++A04F              ;hddReadDataSv1		⥭ 512b    㥬 hl ( SMUC v1 shadow)
  10++A04F              ;hddReadDataSv2		⥭ 512b    㥬 hl ( SMUC v2)
  11++A04F              ;hddReadDataN		⥭ 512b    㥬 hl ( NEMO)
  12++A04F              ;hddReadDataNA8		⥭ 512b    㥬 hl ( NEMO A8)
  13++A04F              ;hddReadDataAtm		⥭ 512b    㥬 hl ( ATM-IDE)
  14++A04F              ;hddReadDataPrf		⥭ 512b    㥬 hl ( PROFI IDE)
  15++A04F              ;hddWriteDataSv1	 512b    㥬 hl ( SMUC v1 shadow)
  16++A04F              ;hddWriteDataSv2	 512b    㥬 hl ( SMUC v2)
  17++A04F              ;hddWriteDataN		 512b    㥬 hl ( NEMO)
  18++A04F              ;hddWriteDataNA8	 512b    㥬 hl ( NEMO A8)
  19++A04F              ;hddWriteDataAtm	 512b    㥬 hl ( ATM-IDE)
  20++A04F              ;hddWriteDataPrf	 512b    㥬 hl ( PROFI-IDE)
  21++A04F              ;hddSendCmd		뫠  
  22++A04F              ;hddWaitReadyData	 ⮢ HDD  । 
  23++A04F              ;hddWaitReadyCmd	 ⮢ HDD  ਭ 
  24++A04F              ;hddWaitNoBusy		 ⮢ HDD
  25++A04F              ;smucTest3FF0		஢ઠ    ࠡ Smuc v1
  26++A04F              ;profiPortsOff		몫祭 ⮢ PROFI
  27++A04F              ;profiPortsOn		祭 ⮢ PROFI
  28++A04F              ;atmPortsOff		몫祭 ⮢ ATM
  29++A04F              ;atmPortsOn		祭 ⮢ ATM
  30++A04F              ;out_C_A_2A53		  ⥭ 
  31++A04F              ;out_C_A		  ⥭ 
  32++A04F              ;in_A_C_profi		⥭  PROFI
  33++A04F              ;in_A_C			⥭ ⥭ 
  34++A04F              ;
  35++A04F              ;------------------------------------------------------------------------------
  36++A04F              hddTestInit	ifused
  37++A04F              ;஢ઠ ⢮ 
  38++A04F              ;:  ix -    ⥭ 䨪樮 ᥪ
  39++A04F              ;     a=#A0/#B0 ஢塞 Master/Slave
  40++A04F              ;: cy=1 訡 ⥭/    
  41++A04F              ;       a=#56 hard disk not found
  42++A04F              ;       a=#57 hard disk R/W error
  43++A04F              ;       a=#60 busy not found
  44++A04F              ;       a=#61 hard disk not ready
  45++A04F              ;       a=#62 hard disk data not ready
  46++A04F              ;     cy=0  㦥,  ix ⠭ ᥪ 䨪樨
  47++A04F              ;       a=#00
  48++A04F              ;       hl,de,bc - ????
  49++A04F              ;
  50++A04F              ;hddTestInit
  51++A04F              ;
  52++A04F              ;⠭  master/slave  LBA addr =#00000000
  53++A04F 57           	ld	d,a
  54++A050 1E 06        	ld	e,#06
  55++A052 AF           	xor	a
  56++A053 21 86 99     	ld	hl,kPort1F1
  57++A056 4E           loop016	ld	c,(hl)
  58++A057 23           	inc	hl
  59++A058 46           	ld	b,(hl)
  60++A059 23           	inc	hl
  61++A05A 1D           	dec	e
  62++A05B C4 6C 99     	call	nz,kOut_C_A
  63++A05E 20 F6        	jr	nz,loop016
  64++A060 7A           	ld	a,d
  65++A061 CD 6C 99     	call	kOut_C_A
  66++A064              ;d=#A0/#B0 ஢塞 Master/Slave
  67++A064
  68++A064              ;ࠢ塞  #90 (EXECUTE DEVICE DIAGNOSTIC)
  69++A064 CD FD A2     	call	hddWaitReadyCmd		;->bc -  #1F7 - Command/Status
  70++A067 D8           	ret	c			;error -> a=#60/#61
  71++A068 3E 90        	ld	a,#90			;EXECUTE DEVICE DIAGNOSTIC
  72++A06A CD 6C 99     	call	kOut_C_A
  73++A06D CD 19 A3     	call	hddWaitNoBusy
  74++A070 D8           	ret	c			;error -> a=#60
  75++A071              ;  ஢塞 ⢥
  76++A071 ED 4B 86 99  	ld	bc,(kPort1F1)		;Error
  77++A075 CD 6F 99     	call	kIn_A_C
  78++A078 CB 62        	bit	4,d
  79++A07A 28 04        	jr	z,goto019		;䨪 master`
  80++A07C FE 80        	cp	#80
  81++A07E 28 04        	jr	z,goto020		;slave   
  82++A080 FE 01        goto019	cp	#01
  83++A082 20 3E        	jr	nz,goto021		;master/slave 
  84++A084
  85++A084              ;  
  86++A084              ;  ஢塞 ᨣ
  87++A084 ED 4B 8E 99  goto020	ld	bc,(kPort1F5)		;Cylinder high
  88++A088 CD 6F 99     	call	kIn_A_C
  89++A08B 5F           	ld	e,a
  90++A08C ED 4B 8C 99  	ld	bc,(kPort1F4)		;Cylinder low
  91++A090 CD 6F 99     	call	kIn_A_C
  92++A093 B3           	or	e
  93++A094 20 2C        	jr	nz,goto021		;  ,   ஢ ᨣ CD
  94++A096 ED 4B 8A 99  	ld	bc,(kPort1F3)		;Sector number
  95++A09A CD 6F 99     	call	kIn_A_C
  96++A09D 5F           	ld	e,a
  97++A09E 1D           	dec	e
  98++A09F ED 4B 88 99  	ld	bc,(kPort1F2)		;Sector count
  99++A0A3 CD 6F 99     	call	kIn_A_C
 100++A0A6 3D           	dec	a
 101++A0A7 B3           	or	e
 102++A0A8 20 18        	jr	nz,goto021		;  ,   ஢ ᨣ CD
 103++A0AA CD C8 A0     	call	hddReadIdSec		;⠥ ᥪ 䨪樨
 104++A0AD D8           	ret	c			;a=#57/#60/#61/#62
 105++A0AE              ;  ஢塞   㫨   ᫮
 106++A0AE 4E           	ld	c,(hl)
 107++A0AF 23           	inc	hl
 108++A0B0 46           	ld	b,(hl)			;bc - ࢮ ᫮
 109++A0B1 23           	inc	hl
 110++A0B2 3E FF        	ld	a,#FF
 111++A0B4 5E           loop017	ld	e,(hl)			;ࠢ  ⠫묨
 112++A0B5 23           	inc	hl
 113++A0B6 56           	ld	d,(hl)
 114++A0B7 23           	inc	hl
 115++A0B8 EB           	ex	de,hl
 116++A0B9 B7           	or	a
 117++A0BA ED 42        	sbc	hl,bc
 118++A0BC EB           	ex	de,hl
 119++A0BD 20 07        	jr	nz,goto022		;  ᫮
 120++A0BF 3D           	dec	a
 121++A0C0 20 F2        	jr	nz,loop017
 122++A0C2
 123++A0C2              ;  
 124++A0C2 3E 56        goto021	ld	a,#56
 125++A0C4 37           	scf
 126++A0C5 C9           	ret
 127++A0C6
 128++A0C6              ; ஢ન ன,  
 129++A0C6 AF           goto022	xor	a
 130++A0C7 C9           	ret
 131++A0C8
 132++A0C8              	endif
 133++A0C8
 134++A0C8              ;------------------------------------------------------------------------------
 135++A0C8              hddReadIdSec	ifused
 136++A0C8              ;⥭ ᥪ 䨪樨      ix
 137++A0C8              ;:  ix -    ⥭ ᥪ 䨪樨
 138++A0C8              ;     d=#E0/#F0 - master/slave
 139++A0C8              ;: cy=1 訡   -> a -  訡
 140++A0C8              ;       a=#57 hard disk R/W error
 141++A0C8              ;       a=#60 busy not found
 142++A0C8              ;       a=#61 hard disk not ready
 143++A0C8              ;       a=#62 hard disk data not ready
 144++A0C8              ;     cy=0 ᥪ ⠭
 145++A0C8              ;       hl -   ᥪ஬
 146++A0C8              ;       bc= #1F7
 147++A0C8              ;
 148++A0C8              ;hddReadIdSec
 149++A0C8              ;
 150++A0C8 ED 4B 90 99  	ld	bc,(kPort1F6)
 151++A0CC 7A           	ld	a,d
 152++A0CD CD 6C 99     	call	kOut_C_A
 153++A0D0 CD FD A2     	call	hddWaitReadyCmd		;->bc -  #1F7 - Command/Status
 154++A0D3 D8           	ret	c			;error -> a=#60/#61
 155++A0D4 3E EC        	ld	a,#EC			;IDENTIFY DEVICE
 156++A0D6 CD 6C 99     	call	kOut_C_A
 157++A0D9 CD E4 A2     	call	hddWaitReadyData
 158++A0DC DA 78 99     	jp	c,kHddReset		;error -> a=#60/#62
 159++A0DF DD E5        	push	ix
 160++A0E1 E1           	pop	hl			;   ⥭ ᥪ
 161++A0E2 CD 75 99     	call	kHddReadData
 162++A0E5 C3 E5 A0     	jp	hddCheckError		;error -> a=#57
 163++A0E8              	org	$-3
 164++A0E5
 165++A0E5              	endif
 166++A0E5
 167++A0E5              ;------------------------------------------------------------------------------
 168++A0E5              hddCheckError	ifused
 169++A0E5              ;஢ઠ  訡  室,  砥 訡  
 170++A0E5              ;: cy=0 訡  뫮
 171++A0E5              ;       =1 뫨 訡 -> a=#57, (ideError) -  訡 
 172++A0E5              ;
 173++A0E5              ;hddCheckError
 174++A0E5              ;
 175++A0E5 ED 4B 92 99  	ld	bc,(kPort1F7)
 176++A0E9 CD 6F 99     	call	kIn_A_C
 177++A0EC 57           	ld	d,a			;ॣ ﭨ
 178++A0ED E6 71        	and	%01110001
 179++A0EF EE 50        	xor	%01010000
 180++A0F1 C8           	ret	z			;室  ⮢   ⢨ 訡
 181++A0F2 ED 4B 86 99  	ld	bc,(kPort1F1)
 182++A0F6 CD 6F 99     	call	kIn_A_C			;⠥  訡
 183++A0F9 32 89 A4     	ld	(ideError),a		;࠭塞
 184++A0FC 3E 57        	ld	a,#57			; 訡 ࠩ
 185++A0FE 37           	scf
 186++A0FF C3 78 99     	jp	kHddReset		;ணࠬ  
 187++A102
 188++A102              	endif
 189++A102
 190++A102              ;------------------------------------------------------------------------------
 191++A102              hddResetSmuc	ifused
 192++A102              ;ணࠬ   SMUC
 193++A102              ;
 194++A102              ;hddResetSmuc
 195++A102              ;
 196++A102 F5           	push	af
 197++A103 C5           	push	bc
 198++A104
 199++A104 01 BA FF     	ld	bc,#FFBA
 200++A107 3E F7        	ld	a,#F7
 201++A109 CD 84 A3     	call	out_C_A_2A53		;device control/alt status on
 202++A10C C5           	push	bc
 203++A10D 01 BE FE     	ld	bc,#FEBE
 204++A110 3E 0C        	ld	a,%00001100
 205++A112 CD 6C 99     	call	kOut_C_A		;ணࠬ  
 206++A115 87           	add	a,a			;㧠 383t
 207++A116 3D           loop015	dec	a			;
 208++A117 20 FD        	jr	nz,loop015		;
 209++A119 CD 6C 99     	call	kOut_C_A		;蠥 ணࠬ  
 210++A11C C1           	pop	bc
 211++A11D 3E 77        	ld	a,#77
 212++A11F CD 84 A3     	call	out_C_A_2A53		;device control/alt status off
 213++A122
 214++A122 C1           	pop	bc
 215++A123 F1           	pop	af
 216++A124 C9           	ret
 217++A125
 218++A125              	endif
 219++A125
 220++A125              ;------------------------------------------------------------------------------
 221++A125              hddResetNemo	ifused
 222++A125              ;ணࠬ   NEMO
 223++A125              ;
 224++A125              ;hddResetNemo
 225++A125              ;
 226++A125 F5           	push	af
 227++A126 C5           	push	bc
 228++A127
 229++A127              ;⠭  
 230++A127              ;	ld	bc,(kPort1F6)
 231++A127              ;	ld	a,(idePort1F6)
 232++A127              ;	out	(c),a			;  
 233++A127
 234++A127              ; 
 235++A127 ED 4B 94 99  	ld	bc,(kPort3F6)
 236++A12B 3E 04        	ld	a,%00000100
 237++A12D ED 79        	out	(c),a			;ணࠬ  
 238++A12F              	IFDEF	PROFIide
 239++A12F CD A3 A3     	 call	Pause70k
 240++A132              	ELSE
 241++A132 ~            	 xor	a			;㧠 4095t
 242++A132 ~            loop014	 dec	a			;
 243++A132 ~            	 jr	nz,loop014		;
 244++A132              	ENDIF
 245++A132 ED 79        	out	(c),a			;蠥 ணࠬ  
 246++A134              	IFDEF	PROFIide
 247++A134 CD A3 A3     	 call	Pause70k
 248++A137              	ELSE
 249++A137 ~            loop049	 dec	a			;
 250++A137 ~            	 jr	nz,loop049		;
 251++A137              	ENDIF
 252++A137
 253++A137 C1           	pop	bc
 254++A138 F1           	pop	af
 255++A139 C9           	ret
 256++A13A
 257++A13A              	endif
 258++A13A
 259++A13A              ;------------------------------------------------------------------------------
 260++A13A              hddReadDataSv1	ifused
 261++A13A              ;⥭ 512b    㥬 hl ( SMUC v1 shadow)
 262++A13A              ;:  hl -    ⥭ 
 263++A13A              ;: cy=0
 264++A13A              ;     hl -  
 265++A13A              ;     a=#00
 266++A13A              ;     de,bc - ???
 267++A13A              ;
 268++A13A              ;hddReadDataSv1
 269++A13A              ;
 270++A13A F3           	di
 271++A13B DD E5        	push	ix
 272++A13D E5           	push	hl
 273++A13E ED 73 7C A1  	ld	(cng_02+1),sp
 274++A142 EB           	ex	de,hl
 275++A143 0E BE        	ld	c,#BE
 276++A145 21 2F 3D     	ld	hl,#3D2F
 277++A148 DD 2E 40     	ld	xl,#40
 278++A14B 31 84 A1     loop013	ld	sp,var_02
 279++A14E 06 F8        	ld	b,#F8
 280++A150 E9           	jp	(hl)
 281++A151 12           goto011	ld	(de),a
 282++A152 13           	inc	de
 283++A153 06 D8        	ld	b,#D8
 284++A155 E9           	jp	(hl)
 285++A156 12           goto012	ld	(de),a
 286++A157 13           	inc	de
 287++A158 06 F8        	ld	b,#F8
 288++A15A E9           	jp	(hl)
 289++A15B 12           goto013	ld	(de),a
 290++A15C 13           	inc	de
 291++A15D 06 D8        	ld	b,#D8
 292++A15F E9           	jp	(hl)
 293++A160 12           goto014	ld	(de),a
 294++A161 13           	inc	de
 295++A162 06 F8        	ld	b,#F8
 296++A164 E9           	jp	(hl)
 297++A165 12           goto015	ld	(de),a
 298++A166 13           	inc	de
 299++A167 06 D8        	ld	b,#D8
 300++A169 E9           	jp	(hl)
 301++A16A 12           goto016	ld	(de),a
 302++A16B 13           	inc	de
 303++A16C 06 F8        	ld	b,#F8
 304++A16E E9           	jp	(hl)
 305++A16F 12           goto017	ld	(de),a
 306++A170 13           	inc	de
 307++A171 06 D8        	ld	b,#D8
 308++A173 E9           	jp	(hl)
 309++A174 12           goto018	ld	(de),a
 310++A175 13           	inc	de
 311++A176 DD 2D        	dec	xl
 312++A178 C2 4B A1     	jp	nz,loop013
 313++A17B 31 00 00     cng_02	ld	sp,#0000
 314++A17E E1           	pop	hl
 315++A17F DD E1        	pop	ix
 316++A181 FB           	ei
 317++A182 AF           	xor	a
 318++A183 C9           	ret
 319++A184 F3 3F 51 A1  var_02	dw	dosInPort,goto011
 320++A188 F3 3F 56 A1  	dw	dosInPort,goto012
 321++A18C F3 3F 5B A1  	dw	dosInPort,goto013
 322++A190 F3 3F 60 A1  	dw	dosInPort,goto014
 323++A194 F3 3F 65 A1  	dw	dosInPort,goto015
 324++A198 F3 3F 6A A1  	dw	dosInPort,goto016
 325++A19C F3 3F 6F A1  	dw	dosInPort,goto017
 326++A1A0 F3 3F 74 A1  	dw	dosInPort,goto018
 327++A1A4
 328++A1A4              	endif
 329++A1A4
 330++A1A4              ;------------------------------------------------------------------------------
 331++A1A4              hddReadDataSv2	ifused
 332++A1A4              ;⥭ 512b    㥬 hl ( SMUC v2)
 333++A1A4              ;:  hl -    ⥭ 
 334++A1A4              ;: cy=0
 335++A1A4              ;     hl -  
 336++A1A4              ;     a=#00
 337++A1A4              ;     de,bc - ???
 338++A1A4              ;
 339++A1A4              ;hddReadDataSv2
 340++A1A4              ;
 341++A1A4 E5           	push	hl
 342++A1A5 0E BE        	ld	c,#BE
 343++A1A7 11 F8 D8     	ld	de,#D8F8
 344++A1AA AF           	xor	a
 345++A1AB 43           loop012	ld	b,e		; #F8BE ॣ  ( )
 346++A1AC ED A2        	ini
 347++A1AE 42           	ld	b,d		; #D8BE ॣ  ( )
 348++A1AF ED A2        	ini
 349++A1B1 3D           	dec	a
 350++A1B2 C2 AB A1     	jp	nz,loop012
 351++A1B5 E1           	pop	hl
 352++A1B6 AF           	xor	a
 353++A1B7 C9           	ret
 354++A1B8
 355++A1B8              	endif
 356++A1B8
 357++A1B8              ;------------------------------------------------------------------------------
 358++A1B8              hddReadDataN	ifused
 359++A1B8              ;⥭ 512b    㥬 hl ( NEMO)
 360++A1B8              ;:  hl -    ⥭ 
 361++A1B8              ;: cy=0
 362++A1B8              ;     hl -  
 363++A1B8              ;     a=#00
 364++A1B8              ;     bc - ???
 365++A1B8              ;
 366++A1B8              ;hddReadDataN
 367++A1B8              ;
 368++A1B8 E5           	push	hl
 369++A1B9 01 10 FF     	ld	bc,#FF10	; #FF10 ॣ  ( )
 370++A1BC AF           	xor	a
 371++A1BD ED A2        loop011	ini
 372++A1BF 04           	inc	b
 373++A1C0 0C           	inc	c		; #FF11 ॣ  ( )
 374++A1C1 ED A2        	ini
 375++A1C3 04           	inc	b
 376++A1C4 0D           	dec	c
 377++A1C5 3D           	dec	a
 378++A1C6 C2 BD A1     	jp	nz,loop011
 379++A1C9 E1           	pop	hl
 380++A1CA AF           	xor	a
 381++A1CB C9           	ret
 382++A1CC
 383++A1CC              	endif
 384++A1CC
 385++A1CC              ;------------------------------------------------------------------------------
 386++A1CC              hddReadDataNA8	ifused
 387++A1CC              ;⥭ 512b    㥬 hl ( NEMO A8)
 388++A1CC              ;:  hl -    ⥭ 
 389++A1CC              ;: cy=0
 390++A1CC              ;     hl -  
 391++A1CC              ;     a=#00
 392++A1CC              ;     de,bc - ???
 393++A1CC              ;
 394++A1CC              ;hddReadDataNA8
 395++A1CC              ;
 396++A1CC 01 10 00     	ld	bc,#0010
 397++A1CF 18 03        	jr	goto010
 398++A1D1 18 FE        	jr	hddReadDataAtm
 399++A1D3              	org	$-2
 400++A1D1
 401++A1D1              	endif
 402++A1D1
 403++A1D1              ;------------------------------------------------------------------------------
 404++A1D1              hddReadDataAtm	ifused
 405++A1D1              ;⥭ 512b    㥬 hl ( ATM-IDE)
 406++A1D1              ;:  hl -    ⥭ 
 407++A1D1              ;: cy=0
 408++A1D1              ;     hl -  
 409++A1D1              ;     a=#00
 410++A1D1              ;     de,bc - ???
 411++A1D1              ;
 412++A1D1              ;hddReadDataAtm
 413++A1D1              ;
 414++A1D1 01 0F 00     	ld	bc,#000F
 415++A1D4 E5           goto010	push	hl
 416++A1D5 ED B2        	inir
 417++A1D7 ED B2        	inir
 418++A1D9 E1           	pop	hl
 419++A1DA AF           	xor	a
 420++A1DB C9           	ret
 421++A1DC
 422++A1DC              	endif
 423++A1DC
 424++A1DC              ;------------------------------------------------------------------------------
 425++A1DC              hddReadDataPrf	ifused
 426++A1DC              ;⥭ 512b    㥬 hl ( PROFI IDE)
 427++A1DC              ;:  hl -    ⥭ 
 428++A1DC              ;: cy=0
 429++A1DC              ;     hl -  
 430++A1DC              ;     a=#00
 431++A1DC              ;     de,bc - ???
 432++A1DC              ;
 433++A1DC              ;hddReadDataPrf
 434++A1DC              ;
 435++A1DC E5           	push	hl
 436++A1DD 11 CB EB     	ld	de,#EBCB
 437++A1E0 AF           	xor	a
 438++A1E1 47           	ld	b,a
 439++A1E2 4B           loop048	ld	c,e			; #00CB ॣ  ( )
 440++A1E3 ED A2        	ini
 441++A1E5 04           	inc	b
 442++A1E6 4A           	ld	c,d			; #00EB ॣ  ( )
 443++A1E7 ED A2        	ini
 444++A1E9 04           	inc	b
 445++A1EA 3D           	dec	a
 446++A1EB C2 E2 A1     	jp	nz,loop048
 447++A1EE E1           	pop	hl
 448++A1EF AF           	xor	a
 449++A1F0 C9           	ret
 450++A1F1
 451++A1F1              	endif
 452++A1F1
 453++A1F1              ;------------------------------------------------------------------------------
 454++A1F1              hddWriteDataSv1	ifused
 455++A1F1              ; 512b    㥬 hl ( SMUC v1 shadow)
 456++A1F1              ;:  hl -     
 457++A1F1              ;: cy=0
 458++A1F1              ;     hl -  
 459++A1F1              ;     a=#00
 460++A1F1              ;     de,bc - ???
 461++A1F1              ;
 462++A1F1              ;hddWriteDataSv1
 463++A1F1              ;
 464++A1F1 F3           	di
 465++A1F2 DD E5        	push	ix
 466++A1F4 E5           	push	hl
 467++A1F5 ED 73 3D A2  	ld	(cng_01+1),sp
 468++A1F9 0E BE        	ld	c,#BE
 469++A1FB DD 21 2F 3D  	ld	ix,#3D2F
 470++A1FF 16 40        	ld	d,#40
 471++A201 31 45 A2     loop006	ld	sp,var_01
 472++A204 5E           	ld	e,(hl)
 473++A205 23           	inc	hl
 474++A206 7E           	ld	a,(hl)
 475++A207 23           	inc	hl
 476++A208 06 D8        	ld	b,#D8
 477++A20A DD E9        	jp	(ix)
 478++A20C 06 F8        goto001	ld	b,#F8
 479++A20E 7B           	ld	a,e
 480++A20F DD E9        	jp	(ix)
 481++A211 5E           goto002	ld	e,(hl)
 482++A212 23           	inc	hl
 483++A213 7E           	ld	a,(hl)
 484++A214 23           	inc	hl
 485++A215 06 D8        	ld	b,#D8
 486++A217 DD E9        	jp	(ix)
 487++A219 06 F8        goto003	ld	b,#F8
 488++A21B 7B           	ld	a,e
 489++A21C DD E9        	jp	(ix)
 490++A21E 5E           goto004	ld	e,(hl)
 491++A21F 23           	inc	hl
 492++A220 7E           	ld	a,(hl)
 493++A221 23           	inc	hl
 494++A222 06 D8        	ld	b,#D8
 495++A224 DD E9        	jp	(ix)
 496++A226 06 F8        goto005	ld	b,#F8
 497++A228 7B           	ld	a,e
 498++A229 DD E9        	jp	(ix)
 499++A22B 5E           goto006	ld	e,(hl)
 500++A22C 23           	inc	hl
 501++A22D 7E           	ld	a,(hl)
 502++A22E 23           	inc	hl
 503++A22F 06 D8        	ld	b,#D8
 504++A231 DD E9        	jp	(ix)
 505++A233 06 F8        goto007	ld	b,#F8
 506++A235 7B           	ld	a,e
 507++A236 DD E9        	jp	(ix)
 508++A238 15           goto008	dec	d
 509++A239 C2 01 A2     	jp	nz,loop006
 510++A23C 31 00 00     cng_01	ld	sp,#0000
 511++A23F E1           	pop	hl
 512++A240 DD E1        	pop	ix
 513++A242 FB           	ei
 514++A243 AF           	xor	a
 515++A244 C9           	ret
 516++A245 F0 3F 0C A2  var_01	dw	dosOutPort,goto001
 517++A249 F0 3F 11 A2  	dw	dosOutPort,goto002
 518++A24D F0 3F 19 A2  	dw	dosOutPort,goto003
 519++A251 F0 3F 1E A2  	dw	dosOutPort,goto004
 520++A255 F0 3F 26 A2  	dw	dosOutPort,goto005
 521++A259 F0 3F 2B A2  	dw	dosOutPort,goto006
 522++A25D F0 3F 33 A2  	dw	dosOutPort,goto007
 523++A261 F0 3F 38 A2  	dw	dosOutPort,goto008
 524++A265
 525++A265              	endif
 526++A265
 527++A265              ;------------------------------------------------------------------------------
 528++A265              hddWriteDataSv2	ifused
 529++A265              ; 512b    㥬 hl ( SMUC v2)
 530++A265              ;:  hl -     
 531++A265              ;: cy=0
 532++A265              ;     hl -  
 533++A265              ;     a=#00
 534++A265              ;     de,bc - ???
 535++A265              ;
 536++A265              ;hddWriteDataSv2
 537++A265              ;
 538++A265 E5           	push	hl
 539++A266 0E BE        	ld	c,#BE
 540++A268 11 F9 D9     	ld	de,#D9F9	; outd 砫  dec b
 541++A26B AF           	xor	a
 542++A26C 42           loop010	ld	b,d		; #D8BE ॣ  ( )
 543++A26D 23           	inc	hl
 544++A26E ED AB        	outd
 545++A270 43           	ld	b,e		; #F8BE ॣ  ( )
 546++A271 ED A3        	outi
 547++A273 23           	inc	hl
 548++A274 3D           	dec	a
 549++A275 C2 6C A2     	jp	nz,loop010
 550++A278 E1           	pop	hl
 551++A279 AF           	xor	a
 552++A27A C9           	ret
 553++A27B
 554++A27B              	endif
 555++A27B
 556++A27B              ;------------------------------------------------------------------------------
 557++A27B              hddWriteDataN	ifused
 558++A27B              ; 512b    㥬 hl ( NEMO)
 559++A27B              ;:  hl -     
 560++A27B              ;: cy=0
 561++A27B              ;     hl -  
 562++A27B              ;     a=#00
 563++A27B              ;     de,bc - ???
 564++A27B              ;
 565++A27B              ;hddWriteDataN
 566++A27B              ;
 567++A27B E5           	push	hl
 568++A27C 01 11 00     	ld	bc,#0011		; outd 砫  dec b
 569++A27F AF           	xor	a
 570++A280 23           loop009	inc	hl
 571++A281 ED AB        	outd				;訩 
 572++A283 0D           	dec	c
 573++A284 04           	inc	b
 574++A285 ED A3        	outi				;訩 
 575++A287 0C           	inc	c
 576++A288 04           	inc	b
 577++A289 23           	inc	hl
 578++A28A 3D           	dec	a
 579++A28B C2 80 A2     	jp	nz,loop009
 580++A28E E1           	pop	hl
 581++A28F AF           	xor	a
 582++A290 C9           	ret
 583++A291
 584++A291              	endif
 585++A291
 586++A291              ;------------------------------------------------------------------------------
 587++A291              hddWriteDataNA8	ifused
 588++A291              ; 512b    㥬 hl ( NEMO A8)
 589++A291              ;:  hl -     
 590++A291              ;: cy=0
 591++A291              ;     hl -  
 592++A291              ;     a=#00
 593++A291              ;     de,bc - ???
 594++A291              ;
 595++A291              ;hddWriteDataNA8
 596++A291              ;
 597++A291 0E 10        	ld	c,#10
 598++A293 18 02        	jr	goto009
 599++A295 18 FE        	jr	hddWriteDataAtm
 600++A297              	org	$-2
 601++A295
 602++A295              	endif
 603++A295
 604++A295              ;------------------------------------------------------------------------------
 605++A295              hddWriteDataAtm	ifused
 606++A295              ; 512b    㥬 hl ( ATM-IDE)
 607++A295              ;:  hl -     
 608++A295              ;: cy=0
 609++A295              ;     hl -  
 610++A295              ;     a=#00
 611++A295              ;     de,bc - ???
 612++A295              ;
 613++A295              ;hddWriteDataAtm
 614++A295              ;
 615++A295 0E 0F        	ld	c,#0F
 616++A297 E5           goto009	push	hl
 617++A298 AF           	xor	a
 618++A299 5F           	ld	e,a			; outd 砫  dec b
 619++A29A 43           loop007	ld	b,e
 620++A29B 23           	inc	hl
 621++A29C ED AB        	outd				;訩 
 622++A29E ED A3        	outi				;訩 
 623++A2A0 23           	inc	hl
 624++A2A1 3D           	dec	a
 625++A2A2 C2 9A A2     	jp	nz,loop007
 626++A2A5 E1           	pop	hl
 627++A2A6 AF           	xor	a
 628++A2A7 C9           	ret
 629++A2A8
 630++A2A8              	endif
 631++A2A8
 632++A2A8              ;------------------------------------------------------------------------------
 633++A2A8              hddWriteDataPrf	ifused
 634++A2A8              ; 512b    㥬 hl ( PROFI-IDE)
 635++A2A8              ;:  hl -     
 636++A2A8              ;: cy=0
 637++A2A8              ;     hl -  
 638++A2A8              ;     a=#00
 639++A2A8              ;     de,bc - ???
 640++A2A8              ;
 641++A2A8              ;hddWriteDataPrf
 642++A2A8              ;
 643++A2A8 E5           	push	hl
 644++A2A9 11 CB EB     	ld	de,#EBCB
 645++A2AC AF           	xor	a
 646++A2AD 47           	ld	b,a
 647++A2AE 04           loop047	inc	b			; outd 砫  dec b
 648++A2AF 4B           	ld	c,e			; #00CB ॣ  ( )
 649++A2B0 23           	inc	hl
 650++A2B1 ED AB        	outd
 651++A2B3 04           	inc	b
 652++A2B4 4A           	ld	c,d			; #00EB ॣ  ( )
 653++A2B5 ED A3        	outi
 654++A2B7 23           	inc	hl
 655++A2B8 3D           	dec	a
 656++A2B9 C2 AE A2     	jp	nz,loop047
 657++A2BC E1           	pop	hl
 658++A2BD AF           	xor	a
 659++A2BE C9           	ret
 660++A2BF
 661++A2BF              	endif
 662++A2BF
 663++A2BF              ;------------------------------------------------------------------------------
 664++A2BF              hddSendCmd	ifused
 665++A2BF              ;뫠  
 666++A2BF              ;:  a -  
 667++A2BF              ;: cy=1 HDD  襫  ⮢
 668++A2BF              ;       a=#60 busy not found
 669++A2BF              ;       a=#61 hard disk not ready
 670++A2BF              ;     cy=0  㦥  ॣ
 671++A2BF              ;        a,d -  
 672++A2BF              ;     bc -  #1F7
 673++A2BF              ;     hl,e - ???
 674++A2BF              ;
 675++A2BF              ;hddSendCmd
 676++A2BF              ;
 677++A2BF              ; ⮢ hdd
 678++A2BF 57           	ld	d,a
 679++A2C0 CD 19 A3     	call	hddWaitNoBusy		; ⮢ HDD
 680++A2C3 D8           	ret	c			;訡: hdd  襫  ⮢
 681++A2C4
 682++A2C4              ;㧪  ॣ - ᥪ஢,  LBA/CHS, ⨯ ன⢠
 683++A2C4 D5           	push	de
 684++A2C5 11 50 A4     	ld	de,idePort1F1
 685++A2C8 21 86 99     	ld	hl,kPort1F1
 686++A2CB 3E 06        	ld	a,#06
 687++A2CD F5           loop005	push	af
 688++A2CE 4E           	ld	c,(hl)
 689++A2CF 23           	inc	hl
 690++A2D0 46           	ld	b,(hl)
 691++A2D1 23           	inc	hl
 692++A2D2 1A           	ld	a,(de)
 693++A2D3 13           	inc	de
 694++A2D4 CD 6C 99     	call	kOut_C_A
 695++A2D7 F1           	pop	af
 696++A2D8 3D           	dec	a
 697++A2D9 20 F2        	jr	nz,loop005
 698++A2DB D1           	pop	de
 699++A2DC
 700++A2DC              ; ⮢  ਥ 
 701++A2DC CD FD A2     	call	hddWaitReadyCmd		; ⮢ HDD  ਭ 
 702++A2DF D8           	ret	c			;訡: hdd  襫  ⮢
 703++A2E0 7A           	ld	a,d
 704++A2E1 C3 6C 99     	jp	kOut_C_A
 705++A2E4
 706++A2E4              	endif
 707++A2E4
 708++A2E4              ;------------------------------------------------------------------------------
 709++A2E4              hddWaitReadyData	ifused
 710++A2E4              ; ⮢ HDD  । 
 711++A2E4              ;:  ---
 712++A2E4              ;: cy=1 HDD  襫  ⮢
 713++A2E4              ;       a=#60 busy not found
 714++A2E4              ;       a=#62 hard disk data not ready
 715++A2E4              ;     cy=0 HDD ⮢  ਭ 
 716++A2E4              ;        a - ॣ ﭨ
 717++A2E4              ;     bc -  #1F7
 718++A2E4              ;     hl,e - ???
 719++A2E4              ;
 720++A2E4              ;hddWaitReadyData
 721++A2E4              ;
 722++A2E4 CD 19 A3     	call	hddWaitNoBusy		; ⮢ HDD
 723++A2E7 D8           	ret	c			;訡: hdd  襫  ⮢
 724++A2E8 CB 5F        	bit	3,a
 725++A2EA C0           	ret	nz			; ⮢  । 
 726++A2EB              ;bc -  #1F7
 727++A2EB
 728++A2EB              ; ⮢  । 
 729++A2EB 21 80 00     	ld	hl,dataTimeOut
 730++A2EE CD 6F 99     loop004	call	kIn_A_C			;⠥ ॣ ﭨ
 731++A2F1 CB 5F        	bit	3,a
 732++A2F3 C0           	ret	nz			; ⮢  । 
 733++A2F4 2B           	dec	hl
 734++A2F5 7C           	ld	a,h
 735++A2F6 B5           	or	l
 736++A2F7 20 F5        	jr	nz,loop004
 737++A2F9 3E 62        	ld	a,#62
 738++A2FB 37           	scf
 739++A2FC C9           	ret
 740++A2FD
 741++A2FD              	endif
 742++A2FD
 743++A2FD              ;------------------------------------------------------------------------------
 744++A2FD              hddWaitReadyCmd	ifused
 745++A2FD              ; ⮢ HDD  ਭ 
 746++A2FD              ;:  ---
 747++A2FD              ;: cy=1 HDD  襫  ⮢
 748++A2FD              ;       a=#60 busy not found
 749++A2FD              ;       a=#61 hard disk not ready
 750++A2FD              ;     cy=0 HDD ⮢  ਭ 
 751++A2FD              ;        a - ॣ ﭨ
 752++A2FD              ;     bc -  #1F7
 753++A2FD              ;     hl,e - ???
 754++A2FD              ;
 755++A2FD              ;hddWaitReadyCmd
 756++A2FD              ;
 757++A2FD CD 19 A3     	call	hddWaitNoBusy		; ⮢ HDD
 758++A300 D8           	ret	c			;訡: hdd  襫  ⮢
 759++A301 CB 77        	bit	6,a
 760++A303 C0           	ret	nz			;室.  ⮢ ਭ 
 761++A304              ;bc -  #1F7
 762++A304
 763++A304              ; ⮢ ਭ 
 764++A304 21 10 00     	ld	hl,cmdTimeOut
 765++A307 CD 6F 99     loop003	call	kIn_A_C			;⠥ ॣ ﭨ
 766++A30A CB 77        	bit	6,a
 767++A30C C0           	ret	nz			;室.  ⮢ ਭ 
 768++A30D 1D           	dec	e
 769++A30E 20 F7        	jr	nz,loop003
 770++A310 2B           	dec	hl
 771++A311 7C           	ld	a,h
 772++A312 B5           	or	l
 773++A313 20 F2        	jr	nz,loop003
 774++A315 3E 61        	ld	a,#61
 775++A317 37           	scf
 776++A318 C9           	ret
 777++A319
 778++A319              	endif
 779++A319
 780++A319              ;------------------------------------------------------------------------------
 781++A319              hddWaitNoBusy	ifused
 782++A319              ; ⮢ HDD
 783++A319              ;:  ---
 784++A319              ;: cy=1 HDD  襫  ⮢
 785++A319              ;       a=#60 busy not found
 786++A319              ;     cy=0 HDD ⮢
 787++A319              ;        a - ॣ ﭨ
 788++A319              ;     bc -  #1F7
 789++A319              ;     hl,e - ???
 790++A319              ;
 791++A319              ;hddWaitNoBusy
 792++A319              ;
 793++A319              ;⠭  
 794++A319 ED 4B 90 99  	ld	bc,(kPort1F6)
 795++A31D 3A 55 A4     	ld	a,(idePort1F6)
 796++A320 CD 6C 99     	call	kOut_C_A		;  
 797++A323              ;	IFDEF	PROFIide
 798++A323              ;	 ld	a,(DrvHDD.ideType)
 799++A323              ;	 and	#20
 800++A323              ;	 call	nz,Pause70k
 801++A323              ;	ENDIF
 802++A323
 803++A323              ; ⮢
 804++A323 ED 4B 92 99  	ld	bc,(kPort1F7)
 805++A327 21 20 00     	ld	hl,busyTimeOut		;⢮ ⮪
 806++A32A AF           loop002	xor	a
 807++A32B 5F           	ld	e,a
 808++A32C CD 6F 99     loop001	call	kIn_A_C			;⠥ ॣ ﭨ
 809++A32F CB 7F        	bit	7,a
 810++A331 C8           	ret	z			;HDD ⮢
 811++A332 1D           	dec	e			;HDD 
 812++A333 20 F7        	jr	nz,loop001		;塞 ⪨
 813++A335 2B           	dec	hl
 814++A336 7C           	ld	a,h
 815++A337 B5           	or	l
 816++A338 20 F0        	jr	nz,loop002
 817++A33A 3E 60        	ld	a,#60			;HDD  襫  ⮢
 818++A33C 37           	scf
 819++A33D C9           	ret
 820++A33E
 821++A33E              	endif
 822++A33E
 823++A33E              ;------------------------------------------------------------------------------
 824++A33E              smucTest3FF0	ifused
 825++A33E              ;஢ઠ    ࠡ Smuc v1
 826++A33E              ;: cy=1 窨 室 
 827++A33E              ;
 828++A33E              ;smucTest3FF0
 829++A33E              ;
 830++A33E              ;㥬  tr-dos
 831++A33E FD E5        	push	iy
 832++A340 21 F0 3F     	ld	hl,dosOutPort
 833++A343 0E 13        	ld	c,#13
 834++A345 F3           	di
 835++A346 FD 21 3A 5C  	ld	iy,#5C3A
 836++A34A ED 46        	im	0
 837++A34C CD 13 3D     	call	#3D13
 838++A34F ED 56        	im	1 ;2
 839++A351 FB           	ei
 840++A352 FD E1        	pop	iy
 841++A354
 842++A354              ;஢塞
 843++A354 06 06        	ld	b,#06
 844++A356 21 DD 5C     	ld	hl,#5CDD
 845++A359 11 66 A3     	ld	de,var_03
 846++A35C 1A           loop025	ld	a,(de)
 847++A35D BE           	cp	(hl)
 848++A35E 37           	scf
 849++A35F C0           	ret	nz
 850++A360 23           	inc	hl
 851++A361 13           	inc	de
 852++A362 10 F8        	djnz	loop025
 853++A364 B7           	or	a
 854++A365 C9           	ret
 855++A366 ED 79        var_03	db	#ED,#79			;out (c),a
 856++A368 C9           	db	#C9			;ret
 857++A369 ED 78        	db	#ED,#78			;in a,(c)
 858++A36B C9           	db	#C9			;ret
 859++A36C
 860++A36C              	endif
 861++A36C
 862++A36C              ;------------------------------------------------------------------------------
 863++A36C              profiPortsOff	ifused
 864++A36C              ;몫祭 ⮢ PROFI
 865++A36C              ;:  ---
 866++A36C              ;
 867++A36C              ;profiPortsOff
 868++A36C              ;
 869++A36C 3E 00        	ld	a,baseDFFDoff
 870++A36E 18 02        	jr	goto068
 871++A370 18 FE        	jr	profiPortsOn
 872++A372              	org	$-2
 873++A370
 874++A370              	endif
 875++A370
 876++A370              ;------------------------------------------------------------------------------
 877++A370              profiPortsOn	ifused
 878++A370              ;祭 ⮢ PROFI
 879++A370              ;:  ---
 880++A370              ;
 881++A370              ;profiPortsOn
 882++A370              ;
 883++A370 3E 20        	ld	a,baseDFFDon
 884++A372 01 FD DF     goto068	ld	bc,#DFFD
 885++A375 ED 79        	out	(c),a
 886++A377 B7           	or	a
 887++A378 C9           	ret
 888++A379
 889++A379              	endif
 890++A379
 891++A379              ;------------------------------------------------------------------------------
 892++A379              atmPortsOff	ifused
 893++A379              ;몫祭 ⮢ ATM
 894++A379              ;:  ---
 895++A379              ;
 896++A379              ;atmPortsOff
 897++A379              ;
 898++A379 01 77 FF     	ld	bc,#FF77
 899++A37C              ;	ld	a,%10101000 or atmXX77
 900++A37C 18 03        	jr	goto027
 901++A37E
 902++A37E              	endif
 903++A37E
 904++A37E              ;------------------------------------------------------------------------------
 905++A37E              atmPortsOn	ifused
 906++A37E              ;祭 ⮢ ATM
 907++A37E              ;:  ---
 908++A37E              ;
 909++A37E              ;atmPortsOn
 910++A37E              ;
 911++A37E 01 77 FD     	ld	bc,#FD77
 912++A381 3E AB        goto027	ld	a,%10101000 or atmXX77
 913++A383 B7           	or	a
 914++A384 18 FE        	jr	out_C_A_2A53
 915++A386              	org	$-2
 916++A384
 917++A384              	endif
 918++A384
 919++A384              ;------------------------------------------------------------------------------
 920++A384              out_C_A_2A53	ifused
 921++A384              ;  ⥭ 
 922++A384              ;:  bc - 
 923++A384              ;     a - ᫤ন 
 924++A384              ;
 925++A384              ;out_C_A_2A53
 926++A384              ;
 927++A384              	IFDEF	openDOS		;⥭  
 928++A384 ~            	 out	(c),a
 929++A384 ~            	 ret
 930++A384              	ELSE
 931++A384 E5           	 push	hl
 932++A385 21 53 2A     	 ld	hl,#2A53
 933++A388 E3           	 ex	(sp),hl
 934++A389 C3 2F 3D     	 jp	#3D2F
 935++A38C              	ENDIF
 936++A38C
 937++A38C              	endif
 938++A38C
 939++A38C              ;------------------------------------------------------------------------------
 940++A38C              out_C_A		ifused
 941++A38C              ;  ⥭ 
 942++A38C              ;:  bc - 
 943++A38C              ;     a - ᫤ন 
 944++A38C              ;
 945++A38C              ;out_C_A
 946++A38C              ;
 947++A38C E5           	push	hl
 948++A38D 21 F0 3F     	ld	hl,dosOutPort
 949++A390 E3           	ex	(sp),hl
 950++A391 C3 2F 3D     	jp	#3D2F
 951++A394
 952++A394              	endif
 953++A394
 954++A394              ;------------------------------------------------------------------------------
 955++A394              in_A_C_profi	ifused
 956++A394              ;⥭  PROFI
 957++A394              ;:  bc - 
 958++A394              ;: a - ᫤ন 
 959++A394              ;
 960++A394              ;in_A_C_profi
 961++A394              ;
 962++A394 CB A9        	res	5,c
 963++A396 ED 78        	in	a,(c)
 964++A398 CB E9        	set	5,c
 965++A39A C9           	ret
 966++A39B
 967++A39B              	endif
 968++A39B
 969++A39B              ;------------------------------------------------------------------------------
 970++A39B              in_A_C		ifused
 971++A39B              ;⥭ ⥭ 
 972++A39B              ;:  bc - 
 973++A39B              ;: a - ᫤ন 
 974++A39B              ;
 975++A39B              ;in_A_C
 976++A39B              ;
 977++A39B E5           	push	hl
 978++A39C 21 F3 3F     	ld	hl,dosInPort
 979++A39F E3           	ex	(sp),hl
 980++A3A0 C3 2F 3D     	jp	#3D2F
 981++A3A3
 982++A3A3              	endif
 983++A3A3
 984++A3A3              ;==============================================================================
 985++A3A3              ;
 986++A3A3              ;==============================================================================
 987++A3A3
# file closed: Drivers/DrvHDD/DrvHDD.ide.a80
 229+ A3A3              	INCLUDE		"DrvHDD.calc.a80"
# file opened: Drivers/DrvHDD/DrvHDD.calc.a80
   1++A3A3              ;楤  HDD Driver. 楤  ⥬᪨ ⮢
   2++A3A3              ;䠩 DrvHDD.calc.a80
   3++A3A3              ;
   4++A3A3              ;Pause70k		প 70k ⠪⮢
   5++A3A3              ;SetZeroDEHL		㫥 dehl
   6++A3A3              ;hddLBAtoCHS		८ࠧ  LBA  CHS
   7++A3A3              ;calcHLequEmulA		㬭: hl=e*a
   8++A3A3              ;altDEHLdivBC		 de'hl'=de'hl'/bc
   9++A3A3              ;
  10++A3A3              ;------------------------------------------------------------------------------
  11++A3A3              Pause70k	ifused
  12++A3A3              ;প 70k ⠪⮢
  13++A3A3              ;: bc=#0000
  14++A3A3              ;     a=#00
  15++A3A3              ;
  16++A3A3              ;Pause70k
  17++A3A3              ;
  18++A3A3 C5           	push	bc
  19++A3A4 01 28 0A     	ld	bc,2600
  20++A3A7 0B           loop050	dec	bc
  21++A3A8 78           	ld	a,b
  22++A3A9 B1           	or	c
  23++A3AA 20 FB        	jr	nz,loop050
  24++A3AC C1           	pop	bc
  25++A3AD C9           	ret
  26++A3AE
  27++A3AE              	endif
  28++A3AE
  29++A3AE              ;------------------------------------------------------------------------------
  30++A3AE              SetZeroDEHL	ifused
  31++A3AE ~            ;㫥 dehl
  32++A3AE ~            ;: dehl=#00000000
  33++A3AE ~            ;
  34++A3AE ~            ;SetZeroDEHL
  35++A3AE ~            ;
  36++A3AE ~            	ld	hl,#0000
  37++A3AE ~            	ld	e,l
  38++A3AE ~            	ld	d,l
  39++A3AE ~            	ret
  40++A3AE ~
  41++A3AE              	endif
  42++A3AE
  43++A3AE              ;------------------------------------------------------------------------------
  44++A3AE              hddLBAtoCHS	ifused
  45++A3AE              ;८ࠧ  LBA  CHS
  46++A3AE              ;:  dehl - LBA  ᥪ
  47++A3AE              ;: de -  樫 CHS
  48++A3AE              ;     c -  ᥪ CHS
  49++A3AE              ;     a -   CHS
  50++A3AE              ;
  51++A3AE              ;hddLBAtoCHS
  52++A3AE              ;
  53++A3AE D9           	exx
  54++A3AF ED 4B 62 A4  	ld	bc,(devHmulS)		;head*sector (ᥪ஢  樫)
  55++A3B3 CD F5 A3     	call	altDEHLdivBC		; de'hl'=de'hl'/bc
  56++A3B6 D9           	exx
  57++A3B7 7A           	ld	a,d
  58++A3B8 B3           	or	e
  59++A3B9 20 21        	jr	nz,goto038		; । CHS
  60++A3BB 47           	ld	b,a			;b=#00
  61++A3BC EB           	ex	de,hl
  62++A3BD 2A 5E A4     	ld	hl,(devCylinders)
  63++A3C0 ED 52        	sbc	hl,de
  64++A3C2 38 18        	jr	c,goto038		; । CHS
  65++A3C4 D5           	push	de			; 樫 CHS
  66++A3C5 3A 61 A4     	ld	a,(devSectors)
  67++A3C8 4F           	ld	c,a			;bc - 祭 sector HDD
  68++A3C9 F5           	push	af
  69++A3CA CD F5 A3     	call	altDEHLdivBC		; de'hl'=de'hl'/bc
  70++A3CD F1           	pop	af
  71++A3CE D1           	pop	de
  72++A3CF 2C           	inc	l
  73++A3D0 BD           	cp	l
  74++A3D1 38 09        	jr	c,goto038		; । CHS
  75++A3D3 7D           	ld	a,l			; ᥪ CHS
  76++A3D4 D9           	exx
  77++A3D5 4F           	ld	c,a
  78++A3D6 3A 60 A4     	ld	a,(devHeads)
  79++A3D9 BD           	cp	l
  80++A3DA 7D           	ld	a,l			;  CHS
  81++A3DB D0           	ret	nc			;ࠬ  । CHS
  82++A3DC
  83++A3DC              ; । CHS, ⠢ ᨬ 祭
  84++A3DC ED 5B 5E A4  goto038	ld	de,(devCylinders)
  85++A3E0 2A 60 A4     	ld	hl,(devHeads)
  86++A3E3 7D           	ld	a,l
  87++A3E4 4C           	ld	c,h
  88++A3E5 1B           	dec	de
  89++A3E6 2D           	dec	l
  90++A3E7 C9           	ret
  91++A3E8
  92++A3E8              	endif
  93++A3E8
  94++A3E8              ;------------------------------------------------------------------------------
  95++A3E8              calcHLequEmulA	ifused
  96++A3E8              ;㬭: hl=e*a
  97++A3E8              ;:  a,e - ᫠
  98++A3E8              ;: hl=e*a
  99++A3E8              ;     d,b =#00
 100++A3E8              ;
 101++A3E8              ;calcHLequEmulA
 102++A3E8              ;
 103++A3E8 67                   ld      h,a
 104++A3E9 2E 00                ld      l,#00
 105++A3EB 55                   ld      d,l
 106++A3EC 06 08                ld      b,#08
 107++A3EE 29           loop026 add     hl,hl
 108++A3EF 30 01                jr      nc,goto028
 109++A3F1 19                   add     hl,de
 110++A3F2 10 FA        goto028 djnz    loop026
 111++A3F4 C9                   ret
 112++A3F5
 113++A3F5                      endif
 114++A3F5
 115++A3F5              ;------------------------------------------------------------------------------
 116++A3F5              altDEHLdivBC	ifused
 117++A3F5              ; de'hl'=de'hl'/bc
 118++A3F5              ;:  de'hl' - 
 119++A3F5              ;     bc - ⥫
 120++A3F5              ;: de'hl' - 祭
 121++A3F5              ;     hl ⮪  
 122++A3F5              ;
 123++A3F5              ;altDEHLdivBC
 124++A3F5              ;
 125++A3F5 21 00 00     	ld	hl,#0000
 126++A3F8 E5           	push	hl
 127++A3F9 5D           	ld	e,l
 128++A3FA 54           	ld	d,h
 129++A3FB D9           	exx
 130++A3FC 06 20        	ld	b,#20
 131++A3FE AF           loop028	xor	a
 132++A3FF CB 15        	rl	l
 133++A401 CB 14        	rl	h
 134++A403 CB 13        	rl	e
 135++A405 CB 12        	rl	d
 136++A407 D9           	exx
 137++A408 CB 15        	rl	l
 138++A40A CB 14        	rl	h
 139++A40C CB 13        	rl	e
 140++A40E CB 12        	rl	d
 141++A410 17           	rla
 142++A411 B7           	or	a
 143++A412 ED 42        	sbc	hl,bc
 144++A414 E3           	ex	(sp),hl
 145++A415 EB           	ex	de,hl
 146++A416 ED 52        	sbc	hl,de
 147++A418 EB           	ex	de,hl
 148++A419 E3           	ex	(sp),hl
 149++A41A D9           	exx
 150++A41B DE 00        	sbc	a,#00
 151++A41D 20 26        	jr	nz,goto033
 152++A41F 2C           loop029	inc	l
 153++A420 10 DC        	djnz	loop028
 154++A422 33           	inc	sp
 155++A423 33           	inc	sp
 156++A424 D9           	exx
 157++A425 C9           	ret
 158++A426 AF           loop027	xor	a
 159++A427 CB 15        	rl	l
 160++A429 CB 14        	rl	h
 161++A42B CB 13        	rl	e
 162++A42D CB 12        	rl	d
 163++A42F D9           	exx
 164++A430 CB 15        	rl	l
 165++A432 CB 14        	rl	h
 166++A434 CB 13        	rl	e
 167++A436 CB 12        	rl	d
 168++A438 17           	rla
 169++A439 09           	add	hl,bc
 170++A43A E3           	ex	(sp),hl
 171++A43B EB           	ex	de,hl
 172++A43C ED 5A        	adc	hl,de
 173++A43E EB           	ex	de,hl
 174++A43F E3           	ex	(sp),hl
 175++A440 D9           	exx
 176++A441 DE 00        	sbc	a,#00
 177++A443 28 DA        	jr	z,loop029
 178++A445 10 DF        goto033	djnz	loop027
 179++A447 D9           	exx
 180++A448 09           	add	hl,bc
 181++A449 30 01        	jr	nc,goto034
 182++A44B 13           	inc	de
 183++A44C 33           goto034	inc	sp
 184++A44D 33           	inc	sp
 185++A44E C9           	ret
 186++A44F
 187++A44F              	endif
 188++A44F
 189++A44F              ;==============================================================================
 190++A44F              ;
 191++A44F              ;==============================================================================
 192++A44F
# file closed: Drivers/DrvHDD/DrvHDD.calc.a80
 230+ A44F              	IFDEF		ver1_10
 231+ A44F              	 INCLUDE	"DrvHDD.var1_10.a80"
# file opened: Drivers/DrvHDD/DrvHDD.var1_10.a80
   1++A44F              ;६ HDD Driver
   2++A44F              ;䠩 DrvHDD.var.a80
   3++A44F              ;
   4++A44F              ;⠭ ᪨ ஫஢ ( ४⭮ ⠭ ୠ)
   5++A44F              ;㯭 ஫
   6++A44F              ;0,=1 SMUC v2
   7++A44F              ;1,=1 SMUC v1 (shadow)
   8++A44F              ;2,=1 Nemo
   9++A44F              ;3,=1 Nemo A8
  10++A44F              ;4,=1 ATM-IDE
  11++A44F              ;5,=1 PROFI IDE
  12++A44F              ;6,=1 Z-Controller
  13++A44F              ;7,=1 DivMMC
  14++A44F              ;
  15++A44F              devMask	=	#00
  16++A44F              devNums	=	#00
  17++A44F              	IFDEF	SMUCv2		;প SMUC v2
  18++A44F              devMask	=	devMask+#01
  19++A44F              devNums	=	devNums+#01
  20++A44F              	ENDIF
  21++A44F              	IFDEF	SMUCv1		;প SMUC v1 (१ ⥭ )
  22++A44F              devMask	=	devMask+#02
  23++A44F              devNums	=	devNums+#01
  24++A44F              	ENDIF
  25++A44F              	IFDEF	NemoStd		;প NEMO
  26++A44F              devMask	=	devMask+#04
  27++A44F              devNums	=	devNums+#01
  28++A44F              	ENDIF
  29++A44F              	IFDEF	NemoA8		;প NEMO A8
  30++A44F              devMask	=	devMask+#08
  31++A44F              devNums	=	devNums+#01
  32++A44F              	ENDIF
  33++A44F              	IFDEF	ATMide		;প ATM-IDE
  34++A44F              devMask	=	devMask+#10
  35++A44F              devNums	=	devNums+#01
  36++A44F              	ENDIF
  37++A44F              	IFDEF	PROFIide	;প PROFI-IDE
  38++A44F              devMask	=	devMask+#20
  39++A44F              devNums	=	devNums+#01
  40++A44F              	ENDIF
  41++A44F              	IFDEF	ZC		;প Z-Controller
  42++A44F              devMask	=	devMask+#40
  43++A44F              devNums	=	devNums+#01
  44++A44F              	ENDIF
  45++A44F              	IFDEF	DivMMC		;প DivMMC
  46++A44F              devMask	=	devMask+#80
  47++A44F              devNums	=	devNums+#01
  48++A44F              	ENDIF
  49++A44F
  50++A44F              ;------------------------------------------------------------------------------
  51++A44F              ; ⥪饣 ஫   ( ଠ PartitionNum)
  52++A44F              ; ࠩ ᯮ ⮫쪮  5-3,2
  53++A44F              ;7,=0/1 ⨯ ࠧ MFS/FAT
  54++A44F              ;6,=1 ࠧ             543
  55++A44F              ;5-3,=???  ன⢠: =000 SMUC v2
  56++A44F              ;                           =001 SMUC v1
  57++A44F              ;                           =010 Nemo
  58++A44F              ;                           =011 Nemo A8
  59++A44F              ;                           =100 ATM IDE
  60++A44F              ;                           =101 PROFI-IDE
  61++A44F              ;                           =110 SD ZC
  62++A44F              ;                           =111 SD DivMMC
  63++A44F              ;2,=0/1 hdd master/slave
  64++A44F              ;0..1,=??  ࠧ
  65++A44F              ;
  66++A44F FF           drvDevice	db	#FF
  67++A450
  68++A450              ;------------------------------------------------------------------------------
  69++A450              ; ६     
  70++A450 00           idePort1F1	db	0	;ॣ ⥫ ⥩ #1F1/#F9BE ( ॠ)
  71++A451              secCounter
  72++A451 00           idePort1F2	db	0	;ॣ 稪 ᥪ஢ #1F2/#FABE
  73++A452 00           idePort1F3	db	0	;CHS  ᥪ/LBA 7:0 #1F3/#FBBE
  74++A453 00           idePort1F4	db	0	;CHS  樫 low/LBA 15:8 #1F4/#FCBE
  75++A454 00           idePort1F5	db	0	;CHS  樫 high/LBA 23:16 #1F5/#FDBE
  76++A455 00           idePort1F6	db	0	;CHS  /LBA 27:24 #1F6/#FEBE
  77++A456              				; 4,=0/1 ⥪騩  master/slave
  78++A456              				; 5,=1 ᥣ
  79++A456              				; 6,=0/1  CHS/LBA 
  80++A456              				; 7,=1 ᥣ
  81++A456 20           idePort1F7r	db	#20	;ॣ  (⥭ ᥪ)
  82++A457 30           idePort1F7w	db	#30	;ॣ  ( ᥪ)
  83++A458 90           idePort1F7i	db	#90	;ॣ  (䨪)
  84++A459 01           idePortErrCnt	db	#01	;⢮ ⮪ ⥭/ ᥪ
  85++A45A              AdrLBA32	ifused
  86++A45A 00 00 00 00  		 dd	0	;LBA32  ᥪ
  87++A45E              		endif
  88++A45E
  89++A45E              ;------------------------------------------------------------------------------
  90++A45E              ; ६ ਨ ⥪饣 ன⢠
  91++A45E              ;+#0A ࠬ ன⢠
  92++A45E              ;7,=1 /SD 
  93++A45E              ;6,=1  প LBA
  94++A45E              ;5,=1  প CHS
  95++A45E              ;4,=0/1  SD/HDD master/slave
  96++A45E              ;3,=0/1 প LBA32 off/on
  97++A45E              ;2,=0/1  SD ⮢/筠 
  98++A45E              ;1-0,=00  ⠡ ࠧ
  99++A45E              ;    =10  ࠧ  砫 ᪠
 100++A45E              ;    =01  MBR
 101++A45E              ;    =11  GPT
 102++A45E              ;
 103++A45E              CurrentDev
 104++A45E 00 00        devCylinders	dw 0		;+#00 2 祭 Cylinders HDD
 105++A460 00           devHeads	db 0		;+#02 1 祭 head HDD
 106++A461 00           devSectors	db 0		;+#03 1 祭 sector HDD
 107++A462 00 00        devHmulS	dw 0		;+#04 2 ந head * sectors
 108++A464 00 00 00 00  devLBAsec	dd 0		;+#06 4 - ᥪ஢ LBA
 109++A468 00           devFlags	db %00000000	;+#0A 1 ࠬ ன⢠
 110++A469              EndCurrentDev
 111++A469
 112++A469              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 113++A469              ; ६ ਨ   ஢
 114++A469              	IFNDEF	DrvHddExtVars
 115++A469 ~            	 IFDEF	SMUC
 116++A469 ~            msSMUC	  ds	11		;SMUC master
 117++A469 ~            slSMUC	  ds	11		;SMUC slave
 118++A469 ~            	 ENDIF
 119++A469 ~            	 IFDEF	NEMO
 120++A469 ~            msNemo	  ds	11		;Nemo master
 121++A469 ~            slNemo	  ds	11		;Nemo slave
 122++A469 ~            	 ENDIF
 123++A469 ~            	 IFDEF	ATMide
 124++A469 ~            msATM	  ds	11		;ATM IDE master
 125++A469 ~            slATM	  ds	11		;ATM IDE slave
 126++A469 ~            	 ENDIF
 127++A469 ~            	 IFDEF	PROFIide
 128++A469 ~            msPROFI	  ds	11		;Profi IDE master
 129++A469 ~            slPROFI	  ds	11		;Profi IDE slave
 130++A469 ~            	 ENDIF
 131++A469 ~            	 IFDEF	ZC
 132++A469 ~            cardZC	  ds	11		;ZC SD 
 133++A469 ~            	 ENDIF
 134++A469 ~            	 IFDEF	DivMMC
 135++A469 ~            mDivMMC	  ds	11		;DivMMC master
 136++A469 ~            sDivMMC	  ds	11		;DivMMC slave
 137++A469 ~            	 ENDIF
 138++A469              	ENDIF
 139++A469
 140++A469              ;------------------------------------------------------------------------------
 141++A469              ;⠡ ᮢ  ६ ஢/SD 
 142++A469 50 97        tblDev	dw	msSMUC
 143++A46B 5B 97        	dw	slSMUC
 144++A46D 50 97        	dw	msSMUC
 145++A46F 5B 97        	dw	slSMUC
 146++A471 66 97        	dw	msNemo
 147++A473 71 97        	dw	slNemo
 148++A475 66 97        	dw	msNemo
 149++A477 71 97        	dw	slNemo
 150++A479 7C 97        	dw	msATM
 151++A47B 87 97        	dw	slATM
 152++A47D 92 97        	dw	msPROFI
 153++A47F 92 97        	dw	slPROFI
 154++A481 A8 97        	dw	cardZC
 155++A483 A8 97        	dw	cardZC
 156++A485 B3 97        	dw	mDivMMC
 157++A487 BE 97        	dw	sDivMMC
 158++A489
 159++A489              ;------------------------------------------------------------------------------
 160++A489              ; 訡
 161++A489 00           ideError	db 0
 162++A48A
 163++A48A              ;==============================================================================
 164++A48A
# file closed: Drivers/DrvHDD/DrvHDD.var1_10.a80
 232+ A48A              	ELSE
 233+ A48A ~            	 INCLUDE	"DrvHDD.var1_00.a80"
 234+ A48A              	ENDIF
 235+ A48A              End	;SAVEBIN	"drvhdd.bin",Start,End-Start
 236+ A48A              	DISPLAY		"Lenght DrvHDD = ",/A,End-Start
 237+ A48A              	ENDMODULE
 238+ A48A
# file closed: Drivers/DrvHDD/DrvHDD.main.a80
5179  A48A              		include "Drivers/DrvFAT/DrvFAT.main.a80"
# file opened: Drivers/DrvFAT/DrvFAT.main.a80
   1+ A48A              ;ࠩ  FAT32
   2+ A48A              ;FAT Driver v1.00
   3+ A48A              ;(c) 2022-2024 LW aka PLM
   4+ A48A              ;
   5+ A48A              ;Date Creating: 14.12.2022
   6+ A48A              ;Last   Update: 08.09.2024
   7+ A48A              ;Last  Edition: 08.09.2024
   8+ A48A              ;
   9+ A48A              ;:
  10+ A48A              ;DrvFAT.main.a80	-  䠩
  11+ A48A              ;DrvFAT.LFN.a80		- ࠡ  묨 
  12+ A48A              ;DrvFAT.rst.a80		- ࠡ⪠ ᮢ 짮⥫
  13+ A48A              ;DrvFAT.format.a80	- ᮧ  ଠ஢ ࠧ
  14+ A48A              ;DrvFAT.dir.a80		- ࠡ  ⠫
  15+ A48A              ;DrvFAT.file.a80	- ࠡ  䠩  ⠫
  16+ A48A              ;DrvFAT.fcb.a80		- ࠡ  ஬ fcb
  17+ A48A              ;DrvFAT.init.a80	- 樠 ६ FAT32 ࠧ
  18+ A48A              ;DrvFAT.part.a80	- ࠡ  ࠧ
  19+ A48A              ;DrvFAT.table.a80	- 楤  ࠡ  ⠡楩 FAT
  20+ A48A              ;DrvFAT.str.a80		-  ࠡ  ப
  21+ A48A              ;DrvFAT.misc.a80	- 楤 饣 祭
  22+ A48A              ;DrvFAT.var.a80		- ६
  23+ A48A              ;DrvFAT.info		- ଠ  ࠩ
  24+ A48A              ;DrvFAT.lua.a80		- LUA
  25+ A48A              ;
  26+ A48A              ;------------------------------------------------------------------------------
  27+ A48A              ; 樨
  28+ A48A              	DEVICE 	ZXSPECTRUM128
  29+ A48A              	INCLUDE "DrvFAT.lua.a80"
# file opened: Drivers/DrvFAT/DrvFAT.lua.a80
   1++A48A              	LUA
   2++A48A ~
   3++A48A ~            	local nameflog = "DrvFAT.lua.info"
   4++A48A ~            	local flog = nil
   5++A48A ~            	local blname={}
   6++A48A ~            	blname[1] ="DrvFAT.Start"
   7++A48A ~            	blname[2] ="DrvFAT.End"
   8++A48A ~
   9++A48A ~            	if flog==nil then flog=io.open(nameflog,"w") end
  10++A48A ~
  11++A48A ~            	plen = sj.get_label(blname[1])
  12++A48A ~            	flog:write(" 砫 DrvFAT32","\t"," = ",string.format('0x%04X', plen)," = ",plen,"\n")
  13++A48A ~
  14++A48A ~            	plen = sj.get_label(blname[2]) - sj.get_label(blname[1])
  15++A48A ~            	flog:write("  ࠩ","\t"," = ",string.format('0x%04X', plen)," = ",plen,"\n")
  16++A48A ~
  17++A48A ~            	flog:flush ()
  18++A48A ~
  19++A48A              	ENDLUA
  20++A48A
  21++A48A
# file closed: Drivers/DrvFAT/DrvFAT.lua.a80
  30+ A48A              	INCLUDE "DrvHDD.Project.mac"
# file opened: Drivers/DrvFAT/DrvHDD.Project.mac
   1++A48A              ;  맮 / ࠩ ॠ
   2++A48A              ;䠩 DrvHDD.mac
   3++A48A              ;
   4++A48A              ;hddSetCurrSec		  ⠭  ६  LBA/CHS
   5++A48A              ;hddReadSec2HL		⥭ ᥪ     㥬 hl
   6++A48A              ;hddReadSec2IX		⥭ ᥪ     㥬 ix
   7++A48A              ;hddWriteSecHL		 ᥪ   㥬 hl  
   8++A48A              ;hddWriteSecIX		 ᥪ   㥬 IX  
   9++A48A              ;CheckDelFile		室 ஢ન 㤠  䠩
  10++A48A              ;			(㦭 ⮫쪮  䏇)
  11++A48A              ;CheckHDDms		஢ઠ   ⥬  
  12++A48A              ;SetNumSectors_1	⠭ ⢠ । ᥪ஢ =#01
  13++A48A              ;ReadSecMBR		⥭ 㫥 ᥪ     Buf4MBR
  14++A48A              ;SetHDDpart		⠭ ⥪騬  ᮣ᭮  ࠧ
  15++A48A              ;WriteSecDEHL		 ᥪ   xE5A9    
  16++A48A              ;			 dehl
  17++A48A              ;DirectRdWrSectors	אַ ⥭/ 㯯 ᥪ஢  
  18++A48A              ;
  19++A48A              ;------------------------------------------------------------------------------
  20++A48A              ;  ⠭  ६  LBA/CHS
  21++A48A              ;:  dehl - ᬥ饭  ᥪ (512b)  砫   㦭 ᥪ
  22++A48A              	MACRO	hddSetCurrSec
  23++A48A ~            	call	DrvHDD.hddSetVarLBAadr
  24++A48A              	ENDM
  25++A48A
  26++A48A              ;------------------------------------------------------------------------------
  27++A48A              ;⥭ ᥪ     㥬 hl
  28++A48A              ;: hl  
  29++A48A              	MACRO	hddReadSec2HL
  30++A48A ~            	call	DrvHDD.RdSecHDD_HL
  31++A48A              	ENDM
  32++A48A
  33++A48A              ;------------------------------------------------------------------------------
  34++A48A              ;⥭ ᥪ     㥬 ix
  35++A48A              ;: hl = ix
  36++A48A              	MACRO	hddReadSec2IX
  37++A48A ~            	call	DrvHDD.RdSecHDD_IX
  38++A48A              	ENDM
  39++A48A
  40++A48A              ;------------------------------------------------------------------------------
  41++A48A              ; ᥪ   㥬 hl  
  42++A48A              ;: hl  
  43++A48A              	MACRO	hddWriteSecHL
  44++A48A ~            	call	DrvHDD.WrSecHDD_HL
  45++A48A              	ENDM
  46++A48A
  47++A48A              ;------------------------------------------------------------------------------
  48++A48A              ; ᥪ   㥬 ix  
  49++A48A              ;: hl = ix
  50++A48A              	MACRO	hddWriteSecIX
  51++A48A ~            	call	DrvHDD.WrSecHDD_IX
  52++A48A              	ENDM
  53++A48A
  54++A48A              ;------------------------------------------------------------------------------
  55++A48A              ;室 ஢ન 㤠  䠩 (㦭 ⮫쪮  䏇)
  56++A48A              ;: nz - ஢ઠ  㦭
  57++A48A              	MACRO	CheckDelFile
  58++A48A ~            	bit	0,(iy+#1B)
  59++A48A              	ENDM
  60++A48A
  61++A48A              ;------------------------------------------------------------------------------
  62++A48A              ;஢ઠ   ⥬  
  63++A48A              ;:  a -   =#00/#01 master/slave
  64++A48A              ;: z -  
  65++A48A              	MACRO	CheckHDDms
  66++A48A ~            	or	a
  67++A48A ~            	jr	z,.gtm01
  68++A48A ~            	bit	3,(iy+#1D)
  69++A48A ~            	jr	.gtm02
  70++A48A ~            .gtm01	bit	3,(iy+#1C)
  71++A48A ~            .gtm02
  72++A48A              	ENDM
  73++A48A
  74++A48A              ;------------------------------------------------------------------------------
  75++A48A              ;⠭ ⢠ । ᥪ஢ =#01
  76++A48A              	MACRO	SetNumSectors_1
  77++A48A ~            	ld	a,#01
  78++A48A ~            	ld	(DrvHDD.idePort1F2),a	;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
  79++A48A              	ENDM
  80++A48A
  81++A48A              ;------------------------------------------------------------------------------
  82++A48A              ;⥭ 㫥 ᥪ     Buf4MBR
  83++A48A              	MACRO	ReadSecMBR
  84++A48A ~            	call	DrvHDD.RdSecHDD_DEHL
  85++A48A              	ENDM
  86++A48A
  87++A48A              ;------------------------------------------------------------------------------
  88++A48A              ;⠭ ⥪騬  ᮣ᭮  ࠧ
  89++A48A              ;:  0-1,a -  ࠧ
  90++A48A              ;       2,a - hdd master/slave
  91++A48A              ;     5-3,a -  ஫
  92++A48A              ;: cy=1 ன⢮ 
  93++A48A              ;
  94++A48A              	MACRO	SetHDDpart
  95++A48A ~            	call	DrvHDD.hddSetDevice
  96++A48A              	ENDM
  97++A48A
  98++A48A              ;------------------------------------------------------------------------------
  99++A48A              ; ᥪ        dehl
 100++A48A              ;:  dehl - LBA  ᥪ
 101++A48A              ;: cy=1 訡 ⥭ 
 102++A48A              ;
 103++A48A              	MACRO	WriteSecDEHL
 104++A48A ~            	call	Rom7.WrSecHDD_DEHL
 105++A48A              	ENDM
 106++A48A
 107++A48A              ;------------------------------------------------------------------------------
 108++A48A              ;אַ ⥭/ 㯯 ᥪ஢  
 109++A48A              ;:   ࢮ ᥪ   ⠭  ६
 110++A48A              ;     hl -   ⥭
 111++A48A              ;     b  - ⢮ ᥪ஢  ⥭
 112++A48A              ;     cy=0/1 - ⥭/
 113++A48A              ;: cy=1 訡 ⥭/
 114++A48A              ;       a=#60 - HDD  襫  ⮢
 115++A48A              ;       a=#61
 116++A48A              ;       a=#62
 117++A48A              ;       a=#57 -  訡 ࠩ
 118++A48A              ;
 119++A48A              	MACRO	DirectRdWrSectors
 120++A48A ~            	call	Rom7.hddRdWrSectors
 121++A48A              	ENDM
 122++A48A
 123++A48A              ;==============================================================================
 124++A48A
# file closed: Drivers/DrvFAT/DrvHDD.Project.mac
  31+ A48A              ;	PAGE	#00
  32+ A48A              	MODULE	DrvFAT
  33+ A48A
  34+ A48A              ;------------------------------------------------------------------------------
  35+ A48A              ;᫮ ࠭樨
  36+ A48A
  37+ A48A              ;	DEFINE	forProfROM	;ᡮઠ  䏧
  38+ A48A              ;	DEFINE	forRRL		;ᡮઠ  ResetRomLoader
  39+ A48A              	DEFINE	withMFS		; প MFS
  40+ A48A              ;	DEFINE	VarsInDrv	;६ 室  ⠢ ࠩ
  41+ A48A              ;	DEFINE	FAT_SIZE_32	;প ⮫쪮 FAT32 ( ॠ)
  42+ A48A
  43+ A48A              ;------------------------------------------------------------------------------
  44+ A48A              ;⠭ ࠩ
  45+ A48A
  46+ A48A              ; ᥬ஢:
  47+ A48A              AdrDrvBegin	equ $
  48+ A48A
  49+ A48A              	ifndef	VarsInDrv
  50+ A48A              VarsFAT	equ	_VarsFAT;  ६
  51+ A48A              	endif
  52+ A48A
  53+ A48A              LenEntryLFN	equ #0D	;⢮ ᨬ  ਯ LongName
  54+ A48A              fnSep		equ "/" ;᭮ ࠧ⥫   (    )
  55+ A48A              fnSep1		equ "/" ; ࠧ⥫  
  56+ A48A              fnSep2		equ #5C ; ࠧ⥫  
  57+ A48A
  58+ A48A              ; 訡
  59+ A48A              errOK		equ #00
  60+ A48A              errNumTooBig	equ #11 ;number too big
  61+ A48A              @errInvFileName	equ #45 ;invalid file name
  62+ A48A              errFileNotFound	equ #48 ;file not found
  63+ A48A              errDiskNoSpace	equ #49	;disk no space
  64+ A48A              errRWnum	equ #50 ;R/W error _᫮_
  65+ A48A              errHddNotFound	equ #56 ;hard disk not found
  66+ A48A              errHddRWerror	equ #57 ;hard disk R/W error #nnnn
  67+ A48A              errHddBusy	equ #60 ;busy not found
  68+ A48A              errHddNotReady	equ #61 ;hard disk not ready
  69+ A48A              errHddNotData	equ #62 ;hard disk data not ready
  70+ A48A              errInvPartMg	equ #63 ;invalid partition manager
  71+ A48A              errPartNotFound	equ #66 ;partition not found
  72+ A48A              errInvalidPart	equ #6D ;invalid partition
  73+ A48A              errInvalidFile	equ #70 ;invalid file
  74+ A48A              errEoF		equ #71 ;end of file
  75+ A48A              errPathEmpty	equ #72 ;path empty
  76+ A48A              errFileExist	equ #73 ;file exist
  77+ A48A              errDirNotEmpty	equ #74 ;dir not empty
  78+ A48A              errFileEmpty	equ #75 ;file empty
  79+ A48A              errAccesDenied	equ #79 ;acces denied
  80+ A48A              errCopyItself	equ #7A ;copy to itself
  81+ A48A
  82+ A48A              ;ᬥ饭   fcb
  83+ A48A              fcbName		equ #00 ;8  䠩
  84+ A48A              fcbExt		equ #08 ;3 ७ 䠩
  85+ A48A              fcbAttr		equ #0B ;1 ਡ 䠩
  86+ A48A              fcbClsFile	equ #0C ;4  ࢮ  䠩/⠫
  87+ A48A              fcbClsDIR	equ #10 ;4  ࢮ  ⠫  ⨬ 䠩/⠫
  88+ A48A              fcbSize		equ #14 ;4 ࠧ 䠩/⠫  
  89+ A48A              fcbOffset	equ #18 ;4 㪠⥫  䠩
  90+ A48A              fcbStore	equ #1C	;1  ७ 㦤
  91+ A48A              fcbStore2	equ #1D ;1 १
  92+ A48A              fcbType		equ #1E ;1 bit 3,=0/1  SFN/LFN
  93+ A48A              			;  bit 4,=0/1  䠩/⠫
  94+ A48A              fcbPart		equ #1F ;1  ⥪饣   ࠧ  
  95+ A48A
  96+ A48A              ;ᬥ饭   BPB
  97+ A48A              BPB_BytesPerSec		equ #0B	;2 ⢮   ᥪ
  98+ A48A              BPB_SecPerClus		equ #0D	;1 ⢮ ᥪ஢  
  99+ A48A              BPB_RsvdSecCnt		equ #0E	;2 ⢮ १ࢨ஢ ᥪ஢
 100+ A48A              BPB_NumFATs		equ #10	;1 ⢮ FAT ⠡
 101+ A48A              BPB_RootEntCnt		equ #11	;2  FAT12/16 ᫮ 32- ⮢,  FAT32 = 0
 102+ A48A              BPB_TotSec16		equ #13	;2 ⢮ ᥪ஢  ࠧ
 103+ A48A              BPB_FATSz16		equ #16	;2  FAT12/16 ⢮ ᥪ஢  FAT,  FAT32 = 0
 104+ A48A              BPB_TotSec32		equ #20	;4 饥 ⢮ ᥪ஢  ࠧ
 105+ A48A              BPB_FATSz32		equ #24	;4 ⢮ ᥪ஢  FAT ⠡
 106+ A48A              BPB_RootClus		equ #2C	;4  ࢮ  root ४ਨ
 107+ A48A              BPB_FAT32_FsInfo	equ #30 ;2  ᥪ  FSInfo  १ࢭ  ᪮ ᪠
 108+ A48A
 109+ A48A              ;ࠧ 
 110+ A48A              Buf4File	equ _Buf4File	;  ⥭ 䠩
 111+ A48A              Buf4MBR		equ _Buf4MBR	;  ᥪ஬ MBR
 112+ A48A              Buf4LFN		equ _Buf4LFN	;  ᮧ ᥩ   
 113+ A48A              Buf4Format	equ 0		;#600   ଠ஢ ࠧ
 114+ A48A              @Buf4Desc	equ 0		;#200   ஢ ਯ஢  ⠫
 115+ A48A              @Buf4FirstSym	equ 0		;#200    㪢  ਯ஢
 116+ A48A              Buf4DIR		equ _Buf4DIR	;#200   㧪 ᥪ DIR (⠫)
 117+ A48A              Buf4FAT		equ _Buf4FAT	;#200   㧪 ᥪ FAT
 118+ A48A              @Buf4SortDesc	equ 0		;६   ஢ FAT ⠫
 119+ A48A              @CurrentPath 	equ _CurrentPath;#100  ⥪饣 
 120+ A48A              				;+#00 -   (᫥   =#00)
 121+ A48A              @BufCurrentPath	equ 0		;#100  ⥪饣  ( ࠭  )
 122+ A48A              tmp_fcb		equ _tmp_fcb	;#20  ६ ࠭ fcb
 123+ A48A
 124+ A48A              ;------------------------------------------------------------------------------
 125+ A48A
 126+ A48A              	ORG	AdrDrvBegin
 127+ A48A              Start
 128+ A48A              	INCLUDE	"DrvFAT.LFN.a80"
# file opened: Drivers/DrvFAT/DrvFAT.LFN.a80
   1++A48A              ;楤  FAT Driver. ࠡ  묨 
   2++A48A              ;䠩 DrvFAT.LFN.a80
   3++A48A              ;
   4++A48A              ;lfnSetOneEntry		⠭   LFN  
   5++A48A              ;fatSetSFNname		ନ஢ ⪮   ஢મ ⢮
   6++A48A              ;			䠩
   7++A48A              ;fatGetLongName		祭   䠩
   8++A48A              ;lfnGetOneGroupName	뤥     ਯ
   9++A48A              ;strGetShortName	஢   ⪮   ॢ ᨬ
  10++A48A              ;			  ॣ
  11++A48A              ;
  12++A48A              ;------------------------------------------------------------------------------
  13++A48A              lfnSetOneEntry	ifused
  14++A48A              ;⠭   LFN  
  15++A48A              ;:  de -   ப  
  16++A48A              ;     hl -    
  17++A48A              ;     b -  ⠭ 
  18++A48A              ;     c - ஫쭠 㬬 ⪮ 
  19++A48A              ;: de - ᫥騩  ப  
  20++A48A              ;     hl -     +#20
  21++A48A              ;     b -  ⠭ 
  22++A48A              ;     c - ஫쭠 㬬 ⪮ 
  23++A48A              ;
  24++A48A              ;lfnSetOneEntry
  25++A48A              ;
  26++A48A              ; +#00     
  27++A48A 70           	ld	(hl),b
  28++A48B 23           	inc	hl
  29++A48C              ; +#01..#0A (5 ᨬ)
  30++A48C B7           	or	a
  31++A48D 3E 05        	ld	a,#05
  32++A48F CD A7 A4     	call	lfnSetOneGroupName
  33++A492              ; +#0B..#0C
  34++A492 36 0F        	ld	(hl),#0F
  35++A494 23           	inc	hl
  36++A495 36 00        	ld	(hl),#00
  37++A497 23           	inc	hl
  38++A498              ; +#0D ஫쭠 㬬 ⪮ 
  39++A498 71           	ld	(hl),c
  40++A499 23           	inc	hl
  41++A49A              ; +#0E..#19 (6 ᨬ)
  42++A49A 3E 06        	ld	a,#06
  43++A49C CD A7 A4     	call	lfnSetOneGroupName
  44++A49F              ; +#1A..#1B 㫨
  45++A49F 36 00        	ld	(hl),#00
  46++A4A1 23           	inc	hl
  47++A4A2 36 00        	ld	(hl),#00
  48++A4A4 23           	inc	hl
  49++A4A5              ; +#1C..#1F (2 ᨬ)
  50++A4A5 3E 02        	ld	a,#02
  51++A4A7              ;	call	lfnSetOneGroupName
  52++A4A7              ;	ret
  53++A4A7
  54++A4A7              	endif
  55++A4A7
  56++A4A7              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  57++A4A7              lfnSetOneGroupName	ifused
  58++A4A7              ;८ࠧ ப    
  59++A4A7              ;:  a - ⢮ ᨬ  㯯
  60++A4A7              ;     hl -  㯯  ਯ
  61++A4A7              ;     de -  ப 筨
  62++A4A7              ;     cy=1 塞  #FF
  63++A4A7              ;: cy=1 -  ,  塞 #FF
  64++A4A7              ;     hl=hl+(a*2)
  65++A4A7              ;     de=de+a - ᫥騩   ப  
  66++A4A7              ;
  67++A4A7              ;lfnSetOneGroupName
  68++A4A7              ;
  69++A4A7 C5           	push	bc
  70++A4A8 47           	ld	b,a
  71++A4A9 9F           	sbc	a,a			;cy=1 -> a=#FF, cy=1
  72++A4AA 38 3E        	jr	c,goto163		;  ᨬ  
  73++A4AC 1A           loop062	ld	a,(de)
  74++A4AD B7           	or	a
  75++A4AE 28 3A        	jr	z,goto163		; 
  76++A4B0 D5           	push	de
  77++A4B1 11 5F 00     	ld	de,#005F		;"_"
  78++A4B4 CD 72 B2     	call	chrCheckLFN		;஢ઠ  ⨬ ᨬ
  79++A4B7 28 26        	jr	z,goto164		; ⨬ ᨬ   䠩
  80++A4B9 5F           	ld	e,a
  81++A4BA FE 80        	cp	#80
  82++A4BC 38 21        	jr	c,goto164		;ᨬ ⨭   ப
  83++A4BE FE A0        	cp	#A0
  84++A4C0 38 18        	jr	c,goto165		;.. -> -#70
  85++A4C2 FE B0        	cp	#B0
  86++A4C4 38 14        	jr	c,goto165		;.. -> -#70
  87++A4C6 FE E0        	cp	#E0
  88++A4C8 38 15        	jr	c,goto164		;᪨ ᨬ ⨬
  89++A4CA FE F0        	cp	#F0
  90++A4CC 38 0A        	jr	c,goto166		;.. -> -#A0
  91++A4CE FE F1        	cp	#F1
  92++A4D0 38 04        	jr	c,goto167		; -> -#EF
  93++A4D2 28 04        	jr	z,goto166		; -> -#A0
  94++A4D4 18 09        	jr	goto164			;⠫쭮 ⨬
  95++A4D6 D6 4F        goto167	sub	#4F
  96++A4D8 D6 30        goto166	sub	#30			;-#A0
  97++A4DA D6 70        goto165	sub	#70			;-#70
  98++A4DC 5F           	ld	e,a
  99++A4DD 16 04        	ld	d,#04
 100++A4DF 73           goto164	ld	(hl),e
 101++A4E0 23           	inc	hl
 102++A4E1 72           	ld	(hl),d
 103++A4E2 23           	inc	hl
 104++A4E3 D1           	pop	de
 105++A4E4 13           	inc	de
 106++A4E5 10 C5        	djnz	loop062
 107++A4E7 C1           	pop	bc
 108++A4E8 B7           	or	a
 109++A4E9 C9           	ret
 110++A4EA              ; 
 111++A4EA 77           goto163	ld	(hl),a
 112++A4EB 23           	inc	hl
 113++A4EC 77           	ld	(hl),a
 114++A4ED 23           	inc	hl
 115++A4EE 3E FF        	ld	a,#FF
 116++A4F0 10 F8        	djnz	goto163
 117++A4F2 C1           	pop	bc
 118++A4F3 37           	scf
 119++A4F4 C9           	ret
 120++A4F5
 121++A4F5              	endif
 122++A4F5
 123++A4F5              ;------------------------------------------------------------------------------
 124++A4F5              fatSetSFNname	ifused
 125++A4F5              ;ନ஢ ⪮   ஢મ ⢮ 䠩
 126++A4F5              ;:  ix -   fcb
 127++A4F5              ;     hl -  ப   䠩
 128++A4F5              ;: hl -  
 129++A4F5              ;     b =#00
 130++A4F5              ;     c - ஫쭠 㬬 
 131++A4F5              ;     cy=1 訡 ⥭/
 132++A4F5              ;       a=errRWnum
 133++A4F5              ;       a=errInvalidPart
 134++A4F5              ;       a=errEoF - 䠩 ࢠ
 135++A4F5              ;       a=errFileEmpty - ⮩ ୥ ⠫
 136++A4F5              ;       a=errInvFileName 䠩  ⠪  
 137++A4F5              ;     cy=0   
 138++A4F5              ;
 139++A4F5              ;fatSetSFNname
 140++A4F5              ;
 141++A4F5 E5           	push	hl
 142++A4F6 DD E5        	push	ix
 143++A4F8 D1           	pop	de
 144++A4F9 CD 7F B1     	call	FileNameLFNto8dot3	;ନ㥬 ⪮ 
 145++A4FC C5           	push	bc			;b=#00
 146++A4FD 18 1B        	jr	goto159			;饬 䠩
 147++A4FF
 148++A4FF              ;⪮४㥬   ⨫줮, ᫨ 
 149++A4FF C5           loop061	push	bc
 150++A500 2B           	dec	hl
 151++A501 2B           	dec	hl
 152++A502 2B           	dec	hl
 153++A503 2B           	dec	hl			;hl+7   䩠
 154++A504 78           	ld	a,b
 155++A505 E6 0F        	and	#0F
 156++A507 C6 30        	add	a,#30
 157++A509 77           	ld	(hl),a			;ன ᨬ ᫥ ⨫
 158++A50A 2B           	dec	hl
 159++A50B 78           	ld	a,b
 160++A50C 0F           	rrca
 161++A50D 0F           	rrca
 162++A50E 0F           	rrca
 163++A50F 0F           	rrca
 164++A510 E6 0F        	and	#0F
 165++A512 28 04        	jr	z,goto160			;⠢ ⨫
 166++A514 C6 30        	add	a,#30
 167++A516 77           	ld	(hl),a
 168++A517 2B           	dec	hl
 169++A518 36 7E        goto160	ld	(hl),"~"
 170++A51A DD E5        goto159	push	ix
 171++A51C E1           	pop	hl			;   fcb
 172++A51D CD A1 A7     	call	fatFindEntryDir		; 䠩  ⠫
 173++A520              ;	call	fcbFindEntry		; 䠩  ⠫
 174++A520 C1           	pop	bc
 175++A521 38 08        	jr	c,goto161		;訡 ⥭
 176++A523 20 06        	jr	nz,goto161		;䠩  ⠪   
 177++A525 04           	inc	b
 178++A526 20 D7        	jr	nz,loop061		;䠩  ⠪  
 179++A528 3E 45        	ld	a,errInvFileName
 180++A52A 37           	scf
 181++A52B
 182++A52B              ; ஫쭮 㬬 ⪮ 
 183++A52B F5           goto161	push	af
 184++A52C DD E5        	push	ix
 185++A52E E1           	pop	hl
 186++A52F AF           	xor	a
 187++A530 06 0B        	ld	b,#0B
 188++A532 4F           goto168	ld	c,a
 189++A533 0F           	rrca
 190++A534 E6 80        	and	#80
 191++A536 CB 39        	srl	c
 192++A538 81           	add	a,c
 193++A539 86           	add	a,(hl)
 194++A53A 23           	inc	hl
 195++A53B 10 F5        	djnz	goto168
 196++A53D 4F           	ld	c,a
 197++A53E F1           	pop	af
 198++A53F E1           	pop	hl
 199++A540 C9           	ret
 200++A541
 201++A541              	endif
 202++A541
 203++A541              ;------------------------------------------------------------------------------
 204++A541              fatGetLongName	ifused
 205++A541 ~            ;祭   䠩
 206++A541 ~            ;:  hl -    
 207++A541 ~            ;     bc -    ⥪饬 ⠫
 208++A541 ~            ;: hl -     ଠ ASCIZ (᫨   , 
 209++A541 ~            ;          頥 ⪮ )
 210++A541 ~            ;     a -  ,  ⮬ 
 211++A541 ~            ;
 212++A541 ~            ;fatGetLongName
 213++A541 ~            ;
 214++A541 ~            	push	hl
 215++A541 ~            	push	hl
 216++A541 ~            	call	fatGetEntryLong		;  ⥪饬 ⠫ ਯ   
 217++A541 ~            	jr	c,goto157
 218++A541 ~            	bit	0,e
 219++A541 ~            	jp	z,lfnGetShortName	;  
 220++A541 ~
 221++A541 ~            ;⥭   䠩
 222++A541 ~            	exx
 223++A541 ~            	ld	c,#00
 224++A541 ~            	exx
 225++A541 ~            loop059	dec	bc
 226++A541 ~            	call	fatGetEntry
 227++A541 ~            	jr	c,goto157
 228++A541 ~            	ld	a,(hl)
 229++A541 ~            	inc	hl
 230++A541 ~            	exx
 231++A541 ~            	bit	6,c
 232++A541 ~            	pop	hl			;  
 233++A541 ~            	jr	nz,goto151
 234++A541 ~            	ld	c,a
 235++A541 ~            	exx
 236++A541 ~            	ld	a,#05			;⢮ ᨬ
 237++A541 ~            	call	lfnGetOneGroupName
 238++A541 ~            	and	a
 239++A541 ~            	jr	z,goto156		; 
 240++A541 ~            	inc	hl
 241++A541 ~            	inc	hl
 242++A541 ~            	inc	hl
 243++A541 ~            	ld	a,#06
 244++A541 ~            	call	lfnGetOneGroupName
 245++A541 ~            	and	a
 246++A541 ~            	jr	z,goto156		; 
 247++A541 ~            	inc	hl
 248++A541 ~            	inc	hl
 249++A541 ~            	ld	a,#02
 250++A541 ~            	call	lfnGetOneGroupName
 251++A541 ~            	and	a
 252++A541 ~            	jr	z,goto156		; 
 253++A541 ~            	exx
 254++A541 ~            	push	hl
 255++A541 ~            	exx
 256++A541 ~            	jr	loop059
 257++A541 ~
 258++A541 ~            ;થ     
 259++A541 ~            goto156	exx
 260++A541 ~            goto151	ld	(hl),#00
 261++A541 ~            	inc	hl
 262++A541 ~            	pop	de
 263++A541 ~            	push	de
 264++A541 ~            	or	a
 265++A541 ~            	sbc	hl,de
 266++A541 ~            	ld	a,l
 267++A541 ~            	exx
 268++A541 ~            	pop	hl
 269++A541 ~            	ret
 270++A541 ~
 271++A541 ~            ;訡 ⥭
 272++A541 ~            goto157	pop	hl
 273++A541 ~            	pop	hl
 274++A541 ~            	ret
 275++A541 ~            	jr	strGetShortName
 276++A541 ~            	org	$-2
 277++A541 ~
 278++A541              	endif
 279++A541
 280++A541              ;------------------------------------------------------------------------------
 281++A541              lfnGetOneGroupName	ifused
 282++A541 ~            ;뤥     ਯ
 283++A541 ~            ;:  a - ⢮ ᨬ  㯯
 284++A541 ~            ;     hl -  㯯  ਯ
 285++A541 ~            ;     hl' -  ਥ  
 286++A541 ~            ;: z,a =#00 -  
 287++A541 ~            ;     hl=hl+(a*2)
 288++A541 ~            ;     hl' -  ਥ  
 289++A541 ~            ;
 290++A541 ~            ;lfnGetOneGroupName
 291++A541 ~            ;
 292++A541 ~            	exx
 293++A541 ~            	ld	b,a
 294++A541 ~            	exx
 295++A541 ~            loop058	ld	d,(hl)
 296++A541 ~            	inc	hl
 297++A541 ~            	ld	e,(hl)
 298++A541 ~            	inc	hl
 299++A541 ~            	ld	a,d
 300++A541 ~            	or	e
 301++A541 ~            	ret	z
 302++A541 ~            	ld	a,e
 303++A541 ~            	and	a
 304++A541 ~            	jr	nz,goto152
 305++A541 ~            	ld	a,d
 306++A541 ~            	cp	#80
 307++A541 ~            	jr	c,goto153
 308++A541 ~            	ld	d,#5F
 309++A541 ~            	jr	goto153
 310++A541 ~            goto152	cp	#04
 311++A541 ~            	ld	a,#5F
 312++A541 ~            	jr	nz,goto153
 313++A541 ~            	ld	a,d
 314++A541 ~            	ld	de,#5FEF
 315++A541 ~            	cp	#01
 316++A541 ~            	jr	z,goto154
 317++A541 ~            	ld	e,#A0
 318++A541 ~            	cp	#51
 319++A541 ~            	jr	z,goto154
 320++A541 ~            	sub	#10
 321++A541 ~            	ld	e,#80
 322++A541 ~            	jr	nc,goto155
 323++A541 ~            	ld	a,d
 324++A541 ~            	jr	goto153
 325++A541 ~            goto155	cp	#30
 326++A541 ~            	jr	c,goto154
 327++A541 ~            	ld	e,#B0
 328++A541 ~            	cp	#40
 329++A541 ~            	jr	c,goto154
 330++A541 ~            	ld	a,d
 331++A541 ~            	jr	goto153
 332++A541 ~            goto154	add	a,e
 333++A541 ~            goto153	exx
 334++A541 ~            	ld	(hl),a
 335++A541 ~            	inc	hl
 336++A541 ~            	dec	b
 337++A541 ~            	exx
 338++A541 ~            	jr	nz,loop058
 339++A541 ~            	ret
 340++A541 ~
 341++A541              	endif
 342++A541
 343++A541              ;------------------------------------------------------------------------------
 344++A541              strGetShortName	ifused
 345++A541 ~            ;஢   ⪮   ॢ ᨬ   ॣ
 346++A541 ~            ;:  hl -  ਯ
 347++A541 ~            ;     de -  ਥ  
 348++A541 ~            ;     a - ਡ 
 349++A541 ~            ;: a -  ப  
 350++A541 ~            ;     hl -  砫 
 351++A541 ~            ;
 352++A541 ~            ;strGetShortName
 353++A541 ~            ;
 354++A541 ~            	push	de
 355++A541 ~            	push	de
 356++A541 ~
 357++A541 ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 358++A541 ~            ;஢   ⪮   ॢ ᨬ   ॣ
 359++A541 ~            ;:  hl -  ਯ
 360++A541 ~            ;     (sp) -  ਥ  
 361++A541 ~            ;     (sp) -  ਥ  
 362++A541 ~            ;     a - ਡ 
 363++A541 ~            ;: a -  ப  
 364++A541 ~            ;     hl -  砫 
 365++A541 ~            ;
 366++A541 ~            lfnGetShortName
 367++A541 ~            ;
 368++A541 ~            	pop	de
 369++A541 ~            	ld	c,a
 370++A541 ~            	ld	b,#08
 371++A541 ~            	call	proc_14			;㥬 
 372++A541 ~            	ld	a,(hl)
 373++A541 ~            	cp	" "
 374++A541 ~            	jr	z,goto150		; ७
 375++A541 ~            	ld	a,"."
 376++A541 ~            	ld	(de),a
 377++A541 ~            	inc	de
 378++A541 ~            	ld	b,#03
 379++A541 ~            	call	proc_14			;㥬 ७
 380++A541 ~
 381++A541 ~            ;થ     
 382++A541 ~            goto150	ex	de,hl
 383++A541 ~            	ld	(hl),#00
 384++A541 ~            	inc	hl
 385++A541 ~            	pop	de
 386++A541 ~            	or	a
 387++A541 ~            	sbc	hl,de
 388++A541 ~            	ld	a,l			; 
 389++A541 ~            	ex	de,hl
 390++A541 ~            	ret
 391++A541 ~
 392++A541 ~            ;஢ /७  ਥ  ॢ   ॣ
 393++A541 ~            proc_14
 394++A541 ~            loop057	ld	a,(hl)
 395++A541 ~            	cp	" "
 396++A541 ~            	jr	z,goto146
 397++A541 ~            	bit	4,c
 398++A541 ~            	jr	nz,goto147		; ⠫
 399++A541 ~            	cp	"A"
 400++A541 ~            	jr	c,goto147
 401++A541 ~            	cp	"Z"+1
 402++A541 ~            	jr	c,goto148
 403++A541 ~            	cp	#80			;rus 
 404++A541 ~            	jr	c,goto147
 405++A541 ~            	cp	#90			;rus +1
 406++A541 ~            	jr	c,goto148
 407++A541 ~            	cp	#A0			;rus +1
 408++A541 ~            	jr	c,goto149
 409++A541 ~            	cp	#F0
 410++A541 ~            	jr	nz,goto147		;rus 
 411++A541 ~            	inc	a
 412++A541 ~            	jr	goto147
 413++A541 ~            goto149	and	#EF
 414++A541 ~            	or	#40
 415++A541 ~            goto148	or	#20
 416++A541 ~            goto147	ld	(de),a
 417++A541 ~            	inc	de
 418++A541 ~            	inc	hl
 419++A541 ~            	djnz	loop057
 420++A541 ~            goto146	ld	a,b
 421++A541 ~            	add	a,l
 422++A541 ~            	ld	l,a
 423++A541 ~            	ret	nc
 424++A541 ~            	inc	h
 425++A541 ~            	ret
 426++A541 ~
 427++A541              	endif
 428++A541
 429++A541              ;==============================================================================
 430++A541
# file closed: Drivers/DrvFAT/DrvFAT.LFN.a80
 129+ A541              	INCLUDE	"DrvFAT.rst.a80"
# file opened: Drivers/DrvFAT/DrvFAT.rst.a80
   1++A541              ;楤  FAT Driver. ࠡ⪠ ᮢ 짮⥫
   2++A541              ;䠩 DrvFAT.rst.a80
   3++A541              ;
   4++A541              ;WriteDataToFile	     䠩
   5++A541              ;ReadDataFromFile	⥭   䠩  
   6++A541              ;tmWrSecHDD_hl		ﬠ  ᥪ      hl
   7++A541              ;			( ⥭ )
   8++A541              ;WrSecHDD_hl		ﬠ  ᥪ      hl
   9++A541              ;tmRdSecHDD_hl		אַ ⥭ ᥪ      hl
  10++A541              ;			( ⥭ )     
  11++A541              ;			⥬ , ⠥ १ 
  12++A541              ;RdSecHDD_hl		אַ ⥭ ᥪ      hl
  13++A541              ;
  14++A541              ;------------------------------------------------------------------------------
  15++A541              WriteDataToFile	ifused
  16++A541              ;     䠩
  17++A541              ;  䠩   
  18++A541              ;   fcb   ⠭: fcbName, fcbExt, fcbClsFile, fcbClsDIR,
  19++A541              ;    fcbSize, fcbOffset, fcbPart
  20++A541              ;:  ix -  fcb
  21++A541              ;     hl -     
  22++A541              ;     bc - ⢮   
  23++A541              ;: cy=1 訡
  24++A541              ;        a=errNumTooBig - ᫨誮 让 ࠧ,  #FFFF ஢
  25++A541              ;        a=errRWnum -  訡
  26++A541              ;        a=errFileEmpty - 㫥 ࠧ 䠩
  27++A541              ;        a=errDiskNoSpace
  28++A541              ;        a=errInvalidPart
  29++A541              ;        a=errEoF - 䠩 ࢠ
  30++A541              ;        a=errFileNotFound
  31++A541              ;     cy=0  ᠭ
  32++A541              ;       hl ᫥騩   
  33++A541              ;
  34++A541              ;WriteDataToFile
  35++A541              ;
  36++A541 E5           	push	hl
  37++A542 C5           	push	bc
  38++A543
  39++A543              ;⠥  ᪮쪮 㦭 㢥 ࠧ 䠩
  40++A543              ;  ࠧ offset-size+BC
  41++A543 CD 05 AD     	call	LD_DEHL_fcbOffset
  42++A546 D5           	push	de
  43++A547 E5           	push	hl
  44++A548 CD 0A AD     	call	LD_DEHL_fcbSize
  45++A54B EB           	ex	de,hl
  46++A54C E3           	ex	(sp),hl
  47++A54D B7           	or	a
  48++A54E ED 52        	sbc	hl,de
  49++A550 D1           	pop	de
  50++A551 E3           	ex	(sp),hl
  51++A552 ED 52        	sbc	hl,de
  52++A554 EB           	ex	de,hl
  53++A555 E1           	pop	hl		;dehl = offset - size
  54++A556 09           	add	hl,bc
  55++A557 30 01        	jr	nc,goto106
  56++A559 13           	inc	de		;dehl = offset - size + BC
  57++A55A 7A           goto106	ld	a,d             ;       ࠧ   㦭 㢥 䠩
  58++A55B B3           	or	e
  59++A55C B4           	or	h
  60++A55D B5           	or	l
  61++A55E 28 09        	jr	z,goto107	;=#00  墠⠥
  62++A560 7A           	ld	a,d
  63++A561 17           	rla
  64++A562 38 05        	jr	c,goto107	;<#00  墠⠥
  65++A564              ;dehl  ᪮쪮  㦭 㢥 ࠧ 䠩
  66++A564
  67++A564              ;ਬ 䠩  dehl 
  68++A564 CD 63 A8     	call	addBytesToFile
  69++A567 38 38        	jr	c,goto115
  70++A569
  71++A569              ; ᬥ饭  ᥪ
  72++A569 CD 05 AD     goto107	call	LD_DEHL_fcbOffset;dehl ᬥ饭  䠩
  73++A56C AF           loop043	xor	a
  74++A56D CB 3A        	srl	d
  75++A56F 20 2E        	jr	nz,goto108	;᫨誮 让 㪠⥫
  76++A571 CB 1B        	rr	e
  77++A573 CB 1C        	rr	h
  78++A575 17           	rla
  79++A576 47           	ld	b,a
  80++A577 4D           	ld	c,l
  81++A578 53           	ld	d,e
  82++A579 5C           	ld	e,h
  83++A57A 21 00 02     	ld	hl,#0200
  84++A57D ED 42        	sbc	hl,bc
  85++A57F              ;hl ᪮쪮    ᥪ  
  86++A57F              ;de ᬥ饭  砫 䠩  ᥪ (512b)
  87++A57F              ;bc ᬥ饭  ᥪ
  88++A57F
  89++A57F              ;। 㦭 뢠 楫 ᥪ  ⮫쪮  
  90++A57F EB           	ex	de,hl
  91++A580 E3           	ex	(sp),hl
  92++A581 B7           	or	a
  93++A582 ED 52        	sbc	hl,de
  94++A584 19           	add	hl,de
  95++A585 30 02        	jr	nc,goto109
  96++A587 54           	ld	d,h
  97++A588 5D           	ld	e,l
  98++A589 F1           goto109	pop	af
  99++A58A E3           	ex	(sp),hl
 100++A58B F5           	push	af
 101++A58C E3           	ex	(sp),hl
 102++A58D EB           	ex	de,hl
 103++A58E 7D           	ld	a,l
 104++A58F B7           	or	a
 105++A590 20 13        	jr	nz,goto110		;襬  ᥪ
 106++A592 7C           	ld	a,h
 107++A593 FE 02        	cp	#02
 108++A595 20 0E        	jr	nz,goto110		;襬  ᥪ
 109++A597              ;hl ᪮쪮  㦭   ᥪ
 110++A597              ;de ᬥ饭  砫 䠩  ᥪ (512b)
 111++A597              ;bc ᬥ饭  ᥪ
 112++A597
 113++A597              ;襬 ᥪ 楫
 114++A597 E1           	pop	hl
 115++A598 CD 4B A6     	call	tmWrSecHDD_hl
 116++A59B 30 2B        	jr	nc,goto111
 117++A59D
 118++A59D              ;訡 
 119++A59D C1           goto112	pop	bc
 120++A59E C9           	ret
 121++A59F 3E 11        goto108	ld	a,errNumTooBig
 122++A5A1 C1           goto115	pop	bc
 123++A5A2 E1           	pop	hl
 124++A5A3 37           	scf
 125++A5A4 C9           	ret
 126++A5A5
 127++A5A5
 128++A5A5              ;襬  ᥪ
 129++A5A5 E5           goto110	push	hl
 130++A5A6 C5           	push	bc
 131++A5A7 21 30 8D     	ld	hl,Buf4File
 132++A5AA E5           	push	hl
 133++A5AB CD 60 A6     	call	RdSecHDD_hl	;⠫ ᥪ  
 134++A5AE E1           	pop	hl
 135++A5AF C1           	pop	bc
 136++A5B0 F5           	push	af
 137++A5B1 09           	add	hl,bc
 138++A5B2 F1           	pop	af
 139++A5B3 C1           	pop	bc
 140++A5B4 D1           	pop	de
 141++A5B5 EB           	ex	de,hl
 142++A5B6 38 E5        	jr	c,goto112	;訡 ⥭
 143++A5B8              	IFDEF	forProfROM
 144++A5B8 ~            	 bit	5,(iy+#0B)
 145++A5B8 ~            	 jr	z,goto113	;맮  
 146++A5B8 ~            	 call	Rom7.CheckAdrMem;।   ⥭  ⥬ 
 147++A5B8 ~            	 jr	nc,goto113
 148++A5B8 ~            	 push	bc
 149++A5B8 ~            	 rst	#30
 150++A5B8 ~            	 dw	Rom2.copyUserRamToRam8	;஢   
 151++A5B8 ~            	 db	#02
 152++A5B8 ~            	 jr	goto114
 153++A5B8              	ENDIF
 154++A5B8              	IFDEF	forRRL
 155++A5B8 ~            	 bit	5,(iy+P0Bh)
 156++A5B8 ~            	 jr	z,goto113		;맮  
 157++A5B8 ~            	 call	r8d.CheckAdrMem		;।   ⥭  ⥬ 
 158++A5B8 ~            	 jr	nc,goto113
 159++A5B8 ~            	 push	bc
 160++A5B8 ~            	 UserMemToBuf
 161++A5B8 ~            ;	 call	Rom2.copyUserRamToRam8	;஢   
 162++A5B8 ~            	 jr	goto114
 163++A5B8              	ENDIF
 164++A5B8
 165++A5B8 C5           goto113	push	bc
 166++A5B9 ED B0        	ldir
 167++A5BB E5           goto114	push	hl
 168++A5BC 21 30 8D     	ld	hl,Buf4File
 169++A5BF              	hddWriteSecHL		; ᥪ    
 169++A5BF CD 37 9B    >	call	DrvHDD.WrSecHDD_HL
 170++A5C2 E1           	pop	hl
 171++A5C3 C1           	pop	bc
 172++A5C4 3E 50        	ld	a,errRWnum
 173++A5C6 38 D5        	jr	c,goto112	;訡 
 174++A5C8
 175++A5C8
 176++A5C8              ;᫥騩 ᥪ
 177++A5C8 E3           goto111	ex	(sp),hl
 178++A5C9 B7           	or	a
 179++A5CA ED 42        	sbc	hl,bc
 180++A5CC E5           	push	hl
 181++A5CD F5           	push	af
 182++A5CE 60           	ld	h,b
 183++A5CF 69           	ld	l,c
 184++A5D0 CD 92 AC     	call	add2Offset_HL
 185++A5D3 F1           	pop	af
 186++A5D4              	IFDEF	forRRL
 187++A5D4 ~            	 jp	nz,loop043
 188++A5D4              	ELSE
 189++A5D4 20 96        	 jr	nz,loop043
 190++A5D6              	ENDIF
 191++A5D6 E1           	pop	hl
 192++A5D7
 193++A5D7
 194++A5D7              ;室
 195++A5D7 E1           	pop	hl
 196++A5D8 B7           	or	a
 197++A5D9 C9           	ret
 198++A5DA
 199++A5DA              	endif
 200++A5DA
 201++A5DA              ;------------------------------------------------------------------------------
 202++A5DA              ReadDataFromFile	ifused
 203++A5DA              ;⥭   䠩  
 204++A5DA              ;  䠩   
 205++A5DA              ;   fcb   ⠭: fcbClsFile, fcbOffset
 206++A5DA              ;:  ix -  fcb
 207++A5DA              ;     hl -   ⥭
 208++A5DA              ;     bc - ⢮   ⥭
 209++A5DA              ;: cy=1 뫨 訡
 210++A5DA              ;       a=errRWnum
 211++A5DA              ;       a=errInvalidPart
 212++A5DA              ;       a=errEoF - 䠩 ࢠ
 213++A5DA              ;       a=errFileEmpty
 214++A5DA              ;     cy=0  ⠭
 215++A5DA              ;       hl ᫥騩   ⥭
 216++A5DA              ;
 217++A5DA              ;ReadDataFromFile
 218++A5DA              ;
 219++A5DA E5           	push	hl
 220++A5DB C5           	push	bc
 221++A5DC
 222++A5DC              ; ᬥ饭  ᥪ
 223++A5DC              ;	call	LD_DEHL_fcbOffset	;dehl 㪠⥫  䠩
 224++A5DC 2E 00        	ld	l,#00
 225++A5DE CD A6 AC     	call	add2OffsetEOF_L		;dehl 㪠⥫  䠩
 226++A5E1 3E 71        	ld	a,errEoF
 227++A5E3 38 35        	jr	c,goto187		; । 䠩
 228++A5E5 AF           loop033	xor	a
 229++A5E6 CB 3A        	srl	d
 230++A5E8 20 2E        	jr	nz,goto082
 231++A5EA CB 1B        	rr	e
 232++A5EC CB 1C        	rr	h
 233++A5EE 17           	rla
 234++A5EF 47           	ld	b,a
 235++A5F0 4D           	ld	c,l
 236++A5F1 53           	ld	d,e
 237++A5F2 5C           	ld	e,h
 238++A5F3              ;	or	l
 239++A5F3              ;	jr	z,goto083
 240++A5F3              ;	inc	de
 241++A5F3              ;	ld	a,e
 242++A5F3              ;	or	d
 243++A5F3              ;	jr	z,goto082
 244++A5F3 21 00 02     goto083	ld	hl,#0200
 245++A5F6 ED 42        	sbc	hl,bc
 246++A5F8              ;hl ᪮쪮    ᥪ  
 247++A5F8              ;de ᬥ饭  砫 䠩  ᥪ (512b)
 248++A5F8              ;bc ᬥ饭  ᥪ
 249++A5F8
 250++A5F8
 251++A5F8              ;। 㦭 㦠 楫 ᥪ  ⮫쪮  
 252++A5F8 EB           	ex	de,hl
 253++A5F9 E3           	ex	(sp),hl
 254++A5FA B7           	or	a
 255++A5FB ED 52        	sbc	hl,de
 256++A5FD 19           	add	hl,de
 257++A5FE 30 02        	jr	nc,goto084
 258++A600 54           	ld	d,h
 259++A601 5D           	ld	e,l
 260++A602 F1           goto084	pop	af
 261++A603 E3           	ex	(sp),hl
 262++A604 F5           	push	af
 263++A605 E3           	ex	(sp),hl
 264++A606 EB           	ex	de,hl
 265++A607 7D           	ld	a,l
 266++A608 B7           	or	a
 267++A609 20 13        	jr	nz,goto085		;⠥  ᥪ
 268++A60B 7C           	ld	a,h
 269++A60C FE 02        	cp	#02
 270++A60E 20 0E        	jr	nz,goto085		;⠥  ᥪ
 271++A610              ;hl ᪮쪮  㦭   ᥪ
 272++A610              ;de ᬥ饭  砫 䠩  ᥪ (512b)
 273++A610              ;bc ᬥ饭  ᥪ
 274++A610
 275++A610
 276++A610              ;⠥ ᥪ 楫
 277++A610 E1           	pop	hl
 278++A611 CD 60 A6     	call	tmRdSecHDD_hl
 279++A614 30 1F        	jr	nc,goto086
 280++A616
 281++A616              ;訡 ⥭
 282++A616 C1           goto087	pop	bc
 283++A617 C9           	ret
 284++A618 3E 11        goto082	ld	a,errNumTooBig
 285++A61A C1           goto187	pop	bc
 286++A61B E1           	pop	hl
 287++A61C 37           	scf
 288++A61D C9           	ret
 289++A61E
 290++A61E
 291++A61E              ;⠥  ᥪ
 292++A61E E5           goto085	push	hl
 293++A61F C5           	push	bc
 294++A620 21 30 8D     	ld	hl,Buf4File
 295++A623 E5           	push	hl
 296++A624 CD 60 A6     	call	RdSecHDD_hl
 297++A627 E1           	pop	hl
 298++A628 C1           	pop	bc
 299++A629 F5           	push	af
 300++A62A 09           	add	hl,bc
 301++A62B F1           	pop	af
 302++A62C C1           	pop	bc
 303++A62D D1           	pop	de
 304++A62E 38 E6        	jr	c,goto087
 305++A630              	IFDEF	forProfROM
 306++A630 ~            	 bit	5,(iy+#0B)
 307++A630 ~            	 jr	z,goto088		;맮  
 308++A630 ~            	 ex	de,hl
 309++A630 ~            	 call	Rom7.CheckAdrMem	;।   ⥭  ⥬ 
 310++A630 ~            	 ex	de,hl
 311++A630 ~            	 jr	nc,goto088
 312++A630 ~            	 push	bc
 313++A630 ~            	 rst	#30
 314++A630 ~            	 dw	Rom2.copyRam8ToUserRam	;⠭    ram 8
 315++A630 ~            	 db	#02
 316++A630 ~            	 pop	bc
 317++A630 ~            	 ex	de,hl
 318++A630 ~            	 jr	goto086
 319++A630              	ENDIF
 320++A630              	IFDEF	forRRL
 321++A630 ~            	 bit	5,(iy+P0Bh)
 322++A630 ~            	 jr	z,goto088		;맮  
 323++A630 ~            	 ex	de,hl
 324++A630 ~            	 call	r8d.CheckAdrMem		;।   ⥭  ⥬ 
 325++A630 ~            	 ex	de,hl
 326++A630 ~            	 jr	nc,goto088
 327++A630 ~            	 push	bc
 328++A630 ~            	 call	Rom2.copyRam8ToUserRam	;⠭    ram 8
 329++A630 ~            	 pop	bc
 330++A630 ~            	 ex	de,hl
 331++A630 ~            	 jr	goto086
 332++A630              	ENDIF
 333++A630
 334++A630 C5           goto088	push	bc
 335++A631 ED B0        	ldir
 336++A633 C1           	pop	bc			;bc ⢮ ⠭   ᥪ
 337++A634 EB           	ex	de,hl			;hl ᫥騩   ⥭
 338++A635
 339++A635
 340++A635              ;᫥騩 ᥪ
 341++A635              ;(sp) bc - ⠢襥 ⢮   ⥭
 342++A635              ;hl ᫥騩   ⥭
 343++A635              ;bc ⢮ ⠭ 
 344++A635 E3           goto086	ex	(sp),hl
 345++A636 B7           	or	a
 346++A637 ED 42        	sbc	hl,bc
 347++A639 E5           	push	hl
 348++A63A F5           	push	af
 349++A63B 60           	ld	h,b
 350++A63C 69           	ld	l,c
 351++A63D CD A8 AC     	call	add2OffsetEOF_HL	;cy=1 㪠⥫   । 䠩 -> ⠭  砫
 352++A640 C1           	pop	bc
 353++A641 38 04        	jr	c,goto186		; 䠩
 354++A643 C5           	push	bc
 355++A644 F1           	pop	af
 356++A645 20 9E        	jr	nz,loop033
 357++A647 E1           goto186	pop	hl
 358++A648
 359++A648
 360++A648              ;室
 361++A648 E1           	pop	hl
 362++A649 B7           	or	a
 363++A64A C9           	ret
 364++A64B
 365++A64B              	endif
 366++A64B
 367++A64B              ;------------------------------------------------------------------------------
 368++A64B              tmWrSecHDD_hl	ifused
 369++A64B              ;ﬠ  ᥪ      hl ( ⥭ )
 370++A64B              ;      ⥬ , 襬 १ 
 371++A64B              ;:  ix -  fcb
 372++A64B              ;     hl -   
 373++A64B              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 374++A64B              ;: cy=1 뫨 訡
 375++A64B              ;       a=errRWnum
 376++A64B              ;       a=errInvalidPart
 377++A64B              ;       a=errEoF - 䠩 ࢠ
 378++A64B              ;       a=errFileEmpty
 379++A64B              ;     cy=0, nz - ᠫ   
 380++A64B              ;     cy=0, z - ४뢠  , ⮬ ᠫ  
 381++A64B              ;       hl - ᫥騩   
 382++A64B              ;       bc=#0200 ⢮ ᠭ 
 383++A64B              ;     de,bc,a - ???
 384++A64B              ;
 385++A64B              ;tmWrSecHDD_hl
 386++A64B              ;
 387++A64B              	IFDEF	forProfROM
 388++A64B ~            	 bit	5,(iy+#0B)
 389++A64B ~            	 jr	z,WrSecHDD_hl		;맮  
 390++A64B ~            	 ld	bc,#0200		;ࠧ ᥪ
 391++A64B ~            	 call	Rom7.CheckAdrMem	;।   ⥭  ⥬ 
 392++A64B ~            	 jr	nc,WrSecHDD_hl		;஢  
 393++A64B ~            	 push	bc
 394++A64B ~            	 push	de
 395++A64B ~            	 ld	de,Buf4File
 396++A64B ~            	 push	de
 397++A64B ~            	 rst	#30
 398++A64B ~            	 dw	Rom2.copyUserRamToRam8	;஢   
 399++A64B ~            	 db	#02
 400++A64B ~            	 pop	de
 401++A64B ~            	 ex	(sp),hl
 402++A64B ~            	 ex	de,hl
 403++A64B ~            	 call	WrSecHDD_hl		; ᥪ
 404++A64B ~            	 pop	hl
 405++A64B ~            	 pop	bc
 406++A64B ~            	 ret
 407++A64B              	ENDIF
 408++A64B              	IFDEF	forRRL
 409++A64B ~            	 bit	5,(iy+P0Bh)
 410++A64B ~            	 jr	z,WrSecHDD_hl		;맮  
 411++A64B ~            	 ld	bc,#0200		;ࠧ ᥪ
 412++A64B ~            	 call	r8d.CheckAdrMem		;।   ⥭  ⥬ 
 413++A64B ~            	 jr	nc,WrSecHDD_hl		;஢  
 414++A64B ~            	 push	bc
 415++A64B ~            	 push	de
 416++A64B ~            	 ld	de,Buf4File
 417++A64B ~            	 push	de
 418++A64B ~            	 call	Rom2.copyUserRamToRam8	;஢   
 419++A64B ~            	 pop	de
 420++A64B ~            	 ex	(sp),hl
 421++A64B ~            	 ex	de,hl
 422++A64B ~            	 call	WrSecHDD_hl		; ᥪ
 423++A64B ~            	 pop	hl
 424++A64B ~            	 pop	bc
 425++A64B ~            	 ret
 426++A64B              	ENDIF
 427++A64B 18 FE        	jr	WrSecHDD_hl
 428++A64D              	org	$-2
 429++A64B
 430++A64B              	endif
 431++A64B
 432++A64B              ;------------------------------------------------------------------------------
 433++A64B              WrSecHDD_hl	ifused
 434++A64B              ;ﬠ  ᥪ      hl
 435++A64B              ;:  ix -  fcb
 436++A64B              ;     hl -   
 437++A64B              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 438++A64B              ;: cy=1 뫨 訡
 439++A64B              ;       a=errRWnum
 440++A64B              ;       a=errInvalidPart
 441++A64B              ;       a=errEoF - 䠩 ࢠ
 442++A64B              ;       a=errFileEmpty
 443++A64B              ;     cy=0 - ᥪ ᠭ
 444++A64B              ;       hl - ᫥騩   
 445++A64B              ;       bc=#0200 ⢮ ᠭ 
 446++A64B              ;     de,a - ???
 447++A64B              ;
 448++A64B              ;WrSecHDD_hl
 449++A64B              ;
 450++A64B DD E5        	push	ix
 451++A64D E3           	ex	(sp),hl
 452++A64E 01 0C 00     	ld	bc,fcbClsFile
 453++A651 09           	add	hl,bc		;  ஬ ࢮ  䠩
 454++A652 CD 18 AB     	call	CalcAdrSecInFile;dehl - LBA  ᥪ
 455++A655              ;	jr	c,goto105	;訡
 456++A655 38 25        	jr	c,goto081	;訡
 457++A657              	hddSetCurrSec		;  ⠭  ६  LBA/CHS  ᨬ  ஥
 457++A657 CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 458++A65A E1           	pop	hl
 459++A65B              	hddWriteSecHL		; ᥪ    
 459++A65B CD 37 9B    >	call	DrvHDD.WrSecHDD_HL
 460++A65E 18 13        	jr	goto185
 461++A660              ;	ld	a,errRWnum
 462++A660              ;	ret	c		;訡 ⥭ 
 463++A660              ;	ld	bc,#0200
 464++A660              ;	add	hl,bc
 465++A660              ;	or	a
 466++A660              ;	ret
 467++A660              ;goto105	pop	hl
 468++A660              ;	ret
 469++A660
 470++A660              	endif
 471++A660
 472++A660              ;------------------------------------------------------------------------------
 473++A660              tmRdSecHDD_hl	ifused
 474++A660              ;אַ ⥭ ᥪ      hl ( ⥭ )
 475++A660              ;      ⥬ , ⠥ १ 
 476++A660              ;:  ix -  fcb
 477++A660              ;     hl -   ⥭
 478++A660              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 479++A660              ;: cy=1 뫨 訡
 480++A660              ;       a=errRWnum
 481++A660              ;       a=errInvalidPart
 482++A660              ;       a=errEoF - 䠩 ࢠ
 483++A660              ;       a=errFileEmpty
 484++A660              ;     cy=0, nz - ⠫   
 485++A660              ;     cy=0, z - ⠫  , ⮬ ४뢠   짮⥫
 486++A660              ;       hl - ᫥騩   
 487++A660              ;       bc=#0200 ⢮ ⠭ 
 488++A660              ;     de,bc,a - ???
 489++A660              ;
 490++A660              ;tmRdSecHDD_hl
 491++A660              ;
 492++A660              	IFDEF	forProfROM
 493++A660 ~            	 bit	5,(iy+#0B)
 494++A660 ~            	 jr	z,RdSecHDD_hl		;맮  
 495++A660 ~            	 ld	bc,#0200		;ࠧ ᥪ
 496++A660 ~            	 call	Rom7.CheckAdrMem	;।   ⥭  ⥬ 
 497++A660 ~            	 jr	nc,RdSecHDD_hl		;஢  
 498++A660 ~            	 push	hl
 499++A660 ~            	 ld	hl,Buf4File
 500++A660 ~            	 call	RdSecHDD_hl
 501++A660 ~            	 pop	de
 502++A660 ~            	 ret	c			;뫨 訡 ⥭
 503++A660 ~            	 ld	hl,Buf4File
 504++A660 ~            	 push	bc
 505++A660 ~            	 rst	#30
 506++A660 ~            	 dw	Rom2.copyRam8ToUserRam	;⠭    ram 8
 507++A660 ~            	 db	#02
 508++A660 ~            	 pop	bc
 509++A660 ~            	 ex	de,hl
 510++A660 ~            	 xor	a
 511++A660 ~            	 ret
 512++A660              	ENDIF
 513++A660              	IFDEF	forRRL
 514++A660 ~            	 bit	5,(iy+P0Bh)
 515++A660 ~            	 jr	z,RdSecHDD_hl		;맮  
 516++A660 ~            	 ld	bc,#0200		;ࠧ ᥪ
 517++A660 ~            	 call	r8d.CheckAdrMem		;।   ⥭  ⥬ 
 518++A660 ~            	 jr	nc,RdSecHDD_hl		;஢  
 519++A660 ~            	 push	hl
 520++A660 ~            	 ld	hl,Buf4File
 521++A660 ~            	 call	RdSecHDD_hl
 522++A660 ~            	 pop	de
 523++A660 ~            	 ret	c			;뫨 訡 ⥭
 524++A660 ~            	 ld	hl,Buf4File
 525++A660 ~            	 push	bc
 526++A660 ~            	 call	Rom2.copyRam8ToUserRam	;⠭    ram 8
 527++A660 ~            	 pop	bc
 528++A660 ~            	 ex	de,hl
 529++A660 ~            	 xor	a
 530++A660 ~            	 ret
 531++A660              	ENDIF
 532++A660 18 FE        	jr	RdSecHDD_hl
 533++A662              	org	$-2
 534++A660
 535++A660              	endif
 536++A660
 537++A660              ;------------------------------------------------------------------------------
 538++A660              RdSecHDD_hl	ifused
 539++A660              ;אַ ⥭ ᥪ      hl
 540++A660              ;:  ix -  fcb
 541++A660              ;     hl -   ⥭
 542++A660              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 543++A660              ;: cy=1 뫨 訡
 544++A660              ;       a=errRWnum
 545++A660              ;       a=errInvalidPart
 546++A660              ;       a=errEoF - 䠩 ࢠ
 547++A660              ;       a=errFileEmpty
 548++A660              ;     cy=0 - ᥪ ⠭
 549++A660              ;       hl - ᫥騩   
 550++A660              ;       bc=#0200 ⢮ ⠭ 
 551++A660              ;     de,a - ???
 552++A660              ;
 553++A660              ;RdSecHDD_hl
 554++A660              ;
 555++A660 DD E5        	push	ix
 556++A662 E3           	ex	(sp),hl
 557++A663 01 0C 00     	ld	bc,fcbClsFile
 558++A666 09           	add	hl,bc		;  ஬ ࢮ  䠩
 559++A667 CD 18 AB     	call	CalcAdrSecInFile;dehl - LBA  ᥪ
 560++A66A 38 10        	jr	c,goto081	;訡
 561++A66C              	hddSetCurrSec		;  ⠭  ६  LBA/CHS  ᨬ  ஥
 561++A66C CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 562++A66F E1           	pop	hl
 563++A670              	hddReadSec2HL		;⥭ ᥪ    
 563++A670 CD 0B 9B    >	call	DrvHDD.RdSecHDD_HL
 564++A673 3E 50        goto185	ld	a,errRWnum
 565++A675 D8           	ret	c		;訡 ⥭ 
 566++A676 01 00 02     	ld	bc,#0200
 567++A679 09           	add	hl,bc
 568++A67A B7           	or	a
 569++A67B C9           	ret
 570++A67C E1           goto081	pop	hl
 571++A67D C9           	ret
 572++A67E
 573++A67E              	endif
 574++A67E
 575++A67E              ;==============================================================================
 576++A67E
# file closed: Drivers/DrvFAT/DrvFAT.rst.a80
 130+ A67E              	INCLUDE	"DrvFAT.format.a80"
# file opened: Drivers/DrvFAT/DrvFAT.format.a80
   1++A67E              ;楤  FAT Driver. ᮧ  ଠ஢ ࠧ
   2++A67E              ;䠩 DrvFAT.format.a80
   3++A67E              ;
   4++A67E              ;fatFormatPart		ଠ஢ ࠧ FAT
   5++A67E              ;
   6++A67E              ;------------------------------------------------------------------------------
   7++A67E              fatFormatPart	ifused
   8++A67E ~            ;ଠ஢ ࠧ FAT
   9++A67E ~            ;:  a - ࠧ  (=#01/#02/#04/#08/#10/#20/#40/#80)
  10++A67E ~            ;         =#00 ⮬᪨  室  ꥬ ࠧ
  11++A67E ~            ;     hl -  ਯ ࠧ (    xEBF5)
  12++A67E ~            ;: cy=1 뫨 訡
  13++A67E ~            ;       a=errHddNotFound
  14++A67E ~            ;       a=errHddRWerror
  15++A67E ~            ;       a=errHddBusy
  16++A67E ~            ;       a=errHddNotReady
  17++A67E ~            ;       a=errHddNotData
  18++A67E ~            ;
  19++A67E ~            ;fatFormatPart
  20++A67E ~            ;
  21++A67E ~            	call	DeinitFATpart
  22++A67E ~
  23++A67E ~            ;ନ㥬 boot sector
  24++A67E ~            	push	af
  25++A67E ~            	push	hl
  26++A67E ~            	ld	hl,BootSecFAT32
  27++A67E ~            	ld	de,Buf4Format
  28++A67E ~            	ld	bc,#005A
  29++A67E ~            	ldir
  30++A67E ~            	ld	h,d
  31++A67E ~            	ld	l,e
  32++A67E ~            	inc	de
  33++A67E ~            	ld	(hl),b
  34++A67E ~            	ld	bc,#05A3
  35++A67E ~            	ldir
  36++A67E ~            	ld	hl,#AA55
  37++A67E ~            	ld	(Buf4Format+#1FE),hl
  38++A67E ~            	pop	hl
  39++A67E ~            ;   砫 ࠧ
  40++A67E ~            	ld	c,#04
  41++A67E ~            	add	hl,bc
  42++A67E ~            	add	hl,bc
  43++A67E ~            	ld	de,tmpDWORD
  44++A67E ~            	ldir
  45++A67E ~            ;  ᥪ஢  ࠧ
  46++A67E ~            	ld	de,Buf4Format+#20
  47++A67E ~            	ld	c,#04
  48++A67E ~            	ldir
  49++A67E ~            ;  ᥪ஢  
  50++A67E ~            	pop	af
  51++A67E ~            	ld	bc,(Buf4Format+#20+2)
  52++A67E ~            	or	a
  53++A67E ~            	jr	nz,goto140
  54++A67E ~            	ld	hl,TablCLS
  55++A67E ~            	ld	a,#80
  56++A67E ~            loop053	rrca
  57++A67E ~            	ld	e,(hl)
  58++A67E ~            	inc	hl
  59++A67E ~            	ld	d,(hl)
  60++A67E ~            	inc	hl
  61++A67E ~            	ex	de,hl
  62++A67E ~            	sbc	hl,bc
  63++A67E ~            	ex	de,hl
  64++A67E ~            	jr	nc,loop053
  65++A67E ~            goto140	ld	(Buf4Format+#0D),a	;ᥪ஢  
  66++A67E ~            ;  ࠧ FAT  ᥪ
  67++A67E ~            ;  (((ᥪ஢  ࠧ-१ࢨ஢)/ᥪ஢  +1)/(512/4))+1
  68++A67E ~            	ld	d,b
  69++A67E ~            	ld	e,c
  70++A67E ~            	ld	hl,(Buf4Format+#20)	;dehl - ࠧ ࠧ  ᥪ
  71++A67E ~            	ld	bc,(Buf4Format+#0E)	;bc - १ࢨ஢ ᥪ஢
  72++A67E ~            	or	a
  73++A67E ~            	sbc	hl,bc
  74++A67E ~            	jr	nc,goto141
  75++A67E ~            	dec	de
  76++A67E ~            goto141	call	SRL_dehl_A		;dehl=dehl/a
  77++A67E ~            	call	Inc_DEHL		;dehl+1
  78++A67E ~            	ld	a,#80
  79++A67E ~            	call	SRL_dehl_A		;dehl=dehl/#80
  80++A67E ~            	call	Inc_DEHL		;dehl+1 (ࠧ FAT ⠡)
  81++A67E ~            	ld	(Buf4Format+#24),hl	;ࠧ FAT ⠡
  82++A67E ~            	ld	(Buf4Format+#24+2),de
  83++A67E ~            ;  ନ㥬 ᥪ FS-Info
  84++A67E ~            	ld	hl,FSinfoSecFAT32
  85++A67E ~            	ld	de,Buf4Format+#200
  86++A67E ~            	ld	bc,#0004
  87++A67E ~            	ldir
  88++A67E ~            	ld	de,Buf4Format+#200+#1E4
  89++A67E ~            	ld	c,#0C
  90++A67E ~            	ldir
  91++A67E ~            	ld	hl,#AA55
  92++A67E ~            	ld	(Buf4Format+#3FE),hl
  93++A67E ~            ;  襬  ᥪ஢ ( ࠧ  )
  94++A67E ~            	ld	hl,tmpDWORD
  95++A67E ~            	call	LD_DEHL_adrHL		; 砫 ࠧ
  96++A67E ~            	call	proc_12
  97++A67E ~            	call	nc,proc_12
  98++A67E ~            	ret	c			;訡 
  99++A67E ~
 100++A67E ~            ;㫨 ⠢訥 १ࢨ஢ ᥪ,   FAT, ୥ ⠫
 101++A67E ~            	push	de
 102++A67E ~            	push	hl
 103++A67E ~            	exx
 104++A67E ~            	ld	bc,#20-#06-#06		;⠢襥  १ࢨ஢
 105++A67E ~            	ld	a,(Buf4Format+#0D)	;ᥪ஢  
 106++A67E ~            	add	a,c
 107++A67E ~            	ld	c,a
 108++A67E ~            	ld	hl,(Buf4Format+#24)	;ࠧ FAT ⠡
 109++A67E ~            	ld	de,(Buf4Format+#24+2)
 110++A67E ~            	add	hl,hl
 111++A67E ~            	ex	de,hl
 112++A67E ~            	adc	hl,hl
 113++A67E ~            	ex	de,hl			;ࠧ FAT ⠡ *2
 114++A67E ~            	add	hl,bc
 115++A67E ~            	jr	nc,loop054
 116++A67E ~            	inc	de			;dehl ⢮ ᥪ஢  㫥
 117++A67E ~            loop054	push	hl
 118++A67E ~            	push	de
 119++A67E ~            	exx
 120++A67E ~            	call	proc_13
 121++A67E ~            	dw	Buf4Format+#400
 122++A67E ~            	exx
 123++A67E ~            	pop	de
 124++A67E ~            	pop	hl
 125++A67E ~            	jr	c,goto143
 126++A67E ~            	call	Dec_DEHL
 127++A67E ~            	ld	a,d
 128++A67E ~            	or	e
 129++A67E ~            	or	h
 130++A67E ~            	or	l
 131++A67E ~            	jr	nz,loop054
 132++A67E ~
 133++A67E ~            ;ய襬  ⠡ FAT  
 134++A67E ~            	ld	b,#0A
 135++A67E ~            	ld	hl,Buf4Format+#400
 136++A67E ~            	ld	(hl),#F8
 137++A67E ~            	inc	hl
 138++A67E ~            loop055	ld	(hl),#FF
 139++A67E ~            	inc	hl
 140++A67E ~            	djnz	loop055
 141++A67E ~            	ld	a,#0F
 142++A67E ~            	ld	(hl),a
 143++A67E ~            	ld	(Buf4Format+#400+#03),a
 144++A67E ~            	pop	hl
 145++A67E ~            	pop	de
 146++A67E ~            	ld	bc,#20-#06-#06		;⠢襥  १ࢨ஢
 147++A67E ~            	add	hl,bc
 148++A67E ~            	jr	nc,goto142
 149++A67E ~            	inc	de
 150++A67E ~            goto142	ld	c,#01
 151++A67E ~            	call	proc_13
 152++A67E ~            	dw	Buf4Format+#400
 153++A67E ~            	ret	c
 154++A67E ~            	ld	bc,Buf4Format+#24
 155++A67E ~            	call	Add_DEHL_adrBC
 156++A67E ~            	call	Dec_DEHL
 157++A67E ~            	ld	bc,#0001
 158++A67E ~            	call	proc_13
 159++A67E ~            	dw	Buf4Format+#400
 160++A67E ~            	ret
 161++A67E ~
 162++A67E ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 163++A67E ~            ;  ᥪ஢: boot, FSinfo, 4 
 164++A67E ~            ;:  dehl - LBA  ࢮ ᥪ
 165++A67E ~            ;: cy=1 訡 
 166++A67E ~            ;     cy=0  ᠭ ᯥ譮
 167++A67E ~            ;     dehl=dehl+#06
 168++A67E ~            ;     bc=#0001
 169++A67E ~            ;
 170++A67E ~            proc_12	ld	bc,#0003
 171++A67E ~            	call	proc_13
 172++A67E ~            	dw	Buf4Format
 173++A67E ~            	ret	c
 174++A67E ~            	ld	bc,#0301
 175++A67E ~            loop056	push	bc
 176++A67E ~            	ld	b,#00
 177++A67E ~            	call	proc_13
 178++A67E ~            	dw	Buf4Format+#400
 179++A67E ~            	pop	bc
 180++A67E ~            	ret	c
 181++A67E ~            	djnz	loop056
 182++A67E ~            	ret
 183++A67E ~
 184++A67E ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 185++A67E ~            ; 㯯 ᥪ஢
 186++A67E ~            ;:  dehl - LBA  ࢮ ᥪ
 187++A67E ~            ;     bc - ⢮ ᥪ஢  
 188++A67E ~            ;     dw #nnnn -  , 㤠 襬
 189++A67E ~            ;: cy=1 訡 
 190++A67E ~            ;     cy=0  ᠭ ᯥ譮
 191++A67E ~            ;     dehl=dehl+bc
 192++A67E ~            ;     bc -  
 193++A67E ~            ;
 194++A67E ~            proc_13	ex	(sp),hl
 195++A67E ~            	push	de
 196++A67E ~            	pop	af
 197++A67E ~            	ld	e,(hl)
 198++A67E ~            	inc	hl
 199++A67E ~            	ld	d,(hl)
 200++A67E ~            	inc	hl
 201++A67E ~            	ex	(sp),hl
 202++A67E ~            	push	hl
 203++A67E ~            	push	af
 204++A67E ~            	push	bc
 205++A67E ~            	push	bc
 206++A67E ~            	push	de
 207++A67E ~            	push	af
 208++A67E ~            	pop	de
 209++A67E ~            	hddSetCurrSec
 210++A67E ~            	pop	hl
 211++A67E ~            	pop	bc
 212++A67E ~            	ld	b,c
 213++A67E ~            	scf
 214++A67E ~            	DirectRdWrSectors
 215++A67E ~            	pop	bc
 216++A67E ~            goto143	pop	de
 217++A67E ~            	pop	hl
 218++A67E ~            	ret	c
 219++A67E ~            	add	hl,bc
 220++A67E ~            	ret	nc
 221++A67E ~            	inc	de
 222++A67E ~            	or	a
 223++A67E ~            	ret
 224++A67E ~
 225++A67E              	endif
 226++A67E
 227++A67E              ;==============================================================================
 228++A67E              ;蠡  boot sector FAT32
 229++A67E              BootSecFAT32	ifused
 230++A67E ~            ;
 231++A67E ~             db #EB,#3C,#90		;+#00..#02 Jump code
 232++A67E ~             db "MSDOS5.0"		;+#03..#0A OEM Name
 233++A67E ~             dw #200		;+#0B Bytes per sector
 234++A67E ~             db #00;?		;+#0D sectors_per_cluster
 235++A67E ~             dw #0020		;+#0E १ࢨ஢ ᥪ஢
 236++A67E ~             db #02			;+#10 ⢮  FAT
 237++A67E ~             dw #0000		;+#11 ⢮ ᥩ  ୥ ⠫ =0  FAT32
 238++A67E ~             dw #0000;?		;+#13 Total sectors (use FAT32 count instead)
 239++A67E ~             db #F8			;+#15 Media type
 240++A67E ~             dw #0000		;+#16 Count of sectors used by the FAT table (FAT16 only)
 241++A67E ~             dw #003F		;+#18 Sectors per track (default)
 242++A67E ~             dw #00FF		;+#1A Heads (default)
 243++A67E ~             dd #00000000		;+#1C Hidden sectors
 244++A67E ~             dd #00000000;?		;+#20 Total sectors for this volume
 245++A67E ~             dd #00000000;?		;+#24 BPB_FATSz32 (ࠧ FAT  ᥪ)
 246++A67E ~             dw #0000		;+#28 BPB_ExtFlags
 247++A67E ~             dw #0000		;+#2A BPB_FSVer
 248++A67E ~             dd #00000002		;+#2C BPB_RootClus
 249++A67E ~             dw #0001		;+#30 BPB_FSInfo
 250++A67E ~             dw #0006		;+#32 BPB_BkBootSec
 251++A67E ~             ds #0C,#00		;+#34..#3F free
 252++A67E ~             db #00			;+#40 Drive number
 253++A67E ~             db #00			;+#41 free
 254++A67E ~             db #29			;+#42 Boot signature
 255++A67E ~             db #12,#34,#56,#78	;+#43..#46 Volume ID
 256++A67E ~             db "ZS-Scorpion"	;+#47..#51 Volume name
 257++A67E ~             db "FAT32   "		;+#52..59 File sys type
 258++A67E ~            ; ds #1A4,#00		;+#5A..#1FD free
 259++A67E ~            ; db #55,#AA		;+#1FE Signature
 260++A67E              	endif
 261++A67E
 262++A67E              ;蠡  fsinfo ᥪ
 263++A67E              FSinfoSecFAT32	ifused
 264++A67E ~            ;
 265++A67E ~             db "RRaA"		;+#00..#03 ᨣ
 266++A67E ~             db "rrAa"		;+#1E4..#1E7 ᨣ
 267++A67E ~             db #FF,#FF,#FF,#FF	;+#1E8..#1EB Free Count
 268++A67E ~             db #FF,#FF,#FF,#FF	;+#1EC..#1EF Next Free
 269++A67E              	endif
 270++A67E
 271++A67E              ;⠡   ⢠ ᥪ஢  
 272++A67E              ;
 273++A67E              TablCLS	ifused
 274++A67E ~            	dw #03FF
 275++A67E ~            	dw #01FF
 276++A67E ~            	dw #00FF
 277++A67E ~            	dw #0007
 278++A67E ~            	dw #0003
 279++A67E ~            	dw #0001
 280++A67E ~            	dw #0000
 281++A67E              	endif
 282++A67E              ;==============================================================================
 283++A67E
# file closed: Drivers/DrvFAT/DrvFAT.format.a80
 131+ A67E              	INCLUDE	"DrvFAT.dir.a80"
# file opened: Drivers/DrvFAT/DrvFAT.dir.a80
   1++A67E              ;楤  FAT Driver. ࠡ  ⠫
   2++A67E              ;䠩 DrvFAT.dir.a80
   3++A67E              ;
   4++A67E              ;fatRenMoveEntry	२/७   㣮 ⠫ 
   5++A67E              ;			।  ࠧ FAT
   6++A67E              ;fatWriteEntry		ᮧ   ⠫ (⮫쪮 )
   7++A67E              ;FindPathFile		 䠩     ⥪饬 ⠫ 
   8++A67E              ;			室  ⠫  ஢મ ᨭ⠪
   9++A67E              ;SetPathFile		 䠩     ⥪饬 ⠫ 
  10++A67E              ;			室  ⠫  ஢મ ᨭ⠪
  11++A67E              ;			 ⠭  ⠫ ⥪騬
  12++A67E              ;Enter2DIR		室  ४
  13++A67E              ;SetDirCurrent		⠭ ४ਨ ⥪饩
  14++A67E              ;fatEraseEntry		㤠   ⥪饬 ⠫ (䠩/⮣ ⠫)
  15++A67E              ;fatMarkDelEntry	⪠  䠩  ⠫   ﬨ
  16++A67E              ;			  㤠묨
  17++A67E              ;fatGetEntryLBA		  ⥪饬 ⠫ ਯ   LBA 
  18++A67E              ;fatGetEntryLong	  ⥪饬 ⠫ ਯ   
  19++A67E              ;fatGetEntry		  ⥪饬 ⠫ ਯ   
  20++A67E              ;fatTestEmptyDir	஢ઠ ⥪飮 ⠫ ⮩  
  21++A67E              ;SortFoundedEntries	஢ ᯨ᪠  ਯ஢
  22++A67E              ;			(䠩/⠫)
  23++A67E              ;GetNumOfEntries	 ⢠ ⨬ ( 256) ᥩ 
  24++A67E              ;			⥪饬 ⠫
  25++A67E              ;fatCreateDIR		ᮧ ⠫  ⥪饬 FAT32 ⠫
  26++A67E              ;fatCreateDIRlfn	ᮧ ⠫     ⥪饬 FAT32 ⠫
  27++A67E              ;fatFindEntryDir	   ⥪饬 ⠫    ଠ
  28++A67E              ;			name[.][ext]\
  29++A67E              ;CP_TwoDot		஢ઠ  䠩   窨 (뫪  த⥫)
  30++A67E              ;CP_OneDot		஢ઠ  䠩    (뫪  ᥡ)
  31++A67E              ;ReadSectorDIR		⥭ ᥪ ⠫     
  32++A67E              ;fatSetTmpDir		⠭ ६ ⥪饩 ४ਨ
  33++A67E              ;
  34++A67E              ;------------------------------------------------------------------------------
  35++A67E              fatRenMoveEntry	ifused
  36++A67E ~            ;२/७   ⥪饣 ⠫  㣮 ⠫
  37++A67E ~            ;   ।  ࠧ
  38++A67E ~            ;     ஢७   SFN ॢ  孨 ॣ
  39++A67E ~            ;  䠩/⠫  ⢮
  40++A67E ~            ;   fcb   ⠭: fcbName, fcbExt, fcbAttr, fcbClsFile,
  41++A67E ~            ;    fcbClsDIR, bit3 fcbType=0/1 SFN/LFN
  42++A67E ~            ;:  ix -   fcb
  43++A67E ~            ;     fcbName, fcbExt - ஥   ७
  44++A67E ~            ;     hl -  ப     ଠ ASCIIZ
  45++A67E ~            ;     hl -     ଠ name[.][ext]\ (  ଠ 8+3)
  46++A67E ~            ;     de -  ६   ஬ ⠫-ਥ, ᫨ ࠢ
  47++A67E ~            ;        fcbClsDIR   २
  48++A67E ~            ;: cy=1 訡 ⥭/,   
  49++A67E ~            ;       a=errRWnum
  50++A67E ~            ;       a=errInvalidPart
  51++A67E ~            ;       a=errEoF - 䠩 ࢠ
  52++A67E ~            ;       a=errFileEmpty - ⮩ ୥ ⠫
  53++A67E ~            ;	a=errFileNotFound
  54++A67E ~            ;       a=errInvFileName 䠩  ⠪  /⮥ 
  55++A67E ~            ;       a=errDiskNoSpace
  56++A67E ~            ;     cy=0  ᥭ  ⫮
  57++A67E ~            ;
  58++A67E ~            ;fatRenMoveEntry
  59++A67E ~            ;
  60++A67E ~            ;।    ⠫-筨
  61++A67E ~            	push	hl
  62++A67E ~            	push	de
  63++A67E ~            	push	ix
  64++A67E ~            	pop	hl
  65++A67E ~            	call	fcbFindEntry
  66++A67E ~            	pop	de
  67++A67E ~            	pop	hl
  68++A67E ~            	ret	c			;訡 ⥭/䠩  
  69++A67E ~
  70++A67E ~            ;஢ઠ ⨯  SFN/LFN
  71++A67E ~            	push	bc			;   ⠫-筨
  72++A67E ~            	bit	3,(ix+fcbType)
  73++A67E ~            	jr	nz,goto191		; LFN
  74++A67E ~
  75++A67E ~            ;஢ઠ ⢮ 䠩  ⠫-ਥ ( SFN)
  76++A67E ~            	push	de
  77++A67E ~            ;  ⠭ ⠫-ਥ
  78++A67E ~            	push	hl
  79++A67E ~            	ex	de,hl
  80++A67E ~            	call	excngCLSCurrDir		;⠫-ਥ
  81++A67E ~            	pop	hl
  82++A67E ~            ;  ନ㥬  SFN  fcb    ਥ
  83++A67E ~            	push	hl
  84++A67E ~            	push	ix
  85++A67E ~            	pop	de
  86++A67E ~            	call	FileNameTo8dot3
  87++A67E ~            	pop	hl
  88++A67E ~            ;     ⠫-ਥ
  89++A67E ~            	call	fatFindEntryDir
  90++A67E ~            	pop	hl
  91++A67E ~            	jr	c,goto192		;訡 ⥭
  92++A67E ~            	ld	a,errFileExist
  93++A67E ~            	jr	z,goto192		;nc ⠪ 䠩   ਥ
  94++A67E ~            ;  ⠭ ⠫-筨
  95++A67E ~            	push	hl
  96++A67E ~            	call	excngCLSCurrDir		;⠫-筨
  97++A67E ~            	pop	de
  98++A67E ~            	sbc	hl,hl			;hl=#0000
  99++A67E ~
 100++A67E ~            ;ᮧ   ⠫-ਥ
 101++A67E ~            goto191	call	fatWriteEntry		;ᮧ 
 102++A67E ~            	pop	bc
 103++A67E ~            	ret	c			;訡
 104++A67E ~
 105++A67E ~            ;㤠   ⠫-筨
 106++A67E ~            	ld	a,#FF
 107++A67E ~            	ld	(SecDIRinBuf+#03),a	;  ᥪ ⠫
 108++A67E ~            	jp	fatMarkDelEntry		;㤠   ⪨ 楯窨 ஢
 109++A67E ~
 110++A67E ~            ;訡
 111++A67E ~            goto192	pop	bc
 112++A67E ~            	scf
 113++A67E ~            	jr	proc_17			;⠫-筨 (  / fatWriteEntry)
 114++A67E ~
 115++A67E ~
 116++A67E ~            /* ਠ. ४
 117++A67E ~            ;fatRenMoveEntry
 118++A67E ~            ;
 119++A67E ~            ;⠭ ਧ ⠫
 120++A67E ~            	ld	a,(ix+fcbAttr)
 121++A67E ~            	and	#10
 122++A67E ~            	ld	(ix+fcbType),a
 123++A67E ~
 124++A67E ~            ;஢塞 ⢮ 䠩  ⠫ ਥ/⥪饬
 125++A67E ~            	push	hl
 126++A67E ~            	push	de
 127++A67E ~            	ex	de,hl
 128++A67E ~            	call	excngCLSCurrDir		;⠫-ਥ
 129++A67E ~            	push	ix
 130++A67E ~            	pop	hl
 131++A67E ~            	call	fatFindEntryDir
 132++A67E ~            	jr	c,goto188		;訡 ⥭
 133++A67E ~            	ld	a,errFileExist
 134++A67E ~            	jr	z,goto188		;nc ⠪ 䠩   ਥ
 135++A67E ~            	pop	hl
 136++A67E ~            	push	hl
 137++A67E ~            	call	excngCLSCurrDir		;⠭ ClsDIR 筨
 138++A67E ~
 139++A67E ~            ;稬   室 䠩  ⠫ 筨
 140++A67E ~            	push	ix
 141++A67E ~            	pop	hl
 142++A67E ~            	call	fatFindEntryDir		;bc -    ⠫
 143++A67E ~            	jr	c,goto189		;訡
 144++A67E ~            	ld	a,errFileNotFound
 145++A67E ~            	jr	nz,goto189		;  ⠪  
 146++A67E ~            	call	fatMarkDelEntry		;㤠   ⪨ 楯窨 ஢
 147++A67E ~            	jr	c,goto189		;訡
 148++A67E ~
 149++A67E ~            ;ᮧ   ⠫ ਥ
 150++A67E ~            	pop	de
 151++A67E ~            	pop	hl
 152++A67E ~            	call	fatWriteEntry
 153++A67E ~
 154++A67E ~            ;室  訡
 155++A67E ~            goto188	pop	hl
 156++A67E ~            	push	hl
 157++A67E ~            	call	proc_17			;⠫-ਥ
 158++A67E ~            goto189	pop	hl
 159++A67E ~            	pop	de
 160++A67E ~            	ret
 161++A67E ~            */
 162++A67E              	endif
 163++A67E
 164++A67E              ;------------------------------------------------------------------------------
 165++A67E              fatWriteEntry	ifused
 166++A67E ~            ;ᮧ   ⠫ (⮫쪮 )
 167++A67E ~            ;  䠩/⠫  ⢮
 168++A67E ~            ;   fcb   ⠭: fcbName, fcbExt, fcbAttr, fcbClsFile,
 169++A67E ~            ;    fcbClsDIR, fcbSize
 170++A67E ~            ;:  ix -   fcb
 171++A67E ~            ;     fcbName, fcbExt -    ७  ࠡ  SFN
 172++A67E ~            ;     hl -  ப     ଠ ASCIIZ  (fcbName, fcbExt   ⠭)
 173++A67E ~            ;        =#0000  SFN
 174++A67E ~            ;     de -  ६   ஬ ⠫ ਥ, ᫨ ࠢ
 175++A67E ~            ;        fcbClsDIR   २
 176++A67E ~            ;: cy=1 訡 ⥭/
 177++A67E ~            ;       a=errRWnum
 178++A67E ~            ;       a=errInvalidPart
 179++A67E ~            ;       a=errEoF - 䠩 ࢠ
 180++A67E ~            ;       a=errFileEmpty - ⮩ ୥ ⠫
 181++A67E ~            ;       a=errInvFileName 䠩  ⠪  /⮥ 
 182++A67E ~            ;       a=errDiskNoSpace
 183++A67E ~            ;     cy=0  ᥭ  ⫮
 184++A67E ~            ;     hl,de,bc - ???
 185++A67E ~            ;
 186++A67E ~            ;fatWriteEntry
 187++A67E ~            ;
 188++A67E ~            ;⠭ ਧ ⠫
 189++A67E ~            	ld	a,(ix+fcbAttr)
 190++A67E ~            	and	#10
 191++A67E ~            	ld	(ix+fcbType),a
 192++A67E ~
 193++A67E ~            ;ᮧ   ⠫-ਥ
 194++A67E ~            	push	hl
 195++A67E ~            	push	de
 196++A67E ~            	ex	de,hl
 197++A67E ~            	call	excngCLSCurrDir		;⠫-ਥ
 198++A67E ~            	call	fcbSetCLSCurrDir	;⠭  fcb   ⠫-த⥫
 199++A67E ~            	pop	hl
 200++A67E ~            	ex	(sp),hl
 201++A67E ~            	call	fatAddFileEntry
 202++A67E ~            	jr	c,goto190		;訡
 203++A67E ~
 204++A67E ~            ; ⠫ ⠭ 뫪   த⥫
 205++A67E ~            	bit	4,(ix+fcbType)
 206++A67E ~            	jr	z,goto190		;nc  䠩
 207++A67E ~            ;  ஢ਬ ⠫  稥 ᥩ
 208++A67E ~            	push	ix
 209++A67E ~            	pop	hl
 210++A67E ~            	ld	de,fcbClsFile
 211++A67E ~            	add	hl,de
 212++A67E ~            	push	hl
 213++A67E ~            	call	excngCLSCurrDir
 214++A67E ~            	ld	bc,#0000		;bc=#0000  ⥪饩   ⠫
 215++A67E ~            	call	ReadSectorDIR		;⥭ ᥪ ⠫     
 216++A67E ~            	call	nc,LD_DEHL_fcbClsFile	;᫨  訡
 217++A67E ~            	ld	(Buf4DIR+#20+#14),de	;  .. (뫪  த⥫)
 218++A67E ~            	ld	(Buf4DIR+#20+#1A),hl
 219++A67E ~            	call	nc,SaveSecBuf2DIR	;᫨  訡
 220++A67E ~            	pop	hl
 221++A67E ~            	call	proc_17			;⠭ ClsFile
 222++A67E ~            goto190	pop	hl
 223++A67E ~            proc_17	push	af
 224++A67E ~            	call	excngCLSCurrDir		;⠭ CLSCurrDir
 225++A67E ~            	pop	af
 226++A67E ~            	ret
 227++A67E ~
 228++A67E              	endif
 229++A67E
 230++A67E              ;------------------------------------------------------------------------------
 231++A67E              FindPathFile	ifused
 232++A67E ~            ; 䠩     ⥪饬 ⠫  室  ⠫
 233++A67E ~            ; ஢મ ᨭ⠪
 234++A67E ~            ;:  hl -   䠩,     (⠭  室)
 235++A67E ~            ;: cy=1 訡 ⥭/  ⠫  / ⮩
 236++A67E ~            ;       z  -  ⮩, ⥪騩 ⠫  
 237++A67E ~            ;         a=errPathEmpty
 238++A67E ~            ;       nz - 訡 ⥭/  ⠫  
 239++A67E ~            ;         a=errInvFileName
 240++A67E ~            ;         a=errRWnum
 241++A67E ~            ;         a=errInvalidPart
 242++A67E ~            ;         a=errEoF - 䠩 ࢠ
 243++A67E ~            ;         a=errFileEmpty - ⮩ ୥ ⠫
 244++A67E ~            ;         a=errFileNotFound
 245++A67E ~            ;     cy=0   ⠫ 
 246++A67E ~            ;       z  -> a=#00 -  ⠫
 247++A67E ~            ;       nz -> a=#00 -  䠩,   ᫥  
 248++A67E ~            ;       nz -> a<>#00 -  䠩,   ᫥  
 249++A67E ~            ;       b - ࠡ⠭ 
 250++A67E ~            ;       hl -  砫 ਯ 䠩
 251++A67E ~            ;       de -  砫 
 252++A67E ~            ;       (de) -  
 253++A67E ~            ;
 254++A67E ~            ;FindPathFile
 255++A67E ~            ;
 256++A67E ~            	call	SetPathFile
 257++A67E ~            	ret	c
 258++A67E ~            	scf			;⠭  ४ਨ
 259++A67E ~            	call	StoreCLSCurrDir
 260++A67E ~            	ccf
 261++A67E ~            	ret
 262++A67E ~
 263++A67E              	endif
 264++A67E
 265++A67E              ;------------------------------------------------------------------------------
 266++A67E              SetPathFile	ifused
 267++A67E ~            ; 䠩     ⥪饬 ⠫  室  ⠫
 268++A67E ~            ; ஢મ ᨭ⠪  ⠭  ⠫ ⥪騬
 269++A67E ~            ;ଠ : [Drive:][\][DIR\DIR\..\DIR\]filename.ext
 270++A67E ~            ;:  hl -   䠩,     (⠭  室)
 271++A67E ~            ;: cy=1 訡 ⥭/  ⠫  / ⮩
 272++A67E ~            ;       z  -  ⮩, ⥪騩 ⠫  
 273++A67E ~            ;         a=errPathEmpty
 274++A67E ~            ;       nz - 訡 ⥭/  ⠫  
 275++A67E ~            ;         a=errInvFileName
 276++A67E ~            ;         a=errRWnum
 277++A67E ~            ;         a=errInvalidPart
 278++A67E ~            ;         a=errEoF - 䠩 ࢠ
 279++A67E ~            ;         a=errFileEmpty - ⮩ ୥ ⠫
 280++A67E ~            ;         a=errFileNotFound
 281++A67E ~            ;     cy=0   ⠫ 
 282++A67E ~            ;       z  -> a=#00 -  ⠫, ⥪騩  = ⠫
 283++A67E ~            ;       nz -> a=#00 -  䠩,   ᫥  
 284++A67E ~            ;                      ⥪騩  = ⠫  䠩
 285++A67E ~            ;       nz -> a<>#00 -  䠩,   ᫥  
 286++A67E ~            ;                      ⥪騩  = ⠫  䠩
 287++A67E ~            ;       b - ࠡ⠭ 
 288++A67E ~            ;       hl -  砫 ਯ 䠩
 289++A67E ~            ;       de -  砫 
 290++A67E ~            ;       (de) -  
 291++A67E ~            ;       (DescInCurrDir) -   (䠩)  ⠫
 292++A67E ~            ;     (tmpDIR) ।饥 祭 (CLS_CurrDir)
 293++A67E ~            ;
 294++A67E ~            ;SetPathFile
 295++A67E ~            ;
 296++A67E ~            ;  ⥪饣 ⠫
 297++A67E ~            	or	a
 298++A67E ~            	call	StoreCLSCurrDir
 299++A67E ~
 300++A67E ~            ;஢ઠ /  䠩
 301++A67E ~                    push	hl
 302++A67E ~            	inc	hl
 303++A67E ~            	call	TestPathFile	;஢ઠ /  䠩
 304++A67E ~            	ld	a,errInvFileName
 305++A67E ~            	jr	c,goto134	;訡   䠩
 306++A67E ~            	ld	a,errPathEmpty
 307++A67E ~            	jr	z,goto135	; ⮩
 308++A67E ~            	xor	a		;a - 
 309++A67E ~            	push	af
 310++A67E ~            loop049	call	SkipSeparator	;ய ࠧ⥫   
 311++A67E ~            	or	a
 312++A67E ~            	jr	z,goto128	; 
 313++A67E ~
 314++A67E ~            ;   ⥪饬 ⠫
 315++A67E ~            	push	hl
 316++A67E ~            	call	fatFindEntryDir
 317++A67E ~            	jr	c,goto126	;訡 ⥭
 318++A67E ~            	jr	nz,goto125	;  ⠫  
 319++A67E ~            	ex	(sp),hl
 320++A67E ~            	ld	hl,#000B
 321++A67E ~            	add	hl,de
 322++A67E ~            	bit	4,(hl)
 323++A67E ~            	jr	z,goto127	; 䠩
 324++A67E ~            	ld	h,d
 325++A67E ~            	ld	l,e		; ਯ  
 326++A67E ~            	call	CP_TwoDot
 327++A67E ~            	push	af
 328++A67E ~            	call	SetDirCurrent
 329++A67E ~            	pop	af
 330++A67E ~            	pop	hl
 331++A67E ~            	pop	bc
 332++A67E ~            	jr	nz,goto130
 333++A67E ~            	dec	b
 334++A67E ~            	dec	b		; -1
 335++A67E ~            goto130	inc	b		; +1
 336++A67E ~            	push	bc
 337++A67E ~            	ld	a,(hl)
 338++A67E ~            	or	a
 339++A67E ~            	jr	nz,loop049
 340++A67E ~            	jr	goto128
 341++A67E ~
 342++A67E ~            ; 䠩
 343++A67E ~            ;(sp)b - 
 344++A67E ~            ;(sp)hl -    䠩
 345++A67E ~            ;de -  ਯ  
 346++A67E ~            goto127	dec	h		;⠭ 䫠 nz
 347++A67E ~            	pop	hl		; ᫥饣   
 348++A67E ~            	ld	a,(hl)
 349++A67E ~
 350++A67E ~            ; 
 351++A67E ~            ;: z,a=#00  -  ⠫
 352++A67E ~            ;    nz,a=#nn -  䠩
 353++A67E ~            ;    hl -  ᫥饣    (㪠뢠  #00/#nn)
 354++A67E ~            ;    de -  ਯ  
 355++A67E ~            goto128	ex	af,af'
 356++A67E ~            	pop	af		;
 357++A67E ~            	pop	bc		;砫   䠩
 358++A67E ~            	push	af
 359++A67E ~            ;    ࠭  
 360++A67E ~            	ld	(hl),#00
 361++A67E ~            	or	a
 362++A67E ~            	sbc	hl,bc
 363++A67E ~            	ld	h,b
 364++A67E ~            	ld	b,l
 365++A67E ~            	ld	l,c		;hl 砫   䠩
 366++A67E ~            	ld	(hl),b
 367++A67E ~            	ex	de,hl
 368++A67E ~            	pop	bc		;b = 
 369++A67E ~            	ex	af,af'
 370++A67E ~            	ret
 371++A67E ~
 372++A67E ~            ;  ⠫  
 373++A67E ~            goto125	ld	a,errFileNotFound
 374++A67E ~
 375++A67E ~            ;訡 ⥭/
 376++A67E ~            ;:  a -  訡
 377++A67E ~            ;: cy=1
 378++A67E ~            goto126	pop	hl
 379++A67E ~            	pop	hl
 380++A67E ~            goto134	or	a		;䫠 nz
 381++A67E ~            goto135	scf			;⠭  ४ਨ
 382++A67E ~            	pop	hl
 383++A67E ~            	jp	StoreCLSCurrDir
 384++A67E ~
 385++A67E              	endif
 386++A67E
 387++A67E              ;------------------------------------------------------------------------------
 388++A67E              Enter2DIR	ifused
 389++A67E              ;室  ४
 390++A67E              ;:  hl -  ਯ ४ਨ/䠩
 391++A67E              ;     a - attr 
 392++A67E              ;     7,e =0  䠩/⠫
 393++A67E              ;         =1    த⥫᪨ ⠫
 394++A67E              ;     0,e =1   
 395++A67E              ;: hl,de,bc,a - ???
 396++A67E              ;
 397++A67E              ;Enter2DIR
 398++A67E              ;
 399++A67E CB 67        	bit	4,a
 400++A680 CA 36 B1     	jp	z,RenewPath	; 䠩.  ப ⥪饣 
 401++A683 CB 7B        	bit	7,e
 402++A685 01 FB 8C     	ld	bc,CurrentLevel	;㡨   ⥪饬 ⠫
 403++A688 0A           	ld	a,(bc)
 404++A689 28 04        	jr	z,goto124	;室  ⠫
 405++A68B
 406++A68B              ;室  த⥫᪨ ⠫
 407++A68B B7           	or	a
 408++A68C C8           	ret	z		;  ୥ ⠫
 409++A68D 3D           	dec	a
 410++A68E 3D           	dec	a
 411++A68F
 412++A68F              ;室  ⠫
 413++A68F 3C           goto124	inc	a
 414++A690 FE 10        	cp	#10
 415++A692 C8           	ret	z		;᫨誮  
 416++A693 02           	ld	(bc),a
 417++A694 CD 36 B1     	call	RenewPath	; ப ⥪饣 
 418++A697 18 FE        	jr	SetDirCurrent
 419++A699              	org	$-2
 420++A697
 421++A697              	endif
 422++A697
 423++A697              ;------------------------------------------------------------------------------
 424++A697              SetDirCurrent	ifused
 425++A697              ;⠭ ४ਨ ⥪饩
 426++A697              ;:  hl -  ਯ ४ਨ
 427++A697              ;: bc=#0005
 428++A697              ;
 429++A697              ;SetDirCurrent
 430++A697              ;
 431++A697 D5           	push	de
 432++A698 01 14 00     	ld	bc,#0014
 433++A69B 09           	add	hl,bc
 434++A69C 5E           	ld	e,(hl)
 435++A69D 23           	inc	hl
 436++A69E 56           	ld	d,(hl)		;  (襥 ᫮)
 437++A69F 0E 05        	ld	c,#05
 438++A6A1 09           	add	hl,bc
 439++A6A2 7E           	ld	a,(hl)
 440++A6A3 23           	inc	hl
 441++A6A4 66           	ld	h,(hl)		;  (襥 ᫮)
 442++A6A5 6F           	ld	l,a
 443++A6A6 B4           	or	h
 444++A6A7 B2           	or	d
 445++A6A8 B3           	or	e
 446++A6A9 20 07        	jr	nz,goto123	; ୥ ⠫
 447++A6AB 2A EF 8C     	ld	hl,(RootClaster)
 448++A6AE ED 5B F1 8C  	ld	de,(RootClaster+2)
 449++A6B2 22 FC 8C     goto123	ld	(CLS_CurrDir),hl
 450++A6B5 ED 53 FE 8C  	ld	(CLS_CurrDir+2),de
 451++A6B9 D1           	pop	de
 452++A6BA C9           	ret
 453++A6BB
 454++A6BB              	endif
 455++A6BB
 456++A6BB              ;------------------------------------------------------------------------------
 457++A6BB              fatEraseEntry	ifused
 458++A6BB              ;㤠   ⥪饬 ⠫ (䠩/⮣ ⠫)
 459++A6BB              ;   fcb   ⠭: fcbName, fcbExt
 460++A6BB              ;:  ix -   fcb
 461++A6BB              ;: cy=1 訡 ⥭/
 462++A6BB              ;       a=errRWnum
 463++A6BB              ;       a=errInvalidPart
 464++A6BB              ;       a=errEoF - 䠩 ࢠ
 465++A6BB              ;       a=errFileEmpty - ⮩ ୥ ⠫
 466++A6BB              ;       a=errDirNotEmpty
 467++A6BB              ;     cy=0, nz - 䠩     
 468++A6BB              ;       a=errFileNotFound
 469++A6BB              ;     cy=0, z - 䠩/⠫ 㤠
 470++A6BB              ;
 471++A6BB              ;fatEraseEntry
 472++A6BB              ;
 473++A6BB              ;஢ઠ ⢮ 䠩/⠫
 474++A6BB DD E5        	push	ix
 475++A6BD E1           	pop	hl
 476++A6BE CD A1 A7     	call	fatFindEntryDir
 477++A6C1 D8           	ret	c			;訡
 478++A6C2 3E 48        	ld	a,errFileNotFound
 479++A6C4 C0           	ret	nz			;  ⠪  
 480++A6C5 C5           	push	bc			;   ⠫
 481++A6C6 EB           	ex	de,hl
 482++A6C7 CD 51 AC     	call	fcbSetFromEntry
 483++A6CA
 484++A6CA              ;᫨  ⠫, ஢ਬ ⮩   
 485++A6CA DD CB 0B 66  	bit	4,(ix+fcbAttr)
 486++A6CE 28 1B        	jr	z,goto120		; 䠩
 487++A6D0              ;  ஢ਬ ⠫  稥 ᥩ
 488++A6D0 DD E5        	push	ix
 489++A6D2 E1           	pop	hl
 490++A6D3 11 0C 00     	ld	de,fcbClsFile
 491++A6D6 19           	add	hl,de
 492++A6D7 E5           	push	hl
 493++A6D8 CD E2 B2     	call	excngCLSCurrDir
 494++A6DB CD 45 A7     	call	fatTestEmptyDir
 495++A6DE E1           	pop	hl
 496++A6DF F5           	push	af
 497++A6E0 CD E2 B2     	call	excngCLSCurrDir
 498++A6E3 F1           	pop	af
 499++A6E4 C1           	pop	bc
 500++A6E5 D8           	ret	c
 501++A6E6 3E 74        	ld	a,errDirNotEmpty
 502++A6E8 37           	scf
 503++A6E9 C0           	ret	nz
 504++A6EA C5           	push	bc
 505++A6EB
 506++A6EB              ;㤠 
 507++A6EB              ;  ᢮ ⮩ 楯窨 ஢
 508++A6EB CD 0F AD     goto120	call	LD_DEHL_fcbClsFile
 509++A6EE CD 8A AF     	call	FreeClsChain
 510++A6F1 C1           	pop	bc			;   ⠫
 511++A6F2 D8           	ret	c			;訡 ⥭/
 512++A6F3 18 FE        	jr	fatMarkDelEntry
 513++A6F5              	org	$-2
 514++A6F3
 515++A6F3              	endif
 516++A6F3
 517++A6F3              ;------------------------------------------------------------------------------
 518++A6F3              fatMarkDelEntry	ifused
 519++A6F3              ;⪠  䠩  ⠫   ﬨ   㤠묨
 520++A6F3              ;:  bc -    ⠫
 521++A6F3              ;: cy=1 訡 ⥭/ -> a -  訡
 522++A6F3              ;       =0 襭 ᯥ譮 -> a=#00
 523++A6F3              ;     hl,de,bc - ???
 524++A6F3              ;
 525++A6F3              ;fatMarkDelEntry
 526++A6F3              ;
 527++A6F3 CD 08 A7     loop046	call	fatGetEntryLong
 528++A6F6 D8           	ret	c
 529++A6F7 C5           	push	bc
 530++A6F8 D5           	push	de
 531++A6F9 36 E5        	ld	(hl),#E5
 532++A6FB CD CC B0     	call	SaveSecBuf2DIR
 533++A6FE D1           	pop	de
 534++A6FF C1           	pop	bc
 535++A700 D8           	ret	c
 536++A701 0B           	dec	bc
 537++A702 CB 1B        	rr	e
 538++A704 38 ED        	jr	c,loop046
 539++A706 AF           	xor	a
 540++A707 C9           	ret
 541++A708
 542++A708              	endif
 543++A708
 544++A708              ;------------------------------------------------------------------------------
 545++A708              fatGetEntryLBA	ifused
 546++A708 ~            ;  ⥪饬 ⠫ ਯ   LBA 
 547++A708 ~            ;:  bc -    ⠫/   ᥪ
 548++A708 ~            ;     dehl - LBA  ᥪ  
 549++A708 ~            	;     a - ਡ ।饩  (᫨ )
 550++A708 ~            ;: bc  
 551++A708 ~            ;     cy=1 訡 ⥭/
 552++A708 ~            ;       a=errRWnum
 553++A708 ~            ;       a=errInvalidPart
 554++A708 ~            ;       a=errEoF - 䠩 ࢠ
 555++A708 ~            ;     cy=0  
 556++A708 ~            ;       hl    
 557++A708 ~            ;       a - attr   
 558++A708 ~            ;       7,d =0  䠩/⠫
 559++A708 ~            ;           =1    த⥫᪨ ⠫
 560++A708 ~            ;       7,e =0  䠩/⠫
 561++A708 ~            ;           =1    த⥫᪨ ⠫
 562++A708 ~            ;
 563++A708 ~            ;fatGetEntryLBA
 564++A708 ~            ;
 565++A708 ~            	push	bc
 566++A708 ~            ;	push	af
 567++A708 ~            	call	LoadSecDIR2Buf	;: hl=Buf4DIR
 568++A708 ~            ;	pop	bc
 569++A708 ~            ;	ld	e,b
 570++A708 ~            	pop	bc
 571++A708 ~            	jr	proc_16
 572++A708 ~            	jr	fatGetEntry
 573++A708 ~            	org	$-2
 574++A708 ~
 575++A708              	endif
 576++A708
 577++A708              ;------------------------------------------------------------------------------
 578++A708              fatGetEntryLong	ifused
 579++A708              ;  ⥪饬 ⠫ ਯ   
 580++A708              ;:  bc -    ⠫
 581++A708              ;: bc  
 582++A708              ;     cy=1 訡 ⥭/
 583++A708              ;       a=errRWnum
 584++A708              ;       a=errInvalidPart
 585++A708              ;       a=errEoF - 䠩 ࢠ
 586++A708              ;     cy=0  
 587++A708              ;       hl    
 588++A708              ;        a - attr   
 589++A708              ;        7,d =0  䠩/⠫
 590++A708              ;            =1    த⥫᪨ ⠫
 591++A708              ;        7,e =0  䠩/⠫
 592++A708              ;            =1    த⥫᪨ ⠫
 593++A708              ;        0,e =1   
 594++A708              ;
 595++A708              ;fatGetEntryLong
 596++A708              ;
 597++A708 78           	ld	a,b
 598++A709 B1           	or	c		; ⥪饩   ⠫ =#00?
 599++A70A 5F           	ld	e,a
 600++A70B 28 07        	jr	z,fatGetEntry	;।騩   ஢塞
 601++A70D 0B           	dec	bc		;஢ਬ ।騩 
 602++A70E CD 14 A7     	call	fatGetEntry
 603++A711 03           	inc	bc
 604++A712 D8           	ret	c		;訡 ⥭
 605++A713 5F           	ld	e,a		;ਡ ।饩 
 606++A714
 607++A714              	endif
 608++A714
 609++A714              ;------------------------------------------------------------------------------
 610++A714              fatGetEntry	ifused
 611++A714              ;  ⥪饬 ⠫ ਯ   
 612++A714              ;:  bc -    ⠫
 613++A714              ;      e - ਡ ।饩 
 614++A714              ;: bc  
 615++A714              ;     cy=1 訡 ⥭/
 616++A714              ;       a=errRWnum
 617++A714              ;       a=errInvalidPart
 618++A714              ;       a=errEoF - 䠩 ࢠ
 619++A714              ;     cy=0  
 620++A714              ;       hl    
 621++A714              ;       a - attr   
 622++A714              ;       7,d =0  䠩/⠫
 623++A714              ;           =1    த⥫᪨ ⠫
 624++A714              ;       7,e =0  䠩/⠫
 625++A714              ;           =1    த⥫᪨ ⠫
 626++A714              ;       0,e =1   
 627++A714              ;
 628++A714              ;fatGetEntry
 629++A714              ;
 630++A714              ;proc_08
 631++A714 D5           	push	de
 632++A715 CD 25 A8     	call	ReadSectorDIR	;⠥ ᥪ   ஬ 
 633++A718 D1           	pop	de		;hl=Buf4DIR
 634++A719 D8           proc_16	ret	c		;訡
 635++A71A 7B           	ld	a,e		;稥/⢨  
 636++A71B 08           	ex	af,af'
 637++A71C 79           	ld	a,c
 638++A71D E6 0F        	and	#0F		;   ᥪ
 639++A71F 5F           	ld	e,a
 640++A720 16 00        	ld	d,#00
 641++A722 EB           	ex	de,hl
 642++A723 29           	add	hl,hl
 643++A724 29           	add	hl,hl
 644++A725 29           	add	hl,hl
 645++A726 29           	add	hl,hl
 646++A727 29           	add	hl,hl		;hl=hl*#20
 647++A728 19           	add	hl,de		;   
 648++A729 11 0B 00     	ld	de,#000B
 649++A72C 7E           	ld	a,(hl)		;  
 650++A72D EB           	ex	de,hl
 651++A72E 19           	add	hl,de
 652++A72F 6E           	ld	l,(hl)		; ਡ⮢
 653++A730 67           	ld	h,a		;  
 654++A731 EB           	ex	de,hl
 655++A732 CD 0D A8     	call	CP_TwoDot
 656++A735 16 00        	ld	d,#00
 657++A737 20 02        	jr	nz,goto119	;㤥 室  ⠫
 658++A739 16 80        	ld	d,#80		;㤥 室  த⥫᪨
 659++A73B 08           goto119	ex	af,af'
 660++A73C FE 0F        	cp	#0F		;஢塞 ਡ ।饩 
 661++A73E 37           	scf
 662++A73F 3F           	ccf
 663++A740 7B           	ld	a,e		;ਡ ⥪饩 
 664++A741 5A           	ld	e,d		;ࠢ /।
 665++A742 C0           	ret	nz
 666++A743 1C           	inc	e		;bit 0,e=1   
 667++A744 C9           	ret
 668++A745
 669++A745              	endif
 670++A745
 671++A745              ;------------------------------------------------------------------------------
 672++A745              fatTestEmptyDir	ifused
 673++A745              ;஢ઠ ⥪飮 ⠫ ⮩  
 674++A745              ;:  (CLS_CurrDir) -  ࢮ  ⠫
 675++A745              ;: cy=1 訡 ⥭/
 676++A745              ;       a=errRWnum
 677++A745              ;       a=errInvalidPart
 678++A745              ;       a=errEoF - 䠩 ࢠ
 679++A745              ;     cy=0 ⠫ ஢७
 680++A745              ;       z -  ⮩ ⠫
 681++A745              ;       7,a =0/1 ⠫ ୥/
 682++A745              ;
 683++A745              ;fatTestEmptyDir
 684++A745              ;
 685++A745              ;⠥  ᥪ  ஢塞 稥 䨪஢ 
 686++A745 01 00 00     	ld	bc,#0000	;bc=#0000  ⥪饩   ⠫
 687++A748 CD 25 A8     	call	ReadSectorDIR	;⥭ ᥪ ⠫     
 688++A74B D8           	ret	c		;訡
 689++A74C CD 19 A8     	call	CP_OneDot	;hl=Buf4DIR
 690++A74F 28 05        	jr	z,goto116	; ࢠ  "."
 691++A751 7E           	ld	a,(hl)
 692++A752 B7           	or	a
 693++A753 C8           	ret	z		;⮩ ⠫ (   ⮫쪮 ୥)
 694++A754 3E 80        	ld	a,#80		; ୥ ⠫
 695++A756
 696++A756              ;ᥪ 㦥, 饬 ᮢ   
 697++A756 F5           goto116	push	af		;⢮  ᥩ
 698++A757 C5           loop045	push	bc		; 
 699++A758 0E 00        	ld	c,#00		;   ᥪ
 700++A75A 11 0B 00     loop044	ld	de,#000B
 701++A75D 19           	add	hl,de
 702++A75E 7E           	ld	a,(hl)		;ਡ
 703++A75F ED 52        	sbc	hl,de
 704++A761 5E           	ld	e,(hl)		; ᨬ 
 705++A762 FE 0F        	cp	#0F
 706++A764 28 15        	jr	z,goto117	;   
 707++A766 FE 08        	cp	#08
 708++A768 28 11        	jr	z,goto117	;Volume ID
 709++A76A 7B           	ld	a,e
 710++A76B B7           	or	a
 711++A76C 28 28        	jr	z,goto118	; .  稫
 712++A76E FE E5        	cp	#E5
 713++A770 28 09        	jr	z,goto117	;㤠 
 714++A772              ;  ⨬  
 715++A772 D1           	pop	de
 716++A773 F1           	pop	af
 717++A774 3C           	inc	a
 718++A775 F5           	push	af
 719++A776 D5           	push	de
 720++A777 FE 03        	cp	#03
 721++A779 30 1B        	jr	nc,goto118	;⠫  ⮩
 722++A77B              ;  ᫥   ᥪ
 723++A77B 11 20 00     goto117	ld	de,#0020
 724++A77E 19           	add	hl,de
 725++A77F 0C           	inc	c
 726++A780 79           	ld	a,c
 727++A781 FE 10        	cp	#10
 728++A783 38 D5        	jr	c,loop044
 729++A785
 730++A785              ;  ᥪ  , 㧨 ᫥騩 ᥪ
 731++A785 E1           	pop	hl
 732++A786 42           	ld	b,d
 733++A787 09           	add	hl,bc
 734++A788 4D           	ld	c,l
 735++A789 44           	ld	b,h		; ࢮ   ᫥饬 ᥪ
 736++A78A CD 25 A8     	call	ReadSectorDIR
 737++A78D 30 C8        	jr	nc,loop045
 738++A78F FE 71        	cp	errEoF
 739++A791 28 04        	jr	z,goto184
 740++A793
 741++A793              ;訡 ⥭/  㣠
 742++A793 E1           	pop	hl
 743++A794 37           	scf
 744++A795 C9           	ret
 745++A796
 746++A796              ;室. ⠫ ஢७
 747++A796 C1           goto118	pop	bc
 748++A797 F1           goto184	pop	af
 749++A798 FE 80        	cp	#80
 750++A79A C8           	ret	z
 751++A79B B7           	or	a
 752++A79C C8           	ret	z
 753++A79D F8           	ret	m
 754++A79E FE 02        	cp	#02
 755++A7A0 C9           	ret
 756++A7A1
 757++A7A1              	endif
 758++A7A1
 759++A7A1              ;------------------------------------------------------------------------------
 760++A7A1              SortFoundedEntries	ifused
 761++A7A1 ~            ;஢ ᯨ᪠  ਯ஢ (䠩/⠫)
 762++A7A1 ~            ;
 763++A7A1 ~            ;SortFoundedEntries
 764++A7A1 ~            ;
 765++A7A1 ~            /* ਠ
 766++A7A1 ~            	ld	hl,(DescInDIR)
 767++A7A1 ~            	ld	a,h
 768++A7A1 ~            	or	l
 769++A7A1 ~            	ret	z		;⮩ ⠫
 770++A7A1 ~            	dec	hl
 771++A7A1 ~            	ld	a,h
 772++A7A1 ~            	or	l
 773++A7A1 ~            	ret	z		;⮫쪮 1 
 774++A7A1 ~            	push	hl
 775++A7A1 ~            	exx
 776++A7A1 ~            	ld	hl,Buf4SortDesc
 777++A7A1 ~            	pop	bc
 778++A7A1 ~            	ld	e,#00
 779++A7A1 ~            	exx
 780++A7A1 ~            	call	proc_07		;஢ ᥩ ⠫  
 781++A7A1 ~            	exx
 782++A7A1 ~            	ld	e,#FF
 783++A7A1 ~            	exx
 784++A7A1 ~            	call	proc_07		;஢ ᥩ 䠩  
 785++A7A1 ~
 786++A7A1 ~            ;஢ १  ࠡ稩 
 787++A7A1 ~            	ld	hl,Buf4SortDesc
 788++A7A1 ~            	ld	de,Buf4Desc
 789++A7A1 ~            	ld	bc,#200
 790++A7A1 ~            	ldir
 791++A7A1 ~            	ret
 792++A7A1 ~            */
 793++A7A1 ~            	ld	hl,(DescInDIR)
 794++A7A1 ~            	ld	a,h
 795++A7A1 ~            	or	l
 796++A7A1 ~            	ret	z			;⮩ ⠫
 797++A7A1 ~            	ld	hl,Buf4Desc
 798++A7A1 ~            	ld	b,h
 799++A7A1 ~            	ld	c,l
 800++A7A1 ~            	ld	e,#80
 801++A7A1 ~            	call	proc_07			;஢ ᥩ ⠫  
 802++A7A1 ~            	ld	e,#00
 803++A7A1 ~            ;	call	proc_07			;஢ ᥩ 䠩  
 804++A7A1 ~            ;	ret
 805++A7A1 ~
 806++A7A1 ~
 807++A7A1 ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 808++A7A1 ~            /* ਠ
 809++A7A1 ~            ;஢ ᥩ  
 810++A7A1 ~            ;:  hl' -   楫 
 811++A7A1 ~            ;     bc' - ⢮ ᥩ
 812++A7A1 ~            ;      e' =#00/#FF ஢ ⮫쪮 ⠫/䠩
 813++A7A1 ~            ;: bc' - ⢮ ᥩ
 814++A7A1 ~            ;
 815++A7A1 ~            proc_07	ld	bc,Sym4Sort
 816++A7A1 ~            loop038	ld	hl,Buf4FirstSym
 817++A7A1 ~            	ld	de,Buf4Desc
 818++A7A1 ~            loop037	ld	a,(hl)
 819++A7A1 ~            	exx
 820++A7A1 ~            	xor	e
 821++A7A1 ~            	exx
 822++A7A1 ~            ;	and	#10
 823++A7A1 ~            	and	#80
 824++A7A1 ~            	jr	z,goto093	; ⠫/䠩
 825++A7A1 ~            	ld	a,(bc)
 826++A7A1 ~            	cp	#FF
 827++A7A1 ~            	jr	z,goto198		; 㪢
 828++A7A1 ~            	inc	hl
 829++A7A1 ~            	cp	(hl)
 830++A7A1 ~            	dec	hl
 831++A7A1 ~            	jr	nz,goto093
 832++A7A1 ~            goto198	ld	a,(de)
 833++A7A1 ~            	inc	de
 834++A7A1 ~            	exx
 835++A7A1 ~            	ld	(hl),a
 836++A7A1 ~            	inc	hl
 837++A7A1 ~            	exx
 838++A7A1 ~            	ld	a,(de)
 839++A7A1 ~            	inc	de
 840++A7A1 ~            	exx
 841++A7A1 ~            	ld	(hl),a
 842++A7A1 ~            	inc	hl
 843++A7A1 ~
 844++A7A1 ~            goto095	dec	bc
 845++A7A1 ~            	ld	a,b
 846++A7A1 ~            	or	c
 847++A7A1 ~            	exx
 848++A7A1 ~            	jr	z,goto094
 849++A7A1 ~            	inc	hl
 850++A7A1 ~            	inc	hl
 851++A7A1 ~            	jr	loop037
 852++A7A1 ~            ;᫥ 
 853++A7A1 ~            goto093	inc	de
 854++A7A1 ~            	inc	de
 855++A7A1 ~            	exx
 856++A7A1 ~            	jr	goto095
 857++A7A1 ~            ;᫥騩 ᨬ
 858++A7A1 ~            goto094	exx
 859++A7A1 ~            	ld	bc,(DescInDIR)
 860++A7A1 ~            	exx
 861++A7A1 ~            	inc	bc
 862++A7A1 ~            	ld	a,(bc)
 863++A7A1 ~            	or	a
 864++A7A1 ~            	jr	nz,loop038
 865++A7A1 ~
 866++A7A1 ~            	ret
 867++A7A1 ~            */
 868++A7A1 ~            ;஢ ᥩ  ⨯  
 869++A7A1 ~            ;:  hl -  ࢮ   -筨
 870++A7A1 ~            ;     bc -   楫 
 871++A7A1 ~            ;      e =#00/#80 ஢ ⮫쪮 䠩/⠫
 872++A7A1 ~            ;: hl -   ࢮ   -筨
 873++A7A1 ~            ;     bc - ।   楫 
 874++A7A1 ~            ;
 875++A7A1 ~            proc_07	exx
 876++A7A1 ~            	ld	bc,Sym4Sort
 877++A7A1 ~            	exx
 878++A7A1 ~            loop074	inc	hl
 879++A7A1 ~            	inc	(hl)
 880++A7A1 ~            	dec	(hl)
 881++A7A1 ~            	dec	hl
 882++A7A1 ~            	ret	z			; ⠫
 883++A7A1 ~            	push	hl
 884++A7A1 ~            loop073	ld	a,(hl)
 885++A7A1 ~            	inc	hl
 886++A7A1 ~            	xor	e
 887++A7A1 ~            	jp	m,goto199		; 㥬
 888++A7A1 ~            	ex	af,af'
 889++A7A1 ~            	exx
 890++A7A1 ~            	ld	a,(bc)
 891++A7A1 ~            	exx
 892++A7A1 ~            	cp	#FF
 893++A7A1 ~            	jr	z,goto200		; 㪢
 894++A7A1 ~            	cp	(hl)
 895++A7A1 ~            	jr	nz,goto199		;  㪢
 896++A7A1 ~            goto200	dec	hl			;+0
 897++A7A1 ~            	ex	de,hl
 898++A7A1 ~            	ex	(sp),hl
 899++A7A1 ~            ;    ( , 訩 )
 900++A7A1 ~            	ldi
 901++A7A1 ~            	inc	bc
 902++A7A1 ~            	ex	af,af'
 903++A7A1 ~            	ld	(bc),a
 904++A7A1 ~            	inc	bc
 905++A7A1 ~            ;  ன  (ࢠ 㪢)
 906++A7A1 ~            	ldi
 907++A7A1 ~            	inc	bc
 908++A7A1 ~            ;  ⨩  ( , 訩 )
 909++A7A1 ~            	ld	a,(de)
 910++A7A1 ~            	ldi
 911++A7A1 ~            	inc	bc
 912++A7A1 ~            	ld	(bc),a
 913++A7A1 ~            	inc	bc
 914++A7A1 ~            	ex	(sp),hl
 915++A7A1 ~            	ex	de,hl
 916++A7A1 ~            ;  ᫥ 
 917++A7A1 ~            	inc	hl
 918++A7A1 ~            	ld	a,(hl)
 919++A7A1 ~            	dec	hl
 920++A7A1 ~            	or	a			;=#00 ਧ  ᯨ᪠
 921++A7A1 ~            	jr	nz,loop073
 922++A7A1 ~
 923++A7A1 ~            ;᫥騩 ᨬ
 924++A7A1 ~            goto201	pop	hl
 925++A7A1 ~            	exx
 926++A7A1 ~            	inc	bc
 927++A7A1 ~            	ld	a,(bc)
 928++A7A1 ~            	exx
 929++A7A1 ~            	or	a
 930++A7A1 ~            	jr	nz,loop074
 931++A7A1 ~            	ret
 932++A7A1 ~
 933++A7A1 ~            ;᫥ ,  ᮢ 㪢
 934++A7A1 ~            goto199	inc	hl
 935++A7A1 ~            	inc	hl			;+3
 936++A7A1 ~            	inc	hl			;+1 next
 937++A7A1 ~            	ld	a,(hl)
 938++A7A1 ~            	dec	hl			;+0 next
 939++A7A1 ~            	or	a			;=#00 ਧ  ᯨ᪠
 940++A7A1 ~            	jr	nz,loop073
 941++A7A1 ~            	jr	goto201
 942++A7A1 ~
 943++A7A1              	endif
 944++A7A1
 945++A7A1              ;------------------------------------------------------------------------------
 946++A7A1              GetNumOfEntries	ifused
 947++A7A1 ~            ; ⢠ ⨬ ( 256) ᥩ  ⥪饬 ⠫
 948++A7A1 ~            ;:  (Ext4Found) -  ᯨ᪠ ७
 949++A7A1 ~            ;: cy=1 訡 ⥭
 950++A7A1 ~            ;     (DescInDIR),hl - ⢮  ᥩ
 951++A7A1 ~            ;
 952++A7A1 ~            ;GetNumOfEntries
 953++A7A1 ~            ;
 954++A7A1 ~            /* ਠ
 955++A7A1 ~            	ld	hl,#0000		;  ᯨ᪥ ⮡ࠦ ᥩ
 956++A7A1 ~            	ld	(DescInDIR),hl		;⢮  ᥩ
 957++A7A1 ~            	ld	bc,#FFFF		;稪 ᥩ
 958++A7A1 ~            	push	hl
 959++A7A1 ~            loop035	inc	bc
 960++A7A1 ~            	call	ReadSectorDIR		;⠥ ᥪ   ஬ 
 961++A7A1 ~            	jr	c,goto090
 962++A7A1 ~            	ex	de,hl			;de = Buf4DIR
 963++A7A1 ~            	ld	l,c			;   ⠫
 964++A7A1 ~            	add	hl,hl
 965++A7A1 ~            	add	hl,hl
 966++A7A1 ~            	add	hl,hl
 967++A7A1 ~            	add	hl,hl
 968++A7A1 ~            	ld	h,#00
 969++A7A1 ~            	add	hl,hl			;ᬥ饭  ᥪ
 970++A7A1 ~            	add	hl,de			; ਯ
 971++A7A1 ~            	ld	a,(hl)
 972++A7A1 ~            	or	a
 973++A7A1 ~            	jr	z,goto091		; ⠫
 974++A7A1 ~            	call	CP_OneDot
 975++A7A1 ~            	jr	z,loop035		;: .
 976++A7A1 ~            	ld	a,(hl)
 977++A7A1 ~            	cp	#E5
 978++A7A1 ~            	jr	z,loop035		;㤠 
 979++A7A1 ~            	ex	af,af'			; ᨬ 
 980++A7A1 ~            	ld	de,#000B
 981++A7A1 ~            	add	hl,de
 982++A7A1 ~            	ld	a,(hl)			;ਡ
 983++A7A1 ~            	cp	#0F
 984++A7A1 ~            	jr	z,loop035		;  
 985++A7A1 ~            	bit	3,a
 986++A7A1 ~            	jr	nz,loop035		;⪠ ⮬
 987++A7A1 ~            	and	#10
 988++A7A1 ~            	jr	nz,goto092		; ⠫
 989++A7A1 ~
 990++A7A1 ~            ;ࠢ ७  ᯨ᪮
 991++A7A1 ~            	ld	de,(Ext4Found)
 992++A7A1 ~            	ld	a,(de)
 993++A7A1 ~            	or	a
 994++A7A1 ~            	jr	z,goto092		;⮡ࠦ 
 995++A7A1 ~            loop036	ld	a,(de)
 996++A7A1 ~            	or	a
 997++A7A1 ~            	jr	z,loop035		; ᯨ᪠.  ⠪ ७  ⮡ࠦ
 998++A7A1 ~            	push	de
 999++A7A1 ~            	push	hl
1000++A7A1 ~            	dec	hl
1001++A7A1 ~            	dec	hl
1002++A7A1 ~            	dec	hl
1003++A7A1 ~            	call	cmp_adrDE_adrHL_3b	 ;ࠢ  ७
1004++A7A1 ~            	pop	hl
1005++A7A1 ~            	pop	de
1006++A7A1 ~            	inc	de
1007++A7A1 ~            	inc	de
1008++A7A1 ~            	inc	de
1009++A7A1 ~            	jr	nz,loop036
1010++A7A1 ~
1011++A7A1 ~            ; ⮡ࠦ
1012++A7A1 ~            goto092	ld	a,(hl)			;ਡ
1013++A7A1 ~            	pop	de			;  ᯨ᪥ ⮡ࠦ ᥩ
1014++A7A1 ~            	ld	hl,Buf4Desc		;ᯨ᮪  ஢
1015++A7A1 ~            	add	hl,de
1016++A7A1 ~            	add	hl,de
1017++A7A1 ~            	ld	(hl),c
1018++A7A1 ~            	inc	hl
1019++A7A1 ~            	ld	(hl),b			; 
1020++A7A1 ~            	ld	hl,Buf4FirstSym		;ᯨ᮪  㪢  ਡ⮢
1021++A7A1 ~            	add	hl,de
1022++A7A1 ~            	add	hl,de
1023++A7A1 ~            	ld	(hl),a
1024++A7A1 ~            	inc	hl
1025++A7A1 ~            	ex	af,af'			;	 ᨬ 
1026++A7A1 ~            	ld	(hl),a
1027++A7A1 ~            	inc	de			;+1  
1028++A7A1 ~            	push	de
1029++A7A1 ~            	ld	a,d
1030++A7A1 ~            ;	cp	#01
1031++A7A1 ~            ;	jr	c,loop035		;  256 ᥩ
1032++A7A1 ~            	or	a
1033++A7A1 ~            	jr	z,loop035		;  256 ᥩ
1034++A7A1 ~
1035++A7A1 ~            ; ᪠
1036++A7A1 ~            goto091	ld	a,errEoF
1037++A7A1 ~            goto090	pop	hl
1038++A7A1 ~            	ld	(DescInDIR),hl
1039++A7A1 ~            	cp	errEoF
1040++A7A1 ~            	ret	z
1041++A7A1 ~            	scf
1042++A7A1 ~            	ret
1043++A7A1 ~            */
1044++A7A1 ~            ;⠥  ᥪ  ஢塞 稥 䨪஢ 
1045++A7A1 ~            	ld	bc,#0000		; ࢮ   ⠫
1046++A7A1 ~            	call	ReadSectorDIR		;⥭ ᥪ ⠫     
1047++A7A1 ~            	exx
1048++A7A1 ~            	ld	hl,#0000		;⢮  ᥩ
1049++A7A1 ~            	exx
1050++A7A1 ~            	ld	de,Buf4Desc
1051++A7A1 ~            	jr	c,goto197		;訡 ⥭
1052++A7A1 ~            	call	CP_OneDot		;hl=Buf4DIR
1053++A7A1 ~            	scf
1054++A7A1 ~            	jr	z,loop072		;cy=1,  ࢠ  "."
1055++A7A1 ~            	or	a
1056++A7A1 ~
1057++A7A1 ~            ;ᥪ 㦥, 饬 ᮢ   
1058++A7A1 ~            loop072	call	findEntryInSector
1059++A7A1 ~            	ld	a,errEoF
1060++A7A1 ~            	jr	c,goto197		; ᨬ ᥩ/ ⠫ 稫
1061++A7A1 ~
1062++A7A1 ~            ;㧨 ᫥騩 ᥪ
1063++A7A1 ~            ;bc -  ࢮ   ᫥饬 ᥪ
1064++A7A1 ~            	exx
1065++A7A1 ~            	push	hl
1066++A7A1 ~            	exx
1067++A7A1 ~            	push	de
1068++A7A1 ~            	call	ReadSectorDIR
1069++A7A1 ~            	pop	de
1070++A7A1 ~            	exx
1071++A7A1 ~            	pop	hl
1072++A7A1 ~            	exx
1073++A7A1 ~            	jr	nc,loop072
1074++A7A1 ~
1075++A7A1 ~            ;訡 ⥭/  㣠, ⠫ 稫
1076++A7A1 ~            ;a=errEoF ⠫ 稫
1077++A7A1 ~            ;a -  訡
1078++A7A1 ~            goto197	inc	de
1079++A7A1 ~            	ex	de,hl
1080++A7A1 ~            	ld	(hl),#00
1081++A7A1 ~            	exx
1082++A7A1 ~            	ld	(DescInDIR),hl		;⢮  ᥩ
1083++A7A1 ~            	cp	errEoF
1084++A7A1 ~            	ret	z			;nc
1085++A7A1 ~            	scf
1086++A7A1 ~            	ret
1087++A7A1 ~
1088++A7A1 ~            ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1089++A7A1 ~            ;   㦥 ᥪ
1090++A7A1 ~            ;:  hl' - ⢮  ᥩ
1091++A7A1 ~            ;     hl = Buf4DIR (  ᥪ஬)
1092++A7A1 ~            ;     de = Buf4Desc+n (।   )
1093++A7A1 ~            ;     bc -    ⠫ (ࢠ   ᥪ)
1094++A7A1 ~            ;     cy=1 ய   ( 뫪  ᥡ ( 窠))
1095++A7A1 ~            ;     (Ext4Found) -  ᯨ᪠ ७
1096++A7A1 ~            ;: hl' - ⢮  ᥩ
1097++A7A1 ~            ;     de = Buf4Desc+n (।   )
1098++A7A1 ~            ;     bc -  ।   ⠫
1099++A7A1 ~            ;     hl,a,a' - ???
1100++A7A1 ~            ;     cy=1 -  ᨬ ᥩ/ ⠫ 稫
1101++A7A1 ~            ;
1102++A7A1 ~            findEntryInSector
1103++A7A1 ~            ;
1104++A7A1 ~            ;ᥪ 㦥, 饬 ⨬ 
1105++A7A1 ~            	push	de
1106++A7A1 ~            	jr	c,goto193		;ய ࢮ 
1107++A7A1 ~            loop070	ld	a,(hl)
1108++A7A1 ~            	or	a
1109++A7A1 ~            	jr	z,goto194		; .  ⠫
1110++A7A1 ~            	cp	#E5
1111++A7A1 ~            	jr	z,goto193		;㤠 
1112++A7A1 ~            	ex	af,af'			; ᨬ 
1113++A7A1 ~            	ld	de,#000B
1114++A7A1 ~            	add	hl,de
1115++A7A1 ~            	ld	a,(hl)			;ਡ
1116++A7A1 ~            	sbc	hl,de
1117++A7A1 ~            	cp	#0F
1118++A7A1 ~            	jr	z,goto193		;  
1119++A7A1 ~            	bit	3,a
1120++A7A1 ~            	jr	nz,goto193		;⪠ ⮬
1121++A7A1 ~            	set	7,b			;ਧ ⠫
1122++A7A1 ~            	and	#10
1123++A7A1 ~            	jr	nz,goto195		; ⠫, ⮡ࠦ ᥣ
1124++A7A1 ~            	res	7,b			;ਧ 䠩
1125++A7A1 ~
1126++A7A1 ~            ;ࠢ ७  ᯨ᪮
1127++A7A1 ~            	ld	de,(Ext4Found)
1128++A7A1 ~            	ld	a,(de)
1129++A7A1 ~            	or	a
1130++A7A1 ~            	jr	z,goto195		;⮡ࠦ 
1131++A7A1 ~            	push	bc
1132++A7A1 ~            	ld	bc,#0008
1133++A7A1 ~            loop071	ld	a,(de)
1134++A7A1 ~            	or	a
1135++A7A1 ~            	jr	z,goto196		; ᯨ᪠.  ⠪ ७  ⮡ࠦ
1136++A7A1 ~            	push	de
1137++A7A1 ~            	push	hl
1138++A7A1 ~            	add	hl,bc
1139++A7A1 ~            	call	cmp_adrDE_adrHL_3b 	;ࠢ  ७
1140++A7A1 ~            	pop	hl
1141++A7A1 ~            	pop	de
1142++A7A1 ~            	inc	de
1143++A7A1 ~            	inc	de
1144++A7A1 ~            	inc	de
1145++A7A1 ~            	jr	nz,loop071
1146++A7A1 ~            	pop	bc
1147++A7A1 ~
1148++A7A1 ~            ; ⮡ࠦ
1149++A7A1 ~            goto195	ex	(sp),hl
1150++A7A1 ~            	ld	(hl),b			;  (訩 )
1151++A7A1 ~            	res	7,b
1152++A7A1 ~            	inc	hl
1153++A7A1 ~            	ex	af,af'
1154++A7A1 ~            	ld	(hl),a			;  (ࢠ 㪢)
1155++A7A1 ~            	inc	hl
1156++A7A1 ~            	ld	(hl),c			;  (訩 )
1157++A7A1 ~            	inc	hl
1158++A7A1 ~            /*
1159++A7A1 ~            	inc	h
1160++A7A1 ~            	inc	h
1161++A7A1 ~            	ld	(hl),b
1162++A7A1 ~            	inc	hl
1163++A7A1 ~            	ex	af,af'
1164++A7A1 ~            	ld	(hl),a
1165++A7A1 ~            	dec	hl
1166++A7A1 ~            	dec	h
1167++A7A1 ~            	dec	h
1168++A7A1 ~            	res	7,b
1169++A7A1 ~            	ld	(hl),c			;  (訩 )
1170++A7A1 ~            	inc	hl
1171++A7A1 ~            	ld	(hl),b			;  (訩 )
1172++A7A1 ~            	inc	hl
1173++A7A1 ~            */
1174++A7A1 ~            	ex	(sp),hl
1175++A7A1 ~            	exx
1176++A7A1 ~            	inc	hl			;+1  
1177++A7A1 ~            	ld	a,h
1178++A7A1 ~            	exx
1179++A7A1 ~            	dec	a
1180++A7A1 ~            	jr	z,goto194		; ᨬ ᥩ
1181++A7A1 ~
1182++A7A1 ~            ;᫥   ᥪ
1183++A7A1 ~            	push	bc
1184++A7A1 ~            goto196	pop	bc
1185++A7A1 ~            goto193	inc	bc
1186++A7A1 ~            	bit	7,b
1187++A7A1 ~            	jr	nz,goto194		; ᪠  , ९
1188++A7A1 ~            	ld	de,#0020
1189++A7A1 ~            	add	hl,de
1190++A7A1 ~            	ld	de,Buf4DIR+#200
1191++A7A1 ~            	sbc	hl,de
1192++A7A1 ~            	add	hl,de
1193++A7A1 ~            	jr	nz,loop070
1194++A7A1 ~
1195++A7A1 ~            ;ᥪ 稫
1196++A7A1 ~            	pop	de
1197++A7A1 ~            	xor	a
1198++A7A1 ~            	ret
1199++A7A1 ~
1200++A7A1 ~            ; ᨬ ᥩ/ ⠫ 稫
1201++A7A1 ~            goto194	pop	de
1202++A7A1 ~            	scf
1203++A7A1 ~            	ret
1204++A7A1 ~
1205++A7A1              	endif
1206++A7A1
1207++A7A1              ;------------------------------------------------------------------------------
1208++A7A1              fatCreateDIR	ifused
1209++A7A1 ~            ;ᮧ ⠫  ⥪饬 FAT32 ⠫
1210++A7A1 ~            ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType=1
1211++A7A1 ~            ;  fcbSize=#00000000
1212++A7A1 ~            ;:  ix -   fcb
1213++A7A1 ~            ;: cy=1 뫨 訡
1214++A7A1 ~            ;       a=errRWnum
1215++A7A1 ~            ;       a=errInvalidPart
1216++A7A1 ~            ;       a=errEoF - 䠩 ࢠ
1217++A7A1 ~            ;       a=errFileEmpty - ⮩ ୥ ⠫
1218++A7A1 ~            ;       a=errFileExist
1219++A7A1 ~            ;       a=errDiskNoSpace
1220++A7A1 ~            ;       a=errNumTooBig - ᫨誮 让 ࠧ
1221++A7A1 ~            ;     cy=0  ᥭ  ⫮
1222++A7A1 ~            ;
1223++A7A1 ~            ;fatCreateDIR
1224++A7A1 ~            ;
1225++A7A1 ~            	ld	hl,#0000
1226++A7A1 ~            	jr	fatCreateDIRlfn
1227++A7A1 ~            	org	$-2
1228++A7A1              	endif
1229++A7A1
1230++A7A1
1231++A7A1              fatCreateDIRlfn		ifused
1232++A7A1 ~            ;ᮧ ⠫     ⥪饬 FAT32 ⠫
1233++A7A1 ~            ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType=1
1234++A7A1 ~            ;:  ix -   fcb
1235++A7A1 ~            ;     hl -  ப     ଠ ASCIIZ
1236++A7A1 ~            ;       =#0000 ᯮ짮 ⪮   fcb
1237++A7A1 ~            ;
1238++A7A1 ~            ;fatCreateDIRlfn
1239++A7A1 ~            ;
1240++A7A1 ~            ;fcbSize=#00000000
1241++A7A1 ~            	push	hl
1242++A7A1 ~            	call	SetZeroDEHL
1243++A7A1 ~            	call	DEHL2fcbSize
1244++A7A1 ~            	pop	hl
1245++A7A1 ~
1246++A7A1 ~            ;ᮧ  ⠫   
1247++A7A1 ~            	call	fatCreateFileLFN
1248++A7A1 ~            	ret	c
1249++A7A1 ~
1250++A7A1 ~            ;⨬  ⠫
1251++A7A1 ~            	call	LD_DEHL_fcbClsFile
1252++A7A1 ~            	push	ix
1253++A7A1 ~            	ld	ix,Buf4MBR
1254++A7A1 ~            	call	fatClearCls
1255++A7A1 ~            	pop	ix
1256++A7A1 ~            	ret	c
1257++A7A1 ~
1258++A7A1 ~            ;ᮧ  ⮬ ⠫   뫪  ᥡ
1259++A7A1 ~            ;  ᪮㥬 fcb  ६ 
1260++A7A1 ~            	push	ix
1261++A7A1 ~            	pop	hl
1262++A7A1 ~            	ld	de,tmp_fcb
1263++A7A1 ~            	push	de
1264++A7A1 ~            	ld	bc,#0020
1265++A7A1 ~            	ldir
1266++A7A1 ~            	ex	(sp),ix
1267++A7A1 ~            ;  ⠭  
1268++A7A1 ~            	ld	hl,tmp_fcb
1269++A7A1 ~            	ld	(hl),"."
1270++A7A1 ~            	ld	b,#0B-1
1271++A7A1 ~            loop029	inc	hl
1272++A7A1 ~            	ld	(hl),#20
1273++A7A1 ~            	djnz	loop029
1274++A7A1 ~            ;  뫪  ᥡ
1275++A7A1 ~            	call	fcbClsFile2fcbClsDIR
1276++A7A1 ~            	call	addFileEntry
1277++A7A1 ~            	jr	c,goto049
1278++A7A1 ~
1279++A7A1 ~            ;ᮧ  ⮬ ⠫   뫪  த⥫
1280++A7A1 ~            	ld	(ix+fcbName+1),"."
1281++A7A1 ~            	pop	hl
1282++A7A1 ~            	push	hl		; fcb
1283++A7A1 ~            	ld	bc,fcbClsDIR
1284++A7A1 ~            	add	hl,bc		; fcbClsDIR
1285++A7A1 ~            	ld	de,RootClaster
1286++A7A1 ~            	call	cmp_adrDE_adrHL
1287++A7A1 ~            	ld	de,tmp_fcb+fcbClsFile
1288++A7A1 ~            	call	nz,CopyDWORD_HL_DE
1289++A7A1 ~            	call	SetZeroDEHL
1290++A7A1 ~            	call	z,DEHL2fcbClsFile
1291++A7A1 ~            	call	addFileEntry
1292++A7A1 ~            goto049	pop	ix
1293++A7A1 ~            	ret
1294++A7A1 ~
1295++A7A1              	endif
1296++A7A1
1297++A7A1              ;------------------------------------------------------------------------------
1298++A7A1              fatFindEntryDir	ifused
1299++A7A1              ;   ⥪饬 ⠫    ଠ name[.][ext]\
1300++A7A1              ;     ஢७  ॢ  孨 ॣ
1301++A7A1              ;:  hl -    ଠ name[.][ext]\ (  ଠ 8+3)
1302++A7A1              ;: cy=1 訡 ⥭/
1303++A7A1              ;       a=errRWnum
1304++A7A1              ;       a=errInvalidPart
1305++A7A1              ;       a=errEoF - 䠩 ࢠ
1306++A7A1              ;       a=errFileEmpty - ⮩ ୥ ⠫
1307++A7A1              ;       hl -  ᫥饣   
1308++A7A1              ;       bc -    ⠫  ன ࢠ 
1309++A7A1              ;     nc, z  
1310++A7A1              ;       hl -  ᫥饣    (㪠뢠  "\")
1311++A7A1              ;       de -  ਯ  
1312++A7A1              ;       bc -  ஢塞   ⠫
1313++A7A1              ;       (DescInCurrDir) -  ᫥   ⠫
1314++A7A1              ;     nc, nz   
1315++A7A1              ;       hl -  ᫥饣   
1316++A7A1              ;       bc -  ᫥   ⠫
1317++A7A1              ;       (DescInCurrDir) -  ᫥   ⠫
1318++A7A1              ;
1319++A7A1              ;fatFindEntryDir
1320++A7A1              ;
1321++A7A1              ;ନ㥬  䠩  ᪠  ⠫
1322++A7A1 11 25 8D     	ld	de,Name4Find
1323++A7A4 CD A8 B1     	call	FileNameTo8dot3	;hl -  ᫥饣   
1324++A7A7
1325++A7A7              ;⠥  ᥪ  ஢塞 稥 䨪஢ 
1326++A7A7 E5           	push	hl
1327++A7A8 48           	ld	c,b		;bc=#0000  ⥪饩   ⠫
1328++A7A9 CD 25 A8     	call	ReadSectorDIR	;⥭ ᥪ ⠫     
1329++A7AC 38 53        	jr	c,goto065	;訡
1330++A7AE CD 19 A8     	call	CP_OneDot	;hl=Buf4DIR
1331++A7B1 28 04        	jr	z,loop028	; ࢠ  "."
1332++A7B3 7E           	ld	a,(hl)
1333++A7B4 B7           	or	a
1334++A7B5              ;	ld	a,errFileEmpty	;⮩ ⠫ (   ⮫쪮 ୥)
1335++A7B5              ;	jr	z,goto065
1336++A7B5 28 4E        	jr	z,goto129
1337++A7B7
1338++A7B7
1339++A7B7              ;ᥪ 㦥, 饬 ᮢ   
1340++A7B7 C5           loop028	push	bc		; 
1341++A7B8 0E 00        	ld	c,#00		;   ᥪ
1342++A7BA 11 0B 00     loop027	ld	de,#000B
1343++A7BD 19           	add	hl,de
1344++A7BE 7E           	ld	a,(hl)		;ਡ
1345++A7BF ED 52        	sbc	hl,de
1346++A7C1 5E           	ld	e,(hl)		; ᨬ 
1347++A7C2 FE 0F        	cp	#0F
1348++A7C4 28 23        	jr	z,goto066	;   
1349++A7C6 FE 08        	cp	#08
1350++A7C8 28 1F        	jr	z,goto066	;Volume ID
1351++A7CA 7B           	ld	a,e
1352++A7CB B7           	or	a
1353++A7CC 28 36        	jr	z,goto067	; .  稫
1354++A7CE FE E5        	cp	#E5
1355++A7D0 28 17        	jr	z,goto066	;㤠 
1356++A7D2              ;  ࠢ     Name4Find
1357++A7D2              ;  hl -  ਯ  
1358++A7D2 11 25 8D     	ld	de,Name4Find
1359++A7D5 06 0B        	ld	b,#0B
1360++A7D7 E5           	push	hl
1361++A7D8 1A           loop026	ld	a,(de)		;ॢ  孨 ॣ
1362++A7D9 BE           	cp	(hl)
1363++A7DA 20 0C        	jr	nz,goto068
1364++A7DC 13           	inc	de
1365++A7DD 23           	inc	hl
1366++A7DE 10 F8        	djnz	loop026
1367++A7E0              ;   
1368++A7E0 D1           	pop	de		; ਯ  
1369++A7E1 E1           	pop	hl		; ஢塞   ⠫
1370++A7E2 09           	add	hl,bc		;+   ᥪ
1371++A7E3 4D           	ld	c,l
1372++A7E4 44           	ld	b,h		;    ⠫
1373++A7E5 AF           	xor	a		;nc z
1374++A7E6 18 1F        	jr	goto183
1375++A7E8              ;  ᫥   ᥪ
1376++A7E8 E1           goto068	pop	hl
1377++A7E9 11 20 00     goto066	ld	de,#0020
1378++A7EC 19           	add	hl,de
1379++A7ED 0C           	inc	c
1380++A7EE 79           	ld	a,c
1381++A7EF FE 10        	cp	#10
1382++A7F1 38 C7        	jr	c,loop027
1383++A7F3
1384++A7F3
1385++A7F3              ;  ᥪ  , 㧨 ᫥騩 ᥪ
1386++A7F3 E1           	pop	hl
1387++A7F4 42           	ld	b,d
1388++A7F5 09           	add	hl,bc
1389++A7F6 4D           	ld	c,l
1390++A7F7 44           	ld	b,h		; ࢮ   ᫥饬 ᥪ
1391++A7F8 CD 25 A8     	call	ReadSectorDIR
1392++A7FB 30 BA        	jr	nc,loop028
1393++A7FD FE 71        	cp	errEoF
1394++A7FF 28 04        	jr	z,goto129
1395++A801
1396++A801
1397++A801              ;訡 ⥭/  㣠
1398++A801 E1           goto065	pop	hl
1399++A802 37           	scf
1400++A803 C9           	ret
1401++A804
1402++A804
1403++A804              ;nc, nz   
1404++A804 C1           goto067	pop	bc
1405++A805 AF           goto129	xor	a
1406++A806 3C           	inc	a		;nc, nz
1407++A807 E1           goto183	pop	hl
1408++A808 ED 43 04 8D  	ld	(DescInCurrDir),bc
1409++A80C C9           	ret
1410++A80D
1411++A80D              	endif
1412++A80D
1413++A80D              ;------------------------------------------------------------------------------
1414++A80D              CP_TwoDot	ifused
1415++A80D              ;஢ઠ  䠩   窨 (뫪  த⥫)
1416++A80D              ;:  hl -  砫  䠩
1417++A80D              ;: nz -  ᮢ
1418++A80D              ;      z -    -> a=#00, nc
1419++A80D              ;
1420++A80D              ;CP_TwoDot
1421++A80D              ;
1422++A80D 7E           	ld	a,(hl)
1423++A80E FE 2E        	cp	"."
1424++A810 C0           	ret	nz
1425++A811 23           	inc	hl
1426++A812 7E           	ld	a,(hl)
1427++A813 2B           	dec	hl
1428++A814 FE 2E        	cp	"."
1429++A816 C0           	ret	nz
1430++A817 AF           	xor	a
1431++A818 C9           	ret
1432++A819
1433++A819              	endif
1434++A819
1435++A819              ;------------------------------------------------------------------------------
1436++A819              CP_OneDot	ifused
1437++A819              ;஢ઠ  䠩   窠 (뫪  ᥡ)
1438++A819              ;:  hl -  砫  䠩
1439++A819              ;: nz -  ᮢ
1440++A819              ;      z -  ࢠ  -> a=#00, nc
1441++A819              ;
1442++A819              ;CP_OneDot
1443++A819              ;
1444++A819 7E           	ld	a,(hl)
1445++A81A FE 2E        	cp	"."
1446++A81C C0           	ret	nz
1447++A81D 23           	inc	hl
1448++A81E 7E           	ld	a,(hl)
1449++A81F 2B           	dec	hl
1450++A820 FE 20        	cp	" "
1451++A822 C0           	ret	nz
1452++A823 AF           	xor	a
1453++A824 C9           	ret
1454++A825
1455++A825              	endif
1456++A825
1457++A825              ;------------------------------------------------------------------------------
1458++A825              ReadSectorDIR	ifused
1459++A825              ;⥭ ᥪ ⠫     
1460++A825              ;:  bc -    ⠫
1461++A825              ;: cy=1 訡 ⥭/
1462++A825              ;       a=errRWnum
1463++A825              ;       a=errInvalidPart
1464++A825              ;       a=errEoF - 䠩 ࢠ
1465++A825              ;     cy=0 ᥪ ⠭
1466++A825              ;       hl=Buf4DIR
1467++A825              ;     bc  
1468++A825              ;     hl',de',bc' - ???
1469++A825              ;
1470++A825              ;ReadSectorDIR
1471++A825              ;
1472++A825 C5           	push	bc
1473++A826 60           	ld	h,b
1474++A827 69           	ld	l,c
1475++A828 11 00 00     	ld	de,#0000
1476++A82B 3E 10        	ld	a,#10
1477++A82D CD A7 B3     	call	SRL_dehl_A	;dehl=dehl/32
1478++A830 7D           	ld	a,l		;ᬥ饭  ᥪ  砫 ⠫
1479++A831 F5           	push	af
1480++A832 3A EE 8C     	ld	a,(LenCLSInSec)	;ࠧ   ᥪ
1481++A835 F5           	push	af
1482++A836 CD A7 B3     	call	SRL_dehl_A	;hl ᬥ饭    砫 ⠫
1483++A839 4D           	ld	c,l
1484++A83A 44           	ld	b,h
1485++A83B ED 5B FE 8C  	ld	de,(CLS_CurrDir+2)
1486++A83F 2A FC 8C     	ld	hl,(CLS_CurrDir);dehl  ࢮ  ⠫
1487++A842 CD B3 AB     	call	FindCLSinFile	;    ᬥ饭  砫 䠩/⠫
1488++A845 38 02        	jr	c,goto059	;訡
1489++A847 20 04        	jr	nz,goto058	; 
1490++A849 C1           goto059	pop	bc		;室  訡
1491++A84A C1           	pop	bc
1492++A84B C1           	pop	bc
1493++A84C C9           	ret
1494++A84D
1495++A84D              ;  ᥪ  㧪  
1496++A84D CD D8 AE     goto058	call	GetAdrRealSector
1497++A850 F1           	pop	af		;dehl -  ᥪ
1498++A851              				;a - ࠧ   ᥪ
1499++A851 3D           	dec	a
1500++A852 4F           	ld	c,a
1501++A853 F1           	pop	af		;ᬥ饭  ᥪ  砫 ⠫
1502++A854 A1           	and	c
1503++A855 4F           	ld	c,a
1504++A856 06 00        	ld	b,#00		;ᬥ饭  
1505++A858 09           	add	hl,bc
1506++A859 EB           	ex	de,hl
1507++A85A 48           	ld	c,b
1508++A85B ED 4A        	adc	hl,bc
1509++A85D EB           	ex	de,hl		;dehl -  ᥪ  ਯ஬ 䠩
1510++A85E CD DF B0     	call	LoadSecDIR2Buf
1511++A861 C1           	pop	bc
1512++A862 C9           	ret
1513++A863
1514++A863              	endif
1515++A863
1516++A863              ;------------------------------------------------------------------------------
1517++A863              fatSetTmpDir	ifused
1518++A863 ~            ;⠭ ६ ⥪饩 ४ਨ
1519++A863 ~            ;:  hl -  砫 ਯ
1520++A863 ~            ;: hl,bc,a - ???
1521++A863 ~            ;
1522++A863 ~            ;fatSetTmpDir
1523++A863 ~            ;
1524++A863 ~            	push	de
1525++A863 ~            	ld	de,#0014
1526++A863 ~            	add	hl,de
1527++A863 ~            	ld	c,(hl)
1528++A863 ~            	inc	hl
1529++A863 ~            	ld	b,(hl)		;  (襥 ᫮)
1530++A863 ~            	ld	e,#05
1531++A863 ~            	add	hl,de
1532++A863 ~            	ld	e,(hl)
1533++A863 ~            	inc	hl
1534++A863 ~            	ld	d,(hl)		;  (襥 ᫮)
1535++A863 ~            	ld	a,b
1536++A863 ~            	or	c
1537++A863 ~            	or	d
1538++A863 ~            	or	e
1539++A863 ~            	jr	nz,goto056
1540++A863 ~            	ld	de,(RootClaster);訡   . 室  ७
1541++A863 ~            	ld	bc,(RootClaster+2)
1542++A863 ~            goto056	ld	(CLS_CurrDir),de
1543++A863 ~            	ld	(CLS_CurrDir+2),bc
1544++A863 ~            	pop	de
1545++A863 ~            	ret
1546++A863 ~
1547++A863              	endif
1548++A863
1549++A863              ;==============================================================================
1550++A863
# file closed: Drivers/DrvFAT/DrvFAT.dir.a80
 132+ A863              	INCLUDE	"DrvFAT.file.a80"
# file opened: Drivers/DrvFAT/DrvFAT.file.a80
   1++A863              ;楤  FAT Driver.   䠩  ⠫
   2++A863              ;䠩 DrvFAT.file.a80
   3++A863              ;
   4++A863              ;addBytesToFile		㢥祭 ࠧ 䠩   ⢮ 
   5++A863              ;fatCreateFile		ᮧ 䠩  ⥪饬 FAT32 ࠧ
   6++A863              ;fatCreateFileLFN	ᮧ 䠩     ⥪饬 FAT32 ࠧ
   7++A863              ;fatAddFileEntry	  ⠫   /⪨  䠩
   8++A863              ;addFileEntrysLFN	  ⠫ ᥩ    䠩
   9++A863              ;addFileEntry		  ⠫ 䠩
  10++A863              ;findFreeDirEntry	 ⮩   ⠫
  11++A863              ;newFileFreeSpace	ᮧ 楯窨 ஢   ⢮ 
  12++A863              ;addFileFreeSpace	  ⢠   楯窥 ஢
  13++A863              ;fatAddFreeSpace_var	  楯 ஢  ⢠
  14++A863              ;			஢
  15++A863              ;fatAddFreeSpace_dehl	  楯 ஢  ⢠
  16++A863              ;			஢
  17++A863              ;WriteSectorHDD		 ᥪ  
  18++A863              ;ReadSectorHDD		⥭ ᥪ  
  19++A863              ;CalcAdrSecInMountFile	 LBA  ᥪ    ਬ஢ 䠩 (.trd)
  20++A863              ;CalcAdrSecInFile	 LBA  ᥪ 䠩  
  21++A863              ;FindCLSinFile		    ᬥ饭  砫 䠩/⠫
  22++A863              ;
  23++A863              ;------------------------------------------------------------------------------
  24++A863              addBytesToFile	ifused
  25++A863              ;㢥祭 ࠧ 䠩   ⢮ 
  26++A863              ;:  ix -   fcb
  27++A863              ;     dehl - 稭  ,    㢥 ࠧ 䠩
  28++A863              ;: cy=1 訡
  29++A863              ;        a=errNumTooBig - ᫨誮 让 ࠧ,  #FFFF ஢
  30++A863              ;        a=errRWnum -  訡
  31++A863              ;        a=errFileEmpty - 㫥 ࠧ 䠩
  32++A863              ;        a=errDiskNoSpace
  33++A863              ;        a=errInvalidPart
  34++A863              ;        a=errEoF - 䠩 ࢠ
  35++A863              ;        a=errFileNotFound
  36++A863              ;
  37++A863              ;addBytesToFile
  38++A863              ;
  39++A863              ;⠥ ᢮   ᫥  䠩
  40++A863 D5           	push	de
  41++A864 E5           	push	hl
  42++A865 CD 0A AD     	call	LD_DEHL_fcbSize
  43++A868 CD F1 B2     	call	sizeBytes2Cls	;bc ⢮   ᫥  䠩
  44++A86B 30 29        	jr	nc,goto097
  45++A86D C2 07 A9     	jp	nz,goto104	;᫨誮  ஢ 塞
  46++A870              ;  䠩 ⮩, 塞  ࠧ
  47++A870              ;	call	FindFreeClsRoot
  48++A870 CD 03 AF     	call	FindFreeClsFSinfo
  49++A873 DA 07 A9     	jp	c,goto104
  50++A876 3E 49         	ld	a,errDiskNoSpace
  51++A878 CA 07 A9     	jp	z,goto104
  52++A87B CD F8 AC     	call	DEHL2fcbClsFile
  53++A87E E1           	pop	hl
  54++A87F D1           	pop	de
  55++A880 D5           	push	de
  56++A881 E5           	push	hl
  57++A882 CD 9E AA     	call	newFileFreeSpace
  58++A885 30 69        	jr	nc,goto098	;  ᯥ譮
  59++A887 FE 49        	cp	errDiskNoSpace
  60++A889 20 7C        	jr	nz,goto104
  61++A88B CD 8A AF     	call	FreeClsChain	;᢮ ࠭ ⮩ 楯窨
  62++A88E CD 37 B3     	call	SetZeroDEHL
  63++A891 CD F8 AC     	call	DEHL2fcbClsFile
  64++A894 18 6A        	jr	goto103
  65++A896              ;  ⠥ ⮥ ⮢ ᫥  䠩
  66++A896 78           goto097	ld	a,b
  67++A897 B1           	or	c
  68++A898              ;	jr	z,goto098	; ᫥   
  69++A898 28 0C        	jr	z,goto177	; ᫥   
  70++A89A 3A EE 8C     	ld	a,(LenCLSInSec)
  71++A89D 67           	ld	h,a
  72++A89E 2E 00        	ld	l,#00
  73++A8A0 29           	add	hl,hl		;hl ࠧ    0=65536
  74++A8A1 B7           	or	a
  75++A8A2 ED 42        	sbc	hl,bc		;hl ᢮   ᫥  䠩
  76++A8A4 44           	ld	b,h
  77++A8A5 4D           	ld	c,l		;bc ᢮   ᫥  䠩
  78++A8A6 E1           goto177	pop	hl
  79++A8A7 D1           	pop	de
  80++A8A8
  81++A8A8              ;஢ਬ    
  82++A8A8 D5           	push	de
  83++A8A9 E5           	push	hl
  84++A8AA B7           	or	a
  85++A8AB ED 42        	sbc	hl,bc
  86++A8AD 30 01        	jr	nc,goto099
  87++A8AF 1B           	dec	de
  88++A8B0 7A           goto099	ld	a,d
  89++A8B1 A3           	and	e
  90++A8B2 3C           	inc	a
  91++A8B3 28 3B        	jr	z,goto098	;   
  92++A8B5 7C           	ld	a,h
  93++A8B6 B5           	or	l
  94++A8B7 B3           	or	e
  95++A8B8 B2           	or	d
  96++A8B9 28 35        	jr	z,goto098	;   
  97++A8BB              ;dehl 稭  ,    䠪᪨ 㢥 ࠧ 䠩
  98++A8BB              ;      
  99++A8BB
 100++A8BB              ; 楯窨 ஢  饩 楯窥
 101++A8BB              ;  ⠥ ᪮쪮 ஢  
 102++A8BB CD F1 B2     	call	sizeBytes2Cls	;᫥ ࠧ  
 103++A8BE 38 47        	jr	c,goto104
 104++A8C0              ;  ।  ᫥  䠩
 105++A8C0 E5           	push	hl
 106++A8C1 CD 0F AD     	call	LD_DEHL_fcbClsFile
 107++A8C4 E5           loop041	push	hl
 108++A8C5 D5           	push	de
 109++A8C6 CD 55 B0     	call	ReadFATnextCls	;dehl  ᫥饣 
 110++A8C9 38 39        	jr	c,goto102
 111++A8CB CD 42 B0     	call	TestLastCLS
 112++A8CE 38 04        	jr	c,goto100
 113++A8D0 C1           	pop	bc
 114++A8D1 C1           	pop	bc
 115++A8D2 18 F0        	jr	loop041
 116++A8D4 D1           goto100	pop	de
 117++A8D5 E1           	pop	hl		;dehl  ᫥ 
 118++A8D6 C1           	pop	bc		;bc 塞 ⢮ ஢
 119++A8D7              ;  塞 楯 ஢
 120++A8D7 D5           	push	de
 121++A8D8 E5           	push	hl
 122++A8D9 CD B5 AA     	call	fatAddFreeSpace_dehl
 123++A8DC E1           	pop	hl
 124++A8DD D1           	pop	de
 125++A8DE 30 10        	jr	nc,goto098	;訡  뫮
 126++A8E0 FE 49        	cp	errDiskNoSpace
 127++A8E2 20 23        	jr	nz,goto104
 128++A8E4              ;   ᢮ . ᢮  楯
 129++A8E4 D5           	push	de
 130++A8E5 E5           	push	hl
 131++A8E6 CD 8A AF     	call	FreeClsChain	;᢮ ࠭ ⮩ 楯窨
 132++A8E9 E1           	pop	hl
 133++A8EA D1           	pop	de
 134++A8EB CD EB AF     	call	SetLastClsInFAT
 135++A8EE 18 10        	jr	goto103
 136++A8F0
 137++A8F0              ; ࠧ 䠩    ⠫
 138++A8F0 CD 0A AD     goto098 call	LD_DEHL_fcbSize
 139++A8F3 C1           	pop	bc
 140++A8F4 09           	add	hl,bc
 141++A8F5 C1           	pop	bc
 142++A8F6 EB           	ex	de,hl
 143++A8F7 ED 4A        	adc	hl,bc
 144++A8F9 EB           	ex	de,hl
 145++A8FA CD EB AC     	call	DEHL2fcbSize
 146++A8FD              ;     ⠫
 147++A8FD C3 DB AB     	jp	fcbWriteToEntry
 148++A900
 149++A900              ;室  訡
 150++A900 3E 49        goto103	ld	a,errDiskNoSpace
 151++A902 18 03        	jr	goto104
 152++A904 D1           goto102	pop	de
 153++A905 D1           	pop	de
 154++A906 C1           	pop	bc
 155++A907 E1           goto104	pop	hl
 156++A908 D1           	pop	de
 157++A909 37           	scf
 158++A90A C9           	ret
 159++A90B
 160++A90B              	endif
 161++A90B
 162++A90B              ;------------------------------------------------------------------------------
 163++A90B              fatCreateFile	ifused
 164++A90B              ;ᮧ 䠩  ⥪饬 FAT32 ࠧ
 165++A90B              ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType
 166++A90B              ;  fcbSize
 167++A90B              ;:  ix -   fcb
 168++A90B              ;: cy=1 뫨 訡
 169++A90B              ;       a=errRWnum
 170++A90B              ;       a=errInvalidPart
 171++A90B              ;       a=errEoF - 䠩 ࢠ
 172++A90B              ;       a=errFileEmpty - ⮩ ୥ ⠫
 173++A90B              ;       a=errFileExist
 174++A90B              ;       a=errDiskNoSpace
 175++A90B              ;       a=errNumTooBig - ᫨誮 让 ࠧ
 176++A90B              ;       a=errInvFileName 䠩  ⠪  /⮥ 
 177++A90B              ;     cy=0  ᥭ  ⠫
 178++A90B              ;
 179++A90B              ;fatCreateFile
 180++A90B              ;
 181++A90B 21 00 00     	ld	hl,#0000
 182++A90E 18 FE        	jr	fatCreateFileLFN
 183++A910              	org	$-2
 184++A90E              	endif
 185++A90E
 186++A90E
 187++A90E              fatCreateFileLFN	ifused
 188++A90E              ;ᮧ 䠩     ⥪饬 FAT32 ࠧ
 189++A90E              ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType=1
 190++A90E              ;  fcbSize
 191++A90E              ;:  ix -   fcb
 192++A90E              ;     hl -  ப     ଠ ASCIIZ
 193++A90E              ;       =#0000 ᯮ짮 ⪮   fcb
 194++A90E              ;
 195++A90E              ;fatCreateFileLFN
 196++A90E              ;
 197++A90E E5           	push	hl
 198++A90F 7C           	ld	a,h
 199++A910 B5           	or	l
 200++A911 20 0C        	jr	nz,goto172
 201++A913
 202++A913              ;஢ઠ ⢮ 䠩
 203++A913 DD E5        	push	ix
 204++A915 E1           	pop	hl
 205++A916 CD A1 A7     	call	fatFindEntryDir
 206++A919              ;	call	fcbFindEntry		; 䠩  ⠫
 207++A919 38 38        	jr	c,error1		;訡
 208++A91B 3E 73        	ld	a,errFileExist
 209++A91D 28 34        	jr	z,error1		;䠩  ⠪  
 210++A91F
 211++A91F              ; ᢮ 
 212++A91F CD 03 AF     goto172	call	FindFreeClsFSinfo
 213++A922              ;	call	FindFreeClsRoot
 214++A922 38 2F        	jr	c,error1		;訡
 215++A924 3E 49        	ld	a,errDiskNoSpace
 216++A926 28 2B        	jr	z,error1
 217++A928 CD F8 AC     	call	DEHL2fcbClsFile
 218++A92B
 219++A92B              ;१ࢨ㥬 楯 ஢
 220++A92B DD CB 1E 66  	bit	4,(ix+fcbType)
 221++A92F 28 0A        	jr	z,goto072		;ᮧ 䠩
 222++A931              ;  ᮧ ⠫ ࠧ 1 
 223++A931 2A EE 8C     	ld	hl,(LenCLSInSec)
 224++A934 26 00        	ld	h,#00
 225++A936 54           	ld	d,h
 226++A937 29           	add	hl,hl
 227++A938 5C           	ld	e,h
 228++A939 65           	ld	h,l
 229++A93A 6A           	ld	l,d
 230++A93B CC 0A AD     goto072	call	z,LD_DEHL_fcbSize
 231++A93E CD 9E AA     	call	newFileFreeSpace
 232++A941 30 1B        	jr	nc,goto071
 233++A943 FE 75        	cp	errFileEmpty
 234++A945 28 0F        	jr	z,goto070		; 㫥 ࠧ 䠩
 235++A947 FE 49        	cp	errDiskNoSpace
 236++A949 20 08        	jr	nz,error1
 237++A94B F5           goto069	push	af
 238++A94C CD 0F AD     	call	LD_DEHL_fcbClsFile
 239++A94F CD 8A AF     	call	FreeClsChain		;᢮ ࠭ ⮩ 楯窨
 240++A952 F1           	pop	af
 241++A953 E1           error1	pop	hl
 242++A954 37           	scf
 243++A955 C9           	ret
 244++A956              ;  䠩 㫥 
 245++A956 21 00 00     goto070	ld	hl,#0000
 246++A959 5D           	ld	e,l
 247++A95A 55           	ld	d,l
 248++A95B CD F8 AC     	call	DEHL2fcbClsFile
 249++A95E
 250++A95E              ;ᮧ   ⠫
 251++A95E E1           goto071	pop	hl
 252++A95F E5           	push	hl
 253++A960 CD 67 A9     	call	fatAddFileEntry
 254++A963 38 E6        	jr	c,goto069
 255++A965 E1           	pop	hl
 256++A966 C9           	ret
 257++A967 ~            /*뫮
 258++A967 ~            	push	hl
 259++A967 ~            	ld	a,h
 260++A967 ~            	or	l
 261++A967 ~            	jr	z,goto173
 262++A967 ~            	call	addFileEntrysLFN
 263++A967 ~            	jr	goto174
 264++A967 ~            goto173	call	addFileEntry
 265++A967 ~            goto174	jr	c,goto069
 266++A967 ~            	pop	hl
 267++A967 ~            	ret
 268++A967 ~            */
 269++A967              	endif
 270++A967
 271++A967              ;------------------------------------------------------------------------------
 272++A967              fatAddFileEntry	ifused
 273++A967              ;  ⠫   /⪨  䠩
 274++A967              ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType
 275++A967              ;  fcbClsFile, fcbSize
 276++A967              ;:  ix -   fcb
 277++A967              ;     hl -  ப     ଠ ASCIIZ
 278++A967              ;       =#0000 䠩  ⪨   fcb (fcbName, fcbExt   ⠭)
 279++A967              ;:   fcb ⠭   ७  ᭮  
 280++A967              ;     cy=1 訡 ⥭/
 281++A967              ;       a=errRWnum
 282++A967              ;       a=errInvalidPart
 283++A967              ;       a=errEoF - 䠩 ࢠ
 284++A967              ;       a=errFileEmpty - ⮩ ୥ ⠫
 285++A967              ;       a=errInvFileName 䠩  ⠪  /⮥ 
 286++A967              ;       a=errDiskNoSpace
 287++A967              ;     cy=0  ᥭ  ⫮
 288++A967              ;
 289++A967              ;fatAddFileEntry
 290++A967              ;
 291++A967 7C           	ld	a,h
 292++A968 B5           	or	l
 293++A969 28 68        	jr	z,addFileEntry
 294++A96B 18 FE        	jr	addFileEntrysLFN
 295++A96D              	org	$-2
 296++A96B
 297++A96B              	endif
 298++A96B
 299++A96B              ;------------------------------------------------------------------------------
 300++A96B              addFileEntrysLFN	ifused
 301++A96B              ;  ⠫ ᥩ    䠩
 302++A96B              ;  ᭮   ⪨  ⮦ 
 303++A96B              ;   fcb   ⠭: fcbClsDIR, bit4 fcbType, fcbClsFile, fcbSize
 304++A96B              ;:  ix -   fcb
 305++A96B              ;     hl -  ப     ଠ ASCIIZ
 306++A96B              ;:   fcb ⠭   ७  ᭮  
 307++A96B              ;     cy=1 訡 ⥭/
 308++A96B              ;       a=errRWnum
 309++A96B              ;       a=errInvalidPart
 310++A96B              ;       a=errEoF - 䠩 ࢠ
 311++A96B              ;       a=errFileEmpty - ⮩ ୥ ⠫
 312++A96B              ;       a=errInvFileName 䠩  ⠪  /⮥ 
 313++A96B              ;       a=errDiskNoSpace
 314++A96B              ;     cy=0  ᥭ  ⫮
 315++A96B              ;
 316++A96B              ;addFileEntrysLFN
 317++A96B              ;
 318++A96B              ;ନ஢ ⪮   ஢મ ⢮ 䠩
 319++A96B CD F5 A4     	call	fatSetSFNname		;b=#00
 320++A96E D8           	ret	c
 321++A96F
 322++A96F              ;⠥ 室 ⢮ ᥩ   
 323++A96F E5           	push	hl
 324++A970 05           	dec	b			;b=#FF
 325++A971 7E           loop063	ld	a,(hl)
 326++A972 04           	inc	b
 327++A973 23           	inc	hl
 328++A974 B7           	or	a
 329++A975 20 FA        	jr	nz,loop063
 330++A977 D1           	pop	de			;de -  ப   
 331++A978 78           	ld	a,b
 332++A979 B7           	or	a
 333++A97A 3E 45        	ld	a,errInvFileName
 334++A97C 37           	scf
 335++A97D C8           	ret	z			;⮥ 
 336++A97E 78           	ld	a,b			;b -  
 337++A97F 06 FF        	ld	b,#FF
 338++A981 C6 0C        	add	a,LenEntryLFN-1
 339++A983 04           loop064	inc	b
 340++A984 D6 0D        	sub	LenEntryLFN
 341++A986 30 FB        	jr	nc,loop064
 342++A988              ;de -  ப   
 343++A988              ;b - ⢮ ᥩ    (   ᫥ ) [1..20]
 344++A988              ;c - ஫쭠 㬬 
 345++A988
 346++A988              ;⠭ ਯ஢    
 347++A988 C5           	push	bc
 348++A989 21 30 8F     	ld	hl,Buf4LFN
 349++A98C E5           	push	hl
 350++A98D D5           loop065	push	de
 351++A98E C5           	push	bc
 352++A98F 05           	dec	b
 353++A990 78           	ld	a,b
 354++A991 87           	add	a,a
 355++A992 87           	add	a,a
 356++A993 4F           	ld	c,a
 357++A994 87           	add	a,a
 358++A995 81           	add	a,c
 359++A996 80           	add	a,b			;a=b*13
 360++A997 83           	add	a,e
 361++A998 5F           	ld	e,a
 362++A999 30 01        	jr	nc,goto171
 363++A99B 14           	inc	d			;de   ப   䠩
 364++A99C C1           goto171	pop	bc
 365++A99D              ;	inc	b
 366++A99D CD 8A A4     	call	lfnSetOneEntry		;⠭   LFN
 367++A9A0              ;	pop	bc
 368++A9A0 D1           	pop	de
 369++A9A1 10 EA        	djnz	loop065
 370++A9A3 E1           	pop	hl
 371++A9A4 C1           	pop	bc
 372++A9A5              ;b - ⢮ ᥩ    (   ᫥ ) [1..20]
 373++A9A5              ;c - ஫쭠 㬬 
 374++A9A5              ;hl -    ਯࠬ
 375++A9A5              ;de -  ப   
 376++A9A5
 377++A9A5              ; ਯ஢     
 378++A9A5              ;   ࢮ ⮩   ⠫ ( 㤥 ᫥   ⠫)
 379++A9A5              ;    (㤠   ஢)
 380++A9A5 CB F6        	set	6,(hl)
 381++A9A7 C5           loop066	push	bc
 382++A9A8 E5           	push	hl
 383++A9A9 CD 3C AA     	call	findFreeDirEntry
 384++A9AC DA AF AB     	jp	c,error2		;訡
 385++A9AF              ;  ⠥ ᥪ ⠫
 386++A9AF              ;loop066
 387++A9AF C5           	push	bc
 388++A9B0              	hddSetCurrSec			;⠭  LBA  ⥭
 388++A9B0 CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 389++A9B3 21 30 8D     	ld	hl,Buf4File
 390++A9B6              	hddReadSec2HL			;⠫ ᥪ
 390++A9B6 CD 0B 9B    >	call	DrvHDD.RdSecHDD_HL
 391++A9B9 D1           	pop	de			; ਯ  ⠭ ᥪ
 392++A9BA DA AF AB     	jp	c,error2		;訡
 393++A9BD 19           	add	hl,de
 394++A9BE EB           	ex	de,hl			;  ᥪ ⠫
 395++A9BF E1           	pop	hl
 396++A9C0 01 20 00     	ld	bc,#0020
 397++A9C3 ED B0        	ldir
 398++A9C5 E5           	push	hl			; ᫥饣 ਯ
 399++A9C6              ;  襬 ᥪ ⠫
 400++A9C6 21 30 8D     	ld	hl,Buf4File
 401++A9C9              	hddWriteSecHL			;ᠫ ᥪ
 401++A9C9 CD 37 9B    >	call	DrvHDD.WrSecHDD_HL
 402++A9CC DA AF AB     	jp	c,error2		;訡
 403++A9CF E1           	pop	hl
 404++A9D0 C1           	pop	bc
 405++A9D1 10 D4        	djnz	loop066
 406++A9D3
 407++A9D3              ;襬 ᭮ ਯ  ⪨ 
 408++A9D3 18 FE        	jr	addFileEntry
 409++A9D5              	org	$-2
 410++A9D3
 411++A9D3              	endif
 412++A9D3
 413++A9D3              ;------------------------------------------------------------------------------
 414++A9D3              addFileEntry	ifused
 415++A9D3              ;  ⠫ 䠩
 416++A9D3              ;   fcb   ⠭: fcbName, fcbExt, fcbClsDIR, bit4 fcbType
 417++A9D3              ;  fcbClsFile, fcbSize
 418++A9D3              ;:  ix -   fcb
 419++A9D3              ;: cy=1 뫨 訡.  訡  A
 420++A9D3              ;       a=errRWnum
 421++A9D3              ;       a=errInvalidPart
 422++A9D3              ;       a=errFileEmpty
 423++A9D3              ;       a=errDiskNoSpace
 424++A9D3              ;     cy=0  ᥭ  ⫮
 425++A9D3              ;
 426++A9D3              ;addFileEntry
 427++A9D3              ;
 428++A9D3              ; ⮩   ⠫
 429++A9D3 CD 3C AA     	call	findFreeDirEntry
 430++A9D6 D8           	ret	c		;訡
 431++A9D7
 432++A9D7              ;⠥ ᥪ ⠫
 433++A9D7 C5           	push	bc
 434++A9D8              	hddSetCurrSec		;⠭  LBA  ⥭
 434++A9D8 CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 435++A9DB 21 30 8D     	ld	hl,Buf4File
 436++A9DE              	hddReadSec2HL		;⠫ ᥪ
 436++A9DE CD 0B 9B    >	call	DrvHDD.RdSecHDD_HL
 437++A9E1 C1           	pop	bc
 438++A9E2 D8           	ret	c		;訡
 439++A9E3
 440++A9E3              ;ᨬ  ᥪ 
 441++A9E3 09           	add	hl,bc		;   
 442++A9E4 EB           	ex	de,hl
 443++A9E5 DD E5        	push	ix
 444++A9E7 E1           	pop	hl		;fcb 
 445++A9E8              ;   䠩
 446++A9E8 01 0B 00     	ld	bc,#000B
 447++A9EB ED B0        	ldir
 448++A9ED              ;  ਡ 䠩
 449++A9ED DD 7E 1E     	ld	a,(ix+fcbType)
 450++A9F0              ;	rra
 451++A9F0              ;	rra
 452++A9F0 E6 10        	and	%00010000
 453++A9F2 F6 20        	or	%00100000
 454++A9F4 12           	ld	(de),a
 455++A9F5 13           	inc	de
 456++A9F6              ;   NT
 457++A9F6 AF           	xor	a
 458++A9F7 12           	ld	(de),a
 459++A9F8 13           	inc	de
 460++A9F9 EB           	ex	de,hl
 461++A9FA              ;  ⠭ ६   ᮧ
 462++A9FA 77           	ld	(hl),a
 463++A9FB 23           	inc	hl		;ᥪ㭤    ᥪ㭤
 464++A9FC              	IFDEF	forProfROM
 465++A9FC ~            	 ld	a,(iy-#1E)	;ᥪ㭤
 466++A9FC ~            	 rlca
 467++A9FC ~            	 rlca
 468++A9FC ~            	 ld	c,(iy-#1D)	;
 469++A9FC ~            	 ld	b,#03
 470++A9FC ~            loop020	 rr	c
 471++A9FC ~            	 rra
 472++A9FC ~            	 djnz	loop020
 473++A9FC ~            	 ld	e,a
 474++A9FC ~            	 ld	(hl),a
 475++A9FC ~            	 inc	hl
 476++A9FC ~            	 ld	a,(iy-#1C)	;
 477++A9FC ~            	 rlca
 478++A9FC ~            	 rlca
 479++A9FC ~            	 rlca
 480++A9FC ~            	 or	c
 481++A9FC ~            	 ld	d,a
 482++A9FC ~            	 ld	(hl),a
 483++A9FC ~            	 inc	hl
 484++A9FC ~            	 ld	c,(iy-#1B)	;
 485++A9FC ~            	 ld	a,(iy-#1A)	;
 486++A9FC ~            	 rrca
 487++A9FC ~            	 rrca
 488++A9FC ~            	 rrca
 489++A9FC ~            	 ld	b,a
 490++A9FC ~            	 and	%11100000
 491++A9FC ~            	 or	c
 492++A9FC ~            	 ld	c,a
 493++A9FC ~            	 ld	(hl),a
 494++A9FC ~            	 inc	hl
 495++A9FC ~            	 ld	a,(iy-#19)	;
 496++A9FC ~            	 add	a,20
 497++A9FC ~            	 rr	b
 498++A9FC ~            	 rla
 499++A9FC ~            	 ld	b,a
 500++A9FC ~            	 ld	(hl),a
 501++A9FC ~            	 inc	hl
 502++A9FC              	ELSE
 503++A9FC 77           	 ld	(hl),a
 504++A9FD 23           	 inc	hl
 505++A9FE 77           	 ld	(hl),a
 506++A9FF 23           	 inc	hl
 507++AA00 77           	 ld	(hl),a
 508++AA01 23           	 inc	hl
 509++AA02 77           	 ld	(hl),a
 510++AA03 23           	 inc	hl
 511++AA04 5F           	 ld	e,a
 512++AA05 57           	 ld	d,a
 513++AA06 4F           	 ld	c,a
 514++AA07 47           	 ld	b,a
 515++AA08              	ENDIF
 516++AA08              ;   ᫥ 㯠
 517++AA08 71           	ld	(hl),c
 518++AA09 23           	inc	hl
 519++AA0A 70           	ld	(hl),b
 520++AA0B 23           	inc	hl
 521++AA0C              ;  襥 ᫮  ࢮ 
 522++AA0C DD 7E 0E     	ld	a,(ix+fcbClsFile+2)
 523++AA0F 77           	ld	(hl),a
 524++AA10 23           	inc	hl
 525++AA11 DD 7E 0F     	ld	a,(ix+fcbClsFile+3)
 526++AA14 77           	ld	(hl),a
 527++AA15 23           	inc	hl
 528++AA16              ;  ६   ᫥  䠩
 529++AA16 73           	ld	(hl),e
 530++AA17 23           	inc	hl
 531++AA18 72           	ld	(hl),d
 532++AA19 23           	inc	hl
 533++AA1A 71           	ld	(hl),c
 534++AA1B 23           	inc	hl
 535++AA1C 70           	ld	(hl),b
 536++AA1D 23           	inc	hl
 537++AA1E              ;  襥 ᫮  ࢮ 
 538++AA1E DD 7E 0C     	ld	a,(ix+fcbClsFile)
 539++AA21 77           	ld	(hl),a
 540++AA22 23           	inc	hl
 541++AA23 DD 7E 0D     	ld	a,(ix+fcbClsFile+1)
 542++AA26 77           	ld	(hl),a
 543++AA27 23           	inc	hl
 544++AA28              ;  ࠧ 䠩
 545++AA28 DD E5        	push	ix
 546++AA2A E3           	ex	(sp),hl
 547++AA2B 11 14 00     	ld	de,fcbSize
 548++AA2E 19           	add	hl,de
 549++AA2F D1           	pop	de
 550++AA30 01 04 00     	ld	bc,#0004
 551++AA33 ED B0        	ldir
 552++AA35
 553++AA35              ;襬 ᥪ ⠫
 554++AA35 21 30 8D     	ld	hl,Buf4File
 555++AA38              	hddWriteSecHL		;ᠫ ᥪ
 555++AA38 CD 37 9B    >	call	DrvHDD.WrSecHDD_HL
 556++AA3B C9           	ret
 557++AA3C
 558++AA3C              	endif
 559++AA3C
 560++AA3C              ;------------------------------------------------------------------------------
 561++AA3C              findFreeDirEntry	ifused
 562++AA3C              ; ⮩   ⠫
 563++AA3C              ;   ४⭮    㤠   ஢
 564++AA3C              ;   fcb   ⠭: fcbClsDIR
 565++AA3C              ;:  ix -   fcb
 566++AA3C              ;: cy=1 뫨 訡.  訡  A
 567++AA3C              ;       a=errRWnum
 568++AA3C              ;       a=errInvalidPart
 569++AA3C              ;       a=errFileEmpty
 570++AA3C              ;       a=errDiskNoSpace
 571++AA3C              ;     cy=0  
 572++AA3C              ;	dehl -  ᥪ  ⮩ 
 573++AA3C              ;       bc - ᬥ饭  ᥪ
 574++AA3C              ;
 575++AA3C              ;findFreeDirEntry
 576++AA3C              ;
 577++AA3C DD E5        	push	ix
 578++AA3E
 579++AA3E              ;⠭ ࠬ஢  fcb
 580++AA3E DD E5        	push	ix
 581++AA40 E1           	pop	hl
 582++AA41 11 10 00     	ld	de,fcbClsDIR
 583++AA44 19           	add	hl,de		; ६  ஬ ࢮ  ⠫
 584++AA45 5A           	ld	e,d
 585++AA46
 586++AA46              ;⥭ ᥪ   
 587++AA46 E5           loop019	push	hl		; ६  ஬ ࢮ 
 588++AA47 D5           	push	de		;ᬥ饭  砫 ⠫  ᥪ
 589++AA48 CD 06 AB     	call	ReadSectorHDD
 590++AA4B 30 2A        	jr	nc,goto048	;ᥪ ⠭
 591++AA4D FE 71        	cp	errEoF
 592++AA4F 20 40        	jr	nz,goto046	;訡 ⥭
 593++AA51              ;   . 塞   ⠫
 594++AA51              ;	call	FindFreeClsRoot
 595++AA51 CD 03 AF     	call	FindFreeClsFSinfo
 596++AA54 38 3C        	jr	c,goto047
 597++AA56 3E 49        	ld	a,errDiskNoSpace
 598++AA58 28 37        	jr	z,goto046
 599++AA5A 22 1D 8D     	ld	(tmpDWORD),hl
 600++AA5D ED 53 1F 8D  	ld	(tmpDWORD+2),de	; ᢮ 
 601++AA61 C1           	pop	bc
 602++AA62 E3           	ex	(sp),hl
 603++AA63 D5           	push	de
 604++AA64 CD 85 B3     	call	LD_DEHL_adrHL
 605++AA67 CD C9 AF     	call	AddCls2Chain
 606++AA6A 38 26        	jr	c,goto047	;訡 ⥭/
 607++AA6C              ;  ⪠  
 608++AA6C D1           	pop	de
 609++AA6D E1           	pop	hl
 610++AA6E DD 21 30 8D  	ld	ix,Buf4File
 611++AA72 CD 9F AE     	call	fatClearCls
 612++AA75 18 24        	jr	goto050
 613++AA77              ;   ⮩   ⠭ ᥪ
 614++AA77 01 00 00     goto048	ld	bc,#0000	;ᬥ饭  ᥪ
 615++AA7A DD E5        loop017	push	ix
 616++AA7C E1           	pop	hl
 617++AA7D 09           	add	hl,bc
 618++AA7E 7E           	ld	a,(hl)
 619++AA7F B7           	or	a
 620++AA80 28 10        	jr	z,goto047	;  
 621++AA82 21 20 00     	ld	hl,#0020
 622++AA85 09           	add	hl,bc
 623++AA86 4D           	ld	c,l
 624++AA87 44           	ld	b,h
 625++AA88 CB 48        	bit	1,b
 626++AA8A 28 EE        	jr	z,loop017
 627++AA8C              ;  ⠥ ᫥騩 ᥪ ⠫
 628++AA8C D1           	pop	de
 629++AA8D E1           	pop	hl
 630++AA8E 13           	inc	de
 631++AA8F 18 B5        	jr	loop019
 632++AA91 37           goto046	scf
 633++AA92              ;  
 634++AA92 D1           goto047	pop	de
 635++AA93 E1           	pop	hl
 636++AA94 2A 19 8D     	ld	hl,(SecFileInBuf)
 637++AA97 ED 5B 1B 8D  	ld	de,(SecFileInBuf+2)
 638++AA9B DD E1        goto050	pop	ix
 639++AA9D C9           	ret
 640++AA9E
 641++AA9E              	endif
 642++AA9E
 643++AA9E ~            /* ਠ  頥묨 ⥫묨 ࠬࠬ
 644++AA9E ~            findFreeDirEntry	ifused
 645++AA9E ~            ; ⮩   ⠫
 646++AA9E ~            ;   fcb   ⠭: fcbClsDIR
 647++AA9E ~            ;:  ix -   fcb
 648++AA9E ~            ;: cy=1 뫨 訡.  訡  A
 649++AA9E ~            ;       a=errRWnum
 650++AA9E ~            ;       a=errInvalidPart
 651++AA9E ~            ;       a=errFileEmpty
 652++AA9E ~            ;       a=errDiskNoSpace
 653++AA9E ~            ;       hl,de,bc,hl',de',bc' - ???
 654++AA9E ~            ;     cy=0  
 655++AA9E ~            ;	dehl -  ᥪ  ⮩ 
 656++AA9E ~            ;       bc - ᬥ饭  ᥪ  
 657++AA9E ~            ;       a -    ⥪饬 ᥪ
 658++AA9E ~            ;       bc' - ᬥ饭  砫 ⠫  ᥪ
 659++AA9E ~            ;
 660++AA9E ~            ;findFreeDirEntry
 661++AA9E ~            ;
 662++AA9E ~            ;⠭ ࠬ஢  fcb
 663++AA9E ~            	push	ix
 664++AA9E ~            	pop	hl
 665++AA9E ~            	ld	de,fcbClsDIR
 666++AA9E ~            	add	hl,de		; ६  ஬ ࢮ  ⠫
 667++AA9E ~            	jr	findFreeEntryCurDir
 668++AA9E ~            	org	$-2
 669++AA9E ~
 670++AA9E ~            	endif
 671++AA9E ~
 672++AA9E ~
 673++AA9E ~            findFreeEntryCurDir	ifused
 674++AA9E ~            ; ⮩   ⥪饬 ⠫
 675++AA9E ~            ;ࠬ ⠪ , ஬ fcb
 676++AA9E ~            ;:  hl -  ६  ஬ ࢮ  ⠫
 677++AA9E ~            ;
 678++AA9E ~            ;findFreeEntryCurDir
 679++AA9E ~            ;
 680++AA9E ~            	push	ix
 681++AA9E ~            	ld	de,#0000
 682++AA9E ~
 683++AA9E ~            ;⥭ ᥪ   
 684++AA9E ~            loop019	push	hl		; ६  ஬ ࢮ 
 685++AA9E ~            	push	de		;ᬥ饭  砫 ⠫  ᥪ
 686++AA9E ~            	call	ReadSectorHDD
 687++AA9E ~            	jr	nc,goto048	;ᥪ ⠭
 688++AA9E ~            	cp	errEoF
 689++AA9E ~            	jr	nz,goto046	;訡 ⥭
 690++AA9E ~            ;   . 塞   ⠫
 691++AA9E ~            	call	FindFreeClsFSinfo
 692++AA9E ~            ;	call	FindFreeClsRoot
 693++AA9E ~            	jr	c,goto047
 694++AA9E ~            	ld	a,errDiskNoSpace
 695++AA9E ~            	jr	z,goto046
 696++AA9E ~            	ld	(tmpDWORD),hl
 697++AA9E ~            	ld	(tmpDWORD+2),de	; ᢮ 
 698++AA9E ~            	pop	bc		;ᬥ饭  砫 ⠫  ᥪ
 699++AA9E ~            	ex	(sp),hl
 700++AA9E ~            	push	bc
 701++AA9E ~            	push	de
 702++AA9E ~            	call	LD_DEHL_adrHL
 703++AA9E ~            	call	AddCls2Chain
 704++AA9E ~            	jr	c,goto169	;訡 ⥭/
 705++AA9E ~            ;  ⪠  
 706++AA9E ~            	pop	de
 707++AA9E ~            	pop	bc
 708++AA9E ~            	pop	hl
 709++AA9E ~            	push	bc
 710++AA9E ~            	ld	ix,Buf4File
 711++AA9E ~            	call	fatClearCls	;bc=#0000
 712++AA9E ~            	jr	c,goto170
 713++AA9E ~            	exx
 714++AA9E ~            	pop	bc		;ᬥ饭  砫 ⠫  ᥪ
 715++AA9E ~            	exx
 716++AA9E ~            	pop	hl
 717++AA9E ~            	xor	a
 718++AA9E ~            	jr	goto050
 719++AA9E ~            ;   ⮩   ⠭ ᥪ
 720++AA9E ~            goto048	xor	a
 721++AA9E ~            	ld	b,a
 722++AA9E ~            	ld	c,a		;ᬥ饭  ᥪ
 723++AA9E ~            loop017	push	ix
 724++AA9E ~            	pop	hl
 725++AA9E ~            	add	hl,bc		;nc
 726++AA9E ~            	inc	(hl)
 727++AA9E ~            	dec	(hl)
 728++AA9E ~            	jr	z,goto047	;  
 729++AA9E ~            	inc	a
 730++AA9E ~            	ld	hl,#0020
 731++AA9E ~            	add	hl,bc
 732++AA9E ~            	ld	c,l
 733++AA9E ~            	ld	b,h
 734++AA9E ~            	bit	1,b
 735++AA9E ~            	jr	z,loop017
 736++AA9E ~            ;  ⠥ ᫥騩 ᥪ ⠫
 737++AA9E ~            	pop	de
 738++AA9E ~            	pop	hl
 739++AA9E ~            	inc	de
 740++AA9E ~            	jr	loop019
 741++AA9E ~            goto169	pop	bc
 742++AA9E ~            goto046	scf
 743++AA9E ~            ;  
 744++AA9E ~            goto047	exx
 745++AA9E ~            	pop	bc		;ᬥ饭  ᥪ
 746++AA9E ~            	exx
 747++AA9E ~            goto170	pop	hl
 748++AA9E ~            	ld	hl,(SecFileInBuf)
 749++AA9E ~            	ld	de,(SecFileInBuf+2)
 750++AA9E ~            goto050	pop	ix
 751++AA9E ~            	ret
 752++AA9E ~
 753++AA9E ~            	endif
 754++AA9E ~            */
 755++AA9E              ;------------------------------------------------------------------------------
 756++AA9E              newFileFreeSpace	ifused
 757++AA9E              ;ᮧ 楯窨 ஢   ⢮ 
 758++AA9E              ;   fcb   ⠭: fcbClsFile
 759++AA9E              ;:  dehl - ࠧ  
 760++AA9E              ;     ix -  fcb 
 761++AA9E              ;: cy=1 訡
 762++AA9E              ;        a=errRWnum -  訡
 763++AA9E              ;        a=errNumTooBig - ᫨誮 让 ࠧ
 764++AA9E              ;        a=errFileEmpty - 㫥 ࠧ 䠩
 765++AA9E              ;        a=errDiskNoSpace -> bc - ⢮  뤥 ஢
 766++AA9E              ;                            dehl -  ࢮ    楯窥
 767++AA9E              ;     cy=0  ᯥ譮
 768++AA9E              ;        dehl -  ண   ᮧ 楯窥
 769++AA9E              ;
 770++AA9E              ;newFileFreeSpace
 771++AA9E              ;
 772++AA9E CD F1 B2     	call	sizeBytes2Cls	;᫥ ࠧ  
 773++AAA1 D8           	ret	c
 774++AAA2
 775++AAA2              ;   襬 ਧ  楯窨
 776++AAA2 E5           	push	hl
 777++AAA3 CD 0F AD     	call	LD_DEHL_fcbClsFile
 778++AAA6 D5           	push	de
 779++AAA7 E5           	push	hl
 780++AAA8 CD EB AF     	call	SetLastClsInFAT
 781++AAAB E1           	pop	hl
 782++AAAC D1           	pop	de
 783++AAAD C1           	pop	bc
 784++AAAE D8           	ret	c
 785++AAAF              ;dehl -  ࢮ  䠩
 786++AAAF              ;bc - ࠧ  
 787++AAAF
 788++AAAF              ;襬 ⠫ 楯, ᫨  
 789++AAAF 0B           	dec	bc
 790++AAB0 78           	ld	a,b
 791++AAB1 B1           	or	c
 792++AAB2 C8           	ret	z
 793++AAB3 18 00        	jr	fatAddFreeSpace_dehl
 794++AAB5
 795++AAB5              	endif
 796++AAB5
 797++AAB5              ;------------------------------------------------------------------------------
 798++AAB5              addFileFreeSpace	ifused
 799++AAB5 ~            ;  ⢠   饩 楯窥 ஢
 800++AAB5 ~            ;:  dehl - ࠧ  
 801++AAB5 ~            ;     (tmpDWORD) -  ᫥  楯窨
 802++AAB5 ~            ;: cy=1 訡
 803++AAB5 ~            ;        a=errRWnum -  訡
 804++AAB5 ~            ;        a=errNumTooBig - ᫨誮 让 ࠧ
 805++AAB5 ~            ;        a=errFileEmpty - 㫥 ࠧ 䠩
 806++AAB5 ~            ;        a=errDiskNoSpace -> bc - ⢮  뤥 ஢
 807++AAB5 ~            ;                            dehl -  ࢮ    楯窥
 808++AAB5 ~            ;     cy=0  ᯥ譮
 809++AAB5 ~            ;        dehl -  ࢮ    楯窥
 810++AAB5 ~            ;
 811++AAB5 ~            ;addFileFreeSpace
 812++AAB5 ~            ;
 813++AAB5 ~            	call	sizeBytes2Cls	;᫥ ࠧ  
 814++AAB5 ~            	ret	c
 815++AAB5 ~            	ld	c,l
 816++AAB5 ~            	ld	b,h
 817++AAB5 ~            	jr	fatAddFreeSpace_var
 818++AAB5 ~            	org	$-2
 819++AAB5 ~
 820++AAB5              	endif
 821++AAB5
 822++AAB5              ;------------------------------------------------------------------------------
 823++AAB5              fatAddFreeSpace_var	ifused
 824++AAB5 ~            ;  楯 ஢  ⢠ ஢
 825++AAB5 ~            ;:  bc - ⢮ ஢
 826++AAB5 ~            ;     (tmpDWORD) -  ࢮ  楯窨
 827++AAB5 ~            ;: cy=1 訡 ⥭/
 828++AAB5 ~            ;        a=errRWnum -  訡
 829++AAB5 ~            ;        a=errDiskNoSpace -> bc - ⢮  뤥 ஢
 830++AAB5 ~            ;                            dehl -  ࢮ    楯窥
 831++AAB5 ~            ;     cy=0  ᯥ譮
 832++AAB5 ~            ;        dehl -  ࢮ    楯窥
 833++AAB5 ~            ;
 834++AAB5 ~            ;fatAddFreeSpace_var
 835++AAB5 ~            ;
 836++AAB5 ~            	ld	hl,(tmpDWORD)
 837++AAB5 ~            	ld	de,(tmpDWORD+2)
 838++AAB5 ~            	jr	fatAddFreeSpace_dehl
 839++AAB5 ~            	org	$-2
 840++AAB5 ~
 841++AAB5              	endif
 842++AAB5
 843++AAB5              ;------------------------------------------------------------------------------
 844++AAB5              fatAddFreeSpace_dehl	ifused
 845++AAB5              ;  楯 ஢  ⢠ ஢
 846++AAB5              ;:  bc - ⢮ ஢
 847++AAB5              ;     dehl -  ᫥  楯窨
 848++AAB5              ;: cy=1 訡 ⥭/
 849++AAB5              ;        a=errRWnum -  訡
 850++AAB5              ;        a=errDiskNoSpace -> bc - ⢮  뤥 ஢
 851++AAB5              ;                            dehl -  ࢮ    楯窥
 852++AAB5              ;     cy=0  ᯥ譮
 853++AAB5              ;        dehl -  ࢮ    楯窥
 854++AAB5              ;
 855++AAB5              ;fatAddFreeSpace_dehl
 856++AAB5              ;
 857++AAB5              ;	call	setFsInfoEmpty		;  ࢮ ᢮ 
 858++AAB5              ;	ret	c
 859++AAB5
 860++AAB5              ; ᢮   砫 ࠧ
 861++AAB5 C5           	push	bc
 862++AAB6 D5           	push	de
 863++AAB7 E5           	push	hl
 864++AAB8 CD 03 AF     	call	FindFreeClsFSinfo	;饬 ᢮   砫 ࠧ
 865++AABB              ;	call	FindFreeClsRoot		;饬 ᢮   砫 ࠧ
 866++AABB 22 21 8D     	ld	(tmpDWORD2),hl
 867++AABE ED 53 23 8D  	ld	(tmpDWORD2+2),de	; ࢮ    楯窥
 868++AAC2 18 0B        	jr	goto038
 869++AAC4
 870++AAC4              ;塞 楯 ஢
 871++AAC4 C5           loop013	push	bc
 872++AAC5 D5           	push	de
 873++AAC6 E5           	push	hl
 874++AAC7 CD 7D B3     	call	Inc_DEHL
 875++AACA 28 30        	jr	z,goto043
 876++AACC CD 18 AF     	call	FindFreeCls		;饬 ᢮ 
 877++AACF 22 1D 8D     goto038	ld	(tmpDWORD),hl
 878++AAD2 ED 53 1F 8D  	ld	(tmpDWORD+2),de		; ᢮ 
 879++AAD6 E1           	pop	hl
 880++AAD7 D1           	pop	de			; ⥪饣 
 881++AAD8 38 2A        	jr	c,goto039		;訡 ⥭/
 882++AADA 28 22        	jr	z,goto040		; ᢮ ஢
 883++AADC CD F8 AF     	call	SetNClsInFAT
 884++AADF 38 23        	jr	c,goto039		;訡 ⥭/
 885++AAE1 2A 1D 8D     	ld	hl,(tmpDWORD)
 886++AAE4 ED 5B 1F 8D  	ld	de,(tmpDWORD+2)
 887++AAE8 C1           	pop	bc
 888++AAE9 0B           	dec	bc
 889++AAEA 78           	ld	a,b
 890++AAEB B1           	or	c
 891++AAEC 20 D6        	jr	nz,loop013
 892++AAEE CD 86 B0     	call	setFsInfoFreeCls
 893++AAF1              ;dehl -  ᫥   楯窨
 894++AAF1
 895++AAF1              ;襬  ᫥  ਧ  楯窨
 896++AAF1              ;dehl -  
 897++AAF1 CD EB AF     proc_05	call	SetLastClsInFAT
 898++AAF4 2A 21 8D     	ld	hl,(tmpDWORD2)
 899++AAF7 ED 5B 23 8D  	ld	de,(tmpDWORD2+2)
 900++AAFB C9           	ret
 901++AAFC
 902++AAFC              ; ᢮ ஢
 903++AAFC E1           goto043	pop	hl
 904++AAFD D1           	pop	de
 905++AAFE CD F1 AA     goto040	call	proc_05
 906++AB01 3E 49        	ld	a,errDiskNoSpace	;disk no space
 907++AB03 37           	scf
 908++AB04              ;訡 ⥭/
 909++AB04 C1           goto039	pop	bc
 910++AB05 C9           	ret
 911++AB06
 912++AB06              	endif
 913++AB06
 914++AB06              ;------------------------------------------------------------------------------
 915++AB06              WriteSectorHDD	ifused
 916++AB06 ~            ; ᥪ  
 917++AB06 ~            ;:  hl -  ६  ஬ ࢮ  䠩
 918++AB06 ~            ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 919++AB06 ~            ;: hl -    
 920++AB06 ~            ;     cy=1 뫨 訡.  訡  A
 921++AB06 ~            ;       a=errRWnum
 922++AB06 ~            ;       a=errInvalidPart
 923++AB06 ~            ;       a=errEoF - 䠩 ࢠ
 924++AB06 ~            ;       a=errFileEmpty
 925++AB06 ~            ;
 926++AB06 ~            ;WriteSectorHDD
 927++AB06 ~            ;
 928++AB06 ~            	call	CalcAdrSecInFile	; LBA  ᥪ 䠩  
 929++AB06 ~            					;dehl - LBA  ᥪ
 930++AB06 ~            	ret	c			;訡:   । ࠧ ᪠
 931++AB06 ~            	hddSetCurrSec			;  ⠭  ६  LBA/CHS  ᨬ  ஥
 932++AB06 ~            	ld	hl,Buf4File
 933++AB06 ~            	hddWriteSecHL			; ᥪ    
 934++AB06 ~            	ret	nc			; 訡 
 935++AB06 ~            	ld	a,errRWnum		; 訡: 訡  ⥭   ᥪ 㭪ﬨ 5  6
 936++AB06 ~            	ret
 937++AB06 ~
 938++AB06              	endif
 939++AB06
 940++AB06              ;------------------------------------------------------------------------------
 941++AB06              ReadSectorHDD	ifused
 942++AB06              ;⥭ ᥪ  
 943++AB06              ;:  hl -  ६  ஬ ࢮ  䠩
 944++AB06              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 945++AB06              ;: ix,hl -    ⥭
 946++AB06              ;     cy=1 뫨 訡.  訡  A
 947++AB06              ;       a=errRWnum
 948++AB06              ;       a=errInvalidPart
 949++AB06              ;       a=errEoF - 䠩 ࢠ
 950++AB06              ;       a=errFileEmpty
 951++AB06              ;
 952++AB06              ;ReadSectorHDD
 953++AB06              ;
 954++AB06 CD 18 AB     	call	CalcAdrSecInFile; LBA  ᥪ 䠩  
 955++AB09              				;dehl - LBA  ᥪ
 956++AB09 D8           	ret	c		;訡:   । ࠧ ᪠
 957++AB0A              	hddSetCurrSec		;  ⠭  ६  LBA/CHS  ᨬ  ஥
 957++AB0A CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 958++AB0D DD 21 30 8D  	ld	ix,Buf4File
 959++AB11              	hddReadSec2IX		;⥭ ᥪ    
 959++AB11 CD 03 9B    >	call	DrvHDD.RdSecHDD_IX
 960++AB14 D0           	ret	nc		;訡  뫮
 961++AB15 3E 50        	ld	a,errRWnum
 962++AB17 C9           	ret
 963++AB18
 964++AB18              	endif
 965++AB18
 966++AB18              ;------------------------------------------------------------------------------
 967++AB18              CalcAdrSecInMountFile	ifused		; 䏇
 968++AB18 ~            ; LBA  ᥪ    ਬ஢ 䠩 (.trd)
 969++AB18 ~            ;  ᫥ ࠡ⪨  楤 ᥪ   ⠭
 970++AB18 ~            ;:  de - ᬥ饭  砫 䠩  ᥪ (512b)
 971++AB18 ~            ;: cy=1 訡:   । ࠧ ᪠
 972++AB18 ~            ;       a=errRWnum
 973++AB18 ~            ;       a=errInvalidPart
 974++AB18 ~            ;       a=errEoF - 䠩 ࢠ
 975++AB18 ~            ;       a=errFileEmpty
 976++AB18 ~            ;     cy=0 dehl - ᬥ饭  ᥪ (512b)  砫   㦭 ᥪ
 977++AB18 ~            ;
 978++AB18 ~            ;CalcAdrSecInMountFile
 979++AB18 ~            ;
 980++AB18 ~            	ld	hl,xE590+#01	;६  ஬ ࢮ  䠩
 981++AB18 ~            	call	InitCurrMountFAT
 982++AB18 ~            	jr	goto057
 983++AB18 ~            	jr	CalcAdrSecInFile
 984++AB18 ~            	org	$-2
 985++AB18 ~
 986++AB18              	endif
 987++AB18
 988++AB18              ;------------------------------------------------------------------------------
 989++AB18              CalcAdrSecInFile	ifused
 990++AB18              ; LBA  ᥪ 䠩  
 991++AB18              ;  ᫥ ࠡ⪨  楤 ᥪ   ⠭
 992++AB18              ;:  hl -  ६  ஬ ࢮ  䠩
 993++AB18              ;     de - ᬥ饭  砫 䠩  ᥪ (512b)
 994++AB18              ;: cy=1 訡:   । ࠧ ᪠
 995++AB18              ;       a=errRWnum
 996++AB18              ;       a=errInvalidPart
 997++AB18              ;       a=errEoF - 䠩 ࢠ
 998++AB18              ;       a=errFileEmpty
 999++AB18              ;     cy=0 dehl - LBA  ᥪ
1000++AB18              ;
1001++AB18              ;CalcAdrSecInFile
1002++AB18              ;
1003++AB18 CD 19 AD     	call	InitCurrFAT	;樠 ࠧ FAT, ᫨ 㦭
1004++AB1B D8           goto057	ret	c
1005++AB1C
1006++AB1C              ; ᬥ饭  
1007++AB1C 7B           	ld	a,e
1008++AB1D 4B           	ld	c,e		;a,c -   ᬥ饭  
1009++AB1E F5           	push	af
1010++AB1F 3A EE 8C     	ld	a,(LenCLSInSec)
1011++AB22 47           	ld	b,a		;a,b - ࠧ   ᥪ
1012++AB23 F5           	push	af
1013++AB24 EB           	ex	de,hl
1014++AB25 D5           	push	de
1015++AB26 D5           	push	de
1016++AB27 11 00 00     	ld	de,#0000	;dehl ᬥ饭  ᥪ  砫 䠩
1017++AB2A CD A7 B3     	call	SRL_dehl_A	;hl ᬥ饭    砫 䠩
1018++AB2D
1019++AB2D              ;஢ઠ  㦥  ᥪ ⮣   
1020++AB2D              ;  hl - ᬥ饭    砫 䠩
1021++AB2D              ;  b  - ࠧ   ᥪ
1022++AB2D              ;  c  -   ᬥ饭  
1023++AB2D              ;
1024++AB2D              ;  ஢ਬ   䠩  ࠡ⠥
1025++AB2D E3           	ex	(sp),hl
1026++AB2E 11 12 8D     	ld	de,NumFstCluster
1027++AB31 CD 25 B3     	call	cmp_adrDE_adrHL	;ࠢ  4- ᫠  ᠬ  de  hl
1028++AB34 E1           	pop	hl
1029++AB35 20 3D        	jr	nz,goto019	;䠩 㣮
1030++AB37              ;  ஢ਬ   ஬ 䠩 ࠡ⠥
1031++AB37 ED 5B 16 8D  	ld	de,(NumCluster)	;浪    ।騬 ⠭ ᥪ஬
1032++AB3B EB           	ex	de,hl
1033++AB3C B7           	or	a
1034++AB3D ED 52        	sbc	hl,de
1035++AB3F EB           	ex	de,hl
1036++AB40 20 32        	jr	nz,goto019	;ᥪ 㣮 
1037++AB42              ;   ᬥ饭  ᥪ  ⥪饬 
1038++AB42 78           	ld	a,b
1039++AB43 3D           	dec	a
1040++AB44 A1           	and	c
1041++AB45 4F           	ld	c,a		;ᬥ饭    ᥪ
1042++AB46 3A 18 8D     	ld	a,(NumSecCls)	;浪  ᥪ   
1043++AB49 57           	ld	d,a
1044++AB4A ED 44        	neg
1045++AB4C 81           	add	a,c
1046++AB4D 4F           	ld	c,a		;ᬥ饭 ⭮⥫쭮 㦥 ᥪ
1047++AB4E 5F           	ld	e,a		;ᬥ饭 ⭮⥫쭮 㦥 ᥪ
1048++AB4F 7A           	ld	a,d		;浪  ᥪ   
1049++AB50 81           	add	a,c
1050++AB51 B8           	cp	b
1051++AB52 30 20        	jr	nc,goto019	;諨  ।  (᫮ த  ⭮)
1052++AB54              ;     ᥪ
1053++AB54 E1           	pop	hl		; ६  ஬ ࢮ  䠩
1054++AB55 32 18 8D     	ld	(NumSecCls),a	;浪  ᥪ   
1055++AB58 F1           	pop	af
1056++AB59 F1           	pop	af
1057++AB5A 7B           	ld	a,e
1058++AB5B 07           	rlca
1059++AB5C 9F           	sbc	a,a
1060++AB5D 47           	ld	b,a
1061++AB5E 4B           	ld	c,e
1062++AB5F ED 5B 1B 8D  	ld	de,(SecFileInBuf+2)
1063++AB63 2A 19 8D     	ld	hl,(SecFileInBuf)
1064++AB66 38 06        	jr	c,goto020	;⠭
1065++AB68 09           	add	hl,bc		;᫮
1066++AB69 30 34        	jr	nc,goto021
1067++AB6B 13           	inc	de
1068++AB6C 18 31        	jr	goto021
1069++AB6E 09           goto020	add	hl,bc		;⠭
1070++AB6F 38 2E        	jr	c,goto021
1071++AB71 1B           	dec	de
1072++AB72 18 2B        	jr	goto021
1073++AB74
1074++AB74              ;  ᥪ
1075++AB74 22 16 8D     goto019	ld	(NumCluster),hl
1076++AB77 4D           	ld	c,l
1077++AB78 44           	ld	b,h
1078++AB79 E1           	pop	hl
1079++AB7A CD 85 B3     	call	LD_DEHL_adrHL	;dehl - ; ࢮ  䠩
1080++AB7D ED 53 14 8D  	ld	(NumFstCluster+2),de
1081++AB81 22 12 8D     	ld	(NumFstCluster),hl
1082++AB84 CD B3 AB     	call	FindCLSinFile	;    ᬥ饭  砫 䠩/⠫
1083++AB87 38 21        	jr	c,goto023	;訡. 뢠 㭪
1084++AB89 28 1D        	jr	z,goto022	;䠩 ⮩
1085++AB8B CD D8 AE     	call	GetAdrRealSector;dehl  ᥪ
1086++AB8E F1           	pop	af		;a - ࠧ   ᥪ
1087++AB8F 3D           	dec	a
1088++AB90 4F           	ld	c,a
1089++AB91 F1           	pop	af		;ᬥ饭  ᥪ  砫 䠩
1090++AB92 A1           	and	c
1091++AB93 4F           	ld	c,a
1092++AB94 06 00        	ld	b,#00		;ᬥ饭    ᥪ
1093++AB96 32 18 8D     	ld	(NumSecCls),a
1094++AB99 09           	add	hl,bc
1095++AB9A EB           	ex	de,hl
1096++AB9B 48           	ld	c,b
1097++AB9C ED 4A        	adc	hl,bc
1098++AB9E EB           	ex	de,hl		;dehl -   ᥪ
1099++AB9F ED 53 1B 8D  goto021	ld	(SecFileInBuf+2),de
1100++ABA3 22 19 8D     	ld	(SecFileInBuf),hl
1101++ABA6 B7           	or	a
1102++ABA7 C9           	ret
1103++ABA8
1104++ABA8              ;訡: 䠩 ⮩
1105++ABA8 3E 75        goto022	ld	a,errFileEmpty	; 訡:   । ࠧ ᪠
1106++ABAA              ;訡 ⥭/
1107++ABAA 21 17 8D     goto023	ld	hl,NumCluster+#01
1108++ABAD 36 FF        	ld	(hl),#FF
1109++ABAF C1           error2	pop	bc
1110++ABB0 C1           	pop	bc
1111++ABB1 37           	scf
1112++ABB2 C9           	ret
1113++ABB3
1114++ABB3              	endif
1115++ABB3
1116++ABB3              ;------------------------------------------------------------------------------
1117++ABB3              FindCLSinFile	ifused
1118++ABB3              ;    ᬥ饭  砫 䠩/⠫
1119++ABB3              ;:  dehl -  ࢮ  䠩/⠫
1120++ABB3              ;     bc - ᬥ饭  砫 䠩/⠫  
1121++ABB3              ;: cy=1 訡 ⥭/
1122++ABB3              ;       a=errRWnum
1123++ABB3              ;       a=errInvalidPart
1124++ABB3              ;       a=errEoF - 䠩 ࢠ
1125++ABB3              ;     cy=0
1126++ABB3              ;        z - 䠩 ⮩
1127++ABB3              ;        nz -> a =#01 - dehl   
1128++ABB3              ;     hl',de',bc' - ???
1129++ABB3              ;
1130++ABB3              ;FindCLSinFile
1131++ABB3              ;
1132++ABB3              ;஢ਬ  㤠  䠩
1133++ABB3              	IFDEF	forProfROM
1134++ABB3 ~            	 CheckDelFile
1135++ABB3 ~            	 jr	nz,loop010	;஢ઠ  㦭
1136++ABB3 ~            	 push	hl
1137++ABB3 ~            	 push	de
1138++ABB3 ~            	 push	bc
1139++ABB3 ~            	 call	ReadFATnextCls	;⥭  ண 
1140++ABB3 ~            	 jr	c,goto045
1141++ABB3 ~            	 ld	a,d
1142++ABB3 ~            	 or	e
1143++ABB3 ~            	 or	h
1144++ABB3 ~            	 or	l
1145++ABB3 ~            	 pop	bc
1146++ABB3 ~            	 pop	de
1147++ABB3 ~            	 pop	hl
1148++ABB3 ~            	 scf
1149++ABB3 ~            	 jr	z,goto017	;᫨ =0,  䠩 㤠
1150++ABB3              	ENDIF
1151++ABB3              	IFDEF	forRRL
1152++ABB3 ~            	 CheckDelFile
1153++ABB3 ~            	 jr	nz,loop010	;஢ઠ  㦭
1154++ABB3 ~            	 push	hl
1155++ABB3 ~            	 push	de
1156++ABB3 ~            	 push	bc
1157++ABB3 ~            	 call	ReadFATnextCls	;⥭  ண 
1158++ABB3 ~            	 jr	c,goto045
1159++ABB3 ~            	 ld	a,d
1160++ABB3 ~            	 or	e
1161++ABB3 ~            	 or	h
1162++ABB3 ~            	 or	l
1163++ABB3 ~            	 pop	bc
1164++ABB3 ~            	 pop	de
1165++ABB3 ~            	 pop	hl
1166++ABB3 ~            	 scf
1167++ABB3 ~            	 jr	z,goto017	;᫨ =0,  䠩 㤠
1168++ABB3              	ENDIF
1169++ABB3
1170++ABB3              ;஢ઠ  ⮩  䠩
1171++ABB3 7A           loop010	ld	a,d
1172++ABB4 B3           	or	e
1173++ABB5 B4           	or	h
1174++ABB6 B5           	or	l
1175++ABB7 C8           	ret	z		;䠩 ⮩
1176++ABB8 7C           	ld	a,h
1177++ABB9 A5           	and	l
1178++ABBA A3           	and	e
1179++ABBB 3C           	inc	a
1180++ABBC 20 05        	jr	nz,goto145
1181++ABBE 7A           	ld	a,d
1182++ABBF FE 0F        	cp	#0F
1183++ABC1 28 14        	jr	z,goto144	;䠩 稫
1184++ABC3              ;      ⠡ FAT
1185++ABC3 78           goto145	ld	a,b
1186++ABC4 B1           	or	c
1187++ABC5 28 0E        	jr	z,goto018	;dehl -   
1188++ABC7 CD 42 B0     	call	TestLastCLS
1189++ABCA 38 0C        	jr	c,goto017	;䠩 ࢠ
1190++ABCC C5           	push	bc
1191++ABCD CD 55 B0     	call	ReadFATnextCls	;⥭  ᫥饣 
1192++ABD0 C1           	pop	bc
1193++ABD1 D8           	ret	c
1194++ABD2 0B           	dec	bc
1195++ABD3 18 DE        	jr	loop010
1196++ABD5 3C           goto018	inc	a
1197++ABD6 C9           	ret
1198++ABD7 37           goto144	scf
1199++ABD8 3E 71        goto017	ld	a,errEoF
1200++ABDA C9           	ret
1201++ABDB              	IFDEF	forProfROM
1202++ABDB ~            goto045  pop	bc
1203++ABDB ~             	 pop	de
1204++ABDB ~            	 pop	hl
1205++ABDB ~            	 ret
1206++ABDB              	ENDIF
1207++ABDB              	IFDEF	forRRL
1208++ABDB ~            goto045  pop	bc
1209++ABDB ~             	 pop	de
1210++ABDB ~            	 pop	hl
1211++ABDB ~            	 ret
1212++ABDB              	ENDIF
1213++ABDB
1214++ABDB              	endif
1215++ABDB
1216++ABDB              ;==============================================================================
1217++ABDB
# file closed: Drivers/DrvFAT/DrvFAT.file.a80
 133+ ABDB              	INCLUDE	"DrvFAT.fcb.a80"
# file opened: Drivers/DrvFAT/DrvFAT.fcb.a80
   1++ABDB              ;楤  FAT Driver.   ஬ fcb
   2++ABDB              ;䠩 DrvFAT.fcb.a80
   3++ABDB              ;
   4++ABDB              ;fcbRenameEntry		२   ⠫
   5++ABDB              ;fcbWriteToEntry	  fcb  ⠫
   6++ABDB              ;fcbFindEntry		   ⠫  ࠭ ⥪饣 
   7++ABDB              ;			 ࠧ  fcb
   8++ABDB              ;--fcbSetInEntryClsSize	⠭  ਯ 䠩  ࢮ  
   9++ABDB              ;			ࠧ  fcb
  10++ABDB              ;fcbSetEntryFromFcb	⠭  ਯ 䠩 , ਡ⮢, 
  11++ABDB              ;			ࢮ   ࠧ  fcb
  12++ABDB              ;fcbExxCLSCurrDir	६ ⠭()  fcb  
  13++ABDB              ;			⥪饣 ⠫  ⥪饣 ࠧ
  14++ABDB              ;fcbSetCLSCurrDir	⠭  fcb   ⠫-த⥫
  15++ABDB              ;fcbSetFromEntry	⠭ fcb   ᭮ ਯ 䠩
  16++ABDB              ;fcbClsFile2fcbClsDIR	஢  fcbClsFile   fcbClsDIR
  17++ABDB              ;add2OffsetEOF_L	饭 㪠⥫  䠩  ஫ 室 
  18++ABDB              ;			। 䠩
  19++ABDB              ;add2OffsetEOF_HL	饭 㪠⥫  䠩  ஫ 室 
  20++ABDB              ;			। 䠩
  21++ABDB              ;add2OffsetEOF_EHL	饭 㪠⥫  䠩  ஫ 室 
  22++ABDB              ;			। 䠩
  23++ABDB              ;add2OffsetEOF_DEHL	饭 㪠⥫  䠩  ஫ 室 
  24++ABDB              ;			। 䠩
  25++ABDB              ;DEHL2fcbOffset_EoF	㧪  fcbOffset 㪠⥫  䠩  dehl
  26++ABDB              ;			 ஫ 室  । 䠩
  27++ABDB              ;DEHL2fcbOffset		㧪  fcbOffset 㪠⥫  䠩
  28++ABDB              ;DEHL2fcbClsDIR		㧪  fcbClsDIR  ࢮ  ⠫
  29++ABDB              ;			 䠩
  30++ABDB              ;DEHL2fcbSize		㧪  fcbSize ࠧ 䠩    dehl
  31++ABDB              ;DEHL2fcbClsFile	㧪  fcbClsFile  ࢮ   dehl
  32++ABDB              ;LD_DEHL_fcbOffset	㧪  dehl  fcbOffset  fcb
  33++ABDB              ;LD_DEHL_fcbSize	㧪  dehl  fcbSize  fcb
  34++ABDB              ;LD_DEHL_fcbClsFile	㧪  dehl  ࢮ  䠩  fcb
  35++ABDB              ;
  36++ABDB              ;------------------------------------------------------------------------------
  37++ABDB              fcbRenameEntry	ifused
  38++ABDB ~            ;२   ⠫
  39++ABDB ~            ;   fcb   ⠭: fcbName, fcbExt
  40++ABDB ~            ;:  ix -  fcb   塞  ⠫
  41++ABDB ~            ;     hl -     asciz  ଠ 8+3  8.3
  42++ABDB ~            ;: cy=1 訡 ⥭/
  43++ABDB ~            ;       a=errRWnum
  44++ABDB ~            ;       a=errInvalidPart
  45++ABDB ~            ;       a=errEoF - 䠩 ࢠ
  46++ABDB ~            ;       a=errFileEmpty - ⮩ ୥ ⠫
  47++ABDB ~            ;       a=errFileNotFound
  48++ABDB ~            ;
  49++ABDB ~            ;fcbRenameEntry
  50++ABDB ~            ;
  51++ABDB ~            ;饬   ⠫
  52++ABDB ~            	push	ix
  53++ABDB ~            	ex	(sp),hl
  54++ABDB ~            	call	fcbFindEntry
  55++ABDB ~            	jr	c,goto136
  56++ABDB ~
  57++ABDB ~            ; 
  58++ABDB ~            	ex	de,hl
  59++ABDB ~            	ex	(sp),hl
  60++ABDB ~            	push	hl
  61++ABDB ~            	call	FileNameTo8dot3		;⠭    fcb 
  62++ABDB ~            	pop	hl
  63++ABDB ~            	pop	de
  64++ABDB ~            	call	FileNameTo8dot3		;⠭    ਯ
  65++ABDB ~            	jr	goto137			; ᥪ     Buf4DIR
  66++ABDB ~
  67++ABDB ~            ;室
  68++ABDB ~            goto136	pop	hl
  69++ABDB ~            	ret
  70++ABDB ~
  71++ABDB              	endif
  72++ABDB
  73++ABDB              ;------------------------------------------------------------------------------
  74++ABDB              fcbWriteToEntry	ifused
  75++ABDB              ;  fcb  ⠫
  76++ABDB              ;   fcb   ⠭: fcbName, fcbExt, fcbAttr, fcbClsFile, fcbSize)
  77++ABDB              ;:  ix -  fcb   塞  ⠫
  78++ABDB              ;: cy=1 訡 ⥭/
  79++ABDB              ;       a=errRWnum
  80++ABDB              ;       a=errInvalidPart
  81++ABDB              ;       a=errEoF - 䠩 ࢠ
  82++ABDB              ;       a=errFileEmpty - ⮩ ୥ ⠫
  83++ABDB              ;       a=errFileNotFound
  84++ABDB              ;
  85++ABDB              ;fcbWriteToEntry
  86++ABDB              ;
  87++ABDB              ;饬   ⠫
  88++ABDB DD E5        	push	ix
  89++ABDD E1           	pop	hl
  90++ABDE CD E8 AB     	call	fcbFindEntry
  91++ABE1 D8           	ret	c
  92++ABE2
  93++ABE2              ; 
  94++ABE2 CD FD AB     	call	fcbSetEntryFromFcb	;⠭ ࠬ  ਯ
  95++ABE5 C3 CC B0     goto137	jp	SaveSecBuf2DIR		; ᥪ     Buf4DIR
  96++ABE8
  97++ABE8              	endif
  98++ABE8
  99++ABE8              ;------------------------------------------------------------------------------
 100++ABE8              fcbFindEntry	ifused
 101++ABE8              ;   ⠫  ࠭ ⥪饣   ࠧ  fcb
 102++ABE8              ;   fcb   ⠭: fcbName, fcbExt
 103++ABE8              ;:  ix -  fcb 
 104++ABE8              ;     hl -   䠩 asciz  ଠ 8+3  8.3
 105++ABE8              ;: cy=1 訡 ⥭/,   
 106++ABE8              ;       a=errRWnum
 107++ABE8              ;       a=errInvalidPart
 108++ABE8              ;       a=errEoF - 䠩 ࢠ
 109++ABE8              ;       a=errFileEmpty - ⮩ ୥ ⠫
 110++ABE8              ;	a=errFileNotFound
 111++ABE8              ;     cy=0   (fcb  !!!)
 112++ABE8              ;       de -  ਯ  
 113++ABE8              ;       bc -    ⠫
 114++ABE8              ;     hl -  
 115++ABE8              ;
 116++ABE8              ;fcbFindEntry
 117++ABE8              ;
 118++ABE8 E5           	push	hl
 119++ABE9 CD 23 AC     	call	fcbExxCLSCurrDir
 120++ABEC CD A1 A7     	call	fatFindEntryDir
 121++ABEF E1           	pop	hl
 122++ABF0 38 05        	jr	c,goto101
 123++ABF2 28 03        	jr	z,goto101
 124++ABF4 37           	scf
 125++ABF5 3E 48        	ld	a,errFileNotFound
 126++ABF7
 127++ABF7              ;室
 128++ABF7 F5           goto101	push	af
 129++ABF8 CD 23 AC     	call	fcbExxCLSCurrDir
 130++ABFB F1           	pop	af
 131++ABFC C9           	ret
 132++ABFD
 133++ABFD              	endif
 134++ABFD
 135++ABFD              ;------------------------------------------------------------------------------
 136++ABFD              fcbSetEntryFromFcb	ifused
 137++ABFD              ;⠭  ਯ 䠩 , ਡ⮢,  ࢮ 
 138++ABFD              ;   ࠧ  fcb
 139++ABFD              ;:  ix -  fcb 
 140++ABFD              ;     de -  ਯ  
 141++ABFD              ;: bc=#0000
 142++ABFD              ;
 143++ABFD              ;fcbSetEntryFromFcb
 144++ABFD              ;
 145++ABFD              ;⠭   ਡ
 146++ABFD DD E5        	push	ix
 147++ABFF E1           	pop	hl
 148++AC00 01 0C 00     	ld	bc,#000C
 149++AC03 ED B0        	ldir
 150++AC05
 151++AC05              ;⠭  ࢮ 
 152++AC05 EB           	ex	de,hl
 153++AC06 0E 0E        	ld	c,#0E
 154++AC08 09           	add	hl,bc		;nc (   )
 155++AC09 EB           	ex	de,hl		;de +#1A
 156++AC0A ED A0        	ldi			;襥 ᫮ 
 157++AC0C ED A0        	ldi
 158++AC0E EB           	ex	de,hl
 159++AC0F 0E 08        	ld	c,#08
 160++AC11 ED 42        	sbc	hl,bc
 161++AC13 EB           	ex	de,hl		;de +#14
 162++AC14 ED A0        	ldi			;襥 ᫮ 
 163++AC16 ED A0        	ldi
 164++AC18 EB           	ex	de,hl
 165++AC19 0E 06        	ld	c,#06
 166++AC1B 09           	add	hl,bc
 167++AC1C EB           	ex	de,hl		;de +#1C
 168++AC1D 0E 04        	ld	c,#04
 169++AC1F 09           	add	hl,bc
 170++AC20 ED B0        	ldir			;ࠧ
 171++AC22
 172++AC22 C9           	ret
 173++AC23
 174++AC23              	endif
 175++AC23
 176++AC23              ;------------------------------------------------------------------------------
 177++AC23              fcbExxCLSCurrDir	ifused
 178++AC23              ;६ ⠭()  fcb   ⥪饣 ⠫   ⥪饣
 179++AC23              ;  ࠧ
 180++AC23              ;:  ix -  fcb 
 181++AC23              ;: hl,de,bc -  
 182++AC23              ;
 183++AC23              ;fcbExxCLSCurrDir
 184++AC23              ;
 185++AC23 E5           	push	hl
 186++AC24 D5           	push	de
 187++AC25 C5           	push	bc
 188++AC26 3A FB 8C     	ld	a,(CurrentLevel)
 189++AC29 F5           	push	af
 190++AC2A 21 D3 8A     	ld	hl,PartitionNum
 191++AC2D 4E           	ld	c,(hl)
 192++AC2E DD 71 1C     	ld	(ix+fcbStore),c
 193++AC31 DD 7E 1F     	ld	a,(ix+fcbPart)
 194++AC34 77           	ld	(hl),a
 195++AC35 DD 71 1F     	ld	(ix+fcbPart),c
 196++AC38 CD 1C AD     	call	InitFAT32
 197++AC3B F1           	pop	af
 198++AC3C 32 FB 8C     	ld	(CurrentLevel),a
 199++AC3F
 200++AC3F DD E5        	push	ix
 201++AC41 E1           	pop	hl
 202++AC42 11 10 00     	ld	de,fcbClsDIR
 203++AC45 19           	add	hl,de
 204++AC46 CD E2 B2     	call	excngCLSCurrDir
 205++AC49 C1           	pop	bc
 206++AC4A D1           	pop	de
 207++AC4B E1           	pop	hl
 208++AC4C C9           	ret
 209++AC4D
 210++AC4D              	endif
 211++AC4D
 212++AC4D              ;------------------------------------------------------------------------------
 213++AC4D              fcbSetCLSCurrDir	ifused
 214++AC4D              ;⠭  fcb   ⠫-த⥫
 215++AC4D              ;:  ix -  fcb 
 216++AC4D              ;: cy=1 訡 ⥭/
 217++AC4D              ;       a=errRWnum
 218++AC4D              ;       a=errInvalidPart
 219++AC4D              ;       a=errEoF - 䠩 ࢠ
 220++AC4D              ;       a=errFileEmpty - ⮩ ୥ ⠫
 221++AC4D              ;       a=errFileNotFound
 222++AC4D              ;
 223++AC4D              ;fcbSetCLSCurrDir
 224++AC4D              ;
 225++AC4D D5           	push	de
 226++AC4E E5           	push	hl
 227++AC4F 18 34        	jr	goto175
 228++AC51 18 FE        	jr	fcbSetFromEntry
 229++AC53              	org	$-2
 230++AC51
 231++AC51              	endif
 232++AC51
 233++AC51              ;------------------------------------------------------------------------------
 234++AC51              fcbSetFromEntry	ifused
 235++AC51              ;⠭ fcb   ᭮ ਯ 䠩
 236++AC51              ;:  ix -  fcb 
 237++AC51              ;     hl -  ਯ 䠩
 238++AC51              ;     (CLS_CurrDir)  ⠫  䠩
 239++AC51              ;: hl -  ਯ 䠩
 240++AC51              ;
 241++AC51              ;fcbSetFromEntry
 242++AC51              ;
 243++AC51 D5           	push	de
 244++AC52 E5           	push	hl
 245++AC53 F5           	push	af
 246++AC54
 247++AC54              ; 䠩  ਡ
 248++AC54 DD E5        	push	ix
 249++AC56 D1           	pop	de
 250++AC57 01 0C 00     	ld	bc,#000C
 251++AC5A ED B0        	ldir
 252++AC5C
 253++AC5C              ; ࢮ 
 254++AC5C 0E 08        	ld	c,#08
 255++AC5E 09           	add	hl,bc		;   (hi)
 256++AC5F E5           	push	hl
 257++AC60 0E 08        	ld	c,#08
 258++AC62 09           	add	hl,bc		; ࠧ 䠩
 259++AC63 E3           	ex	(sp),hl
 260++AC64 5E           	ld	e,(hl)
 261++AC65 23           	inc	hl
 262++AC66 56           	ld	d,(hl)
 263++AC67 0E 05        	ld	c,#05
 264++AC69 09           	add	hl,bc
 265++AC6A 7E           	ld	a,(hl)
 266++AC6B 23           	inc	hl
 267++AC6C 66           	ld	h,(hl)
 268++AC6D 6F           	ld	l,a
 269++AC6E CD F8 AC     	call	DEHL2fcbClsFile
 270++AC71 E1           	pop	hl		; ࠧ 䠩
 271++AC72
 272++AC72              ;ࠧ 䠩
 273++AC72 CD 85 B3     	call	LD_DEHL_adrHL
 274++AC75 CD EB AC     	call	DEHL2fcbSize
 275++AC78
 276++AC78              ;㪠⥫  䠩 =#00000000
 277++AC78 CD 37 B3     	call	SetZeroDEHL
 278++AC7B CD D1 AC     	call	DEHL2fcbOffset
 279++AC7E
 280++AC7E              ; ⥪饣   ࠧ  
 281++AC7E 3A D3 8A     	ld	a,(PartitionNum)
 282++AC81 DD 77 1F     	ld	(ix+fcbPart),a
 283++AC84
 284++AC84 F1           	pop	af
 285++AC85
 286++AC85              ;  ⠫
 287++AC85 ED 5B FE 8C  goto175	ld	de,(CLS_CurrDir+2)
 288++AC89 2A FC 8C     	ld	hl,(CLS_CurrDir)
 289++AC8C CD DE AC     	call	DEHL2fcbClsDIR
 290++AC8F
 291++AC8F E1           	pop	hl
 292++AC90 D1           	pop	de
 293++AC91 C9           	ret
 294++AC92
 295++AC92              	endif
 296++AC92
 297++AC92              ;------------------------------------------------------------------------------
 298++AC92              fcbClsFile2fcbClsDIR	ifused
 299++AC92 ~            ;஢  fcbClsFile   cbClsDIR
 300++AC92 ~            ;:  ix -  fcb 
 301++AC92 ~            ;
 302++AC92 ~            ;fcbClsFile2fcbClsDIR
 303++AC92 ~            ;
 304++AC92 ~            	push	ix
 305++AC92 ~            	pop	hl
 306++AC92 ~            	ld	de,fcbClsFile
 307++AC92 ~            	add	hl,de
 308++AC92 ~            	ex	de,hl
 309++AC92 ~            	ld	l,fcbClsDIR-fcbClsFile
 310++AC92 ~            	add	hl,de
 311++AC92 ~            	ex	de,hl
 312++AC92 ~            	jp	CopyDWORD_HL_DE
 313++AC92 ~
 314++AC92              	endif
 315++AC92
 316++AC92              ;------------------------------------------------------------------------------
 317++AC92              ;饭 㪠⥫  䠩
 318++AC92              ;:  ix -  fcb 
 319++AC92              ;:  [d][e][h]l - 稭 饭
 320++AC92              ;: cy=0 㪠⥫ ⠭
 321++AC92              ;       dehl - 㪠⥫
 322++AC92              ;
 323++AC92              add2Offset_L	ifused
 324++AC92 ~            ;
 325++AC92 ~            	ld	h,#00
 326++AC92 ~            	jr	add2Offset_HL
 327++AC92 ~            	org	$-2
 328++AC92              	endif
 329++AC92
 330++AC92              add2Offset_HL	ifused
 331++AC92              ;
 332++AC92 1E 00        	ld	e,#00
 333++AC94 18 FE        	jr	add2Offset_EHL
 334++AC96              	org	$-2
 335++AC94              	endif
 336++AC94
 337++AC94
 338++AC94              add2Offset_EHL	ifused
 339++AC94              ;
 340++AC94 16 00        	ld	d,#00
 341++AC96 18 FE        	jr	add2Offset_DEHL
 342++AC98              	org	$-2
 343++AC96              	endif
 344++AC96
 345++AC96
 346++AC96              add2Offset_DEHL	ifused
 347++AC96              ;
 348++AC96 C5           	push	bc
 349++AC97 D5           	push	de
 350++AC98 E5           	push	hl
 351++AC99 CD 05 AD     	call	LD_DEHL_fcbOffset
 352++AC9C C1           	pop	bc
 353++AC9D 09           	add	hl,bc
 354++AC9E C1           	pop	bc
 355++AC9F EB           	ex	de,hl
 356++ACA0 ED 4A        	adc	hl,bc
 357++ACA2 EB           	ex	de,hl
 358++ACA3 C1           	pop	bc
 359++ACA4 18 2B        	jr	DEHL2fcbOffset
 360++ACA6
 361++ACA6              	endif
 362++ACA6
 363++ACA6              ;------------------------------------------------------------------------------
 364++ACA6              ;饭 㪠⥫  䠩  ஫ 室  । 䠩
 365++ACA6              ;:  ix -  fcb 
 366++ACA6              ;:  [d][e][h]l - 稭 饭
 367++ACA6              ;: cy=1 㪠⥫   । 䠩 -> ⠭  砫
 368++ACA6              ;       dehl =#00000000
 369++ACA6              ;     cy=0 㪠⥫ ⠭
 370++ACA6              ;       dehl - 㪠⥫
 371++ACA6              ;
 372++ACA6              add2OffsetEOF_L		ifused
 373++ACA6              ;
 374++ACA6 26 00        	ld	h,#00
 375++ACA8 18 FE        	jr	add2OffsetEOF_HL
 376++ACAA              	org	$-2
 377++ACA8              	endif
 378++ACA8
 379++ACA8              add2OffsetEOF_HL	ifused
 380++ACA8              ;
 381++ACA8 1E 00        	ld	e,#00
 382++ACAA 18 FE        	jr	add2OffsetEOF_EHL
 383++ACAC              	org	$-2
 384++ACAA              	endif
 385++ACAA
 386++ACAA
 387++ACAA              add2OffsetEOF_EHL	ifused
 388++ACAA              ;
 389++ACAA 16 00        	ld	d,#00
 390++ACAC 18 FE        	jr	add2OffsetEOF_DEHL
 391++ACAE              	org	$-2
 392++ACAC              	endif
 393++ACAC
 394++ACAC
 395++ACAC              add2OffsetEOF_DEHL	ifused
 396++ACAC              ;
 397++ACAC C5           	push	bc
 398++ACAD D5           	push	de
 399++ACAE E5           	push	hl
 400++ACAF CD 05 AD     	call	LD_DEHL_fcbOffset
 401++ACB2 C1           	pop	bc
 402++ACB3 09           	add	hl,bc
 403++ACB4 C1           	pop	bc
 404++ACB5 EB           	ex	de,hl
 405++ACB6 ED 4A        	adc	hl,bc
 406++ACB8 EB           	ex	de,hl
 407++ACB9 C1           	pop	bc
 408++ACBA 18 FE        	jr	DEHL2fcbOffset_EoF
 409++ACBC              	org	$-2
 410++ACBA
 411++ACBA              	endif
 412++ACBA
 413++ACBA              ;------------------------------------------------------------------------------
 414++ACBA              DEHL2fcbOffset_EoF	ifused
 415++ACBA              ;㧪  fcbOffset 㪠⥫  䠩  dehl  ஫ 室  ।
 416++ACBA              ;  䠩
 417++ACBA              ;:  ix -  fcb 
 418++ACBA              ;     dehl - 㪠⥫  䠩
 419++ACBA              ;: cy=1 㪠⥫   । 䠩 -> ⠭  砫
 420++ACBA              ;       dehl =#00000000
 421++ACBA              ;     cy=0 㪠⥫ ⠭
 422++ACBA              ;       dehl - 㪠⥫
 423++ACBA              ;
 424++ACBA              ;DEHL2fcbOffset_EoF
 425++ACBA              ;
 426++ACBA C5           	push	bc
 427++ACBB DD E5        	push	ix
 428++ACBD E3           	ex	(sp),hl
 429++ACBE 01 14 00     	ld	bc,fcbSize
 430++ACC1 09           	add	hl,bc
 431++ACC2 4D           	ld	c,l
 432++ACC3 44           	ld	b,h
 433++ACC4 E1           	pop	hl
 434++ACC5 CD 49 B3     	call	cmp_DEHL_adrBC
 435++ACC8 C1           	pop	bc
 436++ACC9 38 03        	jr	c,goto096
 437++ACCB 20 04        	jr	nz,DEHL2fcbOffset
 438++ACCD 37                   scf
 439++ACCE CD 37 B3     goto096	call	SetZeroDEHL
 440++ACD1
 441++ACD1              	endif
 442++ACD1
 443++ACD1              ;------------------------------------------------------------------------------
 444++ACD1              DEHL2fcbOffset	ifused
 445++ACD1              ;㧪  fcbOffset 㧪  fcbOffset 㪠⥫  䠩
 446++ACD1              ;:  ix -  fcb 
 447++ACD1              ;     dehl - 㪠⥫  䠩
 448++ACD1              ;
 449++ACD1              ;DEHL2fcbOffset
 450++ACD1              ;
 451++ACD1 DD 75 18     	ld	(ix+fcbOffset),l
 452++ACD4 DD 74 19     	ld	(ix+fcbOffset+1),h
 453++ACD7 DD 73 1A     	ld	(ix+fcbOffset+2),e
 454++ACDA DD 72 1B     	ld	(ix+fcbOffset+3),d
 455++ACDD C9           	ret
 456++ACDE
 457++ACDE              	endif
 458++ACDE
 459++ACDE              ;------------------------------------------------------------------------------
 460++ACDE              DEHL2fcbClsDIR	ifused
 461++ACDE              ;㧪  fcbClsDIR  ࢮ  ⠫  䠩
 462++ACDE              ;:  ix -  fcb 
 463++ACDE              ;     dehl -   ⠫
 464++ACDE              ;
 465++ACDE              ;DEHL2fcbClsDIR
 466++ACDE              ;
 467++ACDE DD 75 10     	ld	(ix+fcbClsDIR),l
 468++ACE1 DD 74 11     	ld	(ix+fcbClsDIR+1),h
 469++ACE4 DD 73 12     	ld	(ix+fcbClsDIR+2),e
 470++ACE7 DD 72 13     	ld	(ix+fcbClsDIR+3),d
 471++ACEA C9           	ret
 472++ACEB
 473++ACEB              	endif
 474++ACEB
 475++ACEB              ;------------------------------------------------------------------------------
 476++ACEB              DEHL2fcbSize	ifused
 477++ACEB              ;㧪  fcbSize ࠧ 䠩    dehl
 478++ACEB              ;:  ix -  fcb 
 479++ACEB              ;     dehl - ࠧ 䠩
 480++ACEB              ;
 481++ACEB              ;DEHL2fcbSize
 482++ACEB              ;
 483++ACEB DD 75 14     	ld	(ix+fcbSize),l
 484++ACEE DD 74 15     	ld	(ix+fcbSize+1),h
 485++ACF1 DD 73 16     	ld	(ix+fcbSize+2),e
 486++ACF4 DD 72 17     	ld	(ix+fcbSize+3),d
 487++ACF7 C9           	ret
 488++ACF8
 489++ACF8              	endif
 490++ACF8
 491++ACF8              ;------------------------------------------------------------------------------
 492++ACF8              DEHL2fcbClsFile	ifused
 493++ACF8              ;㧪  fcbClsFile  ࢮ   dehl
 494++ACF8              ;:  ix -  fcb 
 495++ACF8              ;     dehl -  ࢮ  䠩
 496++ACF8              ;
 497++ACF8              ;DEHL2fcbClsFile
 498++ACF8              ;
 499++ACF8 DD 75 0C     	ld	(ix+fcbClsFile),l
 500++ACFB DD 74 0D     	ld	(ix+fcbClsFile+1),h
 501++ACFE DD 73 0E     	ld	(ix+fcbClsFile+2),e
 502++AD01 DD 72 0F     	ld	(ix+fcbClsFile+3),d
 503++AD04 C9           	ret
 504++AD05
 505++AD05              	endif
 506++AD05
 507++AD05              ;------------------------------------------------------------------------------
 508++AD05              LD_DEHL_fcbOffset	ifused
 509++AD05              ;㧪  dehl  fcbOffset  fcb
 510++AD05              ;:  ix -  fcb 
 511++AD05              ;: dehl - 㪠⥫  䠩
 512++AD05              ;
 513++AD05              ;LD_DEHL_fcbOffset
 514++AD05              ;
 515++AD05 11 18 00     	ld	de,fcbOffset
 516++AD08 18 08        	jr	goto044
 517++AD0A 18 03        	jr	LD_DEHL_fcbClsFile
 518++AD0C              	org	$-2
 519++AD0A
 520++AD0A              	endif
 521++AD0A
 522++AD0A              ;------------------------------------------------------------------------------
 523++AD0A              LD_DEHL_fcbSize	ifused
 524++AD0A              ;㧪  dehl  fcbSize  fcb
 525++AD0A              ;:  ix -  fcb 
 526++AD0A              ;: dehl - ࠧ 䠩  
 527++AD0A              ;
 528++AD0A              ;LD_DEHL_fcbSize
 529++AD0A              ;
 530++AD0A 11 14 00     	ld	de,fcbSize
 531++AD0D 18 03        	jr	goto044
 532++AD0F 18 FE        	jr	LD_DEHL_fcbClsFile
 533++AD11              	org	$-2
 534++AD0F
 535++AD0F              	endif
 536++AD0F
 537++AD0F              ;------------------------------------------------------------------------------
 538++AD0F              LD_DEHL_fcbClsFile	ifused
 539++AD0F              ;㧪  dehl  ࢮ  䠩  fcb
 540++AD0F              ;:  ix -  fcb 
 541++AD0F              ;: dehl -  ࢮ  䠩
 542++AD0F              ;
 543++AD0F              ;LD_DEHL_fcbClsFile
 544++AD0F              ;
 545++AD0F 11 0C 00     	ld	de,fcbClsFile
 546++AD12 DD E5        goto044	push	ix
 547++AD14 E1           	pop	hl
 548++AD15 19           	add	hl,de
 549++AD16 C3 85 B3     	jp	LD_DEHL_adrHL
 550++AD19
 551++AD19              	endif
 552++AD19
 553++AD19              ;==============================================================================
 554++AD19
# file closed: Drivers/DrvFAT/DrvFAT.fcb.a80
 134+ AD19              	INCLUDE	"DrvFAT.init.a80"
# file opened: Drivers/DrvFAT/DrvFAT.init.a80
   1++AD19              ;楤  FAT Driver. 樠 ६ FAT32 ࠧ.
   2++AD19              ;䠩 DrvFAT.init.a80
   3++AD19              ;
   4++AD19              ;InitCurrMountFAT	樠 ࠧ FAT  ⥪騬 祭 ࠧ
   5++AD19              ;InitCurrFAT		樠 ⥪饣 ࠧ FAT  室
   6++AD19              ;InitFAT32		樠 ࠧ FAT
   7++AD19              ;InitFATpartition	樠 ६ ࠭ ࠧ FAT
   8++AD19              ;setRootDir		⠭ ୥ ⠫ ⥪騬
   9++AD19              ;DeinitFATpart		樠 ६ ࠧ FAT
  10++AD19              ;DeinitFATbuf		樠 ஢ ࠧ FAT
  11++AD19              ;
  12++AD19              ;------------------------------------------------------------------------------
  13++AD19              	IFDEF	forProfROM
  14++AD19 ~            ;樠 ࠧ FAT  ⥪騬 祭 ࠧ
  15++AD19 ~            ;: cy=1 訡 樠樨
  16++AD19 ~            ;       a=errRWnum
  17++AD19 ~            ;       a=errInvalidPart
  18++AD19 ~            ;     cy =0, nz - ࠧ 樠஢
  19++AD19 ~            ;     cy =0, z - ࠧ  ॡ 樠樨
  20++AD19 ~            ;
  21++AD19 ~            InitCurrMountFAT
  22++AD19 ~            ;
  23++AD19 ~            ;	ld	a,(xE590+#05)	;ࠧ  ࠧ
  24++AD19 ~            	ld	a,(xE590+#15)	;ࠧ  ࠧ
  25++AD19 ~            	and	#7F
  26++AD19 ~            	jr	InitFAT32
  27++AD19 ~
  28++AD19              	ENDIF
  29++AD19
  30++AD19              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  31++AD19              	IFDEF	forRRL
  32++AD19 ~            InitCurrMountFAT
  33++AD19 ~            ;
  34++AD19 ~            ;	 ld	a,(descCurrFDD+#05)	;ࠧ  ࠧ
  35++AD19 ~            	 ld	a,(descCurrFDD+#15)	;ࠧ  ࠧ
  36++AD19 ~            	 and	#7F
  37++AD19 ~            	 jr	InitFAT32
  38++AD19              	ENDIF
  39++AD19
  40++AD19
  41++AD19              ;------------------------------------------------------------------------------
  42++AD19              InitCurrFAT	ifused
  43++AD19              ;樠 ⥪饣 ࠧ FAT  室
  44++AD19              ;: cy=1 訡 樠樨
  45++AD19              ;       a=errRWnum
  46++AD19              ;       a=errInvalidPart
  47++AD19              ;     cy =0, nz - ࠧ 樠஢
  48++AD19              ;     cy =0, z - ࠧ  ॡ 樠樨
  49++AD19              ;
  50++AD19              ;InitCurrFAT
  51++AD19              ;
  52++AD19 3A D3 8A     	ld	a,(PartitionNum)	;࠭ ࠧ
  53++AD1C 18 FE        	jr	InitFAT32
  54++AD1E              	org	$-2
  55++AD1C
  56++AD1C              	endif
  57++AD1C
  58++AD1C              ;------------------------------------------------------------------------------
  59++AD1C              InitFAT32	ifused
  60++AD1C              ;樠 ࠧ FAT
  61++AD1C              ;:  a -  ࠧ
  62++AD1C              ;: cy=1 訡 樠樨
  63++AD1C              ;       a=errRWnum
  64++AD1C              ;       a=errInvalidPart
  65++AD1C              ;     cy =0, nz - ࠧ 樠஢
  66++AD1C              ;     cy =0, z - ࠧ  ॡ 樠樨
  67++AD1C              ;
  68++AD1C              ;InitFAT32
  69++AD1C              ;
  70++AD1C E5           goto028	push	hl
  71++AD1D D5           	push	de
  72++AD1E 21 D5 8C     	ld	hl,CurrentPart		;ந樫஢ ࠧ
  73++AD21 BE           	cp	(hl)
  74++AD22 32 D3 8A     	ld	(PartitionNum),a
  75++AD25              ;	jr	z,goto027
  76++AD25 28 0A        	jr	z,goto139
  77++AD27 6F           	ld	l,a
  78++AD28 CD 3C AE     	call	GetAdrMFSorFAT
  79++AD2B D4 38 AD     	call	nc,InitFATpartition
  80++AD2E D1           goto027	pop	de
  81++AD2F E1           	pop	hl
  82++AD30 C9           	ret
  83++AD31              goto139
  84++AD31              ;	call	setRootDir
  85++AD31              	SetHDDpart
  85++AD31 CD E6 98    >	call	DrvHDD.hddSetDevice
  86++AD34 3E 56        	ld	a,errHddNotFound
  87++AD36 18 F6        	jr	goto027
  88++AD38
  89++AD38              	endif
  90++AD38
  91++AD38              ;------------------------------------------------------------------------------
  92++AD38              InitFATpartition	ifused
  93++AD38              ;樠 ६ ࠭ ࠧ FAT
  94++AD38              ;:  dehl - LBA  ࢮ ᥪ ࠧ
  95++AD38              ;: cy =1 - 訡 樠樨
  96++AD38              ;       a=errRWnum
  97++AD38              ;       a=errInvalidPart
  98++AD38              ;     cy =0, nz - ࠧ 樠஢
  99++AD38              ;     dehl -   
 100++AD38              ;
 101++AD38              ;InitFATpartition
 102++AD38              ;
 103++AD38 CD 24 AE     	call	DeinitFATpart		;樠 ࠧ FAT32
 104++AD3B 22 D7 8C     	ld	(AdrPartBegin),hl
 105++AD3E ED 53 D9 8C  	ld	(AdrPartBegin+2),de	; 砫 ࠧ
 106++AD42 CD DF B0     	call	LoadSecDIR2Buf		;⠬ ᥪ 0 ࠧ
 107++AD45 D8           	ret	c			;訡 ⥭
 108++AD46 E5           	push	hl
 109++AD47 DD E3        	ex	(sp),ix			;ix    ᥪ஬
 110++AD49
 111++AD49              ;஢ઠ 0 ᥪ ࠧ FAT  
 112++AD49 2A 2E 92     	ld	hl,(Buf4DIR+#1FE)
 113++AD4C 11 55 AA     	ld	de,#AA55
 114++AD4F B7           	or	a
 115++AD50 ED 52        	sbc	hl,de
 116++AD52 C2 05 AE     	jp	nz,goto024		;訡.  ᨣ
 117++AD55              ;  ஢ਬ ⢮   ᥪ
 118++AD55 DD 7E 0C     	ld	a,(ix+BPB_BytesPerSec+1)
 119++AD58 D6 02        	sub	#02
 120++AD5A DD B6 0B     	or	(ix+BPB_BytesPerSec)
 121++AD5D C2 05 AE     	jp	nz,goto024		;ᥪ  512b  ন
 122++AD60              ;  ⢮ ᥪ஢  
 123++AD60 DD 56 0D     	ld	d,(ix+BPB_SecPerClus)
 124++AD63 B2           	or	d
 125++AD64 CA 05 AE     	jp	z,goto024		;୮ 祭
 126++AD67 ED 44        	neg
 127++AD69 A2           	and	d
 128++AD6A BA           	cp	d
 129++AD6B C2 05 AE     	jp	nz,goto024		;୮ 祭
 130++AD6E 7A           	ld	a,d
 131++AD6F 32 EE 8C     	ld	(LenCLSInSec),a
 132++AD72              ;  ⢮ ᥪ஢  FAT ⠡
 133++AD72 2A 46 90     	ld	hl,(Buf4DIR+BPB_FATSz16)
 134++AD75 7D           	ld	a,l
 135++AD76 B4           	or	h
 136++AD77 C2 05 AE     	jp	nz,goto024		;  FAT32
 137++AD7A 2A 54 90     	ld	hl,(Buf4DIR+BPB_FATSz32)
 138++AD7D 22 E9 8C     	ld	(LenFATinSec),hl
 139++AD80 2A 56 90     	ld	hl,(Buf4DIR+BPB_FATSz32+2)
 140++AD83 22 EB 8C     	ld	(LenFATinSec+2),hl
 141++AD86              ;  ᬥ饭 ᥪ FSInfo
 142++AD86 2A 60 90     	ld	hl,(Buf4DIR+BPB_FAT32_FsInfo)
 143++AD89 22 DB 8C     	ld	(AdrFsInfo),hl
 144++AD8C              ;  ⢮ ᥪ஢  ࠧ
 145++AD8C 2A 43 90     	ld	hl,(Buf4DIR+BPB_TotSec16)
 146++AD8F 7D           	ld	a,l
 147++AD90 B4           	or	h
 148++AD91 20 72        	jr	nz,goto024		;FAT16  ন
 149++AD93 2A 50 90     	ld	hl,(Buf4DIR+BPB_TotSec32)
 150++AD96 22 E5 8C     	ld	(LenOfPartFAT),hl
 151++AD99 2A 52 90     	ld	hl,(Buf4DIR+BPB_TotSec32+2)
 152++AD9C 22 E7 8C     	ld	(LenOfPartFAT+2),hl
 153++AD9F              ;  ⢮  FAT
 154++AD9F DD 7E 10     	ld	a,(ix+BPB_NumFATs)
 155++ADA2 32 ED 8C     	ld	(NumsFATonPart),a
 156++ADA5 3D           	dec	a
 157++ADA6 FE 07        	cp	#07
 158++ADA8 D2 05 AE     	jp	nc,goto024		; FAT ⠡
 159++ADAB 3C           	inc	a
 160++ADAC              ;   砫 
 161++ADAC 2A E9 8C     	ld	hl,(LenFATinSec)
 162++ADAF ED 5B EB 8C  	ld	de,(LenFATinSec+2)
 163++ADB3 3D           	dec	a
 164++ADB4 28 08        	jr	z,goto025
 165++ADB6 29           loop011	add	hl,hl			;!!!୮   FAT  3
 166++ADB7 EB           	ex	de,hl
 167++ADB8 ED 6A        	adc	hl,hl
 168++ADBA EB           	ex	de,hl
 169++ADBB 3D           	dec	a
 170++ADBC 20 F8        	jr	nz,loop011
 171++ADBE ED 4B 3E 90  goto025	ld	bc,(Buf4DIR+BPB_RsvdSecCnt)
 172++ADC2 C5           	push	bc
 173++ADC3 09           	add	hl,bc
 174++ADC4 30 01        	jr	nc,goto026
 175++ADC6 13           	inc	de
 176++ADC7 22 E1 8C     goto026	ld	(AdrDataBegin),hl
 177++ADCA ED 53 E3 8C  	ld	(AdrDataBegin+2),de	; ࢮ ᥪ 
 178++ADCE              ;   ୥ ४ਨ
 179++ADCE 2A 5C 90     	ld	hl,(Buf4DIR+BPB_RootClus)
 180++ADD1 ED 5B 5E 90  	ld	de,(Buf4DIR+BPB_RootClus+2)
 181++ADD5 22 EF 8C     	ld	(RootClaster),hl
 182++ADD8 ED 53 F1 8C  	ld	(RootClaster+2),de
 183++ADDC 22 FC 8C     	ld	(CLS_CurrDir),hl
 184++ADDF ED 53 FE 8C  	ld	(CLS_CurrDir+2),de
 185++ADE3              ;   ࢮ FAT
 186++ADE3 E3           	ex	(sp),hl			;⢮ १ࢨ஢ ᥪ஢
 187++ADE4 D5           	push	de
 188++ADE5 11 00 00     	ld	de,#0000
 189++ADE8 01 D7 8C     	ld	bc,AdrPartBegin
 190++ADEB CD 8F B3     	call	Add_DEHL_adrBC
 191++ADEE 22 DD 8C     	ld	(AdrFATonHDD),hl
 192++ADF1 ED 53 DF 8C  	ld	(AdrFATonHDD+2),de
 193++ADF5
 194++ADF5              ; ⥪饣 ࠧ
 195++ADF5 3A D3 8A     	ld	a,(PartitionNum)
 196++ADF8 32 D5 8C     	ld	(CurrentPart),a
 197++ADFB              ;	ld	hl,"/"*#100+#02
 198++ADFB              ;	ld	(CurrentPath),hl
 199++ADFB AF           	xor	a
 200++ADFC 32 FB 8C     	ld	(CurrentLevel),a	;㡨   ⥪饬 ⠫
 201++ADFF 3C           	inc	a
 202++AE00 D1           	pop	de
 203++AE01 E1           	pop	hl
 204++AE02 DD E1        	pop	ix
 205++AE04 C9           	ret
 206++AE05 3E 6D        goto024	ld	a,errInvalidPart
 207++AE07 37           	scf
 208++AE08 DD E1        	pop	ix
 209++AE0A C9           	ret
 210++AE0B
 211++AE0B              	endif
 212++AE0B
 213++AE0B              ;------------------------------------------------------------------------------
 214++AE0B              setRootDir	ifused
 215++AE0B              ;⠭ ୥ ⠫ ⥪騬
 216++AE0B              ;: ---
 217++AE0B              ;
 218++AE0B              ;setRootDir
 219++AE0B              ;
 220++AE0B E5           	push	hl
 221++AE0C D5           	push	de
 222++AE0D 21 02 2F     	ld	hl,"/"*#100+#02
 223++AE10 22 30 94     	ld	(CurrentPath),hl
 224++AE13 2E 00        	ld	l,#00
 225++AE15 22 32 94     	ld	(CurrentPath+2),hl
 226++AE18 21 EF 8C     	ld	hl,RootClaster
 227++AE1B 11 FC 8C     	ld	de,CLS_CurrDir
 228++AE1E CD 71 B3     	call	CopyDWORD_HL_DE
 229++AE21 D1           	pop	de
 230++AE22 E1           	pop	hl
 231++AE23 C9           	ret
 232++AE24
 233++AE24              	endif
 234++AE24
 235++AE24              ;------------------------------------------------------------------------------
 236++AE24              DeinitFATpart	ifused
 237++AE24              ;樠 ६ ࠧ FAT
 238++AE24              ;
 239++AE24              ;DeinitFATpart
 240++AE24              ;
 241++AE24 F5           	push	af
 242++AE25 3E FF        	ld	a,#FF
 243++AE27 32 D5 8C     	ld	(CurrentPart),a
 244++AE2A F1           	pop	af
 245++AE2B 18 FE        	jr	DeinitFATbuf
 246++AE2D              	org	$-2
 247++AE2B
 248++AE2B              	endif
 249++AE2B
 250++AE2B              ;------------------------------------------------------------------------------
 251++AE2B              DeinitFATbuf	ifused
 252++AE2B              ;樠 ஢ ࠧ FAT
 253++AE2B              ;
 254++AE2B              ;DeinitFATbuf
 255++AE2B              ;
 256++AE2B F5           	push	af
 257++AE2C 3E FF        	ld	a,#FF
 258++AE2E 32 0D 8D     	ld	(SecFATinBuf+3),a
 259++AE31 32 11 8D     	ld	(SecDIRinBuf+3),a
 260++AE34 32 1C 8D     	ld	(SecFileInBuf+3),a
 261++AE37 32 15 8D     	ld	(NumFstCluster+3),a
 262++AE3A F1           	pop	af
 263++AE3B C9           	ret
 264++AE3C
 265++AE3C              	endif
 266++AE3C
 267++AE3C              ;==============================================================================
 268++AE3C
# file closed: Drivers/DrvFAT/DrvFAT.init.a80
 135+ AE3C              	INCLUDE	"DrvFAT.part.a80"
# file opened: Drivers/DrvFAT/DrvFAT.part.a80
   1++AE3C              ;楤  FAT Driver.   ࠧ
   2++AE3C              ;䠩 DrvFAT.part.a80
   3++AE3C              ;
   4++AE3C              ;FindMFSorFAT		।    ࠧ MFS/FAT32  ⥪饬 
   5++AE3C              ;GetAdrMFSorFAT		 ࠧ MFS/FAT32  
   6++AE3C              ;
   7++AE3C              ;------------------------------------------------------------------------------
   8++AE3C              FindMFSorFAT	ifused
   9++AE3C ~            ;।    ࠧ MFS/FAT32  ⥪饬 
  10++AE3C ~            ;  MFS ⮫쪮  䏇
  11++AE3C ~            ;: cy=1 ࠧ  
  12++AE3C ~            ;       a=errRWnum
  13++AE3C ~            ;       a=errPartNotFound
  14++AE3C ~            ;     cy=0 ࠧ 
  15++AE3C ~            ;        a -  ⨯ ࠧ
  16++AE3C ~            ;FindMFSorFAT
  17++AE3C ~            ;
  18++AE3C ~            	push	ix
  19++AE3C ~            	call	SetZeroDEHL
  20++AE3C ~            	SetNumSectors_1		;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
  21++AE3C ~            	ReadSecMBR		;⥭ 㫥 ᥪ     Buf4MBR
  22++AE3C ~            	ld	a,errRWnum
  23++AE3C ~            	jr	c,goto036	;訡 ⥭
  24++AE3C ~
  25++AE3C ~            ; ࠧ MFS/FAT32  MBR
  26++AE3C ~            	ld	hl,(Buf4MBR+#1FE)
  27++AE3C ~            	ld	de,#AA55	;ᨣ (55h AAh)
  28++AE3C ~            	or	a
  29++AE3C ~            	sbc	hl,de
  30++AE3C ~            	jr	nz,goto036	;ᨣ : MBR 
  31++AE3C ~            	ld	b,#04
  32++AE3C ~            	ld	ix,Buf4MBR+#1BE	;砫 ਯ஢ ࠧ HDD
  33++AE3C ~            loop012	ld	a,(ix+#04)	; ⨯ ࠧ
  34++AE3C ~            	ifdef	withMFS
  35++AE3C ~            	cp	#53		; MFS
  36++AE3C ~            	jr	z,goto037
  37++AE3C ~            	endif
  38++AE3C ~            	cp	#0B
  39++AE3C ~            	jr	z,goto037
  40++AE3C ~            	cp	#0C
  41++AE3C ~            	jr	z,goto037
  42++AE3C ~            	ld	de,#0010
  43++AE3C ~            	add	ix,de		;ਯ ᫥饣 ࠧ
  44++AE3C ~            	djnz	loop012
  45++AE3C ~            goto036	ld	a,errPartNotFound
  46++AE3C ~            goto035	scf
  47++AE3C ~            goto037	pop	ix
  48++AE3C ~            	ret
  49++AE3C ~
  50++AE3C              	endif
  51++AE3C
  52++AE3C              ;------------------------------------------------------------------------------
  53++AE3C              GetAdrMFSorFAT	ifused
  54++AE3C              ; ࠧ MFS/FAT32  
  55++AE3C              ;:  l -  ࠧ
  56++AE3C              ;: cy=1 訡 ⥭/,  ࠧ  
  57++AE3C              ;       a=errRWnum
  58++AE3C              ;       a=errPartNotFound
  59++AE3C              ;       a=errInvalidPart
  60++AE3C              ;     cy=0 ࠧ 
  61++AE3C              ;       a =#53 ࠧ MFS (⮫쪮  䏇)
  62++AE3C              ;         =#0B FAT32
  63++AE3C              ;         =#0C FAT32 (LBA)
  64++AE3C              ;       bc -  ਯ ࠧ  
  65++AE3C              ;       dehl - ᬥ饭 ࢮ ᥪ ࠧ
  66++AE3C              ;
  67++AE3C              ;GetAdrMFSorFAT
  68++AE3C              ;
  69++AE3C              ;⠭ 
  70++AE3C DD E5        	push	ix
  71++AE3E E5           	push	hl
  72++AE3F
  73++AE3F              ;⠭  ᮣ᭮  ࠧ
  74++AE3F 7D           	ld	a,l
  75++AE40              	SetHDDpart
  75++AE40 CD E6 98    >	call	DrvHDD.hddSetDevice
  76++AE43 3E 56        	ld	a,errHddNotFound
  77++AE45 38 53        	jr	c,goto031	; 
  78++AE47
  79++AE47              ;⥭ ᥪ MBR
  80++AE47 CD 37 B3     	call	SetZeroDEHL	;hl=de=#0000 (㫥 ᥪ)
  81++AE4A              	SetNumSectors_1		;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
  81++AE4A 3E 01       >	ld	a,#01
  81++AE4C 32 51 A4    >	ld	(DrvHDD.idePort1F2),a	;᫮ । ᥪ஢    ⥭/ (=#00->=#100)
  82++AE4F              	ReadSecMBR		;⥭ 㫥 ᥪ     Buf4MBR
  82++AE4F CD FE 9A    >	call	DrvHDD.RdSecHDD_DEHL
  83++AE52 3E 50        	ld	a,errRWnum
  84++AE54 38 44        	jr	c,goto031	;訡 ⥭
  85++AE56
  86++AE56              ; ࠧ MFS/FAT32  MBR
  87++AE56 2A D3 8C     	ld	hl,(Buf4MBR+#1FE)
  88++AE59 11 55 AA     	ld	de,#AA55	;ᨣ (55h AAh)
  89++AE5C B7           	or	a
  90++AE5D ED 52        	sbc	hl,de
  91++AE5F 20 37        	jr	nz,goto032	;ᨣ : MBR 
  92++AE61 E1           	pop	hl
  93++AE62 7D           	ld	a,l
  94++AE63 E6 03        	and	#03
  95++AE65 6F           	ld	l,a
  96++AE66 26 00        	ld	h,#00
  97++AE68 29           	add	hl,hl
  98++AE69 29           	add	hl,hl
  99++AE6A 29           	add	hl,hl
 100++AE6B 29           	add	hl,hl
 101++AE6C EB           	ex	de,hl
 102++AE6D DD 21 93 8C  	ld	ix,Buf4MBR+#1BE	;砫 ਯ஢ ࠧ HDD
 103++AE71 DD 19        	add	ix,de
 104++AE73 DD 7E 04     	ld	a,(ix+#04)
 105++AE76              	IFDEF	withMFS
 106++AE76 FE 53        	 cp	#53		; ⨯ ࠧ MFS
 107++AE78 28 0C        	 jr	z,goto033
 108++AE7A              	ENDIF
 109++AE7A FE 0B        	cp	#0B
 110++AE7C 28 08        	jr	z,goto033
 111++AE7E FE 0C        	cp	#0C
 112++AE80 28 04        	jr	z,goto033
 113++AE82 3E 6D        	ld	a,errInvalidPart
 114++AE84 18 15        	jr	goto034		;ࠧ  
 115++AE86 DD 6E 08     goto033	ld	l,(ix+#08)
 116++AE89 DD 66 09     	ld	h,(ix+#09)
 117++AE8C DD 5E 0A     	ld	e,(ix+#0A)
 118++AE8F DD 56 0B     	ld	d,(ix+#0B)	;dehl - ᬥ饭 ࢮ ᥪ ࠤ
 119++AE92 DD E5        	push	ix
 120++AE94 C1           	pop	bc
 121++AE95 DD E1        	pop	ix
 122++AE97 C9           	ret
 123++AE98 3E 66        goto032	ld	a,errPartNotFound;ᮮ饭: partition not found
 124++AE9A E1           goto031	pop	hl
 125++AE9B DD E1        goto034	pop	ix
 126++AE9D 37           	scf
 127++AE9E C9           	ret
 128++AE9F
 129++AE9F              	endif
 130++AE9F
 131++AE9F              ;==============================================================================
 132++AE9F
# file closed: Drivers/DrvFAT/DrvFAT.part.a80
 136+ AE9F              	INCLUDE	"DrvFAT.table.a80"
# file opened: Drivers/DrvFAT/DrvFAT.table.a80
   1++AE9F              ;楤  FAT Driver.   ⠡楩 FAT
   2++AE9F              ;䠩 DrvFAT.table.a80
   3++AE9F              ;
   4++AE9F              ;fatClearCls		⪠  FAT
   5++AE9F              ;GetAdrRealSector	᫥  䨧᪮ ᥪ
   6++AE9F              ;FindFreeClsFSinfo	 ᢮  稭  ࠬ  FSinfo
   7++AE9F              ;FindFreeClsRoot	 ᢮  稭  ୥ ⠫
   8++AE9F              ;			(砫 )
   9++AE9F              ;FindFreeCls		 ᢮ 
  10++AE9F              ;FreeClsChain		  楯 ஢  ᢮
  11++AE9F              ;AddCls2Chain		   楯
  12++AE9F              ;SetLastClsInFAT	 ਧ ᫥   楯 ஢
  13++AE9F              ;SetNClsInFAT		    楯 ஢
  14++AE9F              ;SaveSecFAT2Buf		 ᥪ ⠡ FAT   Buf4FAT
  15++AE9F              ;TestLastCLS		஢ઠ  ᫥  䠩
  16++AE9F              ;ReadFATnextCls		⥭  ᫥饣 
  17++AE9F              ;setFsInfoEmpty		  ࢮ ᢮   FsInfo
  18++AE9F              ;setFsInfoFreeCls	⠭  FsInfo  ᫥饣 ᢮ 
  19++AE9F              ;ReadFsIFreeCls		⥭  ࢮ ᢮   FSinfo
  20++AE9F              ;CountFreeCls		 ⢠ ᢮ ஢  ⥪饬 ࠧ 
  21++AE9F              ;SaveSecBuf2DIR		㧪 ᥪ ⠫   Buf4DIR
  22++AE9F              ;LoadSecDIR2Buf		㧪 ᥪ ⠫   Buf4DIR
  23++AE9F              ;LoadSecFAT2Buf		㧪 ᥪ   Buf4FAT
  24++AE9F              ;
  25++AE9F              ;------------------------------------------------------------------------------
  26++AE9F              fatClearCls	ifused
  27++AE9F              ;⪠  FAT
  28++AE9F              ;:  dehl -   FAT
  29++AE9F              ;     ix -  
  30++AE9F              ;: cy=1 訡 ⥭/
  31++AE9F              ;       a=errRWnum
  32++AE9F              ;     cy=0  饭
  33++AE9F              ;	dehl -  ࢮ ᥪ 
  34++AE9F              ;       bc=#0000
  35++AE9F              ;
  36++AE9F              ;fatClearCls
  37++AE9F              ;
  38++AE9F CD D8 AE     	call	GetAdrRealSector
  39++AEA2 3A EE 8C     	ld	a,(LenCLSInSec)
  40++AEA5 47           	ld	b,a
  41++AEA6 D5           	push	de
  42++AEA7 E5           	push	hl
  43++AEA8 C5           loop018	push	bc
  44++AEA9 E5           	push	hl
  45++AEAA D5           	push	de		;LBA  ᥪ
  46++AEAB              	hddSetCurrSec		;  ⠭  ६  LBA/CHS  ᨬ  ஥
  46++AEAB CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
  47++AEAE              	hddReadSec2IX		;⥭ ᥪ     ix
  47++AEAE CD 03 9B    >	call	DrvHDD.RdSecHDD_IX
  48++AEB1 38 1D        	jr	c,goto073	;訡 ⥭/
  49++AEB3 DD E5        	push	ix
  50++AEB5 E1           	pop	hl
  51++AEB6 5D           	ld	e,l
  52++AEB7 54           	ld	d,h
  53++AEB8 13           	inc	de
  54++AEB9 01 FF 01     	ld	bc,#01FF
  55++AEBC 36 00        	ld	(hl),#00
  56++AEBE ED B0        	ldir
  57++AEC0              	hddWriteSecIX		; ⮣ ᥪ
  57++AEC0 CD 32 9B    >	call	DrvHDD.WrSecHDD_IX
  58++AEC3 38 0B        	jr	c,goto073	;訡 ⥭/
  59++AEC5 D1           	pop	de
  60++AEC6 E1           	pop	hl
  61++AEC7 C1           	pop	bc
  62++AEC8 CD 7D B3     	call	Inc_DEHL
  63++AECB 10 DB        	djnz	loop018
  64++AECD 48           	ld	c,b
  65++AECE 18 05        	jr	goto074
  66++AED0 3E 50        goto073	ld	a,errRWnum
  67++AED2 D1           	pop	de
  68++AED3 E1           	pop	hl
  69++AED4 C1           	pop	bc
  70++AED5 E1           goto074	pop	hl
  71++AED6 D1           	pop	de
  72++AED7 C9           	ret
  73++AED8
  74++AED8              	endif
  75++AED8
  76++AED8              ;------------------------------------------------------------------------------
  77++AED8              GetAdrRealSector	ifused
  78++AED8              ;᫥  䨧᪮ ᥪ
  79++AED8              ;:  dehl -   FAT
  80++AED8              ;: dehl -  ᥪ
  81++AED8              ;     hl',de',bc' -  
  82++AED8              ;
  83++AED8              ;GetAdrRealSector
  84++AED8              ;
  85++AED8 7A           	ld	a,d
  86++AED9 B3           	or	e
  87++AEDA B4           	or	h
  88++AEDB B5           	or	l
  89++AEDC 28 09        	jr	z,goto015	; 㫥  ->  ୥ ⠫.  2
  90++AEDE              ;	jr	nz,goto015	; 㫥  ->  ୥ ⠫.  2
  91++AEDE              ;	ld	hl,(AdrFATonHDD)
  92++AEDE              ;	ld	de,(AdrFATonHDD+2)
  93++AEDE              ;	ld	bc,LenFATinSec
  94++AEDE              ;	push	bc
  95++AEDE              ;	call	Add_DEHL_adrBC
  96++AEDE              ;	pop	bc
  97++AEDE              ;	jp	Add_DEHL_adrBC
  98++AEDE              ;goto015
  99++AEDE
 100++AEDE              ;   묨
 101++AEDE 01 FE FF     	ld	bc,#FFFE
 102++AEE1 09           	add	hl,bc
 103++AEE2 03           	inc	bc
 104++AEE3 EB           	ex	de,hl
 105++AEE4 ED 4A        	adc	hl,bc
 106++AEE6 EB           	ex	de,hl		; -2
 107++AEE7 3A EE 8C     goto015	ld	a,(LenCLSInSec)	;ࠧ   ᥪ
 108++AEEA 18 08        	jr	goto016
 109++AEEC CB 25        loop009	sla	l
 110++AEEE CB 14        	rl	h
 111++AEF0 CB 13        	rl	e
 112++AEF2 CB 12        	rl	d
 113++AEF4 0F           goto016	rrca
 114++AEF5 30 F5        	jr	nc,loop009	;㬭  ࠧ 
 115++AEF7 01 D7 8C     	ld	bc,AdrPartBegin
 116++AEFA CD 8F B3     	call	Add_DEHL_adrBC	;ਡ ᬥ饭 砫 ࠧ  ᪥
 117++AEFD 01 E1 8C     	ld	bc,AdrDataBegin	; ࢮ ᥪ  ࠧ  BPB
 118++AF00 C3 8F B3     	jp	Add_DEHL_adrBC	;ਡ ᬥ饭 砫   ࠧ
 119++AF03
 120++AF03              	endif
 121++AF03
 122++AF03              ;------------------------------------------------------------------------------
 123++AF03              FindFreeClsFSinfo	ifused
 124++AF03              ; ᢮  稭  ࠬ  FSinfo
 125++AF03              ;: cy=1 訡 ⥭/
 126++AF03              ;        a=errRWnum -  訡
 127++AF03              ;     nc,z - ᢮   . FAT 稫
 128++AF03              ;     nc,nz - ⮩  
 129++AF03              ;       dehl -  ⮣ 
 130++AF03              ;
 131++AF03              ;FindFreeClsFSinfo
 132++AF03              ;
 133++AF03 CD 9D B0     	call	ReadFsIFreeCls
 134++AF06 D8           	ret	c			;訡
 135++AF07 28 08        	jr	z,FindFreeClsRoot	;  ⠭
 136++AF09 CD 18 AF     	call	FindFreeCls
 137++AF0C D8           	ret	c
 138++AF0D C0           	ret	nz			;nc,nz ⮩  
 139++AF0E CD 71 B0     	call	setFsInfoEmpty
 140++AF11 18 FE        	jr	FindFreeClsRoot
 141++AF13              	org	$-2
 142++AF11
 143++AF11              	endif
 144++AF11
 145++AF11              ;------------------------------------------------------------------------------
 146++AF11              FindFreeClsRoot	ifused
 147++AF11              ; ᢮  稭  ୥ ⠫ (砫 )
 148++AF11              ;: cy=1 訡 ⥭/
 149++AF11              ;        a=errRWnum -  訡
 150++AF11              ;     nc,z - ᢮   . FAT 稫
 151++AF11              ;     nc,nz - ⮩  
 152++AF11              ;       dehl -  ⮣ 
 153++AF11              ;
 154++AF11              ;FindFreeClsRoot
 155++AF11              ;
 156++AF11 2A EF 8C     	ld	hl,(RootClaster)
 157++AF14 ED 5B F1 8C  	ld	de,(RootClaster+2)
 158++AF18 18 FE        	jr	FindFreeCls
 159++AF1A              	org	$-2
 160++AF18
 161++AF18              	endif
 162++AF18
 163++AF18              ;------------------------------------------------------------------------------
 164++AF18              FindFreeCls	ifused
 165++AF18              ; ᢮ 
 166++AF18              ;:  dehl -    ண 稭 
 167++AF18              ;: cy=1 訡 ⥭/
 168++AF18              ;        a=errRWnum -  訡
 169++AF18              ;     nc,z - ᢮   . FAT 稫
 170++AF18              ;     nc,nz - ⮩  
 171++AF18              ;       dehl -  ⮣ 
 172++AF18              ;
 173++AF18              ;FindFreeCls
 174++AF18              ;
 175++AF18              ;ᬥ饭  砫쭮   =#00
 176++AF18 D5           	push	de
 177++AF19 E5           	push	hl
 178++AF1A CD 3D B3     	call	SetZero2tmpDWORD
 179++AF1D
 180++AF1D              ;㧨 ᥪ  ஬
 181++AF1D              ;  ⠥ ᬥ饭  ᥪ  砫 FAT ⠡
 182++AF1D 29           	add	hl,hl
 183++AF1E EB           	ex	de,hl
 184++AF1F ED 6A        	adc	hl,hl		;hlde=dehl*2
 185++AF21 EB           	ex	de,hl		;dehl=dehl*2
 186++AF22 4D           	ld	c,l
 187++AF23 CB 39        	srl	c
 188++AF25 06 00        	ld	b,#00		;bc    ᥪ
 189++AF27 6C           	ld	l,h
 190++AF28 63           	ld	h,e
 191++AF29 5A           	ld	e,d
 192++AF2A 50           	ld	d,b		;dehl - ᬥ饭  ᥪ  砫 FAT ⠡
 193++AF2B              ;  ஢ਬ  諨   ࠭ FAT
 194++AF2B D5           loop008	push	de
 195++AF2C E5           	push	hl
 196++AF2D C5           	push	bc
 197++AF2E 01 E9 8C     	ld	bc,LenFATinSec
 198++AF31 CD 49 B3     	call	cmp_DEHL_adrBC
 199++AF34 28 3D        	jr	z,goto012		;FAT 稫
 200++AF36 38 3B        	jr	c,goto012		;FAT 稫
 201++AF38 CD FF B0     	call	LoadSecFAT2Buf
 202++AF3B 38 37        	jr	c,goto013		;訡 ⥭/
 203++AF3D C1           	pop	bc
 204++AF3E 09           	add	hl,bc
 205++AF3F 09           	add	hl,bc
 206++AF40 09           	add	hl,bc
 207++AF41 09           	add	hl,bc
 208++AF42
 209++AF42              ;饬  㦥 ᥪ ⮩ 
 210++AF42 E5           loop007	push	hl
 211++AF43 CD 85 B3     	call	LD_DEHL_adrHL		;ld dehl,(hl)
 212++AF46 7D           	ld	a,l
 213++AF47 B4           	or	h
 214++AF48 B3           	or	e
 215++AF49 B2           	or	d
 216++AF4A E1           	pop	hl
 217++AF4B 28 16        	jr	z,goto014		;⮩  
 218++AF4D 23           	inc	hl
 219++AF4E 23           	inc	hl
 220++AF4F 23           	inc	hl
 221++AF50 23           	inc	hl
 222++AF51 04           	inc	b
 223++AF52 0C           	inc	c
 224++AF53 F2 42 AF     	jp	p,loop007
 225++AF56
 226++AF56              ;᫥騩 ᥪ  FAT
 227++AF56 CD 7A AF     	call	proc_04		;ਡ  (tmpDWORD) + b
 228++AF59 E1           	pop	hl
 229++AF5A D1           	pop	de
 230++AF5B CD 7D B3     	call	Inc_DEHL	;६  ᥪ
 231++AF5E 01 00 00     	ld	bc,#0000
 232++AF61 18 C8        	jr	loop008
 233++AF63
 234++AF63              ; ⮢  + b + (tmpDWORD)
 235++AF63              ;nc,nz - ⮩  
 236++AF63 E1           goto014	pop	hl
 237++AF64 D1           	pop	de
 238++AF65 CD 7A AF     	call	proc_04		;ਡ  (tmpDWORD) + b
 239++AF68 E1           	pop	hl
 240++AF69 D1           	pop	de
 241++AF6A 01 1D 8D     	ld	bc,tmpDWORD
 242++AF6D CD 8F B3     	call	Add_DEHL_adrBC	;dehl=dehl+(tmpDWORD)
 243++AF70 AF           	xor	a
 244++AF71 3C           	inc	a
 245++AF72 C9           	ret
 246++AF73
 247++AF73              ;nc,z - ᢮   . FAT 稫
 248++AF73 AF           goto012	xor	a
 249++AF74
 250++AF74              ;cy=1 訡 ⥭/
 251++AF74 C1           goto013	pop	bc
 252++AF75 C1           	pop	bc
 253++AF76 C1           	pop	bc
 254++AF77 E1           	pop	hl
 255++AF78 D1           	pop	de
 256++AF79 C9           	ret
 257++AF7A
 258++AF7A              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 259++AF7A              ;ਡ  (tmpDWORD) + b
 260++AF7A 21 1D 8D     proc_04	ld	hl,tmpDWORD
 261++AF7D 7E           	ld	a,(hl)
 262++AF7E 80           	add	a,b
 263++AF7F 77           	ld	(hl),a
 264++AF80 D0           	ret	nc
 265++AF81 23           	inc	hl
 266++AF82 34           	inc	(hl)
 267++AF83 C0           	ret	nz
 268++AF84 23           	inc	hl
 269++AF85 34           	inc	(hl)
 270++AF86 C0           	ret	nz
 271++AF87 23           	inc	hl
 272++AF88 34           	inc	(hl)
 273++AF89 C9           	ret
 274++AF8A
 275++AF8A              	endif
 276++AF8A
 277++AF8A              ;------------------------------------------------------------------------------
 278++AF8A              FreeClsChain	ifused
 279++AF8A              ;  楯 ஢  ᢮
 280++AF8A              ;:  dehl -  (ࢮ)  楯窥
 281++AF8A              ;: cy=1 訡 ⥭/
 282++AF8A              ;        a=errRWnum -  訡
 283++AF8A              ;
 284++AF8A              ;FreeClsChain
 285++AF8A              ;
 286++AF8A              ;⠥    FSinfo
 287++AF8A E5           	push	hl
 288++AF8B D5           	push	de
 289++AF8C CD 9D B0     	call	ReadFsIFreeCls
 290++AF8F D1           	pop	de
 291++AF90 E1           	pop	hl
 292++AF91 D8           	ret	c
 293++AF92
 294++AF92              ;  
 295++AF92 CD 3D B3     	call	SetZero2tmpDWORD
 296++AF95
 297++AF95              ;஢ਬ  ᫥ 
 298++AF95 CD 42 B0     loop006	call	TestLastCLS
 299++AF98 3F           	ccf
 300++AF99 D2 80 B0     	jp	nc,setFsInfoVar		; ᫥ 
 301++AF9C              ;	ret	nc			; ᫥ 
 302++AF9C 7D           	ld	a,l
 303++AF9D B4           	or	h
 304++AF9E B3           	or	e
 305++AF9F B2           	or	d
 306++AFA0 CA 80 B0     	jp	z,setFsInfoVar		; ⮩ 
 307++AFA3              ;	ret	z			; ⮩ 
 308++AFA3
 309++AFA3              ;⠭    ६ FSinfo
 310++AFA3              ;  dehl -    楯窥
 311++AFA3 01 F7 8C     	ld	bc,FsINextCls
 312++AFA6 CD 49 B3     	call	cmp_DEHL_adrBC
 313++AFA9 FA B3 AF     	jp	m,goto203
 314++AFAC 22 F7 8C     	ld	(FsINextCls+0),hl
 315++AFAF ED 53 F9 8C  	ld	(FsINextCls+2),de
 316++AFB3
 317++AFB3              ;⠥  ᫥饣 
 318++AFB3 E5           goto203	push	hl
 319++AFB4 D5           	push	de
 320++AFB5 CD 55 B0     	call	ReadFATnextCls		;⠥  ᫥饣 
 321++AFB8 C1           	pop	bc
 322++AFB9 38 0C        	jr	c,goto009		;訡
 323++AFBB E3           	ex	(sp),hl
 324++AFBC D5           	push	de
 325++AFBD 59           	ld	e,c
 326++AFBE 50           	ld	d,b
 327++AFBF CD F8 AF     	call	SetNClsInFAT		;襬  ⥪騩 祭 0
 328++AFC2 D1           	pop	de
 329++AFC3 E1           	pop	hl
 330++AFC4 30 CF        	jr	nc,loop006
 331++AFC6 C9           	ret
 332++AFC7 C1           goto009	pop	bc
 333++AFC8 C9           	ret
 334++AFC9
 335++AFC9              	endif
 336++AFC9
 337++AFC9              ;------------------------------------------------------------------------------
 338++AFC9              AddCls2Chain	ifused
 339++AFC9              ;   楯
 340++AFC9              ;:  dehl -  (ࢮ)  楯窥
 341++AFC9              ;     (tmpDWORD) -  ,  㤥 뢠  楯 ஢
 342++AFC9              ;: cy=1 訡 ⥭/
 343++AFC9              ;        a=errRWnum -  訡
 344++AFC9              ;
 345++AFC9              ;AddCls2Chain
 346++AFC9              ;
 347++AFC9 E5           loop005	push	hl
 348++AFCA D5           	push	de
 349++AFCB CD 55 B0     	call	ReadFATnextCls	;dehl  ᫥饣 
 350++AFCE 38 09        	jr	c,goto008	;訡 ⥭
 351++AFD0 CD 42 B0     	call	TestLastCLS
 352++AFD3 38 0A        	jr	c,goto007
 353++AFD5 C1           	pop	bc
 354++AFD6 C1           	pop	bc
 355++AFD7 18 F0        	jr	loop005
 356++AFD9
 357++AFD9              ;室  訡
 358++AFD9 D1           goto008	pop	de
 359++AFDA E1           	pop	hl
 360++AFDB 3E 50        	ld	a,errRWnum	;R/W error _᫮_
 361++AFDD 37           	scf
 362++AFDE C9           	ret			;訡
 363++AFDF
 364++AFDF              ;   楯
 365++AFDF D1           goto007	pop	de
 366++AFE0 E1           	pop	hl
 367++AFE1 CD F8 AF     	call	SetNClsInFAT	;    楯 ஢
 368++AFE4 D8           	ret	c
 369++AFE5 21 1D 8D     	ld	hl,tmpDWORD
 370++AFE8 CD 85 B3     	call	LD_DEHL_adrHL
 371++AFEB 18 FE        	jr	SetLastClsInFAT
 372++AFED              	org	$-2
 373++AFEB
 374++AFEB ~            /* ஥, ਢ ࠡ⠥
 375++AFEB ~            loop005	call	TestLastCLS
 376++AFEB ~            	jr	c,goto007	; ᫥ 
 377++AFEB ~            	ld	a,l
 378++AFEB ~            	or	h
 379++AFEB ~            	or	e
 380++AFEB ~            	or	d
 381++AFEB ~            	jr	z,goto008	; ⮩ 
 382++AFEB ~            	call	ReadFATnextCls	;dehl -  ᫥饣 
 383++AFEB ~            	jr	nc,loop005
 384++AFEB ~            goto008	ld	a,errRWnum	;R/W error _᫮_
 385++AFEB ~            	scf
 386++AFEB ~            	ret			;訡
 387++AFEB ~            goto007	pop	de
 388++AFEB ~            	pop	hl
 389++AFEB ~            	call	SetNClsInFAT	;    楯 ஢
 390++AFEB ~            	ret	c
 391++AFEB ~            	ld	hl,tmpDWORD
 392++AFEB ~            	call	LD_DEHL_adrHL
 393++AFEB ~            	jr	SetLastClsInFAT
 394++AFEB ~            	org	$-2
 395++AFEB ~            */
 396++AFEB              	endif
 397++AFEB
 398++AFEB              ;------------------------------------------------------------------------------
 399++AFEB              SetLastClsInFAT	ifused
 400++AFEB              ; ਧ ᫥   楯 ஢
 401++AFEB              ;:  dehl -     襬  
 402++AFEB              ;: cy=1 訡 ⥭/
 403++AFEB              ;        a=errRWnum -  訡
 404++AFEB              ;
 405++AFEB              ;SetLastClsInFAT
 406++AFEB              ;
 407++AFEB 01 FF FF     	ld	bc,#FFFF
 408++AFEE ED 43 1D 8D  	ld	(tmpDWORD),bc
 409++AFF2 06 0F        	ld	b,#0F
 410++AFF4 ED 43 1F 8D  	ld	(tmpDWORD+2),bc
 411++AFF8 18 FE        	jr	SetNClsInFAT
 412++AFFA              	org	$-2
 413++AFF8
 414++AFF8              	endif
 415++AFF8
 416++AFF8              ;------------------------------------------------------------------------------
 417++AFF8              SetNClsInFAT	ifused
 418++AFF8              ;    楯 ஢
 419++AFF8              ;:  dehl -     襬  
 420++AFF8              ;     (tmpDWORD) -  ,  㤥 뢠  楯 ஢
 421++AFF8              ;: cy=1 訡 ⥭/
 422++AFF8              ;        a=errRWnum -  訡
 423++AFF8              ;
 424++AFF8              ;SetNClsInFAT
 425++AFF8              ;
 426++AFF8 29           	add	hl,hl
 427++AFF9 EB           	ex	de,hl
 428++AFFA ED 6A        	adc	hl,hl		;hlde=dehl*2
 429++AFFC EB           	ex	de,hl		;dehl=dehl*2
 430++AFFD 4D           	ld	c,l
 431++AFFE 6C           	ld	l,h
 432++AFFF 63           	ld	h,e
 433++B000 5A           	ld	e,d
 434++B001 16 00        	ld	d,#00		;dehl - ᬥ饭  ᥪ  砫 FAT ⠡
 435++B003 D5           	push	de
 436++B004 E5           	push	hl
 437++B005 C5            	push	bc		;a - ᬥ饭  ᥪ/2
 438++B006 CD FF B0     	call	LoadSecFAT2Buf	;hl    ᥪ஬
 439++B009 D1           	pop	de
 440++B00A 38 10        	jr	c,goto006	;訡
 441++B00C 16 00        	ld	d,#00
 442++B00E 19           	add	hl,de
 443++B00F 19           	add	hl,de		;   ஬ ᫥饣 
 444++B010 EB           	ex	de,hl
 445++B011 21 1D 8D     	ld	hl,tmpDWORD
 446++B014 CD 71 B3     	call	CopyDWORD_HL_DE
 447++B017 E1           	pop	hl
 448++B018 D1           	pop	de
 449++B019 C3 1F B0     	jp	SaveSecFAT2Buf
 450++B01C E1           goto006	pop	hl
 451++B01D D1           	pop	de
 452++B01E C9           	ret
 453++B01F
 454++B01F              	endif
 455++B01F
 456++B01F              ;------------------------------------------------------------------------------
 457++B01F              SaveSecFAT2Buf	ifused
 458++B01F              ; ᥪ ⠡ FAT   Buf4FAT
 459++B01F              ;:  dehl -  ᥪ  ⠡ FAT (  )
 460++B01F              ;: cy=1 뫨 訡 ⥭/
 461++B01F              ;        a=errRWnum -  訡
 462++B01F              ;
 463++B01F              ;SaveSecFAT2Buf
 464++B01F              ;
 465++B01F 3A ED 8C     	ld	a,(NumsFATonPart)
 466++B022 01 DD 8C     	ld	bc,AdrFATonHDD
 467++B025 F5           loop004	push	af
 468++B026 CD 8F B3     	call	Add_DEHL_adrBC	;᫮ 4-⭮ ᫠   bc  dehl
 469++B029
 470++B029              ; ᥪ  ⠡ FAT
 471++B029 D5           	push	de
 472++B02A E5           	push	hl		;dehl - LBA  ᥪ FAT
 473++B02B              	hddSetCurrSec		;  ⠭  ६  LBA/CHS
 473++B02B CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 474++B02E 21 30 92     	ld	hl,Buf4FAT
 475++B031              	hddWriteSecHL		; ᥪ     hl
 475++B031 CD 37 9B    >	call	DrvHDD.WrSecHDD_HL
 476++B034 E1           	pop	hl
 477++B035 D1           	pop	de
 478++B036 C1           	pop	bc
 479++B037 3E 50        	ld	a,errRWnum	;R/W error _᫮_
 480++B039 D8           	ret	c		;訡
 481++B03A 78           	ld	a,b
 482++B03B 01 E9 8C     	ld	bc,LenFATinSec
 483++B03E 3D           	dec	a
 484++B03F 20 E4        	jr	nz,loop004
 485++B041 C9           	ret
 486++B042
 487++B042              	endif
 488++B042
 489++B042              ;------------------------------------------------------------------------------
 490++B042              TestLastCLS	ifused
 491++B042              ;஢ઠ  ᫥  䠩
 492++B042              ;:  dehl -  
 493++B042              ;: nz,nc -    ᫥
 494++B042              ;      z,nc -  ०
 495++B042              ;     nz,c  -  ᫥
 496++B042              ;
 497++B042              ;TestLastCLS
 498++B042              ;
 499++B042 B7           	or	a
 500++B043 E5           	push	hl
 501++B044 21 FF 0F     	ld	hl,#0FFF
 502++B047 ED 52        	sbc	hl,de
 503++B049 E1           	pop	hl
 504++B04A C0           	ret	nz
 505++B04B D5           	push	de
 506++B04C 11 F7 FF     	ld	de,#FFF7
 507++B04F EB           	ex	de,hl
 508++B050 ED 52        	sbc	hl,de
 509++B052 EB           	ex	de,hl
 510++B053 D1           	pop	de
 511++B054 C9           	ret
 512++B055
 513++B055              	endif
 514++B055
 515++B055              ;------------------------------------------------------------------------------
 516++B055              ReadFATnextCls	ifused
 517++B055              ;⥭  ᫥饣 
 518++B055              ;:  dehl -  
 519++B055              ;: cy=1 訡 ⥭
 520++B055              ;        a=errRWnum -  訡
 521++B055              ;     dehl -  ᫥饣 
 522++B055              ;     hl',de',bc' - ???
 523++B055              ;
 524++B055              ;ReadFATnextCls
 525++B055              ;
 526++B055 29           	add	hl,hl
 527++B056 EB           	ex	de,hl
 528++B057 ED 6A        	adc	hl,hl		;hlde=dehl*2
 529++B059 EB           	ex	de,hl		;dehl=dehl*2
 530++B05A 7D           	ld	a,l
 531++B05B 6C           	ld	l,h
 532++B05C 63           	ld	h,e
 533++B05D 5A           	ld	e,d
 534++B05E 16 00        	ld	d,#00		;dehl - ᬥ饭  ᥪ  砫 FAT ⠡
 535++B060 F5           	push	af		;a - ᬥ饭  ᥪ/2
 536++B061 CD FF B0     	call	LoadSecFAT2Buf	;hl    ᥪ஬
 537++B064 38 09        	jr	c,goto005	;訡
 538++B066 F1           	pop	af
 539++B067 5F           	ld	e,a
 540++B068 16 00        	ld	d,#00
 541++B06A 19           	add	hl,de
 542++B06B 19           	add	hl,de		;   ஬ ᫥饣 
 543++B06C C3 85 B3     	jp	LD_DEHL_adrHL	;ld dehl,(hl)
 544++B06F C1           goto005	pop	bc
 545++B070 C9           	ret
 546++B071
 547++B071              	endif
 548++B071
 549++B071              ;------------------------------------------------------------------------------
 550++B071              setFsInfoEmpty	ifused
 551++B071              ;  ࢮ ᢮   FsInfo
 552++B071              ;  (⠭  #FFFFFFFF)
 553++B071              ;: cy=1 訡 ⥭/
 554++B071              ;        a=errRWnum -  訡
 555++B071              ;     de,hl,bc -  
 556++B071              ;
 557++B071              ;setFsInfoEmpty
 558++B071              ;
 559++B071 E5           	push	hl
 560++B072 D5           	push	de
 561++B073 C5           	push	bc
 562++B074 21 FF FF     	ld	hl,#FFFF
 563++B077 5C           	ld	e,h
 564++B078 54           	ld	d,h
 565++B079 CD 86 B0     	call	setFsInfoFreeCls
 566++B07C C1           	pop	bc
 567++B07D D1           	pop	de
 568++B07E E1           	pop	hl
 569++B07F C9           	ret
 570++B080
 571++B080              	endif
 572++B080
 573++B080              ;------------------------------------------------------------------------------
 574++B080              setFsInfoVar	ifused
 575++B080              ;⠭  FsInfo  ᫥饣 ᢮   ६ FsINextCls
 576++B080              ;:  (FsINextCls) -  ᢮ 
 577++B080              ;: cy=1 訡 ⥭/
 578++B080              ;        a=errRWnum -  訡
 579++B080              ;     dehl -  
 580++B080              ;
 581++B080              ;setFsInfoVar
 582++B080              ;
 583++B080 21 F7 8C     	ld	hl,FsINextCls
 584++B083 CD 85 B3     	call	LD_DEHL_adrHL
 585++B086 18 FE        	jr	setFsInfoFreeCls
 586++B088              	org	$-2
 587++B086
 588++B086              	endif
 589++B086
 590++B086              ;------------------------------------------------------------------------------
 591++B086              setFsInfoFreeCls	ifused
 592++B086              ;⠭  FsInfo  ᫥饣 ᢮ 
 593++B086              ;:  dehl -  ᢮ 
 594++B086              ;: cy=1 訡 ⥭/
 595++B086              ;        a=errRWnum -  訡
 596++B086              ;     dehl -  
 597++B086              ;
 598++B086              ;setFsInfoFreeCls
 599++B086              ;
 600++B086 E5           	push	hl
 601++B087 D5           	push	de
 602++B088 CD 9D B0     	call	ReadFsIFreeCls
 603++B08B D1           	pop	de
 604++B08C E1           	pop	hl
 605++B08D D8           	ret	c
 606++B08E 22 C1 8C     	ld	(Buf4MBR+#1EC+0),hl
 607++B091 ED 53 C3 8C  	ld	(Buf4MBR+#1EC+2),de
 608++B095 21 D5 8A     	ld	hl,Buf4MBR
 609++B098              	hddWriteSecHL
 609++B098 CD 37 9B    >	call	DrvHDD.WrSecHDD_HL
 610++B09B 18 18        	jr	goto030
 611++B09D
 612++B09D              	endif
 613++B09D
 614++B09D              ;------------------------------------------------------------------------------
 615++B09D              ReadFsIFreeCls	ifused
 616++B09D              ;⥭  ࢮ ᢮   FSinfo
 617++B09D              ;: cy=1 訡 ⥭
 618++B09D              ;        a=errRWnum -  訡
 619++B09D              ;     cy=0   ⠭
 620++B09D              ;        (FsINextCls),dehl -  ᢮   FSinfo
 621++B09D              ;        z -   =#FFFFFFFF
 622++B09D              ;     bc,a - ???
 623++B09D              ;
 624++B09D              ;ReadFsIFreeCls
 625++B09D              ;
 626++B09D 2A D7 8C     	ld	hl,(AdrPartBegin)
 627++B0A0 ED 5B D9 8C  	ld	de,(AdrPartBegin+2)
 628++B0A4 ED 4B DB 8C  	ld	bc,(AdrFsInfo)
 629++B0A8 09           	add	hl,bc
 630++B0A9 30 01        	jr	nc,goto029
 631++B0AB 13           	inc	de
 632++B0AC              goto029	hddSetCurrSec			;  ⠭  ६  LBA/CHS
 632++B0AC CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 633++B0AF 21 D5 8A     	ld	hl,Buf4MBR
 634++B0B2              	hddReadSec2HL			;⥭ ᥪ     hl
 634++B0B2 CD 0B 9B    >	call	DrvHDD.RdSecHDD_HL
 635++B0B5 3E 50        goto030	ld	a,errRWnum		;R/W error _᫮_
 636++B0B7 D8           	ret	c
 637++B0B8 2A C1 8C     	ld	hl,(Buf4MBR+#1EC+0)
 638++B0BB ED 5B C3 8C  	ld	de,(Buf4MBR+#1EC+2)
 639++B0BF 22 F7 8C     	ld	(FsINextCls+0),hl
 640++B0C2 ED 53 F9 8C  	ld	(FsINextCls+2),de
 641++B0C6 7D           	ld	a,l
 642++B0C7 A4           	and	h
 643++B0C8 A3           	and	e
 644++B0C9 A2           	and	d
 645++B0CA 3C           	inc	a
 646++B0CB C9           	ret
 647++B0CC
 648++B0CC              	endif
 649++B0CC
 650++B0CC              ;------------------------------------------------------------------------------
 651++B0CC              CountFreeCls	ifused
 652++B0CC ~            ; ⢠ ᢮ ஢  ⥪饬 ࠧ 
 653++B0CC ~            ;: cy=1 訡 ⥭ hdd
 654++B0CC ~            ;        a=errRWnum -  訡
 655++B0CC ~            ;     cy=0 訡  뫮
 656++B0CC ~            ;        dehl - ⢮ ᢮ ஢
 657++B0CC ~            ;
 658++B0CC ~            ;CountFreeCls
 659++B0CC ~            ;
 660++B0CC ~            	call	SetZero2tmpDWORD
 661++B0CC ~            	ld	hl,(LenFATinSec)
 662++B0CC ~            	ld	de,(LenFATinSec+2)
 663++B0CC ~
 664++B0CC ~            ;㧪 । ᥪ FAT
 665++B0CC ~            ;  dehl 浪  ᥪ  ⠡ FAT
 666++B0CC ~            loop003	call	Dec_DEHL
 667++B0CC ~            	push	hl
 668++B0CC ~            	push	de
 669++B0CC ~            	call	LoadSecFAT2Buf	;㧪 ᥪ FAT
 670++B0CC ~            	jr	c,goto003
 671++B0CC ~
 672++B0CC ~            ;  ஢  ᥪ FAT
 673++B0CC ~            	ld	b,#80
 674++B0CC ~            loop002	ld	a,(hl)
 675++B0CC ~            	inc	hl
 676++B0CC ~            	or	(hl)
 677++B0CC ~            	inc	hl
 678++B0CC ~            	or	(hl)
 679++B0CC ~            	inc	hl
 680++B0CC ~            	or	(hl)
 681++B0CC ~            	inc	hl
 682++B0CC ~            	jr	nz,goto004
 683++B0CC ~            	ex	de,hl
 684++B0CC ~            	ld	hl,tmpDWORD
 685++B0CC ~            	call	Inc_addrHL
 686++B0CC ~            	ex	de,hl
 687++B0CC ~            goto004	djnz	loop002
 688++B0CC ~
 689++B0CC ~            ;᫥騩 ᥪ FAT
 690++B0CC ~            	pop	de
 691++B0CC ~            	pop	hl
 692++B0CC ~            	ld	a,l
 693++B0CC ~            	or	h
 694++B0CC ~            	or	e
 695++B0CC ~            	or	d
 696++B0CC ~            	jr	nz,loop003
 697++B0CC ~
 698++B0CC ~            ;⢮  ஢
 699++B0CC ~            	ld	hl,(tmpDWORD)
 700++B0CC ~            	ld	de,(tmpDWORD+2)
 701++B0CC ~            	ret
 702++B0CC ~
 703++B0CC ~            ;訡 ⥭ 
 704++B0CC ~            goto003	pop	de
 705++B0CC ~            	pop	hl
 706++B0CC ~            	ret
 707++B0CC ~
 708++B0CC              	endif
 709++B0CC
 710++B0CC              ;------------------------------------------------------------------------------
 711++B0CC              SaveSecBuf2DIR	ifused
 712++B0CC              ; ᥪ ⠫   Buf4DIR
 713++B0CC              ;:  (SecDIRinBuf) - LBA  ᥪ ⠫
 714++B0CC              ;: cy=1 뫨 訡 ⥭/
 715++B0CC              ;        a=errRWnum -  訡
 716++B0CC              ;
 717++B0CC              ;SaveSecBuf2DIR
 718++B0CC              ;
 719++B0CC 21 0E 8D     	ld	hl,SecDIRinBuf
 720++B0CF CD 85 B3     	call	LD_DEHL_adrHL
 721++B0D2              	hddSetCurrSec		;  ⠭  ६  LBA/CHS
 721++B0D2 CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 722++B0D5 21 30 90     	ld	hl,Buf4DIR	;(xE046) ࠬ LBA/CHS  ᨬ  ஥
 723++B0D8              	hddWriteSecHL
 723++B0D8 CD 37 9B    >	call	DrvHDD.WrSecHDD_HL
 724++B0DB D0           	ret	nc
 725++B0DC 3E 50        	ld	a,errRWnum	;R/W error _᫮_
 726++B0DE C9           	ret
 727++B0DF
 728++B0DF              	endif
 729++B0DF
 730++B0DF              ;------------------------------------------------------------------------------
 731++B0DF              LoadSecDIR2Buf	ifused
 732++B0DF              ;㧪 ᥪ ⠫   Buf4DIR
 733++B0DF              ;:  dehl - LBA  ᥪ ⠫
 734++B0DF              ;: hl=Buf4DIR
 735++B0DF              ;     cy=1 뫨 訡 ⥭/
 736++B0DF              ;        a=errRWnum -  訡
 737++B0DF              ;     hl',de',bc' - ???
 738++B0DF              ;
 739++B0DF              ;LoadSecDIR2Buf
 740++B0DF              ;
 741++B0DF 01 0E 8D     	ld	bc,SecDIRinBuf
 742++B0E2 CD 27 B1     	call	proc_02		;஢ઠ,  㦥  ᥪ  
 743++B0E5 20 04        	jr	nz,goto002	;㦠
 744++B0E7 21 30 90     	ld	hl,Buf4DIR
 745++B0EA C9           	ret
 746++B0EB              ;⥭ ᥪ
 747++B0EB 22 0E 8D     goto002	ld	(SecDIRinBuf),hl
 748++B0EE ED 53 10 8D  	ld	(SecDIRinBuf+2),de
 749++B0F2              	hddSetCurrSec		;  ⠭  ६  LBA/CHS
 749++B0F2 CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 750++B0F5 21 30 90     	ld	hl,Buf4DIR	;(xE046) ࠬ LBA/CHS  ᨬ  ஥
 751++B0F8 CD 1B B1     	call	proc_03
 752++B0FB 21 30 90     	ld	hl,Buf4DIR
 753++B0FE C9           	ret
 754++B0FF
 755++B0FF 18 FE        	jr	LoadSecFAT2Buf
 756++B101              	org	$-2
 757++B0FF              	endif
 758++B0FF
 759++B0FF              ;------------------------------------------------------------------------------
 760++B0FF              LoadSecFAT2Buf	ifused
 761++B0FF              ;㧪 ᥪ ⠡ FAT   Buf4FAT
 762++B0FF              ;:  dehl -  ᥪ  ⠡ FAT (  )
 763++B0FF              ;: hl=Buf4FAT
 764++B0FF              ;     cy=1 뫨 訡 ⥭/
 765++B0FF              ;        a=errRWnum -  訡
 766++B0FF              ;     hl',de',bc' - ???
 767++B0FF              ;
 768++B0FF              ;LoadSecFAT2Buf
 769++B0FF              ;
 770++B0FF 01 DD 8C     	ld	bc,AdrFATonHDD
 771++B102 CD 8F B3     	call	Add_DEHL_adrBC	;᫮ 4-⭮ ᫠   bc  dehl
 772++B105 CD 24 B1     	call	proc_01		;஢ઠ,  㦥  ᥪ  
 773++B108 20 04        	jr	nz,goto001	;㦠
 774++B10A 21 30 92     	ld	hl,Buf4FAT
 775++B10D C9           	ret
 776++B10E              ;⥭ ᥪ
 777++B10E 22 0A 8D     goto001	ld	(SecFATinBuf),hl
 778++B111 ED 53 0C 8D  	ld	(SecFATinBuf+2),de
 779++B115              	hddSetCurrSec		;  ⠭  ६  LBA/CHS
 779++B115 CD 5E 9B    >	call	DrvHDD.hddSetVarLBAadr
 780++B118 21 30 92     	ld	hl,Buf4FAT	;(xE046) ࠬ LBA/CHS  ᨬ  ஥
 781++B11B E5           proc_03	push	hl
 782++B11C              	hddReadSec2HL		;⥭ ᥪ     hl
 782++B11C CD 0B 9B    >	call	DrvHDD.RdSecHDD_HL
 783++B11F E1           	pop	hl
 784++B120 D0           	ret	nc
 785++B121 3E 50        	ld	a,errRWnum	;R/W error _᫮_
 786++B123 C9           	ret
 787++B124              ;஢ઠ,  㦥  ᥪ  
 788++B124              ;: z - ᥪ 㦥 㦥
 789++B124 01 0A 8D     proc_01	ld	bc,SecFATinBuf
 790++B127 0A           proc_02	ld	a,(bc)
 791++B128 03           	inc	bc
 792++B129 BD           	cp	l
 793++B12A C0           	ret	nz
 794++B12B 0A           	ld	a,(bc)
 795++B12C 03           	inc	bc
 796++B12D BC           	cp	h
 797++B12E C0           	ret	nz
 798++B12F 0A           	ld	a,(bc)
 799++B130 03           	inc	bc
 800++B131 BB           	cp	e
 801++B132 C0           	ret	nz
 802++B133 0A           	ld	a,(bc)
 803++B134 BA           	cp	d
 804++B135 C9           	ret
 805++B136
 806++B136              	endif
 807++B136
 808++B136              ;==============================================================================
 809++B136
# file closed: Drivers/DrvFAT/DrvFAT.table.a80
 137+ B136              	INCLUDE	"DrvFAT.str.a80"
# file opened: Drivers/DrvFAT/DrvFAT.str.a80
   1++B136              ;楤  FAT Driver. ࠡ  ப
   2++B136              ;䠩 DrvFAT.str.a80
   3++B136              ;
   4++B136              ;strSetExtToName	⠭  ७   䠩
   5++B136              ;RenewPath		室  㣮 ⠫ (䨪 ப   ⠫)
   6++B136              ;strHddPart		뤥    ࠧ  ப
   7++B136              ;FileName2NameExt	஢  䠩  ଠ 8+3  ଠ name.ext
   8++B136              ;FileNameLFNto8dot3	ॢ  䠩  ଠ name.ext  ଠ 8+3
   9++B136              ;			(  ⪮   ਯ)
  10++B136              ;FileNameTo8dot3	ॢ  䠩  ଠ name.ext  ଠ 8+3
  11++B136              ;			(   ਯ)
  12++B136              ;strCopyName		ନ㥬  䠩/७    B, 
  13++B136              ;			窨    ப
  14++B136              ;TestPathFile		஢ઠ /  䠩  ⨬ ᨬ
  15++B136              ;			 ॢ 㪢  孨 ॣ
  16++B136              ;strTestFileName	஢ઠ  䠩  ⨬ ᨬ 
  17++B136              ;			ॢ 㪢  孨 ॣ
  18++B136              ;strTestNameLFN		஢ઠ  ⨬ ᨬ   LFN
  19++B136              ;chrCheckLFN		஢ઠ  ⨬ ᨬ  LFN
  20++B136              ;SkipSeparator		ய   ࠧ⥫   
  21++B136              ;toUpCaseHL		ॢ ᨬ [a..z], [..]  ப  孨
  22++B136              ;			ॣ, 㤠 㡫 ࠧ⥫
  23++B136              ;
  24++B136              ;------------------------------------------------------------------------------
  25++B136              strSetExtToName	ifused
  26++B136 ~            ;⠭  ७   䠩
  27++B136 ~            ;     ஢७  ॢ  孨 ॣ
  28++B136 ~            ;  ᨬ  ப <#20
  29++B136 ~            ;:  hl -  ப   䠩  ଠ 8.3
  30++B136 ~            ;     de -  ப  ७
  31++B136 ~            ;: de -    䠩
  32++B136 ~            ;
  33++B136 ~            ;strSetExtToName
  34++B136 ~            ;
  35++B136 ~            	push	hl
  36++B136 ~            	push	bc
  37++B136 ~            loop052	ld	a,(hl)
  38++B136 ~            	inc	hl
  39++B136 ~            	cp	#20
  40++B136 ~            	jr	c,goto138	; 
  41++B136 ~            	cp	"."
  42++B136 ~            	jr	nz,loop052	; ७
  43++B136 ~            goto138	dec	hl
  44++B136 ~            	ld	(hl),"."
  45++B136 ~            	inc	hl
  46++B136 ~            	ex	de,hl
  47++B136 ~            	ldi
  48++B136 ~            	ldi
  49++B136 ~            	ldi
  50++B136 ~            	xor	a
  51++B136 ~            	ld	(de),a
  52++B136 ~            	pop	bc
  53++B136 ~            	pop	hl
  54++B136 ~            	ret
  55++B136 ~
  56++B136              	endif
  57++B136
  58++B136              ;------------------------------------------------------------------------------
  59++B136              RenewPath	ifused
  60++B136              ;室  㣮 ⠫ (䨪 ப   ⠫)
  61++B136              ;:  hl -  ਯ 䠩
  62++B136              ;     7,e =0  䠩/⠫
  63++B136              ;         =1    த⥫᪨ ⠫
  64++B136              ;     0,e =1   
  65++B136              ;: a -   
  66++B136              ;
  67++B136              ;RenewPath
  68++B136              ;
  69++B136 E5           	push	hl
  70++B137 CB 7B        	bit	7,e
  71++B139 EB           	ex	de,hl
  72++B13A 21 30 94     	ld	hl,CurrentPath
  73++B13D 4E           	ld	c,(hl)		; 
  74++B13E 06 00        	ld	b,#00
  75++B140 09           	add	hl,bc
  76++B141 20 14        	jr	nz,goto121	;室  த⥫᪨ ⠫
  77++B143
  78++B143              ;室  ⠫ ( ४ਨ  ⥪饬 )
  79++B143 EB           	ex	de,hl
  80++B144 CD 60 B1     	call	FileName2NameExt
  81++B147 EB           	ex	de,hl
  82++B148 36 2F        	ld	(hl),fnSep	;"/" ᨬ ࠧ⥫
  83++B14A 23           goto122	inc	hl
  84++B14B 36 00        	ld	(hl),#00
  85++B14D 01 30 94     	ld	bc,CurrentPath
  86++B150 B7           	or	a
  87++B151 ED 42        	sbc	hl,bc
  88++B153 7D           	ld	a,l
  89++B154 02           	ld	(bc),a		;  
  90++B155 E1           	pop	hl
  91++B156 C9           	ret
  92++B157
  93++B157              ;室  த⥫᪨ ⠫
  94++B157 2B           goto121	dec	hl
  95++B158 2B           loop048	dec	hl
  96++B159 7E           	ld	a,(hl)
  97++B15A FE 2F        	cp	fnSep		;"/"
  98++B15C 20 FA        	jr	nz,loop048
  99++B15E 18 EA        	jr	goto122
 100++B160
 101++B160              	endif
 102++B160
 103++B160              ;------------------------------------------------------------------------------
 104++B160              strHddPart	ifused
 105++B160 ~            ;뤥    ࠧ  ப
 106++B160 ~            ;:  hl -  ப, ᮤঠ饩   䠩  asciz
 107++B160 ~            ;        ଠ  䠩: [hd{0|1},{0|1|2|3}:]\[DIR\DIR\..\DIR\]filename.ext
 108++B160 ~            ;: cy=1 - ᯥ譮
 109++B160 ~            ;        c -   [0..1]
 110++B160 ~            ;        b -  ࠧ   [0..3]
 111++B160 ~            ;        a -   ப ࠧ
 112++B160 ~            ;     cy=0 - ࠧ  ப 
 113++B160 ~            ;        a - ⥪騩 ࠧ
 114++B160 ~            ;     hl - 砫   䠩,   
 115++B160 ~            ;
 116++B160 ~            ;strHddPart
 117++B160 ~            ;
 118++B160 ~            ;뤥    ࠧ  ப
 119++B160 ~            	push	hl
 120++B160 ~            	ld	a,(hl)
 121++B160 ~            	and	#5F
 122++B160 ~            	cp	"H"
 123++B160 ~            	jr	nz,goto055	;ࠧ  㪠
 124++B160 ~            	inc	hl
 125++B160 ~            	ld	a,(hl)
 126++B160 ~            	and	#5F
 127++B160 ~            	cp	"D"
 128++B160 ~            	jr	nz,goto055	;ࠧ  㪠
 129++B160 ~            	inc	hl
 130++B160 ~            	ld	c,(hl)		; 
 131++B160 ~            	inc	hl
 132++B160 ~            	ld	a,(hl)		;ࠧ⥫.   
 133++B160 ~            	cp	","
 134++B160 ~            	jr	nz,goto055	;ࠧ  㪠
 135++B160 ~            	inc	hl
 136++B160 ~            	ld	b,(hl)		; ࠧ
 137++B160 ~            	inc	hl
 138++B160 ~            	ld	a,":"
 139++B160 ~            	cp	(hl)
 140++B160 ~            	jr	nz,goto055	;ࠧ  㪠
 141++B160 ~            	inc	hl
 142++B160 ~
 143++B160 ~            ;뤥  ࠧ
 144++B160 ~            	ld	a,b
 145++B160 ~            	sub	"0"
 146++B160 ~            	jr	c,goto055	;nz 騩 ࠧ
 147++B160 ~            	cp	#04
 148++B160 ~            	ld	b,a		; ࠧ [0..3]
 149++B160 ~            	jr	nc,goto055	;nz 騩 ࠧ
 150++B160 ~
 151++B160 ~            ;뤥  
 152++B160 ~            	ld	a,c
 153++B160 ~            	sub	"0"
 154++B160 ~            	jr	c,goto055	;nz 騩 ࠧ
 155++B160 ~            	IFDEF	ZC
 156++B160 ~            	cp	#03
 157++B160 ~            	ELSE
 158++B160 ~            	cp	#02
 159++B160 ~            	ENDIF
 160++B160 ~            	jr	nc,goto055	;nz 騩 ࠧ
 161++B160 ~            	ld	c,a
 162++B160 ~            	add	a,a
 163++B160 ~            	add	a,a
 164++B160 ~            	or	b
 165++B160 ~            	ex	(sp),hl
 166++B160 ~            	pop	hl
 167++B160 ~            	scf
 168++B160 ~            	ret
 169++B160 ~
 170++B160 ~            ;  ࠧ  ப  㦥
 171++B160 ~            goto055	xor	a
 172++B160 ~            	pop	hl
 173++B160 ~            	ld	a,(PartitionNum)
 174++B160 ~            	ret
 175++B160 ~
 176++B160              	endif
 177++B160
 178++B160              ;------------------------------------------------------------------------------
 179++B160              FileName2NameExt	ifused
 180++B160              ;஢  䠩  ଠ 8+3  ଠ name.ext
 181++B160              ;:  hl -  ਯ 䠩 (  ଠ 8+3)
 182++B160              ;     de -  ਥ
 183++B160              ;: de - ॢ ᢮  ਥ
 184++B160              ;     hl=hl+#0B ( ਡ⮢  ਯ)
 185++B160              ;
 186++B160              ;FileName2NameExt
 187++B160              ;
 188++B160 3E 08        	ld	a,#08
 189++B162 CD 6F B1     	call	proc_09
 190++B165 7E           	ld	a,(hl)		; ७, ᫨ 
 191++B166 FE 20        	cp	" "
 192++B168 C8           	ret	z		;७ 
 193++B169 3E 2E        	ld	a,"."
 194++B16B 12           	ld	(de),a		;ࠧ⥫
 195++B16C 13           	inc	de
 196++B16D 3E 03        	ld	a,#03
 197++B16F 06 00        proc_09	ld	b,#00
 198++B171 4F           	ld	c,a
 199++B172 ED B0        	ldir
 200++B174 47           	ld	b,a
 201++B175 1B           loop047	dec	de		;㤠 ᫥ ஡
 202++B176 1A           	ld	a,(de)
 203++B177 13           	inc	de
 204++B178 FE 20        	cp	" "
 205++B17A C0           	ret	nz
 206++B17B 1B           	dec	de
 207++B17C 10 F7        	djnz	loop047
 208++B17E C9           	ret
 209++B17F
 210++B17F              	endif
 211++B17F
 212++B17F              ;------------------------------------------------------------------------------
 213++B17F              FileNameLFNto8dot3	ifused
 214++B17F              ;ॢ  䠩  ଠ name.ext  ଠ 8+3(  ⪮
 215++B17F              ;    ਯ)
 216++B17F              ;  ᨬ  ப <#20, ࠧ⥫  ⠫ fnSep
 217++B17F              ;:  hl -    ଠ [\]name[.][ext]\
 218++B17F              ;     de -  ਥ 
 219++B17F              ;: hl -  ᫥饣   
 220++B17F              ;     b=#00
 221++B17F              ;
 222++B17F              ;FileNameLFNto8dot3
 223++B17F              ;
 224++B17F CD 7F B2     	call	SkipSeparator
 225++B182
 226++B182              ;ନ㥬  䠩
 227++B182 D5           	push	de
 228++B183 01 7F 08     	ld	bc,#087F
 229++B186 CD B9 B1     	call	strCopyName
 230++B189
 231++B189              ;饬  砫 ७
 232++B189 7E           loop060	ld	a,(hl)
 233++B18A FE 20        	cp	#20
 234++B18C 38 09        	jr	c,goto158		; ப
 235++B18E FE 2F        	cp	fnSep			;"/"
 236++B190 28 05        	jr	z,goto158		; 
 237++B192 23           	inc	hl
 238++B193 FE 2E        	cp	"."
 239++B195 20 F2        	jr	nz,loop060
 240++B197
 241++B197              ;ନ㥬 ७ 䠩
 242++B197 06 03        goto158	ld	b,#03
 243++B199 CD B9 B1     	call	strCopyName
 244++B19C
 245++B19C              ;ॢ  孨 ॣ
 246++B19C E3           	ex	(sp),hl
 247++B19D 1A           	ld	a,(de)
 248++B19E F5           	push	af
 249++B19F AF           	xor	a
 250++B1A0 12           	ld	(de),a
 251++B1A1 CD 8A B2     	call	toUpCaseHL
 252++B1A4 F1           	pop	af
 253++B1A5 12           	ld	(de),a
 254++B1A6 E1           	pop	hl
 255++B1A7
 256++B1A7 C9           	ret
 257++B1A8
 258++B1A8              	endif
 259++B1A8
 260++B1A8              ;------------------------------------------------------------------------------
 261++B1A8              FileNameTo8dot3	ifused
 262++B1A8              ;ॢ  䠩  ଠ name.ext  ଠ 8+3(   ਯ)
 263++B1A8              ;     ஢७  ॢ  孨 ॣ
 264++B1A8              ;  ᨬ  ப <#20, ࠧ⥫  ⠫ fnSep
 265++B1A8              ;:  hl -    ଠ [\]name[.][ext]\
 266++B1A8              ;     de -  ਥ 
 267++B1A8              ;: hl -  ᫥饣   
 268++B1A8              ;
 269++B1A8              ;FileNameTo8dot3
 270++B1A8              ;
 271++B1A8 CD 7F B2     	call	SkipSeparator
 272++B1AB
 273++B1AB              ;ନ㥬  䠩/७
 274++B1AB 01 FF 08     	ld	bc,#08FF
 275++B1AE CD B9 B1     	call	strCopyName
 276++B1B1 7E           	ld	a,(hl)
 277++B1B2 FE 2E        	cp	"."
 278++B1B4 20 01        	jr	nz,goto062
 279++B1B6 23           	inc	hl
 280++B1B7
 281++B1B7              ;ନ㥬 ७ 䠩
 282++B1B7 06 03        goto062	ld	b,#03
 283++B1B9 18 FE        	jr	strCopyName
 284++B1BB              	org	$-2
 285++B1B9
 286++B1B9 ~            /*  
 287++B1B9 ~            ;FileNameTo8dot3
 288++B1B9 ~            ;
 289++B1B9 ~            	ld	bc,#08FF
 290++B1B9 ~            	ld	a,(hl)
 291++B1B9 ~            	cp	fnSep		;"/"
 292++B1B9 ~            	jr	nz,loop022
 293++B1B9 ~            	inc	hl
 294++B1B9 ~
 295++B1B9 ~            ;ନ㥬  䠩
 296++B1B9 ~            loop022	ld	a,(hl)
 297++B1B9 ~            	cp	#20
 298++B1B9 ~            	jr	c,goto060	; 
 299++B1B9 ~            	cp	fnSep		;"/"
 300++B1B9 ~            	jr	z,goto060	; 
 301++B1B9 ~            	cp	"."
 302++B1B9 ~            	jr	z,goto061	; ७
 303++B1B9 ~            	ldi
 304++B1B9 ~            	djnz	loop022
 305++B1B9 ~            	ld	a,(hl)
 306++B1B9 ~            	cp	"."
 307++B1B9 ~            	jr	nz,goto062
 308++B1B9 ~            	inc	hl
 309++B1B9 ~            	jr	goto062
 310++B1B9 ~            goto061	inc	hl
 311++B1B9 ~            ;  塞 ⮪  ஡
 312++B1B9 ~            goto060	ld	a," "
 313++B1B9 ~            loop023	ld	(de),a
 314++B1B9 ~            	inc	de
 315++B1B9 ~            	djnz	loop023
 316++B1B9 ~
 317++B1B9 ~            ;ନ㥬 ७ 䠩
 318++B1B9 ~            goto062	ld	b,#03
 319++B1B9 ~            loop024	ld	a,(hl)
 320++B1B9 ~            	cp	#20
 321++B1B9 ~            	jr	c,goto064	; 
 322++B1B9 ~            	cp	fnSep		;"/"
 323++B1B9 ~            	jr	z,goto064	; 
 324++B1B9 ~            	ldi
 325++B1B9 ~            	djnz	loop024
 326++B1B9 ~            	ret
 327++B1B9 ~            ;  塞 ⮪ ७ ஡
 328++B1B9 ~            goto064	ld	a," "
 329++B1B9 ~            loop025	ld	(de),a
 330++B1B9 ~            	inc	de
 331++B1B9 ~            	djnz	loop025
 332++B1B9 ~            	ret
 333++B1B9 ~            */
 334++B1B9
 335++B1B9              	endif
 336++B1B9
 337++B1B9              ;------------------------------------------------------------------------------
 338++B1B9              strCopyName	ifused
 339++B1B9              ;ନ㥬  䠩/७    B,  窨    ப
 340++B1B9              ;:  hl -  ப   筨
 341++B1B9              ;     de -  ப ਥ
 342++B1B9              ;     b -  /७
 343++B1B9              ;     c=#7F/#FF   /  8.3  8+3
 344++B1B9              ;: hl - 㪠뢠   ப///᫥騩 ᨬ 
 345++B1B9              ;     de - ନ஢   ஡
 346++B1B9              ;     b=#00
 347++B1B9              ;
 348++B1B9              ;strCopyName
 349++B1B9              ;
 350++B1B9 7E           loop022	ld	a,(hl)
 351++B1BA FE 20        	cp	#20
 352++B1BC 38 15        	jr	c,goto060	; 
 353++B1BE 20 06        	jr	nz,goto176
 354++B1C0 CB 79        	bit	7,c
 355++B1C2 23           	inc	hl
 356++B1C3 28 F4        	jr	z,loop022	;஡ ய᪠
 357++B1C5 2B           	dec	hl
 358++B1C6 FE 2F        goto176	cp	fnSep		;"/"
 359++B1C8 28 09        	jr	z,goto060	; 
 360++B1CA FE 2E        	cp	"."
 361++B1CC 28 05        	jr	z,goto060	; ७
 362++B1CE ED A0        	ldi
 363++B1D0 10 E7        	djnz	loop022
 364++B1D2 C9           	ret
 365++B1D3
 366++B1D3              ;塞 ⮪  ஡
 367++B1D3 3E 20        goto060	ld	a," "
 368++B1D5 12           loop023	ld	(de),a
 369++B1D6 13           	inc	de
 370++B1D7 10 FC        	djnz	loop023
 371++B1D9 C9           	ret
 372++B1DA
 373++B1DA              	endif
 374++B1DA
 375++B1DA              ;------------------------------------------------------------------------------
 376++B1DA              TestPathFile	ifused
 377++B1DA              ;஢ઠ /  䠩  ⨬ ᨬ  ॢ 㪢  孨
 378++B1DA              ;  ॣ,   ࠧ⥫  /
 379++B1DA              ;  ᨬ  ப <#20, ࠧ⥫  ⠫ \  /
 380++B1DA              ;:  hl -  砫 
 381++B1DA              ;: cy=1  ᮤন ⨬ ᨬ,  ᫨誮 
 382++B1DA              ;     cy=0 ᨭ⠪ ஢ઠ ன
 383++B1DA              ;       z -  ⮩ -> a,e=#00
 384++B1DA              ;       nz -   ⮩
 385++B1DA              ;         a -  (a=#00 ⮫쪮  䠩  )
 386++B1DA              ;         b=c=#00  稢 ࠧ⥫
 387++B1DA              ;
 388++B1DA              ;TestPathFile
 389++B1DA              ;
 390++B1DA CD 8A B2     	call	toUpCaseHL
 391++B1DD
 392++B1DD              ; 砩. ⮥ 
 393++B1DD 1E 00        	ld	e,#00		;
 394++B1DF 7E           	ld	a,(hl)
 395++B1E0 FE 20        	cp	#20
 396++B1E2 38 4B        	jr	c,goto133
 397++B1E4
 398++B1E4              ;ய⨬  ࠧ⥫
 399++B1E4 E5           	push	hl
 400++B1E5 CD 7F B2     	call	SkipSeparator
 401++B1E8              ;	cp	fnSep		;"/"
 402++B1E8              ;	jr	nz,loop032
 403++B1E8              ;	inc	hl
 404++B1E8
 405++B1E8 01 00 00     loop032	ld	bc,#0000	; /७
 406++B1EB 51           	ld	d,c
 407++B1EC 7E           loop030	ld	a,(hl)
 408++B1ED FE 20        	cp	#20
 409++B1EF 38 24        	jr	c,goto075	; 
 410++B1F1 FE 2F        	cp	fnSep		;"/"
 411++B1F3 28 17        	jr	z,goto076	;  䠩/⠫
 412++B1F5 FE 2E        	cp	"."
 413++B1F7 20 0B        	jr	nz,goto077
 414++B1F9 14           	inc	d
 415++B1FA 15           	dec	d
 416++B1FB 20 07        	jr	nz,goto077	;㦥 ࠡ⪠ ७
 417++B1FD 14           	inc	d		;ࢠ 窠  
 418++B1FE 41           	ld	b,c		; 
 419++B1FF 0E 00        	ld	c,#00		;⥯ ⠥ ७
 420++B201 23           	inc	hl
 421++B202 18 E8        	jr	loop030
 422++B204 CD 38 B2     goto077	call	proc_11		;஢ઠ  ⨬ ᨬ
 423++B207 20 E3        	jr	nz,loop030	;⨬ ᨬ   䠩
 424++B209
 425++B209              ;⨬ ᬢ  
 426++B209 37           goto078	scf
 427++B20A E1           	pop	hl
 428++B20B C9           	ret
 429++B20C
 430++B20C              ;ய᪠ 騥  ࠧ⥫ 
 431++B20C              ;b -  
 432++B20C              ;c -  ७
 433++B20C CD 1C B2     goto076	call	proc_06
 434++B20F 38 F8        	jr	c,goto078	;⨬ ࠧ 
 435++B211 1C           	inc	e
 436++B212 23           	inc	hl
 437++B213 18 D3        	jr	loop032
 438++B215
 439++B215              ; ப, ஢ਬ 祬 稢 ப
 440++B215 2B           goto075	dec	hl
 441++B216 7E           	ld	a,(hl)
 442++B217 E1           	pop	hl
 443++B218 FE 2F        	cp	fnSep		;"/"
 444++B21A 28 13        	jr	z,goto133	;஢ਬ ⮫쪮 
 445++B21C
 446++B21C              ;஢ઠ ࠬ஢   
 447++B21C              ;:  d=1    ७
 448++B21C              ;      =0  ⮫쪮 
 449++B21C              ;     b -  
 450++B21C              ;     c -  ७
 451++B21C              ;     e -  
 452++B21C              ;: cy=1  ᮤন ⨬ ᨬ,  ᫨誮 
 453++B21C 7A           proc_06	ld	a,d
 454++B21D B7           	or	a
 455++B21E 20 02        	jr	nz,goto080
 456++B220 41           	ld	b,c
 457++B221 4F           	ld	c,a
 458++B222 78           goto080	ld	a,b
 459++B223 B7           	or	a
 460++B224 37           	scf
 461++B225 C8           	ret	z		;⮥  ⨬
 462++B226 FE 09        	cp	#09
 463++B228 3F           	ccf
 464++B229 D8           	ret	c		;  8 ᨬ ⨬
 465++B22A 79           	ld	a,c
 466++B22B FE 04        	cp	#04
 467++B22D 3F           	ccf
 468++B22E D8           	ret	c		;७  3 ᨬ ⨬
 469++B22F 7B           goto133	ld	a,e
 470++B230 B7           	or	a
 471++B231 C8           	ret	z		;nc,z - ⮩ 
 472++B232 E6 7F        	and	#7F
 473++B234 FE 10        	cp	#10
 474++B236 3F           	ccf
 475++B237 C9           	ret			;nz
 476++B238
 477++B238              ;஢ઠ  ⨬ ᨬ
 478++B238 0C           proc_11	inc	c
 479++B239 CB FB        	set	7,e
 480++B23B E5           proc_18	push	hl
 481++B23C C5           	push	bc
 482++B23D 21 D0 B2     	ld	hl,IllegalSym
 483++B240 01 12 00     	ld	bc,endIllegalSym-IllegalSym
 484++B243 ED B1        	cpir
 485++B245 C1           	pop	bc
 486++B246 E1           	pop	hl
 487++B247 23           	inc	hl
 488++B248 C9           	ret
 489++B249
 490++B249              	endif
 491++B249
 492++B249              ;------------------------------------------------------------------------------
 493++B249              strTestFileName	ifused
 494++B249              ;஢ઠ  䠩  ⨬ ᨬ  ॢ 㪢  孨
 495++B249              ;  ॣ
 496++B249              ;  ᨬ  ப <#20
 497++B249              ;:  hl -  砫 
 498++B249              ;: cy=1  ᮤন ⨬ ᨬ,  ᫨誮 ,  ⮩
 499++B249              ;     cy=0 ᨭ⠪ ஢ઠ ன
 500++B249              ;
 501++B249              ;strTestFileName
 502++B249              ;
 503++B249 CD 8A B2     	call	toUpCaseHL
 504++B24C
 505++B24C              ; 砩. ⮥ 
 506++B24C 7E           	ld	a,(hl)
 507++B24D FE 20        	cp	#20
 508++B24F D8           	ret	c
 509++B250
 510++B250              ;ࠢ 
 511++B250 E5           	push	hl
 512++B251 11 01 00     	ld	de,#0001
 513++B254 42           	ld	b,d		; /७
 514++B255 4A           	ld	c,d
 515++B256 7E           loop051	ld	a,(hl)
 516++B257 FE 20        	cp	#20
 517++B259 38 BA        	jr	c,goto075	; 
 518++B25B FE 2E        	cp	"."
 519++B25D 20 0B        	jr	nz,goto079
 520++B25F 14           	inc	d
 521++B260 15           	dec	d
 522++B261 20 07        	jr	nz,goto079	;㦥 ࠡ⪠ ७
 523++B263 14           	inc	d		;ࢠ 窠  
 524++B264 41           	ld	b,c		; 
 525++B265 0E 00        	ld	c,#00		;⥯ ⠥ ७
 526++B267 23           	inc	hl
 527++B268 18 EC        	jr	loop051
 528++B26A CD 38 B2     goto079	call	proc_11		;஢ઠ  ⨬ ᨬ
 529++B26D 20 E7        	jr	nz,loop051	;⨬ ᨬ   䠩
 530++B26F
 531++B26F              ;⨬ ᬢ  
 532++B26F 37           	scf
 533++B270 E1           	pop	hl
 534++B271 C9           	ret
 535++B272 C3 DA B1     	jp	TestPathFile
 536++B275              	org	$-3
 537++B272
 538++B272              	endif
 539++B272
 540++B272              ;------------------------------------------------------------------------------
 541++B272              strTestNameLFN	ifused
 542++B272 ~            ;஢ઠ  ⨬ ᨬ   LFN
 543++B272 ~            ;  ᨬ  ப <#20
 544++B272 ~            ;:  hl - ப  
 545++B272 ~            ;: cy=1 ⨬ 
 546++B272 ~            ;     a -  ।
 547++B272 ~            ;     㣨 ॣ  
 548++B272 ~            ;
 549++B272 ~            ;strTestNameLFN
 550++B272 ~            ;
 551++B272 ~            ; 砩. ⮥ 
 552++B272 ~            	ld	a,(hl)
 553++B272 ~            	cp	#20
 554++B272 ~            	ret	c
 555++B272 ~
 556++B272 ~            ;஢ઠ  ⨬ ᨬ
 557++B272 ~            	push	hl
 558++B272 ~            loop075	call	chrCheckLFN
 559++B272 ~            	jr	z,goto202		; ⨬ ᨬ
 560++B272 ~            	inc	hl
 561++B272 ~            	ld	a,(hl)
 562++B272 ~            	cp	#20
 563++B272 ~            	jr	nc,loop075
 564++B272 ~            goto202	pop	hl
 565++B272 ~            	ccf
 566++B272 ~            	ret
 567++B272 ~
 568++B272              	endif
 569++B272
 570++B272              ;------------------------------------------------------------------------------
 571++B272              chrCheckLFN	ifused
 572++B272              ;஢ઠ  ⨬ ᨬ  LFN
 573++B272              ;: z -  ⨬ ᨬ   䠩
 574++B272              ;
 575++B272              ;chrCheckLFN
 576++B272              ;
 577++B272 E5           	push	hl
 578++B273 C5           	push	bc
 579++B274 01 09 00     	ld	bc,endIllegalSym-IllegalLFN
 580++B277 21 D9 B2     	ld	hl,IllegalLFN
 581++B27A ED B1        	cpir
 582++B27C C1           	pop	bc
 583++B27D E1           	pop	hl
 584++B27E C9           	ret
 585++B27F
 586++B27F              	endif
 587++B27F
 588++B27F              ;------------------------------------------------------------------------------
 589++B27F              SkipSeparator	ifused
 590++B27F              ;ய   ࠧ⥫   
 591++B27F              ;:  hl -   , 㪠뢠騩  ࠧ⥫
 592++B27F              ;: hl -  砫   
 593++B27F              ;
 594++B27F              ;SkipSeparator
 595++B27F              ;
 596++B27F 7E           loop031	ld	a,(hl)
 597++B280 FE 2F        	cp	fnSep1		;"/"
 598++B282 28 03        	jr	z,goto063
 599++B284 FE 5C        	cp	fnSep2		;"\"
 600++B286 C0           	ret	nz
 601++B287 23           goto063	inc	hl
 602++B288 18 F5        	jr	loop031
 603++B28A
 604++B28A              	endif
 605++B28A
 606++B28A              ;------------------------------------------------------------------------------
 607++B28A              toUpCaseHL	ifused
 608++B28A              ;ॢ ᨬ [a..z], [..]  ப  孨 ॣ, 㤠
 609++B28A              ;  㡫 ࠧ⥫
 610++B28A              ;:  hl -  ப ᨬ
 611++B28A              ;
 612++B28A              ;toUpCaseHL
 613++B28A              ;
 614++B28A D5           	push	de
 615++B28B E5           	push	hl
 616++B28C
 617++B28C 2B           	dec	hl
 618++B28D 54           	ld	d,h
 619++B28E 5D           	ld	e,l
 620++B28F
 621++B28F 23           loop050	inc	hl
 622++B290 13           loop021	inc	de
 623++B291 7E           	ld	a,(hl)
 624++B292 12           	ld	(de),a
 625++B293 FE 20        	cp	#20
 626++B295 38 2E        	jr	c,goto051
 627++B297 FE 5C        	cp	fnSep2		;"\"
 628++B299 28 2D        	jr	z,goto131
 629++B29B FE 2F        	cp	fnSep1		;"/"
 630++B29D 28 29        	jr	z,goto131
 631++B29F FE 61        	cp	"a"
 632++B2A1 38 EC        	jr	c,loop050
 633++B2A3 FE 7B        	cp	"z"+1
 634++B2A5 38 19        	jr	c,goto052
 635++B2A7 FE A0        	cp	#A0		;rus 
 636++B2A9 38 E4        	jr	c,loop050
 637++B2AB FE B0        	cp	#B0		;rus 
 638++B2AD 38 11        	jr	c,goto052
 639++B2AF FE E0        	cp	#E0		;rus 
 640++B2B1 38 DC        	jr	c,loop050
 641++B2B3 FE F0        	cp	#F0		;rus 
 642++B2B5 38 07        	jr	c,goto053
 643++B2B7 FE F1        	cp	#F1		;rus 
 644++B2B9 20 D4        	jr	nz,loop050
 645++B2BB 3D           	dec	a
 646++B2BC 18 04        	jr	goto054
 647++B2BE E6 9F        goto053	and	#9F
 648++B2C0 E6 DF        goto052	and	#DF
 649++B2C2 12           goto054	ld	(de),a
 650++B2C3 18 CA        	jr	loop050
 651++B2C5
 652++B2C5 E1           goto051	pop	hl
 653++B2C6 D1           	pop	de
 654++B2C7 C9           	ret
 655++B2C8
 656++B2C8 CD 7F B2     goto131	call	SkipSeparator
 657++B2CB 3E 2F        	ld	a,fnSep		;"/"
 658++B2CD 12           	ld	(de),a
 659++B2CE 18 C0        	jr	loop021
 660++B2D0
 661++B2D0              	endif
 662++B2D0
 663++B2D0              ;==============================================================================
 664++B2D0              ;⨬ ᨬ   䠩
 665++B2D0 20 2E        IllegalSym	db " ."
 666++B2D2 2B 5B 5D 3D  		db "+[]=,"
 666++B2D6 2C
 667++B2D7 7F 3B        		db #7F,#3B
 668++B2D9 2F 3A 2A 3F  IllegalLFN	db "/:*?<>|",#22,#5C
 668++B2DD 3C 3E 7C 22
 668++B2E1 5C
 669++B2E2              endIllegalSym
 670++B2E2              ;==============================================================================
 671++B2E2
# file closed: Drivers/DrvFAT/DrvFAT.str.a80
 138+ B2E2              	INCLUDE	"DrvFAT.misc.a80"
# file opened: Drivers/DrvFAT/DrvFAT.misc.a80
   1++B2E2              ;楤  FAT Driver. 楤 饣 祭
   2++B2E2              ;䠩 DrvFAT.misc.a80
   3++B2E2              ;
   4++B2E2              ;excngCLSCurrDir	 ⠬  砫 ⥪饣 ⠫
   5++B2E2              ;sizeBytes2Cls		᫥ ࠧ  
   6++B2E2              ;altDEHLdivBC		 de'hl'=de'hl'/bc
   7++B2E2              ;cmp_adrDE_adrHL	ࠢ 4- ᫠/ப  ᠬ  de  hl
   8++B2E2              ;cmp_adrDE_adrHL_3b	ࠢ 3- ᫠/ப  ᠬ  de  hl
   9++B2E2              ;SetZeroDEHL		㫥 dehl
  10++B2E2              ;SetZero2tmpDWORD	⠭   ६ tmpDWORD
  11++B2E2              ;cmp_DEHL_adrBC		ࠢ ᫠ dehl  ᫠    bc
  12++B2E2              ;StoreCLSCurrDir	࠭/⠭  砫 ⥪饣
  13++B2E2              ;			⠫  ६ ६
  14++B2E2              ;CopyDWORD_HL_DE	஢  ᫮    hl    de
  15++B2E2              ;Inc_addrHL		६ ६ DWORD    hl
  16++B2E2              ;Inc_DEHL		६ dehl=dehl+1
  17++B2E2              ;Dec_DEHL		६ dehl=dehl-1
  18++B2E2              ;LD_DEHL_adrHL		㧪 ᫠  ॣ  
  19++B2E2              ;Add_DEHL_adrBC		᫮ 4-⭮ ᫠   bc  dehl
  20++B2E2              ;SRL_dehl_A		 dehl=dehl/a (a - ⥯ )
  21++B2E2              ;
  22++B2E2              ;------------------------------------------------------------------------------
  23++B2E2              excngCLSCurrDir	ifused
  24++B2E2              ; ⠬  砫 ⥪饣 ⠫
  25++B2E2              ;:  hl -  ६   ஬ ⠫
  26++B2E2              ;
  27++B2E2              ;excngCLSCurrDir
  28++B2E2              ;
  29++B2E2 11 FC 8C     	ld	de,CLS_CurrDir
  30++B2E5 06 04        	ld	b,#04
  31++B2E7 4E           loop042	ld	c,(hl)
  32++B2E8 1A           	ld	a,(de)
  33++B2E9 77           	ld	(hl),a
  34++B2EA 79           	ld	a,c
  35++B2EB 12           	ld	(de),a
  36++B2EC 13           	inc	de
  37++B2ED 23           	inc	hl
  38++B2EE 10 F7        	djnz	loop042
  39++B2F0
  40++B2F0 C9           	ret
  41++B2F1
  42++B2F1              	endif
  43++B2F1
  44++B2F1              ;------------------------------------------------------------------------------
  45++B2F1              sizeBytes2Cls	ifused
  46++B2F1              ;᫥ ࠧ  
  47++B2F1              ;:  dehl - ࠧ  
  48++B2F1              ;: cy=1, nz -> a=errNumTooBig - ᫨誮 让 ࠧ,  #FFFF ஢
  49++B2F1              ;                 ehl - ࠧ  
  50++B2F1              ;                 bc - ⢮   ᫥ 
  51++B2F1              ;     cy=1, z ->  a=errFileEmpty - 㫥 ࠧ 䠩
  52++B2F1              ;     cy=0 ⠫ ᯥ譮
  53++B2F1              ;        hl - ࠧ  
  54++B2F1              ;        bc - ⢮   ᫥ 
  55++B2F1              ;        a,de=#0000
  56++B2F1              ;
  57++B2F1              ;sizeBytes2Cls
  58++B2F1              ;
  59++B2F1              ;஢ਬ   
  60++B2F1 7D           	ld	a,l
  61++B2F2 B4           	or	h
  62++B2F3 B3           	or	e
  63++B2F4 B2           	or	d
  64++B2F5 3E 75        	ld	a,errFileEmpty
  65++B2F7 37           	scf
  66++B2F8 C8           	ret	z		;㫥 
  67++B2F9
  68++B2F9              ;᫥ ࠧ  
  69++B2F9 3A EE 8C     	ld	a,(LenCLSInSec)
  70++B2FC 0E FF        	ld	c,#FF
  71++B2FE CB 3A        loop039	srl	d
  72++B300 CB 1B        	rr	e
  73++B302 CB 1C        	rr	h
  74++B304 CB 1D        	rr	l
  75++B306 CB 19        	rr	c
  76++B308 1F           	rra
  77++B309 30 F3        	jr	nc,loop039
  78++B30B 45           	ld	b,l
  79++B30C 18 04        	jr	goto089
  80++B30E CB 38        loop040	srl	b
  81++B310 CB 19        	rr	c
  82++B312 0F           goto089	rrca
  83++B313 30 F9        	jr	nc,loop040
  84++B315              ;bc ࠧ ⪠ 䠩  
  85++B315              ;deh ⢮ ஢
  86++B315
  87++B315 6C           	ld	l,h
  88++B316 63           	ld	h,e
  89++B317 5A           	ld	e,d
  90++B318 78           	ld	a,b
  91++B319 B1           	or	c
  92++B31A C4 7D B3     	call	nz,Inc_DEHL
  93++B31D 7B           	ld	a,e
  94++B31E B2           	or	d
  95++B31F C8           	ret	z
  96++B320
  97++B320              ;訡 ८ࠧ
  98++B320 3E 11        	ld	a,errNumTooBig	;number too big
  99++B322 B7           	or	a
 100++B323 37           	scf
 101++B324 C9           	ret
 102++B325
 103++B325              	endif
 104++B325
 105++B325 ~            /*     ᨨ 室 㣮
 106++B325 ~            sizeBytes2Cls	ifused
 107++B325 ~            ;᫥ ࠧ  
 108++B325 ~            ;:  dehl - ࠧ  
 109++B325 ~            ;: cy=1 訡
 110++B325 ~            ;        a=errNumTooBig - ᫨誮 让 ࠧ
 111++B325 ~            ;        a=errFileEmpty - 㫥 ࠧ 䠩
 112++B325 ~            ;     cy=0 ⠫ ᯥ譮
 113++B325 ~            ;        bc,hl - ࠧ  
 114++B325 ~            ;        a,de=#0000
 115++B325 ~            ;
 116++B325 ~            ;sizeBytes2Cls
 117++B325 ~            ;
 118++B325 ~            ;᫥ ࠧ  
 119++B325 ~            	ld	a,l
 120++B325 ~            	or	h
 121++B325 ~            	or	e
 122++B325 ~            	or	d
 123++B325 ~            	ld	a,errFileEmpty
 124++B325 ~            	scf
 125++B325 ~            	ret	z
 126++B325 ~            	ld	a,l
 127++B325 ~            	ld	l,h
 128++B325 ~            	ld	h,e
 129++B325 ~            	ld	e,d
 130++B325 ~            	ld	d,#00
 131++B325 ~            	push	af
 132++B325 ~            	exx
 133++B325 ~            	ld	a,(LenCLSInSec)
 134++B325 ~            	add	a,a
 135++B325 ~            	ld	c,a
 136++B325 ~            	ld	a,#00
 137++B325 ~            	adc	a,#00
 138++B325 ~            	ld	b,a
 139++B325 ~            	call	altDEHLdivBC
 140++B325 ~            	pop	af
 141++B325 ~            	or	l
 142++B325 ~            	or	h
 143++B325 ~            	exx
 144++B325 ~            	call	nz,Inc_DEHL	; ⮪  . ਡ  
 145++B325 ~            	ld	c,l
 146++B325 ~            	ld	b,h		;ࠧ  
 147++B325 ~            	ld	a,d
 148++B325 ~            	or	e
 149++B325 ~            	ret	z
 150++B325 ~            ;訡 ८ࠧ
 151++B325 ~            	ld	a,errNumTooBig	;number too big
 152++B325 ~            	scf
 153++B325 ~            	ret
 154++B325 ~
 155++B325 ~            	endif
 156++B325 ~            */
 157++B325
 158++B325              ;------------------------------------------------------------------------------
 159++B325              altDEHLdivBC	ifused
 160++B325 ~            ; de'hl'=de'hl'/bc
 161++B325 ~            ;:  de'hl' - 
 162++B325 ~            ;     bc - ⥫
 163++B325 ~            ;: de'hl' - 祭
 164++B325 ~            ;     hl ⮪  
 165++B325 ~            ;
 166++B325 ~            ;altDEHLdivBC
 167++B325 ~            ;
 168++B325 ~            	ld	hl,#0000
 169++B325 ~            	push	hl
 170++B325 ~            	ld	e,l
 171++B325 ~            	ld	d,h
 172++B325 ~            	exx
 173++B325 ~            	ld	b,#20
 174++B325 ~            loop015	xor	a
 175++B325 ~            	rl	l
 176++B325 ~            	rl	h
 177++B325 ~            	rl	e
 178++B325 ~            	rl	d
 179++B325 ~            	exx
 180++B325 ~            	rl	l
 181++B325 ~            	rl	h
 182++B325 ~            	rl	e
 183++B325 ~            	rl	d
 184++B325 ~            	rla
 185++B325 ~            	or	a
 186++B325 ~            	sbc	hl,bc
 187++B325 ~            	ex	(sp),hl
 188++B325 ~            	ex	de,hl
 189++B325 ~            	sbc	hl,de
 190++B325 ~            	ex	de,hl
 191++B325 ~            	ex	(sp),hl
 192++B325 ~            	exx
 193++B325 ~            	sbc	a,#00
 194++B325 ~            	jr	nz,goto041
 195++B325 ~            loop016	inc	l
 196++B325 ~            	djnz	loop015
 197++B325 ~            	inc	sp
 198++B325 ~            	inc	sp
 199++B325 ~            	exx
 200++B325 ~            	ret
 201++B325 ~            loop014	xor	a
 202++B325 ~            	rl	l
 203++B325 ~            	rl	h
 204++B325 ~            	rl	e
 205++B325 ~            	rl	d
 206++B325 ~            	exx
 207++B325 ~            	rl	l
 208++B325 ~            	rl	h
 209++B325 ~            	rl	e
 210++B325 ~            	rl	d
 211++B325 ~            	rla
 212++B325 ~            	add	hl,bc
 213++B325 ~            	ex	(sp),hl
 214++B325 ~            	ex	de,hl
 215++B325 ~            	adc	hl,de
 216++B325 ~            	ex	de,hl
 217++B325 ~            	ex	(sp),hl
 218++B325 ~            	exx
 219++B325 ~            	sbc	a,#00
 220++B325 ~            	jr	z,loop016
 221++B325 ~            goto041	djnz	loop014
 222++B325 ~            	exx
 223++B325 ~            	add	hl,bc
 224++B325 ~            	jr	nc,goto042
 225++B325 ~            	inc	de
 226++B325 ~            goto042	inc	sp
 227++B325 ~            	inc	sp
 228++B325 ~            	ret
 229++B325 ~
 230++B325              	endif
 231++B325
 232++B325              ;------------------------------------------------------------------------------
 233++B325              cmp_adrDE_adrHL	ifused
 234++B325              ;ࠢ  4- ᫠/ப  ᠬ  de  hl
 235++B325              ;:  z - ࠢ
 236++B325              ;     nz -  ࠢ
 237++B325              ;cmp_adrDE_adrHL
 238++B325              ;
 239++B325 1A           	ld	a,(de)
 240++B326 BE           	cp	(hl)
 241++B327 C0           	ret	nz
 242++B328 23           	inc	hl
 243++B329 13           	inc	de
 244++B32A 18 FE        	jr	cmp_adrDE_adrHL_3b
 245++B32C              	org	$-2
 246++B32A
 247++B32A              	endif
 248++B32A
 249++B32A              ;------------------------------------------------------------------------------
 250++B32A              cmp_adrDE_adrHL_3b	ifused
 251++B32A              ;ࠢ  3- ᫠/ப  ᠬ  de  hl
 252++B32A              ;:  z - ࠢ
 253++B32A              ;     nz -  ࠢ
 254++B32A              ;cmp_adrDE_adrHL_3b
 255++B32A              ;
 256++B32A 1A           	ld	a,(de)
 257++B32B BE           	cp	(hl)
 258++B32C C0           	ret	nz
 259++B32D 23           	inc	hl
 260++B32E 13           	inc	de
 261++B32F 1A           	ld	a,(de)
 262++B330 BE           	cp	(hl)
 263++B331 C0           	ret	nz
 264++B332 23           	inc	hl
 265++B333 13           	inc	de
 266++B334 1A           	ld	a,(de)
 267++B335 BE           	cp	(hl)
 268++B336 C9           	ret
 269++B337
 270++B337              	endif
 271++B337
 272++B337              ;------------------------------------------------------------------------------
 273++B337              SetZeroDEHL	ifused
 274++B337              ;㫥 dehl
 275++B337              ;: dehl=#00000000
 276++B337              ;
 277++B337              ;SetZeroDEHL
 278++B337              ;
 279++B337 21 00 00     	ld	hl,#0000
 280++B33A 5D           	ld	e,l
 281++B33B 55           	ld	d,l
 282++B33C C9           	ret
 283++B33D
 284++B33D              	endif
 285++B33D
 286++B33D              ;------------------------------------------------------------------------------
 287++B33D              SetZero2tmpDWORD	ifused
 288++B33D              ;⠭   ६ tmpDWORD
 289++B33D              ;
 290++B33D              ;SetZero2tmpDWORD
 291++B33D              ;
 292++B33D 01 00 00     	ld	bc,#0000
 293++B340 ED 43 1D 8D  	ld	(tmpDWORD),bc
 294++B344 ED 43 1F 8D  	ld	(tmpDWORD+2),bc
 295++B348 C9           	ret
 296++B349
 297++B349              	endif
 298++B349
 299++B349              ;------------------------------------------------------------------------------
 300++B349              cmp_DEHL_adrBC	ifused
 301++B349              ;ࠢ ᫠ dehl  ᫠    bc
 302++B349              ;:  dehl - 4 ⭮ ᫮
 303++B349              ;     bc -  4 ⭮ ᫠
 304++B349              ;: nz,nc,p - dehl<(bc)
 305++B349              ;     nz,c,m - dehl>(bc)
 306++B349              ;     z,nc,p  - dehl=(bc)
 307++B349              ;
 308++B349              ;cmp_DEHL_adrBC
 309++B349              ;
 310++B349 03           	inc	bc
 311++B34A 03           	inc	bc
 312++B34B 03           	inc	bc
 313++B34C 0A           	ld	a,(bc)			;ࠢ  +3
 314++B34D BA           	cp	d
 315++B34E 38 19        	jr	c,goto010		;d > (bc)
 316++B350 20 1B        	jr	nz,goto011		;d < (bc)
 317++B352 0B           	dec	bc
 318++B353 0A           	ld	a,(bc)			;ࠢ  +2
 319++B354 BB           	cp	e
 320++B355 38 12        	jr	c,goto010		;e > (bc)
 321++B357 20 14        	jr	nz,goto011		;e < (bc)
 322++B359 0B           	dec	bc
 323++B35A 0A           	ld	a,(bc)			;ࠢ  +1
 324++B35B BC           	cp	h
 325++B35C 38 0B        	jr	c,goto010		;h > (bc)
 326++B35E 20 0D        	jr	nz,goto011		;h < (bc)
 327++B360 0B           	dec	bc
 328++B361 0A           	ld	a,(bc)			;ࠢ  +0
 329++B362 BD           	cp	l
 330++B363 38 04        	jr	c,goto010		;l > (bc)
 331++B365 20 06        	jr	nz,goto011		;l < (bc)
 332++B367
 333++B367              ;z,nc,p  - dehl=(bc)
 334++B367 AF           	xor	a
 335++B368 C9           	ret
 336++B369
 337++B369              ;nz,c,m - dehl>(bc)
 338++B369 AF           goto010	xor	a
 339++B36A D6 01        	sub	#01
 340++B36C C9           	ret
 341++B36D
 342++B36D              ;nz,nc,p - dehl<(bc)
 343++B36D AF           goto011	xor	a
 344++B36E C6 01        	add	a,#01
 345++B370 C9           	ret
 346++B371
 347++B371              	endif
 348++B371
 349++B371              ;------------------------------------------------------------------------------
 350++B371              StoreCLSCurrDir	ifused
 351++B371 ~            ;࠭/⠭  砫 ⥪饣 ⠫  ६ ६
 352++B371 ~            ;:  cy=0 ࠭ 
 353++B371 ~            ;     cy=1 ⠭ 
 354++B371 ~            ;
 355++B371 ~            ;StoreCLSCurrDir
 356++B371 ~            ;
 357++B371 ~            	push	hl
 358++B371 ~            	push	de
 359++B371 ~            	ld	hl,CLS_CurrDir
 360++B371 ~            	ld	de,tmpDIR
 361++B371 ~            	jr	nc,goto132
 362++B371 ~            	ex	de,hl
 363++B371 ~            	jr	goto132
 364++B371 ~            	jr	CopyDWORD_HL_DE
 365++B371 ~            	org	$-2
 366++B371 ~
 367++B371              	endif
 368++B371
 369++B371              ;------------------------------------------------------------------------------
 370++B371              CopyDWORD_HL_DE	ifused
 371++B371              ;஢  ᫮    hl    de
 372++B371              ;
 373++B371              ;CopyDWORD_HL_DE
 374++B371              ;
 375++B371 E5           	push	hl
 376++B372 D5           	push	de
 377++B373 C5           goto132	push	bc
 378++B374 01 04 00     	ld	bc,#0004
 379++B377 ED B0        	ldir
 380++B379 C1           	pop	bc
 381++B37A D1           	pop	de
 382++B37B E1           	pop	hl
 383++B37C C9           	ret
 384++B37D
 385++B37D              	endif
 386++B37D
 387++B37D              ;------------------------------------------------------------------------------
 388++B37D              Inc_addrHL	ifused
 389++B37D ~            ;६ ६ DWORD    hl
 390++B37D ~            ;: z - ९ ६ ⠫ =#00000000
 391++B37D ~            ;Inc_addrHL
 392++B37D ~            ;
 393++B37D ~            	inc	(hl)
 394++B37D ~            	ret	nz
 395++B37D ~            	inc	hl
 396++B37D ~            	inc	(hl)
 397++B37D ~            	ret	nz
 398++B37D ~            	inc	hl
 399++B37D ~            	inc	(hl)
 400++B37D ~            	ret	nz
 401++B37D ~            	inc	hl
 402++B37D ~            	inc	(hl)
 403++B37D ~            	ret
 404++B37D ~
 405++B37D              	endif
 406++B37D
 407++B37D              ;------------------------------------------------------------------------------
 408++B37D              Inc_DEHL	ifused
 409++B37D              ;६ dehl=dehl+1
 410++B37D              ;: z - ९ dehl=#00000000
 411++B37D              ;Inc_DEHL
 412++B37D              ;
 413++B37D 2C           	inc	l
 414++B37E C0           	ret	nz
 415++B37F 24           	inc	h
 416++B380 C0           	ret	nz
 417++B381 1C           	inc	e
 418++B382 C0           	ret	nz
 419++B383 14           	inc	d
 420++B384 C9           	ret
 421++B385
 422++B385              	endif
 423++B385
 424++B385              ;------------------------------------------------------------------------------
 425++B385              Dec_DEHL	ifused
 426++B385 ~            ;६ dehl=dehl-1
 427++B385 ~            ;Dec_DEHL
 428++B385 ~            ;
 429++B385 ~            	dec	hl
 430++B385 ~            	ld	a,l
 431++B385 ~            	and	h
 432++B385 ~            	inc	a
 433++B385 ~            	ret	nz
 434++B385 ~            	dec	de
 435++B385 ~            	ret
 436++B385 ~
 437++B385              	endif
 438++B385
 439++B385              ;------------------------------------------------------------------------------
 440++B385              LD_DEHL_adrHL	ifused
 441++B385              ;㧪 ᫠  ॣ  
 442++B385              ;:  hl -  㤠 㧨
 443++B385              ;: dehl - ᫮
 444++B385              ;
 445++B385              ;LD_DEHL_adrHL
 446++B385              ;
 447++B385 5E           	ld	e,(hl)
 448++B386 23           	inc	hl
 449++B387 56           	ld	d,(hl)
 450++B388 23           	inc	hl
 451++B389 D5           	push	de
 452++B38A 5E           	ld	e,(hl)
 453++B38B 23           	inc	hl
 454++B38C 56           	ld	d,(hl)
 455++B38D E1           	pop	hl
 456++B38E C9           	ret
 457++B38F
 458++B38F              	endif
 459++B38F
 460++B38F              ;------------------------------------------------------------------------------
 461++B38F              Add_DEHL_adrBC	ifused
 462++B38F              ;᫮ 4-⭮ ᫠   bc  dehl
 463++B38F              ;: dehl=dehl+(bc)
 464++B38F              ;
 465++B38F              ;Add_DEHL_adrBC
 466++B38F              ;
 467++B38F 0A           	ld	a,(bc)
 468++B390 03           	inc	bc
 469++B391 85           	add	a,l
 470++B392 6F           	ld	l,a
 471++B393 0A           	ld	a,(bc)
 472++B394 03           	inc	bc
 473++B395 8C           	adc	a,h
 474++B396 67           	ld	h,a
 475++B397 0A           	ld	a,(bc)
 476++B398 03           	inc	bc
 477++B399 8B           	adc	a,e
 478++B39A 5F           	ld	e,a
 479++B39B 0A           	ld	a,(bc)
 480++B39C 8A           	adc	a,d
 481++B39D 57           	ld	d,a
 482++B39E C9           	ret
 483++B39F
 484++B39F              	endif
 485++B39F
 486++B39F              ;------------------------------------------------------------------------------
 487++B39F              ; dehl=dehl/a (a - ⥯ )
 488++B39F              ;
 489++B39F CB 3A        loop034	srl	d
 490++B3A1 CB 1B        	rr	e
 491++B3A3 CB 1C        	rr	h
 492++B3A5 CB 1D        	rr	l
 493++B3A7              ;
 494++B3A7              SRL_dehl_A
 495++B3A7              ;
 496++B3A7 0F           	rrca
 497++B3A8 30 F5        	jr	nc,loop034
 498++B3AA C9           	ret
 499++B3AB
 500++B3AB              ;==============================================================================
 501++B3AB
# file closed: Drivers/DrvFAT/DrvFAT.misc.a80
 139+ B3AB              	INCLUDE	"DrvFAT.var.a80"
# file opened: Drivers/DrvFAT/DrvFAT.var.a80
   1++B3AB              ;६ FAT Driver
   2++B3AB              ;䠩 DrvFAT.var.a80
   3++B3AB              ;
   4++B3AB              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   5++B3AB              	ifdef	VarsInDrv
   6++B3AB ~            VarsFAT	ds	#5B
   7++B3AB              	else
   8++B3AB
   9++B3AB              ;६ ⥪饣 FAT32 ࠧ
  10++B3AB              CurrentPart	equ VarsFAT+#00	;1 bit 1-0,  ந樫஢ ࠧ FAT
  11++B3AB                                              ;  bit 3-2,  ன⢠
  12++B3AB              				;           =00 HDD master
  13++B3AB              				;           =01 HDD slave
  14++B3AB              				;           =10 SD card
  15++B3AB              FlgFAT		equ VarsFAT+#01	;1 䫠
  16++B3AB              				;  0,=1 NextFreeCluster  ⠭  #FF
  17++B3AB              AdrPartBegin	equ VarsFAT+#02	;4  砫 ࠧ
  18++B3AB              AdrFsInfo	equ VarsFAT+#06	;2 ᬥ饭 ᥪ FSInfo  砫 ࠧ
  19++B3AB              AdrFATonHDD	equ VarsFAT+#08	;4 砫 ࢮ FAT-⠡
  20++B3AB              AdrDataBegin	equ VarsFAT+#0C	;4  ࢮ ᥪ  ࠧ  BPB
  21++B3AB              				;  (ᬥ饭  砫 ࠧ)
  22++B3AB              LenOfPartFAT	equ VarsFAT+#10	;4 ⢮ ᥪ஢  ࠧ
  23++B3AB              LenFATinSec	equ VarsFAT+#14	;4 ⢮ ᥪ஢   FAT
  24++B3AB              NumsFATonPart	equ VarsFAT+#18	;1 ⢮  FAT  ⥪饬 ࠧ
  25++B3AB              LenCLSInSec	equ VarsFAT+#19	;1 ࠧ   ᥪ
  26++B3AB              RootClaster	equ VarsFAT+#1A	;4  ࢮ   ⠫
  27++B3AB              FsIFreeCls	equ VarsFAT+#1E	;4 ᫮ ᢮ ஢
  28++B3AB              				;  =#FFFFFFFF ⭮
  29++B3AB              FsINextCls	equ VarsFAT+#22	;4    ண  ᪠
  30++B3AB              				;  ᢮ 
  31++B3AB              				;  =#FFFFFFFF ⭮
  32++B3AB
  33++B3AB
  34++B3AB              ;६  ࠡ  FAT
  35++B3AB              @CurrentLevel	equ VarsFAT+#26	;1 㡨   ⥪饬 ⠫
  36++B3AB              @CLS_CurrDir	equ VarsFAT+#27	;4   ⥪饩 ४ਨ
  37++B3AB              tmpDIR		equ VarsFAT+#2B	;4   ६ ४ਨ
  38++B3AB              @DescInCurrDir	equ VarsFAT+#2F	;2  ⥪饩   ⠫
  39++B3AB              @DescInDIR	equ VarsFAT+#31	;2 ⢮ ᥩ  ⥪饬 ⠫
  40++B3AB              @Ext4Found	equ VarsFAT+#33	;2  ᯨ᪠ ७  ⮡ࠦ
  41++B3AB              @SecFATinBuf	equ VarsFAT+#35	;4  ᥪ FAT, 㦥
  42++B3AB              				;    Buf4FAT
  43++B3AB              @SecDIRinBuf	equ VarsFAT+#39	;4  ᥪ ⠫, 㦥
  44++B3AB              				;    Buf4DIR
  45++B3AB
  46++B3AB
  47++B3AB              ; ᪮७ ⥭ 䠩
  48++B3AB              NumFstCluster	equ VarsFAT+#3D	;4  ࢮ  ⥪饣 䠩
  49++B3AB              NumCluster	equ VarsFAT+#41	;2 浪    ।騬
  50++B3AB              				;  ⠭ ᥪ஬ ⥪饣 䠩
  51++B3AB              NumSecCls	equ VarsFAT+#43	;1 浪  ᥪ  
  52++B3AB              				;  ।騩 ⠭ ᥪ ண 
  53++B3AB              				;  
  54++B3AB              SecFileInBuf	equ VarsFAT+#44	;4  ᥪ 䠩, 㦥  
  55++B3AB
  56++B3AB              ; ६ ࠭ ६
  57++B3AB              tmpDWORD	equ VarsFAT+#48	;4 ६ ६  ࠧ 㦤
  58++B3AB              				;  ᯮ  楤:
  59++B3AB              				;  CountFreeCls
  60++B3AB              				;  SetNClsInFAT
  61++B3AB              				;  AddCls2Chain
  62++B3AB              				;  FreeClsChain
  63++B3AB              				;  FindFreeCls
  64++B3AB              				;  fatAddFreeSpace_dehl
  65++B3AB              				;  fatAddFreeSpace_var
  66++B3AB              				;  addFileFreeSpace
  67++B3AB              				;  findFreeDirEntry
  68++B3AB              				;  fatFormatPart
  69++B3AB              tmpDWORD2	equ VarsFAT+#4C	;+4 ६ ६  ࠧ 㦤
  70++B3AB              				;  ᯮ  楤:
  71++B3AB              				;  fatAddFreeSpace
  72++B3AB              @Name4Find	equ VarsFAT+#50	;11  䠩 FAT  ᪠  ⠫
  73++B3AB
  74++B3AB              	endif
  75++B3AB
  76++B3AB              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  77++B3AB              ; ஢  䠩/⠫
  78++B3AB              	ifused	Sym4Sort
  79++B3AB ~            Sym4Sort	db ".!#$%&'()-0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`{}~",#7F
  80++B3AB ~            		db "",#FF,0
  81++B3AB              	endif
  82++B3AB
  83++B3AB              ;------------------------------------------------------------------------------
  84++B3AB
# file closed: Drivers/DrvFAT/DrvFAT.var.a80
 140+ B3AB              End	;SAVEBIN	"drvfat.bin",Start,End-Start
 141+ B3AB              	DISPLAY "Lenght DrvFAT = ",/A,End-Start
 142+ B3AB
 143+ B3AB              	ENDMODULE
 144+ B3AB
# file closed: Drivers/DrvFAT/DrvFAT.main.a80
5180  B3AB
5181  B3AB 00 00 00...  		align 8
5182  B3B0 5A 58 4E     trn_buf	db	"ZXN" ;тут пакет для передачи
5183  B3B3
5184  B3B3              end_ ;ниже буферы, в файл не выгружаются
5185  B3B3
5186  B3B3 00 00 00...  	ds 2048
5187  BBB3
5188  BBB3 00 00 00...  cipstart_line ds 256 ;буфер для строки соединения
5189  BCB3
5190  BCB3 00 00 00...  file_fcb_tmp ds 32 ;временно
5191  BCD3 00 00 00...  file_name_cur ds file_name_len+3 ;временно
5192  BCE2 00 00 00...  file_cfg_name_buf ds 256
5193  BDE2
5194  BDE2
5195  BDE2 00 00 00...  	align 8
5196  BDE8 00 00 00...  cat_r2 ds  2048 ;буфер каталога справа (временная копия)
5197  C5E8              	align 8
5198  C5E8 00 00 00...  cat_open_trd ds 9*256+16 ;буфер каталога открытого образа (правая панель)
5199  CEF8 00 00 00...  	align 128
5200  CF00 00 00 00...  cat_mark_l ds 128 ;база отмеченных файлов слева
5201  CF80 00 00 00...  cat_mark_r ds 128 ;база отмеченных файлов справа
5202  D000 00 00 00...  cat_l ds cat_size_max ;9*256 ;буфер каталога диска (левая панель)
5203  EE00              cat_l_end
5204  EE00 00 00 00...  cat_r ds 2048 ;буфер каталога справа
5205  F600              cat_r_end
5206  F600 00 00 00...  rec_buf ds  2048 ;буфер приёма
5207  FE00
5208  FE00              ;сохранение файла настроек
5209  FE00              start_ini
5210  FE00              	incbin 'AY232K_i.C'
5211  FEAD              end_ini
5212  FEAD
5213  FEAD              	SAVETRD "AY232K.TRD",|"AY232K_i.C",start_ini,end_ini-start_ini
5214  FEAD              ;сохранение
5215  FEAD              end_all
5216  FEAD              	SAVETRD "AY232K.TRD",|"AY232K.C",start_,end_-start_
5217  FEAD
# file closed: ay232k.asm
